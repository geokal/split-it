@using QuizManager.Services.ProfessorDashboard
@using QuizManager.Services.UserContext
@using QuizManager.Models
@using Microsoft.AspNetCore.Components.Forms
@inject IProfessorDashboardService ProfessorDashboardService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

@if (AllEvents == null)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Φόρτωση...</span>
        </div>
    </div>
}
else
{
    <!-- Simple Filters Section matching production -->
    <div class="row mb-3">
        <div class="col-md-2">
            <label for="statusFilterForAnnouncements" style="color: #2d3748;"><strong>Φίλτρο Εμφάνισης</strong></label>
            <div class="input-group">
                <select id="statusFilterForAnnouncements" class="form-control form-control-sm" 
                        @onchange="HandleStatusFilterChange">
                    <option value="Όλες">Όλες</option>
                    <option value="Δημοσιευμένη">Δημοσιευμένη</option>
                    <option value="Μη Δημοσιευμένη">Μη Δημοσιευμένη</option>
                </select>
                <div class="input-group-append">
                    <span class="input-group-text">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <label style="color: #2d3748;"><strong>Αποτελέσματα ανά Σελίδα</strong></label>
            <div class="input-group" style="max-width: 65px;">
                <select class="form-control form-control-sm" 
                        @onchange="OnPageSizeChange" 
                        aria-label="Items per page">
                    @foreach (var option in pageSizeOptions)
                    {
                        <option value="@option" selected="@(PageSize == option)">@option</option>
                    }
                </select>
                <div class="input-group-append">
                    <span class="input-group-text">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            @if (selectedEventFilter == "Όλες")
            {
                <span><strong>Σύνολο: </strong>@TotalCount</span>
            }
            else if (selectedEventFilter == "Δημοσιευμένη")
            {
                <span><strong>Σύνολο: </strong>@PublishedCount</span>
            }
            else if (selectedEventFilter == "Μη Δημοσιευμένη")
            {
                <span><strong>Σύνολο: </strong>@UnpublishedCount</span>
            }
        </div>
    </div>

    <!-- Bulk Edit Button -->
    @if (FilteredEvents != null && FilteredEvents.Any())
    {
        <div class="row mb-3">
            <div class="col-md-12">

            <span class="text-muted">
                <strong>@FilteredEvents.Count</strong> εκδηλώσεις βρέθηκαν
            </span>
             @if (selectedProfessorEventIds.Any())
            {
                <div class="btn-group fade-in">
                    <button class="btn btn-outline-danger btn-sm d-flex align-items-center" @onclick="() => ShowBulkActionModal(BulkActionType.Delete)">
                        <i class="fas fa-trash me-2"></i>Διαγραφή (@selectedProfessorEventIds.Count)
                    </button>
                    <button class="btn btn-outline-primary btn-sm d-flex align-items-center" @onclick="() => ShowBulkActionModal(BulkActionType.ChangeStatus)">
                        <i class="fas fa-sync-alt me-2"></i>Αλλαγή Κατάστασης (@selectedProfessorEventIds.Count)
                    </button>
                </div>
            }
        </div>
        
        <!-- Pagination Controls (Top) -->
       @if (TotalPages > 1)
        {
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage - 1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </li>
                    <li class="page-item active">
                        <span class="page-link">
                            Σελίδα @CurrentPage από @TotalPages
                        </span>
                    </li>
                    <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage + 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        }
    </div>

    <!-- Table -->
    <div class="table-responsive shadow-sm" style="border-radius: 12px; overflow: hidden;">
        <table class="table table-hover mb-0 bg-white">
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th class="border-bottom-0 py-3" style="width: 40px;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   checked="@AreAllVisibleEventsSelected"
                                   @onchange="ToggleSelectAllEvents" 
                                   style="cursor: pointer;">
                        </div>
                    </th>
                    <th class="border-bottom-0 py-3 text-secondary text-uppercase font-weight-bold small">Τίτλος/Ημερομηνία</th>
                    <th class="border-bottom-0 py-3 text-secondary text-uppercase font-weight-bold small">Τοποθεσία</th>
                    <th class="border-bottom-0 py-3 text-secondary text-uppercase font-weight-bold small">Επιλογές Μεταφοράς</th>
                    <th class="border-bottom-0 py-3 text-secondary text-uppercase font-weight-bold small">Κατάσταση</th>
                    <th class="border-bottom-0 py-3 text-secondary text-uppercase font-weight-bold small">Ενδιαφέρον</th>
                    <th class="border-bottom-0 py-3 text-center text-secondary text-uppercase font-weight-bold small">Ενέργειες</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var professorEvent in PaginatedEvents)
                {
                    <tr style="vertical-align: middle;">
                         <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       checked="@selectedProfessorEventIds.Contains(professorEvent.RNGForEventUploadedAsProfessor)"
                                       @onchange="@(e => ToggleProfessorEventSelection(professorEvent.RNGForEventUploadedAsProfessor, e.Value))"
                                       style="cursor: pointer;">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-dark">@professorEvent.ProfessorEventTitle</span>
                                <span class="text-muted small">
                                    <i class="far fa-calendar me-1"></i>
                                    @professorEvent.ProfessorEventActiveDate.ToString("dd/MM/yyyy")
                                     <i class="far fa-clock ms-2 me-1"></i>
                                    @professorEvent.ProfessorEventTimeOnly
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="text-dark">@professorEvent.ProfessorEventDimosLocation</span>
                                <span class="text-muted small">@professorEvent.ProfessorEventPerifereiaLocation</span>
                            </div>
                        </td>
                         <td>
                            @if (professorEvent.ProfessorEventOfferingTransportToEventLocation == true)
                            {
                                <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">
                                    <i class="fas fa-bus me-1"></i>Παρέχεται
                                </span>
                            }
                            else
                            {
                                <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
                                    <i class="fas fa-walking me-1"></i>Δεν παρέχεται
                                </span>
                            }
                        </td>
                         <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       checked="@(professorEvent.ProfessorEventStatus == "Active")"
                                       @onchange="() => OnToggleEventStatus.InvokeAsync(professorEvent)"
                                       style="cursor: pointer;">
                                <label class="form-check-label small text-muted">
                                    @(professorEvent.ProfessorEventStatus == "Active" ? "Ενεργή" : "Ανενεργή")
                                </label>
                            </div>
                        </td>
                        <td>
                             <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary position-relative" 
                                        @onclick="() => ExpandStudentInterest(professorEvent)">
                                    <i class="fas fa-user-graduate"></i>
                                </button>
                                 <button class="btn btn-sm btn-outline-info position-relative" 
                                         @onclick="() => ExpandCompanyInterest(professorEvent)">
                                    <i class="fas fa-building"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light text-primary" title="Επεξεργασία" @onclick="() => OnEditEvent.InvokeAsync(professorEvent)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-light text-danger" title="Διαγραφή" @onclick="() => OnDeleteEvent.InvokeAsync(professorEvent)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    
                    @if (expandedEventIdForStudents == professorEvent.RNGForEventUploadedAsProfessor)
                    {
                        <tr class="table-active">
                            <td colspan="7">
                                <div class="p-3">
                                    <h6 class="text-primary mb-3">Ενδιαφερόμενοι Φοιτητές</h6>
                                    @if (isLoadingStudents)
                                    {
                                         <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                                    }
                                    else if (InterestedStudents != null && InterestedStudents.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Όνομα</th>
                                                        <th>Email</th>
                                                        <th>Τηλέφωνο</th>
                                                        <th>Λεπτομέρειες</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var student in InterestedStudents)
                                                    {
                                                        <tr>
                                                            <td>@student.Name @student.Surname</td>
                                                            <td>@student.Email</td>
                                                            <td>@student.Telephone</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-info text-white" @onclick="() => OnShowStudentDetails.InvokeAsync(student)">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info mb-0">Δεν υπάρχουν εκδηλώσεις ενδιαφέροντος από φοιτητές.</div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                    
                     @if (expandedEventIdForCompanies == professorEvent.RNGForEventUploadedAsProfessor)
                    {
                        <tr class="table-active">
                             <td colspan="7">
                                <div class="p-3">
                                    <h6 class="text-info mb-3">Ενδιαφερόμενες Εταιρείες</h6>
                                     @if (isLoadingCompanies)
                                    {
                                         <div class="spinner-border text-info spinner-border-sm" role="status"></div>
                                    }
                                    else if (InterestedCompanies != null && InterestedCompanies.Any())
                                    {
                                         <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Επωνυμία</th>
                                                        <th>Email</th>
                                                        <th>Τηλέφωνο</th>
                                                        <th>Λεπτομέρειες</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var company in InterestedCompanies)
                                                    {
                                                        <tr>
                                                            <td>@company.CompanyName</td>
                                                            <td>@company.CompanyEmail</td>
                                                            <td>@company.CompanyTelephone</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-info text-white" @onclick="() => OnShowCompanyDetails.InvokeAsync(company)">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                         <div class="alert alert-info mb-0">Δεν υπάρχουν εκδηλώσεις ενδιαφέροντος από εταιρείες.</div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    
     <!-- Pagination Controls (Bottom) -->
    @if (TotalPages > 1)
    {
        <div class="d-flex justify-content-center mt-4">
             <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage - 1)">Προηγούμενη</button>
                    </li>
                    @for (int i = 1; i <= TotalPages; i++)
                    {
                         var pageIndex = i;
                         <li class="page-item @(CurrentPage == pageIndex ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(pageIndex)">@pageIndex</button>
                        </li>
                    }
                     <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage + 1)">Επόμενη</button>
                    </li>
                </ul>
            </nav>
        </div>
    }
}


@code {
    [Parameter] public List<ProfessorEvent> AllEvents { get; set; }
    [Parameter] public List<string> Regions { get; set; }
    [Parameter] public Dictionary<string, List<string>> RegionToTownsMap { get; set; }
    
    [Parameter] public EventCallback<ProfessorEvent> OnDeleteEvent { get; set; }
    [Parameter] public EventCallback<ProfessorEvent> OnEditEvent { get; set; }
    [Parameter] public EventCallback<ProfessorEvent> OnToggleEventStatus { get; set; }
     [Parameter] public EventCallback<Student> OnShowStudentDetails { get; set; }
    [Parameter] public EventCallback<Company> OnShowCompanyDetails { get; set; }

    // State for Component
    private string selectedEventFilter = "All";
    private string selectedRegionFilter = "";
    private string selectedTownFilter = "";
    private DateTime? selectedDateFilter;
    
    private List<ProfessorEvent> FilteredEvents = new();
    private List<ProfessorEvent> PaginatedEvents = new();
    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalPages = 1;

    private HashSet<long> selectedProfessorEventIds = new();
    
    // Expansion State
    private long? expandedEventIdForStudents;
    private long? expandedEventIdForCompanies;
    private bool isLoadingStudents;
    private bool isLoadingCompanies;
    
    // Data placeholders for expanded rows
    private List<Student> InterestedStudents = new();
    private List<Company> InterestedCompanies = new();


    protected override void OnParametersSet()
    {
        FilterEvents();
    }

    private void FilterEvents()
    {
        if (AllEvents == null) return;

        var query = AllEvents.AsEnumerable();

        if (selectedEventFilter == "Active")
        {
            query = query.Where(e => e.ProfessorEventStatus == "Active");
        }
        else if (selectedEventFilter == "Inactive")
        {
            query = query.Where(e => e.ProfessorEventStatus != "Active");
        }

        if (!string.IsNullOrEmpty(selectedRegionFilter))
        {
            query = query.Where(e => e.ProfessorEventPerifereiaLocation == selectedRegionFilter);
        }

        if (!string.IsNullOrEmpty(selectedTownFilter))
        {
             query = query.Where(e => e.ProfessorEventDimosLocation == selectedTownFilter);
        }
        
        if (selectedDateFilter.HasValue)
        {
             query = query.Where(e => e.ProfessorEventActiveDate.Date == selectedDateFilter.Value.Date);
        }

        FilteredEvents = query.ToList();
        CalculatePagination();
    }

    private void OnRegionFilterChanged(ChangeEventArgs e)
    {
        selectedRegionFilter = e.Value.ToString();
        selectedTownFilter = ""; // Reset town when region changes
        FilterEvents();
    }
    
    private void ClearFilters()
    {
        selectedEventFilter = "All";
        selectedRegionFilter = "";
        selectedTownFilter = "";
        selectedDateFilter = null;
        FilterEvents();
    }

    private void CalculatePagination()
    {
        TotalPages = (int)Math.Ceiling(FilteredEvents.Count / (double)PageSize);
        if (CurrentPage > TotalPages) CurrentPage = 1;
        if (TotalPages < 1) TotalPages = 1;
        UpdatePaginatedEvents();
    }

    private void UpdatePaginatedEvents()
    {
         PaginatedEvents = FilteredEvents
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        UpdatePaginatedEvents();
    }

    private void ToggleSelectAllEvents(ChangeEventArgs e)
    {
        bool isSelected = (bool)e.Value;
        if (isSelected)
        {
            selectedProfessorEventIds = FilteredEvents.Select(e => e.RNGForEventUploadedAsProfessor).ToHashSet();
        }
        else
        {
            selectedProfessorEventIds.Clear();
        }
    }

    private void ToggleProfessorEventSelection(long eventId, object checkedValue)
    {
        bool isChecked = (bool)checkedValue;
        if (isChecked)
        {
            selectedProfessorEventIds.Add(eventId);
        }
        else
        {
            selectedProfessorEventIds.Remove(eventId);
        }
    }

    private bool AreAllVisibleEventsSelected => FilteredEvents.Any() && selectedProfessorEventIds.Count == FilteredEvents.Count;

    // Expand Logic
    private async Task ExpandStudentInterest(ProfessorEvent evt)
    {
        if (expandedEventIdForStudents == evt.RNGForEventUploadedAsProfessor)
        {
            expandedEventIdForStudents = null; // Collapse
            return;
        }

        expandedEventIdForStudents = evt.RNGForEventUploadedAsProfessor;
        expandedEventIdForCompanies = null; // Close other
        isLoadingStudents = true;
        InterestedStudents.Clear(); // Clear previous
        
        // Fetch interested students from the database
        try 
        {
            var interests = await ProfessorDashboardService.GetProfessorEventStudentInterestsAsync(evt.RNGForEventUploadedAsProfessor);
            var students = new List<Student>();
            foreach (var interest in interests)
            {
                var s = await ProfessorDashboardService.GetStudentByUniqueIdAsync(interest.StudentUniqueIDShowInterestForEvent);
                if (s != null) students.Add(s);
            }
            InterestedStudents = students;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching students: {ex.Message}");
        }
        
        await Task.Delay(500); // Simulate network
        isLoadingStudents = false;
        StateHasChanged();
    }

    private async Task ExpandCompanyInterest(ProfessorEvent evt)
    {
         if (expandedEventIdForCompanies == evt.RNGForEventUploadedAsProfessor)
        {
            expandedEventIdForCompanies = null; // Collapse
            return;
        }

        expandedEventIdForCompanies = evt.RNGForEventUploadedAsProfessor;
        expandedEventIdForStudents = null; 
        isLoadingCompanies = true;
        InterestedCompanies.Clear();
        
        // Simulate fetch
        try
        {
             var interests = await ProfessorDashboardService.GetProfessorEventCompanyInterestsAsync(evt.RNGForEventUploadedAsProfessor);
             var companies = new List<Company>();
             foreach (var interest in interests)
             {
                 var c = await ProfessorDashboardService.GetCompanyByUniqueIdAsync(interest.CompanyUniqueIDShowInterestForProfessorEvent);
                 if (c != null) companies.Add(c);
             }
             InterestedCompanies = companies;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching companies: {ex.Message}");
        }
        
        await Task.Delay(500); 
        isLoadingCompanies = false;
        StateHasChanged();
    }
    
    public enum BulkActionType { Delete, ChangeStatus }
    private void ShowBulkActionModal(BulkActionType type)
    {
        // Emit event to parent to handle bulk action? 
        // Or handle here. For now, just logging.
        Console.WriteLine($"Bulk Action: {type} on {selectedProfessorEventIds.Count} items");
    }
}
