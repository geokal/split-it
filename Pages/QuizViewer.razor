@page "/studentRegistration"

@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging
@using QuizManager.Data
@using QuizManager.Models
@using System.IO
@using System.Reflection.Metadata
@using static System.Net.FileWebRequest
@using System.Security.Claims
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using System.Text;
@using System.Text.RegularExpressions

@inject ILogger<QuizViewer> Logger
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject FileUploadService FileUploadService;
@inject IJSRuntime JSRuntime;
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager


<style>
    /* Base styles */
    body {
        background-color: #f0f0f0;
        color: #000000;
        padding: 0;
        margin: 0;
        min-width: 320px;
    }

    /* Message boxes */
    .error-message, .empty-message, 
    .good-message, .refresh-message {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
    }

    /* Headings */
    h3 {
        font-size: 24px;
        color: #FF5733;
        margin-top: 0;
    }

    h4 {
        font-size: 24px;
        color: darkblue;
        margin-top: 0;
    }

    /* Ultra-wide form container */
    .form-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 20px auto;
        width: 98%;
        max-width: 2400px; /* Extremely wide maximum */
        padding: 0 10px;
        box-sizing: border-box;
    }

    .grouped-section {
        background-color: #ffffff; /* Clean white background like Bootstrap cards */
        padding: 24px; /* Comfortable spacing inside */
        border-radius: 0.5rem; /* Subtle, smooth rounded corners */
        border: 1px solid #2d3748; /* Light gray border consistent with Bootstrap */
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Soft shadow for depth */
        width: 100%;
        min-width: 600px; /* Wide minimum, adjust as needed */
        box-sizing: border-box;
        transition: all 0.2s ease-in-out; /* Smooth hover/interaction transitions */
    }

        /* Optional: subtle hover effect */
        .grouped-section:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1); /* Slightly more prominent shadow */
            transform: translateY(-2px); /* Gentle lift effect */
        }


    /* Form groups - original sizing */
    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        width: 100%;
    }

    .form-group label {
        width: 100%;
        margin-bottom: 5px;
    }

    /* Input fields - original height but wider */
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        max-width: 550px; /* Extra wide inputs */
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    /* Original button sizing */
    .btn, .btn-submit, .btn-submit1, .searchjobs-button {
        padding: 10px 20px;
        font-size: 16px;
        width: auto;
    }

    /* Wide select elements */
    .select-with-arrow {
        position: relative;
        width: 100%;
        max-width: 550px; /* Matches input width */
    }

    /* Responsive behavior */
    @@media (min-width: 1280px) {
        .form-container {
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        .grouped-section {
            flex: 1 1 calc(50% - 20px); /* Two very wide columns */
            min-width: 600px;
        }
    }

   @@media (min-width: 1920px) {
        .form-container {
            flex-wrap: nowrap; /* Three ultra-wide columns */
        }
        
        .grouped-section {
            flex: 1 1 calc(33.33% - 20px);
            min-width: 600px;
        }
    }

    /* Immediate stacking below 1280px */
    @@media (max-width: 1279px) {
        .form-container {
            flex-direction: column;
        }
        .grouped-section {
            width: 100%;
            min-width: 100%;
        }
    }

    .input-with-suffix {
    position: relative;
    display: inline-block;
    width: 100%;
}

    .input-with-suffix-field {
        padding-right: 40px; /* Give space for the suffix */
        width: 100%;
        box-sizing: border-box;
    }

    .input-with-suffix .suffix {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #777;
        pointer-events: none;
    }

    .shake {
        animation: shake 0.5s;
        border: 2px solid red !important;
    }

    @@keyframes shake {
        0% { transform: translateX(0); }
        20% { transform: translateX(-10px); }
        40% { transform: translateX(10px); }
        60% { transform: translateX(-10px); }
        80% { transform: translateX(10px); }
        100% { transform: translateX(0); }
    }

    .shake-input {
        background-color: #fff0f0 !important;
    }

    .error-message {
        color: red;
        font-weight: bold;
        padding: 10px;
        background-color: #fff0f0;
        border: 1px solid red;
        border-radius: 5px;
        margin: 10px 0;
    }

    /* Reuse these styles for all step headings */
    .step-title {
        font-weight: 600;
        font-size: 1.25rem;
        color: #2d3748; /* heading text color */
        display: flex;
        align-items: center; /* vertically center number and text */
        gap: 10px; /* space between circle and text */
    }

    .step-number {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 30px;
        height: 30px;
        border-radius: 50%; /* perfect circle */
        background-color: #2d3748; /* Bootstrap blue */
        color: #ffffff; /* white number */
        font-weight: 600;
        font-size: 1rem;
    }
</style>


@if (!hasReadAsStudentPermission)
{
    @*
    <div class="error-message">
        <p><strong>You are Not a StudentModel</strong></p>
        <p><strong>Please Login as StudentModel!</strong></p>
    </div>
    *@
}
else
{
<h3 style="color: #000000;"><strong>Πληροφορίες Φοιτητή</strong></h3>
    <EditForm Model="@newStudent" OnValidSubmit="SubmitForm">
        <div class="form-container">
            <div class="grouped-section">
                <h4 class="step-title">
                    <span class="step-number">1</span> Προσωπικές Πληροφορίες
                </h4>

                <!-- Fields in * are mandatory -->
                <br />
                <div class="form-group">
                    <label><strong>Φωτογραφία</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-image"></i></span>
                        <InputFile OnChange="HandleFileChangeStudentImage" accept="image/*" class="form-control" />
                    </div>
                    <small class="form-text text-muted">Επιτρεπόμενο Όριο Αρχείου (1MB)</small>
                    @if (!string.IsNullOrEmpty(FileErrorMessage))
                    {
                        <div class="text-danger mt-2">@FileErrorMessage</div>
                    }
                </div>

                <div class="form-group">
                    <label><strong>Email</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        <InputText @bind-Value="Username" readonly class="readonly-input form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Μοναδικό ID Μέλους</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                        <InputText @bind-Value="newStudent.Student.UniqueID"
                                   readonly
                                   class="readonly-input form-control"
                                   style="color: blue;"
                                   placeholder="Δημιουργείται αυτόματα μετά την πρώτη σας Εγγραφή" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Ερευνητική Ομάδα</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-users"></i></span>
                        <InputText @bind-Value="newStudent.NameOfResearchGroupHeIsMember" readonly class="form-control readonly-input" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Όνομα</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <InputText @bind-Value="newStudent.Name" class="@($"{nameInputClass} form-control")" />
                    </div>
                </div>


                <div class="form-group">
                    <label><strong>Επώνυμο</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <InputText @bind-Value="newStudent.Surname" class="@($"{surnameInputClass} form-control")" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Τηλέφωνο</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        <InputText @bind-Value="newStudent.Telephone"
                                   class="@($"{telephoneInputClass} form-control")"
                                   placeholder="+456064213978"
                                   maxlength="13"
                                   pattern="^\+?[0-9]{1,12}$"
                                   title="Παρακαλώ εισάγετε έγκυρο αριθμό τηλεφώνου (π.χ. +30##########)" />
                    </div>
                    @if (!string.IsNullOrEmpty(telephoneValidationMessage))
                    {
                        <div class="text-danger small">@telephoneValidationMessage</div>
                    }
                </div>

                <label><strong>Εμφάνιση Τηλεφώνου</strong></label>
                <div>
                    <InputRadioGroup @bind-Value="newStudent.PhoneVisibility">
                        <InputRadio Value="true" /> Ναι
                        <InputRadio Value="false" /> Όχι
                    </InputRadioGroup>
                </div>
                <br />

                <div class="form-group">
                    <label><strong>Διεύθυνση</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <InputText id="autocomplete"
                               @bind-Value="newStudent.PermanentAddress"
                               class="@($"{addressInputClass} form-control")" />
                </div>

                <div class="form-group">
                    <label><strong>Τ.Κ</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <input type="text"
                           @bind="newStudent.PermanentPC"
                           @oninput="HandlePermanentPCNumberInput"
                           class="@($"{pcInputClass} form-control")"
                           maxlength="5" />
                </div>

                <div class="form-group">
                    <label><strong>Περιφέρεια</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <select @bind="newStudent.PermanentRegion" class="@($"{regionInputClass} select-with-arrow")">
                        <option value="">-- Επιλέξτε Περιφέρεια --</option>
                        @foreach (var region in Regions)
                        {
                            <option value="@region">@region</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><strong>Πόλη</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <select @bind="newStudent.PermanentTown" class="@($"{townInputClass} select-with-arrow")">
                        <option value="">-- Επιλέξτε Πόλη --</option>
                        @if (!string.IsNullOrEmpty(newStudent.PermanentRegion) && RegionToTownsMap.ContainsKey(newStudent.PermanentRegion))
                        {
                            foreach (var town in RegionToTownsMap[newStudent.PermanentRegion])
                            {
                                <option value="@town">@town</option>
                            }
                        }
                    </select>
                </div>

                <br />
                <label><strong>Εμφάνιση Κατοικίας</strong></label>
                <div>
                    <InputRadioGroup @bind-Value="newStudent.HomeVisibility">
                        <InputRadio Value="true" /> Ναι
                        <InputRadio Value="false" /> Όχι
                    </InputRadioGroup>
                </div>
                <br />
                <br />
                <div class="form-group">
                    <label><strong>Επισύναψη Βιογραφικού</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-file-pdf"></i></span>
                        <InputFile OnChange="SingleUploadCV" class="form-control" />
                    </div>
                    <small class="form-text text-muted">Επιτρεπόμενο Όριο Αρχείου (10MB)</small>
                    @if (showCVAlert)
                    {
                        <div class="alert alert-warning" role="alert">
                            You have not attached a CV.
                        </div>
                    }
                </div>
                <br />
                <br />
                <div class="form-group">
                    <label><strong>Προφίλ LinkedIn</strong></label> 
                    <div class="input-group">
                        <span class="input-group-text"><i class="fab fa-linkedin"></i></span>
                        <InputText @bind-Value="newStudent.LinkedInProfile"
                                   class="form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Προσωπική Ιστοσελίδα </strong></label> 
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-link"></i></span>
                        <InputText @bind-Value="newStudent.PersonalWebsite" class="form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Προφίλ Google Scholar</strong></label> 
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-brands fa-google"></i></span>
                        <InputText @bind-Value="newStudent.StudentGoogleScholarProfile"
                                   class="form-control" />
                    </div>
                </div>

                <label><strong>Διαθέτετε Μεταφορικό Μέσο;</strong></label>
                <div>
                    <InputRadioGroup @bind-Value="newStudent.Transport">
                        <InputRadio Value="true" /> Ναι
                        <InputRadio Value="false" /> Όχι
                    </InputRadioGroup>
                </div>
                <br />
                <br />
            </div>

            <div class="grouped-section">
                <h4 class="step-title">
                    <span class="step-number">2</span> Πληροφορίες Φοίτησης
                </h4>

                <div class="form-group">
                    <label><strong>Πανεπιστημιακό Ίδρυμα</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-university"></i></span>
                        <InputText @bind-Value="newStudent.University" readonly class="readonly-input form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Ιδιότητα Μέλους</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <select @bind="newStudent.LevelOfDegree" @bind:event="onchange" class="@($"{levelOfDegreeInputClass} select-with-arrow")">
                        <option value="">-- Επιλέξτε Ιδιότητα --</option>
                        <option value="Προπτυχιακός Φοιτητής">Προπτυχιακός Φοιτητής</option>
                        @foreach (var degreelevel in DegreeLevel.Where(d => d != "Προπτυχιακός Φοιτητής"))
                        {
                            <option value="@degreelevel">@degreelevel</option>
                        }
                    </select>
                </div>

                @if (ShouldShowResearchFields())
                {
                    <div class="form-group">
                        <label><strong> • Τίτλος Έρευνας • </strong></label> <!-- NO * -->
                        <input type="text" class="form-control"
                               @bind="newStudent.WhenStudentIsPostDocOrPhD_ResearchTitle"
                               placeholder="Εισάγετε τον τίτλο της έρευνας" />
                    </div>

                    <div class="form-group">
                        <label><strong> • Περιγραφή Έρευνας • </strong> (μέχρι 300 λέξεις)</label> <!-- NO * -->
                        <textarea class="form-control"
                                  @bind="newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription"
                                  placeholder="Περιγράψτε την έρευνά σας..."
                                  rows="4"
                                  maxlength="2000"></textarea>
                        <small class="text-muted">@GetWordCount()/300 λέξεις</small>
                    </div>
                }

                <label><strong>Έχετε Ολοκληρώσει τις Σπουδές σας</strong></label>
                <div>
                    <InputRadioGroup @bind-Value="newStudent.HasFinishedStudies">
                        <InputRadio Value="true" /> Ναι
                        <InputRadio Value="false" /> Όχι
                    </InputRadioGroup>
                </div>
                <br />

                <div class="form-group">
                    <label><strong>Αριθμός Μητρώου</strong></label> <!-- REMOVED * -->
                    <input id="registryNumber"
                           @bind="FormattedRegNumber"
                           type="text"
                           class="form-control"
                           placeholder="XXXX-YYYY-ZZZZZ"
                           @oninput="HandleRegistryNumberInput"
                           @onblur="ValidateRegistryNumber" />
                    <div id="registryNumberValidationMessage" class="invalid-feedback" style="display: none;">Λανθασμένος Αριθμός Μητρώου</div>
                    <div id="xxxxValidationMessage" class="invalid-feedback" style="display: none;">Λανθασμένο XXXX: Πρέπει να είναι: 1115, 1116, 1117, 1118 ή 1119</div>
                    <div id="yyyyValidationMessage" class="invalid-feedback" style="display: none;">Λανθασμένο YYYY: Πρέπει να είναι μεταξύ: 2010 και Σημερινής Χρονιάς</div>
                    <div id="zzzzzValidationMessage" class="invalid-feedback" style="display: none;">Λανθασμένο ZZZZZ: Πρέπει να είναι: 00xxx με xxx μεταξύ 1 και 300</div>
                </div>

                <!-- Add School dropdown before Department -->
                <div class="form-group">
                    <label><strong>Σχολή</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <select value="@newStudent.School"
                            @onchange="OnSchoolChange"
                            class="@($"{schoolInputClass} select-with-arrow")">
                        <option value="">-- Επιλογή Σχολής --</option>
                        @foreach (var school in schools)
                        {
                            <option value="@school">@school</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><strong>Τμήμα</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <select value="@newStudent.Department"
                            @onchange="OnDepartmentChange"
                            class="@($"{departmentInputClass} select-with-arrow")"
                            disabled="@(string.IsNullOrEmpty(newStudent.School))">
                        <option value="">-- Επιλογή Τμήματος --</option>
                        @if (!string.IsNullOrEmpty(newStudent.School))
                        {
                            @foreach (var department in departments)
                            {
                                <option value="@department">@department</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><strong>Έτος Εγγραφής</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        <InputText @bind-Value="newStudent.EnrollmentDate"
                                   class="@($"{enrollmentDateInputClass} form-control")"
                                   placeholder="π.χ 2025" />
                    </div>
                    <small style="font-style: italic; color: gray;">Συμπληρώνεται αυτόματα από το Α.Μ</small>
                </div>

                <div class="form-group">
                    <label><strong>Έτος Φοίτησης</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        <InputText @bind-Value="newStudent.StudyYear"
                                   class="@($"{studyYearInputClass} form-control")"
                                   placeholder="π.χ 6"
                                   maxlength="4" />
                    </div>
                    <small style="font-style: italic; color: gray;">Συμπληρώνεται αυτόματα από το Α.Μ</small>
                </div>

                <div class="form-group">
                    <label><strong>Αναμενόμενη Ημερομηνία Αποφοίτησης</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-group">
                        <InputDate @bind-Value="newStudent.ExpectedGraduationDate" 
                                   min="@MinGraduationDate.ToString("yyyy-MM-dd")"
                                   class="@($"{graduationDateInputClass} form-control")" />
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Συμπληρωμένες Διδακτικές Μονάδες</strong><span style="color: red; font-weight: bold;"> *</span></label>
                    <div class="input-with-suffix">
                        <input id="completedEctsInput" @bind="newStudent.CompletedECTS" type="text" class="@($"{ectsInputClass} input-with-suffix-field")" @oninput="HandleCompletedEctsInput" @onblur="ValidateCompletedEcts" />
                        <span class="suffix">/240</span>
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Επισύναψη Αναλυτικής Βαθμολογίας</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                        <InputFile OnChange="SingleUploadTranscripts" class="form-control" />
                    </div>
                    <small class="form-text text-muted">Επιτρεπόμενο Όριο Αρχείου (10MB)</small>
                    @if (!string.IsNullOrEmpty(TranscriptsErrorMessage))
                    {
                        <div class="text-danger mt-2">@TranscriptsErrorMessage</div>
                    }
                </div>
                <br />
                <div class="form-group">
                    <label><strong>Κατάσταση Πρακτικής Άσκησης</strong></label> 
                    <InputSelect @bind-Value="newStudent.InternshipStatus" class="form-control">
                        <option value="Ενδιαφέρομαι για θέση Πρακτικής Άσκησης">Ενδιαφέρομαι για θέση Πρακτικής Άσκησης</option>
                        <option value="Έχω ήδη αναλάβει Πρακτική Άσκηση">Έχω ήδη αναλάβει Πρακτική Άσκηση</option>
                        <option value="Δεν ενδιαφέρομαι για ανάληψη Πρακτικής Άσκησης προς το παρόν">Δεν ενδιαφέρομαι για ανάληψη Πρακτικής Άσκησης προς το παρόν</option>
                    </InputSelect>
                </div>
                <br />
                <div class="form-group">
                    <label><strong>Κατάσταση Διπλωματικής Εργασίας</strong></label> 
                    <InputSelect @bind-Value="newStudent.ThesisStatus" class="form-control">
                        <option value="Ενδιαφέρομαι για ανάληψη Διπλωματικής Εργασίας">Ενδιαφέρομαι για ανάληψη Διπλωματικής Εργασίας</option>
                        <option value="Έχω ήδη αναλάβει Διπλωματική Εργασία">Έχω ήδη αναλάβει Διπλωματική Εργασία</option>
                        <option value="Δεν ενδιαφέρομαι για ανάληψη Διπλωματικής Εργασίας προς το παρόν">Δεν ενδιαφέρομαι για ανάληψη Διπλωματικής Εργασίας προς το παρόν</option>
                    </InputSelect>
                </div>
            </div>

            <div class="grouped-section">
                <h4 class="step-title">
                    <span class="step-number">3</span> Δεξιότητες & Εξειδίκευση
                </h4>


                <!-- Areas of Expertise Validation Message -->
                @if (!string.IsNullOrEmpty(areasValidationMessage))
                {
                    <div class="alert alert-danger">@areasValidationMessage</div>
                }

                <div class="form-group">
                    <label>
                        <strong>Περιοχές Εξειδίκευσης</strong>
                        <span style="color: red; font-weight: bold;"> *</span>
                        <span class="ms-1" data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              data-bs-html="true"
                              title="Προσθήκη Προσαρμοσμένης Περιοχής: Πληκτρολογήστε το Όνομα της Περιοχής που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
                            <i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
                        </span>
                    </label>
                    
                    <!-- Search field with icon and custom area button - RESTRUCTURED -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="input-group flex-grow-1 mr-2">
                            <input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Περιοχής"
                                   @bind="areassearchTerm" @oninput="FilterAvailableAreas"
                                   @onfocus="ClearSearchSelection" />
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success align-self-start"
                                @onclick="async () => await AddCustomAreaFromSearch()"
                                title="Προσθήκη προσαρμοσμένης περιοχής"
                                style="white-space: nowrap; height: 45px; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i> Προσθήκη
                        </button>
                    </div>

                    <div class="d-flex align-items-center">
                        <!-- Available areas box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-list-alt" style="color: #4682b4; font-size: 1.2rem;"></i>
                                <span class="ml-2">Διαθέσιμες Περιοχές</span>
                            </div>
                            <select id="availableAreas" class="form-control" size="10" multiple
                                    @onchange="OnAvailableAreaSelectionChanged" style="height: 200px;">
                                @foreach (var area in filteredAreas)
                                {
                                    <option @key="@($"area-{area.AreaName}")" value="@($"area:{area.AreaName}")"
                                            @onclick="() => ToggleExpansion(area.AreaName)">
                                        @area.AreaName
                                    </option>
                                    @if (expandedAreas.Contains(area.AreaName))
                                    {
                                        var subFields = area.AreaSubFields?.Split(',');
                                        if (subFields != null)
                                        {
                                            foreach (var subField in subFields)
                                            {
                                                <!-- Include parent area name in the key to make it unique -->
                                                <option @key="@($"subfield-{area.AreaName}-{subField}")"
                                                        value="@($"subfield:{subField}")"
                                                        style="padding-left: 20px;">• @subField</option>
                                            }
                                        }
                                    }
                                }
                            </select>
                        </div>

                        <!-- Move buttons -->
                        <div class="d-flex flex-column mx-1">
                            <button type="button" class="btn btn-outline-primary mb-1 px-2" @onclick="async () => await MoveSelectedAreaToRight()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedAreaToLeft">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- Selected areas box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
                                <span class="ml-2">Επιλεγμένες Περιοχές</span>
                            </div>
                            <select id="selectedAreas" class="form-control @areasValidationClass"
                                    size="10" multiple @onchange="OnSelectedAreaSelectionChanged" style="height: 200px;">
                                @foreach (var selectedItem in selectedAreasForAssessment)
                                {
                                    @if (selectedItem.IsSubField)
                                    {
                                        <option @key="@($"selected-{selectedItem.UniqueId}")"
                                                value="@($"subfield:{selectedItem.FullName}")">
                                            @selectedItem.DisplayName <span style="color: #666; font-size: 0.9em;"></span>
                                        </option>
                                    }
                                    else
                                    {
                                        var isCustomArea = IsCustomArea(selectedItem.FullName);
                                        <option @key="@($"selected-{selectedItem.UniqueId}")"
                                                value="@($"area:{selectedItem.FullName}")"
                                                style="@(isCustomArea ? "color: blue; font-style: italic;" : "")">
                                            @selectedItem.DisplayName <span style="color: #666; font-size: 0.9em;">@(isCustomArea ? "(Προσαρμοσμένη)" : "")</span>
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="assessment-container mt-3">
                        @if (selectedAreasForAssessment.Any())
                        {
                            <label><strong>Αυτοαξιολόγηση Περιοχών Εξειδίκευσης</strong></label>
                            @foreach (var selectedArea in selectedAreasForAssessment)
                            {
                                <div class="d-flex align-items-center mt-2">
                                    <label class="mr-2" style="color: #2d3748; text-decoration: underline;">
                                        @selectedArea.DisplayName
                                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                                            @(selectedArea.IsSubField ? "(Υποκατηγορία)" : IsCustomArea(selectedArea.FullName) ? "(Προσαρμοσμένη)" : "")
                                        </span>:
                                    </label>
                                    <select @bind="selectedArea.Assessment" class="form-control" style="width: 60px;">
                                        @for (int i = 1; i <= 10; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Target Areas Validation Message -->
                @if (!string.IsNullOrEmpty(targetAreasValidationMessage))
                {
                    <div class="alert alert-danger">@targetAreasValidationMessage</div>
                }

                <div class="form-group">
                    <label>
                        <strong>Περιοχές Ενδιαφέροντος</strong>
                        <span style="color: red; font-weight: bold;"> *</span>
                        <span class="ms-1" data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              data-bs-html="true"
                              title="Προσθήκη Προσαρμοσμένης Περιοχής: Πληκτρολογήστε το Όνομα της Περιοχής που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
                            <i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
                        </span>
                    </label>

                    <!-- Search field with icon and custom target area button - RESTRUCTURED -->
                    <div class="d-flex align-items-start mb-3">
                        <div class="input-group flex-grow-1 mr-2">
                            <input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Περιοχής"
                                   @bind="targetAreasSearchTerm" @oninput="FilterAvailableTargetAreas"
                                   @onfocus="ClearTargetSearchSelection" />
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success align-self-start"
                                @onclick="async () => await AddCustomTargetAreaFromSearch()"
                                title="Προσθήκη προσαρμοσμένης περιοχής ενδιαφέροντος"
                                style="white-space: nowrap; height: 45px; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i> Προσθήκη
                        </button>
                    </div>

                    <div class="d-flex align-items-center">
                        <!-- Available target areas box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-list-alt" style="color: #4682b4; font-size: 1.2rem;"></i>
                                <span class="ml-2">Διαθέσιμες Περιοχές</span>
                            </div>
                            <select id="availableTargetAreas" class="form-control" size="10" multiple
                                    @onchange="OnAvailableTargetAreaSelectionChanged" style="height: 200px;">
                                @foreach (var area in filteredTargetAreas)
                                {
                                    <option @key="@($"target-area-{area.AreaName}")" value="@($"area:{area.AreaName}")"
                                            @onclick="() => ToggleTargetAreaExpansion(area.AreaName)">
                                        @area.AreaName
                                    </option>
                                    @if (expandedTargetAreas.Contains(area.AreaName))
                                    {
                                        var subFields = area.AreaSubFields?.Split(',');
                                        if (subFields != null)
                                        {
                                            foreach (var subField in subFields)
                                            {
                                                <!-- Include parent area name in the key to make it unique -->
                                                <option @key="@($"target-subfield-{area.AreaName}-{subField}")"
                                                        value="@($"subfield:{subField}")"
                                                        style="padding-left: 20px;">• @subField</option>
                                            }
                                        }
                                    }
                                }
                            </select>
                        </div>

                        <!-- Move buttons -->
                        <div class="d-flex flex-column mx-1">
                            <button type="button" class="btn btn-outline-primary mb-1 px-2" @onclick="async () => await MoveSelectedTargetAreaToRight()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedTargetAreaToLeft">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- Selected target areas box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
                                <span class="ml-2">Επιλεγμένες Περιοχές</span>
                            </div>
                            <select id="selectedTargetAreas" class="form-control @targetAreasValidationClass"
                                    size="10" multiple @onchange="OnSelectedTargetAreaSelectionChanged" style="height: 200px;">
                                @foreach (var selectedItem in selectedTargetAreasForAssessment)
                                {
                                    @if (selectedItem.IsSubField)
                                    {
                                        <option @key="@($"selected-target-{selectedItem.UniqueId}")"
                                                value="@($"subfield:{selectedItem.FullName}")">
                                            @selectedItem.DisplayName <span style="color: #666; font-size: 0.9em;"></span>
                                        </option>
                                    }
                                    else
                                    {
                                        var isCustomArea = IsCustomTargetArea(selectedItem.FullName);
                                        <option @key="@($"selected-target-{selectedItem.UniqueId}")"
                                                value="@($"area:{selectedItem.FullName}")"
                                                style="@(isCustomArea ? "color: blue; font-style: italic;" : "")">
                                            @selectedItem.DisplayName <span style="color: #666; font-size: 0.9em;">@(isCustomArea ? "(Προσαρμοσμένη)" : "")</span>
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <br />
                <br />

                <!-- Skills Validation Message -->
                @if (!string.IsNullOrEmpty(skillsValidationMessage))
                {
                    <div class="alert alert-danger">@skillsValidationMessage</div>
                }

                <!-- Skills Validation Message -->
                @if (!string.IsNullOrEmpty(skillsValidationMessage))
                {
                    <div class="alert alert-danger">@skillsValidationMessage</div>
                }

                <div class="form-group">
                    <label>
                        <strong>Τεχνικές Ικανότητες</strong>
                        <span style="color: red; font-weight: bold;"> *</span>
                        <span class="ms-1" data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              data-bs-html="true"
                              title="Προσθήκη Προσαρμοσμένης Ικανότητας: Πληκτρολογήστε το Όνομα της Ικανότητας που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
                            <i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
                        </span>
                    </label>

                    <!-- Search field with icon and custom skill button - RESTRUCTURED -->
                    <div class="d-flex align-items-start mb-3">
                        <div class="input-group flex-grow-1 mr-2">
                            <input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Ικανότητας"
                                   @bind="skillsSearchTerm"
                                   @oninput="FilterAvailableSkills"
                                   @onfocus="ClearSkillSearchSelection" />
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success align-self-start"
                                @onclick="async () => await AddCustomSkillFromSearch()"
                                title="Προσθήκη προσαρμοσμένης ικανότητας"
                                style="white-space: nowrap; height: 45px; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i> Προσθήκη
                        </button>
                    </div>

                    
                    <div class="d-flex align-items-center">
                        <!-- Available skills box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-list-alt" style="color: #4682b4; font-size: 1.2rem;"></i>
                                <span class="ml-2">Διαθέσιμες Ικανότητες</span>
                            </div>
                            <select id="availableSkills" class="form-control" size="10" multiple
                                    @onchange="OnAvailableSkillSelectionChanged" style="height: 200px;">
                                @foreach (var skill in filteredSkills)
                                {
                                    <option @key="@($"skill-{skill.SkillName}")" value="@skill.SkillName">
                                        @skill.SkillName
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Move buttons -->
                        <div class="d-flex flex-column mx-1">
                            <button type="button" class="btn btn-outline-primary mb-1 px-2"
                                    @onclick="async () => await MoveSelectedSkillToRight()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedSkillToLeft">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- Selected skills box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
                                <span class="ml-2">Επιλεγμένες Ικανότητες</span>
                            </div>
                            <select id="selectedSkills" class="form-control @skillsValidationClass"
                                    size="10" multiple @onchange="OnSelectedSkillSelectionChanged" style="height: 200px;">
                                @foreach (var selectedSkill in selectedSkillsForAssessment)
                                {
                                    var isCustomSkill = IsCustomSkill(selectedSkill.SkillName);
                                    <option @key="@($"selected-skill-{selectedSkill.SkillName}")"
                                            value="@selectedSkill.SkillName"
                                            style="@(isCustomSkill ? "color: blue; font-style: italic;" : "")">
                                        @selectedSkill.SkillName <span style="color: #666; font-size: 0.9em;">@(isCustomSkill ? "(Προσαρμοσμένη)" : "")</span>
                                    </option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="assessment-container mt-3">
                        @if (selectedSkillsForAssessment.Any())
                        {
                            <label><strong>Αυτοαξιολόγηση Τεχνικών Ικανοτήτων</strong></label>
                            @foreach (var selectedSkill in selectedSkillsForAssessment)
                            {
                                <div class="d-flex align-items-center mt-2">
                                    <label class="mr-2" style="color: #2d3748; text-decoration: underline;">
                                        @selectedSkill.SkillName
                                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                                            @(IsCustomSkill(selectedSkill.SkillName) ? "(Προσαρμοσμένη)" : "")
                                        </span>:
                                    </label>
                                    <select @bind="selectedSkill.Assessment" class="form-control" style="width: 60px;">
                                        @for (int i = 1; i <= 10; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Target Skills Validation Message -->
                @if (!string.IsNullOrEmpty(targetSkillsValidationMessage))
                {
                    <div class="alert alert-danger">@targetSkillsValidationMessage</div>
                }

                <div class="form-group">
                    <label>
                        <strong>Τεχνικές Ικανότητες Ενδιαφέροντος</strong>
                        <span style="color: red; font-weight: bold;"> *</span>
                        <span class="ms-1" data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              data-bs-html="true"
                              title="Προσθήκη Προσαρμοσμένης Ικανότητας: Πληκτρολογήστε το Όνομα της Ικανότητας που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
                            <i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
                        </span>
                    </label>

                    <!-- Search field with icon and custom target skill button - RESTRUCTURED -->
                    <div class="d-flex align-items-start mb-3">
                        <div class="input-group flex-grow-1 mr-2">
                            <input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Ικανότητας"
                                   @bind="targetSkillsSearchTerm"
                                   @oninput="FilterAvailableTargetSkills"
                                   @onfocus="ClearTargetSkillSearchSelection" />
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success align-self-start"
                                @onclick="async () => await AddCustomTargetSkillFromSearch()"
                                title="Προσθήκη προσαρμοσμένης ικανότητας ενδιαφέροντος"
                                style="white-space: nowrap; height: 45px; margin-left: 10px;">
                            <i class="fas fa-plus-circle"></i> Προσθήκη
                        </button>
                    </div>

                    <div class="d-flex align-items-center">
                        <!-- Available target skills box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-cogs" style="color: #4682b4; font-size: 1.2rem;"></i>
                                <span class="ml-2">Διαθέσιμες Ικανότητες</span>
                            </div>
                            <select id="availableTargetSkills" class="form-control" size="10" multiple
                                    @onchange="OnAvailableTargetSkillSelectionChanged" style="height: 200px;">
                                @foreach (var skill in filteredTargetSkills)
                                {
                                    <option @key="@($"target-skill-{skill.SkillName}")" value="@skill.SkillName">
                                        @skill.SkillName
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Move buttons -->
                        <div class="d-flex flex-column mx-1">
                            <button type="button" class="btn btn-outline-primary mb-1 px-2"
                                    @onclick="async () => await MoveSelectedTargetSkillToRight()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedTargetSkillToLeft">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- Selected target skills box -->
                        <div style="width: 45%;">
                            <div class="text-center mb-1">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
                                <span class="ml-2">Επιλεγμένες Ικανότητες</span>
                            </div>
                            <select id="selectedTargetSkills" class="form-control @targetSkillsValidationClass"
                                    size="10" multiple @onchange="OnSelectedTargetSkillSelectionChanged" style="height: 200px;">
                                @foreach (var selectedTargetSkill in selectedTargetSkillsForAssessment)
                                {
                                    var isCustomSkill = IsCustomTargetSkill(selectedTargetSkill.SkillName);
                                    <option @key="@($"selected-target-skill-{selectedTargetSkill.SkillName}")"
                                            value="@selectedTargetSkill.SkillName"
                                            style="@(isCustomSkill ? "color: blue; font-style: italic;" : "")">
                                        @selectedTargetSkill.SkillName <span style="color: #666; font-size: 0.9em;">@(isCustomSkill ? "(Προσαρμοσμένη)" : "")</span>
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <br />
                <div class="form-group">
                    <label><strong>Επισύναψη Συνοδευτικής Επιστολής</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-file-text"></i></span>
                        <InputFile OnChange="SingleUploadCoverLetter" class="form-control" />
                    </div>
                    <small class="form-text text-muted">Επιτρεπόμενο Όριο Αρχείου (10MB)</small>
                    @if (!string.IsNullOrEmpty(CoverLetterErrorMessage))
                    {
                        <div class="text-danger mt-2">@CoverLetterErrorMessage</div>
                    }
                </div>
                <br />
                <br />

                <div class="form-group">
                    <label><strong>Προτιμώμενες Περιοχές/Περιφέρειες</strong></label>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tbody>
                                @for (var rowIndex = 0; rowIndex < Math.Ceiling((double)(Regions.Count + 1) / 3); rowIndex++)
                                {
                                    <tr>
                                        @for (var colIndex = 0; colIndex < 3; colIndex++)
                                        {
                                            var index = rowIndex * 3 + colIndex;
                                            if (index < Regions.Count)
                                            {
                                                var region = Regions[index];
                                                <td style="padding: 5px; border: none; width: 33%;">
                                                    <div class="custom-control custom-checkbox d-flex align-items-center">
                                                        <input type="checkbox" class="custom-control-input" id="@($"region_{region.Replace(" ", "_")}")"
                                                               checked="@(selectedRegionsDictionary.ContainsKey(region) && selectedRegionsDictionary[region])"
                                                               @onchange="@(e => UpdateRegionSelection(region, (bool)e.Value))"
                                                               style="width: 14px; height: 14px; margin-right: 5px;" />
                                                        <label class="custom-control-label small mb-0" for="@($"region_{region.Replace(" ", "_")}")" style="font-size: 12px;">@region</label>
                                                    </div>
                                                </td>
                                            }
                                            else if (index == Regions.Count)
                                            {
                                                <td style="padding: 5px; border: none; width: 33%;">
                                                    <div class="custom-control custom-checkbox d-flex align-items-center">
                                                        <input type="checkbox" class="custom-control-input" id="selectAllRegions"
                                                               @onchange="SelectAllRegions" style="width: 14px; height: 14px; margin-right: 5px;" />
                                                        <label class="custom-control-label small mb-0" for="selectAllRegions" style="font-size: 12px;">Επιλογή Όλων</label>
                                                    </div>
                                                </td>
                                            }
                                            else
                                            {
                                                <td style="padding: 5px; border: none;"></td>
                                            }
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Προτιμώμενες Πόλεις</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                        <div class="form-control">
                            <InputRadioGroup @bind-Value="newStudent.PreferredTownsBoolean">
                                <InputRadio Value="true" /> Ναι
                                <InputRadio Value="false" /> Όχι
                            </InputRadioGroup>
                        </div>
                    </div>
                </div>

                @if (newStudent.PreferredTownsBoolean)
                {
                    <div class="form-group mt-3">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                    @foreach (var region in Regions.Where(r => selectedRegionsDictionary.ContainsKey(r) && selectedRegionsDictionary[r]))
                                    {
                                        <tr>
                                            <td style="font-weight: bold; width: 150px;">@region:</td>
                                            <td>
                                                <div class="row">
                                                    @if (RegionToTownsMap.TryGetValue(region, out var towns))
                                                    {
                                                        @foreach (var town in towns)
                                                        {
                                                            <div class="col-md-4">
                                                                <div class="custom-control custom-checkbox d-flex align-items-center">
                                                                    <input type="checkbox"
                                                                           checked="@(selectedTownsDictionary.TryGetValue(town, out var isSelected) && isSelected)"
                                                                           @onchange="@(e => UpdateTownSelection(town, (bool)e.Value))"
                                                                           id="@($"town_{town.Replace(" ", "_")}")"
                                                                           style="width: 14px; height: 14px; margin-right: 5px;" />
                                                                    <label class="custom-control-label small mb-0"
                                                                           for="@($"town_{town.Replace(" ", "_")}")"
                                                                           style="font-size: 12px;">@town</label>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        </div>
        <br />
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Σφάλμα:</strong> @errorMessage
            </div>
        }
        @* SUBMIT FORM BUTTON AND AGREEMENT *@
        <!-- Only show terms agreement for new registrations -->
        @if (!isRegistered)
        {
            <div class="form-check mb-4">
                <CustomCheckbox @bind-Value="agreeTerms" @ref="customCheckbox" />
                <label class="form-check-label" for="customCheckboxId">
                    Για Εγγραφή θα πρέπει να Αποδεχτείτε τους όρους συμμετοχής στην Πλατφόρμα.
                </label>
            </div>
        }

        <!-- Buttons -->
        @if (!isRegistered)
        {
            <button type="button" class="btn btn-lg shadow px-4" 
                    style="background-color: #2d3748; border-color: #2d3748; color: white;"
                    @onclick="HandleSaveButtonClick" 
                    disabled="@(termsAccepted && !canSubmit)">
                <i class="fas fa-save me-2"></i>
                @GetSaveButtonText()
            </button>

            @if (termsAccepted)
            {
                <div class="mt-2">
                    <small class="text-success">
                        <i class="fas fa-check-circle me-1"></i>Έχετε αποδεχτεί τους όρους συμμετοχής. Κάντε "Ολοκλήρωση Εγγραφής" για Αποθήκευση.
                    </small>
                </div>
            }
        }
        else
        {
            <button type="submit" class="btn btn-lg shadow px-4" 
                    style="background-color: #2d3748; border-color: #2d3748; color: white;"
                    @onclick="UpdateStudentRegistration">
                <i class="fas fa-sync-alt me-2"></i>Ανανέωση Στοιχείων
            </button>

            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-check-circle me-1"></i>Οι όροι χρήσης έχουν ήδη γίνει αποδεκτοί
                </small>
            </div>
        }

        <UserAgreementModal OnAgree="AgreeToTermsAsync" OnDecline="DeclineTermsAsync" />

        <!-- Your existing messages section remains the same -->
        @if (updated)
        {
            <div class="mt-3">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-check-circle me-2"></i>Η Ανανέωση των στοιχείων σας πραγματοποιήθηκε με Επιτυχία! Περιμένετε για Ανανέωση Σελίδας.... </strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        }
        @if (saved)
        {
            <div class="mt-3">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-check-circle me-2"></i>Η Εγγραφή σας Ολοκληρώθηκε Με Επιτυχία!</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        }
        @if (error)
        {
            <div class="mt-3">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Η Εγγραφή Σας Απέτυχε</strong>
                    <p class="mb-0">Ανανεώστε Την Σελίδα Και Προσπαθήστε ξανά</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        }
        <br />
        <br />
    </EditForm>
}

<!-- Loading Modal for StudentModel Form Submission -->
@if (showLoadingModalWhenSubmitStudentForm)
{
    <div class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p>Αποθήκευση στοιχείων φοιτητή...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: @loadingProgressWhenSubmitStudentForm%"></div>
            </div>
        </div>
    </div>
}
<!-- Loading Modal for StudentModel Registration Update -->
@if (showLoadingModalWhenUpdateStudentRegistration)
{
    <div class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p>Ενημέρωση στοιχείων φοιτητή...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: @loadingProgressWhenUpdateStudentRegistration%"></div>
            </div>
        </div>
    </div>
}


@inject IJSRuntime JS
@code {

    private bool termsAccepted = false; 
    private bool canSubmit = false; 
    private bool isSubmitting = false; 
    private DateTime MinGraduationDate => DateTime.Today.AddDays(1); 


    private string GetSaveButtonText()
    {
        if (termsAccepted && canSubmit)
            return "Ολοκλήρωση Εγγραφής";
        else if (termsAccepted)
            return "Αποθήκευση (Έτοιμο)";
        else
            return "Αποθήκευση";
    }

    private Dictionary<string, List<string>> schoolDepartments = new()
        {
            ["ΑΓΡΟΤΙΚΗΣ ΑΝΑΠΤΥΞΗΣ, ΔΙΑΤΡΟΦΗΣ ΚΑΙ ΑΕΙΦΟΡΙΑΣ"] = new List<string>
    {
        "ΤΜΗΜΑ ΑΓΡΟΤΙΚΗΣ ΑΝΑΠΤΥΞΗΣ, ΑΓΡΟΔΙΑΤΡΟΦΗΣ ΚΑΙ ΔΙΑΧΕΙΡΙΣΗΣ ΦΥΣΙΚΩΝ ΠΟΡΩΝ"
    },
            ["ΕΠΙΣΤΗΜΩΝ ΑΓΩΓΗΣ"] = new List<string>
    {
        "ΠΑΙΔΑΓΩΓΙΚΟ ΤΜΗΜΑ ΔΗΜΟΤΙΚΗΣ ΕΚΠΑΙΔΕΥΣΗΣ",
        "ΤΜΗΜΑ ΕΚΠΑΙΔΕΥΣΗΣ ΚΑΙ ΑΓΩΓΗΣ ΣΤΗΝ ΠΡΟΣΧΟΛΙΚΗ ΗΛΙΚΙΑ"
    },
            ["ΕΠΙΣΤΗΜΩΝ ΥΓΕΙΑΣ"] = new List<string>
    {
        "ΤΜΗΜΑ ΙΑΤΡΙΚΗΣ",
        "ΤΜΗΜΑ ΝΟΣΗΛΕΥΤΙΚΗΣ",
        "ΤΜΗΜΑ ΟΔΟΝΤΙΑΤΡΙΚΗΣ",
        "ΤΜΗΜΑ ΦΑΡΜΑΚΕΥΤΙΚΗΣ"
    },
            ["ΕΠΙΣΤΗΜΗΣ ΦΥΣΙΚΗΣ ΑΓΩΓΗΣ ΚΑΙ ΑΘΛΗΤΙΣΜΟΥ"] = new List<string>
    {
        "ΤΜΗΜΑ ΕΠΙΣΤΗΜΗΣ ΦΥΣΙΚΗΣ ΑΓΩΓΗΣ ΚΑΙ ΑΘΛΗΤΙΣΜΟΥ"
    },
            ["ΘΕΟΛΟΓΙΚΗ"] = new List<string>
    {
        "ΤΜΗΜΑ ΘΕΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΚΟΙΝΩΝΙΚΗΣ ΘΕΟΛΟΓΙΑΣ ΚΑΙ ΘΡΗΣΚΕΙΟΛΟΓΙΑΣ"
    },
            ["ΘΕΤΙΚΩΝ ΕΠΙΣΤΗΜΩΝ"] = new List<string>
    {
        "ΤΜΗΜΑ ΑΕΡΟΔΙΑΣΤΗΜΙΚΗΣ ΕΠΙΣΤΗΜΗΣ ΚΑΙ ΤΕΧΝΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΒΙΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΓΕΩΛΟΓΙΑΣ ΚΑΙ ΓΕΩΠΕΡΙΒΑΛΛΟΝΤΟΣ",
        "ΤΜΗΜΑ ΙΣΤΟΡΙΑΣ ΚΑΙ ΦΙΛΟΣΟΦΙΑΣ ΤΗΣ ΕΠΙΣΤΗΜΗΣ",
        "ΤΜΗΜΑ ΜΑΘΗΜΑΤΙΚΩΝ",
        "ΤΜΗΜΑ ΠΛΗΡΟΦΟΡΙΚΗΣ ΚΑΙ ΤΗΛΕΠΙΚΟΙΝΩΝΙΩΝ",
        "ΤΜΗΜΑ ΤΕΧΝΟΛΟΓΙΩΝ ΨΗΦΙΑΚΗΣ ΒΙΟΜΗΧΑΝΙΑΣ",
        "ΤΜΗΜΑ ΦΥΣΙΚΗΣ",
        "ΤΜΗΜΑ ΧΗΜΕΙΑΣ"
    },
            ["ΝΟΜΙΚΗ"] = new List<string>
    {
        "ΝΟΜΙΚΗ ΣΧΟΛΗ"
    },
            ["ΟΙΚΟΝΟΜΙΚΩΝ ΚΑΙ ΠΟΛΙΤΙΚΩΝ ΕΠΙΣΤΗΜΩΝ"] = new List<string>
    {
        "ΤΜΗΜΑ ΔΙΑΧΕΙΡΙΣΗΣ ΛΙΜΕΝΩΝ ΚΑΙ ΝΑΥΤΙΛΙΑΣ",
        "ΤΜΗΜΑ ΕΠΙΚΟΙΝΩΝΙΑΣ ΚΑΙ ΜΕΣΩΝ ΜΑΖΙΚΗΣ ΕΝΗΜΕΡΩΣΗΣ",
        "ΤΜΗΜΑ ΟΙΚΟΝΟΜΙΚΩΝ ΕΠΙΣΤΗΜΩΝ",
        "ΤΜΗΜΑ ΠΟΛΙΤΙΚΗΣ ΕΠΙΣΤΗΜΗΣ ΚΑΙ ΔΗΜΟΣΙΑΣ ΔΙΟΙΚΗΣΗΣ",
        "ΤΜΗΜΑ ΤΟΥΡΚΙΚΩΝ ΣΠΟΥΔΩΝ ΚΑΙ ΣΥΓΧΡΟΝΩΝ ΑΣΙΑΤΙΚΩΝ ΣΠΟΥΔΩΝ",
        "ΤΜΗΜΑ ΔΙΟΙΚΗΣΗΣ ΕΠΙΧΕΙΡΗΣΕΩΝ ΚΑΙ ΟΡΓΑΝΙΣΜΩΝ",
        "ΤΜΗΜΑ ΚΟΙΝΩΝΙΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΨΗΦΙΑΚΩΝ ΤΕΧΝΩΝ ΚΑΙ ΚΙΝΗΜΑΤΟΓΡΑΦΟΥ"
    },
            ["ΦΙΛΟΣΟΦΙΚΗ"] = new List<string>
    {
        "ΠΑΙΔΑΓΩΓΙΚΟ ΤΜΗΜΑ ΔΕΥΤΕΡΟΒΑΘΜΙΑΣ ΕΚΠΑΙΔΕΥΣΗΣ",
        "ΤΜΗΜΑ ΑΓΓΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΓΑΛΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΓΕΡΜΑΝΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟGFIAΣ",
        "ΤΜΗΜΑ ΘΕΑΤΡΙΚΩΝ ΣΠΟΥΔΩΝ",
        "ΤΜΗΜΑ ΙΣΠΑΝΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΙΣΤΟΡΙΑΣ ΚΑΙ ΑΡΧΑΙΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΙΤΑΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΜΟΥΣΙΚΩΝ ΣΠΟΥΔΩΝ",
        "ΤΜΗΜΑ ΡΩΣΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ ΚΑΙ ΣΛΑΒΙΚΩΝ ΣΠΟΥΔΩΝ",
        "ΤΜΗΜΑ ΦΙΛΟΛΟΓΙΑΣ",
        "ΤΜΗΜΑ ΦΙΛΟΣΟΦΙΑΣ",
        "ΤΜΗΜΑ ΨΥΧΟΛΟΓΙΑΣ"
    }
        };

    private bool ShouldShowResearchFields()
    {
        return newStudent.LevelOfDegree == "Υποψήφιος Διδάκτορας" || 
               newStudent.LevelOfDegree == "Μεταδιδακτορικός";
    }

    // Add this method to display word count
    private int GetWordCount()
    {
        if (string.IsNullOrEmpty(newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription))
            return 0;

        return newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription
            .Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries)
            .Length;
    }

    private List<string> schools = new();
    private List<string> departments = new();

    private string googleScholarInputClass = "";
    private string areassearchTerm = string.Empty;
    private List<Area> filteredAreas = new List<Area>();


    private StudentModel userData;
    private bool showStudentsWithProgrammingSkills = false;
    private bool showStudentsWithMachineLearningSkills = false;
    private bool showStudentsWithDatabaseSkills = false;
    private bool showStudentsWithNetworkAndTelecomSkills = false;
    private List<StudentModel> students = new List<StudentModel>();
    private List<StudentModel> filteredStudents = new List<StudentModel>();

    private List<string> selectedSkills = new List<string>();

    private List<string> temporarilySelectedSkills = new List<string>();
    private bool hasReadAsStudentPermission = false;
    private List<string> finalSelectedSkills = new List<string>();
    private string Username = "Anonymous User";
    private string StudentUniqueID = "Δημιουργείται αυτόματα μετά την πρώτη σας Εγγραφή";
    private bool userAlreadyRegistered = false;

    public StudentModel newStudent = new StudentModel { Department = "Πληροφορικής & Τηλεπικοινωνιών" }; //was like that: () Drop Down Initialisation (Otherwise NULL EXCEPTION IF NOT CHOOSE FROM DROPDOWN)
    public bool updated = false;
    public bool saved = false;
    public bool error = false;
    public bool downloadByRegistryIsOk = false;
    public bool downloadByRegistryIsNotOk = false;

    private string nameInputClass = "";
    private string surnameInputClass = "";
    private string departmentInputClass = "";
    private string regNumberInputClass = "";
    public string permanentPCInputClass = "";
    private string errorMessage = "";
    private string telephoneInputClass = "";
    private string addressInputClass = "";
    private string pcInputClass = "";
    private string regionInputClass = "";
    private string townInputClass = "";
    private string studyYearInputClass = "";
    private string graduationDateInputClass = "";
    private string ectsInputClass = "";
    private string internshipInputClass = "";
    private string thesisInputClass = "";
    private string universityInputClass = "";
    private string schoolInputClass = "";
    private string enrollmentDateInputClass = "";
    private string levelOfDegreeInputClass = "";
    private string areasValidationClass = "";
    private string targetAreasValidationClass = "";
    private string skillsValidationClass = "";
    private string targetSkillsValidationClass = "";
    private string areasValidationMessage = "";
    private string targetAreasValidationMessage = "";
    private string skillsValidationMessage = "";
    private string targetSkillsValidationMessage = "";
    private string nameValidationMessage = "";
    private string surnameValidationMessage = "";
    private string telephoneValidationMessage = "";

    private bool isCvUploaded = false;
    private string cvErrorMessage = string.Empty;

    private bool showDropdown = false;


    private List<Area> availableAreas = new List<Area>();
    private List<string> selectedAreas = new List<string>();
    private HashSet<string> expandedAreas = new HashSet<string>();
    private List<string> temporarilySelectedAreas = new List<string>();
    private List<string> finalSelectedAreas = new List<string>();

    private List<AreaItem> selectedAreasForAssessment = new List<AreaItem>();
    private List<string> selectedAvailableItems = new List<string>();
    private List<string> selectedSelectedItems = new List<string>();

    private List<string> selectedTargetAreas = new List<string>();
    private List<string> temporarilySelectedTargetAreas = new List<string>();
    private List<string> finalSelectedTargetAreas = new List<string>();

    private List<AreaItem> selectedTargetAreasForAssessment = new List<AreaItem>();
    private List<Area> availableTargetAreas = new List<Area>();
    private List<Area> filteredTargetAreas = new List<Area>();
    private HashSet<string> expandedTargetAreas = new HashSet<string>();
    private string targetAreasSearchTerm = "";
    private List<string> selectedAvailableTargetItems = new List<string>();
    private List<string> selectedSelectedTargetItems = new List<string>();

    private List<SelectedSkill> selectedSkillsForAssessment = new List<SelectedSkill>(); 

    private List<string> selectedTargetSkills = new List<string>(); // List of selected target skills
    private List<SelectedSkill> selectedTargetSkillsForAssessment = new List<SelectedSkill>(); // List of selected target skills for assessment
    private List<string> expandedSkills = new List<string>();

    private HashSet<string> selectedRegions = new HashSet<string>();
    private Dictionary<string, bool> selectedRegionsDictionary = new Dictionary<string, bool>();
    private Dictionary<string, bool> selectedTownsDictionary = new Dictionary<string, bool>();


    private string UniversityName = "Εθνικό & Καποδιστριακό Πανεπιστήμιο Αθηνών";
    private string completedEctsDisplay = "0/300";
    private string completedEctsNumericPart = "0";

    private bool showCVAlert = false; // Flag to control alert visibility

    private bool agreeTerms = false;
    private CustomCheckbox customCheckbox;

    private int studentId;
    private StudentModel studentData;

    [Parameter] public int StudentId { get; set; }
    [Parameter] public bool IsEditing { get; set; }

    private string formattedRegistryNumber; // To store formatted registry number ΑΚΟΜΑ ΔΕΝ ΔΟΥΛΕΥΕΙ!!!


    private bool isRegistered;
    private IBrowserFile file;

    [Parameter]
    public EventCallback OnAgree { get; set; }

    [Parameter]
    public EventCallback OnDecline { get; set; }

    private bool isManualInput = false;

    private string FileErrorMessage { get; set; }

    private async Task HandleFileChangeStudentImage(InputFileChangeEventArgs e)
    {
        try
        {
            var selectedFiles = e.GetMultipleFiles();
            var file = selectedFiles.FirstOrDefault();

            if (file != null)
            {
                // Check file type
                var allowedTypes = new[] { "image/jpeg", "image/png" };
                if (!allowedTypes.Contains(file.ContentType))
                {
                    FileErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε .jpg ή .png";
                    newStudent.Image = null;
                    return;
                }

                const long maxFileSize = 1048576;
                if (file.Size > maxFileSize)
                {
                    FileErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 1MB";
                    newStudent.Image = null;
                    return;
                }

                using (var memoryStream = new MemoryStream())
                {
                    await file.OpenReadStream(maxFileSize).CopyToAsync(memoryStream);
                    newStudent.Image = memoryStream.ToArray();
                }

                // Clear any previous error message
                FileErrorMessage = null;
            }
            else
            {
                newStudent.Image = null;
                FileErrorMessage = "Παρακαλώ επιλέξτε ένα αρχείο.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading file: {ex.Message}");
            newStudent.Image = null;
            FileErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
        }
    }

    private bool showValidationError = false;


    private List<string> Regions = new List<string>
    {
        "Ανατολική Μακεδονία και Θράκη",
        "Κεντρική Μακεδονία",
        "Δυτική Μακεδονία",
        "Ήπειρος",
        "Θεσσαλία",
        "Ιόνια Νησιά",
        "Δυτική Ελλάδα",
        "Κεντρική Ελλάδα",
        "Αττική",
        "Πελοπόννησος",
        "Βόρειο Αιγαίο",
        "Νότιο Αιγαίο",
        "Κρήτη"
    };

    private Dictionary<string, List<string>> RegionToTownsMap = new Dictionary<string, List<string>>
    {
        {"Ανατολική Μακεδονία και Θράκη", new List<string> {"Κομοτηνή", "Αλεξανδρούπολη", "Καβάλα", "Ξάνθη", "Δράμα", "Ορεστιάδα", "Διδυμότειχο", "Ίασμος", "Νέα Βύσσα", "Φέρες"}},
        {"Κεντρική Μακεδονία", new List<string> {"Θεσσαλονίκη", "Κατερίνη", "Σέρρες", "Κιλκίς", "Πολύγυρος", "Ναούσα", "Έδεσσα", "Γιαννιτσά", "Καβάλα", "Άμφισσα"}},
        {"Δυτική Μακεδονία", new List<string> {"Κοζάνη", "Φλώρινα", "Καστοριά", "Γρεβενά"}},
        {"Ήπειρος", new List<string> {"Ιωάννινα", "Άρτα", "Πρέβεζα", "Ηγουμενίτσα"}},
        {"Θεσσαλία", new List<string> {"Λάρισα", "Βόλος", "Τρίκαλα", "Καρδίτσα"}},
        {"Ιόνια Νησιά", new List<string> {"Κέρκυρα", "Λευκάδα", "Κεφαλονιά", "Ζάκυνθος", "Ιθάκη", "Παξοί", "Κυθήρα"}},
        {"Δυτική Ελλάδα", new List<string> {"Πάτρα", "Μεσολόγγι", "Αμφιλοχία", "Πύργος", "Αιγίο", "Ναύπακτος"}},
        {"Κεντρική Ελλάδα", new List<string> {"Λαμία", "Χαλκίδα", "Λιβαδειά", "Θήβα", "Αλιάρτος", "Αμφίκλεια"}},
        {"Αττική", new List<string> {"Αθήνα", "Πειραιάς", "Κηφισιά", "Παλλήνη", "Αγία Παρασκευή", "Χαλάνδρι", "Καλλιθέα", "Γλυφάδα", "Περιστέρι", "Αιγάλεω"}},
        {"Πελοπόννησος", new List<string> {"Πάτρα", "Τρίπολη", "Καλαμάτα", "Κορίνθος", "Άργος", "Ναύπλιο", "Σπάρτη", "Κυπαρισσία", "Πύργος", "Μεσσήνη"}},
        {"Βόρειο Αιγαίο", new List<string> {"Μυτιλήνη", "Χίος", "Λήμνος", "Σάμος", "Ίκαρος", "Λέσβος", "Θάσος", "Σκύρος", "Ψαρά"}},
        {"Νότιο Αιγαίο", new List<string> {"Ρόδος", "Κως", "Κρήτη", "Κάρπαθος", "Σαντορίνη", "Μύκονος", "Νάξος", "Πάρος", "Σύρος", "Άνδρος"}},
        {"Κρήτη", new List<string> {"Ηράκλειο", "Χανιά", "Ρέθυμνο", "Αγία Νικόλαος", "Ιεράπετρα", "Σητεία", "Κίσαμος", "Παλαιόχωρα", "Αρχάνες", "Ανώγεια"}},
    };


    private List<string> DegreeLevel = new List<string>
    {
        "Προπτυχιακός Φοιτητής",
        "Μεταπτυχιακός Φοιτητής",
        "Υποψήφιος Διδάκτορας",
        "Μεταδιδακτορικός",
        "Άλλο",
    };

    private bool IsRegionSelected(string region)
    {
        return selectedRegions.Contains(region);
    }

    private void ToggleRegionSelection(string region)
    {
        if (selectedRegions.Contains(region))
        {
            selectedRegions.Remove(region);
        }
        else
        {
            selectedRegions.Add(region);
        }
    }

    private void SelectAllRegions(ChangeEventArgs e)
    {
        bool isChecked = (bool)e.Value;
        foreach (var region in Regions)
        {
            selectedRegionsDictionary[region] = isChecked;
        }
    }

    private void HandleRegionChange(ChangeEventArgs args)
    {
        newStudent.PermanentRegion = args.Value?.ToString();
        // Reset town selection when region changes
        newStudent.PermanentTown = string.Empty;
    }

    private List<string> GetTownsForRegion(string region)
    {
        if (RegionToTownsMap.ContainsKey(region))
        {
            return RegionToTownsMap[region];
        }
        return new List<string>();
    }



    private void HandleCompletedEctsInput(ChangeEventArgs e)
    {
        string inputValue = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(inputValue))
        {
            completedEctsNumericPart = "0"; // Handle empty input
            newStudent.CompletedECTS = 0;
        }
        else
        {
            if (!int.TryParse(inputValue, out int ectsValue) || ectsValue < 0 || ectsValue > 300)
            {
                completedEctsNumericPart = "0"; // Handle invalid format or value
                newStudent.CompletedECTS = 0;
            }
            else
            {
                completedEctsNumericPart = ectsValue.ToString();
                newStudent.CompletedECTS = ectsValue;
            }
        }
    }

    private void ValidateCompletedEcts()
    {
        // Additional validation logic if needed
        if (!int.TryParse(completedEctsNumericPart, out int ectsValue))
        {
            completedEctsNumericPart = "0"; // Default invalid input
            newStudent.CompletedECTS = 0;
        }
        else
        {
            newStudent.CompletedECTS = ectsValue;
        }
    }


    private async Task ShowFilteredStudents()
    {
        filteredStudents.Clear();

        if (showStudentsWithProgrammingSkills || showStudentsWithMachineLearningSkills ||
            showStudentsWithDatabaseSkills || showStudentsWithNetworkAndTelecomSkills)
        {
            using var dbContext = await DbContextFactory.CreateDbContextAsync();

            filteredStudents = dbContext.Students.Where(s =>
                (showStudentsWithProgrammingSkills && s.Programming) ||
                (showStudentsWithMachineLearningSkills && s.MachineLearning) ||
                (showStudentsWithDatabaseSkills && s.Databases) ||
                (showStudentsWithNetworkAndTelecomSkills && s.NetworksAndTelecom)
            ).ToList();
        }
    }

    private async Task SingleUploadCV(InputFileChangeEventArgs e)
    {
        if (e.File == null)
        {
            showCVAlert = true; 
            newStudent.LastCVUpdate = null; 
            return;
        }

        const long maxFileSize = 10485760;
        if (e.File.Size > maxFileSize)
        {
            showCVAlert = true;
            newStudent.LastCVUpdate = null;
            newStudent.Attachment = null;
            return;
        }

        try
        {
            MemoryStream ms = new MemoryStream();
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);
            newStudent.Attachment = ms.ToArray();

            newStudent.LastCVUpdate = DateTime.Now;

            showCVAlert = false;

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading CV: {ex.Message}");
            showCVAlert = true;
            newStudent.LastCVUpdate = null;
            newStudent.Attachment = null;
        }
    }

    private string TranscriptsErrorMessage = string.Empty;
    private async Task SingleUploadTranscripts(InputFileChangeEventArgs e)
    {
        try
        {
            if (e.File == null)
            {
                TranscriptsErrorMessage = "Παρακαλώ επιλέξτε ένα αρχείο.";
                newStudent.Grades = null;
                return;
            }

            // Check file size (10MB = 10,485,760 bytes)
            const long maxFileSize = 10485760;
            if (e.File.Size > maxFileSize)
            {
                TranscriptsErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                newStudent.Grades = null;
                return;
            }

            MemoryStream ms = new MemoryStream();
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);
            newStudent.Grades = ms.ToArray();

            // Clear any previous error message
            TranscriptsErrorMessage = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading transcripts: {ex.Message}");
            TranscriptsErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
            newStudent.Grades = null;
        }
    }

    private string CoverLetterErrorMessage = string.Empty;
    private async Task SingleUploadCoverLetter(InputFileChangeEventArgs e)
    {
        try
        {
            if (e.File == null)
            {
                CoverLetterErrorMessage = "Παρακαλώ επιλέξτε ένα αρχείο.";
                newStudent.CoverLetter = null;
                return;
            }

            // Check file size (10MB = 10,485,760 bytes)
            const long maxFileSize = 10485760;
            if (e.File.Size > maxFileSize)
            {
                CoverLetterErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                newStudent.CoverLetter = null;
                return;
            }

            MemoryStream ms = new MemoryStream();
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);
            newStudent.CoverLetter = ms.ToArray();

            // Clear any previous error message
            CoverLetterErrorMessage = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading cover letter: {ex.Message}");
            CoverLetterErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
            newStudent.CoverLetter = null;
        }
    }

    private async Task DownloadFile()
    {
        try
        {
            var student = await FileUploadService.GetStudentByName(newStudent.Name);
            if (student == null)
            {
                throw new Exception("StudentModel not found.");
            }

            if (student.Attachment != null)
            {
                var fileContent = student.Attachment;
                var fileName = $"{student.Name}_CV.pdf";
                await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, fileContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading file: {ex.Message}");
        }
    }

    private async Task DownloadFileByRegNumber()
    {
        try
        {
            var student = await FileUploadService.GetStudentByRegNumber(newStudent.RegNumber);
            if (student == null)
            {
                downloadByRegistryIsOk = true;
                throw new Exception("Registry Number not found.");
            }

            if (student.Attachment != null)
            {
                downloadByRegistryIsOk = true;
                var fileContent = student.Attachment;
                var fileName = $"{student.Name}_CV.pdf";
                await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, fileContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading file: {ex.Message}");
        }
    }

    private async Task PreviewFile()
    {
        try
        {
            var student = await FileUploadService.GetStudentByName(newStudent.Name);
            if (student == null)
            {
                throw new Exception("StudentModel not found.");
            }

            if (student.Attachment != null)
            {
                var fileContent = student.Attachment;
                await JSRuntime.InvokeVoidAsync("BlazorPreviewFile", fileContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error previewing file: {ex.Message}");
        }
    }

    private List<StudentModel> FilterStudents(IEnumerable<StudentModel> students)
    {
        var filteredStudents = students.ToList();

        if (showStudentsWithProgrammingSkills)
        {
            filteredStudents = filteredStudents.Where(s => s.Programming).ToList();
        }

        if (showStudentsWithMachineLearningSkills)
        {
            filteredStudents = filteredStudents.Where(s => s.MachineLearning).ToList();
        }

        if (showStudentsWithDatabaseSkills)
        {
            filteredStudents = filteredStudents.Where(s => s.Databases).ToList();
        }

        if (showStudentsWithNetworkAndTelecomSkills)
        {
            filteredStudents = filteredStudents.Where(s => s.NetworksAndTelecom).ToList();
        }
        return filteredStudents;
    }

    private async Task DownloadAttachment(byte[] attachment, string studentName)
    {
        try
        {
            if (attachment != null)
            {
                var fileName = $"{studentName}_CV.pdf";
                await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, attachment);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading attachment: {ex.Message}");
        }
    }

    private string? registryNumberInput;
    private string? permenentPCNumberInput;
    private long combinedRegNumber;


    private void HandleRegistryNumberInput(ChangeEventArgs e)
    {
        string inputValue = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(inputValue))
        {
            regNumberInputClass = "shake shake-input"; // Handle empty input
        }
        else
        {
            string[] parts = inputValue.Split('-');
            if (parts.Length != 3 ||
                !IsValidXxxx(parts[0]) ||
                !IsValidYyyy(parts[1]) ||
                !IsValidZzzzz(parts[2]))
            {
                regNumberInputClass = "shake shake-input"; // Handle invalid format
            }
            else
            {
                regNumberInputClass = "";

                // Update the formatted value
                FormattedRegNumber = inputValue;

                // Remove hyphens for storage
                string numericValue = inputValue.Replace("-", "");
                if (long.TryParse(numericValue, out long combinedRegNumber))
                {
                    newStudent.RegNumber = combinedRegNumber;

                    // Extract the XXXX part and set the department accordingly
                    string xxxxPart = parts[0];
                    string yyyyPart = parts[1];
                    if (xxxxPart == "1115")
                    {
                        newStudent.Department = "Τεχνολογιών Ψηφιακής Βιομηχανίας";
                    }
                    if (xxxxPart == "1116")
                    {
                        newStudent.Department = "Αγροτικής Ανάπτυξης, Αγροδιατροφής & Διαχείρισης Φυσικών Πόρων";
                    }
                    if (xxxxPart == "1117")
                    {
                        newStudent.Department = "Αεροδιαστημικής Επιστήμης & Τεχνολογίας";
                    }
                    if (xxxxPart == "1118")
                    {
                        newStudent.Department = "Διαχείρισης Λιμένων & Ναυτιλίας";
                    }
                    if (xxxxPart == "1119")
                    {
                        newStudent.Department = "Ψηφιακών Τεχνών & Κινηματογράφου";
                    }
                    if (int.TryParse(yyyyPart, out int enrollmentYear))
                    {
                        newStudent.EnrollmentDate = enrollmentYear.ToString();
                        int currentYear = DateTime.Now.Year;
                        newStudent.StudyYear = (currentYear - enrollmentYear).ToString();
                    }
                }
                else
                {
                    regNumberInputClass = "shake shake-input"; // Handle parsing error
                }
            }
        }
    }

    // Example validation methods (you should replace them with your actual validation logic)
    private bool IsValidXxxx(string xxxx)
    {
        return xxxx == "1115" || xxxx == "1116" || xxxx == "1117" || xxxx == "1118" || xxxx == "1119";
    }

    private bool IsValidYyyy(string yyyy)
    {
        if (int.TryParse(yyyy, out int year))
        {
            int currentYear = DateTime.Now.Year;
            return year >= 2010 && year <= currentYear;
        }
        return false;
    }

    private bool IsValidZzzzz(string zzzzz)
    {
        if (zzzzz.StartsWith("00") && int.TryParse(zzzzz.Substring(2), out int number))
        {
            return number >= 1 && number <= 300;
        }
        return false;
    }


    private void ValidateRegistryNumber()
    {
        string value = registryNumberInput?.Replace("-", "");
        if (value == null || value.Length != 13 || !long.TryParse(value, out _))
        {
            regNumberInputClass = "shake shake-input";
            JSRuntime.InvokeVoidAsync("validateRegistryNumber");
        }
        else
        {
            regNumberInputClass = "";
            JSRuntime.InvokeVoidAsync("validateRegistryNumber");
        }
    }






    private void HandlePermanentPCNumberInput(ChangeEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(e.Value?.ToString()))
        {
            permanentPCInputClass = "shake shake-input";
        }
        else if (!long.TryParse(e.Value.ToString(), out long result))
        {
            permanentPCInputClass = "shake shake-input";
        }
        else
        {
            permanentPCInputClass = "";
            newStudent.PermanentPC = result; // Update the bound property
            permenentPCNumberInput = result.ToString();
        }
    }



    private async Task<List<string>> GetSelectedSkillsFromDOM(string selectId)
    {
        var selectedSkills = await JSRuntime.InvokeAsync<List<string>>("getSelectedValues", selectId);
        return selectedSkills;
    }

    private void SelectSkill(string skill)
    {
        if (!temporarilySelectedSkills.Contains(skill))
        {
            temporarilySelectedSkills.Add(skill);
            Console.WriteLine($"Skill {skill} added to temporarilySelectedSkills.");
        }
        else
        {
            Console.WriteLine($"Skill {skill} is already in temporarilySelectedSkills.");
            temporarilySelectedSkills.Remove(skill);
            Console.WriteLine($"Skill {skill} removed from temporarilySelectedSkills.");
        }

        newStudent.Keywords = string.Join(",", temporarilySelectedSkills);
        Console.WriteLine("Temporarily Selected Skills: " + string.Join(",", temporarilySelectedSkills));
    }

    private void UpdateTemporarilySelectedSkills()
    {
        temporarilySelectedSkills.Clear();
        temporarilySelectedSkills.AddRange(selectedSkills);
        newStudent.Keywords = string.Join(",", temporarilySelectedSkills);
        Console.WriteLine("Temporarily Selected Skills: " + string.Join(",", temporarilySelectedSkills));
        StateHasChanged();
    }

    private void UpdateSelectedSkills()
    {
        temporarilySelectedSkills.Clear();
        temporarilySelectedSkills.AddRange(selectedSkills);
        newStudent.Keywords = string.Join(",", temporarilySelectedSkills);
        Console.WriteLine("Temporarily Selected Skills: " + string.Join(",", temporarilySelectedSkills));
        StateHasChanged();
    }

    private bool showLoadingModalWhenSubmitStudentForm = false;
    private int loadingProgressWhenSubmitStudentForm = 0;
    private async Task SubmitForm()
    {
        errorMessage = "";
        nameInputClass = "";
        surnameInputClass = "";
        telephoneInputClass = "";
        addressInputClass = "";
        pcInputClass = "";
        regionInputClass = "";
        townInputClass = "";
        studyYearInputClass = "";
        graduationDateInputClass = "";
        ectsInputClass = "";
        internshipInputClass = "";
        thesisInputClass = "";
        universityInputClass = "";
        schoolInputClass = "";
        departmentInputClass = "";
        enrollmentDateInputClass = "";
        levelOfDegreeInputClass = "";
        telephoneValidationMessage = "";

        // Show loading modal at the start
        showLoadingModalWhenSubmitStudentForm = true;
        loadingProgressWhenSubmitStudentForm = 0;
        StateHasChanged();

        try
        {
            // Step 1: Validation
            await UpdateProgressWhenSubmitStudentForm(10, 200);

            // List to track missing mandatory fields
            var missingFields = new List<string>();

            // Validate MANDATORY fields
            if (string.IsNullOrEmpty(newStudent.Name))
            {
                nameInputClass = "shake shake-input";
                missingFields.Add("Όνομα");
            }
            if (string.IsNullOrEmpty(newStudent.Surname))
            {
                surnameInputClass = "shake shake-input";
                missingFields.Add("Επώνυμο");
            }

            // Validate telephone with international format
            var telephoneValidation = ValidateTelephone(newStudent.Telephone);
            if (!string.IsNullOrEmpty(telephoneValidation))
            {
                telephoneInputClass = "shake shake-input";
                telephoneValidationMessage = telephoneValidation;
                missingFields.Add("Τηλέφωνο");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentAddress))
            {
                addressInputClass = "shake shake-input";
                missingFields.Add("Διεύθυνση");
            }
            if (newStudent.PermanentPC == 0)
            {
                pcInputClass = "shake shake-input";
                missingFields.Add("Ταχυδρομικός Κώδικας");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentRegion))
            {
                regionInputClass = "shake shake-input";
                missingFields.Add("Περιφέρεια");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentTown))
            {
                townInputClass = "shake shake-input";
                missingFields.Add("Πόλη");
            }
            if (string.IsNullOrEmpty(newStudent.StudyYear))
            {
                studyYearInputClass = "shake shake-input";
                missingFields.Add("Έτος Φοίτησης");
            }
            if (newStudent.ExpectedGraduationDate == default)
            {
                graduationDateInputClass = "shake shake-input";
                missingFields.Add("Αναμενόμενη Ημερομηνία Αποφοίτησης");
            }
            if (newStudent.CompletedECTS == 0)
            {
                ectsInputClass = "shake shake-input";
                missingFields.Add("Συμπληρωμένες Διδακτικές Μονάδες");
            }
            if (string.IsNullOrEmpty(newStudent.University))
            {
                universityInputClass = "shake shake-input";
                missingFields.Add("Πανεπιστημιακό Ίδρυμα");
            }
            if (string.IsNullOrEmpty(newStudent.School))
            {
                schoolInputClass = "shake shake-input";
                missingFields.Add("Σχολή");
            }
            if (string.IsNullOrEmpty(newStudent.Department))
            {
                departmentInputClass = "shake shake-input";
                missingFields.Add("Τμήμα");
            }
            if (string.IsNullOrEmpty(newStudent.EnrollmentDate))
            {
                enrollmentDateInputClass = "shake shake-input";
                missingFields.Add("Έτος Εγγραφής");
            }
            if (string.IsNullOrEmpty(newStudent.LevelOfDegree))
            {
                levelOfDegreeInputClass = "shake shake-input";
                missingFields.Add("Ιδιότητα Μέλους");
            }

            // Validate right-side boxes (selected items)
            if (selectedAreasForAssessment.Count == 0)
            {
                areasValidationClass = "shake shake-input";
                missingFields.Add("Περιοχές Εξειδίκευσης");
            }

            if (selectedTargetAreasForAssessment.Count == 0)
            {
                targetAreasValidationClass = "shake shake-input";
                missingFields.Add("Περιοχές Ενδιαφέροντος");
            }

            if (selectedSkillsForAssessment.Count == 0)
            {
                skillsValidationClass = "shake shake-input";
                missingFields.Add("Τεχνικές Ικανότητες");
            }

            if (selectedTargetSkillsForAssessment.Count == 0)
            {
                targetSkillsValidationClass = "shake shake-input";
                missingFields.Add("Τεχνικές Ικανότητες Ενδιαφέροντος");
            }

            if (missingFields.Count > 0)
            {
                showLoadingModalWhenSubmitStudentForm = false;
                StateHasChanged();
                errorMessage = $"Συμπληρώστε τα ακόλουθα πεδία: {string.Join(", ", missingFields)}";
                return;
            }

            // Step 2: Data preparation
            await UpdateProgressWhenSubmitStudentForm(30, 200);

            // Clear research fields if not applicable
            if (!ShouldShowResearchFields())
            {
                newStudent.WhenStudentIsPostDocOrPhD_ResearchTitle = "";
                newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription = "";
            }
            if (string.IsNullOrEmpty(newStudent.LinkedInProfile))
            {
                newStudent.LinkedInProfile = "";
            }

            if (string.IsNullOrEmpty(newStudent.PersonalWebsite))
            {
                newStudent.PersonalWebsite = "";
            }

            if (string.IsNullOrEmpty(newStudent.StudentGoogleScholarProfile))
            {
                newStudent.StudentGoogleScholarProfile = "";
            }

            // Step 3: Build preferred towns and other fields
            await UpdateProgressWhenSubmitStudentForm(50, 200);

            var preferredTownsList = new List<string>();
            // Build PreferredTowns
            foreach (var region in Regions)
            {
                if (selectedRegionsDictionary.ContainsKey(region) && selectedRegionsDictionary[region])
                {
                    var towns = RegionToTownsMap[region]
                        .Where(town => selectedTownsDictionary.ContainsKey(town) && selectedTownsDictionary[town])
                        .ToList();

                    if (towns.Any())
                    {
                        var formattedRegionTowns = $"[{region}: {string.Join(", ", towns)}]";
                        preferredTownsList.Add(formattedRegionTowns);
                    }
                }
            }

            // Set common student attributes
            newStudent.PreferredTowns = string.Join(", ", preferredTownsList);
            newStudent.PreferedRegions = string.Join(",", selectedRegionsDictionary.Where(kv => kv.Value).Select(kv => kv.Key));
            newStudent.TargetSkills = string.Join(",", selectedTargetSkillsForAssessment.Select(sa => $"{sa.SkillName}"));
            newStudent.TargetAreas = string.Join(",", selectedTargetAreasForAssessment.Select(sa => $"{sa.FullName}"));
            newStudent.AreasOfExpertise = string.Join(", ", selectedAreasForAssessment.Select(sa => $"{sa.FullName}"));
            newStudent.SelfAssesmentAreas = string.Join(", ", selectedAreasForAssessment.Select(sa => $"{sa.FullName}:{sa.Assessment}"));
            newStudent.Keywords = string.Join(",", selectedSkills);
            newStudent.SelfAssesmentSkills = string.Join(", ", selectedSkillsForAssessment.Select(sa => $"{sa.SkillName}:{sa.Assessment}"));
            newStudent.LastCVUpdate = DateTime.Now;
            newStudent.LastProfileUpdate = DateTime.Now;
            newStudent.Student.UniqueID = "STU_" + HashingHelper.HashString(newStudent.Email);

            // Step 4: Database operations
            await UpdateProgressWhenSubmitStudentForm(70, 200);

            using var dbContext = await DbContextFactory.CreateDbContextAsync();

            var existingStudent = await dbContext.Students.FirstOrDefaultAsync(s => s.Email == newStudent.Email);
            if (existingStudent != null)
            {
                showLoadingModalWhenSubmitStudentForm = false;
                StateHasChanged();
                userAlreadyRegistered = true;
                saved = false;
                error = false;
                return;
            }

            await UpdateProgressWhenSubmitStudentForm(80, 200);

            if (newStudent.Attachment != null)
            {
                dbContext.Students.Add(newStudent);
                await dbContext.SaveChangesAsync();
                saved = true;
                error = false;
                selectedSkills.Clear();
            }
            else
            {
                // Handle case where no attachment is provided
                showCVAlert = true;
                newStudent.LastCVUpdate = null;
                dbContext.Students.Add(newStudent);
                await dbContext.SaveChangesAsync();
                saved = true;
                error = false;
                selectedSkills.Clear();
            }

            // Step 5: Final success
            await UpdateProgressWhenSubmitStudentForm(100, 200);

            // Small delay to show completion
            await Task.Delay(500);

            showLoadingModalWhenSubmitStudentForm = false;
            StateHasChanged();

            await Task.Delay(100); // Small delay for smooth transition
        
            // Show the navigation loader
            await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
        
            // Give time for loader to render
            await Task.Delay(300);

            // Step 6: Navigate
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            // Hide loading modal on error
            showLoadingModalWhenSubmitStudentForm = false;
            StateHasChanged();

            error = true;
            errorMessage = "Σφάλμα κατά την αποθήκευση. Παρακαλώ δοκιμάστε ξανά.";
            Console.Error.WriteLine($"Full error: {ex}");
            Console.Error.WriteLine($"Inner exception: {ex.InnerException}");
            // Log stack trace for better debugging
            Console.Error.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            // Reset input classes and state after delay
            // We'll do this without hiding the modal since it's already hidden
            await Task.Delay(3000); // Keep the shake effect for 3 seconds
            nameInputClass = "";
            surnameInputClass = "";
            telephoneInputClass = "";
            addressInputClass = "";
            pcInputClass = "";
            regionInputClass = "";
            townInputClass = "";
            studyYearInputClass = "";
            graduationDateInputClass = "";
            ectsInputClass = "";
            internshipInputClass = "";
            thesisInputClass = "";
            universityInputClass = "";
            schoolInputClass = "";
            departmentInputClass = "";
            enrollmentDateInputClass = "";
            levelOfDegreeInputClass = "";
            errorMessage = "";
            areasValidationClass = "";
            targetAreasValidationClass = "";
            skillsValidationClass = "";
            targetSkillsValidationClass = "";
            areasValidationMessage = "";
            targetAreasValidationMessage = "";
            skillsValidationMessage = "";
            targetSkillsValidationMessage = "";
            nameValidationMessage = "";
            surnameValidationMessage = "";
            telephoneValidationMessage = "";
        }
    }

    // Helper method to update progress and refresh UI
    private async Task UpdateProgressWhenSubmitStudentForm(int current, int total)
    {
        loadingProgressWhenSubmitStudentForm = (int)((double)current / total * 100);
        StateHasChanged();
        await Task.Delay(50); // Small delay for smooth animation
    }





    protected override async Task OnInitializedAsync()
    {
        using var dbContext = await DbContextFactory.CreateDbContextAsync();

        // Load skills and areas from the database
        var skillsFromDb = await dbContext.Skills.ToListAsync();

        // Initialize available skills lists
        availableSkills = skillsFromDb; // This is List<Skill>
        availableTargetSkills = skillsFromDb.Select(s => new SelectedSkill { SkillName = s.SkillName, Assessment = 1 }).ToList();
        availableTargetAreas = await dbContext.Areas.ToListAsync();
        availableAreas = await dbContext.Areas.ToListAsync();

        // Initially show all areas and skills except those already selected
        filteredAreas = availableAreas;
        filteredSkills = availableSkills.Select(s => new SelectedSkill { SkillName = s.SkillName, Assessment = 1 }).ToList();
        filteredTargetAreas = availableTargetAreas.ToList();
        filteredTargetSkills = availableTargetSkills.ToList();


        // Initialize schools and departments
        schools = schoolDepartments.Keys.ToList();
        departments = new List<string>();

        // Initialize school and department to empty values
        newStudent.School = string.Empty;
        newStudent.Department = string.Empty;

        newStudent.PhoneVisibility = false;
        newStudent.HomeVisibility = false;
        newStudent.Transport = false;
        newStudent.HasFinishedStudies = false;

        // Get the authenticated user's email
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userEmail = user.Identity.Name;

        await CheckResearchGroupMembership();

        // Load the student's data from the database
        var studentFromDb = await dbContext.Students.FirstOrDefaultAsync(s => s.Email == userEmail);

        if (studentFromDb != null)
        {
            newStudent = studentFromDb;
            newStudent.PermanentPC = newStudent.PermanentPC;
            formattedRegistryNumber = FormatRegistryNumber(newStudent.RegNumber);

            agreeTerms = true;

            await CheckResearchGroupMembership();

            // Log the student's data for debugging
            Console.WriteLine($"StudentModel Data: {System.Text.Json.JsonSerializer.Serialize(newStudent)}");

            // Initialize regions
            foreach (var region in Regions)
            {
                selectedRegionsDictionary[region] = !string.IsNullOrEmpty(newStudent.PreferedRegions) &&
                                                  newStudent.PreferedRegions.Split(',').Contains(region);
            }

            // Initialize towns - single initialization
            selectedTownsDictionary = new Dictionary<string, bool>();

            if (!string.IsNullOrEmpty(newStudent.PreferredTowns))
            {
                selectedTownsDictionary = new Dictionary<string, bool>();

                // Match each "[Region: Town1, Town2]" block
                var matches = Regex.Matches(newStudent.PreferredTowns, @"\[(.*?)\]");

                foreach (Match match in matches)
                {
                    var content = match.Groups[1].Value; // "Ανατολική Μακεδονία και Θράκη: Δράμα"
                    var parts = content.Split(':');

                    if (parts.Length == 2)
                    {
                        var region = parts[0].Trim();
                        var towns = parts[1].Split(',')
                                            .Select(t => t.Trim())
                                            .Where(t => !string.IsNullOrWhiteSpace(t));

                        foreach (var town in towns)
                        {
                            selectedTownsDictionary[town] = true;
                            Console.WriteLine($"Initialized town as selected: {town}");
                        }
                    }
                }
            }

            // If student exists, update departments based on their school
            if (!string.IsNullOrEmpty(newStudent.School) &&
                schoolDepartments.ContainsKey(newStudent.School))
            {
                departments = schoolDepartments[newStudent.School];
            }


            // Ensure all towns from selected regions exist in dictionary
            foreach (var region in Regions.Where(r => selectedRegionsDictionary[r]))
            {
                if (RegionToTownsMap.TryGetValue(region, out var towns))
                {
                    foreach (var town in towns)
                    {
                        if (!selectedTownsDictionary.ContainsKey(town))
                        {
                            selectedTownsDictionary[town] = false;
                            Console.WriteLine($"Initialized town as unselected: {town}");
                        }
                    }
                }
            }


            // Log the selected regions and towns for debugging
            Console.WriteLine($"Selected Regions: {string.Join(", ", selectedRegionsDictionary.Where(kvp => kvp.Value).Select(kvp => kvp.Key))}");
            Console.WriteLine($"Selected Towns: {string.Join(", ", selectedTownsDictionary.Where(kvp => kvp.Value).Select(kvp => kvp.Key))}");

            // Load the student's selected Areas of Expertise
            if (!string.IsNullOrEmpty(newStudent.SelfAssesmentAreas))
            {
                // Split the SelfAssesmentAreas string into individual area:assessment pairs
                var selectedAreaPairs = newStudent.SelfAssesmentAreas.Split(',');

                foreach (var areaPair in selectedAreaPairs)
                {
                    // Split each pair into area name and assessment
                    var areaParts = areaPair.Split(':');
                    if (areaParts.Length == 2) // Ensure the format is correct
                    {
                        var areaName = areaParts[0].Trim(); // Extract and trim the area name
                        var assessment = int.Parse(areaParts[1].Trim()); // Extract and parse the assessment

                        // Check if this is a subfield (contains bullet point or specific format)
                        bool isSubField = areaName.StartsWith("•") || areaName.Contains("[SubField]");

                        // In your area loading logic, ensure IsSubField is set correctly
                        if (isSubField)
                        {
                            var cleanSubFieldName = areaName.StartsWith("•")
                                ? areaName.Substring(1).Trim()
                                : areaName.Replace("[SubField]", "").Trim();

                            var parentArea = FindParentArea(cleanSubFieldName);

                            selectedAreasForAssessment.Add(new AreaItem
                                {
                                    FullName = cleanSubFieldName,
                                    DisplayName = cleanSubFieldName,
                                    IsSubField = true, // This must be set to true for subfields
                                    ParentArea = parentArea,
                                    Assessment = assessment
                                });
                        }
                        else
                        {
                            // Handle regular area
                            var area = availableAreas.FirstOrDefault(a =>
                                a.AreaName.Trim().Equals(areaName, StringComparison.OrdinalIgnoreCase));

                            if (area != null)
                            {
                                selectedAreasForAssessment.Add(new AreaItem
                                    {
                                        FullName = area.AreaName,
                                        DisplayName = area.AreaName,
                                        IsSubField = false, // This must be set to false for regular areas
                                        ParentArea = "",
                                        Assessment = assessment
                                    });
                            }
                            else
                            {
                                // Custom area
                                selectedAreasForAssessment.Add(new AreaItem
                                    {
                                        FullName = areaName,
                                        DisplayName = areaName,
                                        IsSubField = false, // Custom areas are also regular areas, not subfields
                                        ParentArea = "",
                                        Assessment = assessment
                                    });
                            }
                        }
                    }
                    else
                    {
                        Console.WriteLine($"Invalid area format: {areaPair}");
                    }
                }
            }
            else
            {
                Console.WriteLine("SelfAssesmentAreas is empty or null.");
            }

            // Log the selected Areas of Expertise for debugging
            Console.WriteLine($"Selected Areas for Assessment: {string.Join(", ", selectedAreasForAssessment.Select(a => $"{a.FullName}:{a.Assessment}"))}");

            // Load the student's selected Target Areas
            if (!string.IsNullOrEmpty(newStudent.TargetAreas))
            {
                // Split the TargetAreas string into individual area names
                var selectedTargetAreaNames = newStudent.TargetAreas.Split(',');

                foreach (var areaName in selectedTargetAreaNames)
                {
                    var normalizedAreaName = areaName.Trim();

                    // Check if this is a subfield (marked with [SubField] prefix)
                    bool isSubField = normalizedAreaName.StartsWith("[SubField]");

                    if (isSubField)
                    {
                        var cleanSubFieldName = normalizedAreaName.Replace("[SubField]", "").Trim();
                        var parentArea = FindParentTargetArea(cleanSubFieldName);
                        if (string.IsNullOrEmpty(parentArea))
                        {
                            parentArea = FindParentTargetAreaFromAvailableAreas(cleanSubFieldName);
                        }

                        selectedTargetAreasForAssessment.Add(new AreaItem
                            {
                                FullName = cleanSubFieldName,
                                DisplayName = cleanSubFieldName,
                                IsSubField = true,
                                ParentArea = parentArea, // Ensure this is set
                                Assessment = 1
                            });
                    }
                    else
                    {
                        // Handle regular target area
                        // Check if the area exists in availableTargetAreas (case-insensitive comparison)
                        var area = availableTargetAreas.FirstOrDefault(a =>
                            a.AreaName.Trim().Equals(normalizedAreaName, StringComparison.OrdinalIgnoreCase));

                        if (area != null)
                        {
                            // Add the area to selectedTargetAreasForAssessment
                            selectedTargetAreasForAssessment.Add(new AreaItem
                                {
                                    FullName = area.AreaName,
                                    DisplayName = area.AreaName,
                                    IsSubField = false,
                                    ParentArea = "",
                                    Assessment = 1
                                });

                            // Remove the area from availableTargetAreas to avoid duplication
                            //availableTargetAreas.Remove(area);
                            Console.WriteLine($"Target Area removed from availableTargetAreas: {area.AreaName}");
                        }
                        else
                        {
                            // Handle custom areas (not in availableTargetAreas)
                            selectedTargetAreasForAssessment.Add(new AreaItem
                                {
                                    FullName = normalizedAreaName,
                                    DisplayName = normalizedAreaName,
                                    IsSubField = false,
                                    ParentArea = "",
                                    Assessment = 1
                                });
                            Console.WriteLine($"Custom Target Area added: {normalizedAreaName}");
                        }
                    }
                }

                // Refresh the filtered target areas after loading
                FilterAvailableTargetAreasBasedOnSelection();
            }
            else
            {
                Console.WriteLine("TargetAreas is empty or null.");
            }

            // Log the selected Target Areas for debugging
            Console.WriteLine($"Selected Target Areas: {string.Join(", ", selectedTargetAreasForAssessment.Select(a => a.FullName))}");

            // Load the student's selected Skills
            if (!string.IsNullOrEmpty(newStudent.SelfAssesmentSkills))
            {
                // Split the SelfAssesmentSkills string into individual skill:assessment pairs
                var selectedSkillPairs = newStudent.SelfAssesmentSkills.Split(',');

                foreach (var skillPair in selectedSkillPairs)
                {
                    // Split each pair into skill name and assessment
                    var skillParts = skillPair.Split(':');
                    if (skillParts.Length == 2) // Ensure the format is correct
                    {
                        var skillName = skillParts[0].Trim(); // Extract and trim the skill name
                        var assessment = int.Parse(skillParts[1].Trim()); // Extract and parse the assessment

                        // Check if the skill exists in availableSkills (case-insensitive comparison)
                        var skill = availableSkills.FirstOrDefault(s => s.SkillName.Trim().Equals(skillName, StringComparison.OrdinalIgnoreCase));
                        if (skill != null)
                        {
                            selectedSkillsForAssessment.Add(new SelectedSkill { SkillName = skill.SkillName, Assessment = assessment });
                            // DON'T remove from availableSkills - comment this out:
                            // availableSkills.Remove(skill);
                            Console.WriteLine($"Skill added to selected: {skill.SkillName}");
                        }
                        else
                        {
                            // Handle custom skills (not in availableSkills)
                            selectedSkillsForAssessment.Add(new SelectedSkill { SkillName = skillName, Assessment = assessment });
                            Console.WriteLine($"Custom skill added: {skillName}");
                        }
                    }
                    else
                    {
                        Console.WriteLine($"Invalid skill format: {skillPair}");
                    }
                }
            }
            else
            {
                Console.WriteLine("SelfAssesmentSkills is empty or null.");
            }

            // Log the selected Skills for debugging
            Console.WriteLine($"Selected Skills for Assessment: {string.Join(", ", selectedSkillsForAssessment.Select(s => $"{s.SkillName}:{s.Assessment}"))}");

            // Load the student's selected Target Skills
            if (!string.IsNullOrEmpty(newStudent.TargetSkills))
            {
                // Split the TargetSkills string into individual skill names
                var selectedTargetSkillNames = newStudent.TargetSkills.Split(',');

                foreach (var skillName in selectedTargetSkillNames)
                {
                    var normalizedSkillName = skillName.Trim(); // Normalize the skill name

                    // Check if the skill exists in availableTargetSkills (case-insensitive comparison)
                    var skill = availableTargetSkills.FirstOrDefault(s => s.SkillName.Trim().Equals(normalizedSkillName, StringComparison.OrdinalIgnoreCase));
                    if (skill != null)
                    {
                        // Add the skill to selectedTargetSkillsForAssessment
                        selectedTargetSkillsForAssessment.Add(new SelectedSkill { SkillName = skill.SkillName });

                        // Remove the skill from availableTargetSkills to avoid duplication
                        availableTargetSkills.Remove(skill);
                        Console.WriteLine($"Target Skill removed from availableTargetSkills: {skill.SkillName}");
                    }
                    else
                    {
                        // Handle custom skills (not in availableTargetSkills)
                        selectedTargetSkillsForAssessment.Add(new SelectedSkill { SkillName = normalizedSkillName });
                        Console.WriteLine($"Custom Target Skill added: {normalizedSkillName}");
                    }
                }
            }
            else
            {
                Console.WriteLine("TargetSkills is empty or null.");
            }

            // Log the selected Target Skills for debugging
            Console.WriteLine($"Selected Target Skills: {string.Join(", ", selectedTargetSkillsForAssessment.Select(s => s.SkillName))}");
        }
        else
        {
            // Handle the case where the student is not found
            Console.WriteLine($"StudentModel with email {userEmail} not found.");
        }

        // Filter available areas and skills to exclude selected items
        FilterAvailableAreas(new ChangeEventArgs { Value = "" }); // Pass an empty search term to initialize
        FilterAvailableSkills(new ChangeEventArgs { Value = "" }); // Pass an empty search term to initialize

        // Initialize other data
        isRegistered = studentFromDb != null;

        // Check user authentication and permissions
        if (user.Identity.IsAuthenticated)
        {
            Console.WriteLine($"Authentication Type: {user.Identity.AuthenticationType}");

            foreach (var claim in user.Claims)
            {
                Console.WriteLine($"Claim Type: {claim.Type}, Claim Value: {claim.Value}");
            }

            var roleClaim = user.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role");

            if (roleClaim != null)
            {
                Username = user.Identity?.Name ?? "Anonymous User";
                newStudent.Email = Username;
                var userRole = roleClaim.Value;
                Console.WriteLine($"User Role: {userRole}");
                Console.WriteLine($"User Email: {Username}");

                hasReadAsStudentPermission = userRole == "Student";
            }
            Console.WriteLine($"User Has StudentModel Permission: {hasReadAsStudentPermission}");
        }
        else
        {
            Console.WriteLine("User is not authenticated.");
            hasReadAsStudentPermission = false;
        }

        newStudent.University = UniversityName;
        newStudent.WhenStudentIsPostDocOrPhD_ResearchTitle ??= string.Empty;
        newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription ??= string.Empty;


        // Ensure UI updates
        StateHasChanged();
    }





    private void NavigateToSearchJobs()
    {
        NavigationManager.NavigateTo("/searchjobs");
    }

    private void NavigateToSearchThesis()
    {
        NavigationManager.NavigateTo("/searchthesis");
    }


    private List<string> customAreas = new List<string>();

    private void MoveSelectedAreaToLeft()
    {
        var itemsToRemove = new List<AreaItem>();

        foreach (var selectedValue in selectedSelectedItems)
        {
            if (selectedValue.StartsWith("area:"))
            {
                var areaName = selectedValue.Substring(5);
                itemsToRemove.AddRange(selectedAreasForAssessment
                    .Where(item => item.FullName == areaName && !item.IsSubField));
            }
            else if (selectedValue.StartsWith("subfield:"))
            {
                var subFieldName = selectedValue.Substring(9);
                itemsToRemove.AddRange(selectedAreasForAssessment
                    .Where(item => item.FullName == subFieldName && item.IsSubField));
            }
        }

        foreach (var itemToRemove in itemsToRemove)
        {
            selectedAreasForAssessment.Remove(itemToRemove);
        }

        ValidateSelectedAreas();
        EnsureUniqueSelectedAreas();
        CheckForDuplicateKeys();

        FilterAvailableAreasBasedOnSelection();
        selectedSelectedItems.Clear();
        StateHasChanged();
    }


    private async Task MoveSelectedAreaToRight()
    {
        Console.WriteLine("=== MOVING AREAS TO RIGHT ===");

        var itemsToAdd = new List<(string name, bool isSubField)>();
        bool hasSelectedListItems = false;

        // Check if there are any selected items in the available areas listbox
        var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableAreas");
        hasSelectedListItems = selectedOptions.Length > 0;

        if (!string.IsNullOrWhiteSpace(areassearchTerm) && !hasSelectedListItems)
        {
            // Custom area from search term (no list items selected)
            var customAreaName = areassearchTerm.Trim();

            // Check if this custom area already exists
            bool customAreaExists = selectedAreasForAssessment.Any(item =>
                !item.IsSubField && item.FullName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

            if (!customAreaExists)
            {
                itemsToAdd.Add((customAreaName, false));
                Console.WriteLine($"Will add custom area: {customAreaName}");
                areassearchTerm = ""; // Clear search term
            }
            else
            {
                Console.WriteLine($"Custom area '{customAreaName}' already exists - not adding");
            }
        }
        else if (hasSelectedListItems)
        {
            // Process selected list items
            foreach (var selectedValue in selectedOptions)
            {
                if (selectedValue.StartsWith("area:"))
                {
                    var areaName = selectedValue.Substring(5);

                    // Check if area already exists
                    bool areaExists = selectedAreasForAssessment.Any(item =>
                        !item.IsSubField && item.FullName == areaName);

                    if (!areaExists)
                    {
                        itemsToAdd.Add((areaName, false));
                        Console.WriteLine($"Will add area: {areaName}");
                    }
                    else
                    {
                        Console.WriteLine($"Area '{areaName}' already exists - not adding");
                    }
                }
                else if (selectedValue.StartsWith("subfield:"))
                {
                    var subFieldName = selectedValue.Substring(9);

                    // Check if subfield already exists
                    bool subFieldExists = selectedAreasForAssessment.Any(item =>
                        item.IsSubField && item.FullName == subFieldName);

                    if (!subFieldExists)
                    {
                        itemsToAdd.Add((subFieldName, true));
                        Console.WriteLine($"Will add subfield: {subFieldName}");
                    }
                    else
                    {
                        Console.WriteLine($"Subfield '{subFieldName}' already exists - not adding");
                    }
                }
            }
        }

        // Add all collected items
        foreach (var item in itemsToAdd)
        {
            AddAreaToSelected(item.name, item.isSubField);
        }

        // Final validation and cleanup
        ValidateSelectedAreas();
        EnsureUniqueSelectedAreas();
        FilterAvailableAreasBasedOnSelection();
        selectedAvailableItems.Clear();

        StateHasChanged();
    }




    private void MoveSelectedTargetAreaToLeft()
    {
        var itemsToRemove = new List<AreaItem>();

        foreach (var selectedValue in selectedSelectedTargetItems)
        {
            if (selectedValue.StartsWith("area:"))
            {
                var areaName = selectedValue.Substring(5);
                itemsToRemove.AddRange(selectedTargetAreasForAssessment
                    .Where(item => item.FullName == areaName && !item.IsSubField));
            }
            else if (selectedValue.StartsWith("subfield:"))
            {
                var subFieldName = selectedValue.Substring(9);
                itemsToRemove.AddRange(selectedTargetAreasForAssessment
                    .Where(item => item.FullName == subFieldName && item.IsSubField));
            }
        }

        foreach (var itemToRemove in itemsToRemove)
        {
            selectedTargetAreasForAssessment.Remove(itemToRemove);
        }

        FilterAvailableTargetAreasBasedOnSelection();
        selectedSelectedTargetItems.Clear();
        StateHasChanged();
    }


    private async Task MoveSelectedTargetAreaToRight()
    {
        Console.WriteLine("=== MOVING TARGET AREAS TO RIGHT ===");

        var itemsToAdd = new List<(string name, bool isSubField)>();

        // First, check if we should add a custom area from search term
        if (!string.IsNullOrWhiteSpace(targetAreasSearchTerm))
        {
            // Check if there are actually any selected items in the listbox
            var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableTargetAreas");

            // If no items are selected in the listbox, treat the search term as custom area
            if (selectedOptions.Length == 0)
            {
                var customAreaName = targetAreasSearchTerm.Trim();

                // Check if this is not already in available target areas (custom area)
                var isCustomArea = !availableTargetAreas.Any(a =>
                    a.AreaName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

                if (isCustomArea)
                {
                    itemsToAdd.Add((customAreaName, false));
                    Console.WriteLine($"Will add custom target area: {customAreaName}");

                    // Clear search term after adding custom area
                    targetAreasSearchTerm = "";
                }
            }
            else
            {
                // There are selected items, so process them normally
                foreach (var selectedValue in selectedOptions)
                {
                    if (selectedValue.StartsWith("area:"))
                    {
                        var areaName = selectedValue.Substring(5);
                        itemsToAdd.Add((areaName, false));
                        Console.WriteLine($"Will add target area: {areaName}");
                    }
                    else if (selectedValue.StartsWith("subfield:"))
                    {
                        var subFieldName = selectedValue.Substring(9);
                        itemsToAdd.Add((subFieldName, true));
                        Console.WriteLine($"Will add target subfield: {subFieldName}");
                    }
                }
            }
        }
        else
        {
            // No search term, process selected items normally
            foreach (var selectedValue in selectedAvailableTargetItems)
            {
                if (selectedValue.StartsWith("area:"))
                {
                    var areaName = selectedValue.Substring(5);
                    itemsToAdd.Add((areaName, false));
                    Console.WriteLine($"Will add target area: {areaName}");
                }
                else if (selectedValue.StartsWith("subfield:"))
                {
                    var subFieldName = selectedValue.Substring(9);
                    itemsToAdd.Add((subFieldName, true));
                    Console.WriteLine($"Will add target subfield: {subFieldName}");
                }
            }
        }

        // Add all collected items
        foreach (var item in itemsToAdd)
        {
            AddTargetAreaToSelected(item.name, item.isSubField);
        }

        // Validate and cleanup
        EnsureUniqueTargetAreas();
        FilterAvailableTargetAreasBasedOnSelection();
        selectedAvailableTargetItems.Clear();

        StateHasChanged();
    }

    private void ValidateTargetAreas()
    {
        Console.WriteLine("=== VALIDATING TARGET AREAS ===");

        var uniqueIds = new HashSet<string>();
        var duplicates = new List<string>();

        foreach (var item in selectedTargetAreasForAssessment)
        {
            Console.WriteLine($"Target Item: {item.FullName}, IsSubField: {item.IsSubField}, Parent: {item.ParentArea}, UniqueId: {item.UniqueId}");

            if (!uniqueIds.Add(item.UniqueId))
            {
                duplicates.Add(item.UniqueId);
            }
        }

        if (duplicates.Any())
        {
            Console.WriteLine($"FOUND TARGET DUPLICATES: {string.Join(", ", duplicates)}");
            EnsureUniqueTargetAreas();
        }
        else
        {
            Console.WriteLine("No target duplicates found - validation passed");
        }
        Console.WriteLine($"Total target items: {selectedTargetAreasForAssessment.Count}");
        Console.WriteLine("=== TARGET VALIDATION COMPLETE ===");
    }



    private async Task<List<string>> GetSelectedTargetAreasFromDOM(string selectId)
    {
        var selectedTargetAreas = await JSRuntime.InvokeAsync<List<string>>("getSelectedValues", selectId);
        return selectedTargetAreas;
    }

    private async Task<List<string>> GetSelectedAreasFromDOM(string selectId)
    {
        var selectedAreas = await JSRuntime.InvokeAsync<List<string>>("getSelectedValues", selectId);
        return selectedAreas;
        StateHasChanged();
    }

    private void ToggleSubFields(Area area)
    {
        if (expandedAreas.Contains(area.AreaName))
        {
            expandedAreas.Remove(area.AreaName);
        }
        else
        {
            expandedAreas.Add(area.AreaName);
        }
        StateHasChanged();
    }

    private void ToggleSubFieldsSkill(Skill skill)
    {
        if (expandedSkills.Contains(skill.SkillName))
        {
            expandedSkills.Remove(skill.SkillName);
        }
        else
        {
            expandedSkills.Add(skill.SkillName);
        }
        StateHasChanged();
    }

    private void OnAreaChange(ChangeEventArgs e)
    {
        var selectedValue = e.Value.ToString();
        var selectedArea = availableAreas.FirstOrDefault(a => a.AreaName == selectedValue);
        if (selectedArea != null)
        {
            ToggleSubFields(selectedArea);
        }
    }

    private void OnSkillChange(ChangeEventArgs e)
    {
        var selectedValue = e.Value.ToString();
        var selectedSkill = availableSkills.FirstOrDefault(a => a.SkillName == selectedValue);
    }

    private void OnTargetAreaChange(ChangeEventArgs e)
    {
        var selectedTargetValue = e.Value.ToString();
        var selectedTargetArea = availableTargetAreas.FirstOrDefault(a => a.AreaName == selectedTargetValue);
        if (selectedTargetArea != null)
        {
            ToggleSubFields(selectedTargetArea);
        }
    }

    private void OnTargetSkillChange(ChangeEventArgs e)
    {
        var selectedTargetValue = e.Value.ToString();
        var selectedTargetSkill = availableTargetSkills.FirstOrDefault(a => a.SkillName == selectedTargetValue);
    }


    private void SelectArea(string area)
    {
        if (!temporarilySelectedAreas.Contains(area))
        {
            temporarilySelectedAreas.Add(area);
            Console.WriteLine($"Area {area} added to temporarilySelectedAreas.");
        }
        else
        {
            temporarilySelectedAreas.Remove(area);
            Console.WriteLine($"Area {area} removed from temporarilySelectedAreas.");
        }

        newStudent.AreasOfExpertise = string.Join(",", temporarilySelectedAreas);
        Console.WriteLine("Temporarily Selected Areas: " + string.Join(",", temporarilySelectedAreas));
    }

    private void SelectTargetArea(string area)
    {
        if (!temporarilySelectedTargetAreas.Contains(area))
        {
            temporarilySelectedTargetAreas.Add(area);
            Console.WriteLine($"Target Area {area} added to temporarilySelectedTargetAreas.");
        }
        else
        {
            temporarilySelectedTargetAreas.Remove(area);
            Console.WriteLine($"Target Area {area} removed from temporarilySelectedTargetAreas.");
        }

        newStudent.TargetAreas = string.Join(",", temporarilySelectedTargetAreas);
        Console.WriteLine("Temporarily Selected Target Areas: " + string.Join(",", temporarilySelectedTargetAreas));
    }


    private void UpdateTemporarilySelectedAreas()
    {
        temporarilySelectedAreas.Clear();
        temporarilySelectedAreas.AddRange(selectedAreas);
        newStudent.AreasOfExpertise = string.Join(",", temporarilySelectedAreas);
        Console.WriteLine("Temporarily Selected Areas: " + string.Join(",", temporarilySelectedAreas));
        StateHasChanged();
    }

    private void UpdateTemporarilySelecteTargetAreas()
    {
        temporarilySelectedTargetAreas.Clear();
        temporarilySelectedTargetAreas.AddRange(selectedTargetAreas);
        newStudent.TargetAreas = string.Join(",", temporarilySelectedTargetAreas);
        Console.WriteLine("Temporarily Selected Target Areas: " + string.Join(",", temporarilySelectedTargetAreas));
        StateHasChanged();
    }

    private void UpdateSelectedAreas()
    {
        temporarilySelectedAreas.Clear();
        temporarilySelectedAreas.AddRange(selectedAreas);
        newStudent.AreasOfExpertise = string.Join(",", temporarilySelectedAreas);
        Console.WriteLine("Temporarily Selected Areas: " + string.Join(",", temporarilySelectedAreas));
        StateHasChanged();
    }


    private void UpdateSelectedTargetAreas()
    {
        temporarilySelectedTargetAreas.Clear();
        temporarilySelectedTargetAreas.AddRange(selectedTargetAreas);
        newStudent.TargetAreas = string.Join(",", temporarilySelectedTargetAreas);
        Console.WriteLine("Temporarily Selected Target Areas: " + string.Join(",", temporarilySelectedTargetAreas));
        StateHasChanged();
    }

    public class SelectedArea
    {
        public string AreaName { get; set; }
        public int Assessment { get; set; } = 1; // Default assessment value is 1
    }

    public class SelectedTargetArea
    {
        public string AreaName { get; set; }
        public int Assessment { get; set; } = 1; // Default assessment value is 1
    }


    public class SelectedSkill
    {
        public string SkillName { get; set; }
        public int Assessment { get; set; } = 1; // Default assessment value is 1
    }

    public class SelectedTargetSkill
    {
        public string SkillName { get; set; }
        public int Assessment { get; set; } = 1; // Default assessment value is 1
    }

    private async Task ShowUserAgreementModal(MouseEventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("showUserAgreementModal");
    }


    private async Task HandleAgreeAsync()
    {
        if (OnAgree.HasDelegate)
        {
            await OnAgree.InvokeAsync(null);
        }
    }

    private async Task HandleDeclineAsync()
    {
        if (OnDecline.HasDelegate)
        {
            await OnDecline.InvokeAsync(null);
        }
    }


    private bool showLoadingModalWhenUpdateStudentRegistration = false;
    private int loadingProgressWhenUpdateStudentRegistration = 0;

    private async Task UpdateStudentRegistration()
    {
        errorMessage = "";
        // Reset all input classes
        nameInputClass = "";
        surnameInputClass = "";
        telephoneInputClass = "";
        addressInputClass = "";
        pcInputClass = "";
        regionInputClass = "";
        townInputClass = "";
        studyYearInputClass = "";
        graduationDateInputClass = "";
        ectsInputClass = "";
        internshipInputClass = "";
        thesisInputClass = "";
        universityInputClass = "";
        schoolInputClass = "";
        departmentInputClass = "";
        enrollmentDateInputClass = "";
        levelOfDegreeInputClass = "";
        telephoneValidationMessage = "";

        // Show loading modal at the start
        showLoadingModalWhenUpdateStudentRegistration = true;
        loadingProgressWhenUpdateStudentRegistration = 0;
        StateHasChanged();

        try
        {
            // Step 1: Validation
            await UpdateProgressWhenUpdateStudentRegistration(10, 200);

            // List to track missing mandatory fields
            var missingFields = new List<string>();

            // Validate MANDATORY fields for update
            if (string.IsNullOrEmpty(newStudent.Name))
            {
                nameInputClass = "shake shake-input";
                missingFields.Add("Όνομα");
            }
            if (string.IsNullOrEmpty(newStudent.Surname))
            {
                surnameInputClass = "shake shake-input";
                missingFields.Add("Επώνυμο");
            }

            // Validate telephone with international format
            var telephoneValidation = ValidateTelephone(newStudent.Telephone);
            if (!string.IsNullOrEmpty(telephoneValidation))
            {
                telephoneInputClass = "shake shake-input";
                telephoneValidationMessage = telephoneValidation;
                missingFields.Add("Τηλέφωνο");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentAddress))
            {
                addressInputClass = "shake shake-input";
                missingFields.Add("Διεύθυνση");
            }
            if (newStudent.PermanentPC == 0)
            {
                pcInputClass = "shake shake-input";
                missingFields.Add("Ταχυδρομικός Κώδικας");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentRegion))
            {
                regionInputClass = "shake shake-input";
                missingFields.Add("Περιφέρεια");
            }
            if (string.IsNullOrEmpty(newStudent.PermanentTown))
            {
                townInputClass = "shake shake-input";
                missingFields.Add("Πόλη");
            }
            if (string.IsNullOrEmpty(newStudent.StudyYear))
            {
                studyYearInputClass = "shake shake-input";
                missingFields.Add("Έτος Φοίτησης");
            }
            if (newStudent.ExpectedGraduationDate == default)
            {
                graduationDateInputClass = "shake shake-input";
                missingFields.Add("Αναμενόμενη Ημερομηνία Αποφοίτησης");
            }
            if (newStudent.CompletedECTS == 0)
            {
                ectsInputClass = "shake shake-input";
                missingFields.Add("Συμπληρωμένες Διδακτικές Μονάδες");
            }
            if (string.IsNullOrEmpty(newStudent.University))
            {
                universityInputClass = "shake shake-input";
                missingFields.Add("Πανεπιστημιακό Ίδρυμα");
            }
            if (string.IsNullOrEmpty(newStudent.School))
            {
                schoolInputClass = "shake shake-input";
                missingFields.Add("Σχολή");
            }
            if (string.IsNullOrEmpty(newStudent.Department))
            {
                departmentInputClass = "shake shake-input";
                missingFields.Add("Τμήμα");
            }
            if (string.IsNullOrEmpty(newStudent.EnrollmentDate))
            {
                enrollmentDateInputClass = "shake shake-input";
                missingFields.Add("Έτος Εγγραφής");
            }
            if (string.IsNullOrEmpty(newStudent.LevelOfDegree))
            {
                levelOfDegreeInputClass = "shake shake-input";
                missingFields.Add("Ιδιότητα Μέλους");
            }

            // Validate right-side boxes (selected items)
            if (selectedAreasForAssessment.Count == 0)
            {
                areasValidationClass = "shake shake-input";
                missingFields.Add("Περιοχές Εξειδίκευσης");
            }

            if (selectedTargetAreasForAssessment.Count == 0)
            {
                targetAreasValidationClass = "shake shake-input";
                missingFields.Add("Περιοχές Ενδιαφέροντος");
            }

            if (selectedSkillsForAssessment.Count == 0)
            {
                skillsValidationClass = "shake shake-input";
                missingFields.Add("Τεχνικές Ικανότητες");
            }

            if (selectedTargetSkillsForAssessment.Count == 0)
            {
                targetSkillsValidationClass = "shake shake-input";
                missingFields.Add("Τεχνικές Ικανότητες Ενδιαφέροντος");
            }

            if (missingFields.Count > 0)
            {
                showLoadingModalWhenUpdateStudentRegistration = false;
                StateHasChanged();
                errorMessage = $"Συμπληρώστε τα ακόλουθα πεδία: {string.Join(", ", missingFields)}";
                return;
            }

            // Step 2: Data preparation
            await UpdateProgressWhenUpdateStudentRegistration(30, 200);

            // Clear research fields if not applicable
            if (!ShouldShowResearchFields())
            {
                newStudent.WhenStudentIsPostDocOrPhD_ResearchTitle = "";
                newStudent.WhenStudentIsPostDocOrPhD_ResearchDescription = "";
            }
            if (string.IsNullOrEmpty(newStudent.LinkedInProfile))
            {
                newStudent.LinkedInProfile = "";
            }

            if (string.IsNullOrEmpty(newStudent.PersonalWebsite))
            {
                newStudent.PersonalWebsite = "";
            }

            if (string.IsNullOrEmpty(newStudent.StudentGoogleScholarProfile))
            {
                newStudent.StudentGoogleScholarProfile = "";
            }

            // Step 3: Database operations
            await UpdateProgressWhenUpdateStudentRegistration(50, 200);

            using var dbContext = await DbContextFactory.CreateDbContextAsync();

            // Log selected areas for debugging
            Console.WriteLine($"Selected Areas for Update: {string.Join(", ", selectedAreasForAssessment.Select(a => a.FullName))}");
            Console.WriteLine($"Selected Target Areas for Update: {string.Join(", ", selectedTargetAreasForAssessment.Select(a => a.FullName))}");
            Console.WriteLine($"Selected Skills for Update: {string.Join(", ", selectedSkillsForAssessment.Select(s => s.SkillName))}");

            // Update AreasOfExpertise and SelfAssesmentAreas with the selected areas
            newStudent.AreasOfExpertise = string.Join(",", selectedAreasForAssessment.Select(a => a.FullName));
            newStudent.SelfAssesmentAreas = string.Join(",", selectedAreasForAssessment.Select(sa => $"{sa.FullName}:{sa.Assessment}"));
            newStudent.TargetAreas = string.Join(",", selectedTargetAreasForAssessment.Select(a => a.FullName));

            // Update TargetSkills with the selected skills and their assessments
            newStudent.Keywords = string.Join(",", selectedSkillsForAssessment.Select(s => $"{s.SkillName}"));
            newStudent.SelfAssesmentSkills = string.Join(",", selectedSkillsForAssessment.Select(sa => $"{sa.SkillName}:{sa.Assessment}"));
            newStudent.TargetSkills = string.Join(",", selectedTargetSkillsForAssessment.Select(a => a.SkillName));

            newStudent.LastProfileUpdate = DateTime.Now;

            // Update PreferredRegions with the selected regions
            newStudent.PreferedRegions = string.Join(",", selectedRegionsDictionary
                .Where(kvp => kvp.Value)
                .Select(kvp => kvp.Key));

            // Update PreferredTowns with the selected towns in the required format
            var preferredTownsList = new List<string>();

            foreach (var region in Regions)
            {
                if (selectedRegionsDictionary.TryGetValue(region, out bool isSelected) && isSelected)
                {
                    if (RegionToTownsMap.TryGetValue(region, out var towns))
                    {
                        var selectedTowns = towns
                            .Where(town => selectedTownsDictionary.TryGetValue(town, out bool townSelected) && townSelected)
                            .ToList();

                        if (selectedTowns.Any())
                        {
                            preferredTownsList.Add($"[{region}: {string.Join(", ", selectedTowns)}]");
                        }
                    }
                }
            }

            newStudent.PreferredTowns = string.Join(", ", preferredTownsList);

            // Debug output
            Console.WriteLine($"Regions to save: {newStudent.PreferedRegions}");
            Console.WriteLine($"Towns to save: {newStudent.PreferredTowns}");

            await UpdateProgressWhenUpdateStudentRegistration(70, 200);

            if (isRegistered)
            {
                dbContext.Students.Update(newStudent);
            }
            else
            {
                dbContext.Students.Add(newStudent);
            }

            await dbContext.SaveChangesAsync();
            updated = true;

            // Reset error message on success
            errorMessage = "";

            await UpdateProgressWhenUpdateStudentRegistration(100, 200);

            // Small delay to show completion
            await Task.Delay(500);

            showLoadingModalWhenUpdateStudentRegistration = false;
            StateHasChanged();

            
            await Task.Delay(100); // Small delay for smooth transition
        
            // Show the navigation loader
            await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
        
            // Give time for loader to render
            await Task.Delay(300);

            // Step 4: Navigate
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            // Hide loading modal on error
            showLoadingModalWhenUpdateStudentRegistration = false;
            StateHasChanged();

            error = true;
            errorMessage = "Σφάλμα κατά την ενημέρωση. Παρακαλώ δοκιμάστε ξανά.";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            // Reset input classes and state after delay
            // We'll do this without hiding the modal since it's already hidden
            await Task.Delay(3000); // Keep the shake effect for 3 seconds
            nameInputClass = "";
            surnameInputClass = "";
            telephoneInputClass = "";
            addressInputClass = "";
            pcInputClass = "";
            regionInputClass = "";
            townInputClass = "";
            studyYearInputClass = "";
            graduationDateInputClass = "";
            ectsInputClass = "";
            internshipInputClass = "";
            thesisInputClass = "";
            universityInputClass = "";
            schoolInputClass = "";
            departmentInputClass = "";
            enrollmentDateInputClass = "";
            levelOfDegreeInputClass = "";
            areasValidationClass = "";
            targetAreasValidationClass = "";
            skillsValidationClass = "";
            targetSkillsValidationClass = "";
            areasValidationMessage = "";
            targetAreasValidationMessage = "";
            skillsValidationMessage = "";
            targetSkillsValidationMessage = "";
            nameValidationMessage = "";
            surnameValidationMessage = "";
            telephoneValidationMessage = "";

            StateHasChanged(); // Force UI update to clear validation
        }
    }

    // Helper method to update progress and refresh UI
    private async Task UpdateProgressWhenUpdateStudentRegistration(int current, int total)
    {
        loadingProgressWhenUpdateStudentRegistration = (int)((double)current / total * 100);
        StateHasChanged();
        await Task.Delay(50); // Small delay for smooth animation
    }


    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        var selectedFiles = e.GetMultipleFiles();
        file = selectedFiles.FirstOrDefault();
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            newStudent.Image = buffer;
        }
    }

    private async Task AgreeToTermsAsync()
    {
        termsAccepted = true;
        canSubmit = true; // User can now submit by clicking save again
        agreeTerms = true;
        customCheckbox?.SetValue(true);

        StateHasChanged(); // Refresh UI to show new button state

    }

    private async Task DeclineTermsAsync()
    {
        termsAccepted = false;
        canSubmit = false;
        agreeTerms = false;
        customCheckbox?.SetValue(false);
        StateHasChanged();
    }

    protected override void OnParametersSet()
    {
        RemoveDuplicateAreas();
        base.OnParametersSet();
        // Call your logic when the component parameters are set (including when bound properties change)
        HandleDegreeLevelChange();
    }

    private void HandleDegreeLevelChange()
    {
        // Check if "Προπτυχιακός Φοιτητής" is selected
        if (newStudent.LevelOfDegree != "Προπτυχιακός Φοιτητής")
        {
            // Enable manual input for the user
            isManualInput = true;
        }
        else
        {
            isManualInput = false;
        }

        // Call StateHasChanged to update the UI if research fields need to appear/disappear
        StateHasChanged();
    }

    private string GetValidationClass(string fieldValue)
    {
        return string.IsNullOrEmpty(fieldValue) && showValidationError ? "shake error" : "";
    }

    private string GetValidationClassForEmptyAreasWhenSaveStudentRegistration(int areasCount)
    {
        return areasCount == 0 && showValidationError ? "shake error" : "";
    }



    private void OnAreaSelect(ChangeEventArgs e)
    {
        var selectedArea = e.Value.ToString();

        // If the area is selected, add it to the expanded areas
        if (expandedAreas.Contains(selectedArea))
        {
            expandedAreas.Remove(selectedArea); // Collapse the area
        }
        else
        {
            expandedAreas.Add(selectedArea); // Expand the area
        }

        // Re-trigger the UI to reflect changes
        StateHasChanged(); // Notify the UI to refresh
    }


    private string? formattedRegNumber;

    public string FormattedRegNumber
    {
        get
        {
            return FormatRegistryNumber(newStudent.RegNumber);
        }
        set
        {
            if (TryParseRegistryNumber(value, out long regNumber))
            {
                newStudent.RegNumber = regNumber;
            }
        }
    }

    private string FormatRegistryNumber(long regNumber)
    {
        string regNumberStr = regNumber.ToString("D13"); 
        string xxxx = regNumberStr.Substring(0, 4);     
        string yyyy = regNumberStr.Substring(4, 4);     
        string zzzzz = regNumberStr.Substring(8, 5);    
        return $"{xxxx}-{yyyy}-{zzzzz}";
    }

    private bool TryParseRegistryNumber(string formattedRegNumber, out long regNumber)
    {
        regNumber = 0;
        if (string.IsNullOrWhiteSpace(formattedRegNumber))
            return false;

        // Remove hyphens and parse the numeric value
        string numericValue = formattedRegNumber.Replace("-", "");
        return long.TryParse(numericValue, out regNumber);
    }

    private void UpdateRegionSelection(string region, bool isSelected)
    {
        selectedRegionsDictionary[region] = isSelected;

        // Automatically show towns when any region is selected
        newStudent.PreferredTownsBoolean = selectedRegionsDictionary.Any(kvp => kvp.Value);

        // Initialize towns for newly selected regions
        if (isSelected && RegionToTownsMap.TryGetValue(region, out var towns))
        {
            foreach (var town in towns)
            {
                if (!selectedTownsDictionary.ContainsKey(town))
                {
                    selectedTownsDictionary[town] = false;
                }
            }
        }

        StateHasChanged();
    }

    private void UpdateTownSelection(string town, bool isSelected)
    {
        selectedTownsDictionary[town] = isSelected;
        StateHasChanged();
    }

    private void InitializeTownsForSelectedRegions()
    {
        foreach (var region in Regions)
        {
            if (selectedRegionsDictionary.ContainsKey(region) && selectedRegionsDictionary[region])
            {
                if (RegionToTownsMap.ContainsKey(region))
                {
                    foreach (var town in RegionToTownsMap[region])
                    {
                        if (!selectedTownsDictionary.ContainsKey(town))
                        {
                            selectedTownsDictionary[town] = false;
                        }
                    }
                }
            }
        }
    }

    private void OnSchoolChange(ChangeEventArgs e)
    {
        newStudent.School = e.Value?.ToString();
        UpdateDepartments();
    }

    private void UpdateDepartments()
    {
        if (!string.IsNullOrEmpty(newStudent.School) &&
            schoolDepartments.ContainsKey(newStudent.School))
        {
            departments = schoolDepartments[newStudent.School];
            // Reset department selection when school changes
            newStudent.Department = string.Empty;
        }
        else
        {
            departments = new List<string>();
            newStudent.Department = string.Empty;
        }

        StateHasChanged();
    }

    private void OnDepartmentChange(ChangeEventArgs e)
    {
        newStudent.Department = e.Value?.ToString();
    }

    private string researchGroupMessage = "Γίνεται έλεγχος...";
    private async Task CheckResearchGroupMembership()
    {
        using var dbContext = await DbContextFactory.CreateDbContextAsync();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userEmail = user.Identity.Name;

        // First, check if professor exists in any research group
        var researchGroupMembership = await dbContext.ResearchGroup_NonFacultyMembers
            .FirstOrDefaultAsync(rgp => rgp.PK_NonFacultyMemberEmail == userEmail);

        if (researchGroupMembership != null)
        {
            // If found, get the research group details
            var researchGroup = await dbContext.ResearchGroups
                .FirstOrDefaultAsync(rg => rg.ResearchGroupEmail == researchGroupMembership.PK_ResearchGroupEmail);

            newStudent.NameOfResearchGroupHeIsMember = researchGroup?.ResearchGroupName;
            researchGroupMessage = "Είστε μέλος της ερευνητικής ομάδας";
        }
        else
        {
            newStudent.NameOfResearchGroupHeIsMember = "Δεν είστε μέλος σε κάποια Ερευνητική Ομάδα ακόμη";
            researchGroupMessage = "Δεν βρέθηκε συμμετοχή σε ερευνητική ομάδα.";
        }

        StateHasChanged();
    }

    public class AreaItem : IEquatable<AreaItem>
    {
        public string FullName { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public bool IsSubField { get; set; }
        public string ParentArea { get; set; } = "";
        public int Assessment { get; set; } = 1;

        public string UniqueId => IsSubField ?
            $"SUBFIELD_{ParentArea}_{FullName}" :
            $"AREA_{FullName}";

        public override bool Equals(object obj)
        {
            return Equals(obj as AreaItem);
        }

        public bool Equals(AreaItem other)
        {
            return other != null && UniqueId == other.UniqueId;
        }

        public override int GetHashCode()
        {
            return UniqueId.GetHashCode();
        }
    }

    private void OnAvailableAreaSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedAvailableItems = selectedValues?.ToList() ?? new List<string>();
    }

    private void OnSelectedAreaSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedSelectedItems = selectedValues?.ToList() ?? new List<string>();
    }

    private void AddAreaToSelected(string name, bool isSubField)
    {
        var parentArea = "";
        if (isSubField)
        {
            parentArea = FindParentArea(name);
            if (string.IsNullOrEmpty(parentArea))
            {
                parentArea = FindParentAreaFromAvailableAreas(name);
                if (string.IsNullOrEmpty(parentArea))
                {
                    parentArea = "Unknown";
                }
            }
        }

        // Strong duplicate check with detailed logging
        if (!CanAddArea(name, isSubField, parentArea))
        {
            Console.WriteLine($"BLOCKED: Attempt to add duplicate - Name: {name}, IsSubField: {isSubField}, Parent: {parentArea}");
            return;
        }

        var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{name}" : $"AREA_{name}";

        // Final safety check
        if (selectedAreasForAssessment.Any(item => item.UniqueId == uniqueId))
        {
            Console.WriteLine($"SAFETY CHECK FAILED: Item with ID {uniqueId} already exists");
            return;
        }

        var newItem = new AreaItem
            {
                FullName = name,
                DisplayName = name,
                IsSubField = isSubField,
                ParentArea = parentArea,
                Assessment = 1
            };

        selectedAreasForAssessment.Add(newItem);
        Console.WriteLine($"SUCCESS: Added area - UniqueId: {newItem.UniqueId}, Name: {name}, Type: {(isSubField ? "Subfield" : "Area")}, Custom: {!isSubField && !availableAreas.Any(a => a.AreaName.Equals(name, StringComparison.OrdinalIgnoreCase))}");
    }


    private string FindParentAreaFromAvailableAreas(string subFieldName)
    {
        foreach (var area in availableAreas)
        {
            var subFields = area.AreaSubFields?.Split(',');
            if (subFields != null && subFields.Contains(subFieldName))
            {
                return area.AreaName;
            }
        }
        return "Unknown";
    }

    private string FindParentArea(string subFieldName)
    {
        foreach (var area in availableAreas)
        {
            var subFields = area.AreaSubFields?.Split(',');
            if (subFields != null && subFields.Contains(subFieldName))
            {
                return area.AreaName;
            }
        }
        return "";
    }

    private void FilterAvailableAreasBasedOnSelection()
    {
        // Filter out areas that are already selected (only main areas, not subfields)
        var selectedAreaNames = selectedAreasForAssessment
            .Where(item => !item.IsSubField)
            .Select(item => item.FullName)
            .ToList();

        // filteredAreas should contain all availableAreas EXCEPT the selected ones
        filteredAreas = availableAreas
            .Where(area => !selectedAreaNames.Contains(area.AreaName))
            .ToList();

        Console.WriteLine($"Available areas: {availableAreas.Count}, Filtered areas: {filteredAreas.Count}, Selected areas: {selectedAreasForAssessment.Count}");
    }

    // Update your existing FilterAvailableAreas method
    private void FilterAvailableAreas(ChangeEventArgs e)
    {
        areassearchTerm = e.Value?.ToString() ?? "";

        var selectedAreaNames = selectedAreasForAssessment
            .Where(item => !item.IsSubField)
            .Select(item => item.FullName)
            .ToList();

        if (string.IsNullOrWhiteSpace(areassearchTerm))
        {
            filteredAreas = availableAreas
                .Where(area => !selectedAreaNames.Contains(area.AreaName))
                .ToList();
            expandedAreas.Clear();
        }
        else
        {
            var searchTerm = areassearchTerm.Trim();

            // Clear previous expansions
            expandedAreas.Clear();

            filteredAreas = availableAreas
                .Where(area => !selectedAreaNames.Contains(area.AreaName))
                .Where(area =>
                    area.AreaName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (area.AreaSubFields != null &&
                     area.AreaSubFields.Split(',')
                        .Any(subField => subField.Trim()
                            .Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                )
                .ToList();

            // Check if search term doesn't match any existing area (potential custom area)
            var isPotentialCustomArea = !availableAreas.Any(a =>
                a.AreaName.Equals(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
                !selectedAreaNames.Contains(searchTerm);

            if (isPotentialCustomArea && filteredAreas.Count == 0)
            {
                // You could add a visual hint here that custom area can be added
                Console.WriteLine($"Potential custom area detected: {searchTerm}");
            }

            // Expand areas that have matching subfields
            foreach (var area in filteredAreas)
            {
                bool hasMatchingSubfield = area.AreaSubFields != null &&
                    area.AreaSubFields.Split(',')
                        .Any(subField => subField.Trim()
                            .Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

                if (hasMatchingSubfield)
                {
                    expandedAreas.Add(area.AreaName);
                }
            }
        }

        StateHasChanged();
    }

    // Update your ToggleExpansion method to work with the new structure
    private void ToggleExpansion(string areaName)
    {
        if (expandedAreas.Contains(areaName))
        {
            expandedAreas.Remove(areaName);
        }
        else
        {
            expandedAreas.Add(areaName);
        }
        StateHasChanged();
    }

    private async Task InitializeTargetAreas()
    {
        using var dbContext = await DbContextFactory.CreateDbContextAsync();
        availableTargetAreas = await dbContext.Areas.ToListAsync();
        filteredTargetAreas = availableTargetAreas.ToList();
    }

    // Selection change handlers
    private void OnAvailableTargetAreaSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedAvailableTargetItems = selectedValues?.ToList() ?? new List<string>();
    }

    private void OnSelectedTargetAreaSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedSelectedTargetItems = selectedValues?.ToList() ?? new List<string>();
    }

    private void AddTargetAreaToSelected(string name, bool isSubField)
    {
        var parentArea = "";
        if (isSubField)
        {
            parentArea = FindParentTargetArea(name);
            if (string.IsNullOrEmpty(parentArea))
            {
                parentArea = FindParentTargetAreaFromAvailableAreas(name);
                if (string.IsNullOrEmpty(parentArea))
                {
                    parentArea = "Unknown"; // Ensure parent area is never empty
                }
            }
        }

        // Strong duplicate check with detailed logging
        if (!CanAddTargetArea(name, isSubField, parentArea))
        {
            Console.WriteLine($"BLOCKED: Attempt to add target duplicate - Name: {name}, IsSubField: {isSubField}, Parent: {parentArea}");
            return;
        }

        var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{name}" : $"AREA_{name}";

        // Final safety check
        if (selectedTargetAreasForAssessment.Any(item => item.UniqueId == uniqueId))
        {
            Console.WriteLine($"SAFETY CHECK FAILED: Target item with ID {uniqueId} already exists");
            return;
        }

        var newItem = new AreaItem
            {
                FullName = name,
                DisplayName = name,
                IsSubField = isSubField,
                ParentArea = parentArea,
                Assessment = 1
            };

        selectedTargetAreasForAssessment.Add(newItem);
        Console.WriteLine($"SUCCESS: Added target area - UniqueId: {newItem.UniqueId}, Name: {name}, Type: {(isSubField ? "Subfield" : "Area")}");
    }

    private string FindParentTargetAreaFromAvailableAreas(string subFieldName)
    {
        foreach (var area in availableTargetAreas)
        {
            var subFields = area.AreaSubFields?.Split(',');
            if (subFields != null && subFields.Contains(subFieldName))
            {
                return area.AreaName;
            }
        }
        return "Unknown";
    }

    private string FindParentTargetArea(string subFieldName)
    {
        foreach (var area in availableTargetAreas)
        {
            var subFields = area.AreaSubFields?.Split(',');
            if (subFields != null && subFields.Contains(subFieldName))
            {
                return area.AreaName;
            }
        }
        return "";
    }

    // Filtering methods
    private void FilterAvailableTargetAreasBasedOnSelection()
    {
        // Filter out areas that are already selected (only main areas, not subfields)
        var selectedAreaNames = selectedTargetAreasForAssessment
            .Where(item => !item.IsSubField)
            .Select(item => item.FullName)
            .ToList();

        // filteredTargetAreas should contain all availableTargetAreas EXCEPT the selected ones
        filteredTargetAreas = availableTargetAreas
            .Where(area => !selectedAreaNames.Contains(area.AreaName))
            .ToList();

        Console.WriteLine($"Available Target Areas: {availableTargetAreas.Count}, Filtered Target Areas: {filteredTargetAreas.Count}, Selected Target Areas: {selectedTargetAreasForAssessment.Count}");
    }

    private void FilterAvailableTargetAreas(ChangeEventArgs e)
    {
        targetAreasSearchTerm = e.Value?.ToString() ?? "";

        var selectedAreaNames = selectedTargetAreasForAssessment
            .Where(item => !item.IsSubField)
            .Select(item => item.FullName)
            .ToList();

        if (string.IsNullOrWhiteSpace(targetAreasSearchTerm))
        {
            // If search term is empty, show all areas except selected ones
            filteredTargetAreas = availableTargetAreas
                .Where(area => !selectedAreaNames.Contains(area.AreaName))
                .ToList();

            // Collapse all areas when search is cleared
            expandedTargetAreas.Clear();
        }
        else
        {
            var searchTerm = targetAreasSearchTerm.Trim();

            // Clear previous search-based expansions but keep manually expanded areas
            var manuallyExpandedAreas = expandedTargetAreas.Where(a =>
                !filteredTargetAreas.Any(fa => fa.AreaName == a)).ToList();
            expandedTargetAreas.Clear();
            expandedTargetAreas.UnionWith(manuallyExpandedAreas);

            // Search in both area names and subfields
            filteredTargetAreas = availableTargetAreas
                .Where(area => !selectedAreaNames.Contains(area.AreaName))
                .Where(area =>
                    // Check if area name matches
                    area.AreaName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    // OR check if any subfield matches
                    (area.AreaSubFields != null &&
                     area.AreaSubFields.Split(',')
                        .Any(subField => subField.Trim()
                            .Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                )
                .ToList();

            // Auto-expand ONLY areas that have matching subfields
            foreach (var area in filteredTargetAreas)
            {
                if (area.AreaSubFields != null &&
                    area.AreaSubFields.Split(',')
                        .Any(subField => subField.Trim()
                            .Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
                    !expandedTargetAreas.Contains(area.AreaName))
                {
                    expandedTargetAreas.Add(area.AreaName);
                }
            }
        }

        StateHasChanged();
    }

    // Expansion toggle
    private void ToggleTargetAreaExpansion(string areaName)
    {
        if (expandedTargetAreas.Contains(areaName))
        {
            expandedTargetAreas.Remove(areaName);
        }
        else
        {
            expandedTargetAreas.Add(areaName);
        }
        StateHasChanged();
    }

    private void RemoveDuplicateAreas()
    {
        // Remove duplicates from selectedAreasForAssessment
        selectedAreasForAssessment = selectedAreasForAssessment
            .GroupBy(a => new { a.FullName, a.IsSubField })
            .Select(g => g.First())
            .ToList();

        // Remove duplicates from selectedTargetAreasForAssessment
        selectedTargetAreasForAssessment = selectedTargetAreasForAssessment
            .GroupBy(a => new { a.FullName, a.IsSubField })
            .Select(g => g.First())
            .ToList();
    }


    private void CheckForDuplicateKeys()
    {
        var keys = new HashSet<string>();
        var duplicates = new List<string>();

        foreach (var item in selectedAreasForAssessment)
        {
            string key = item.IsSubField ?
                $"selected-subfield-{item.UniqueId}" :
                $"selected-area-{item.UniqueId}";

            if (!keys.Add(key))
            {
                duplicates.Add(key);
            }
        }

        if (duplicates.Any())
        {
            Console.WriteLine($"FOUND DUPLICATE KEYS: {string.Join(", ", duplicates)}");
            // Force cleanup
            EnsureUniqueSelectedAreas();
        }
        else
        {
            Console.WriteLine("No duplicate keys found in areas");
        }
    }

    private void CheckForDuplicateTargetKeys()
    {
        var keys = new HashSet<string>();
        var duplicates = new List<string>();

        foreach (var item in selectedTargetAreasForAssessment)
        {
            string key = item.IsSubField ?
                $"selected-target-subfield-{item.UniqueId}" :
                $"selected-target-area-{item.UniqueId}";

            if (!keys.Add(key))
            {
                duplicates.Add(key);
            }
        }

        if (duplicates.Any())
        {
            Console.WriteLine($"FOUND DUPLICATE TARGET KEYS: {string.Join(", ", duplicates)}");
            // Force cleanup
            EnsureUniqueTargetAreas();
        }
        else
        {
            Console.WriteLine("No duplicate keys found in target areas");
        }
    }

    private void EnsureUniqueSelectedAreas()
    {
        var beforeCount = selectedAreasForAssessment.Count;
        selectedAreasForAssessment = selectedAreasForAssessment
            .GroupBy(a => a.UniqueId)
            .Select(g => g.First())
            .ToList();

        var afterCount = selectedAreasForAssessment.Count;
        if (beforeCount != afterCount)
        {
            Console.WriteLine($"Removed {beforeCount - afterCount} duplicate areas");
        }
    }

    private void EnsureUniqueTargetAreas()
    {
        var beforeCount = selectedTargetAreasForAssessment.Count;
        selectedTargetAreasForAssessment = selectedTargetAreasForAssessment
            .GroupBy(a => a.UniqueId)
            .Select(g => g.First())
            .ToList();

        var afterCount = selectedTargetAreasForAssessment.Count;
        if (beforeCount != afterCount)
        {
            Console.WriteLine($"Removed {beforeCount - afterCount} duplicate target areas");
        }
    }

    private bool CanAddArea(string name, bool isSubField, string parentArea = "")
    {
        var cleanName = name.Trim();
        var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{cleanName}" : $"AREA_{cleanName}";

        Console.WriteLine($"Checking if can add: '{cleanName}' as {(isSubField ? "subfield" : "area")}, Parent: '{parentArea}'");

        // 1. Check if an item with this unique ID already exists
        if (selectedAreasForAssessment.Any(item => item.UniqueId == uniqueId))
        {
            Console.WriteLine($"❌ Cannot add: {cleanName} - already exists with ID: {uniqueId}");
            return false;
        }

        // 2. Prevent adding subfield with same name as existing area (case insensitive)
        if (isSubField && selectedAreasForAssessment.Any(item => !item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
        {
            Console.WriteLine($"❌ Cannot add subfield: {cleanName} - an area with the same name already exists");
            return false;
        }

        // 3. Prevent adding area with same name as existing subfield (case insensitive)
        if (!isSubField && selectedAreasForAssessment.Any(item => item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
        {
            Console.WriteLine($"❌ Cannot add area: {cleanName} - a subfield with the same name already exists");
            return false;
        }

        // 4. Check for custom area vs subfield conflicts
        if (!isSubField)
        {
            // Check if this name exists as a subfield in ANY available area (not just selected ones)
            bool existsAsSubfieldInAvailableAreas = availableAreas.Any(area =>
                area.AreaSubFields?.Split(',')
                    .Any(subField => subField.Trim().Equals(cleanName, StringComparison.OrdinalIgnoreCase)) == true);

            if (existsAsSubfieldInAvailableAreas)
            {
                Console.WriteLine($"❌ Cannot add area: {cleanName} - this name exists as a subfield in available areas");
                return false;
            }

            // For regular areas (not custom), check if any of their subfields are already selected
            bool existsAsMainAreaInAvailable = availableAreas.Any(area =>
                area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

            if (existsAsMainAreaInAvailable)
            {
                // This is a regular area (not custom), check if its subfields are selected
                var area = availableAreas.First(a => a.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));
                if (area.AreaSubFields != null)
                {
                    var subFields = area.AreaSubFields.Split(',');
                    foreach (var subField in subFields)
                    {
                        var subFieldName = subField.Trim();
                        var subFieldUniqueId = $"SUBFIELD_{cleanName}_{subFieldName}";

                        if (selectedAreasForAssessment.Any(item => item.UniqueId == subFieldUniqueId))
                        {
                            Console.WriteLine($"❌ Cannot add area: {cleanName} - its subfield '{subFieldName}' is already selected");
                            return false;
                        }
                    }
                }
            }
        }
        else
        {
            // For subfields: check if parent area is already selected
            if (!string.IsNullOrEmpty(parentArea))
            {
                var parentUniqueId = $"AREA_{parentArea}";
                if (selectedAreasForAssessment.Any(item => item.UniqueId == parentUniqueId))
                {
                    Console.WriteLine($"❌ Cannot add subfield: {cleanName} - parent area '{parentArea}' is already selected");
                    return false;
                }
            }

            // Also check if this subfield name exists as a main area in available areas
            bool existsAsMainArea = availableAreas.Any(area =>
                area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

            if (existsAsMainArea)
            {
                Console.WriteLine($"❌ Cannot add subfield: {cleanName} - this name exists as a main area in available areas");
                return false;
            }
        }

        Console.WriteLine($"✅ Can add: {cleanName} as {(isSubField ? "subfield" : "area")}");
        return true;
    }

    private bool CanAddTargetArea(string name, bool isSubField, string parentArea = "")
    {
        var cleanName = name.Trim();
        var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{cleanName}" : $"AREA_{cleanName}";

        Console.WriteLine($"Checking if can add target: '{cleanName}' as {(isSubField ? "subfield" : "area")}, Parent: '{parentArea}'");

        // 1. Check if an item with this unique ID already exists
        if (selectedTargetAreasForAssessment.Any(item => item.UniqueId == uniqueId))
        {
            Console.WriteLine($"❌ Cannot add target: {cleanName} - already exists with ID: {uniqueId}");
            return false;
        }

        // 2. Prevent adding subfield with same name as existing area (case insensitive)
        if (isSubField && selectedTargetAreasForAssessment.Any(item => !item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
        {
            Console.WriteLine($"❌ Cannot add target subfield: {cleanName} - an area with the same name already exists");
            return false;
        }

        // 3. Prevent adding area with same name as existing subfield (case insensitive)
        if (!isSubField && selectedTargetAreasForAssessment.Any(item => item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
        {
            Console.WriteLine($"❌ Cannot add target area: {cleanName} - a subfield with the same name already exists");
            return false;
        }

        // 4. Check for custom area vs subfield conflicts
        if (!isSubField)
        {
            // Check if this name exists as a subfield in ANY available area (not just selected ones)
            bool existsAsSubfieldInAvailableAreas = availableAreas.Any(area =>
                area.AreaSubFields?.Split(',')
                    .Any(subField => subField.Trim().Equals(cleanName, StringComparison.OrdinalIgnoreCase)) == true);

            if (existsAsSubfieldInAvailableAreas)
            {
                Console.WriteLine($"❌ Cannot add target area: {cleanName} - this name exists as a subfield in available areas");
                return false;
            }

            // For regular areas (not custom), check if any of their subfields are already selected
            bool existsAsMainAreaInAvailable = availableAreas.Any(area =>
                area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

            if (existsAsMainAreaInAvailable)
            {
                // This is a regular area (not custom), check if its subfields are selected
                var area = availableAreas.First(a => a.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));
                if (area.AreaSubFields != null)
                {
                    var subFields = area.AreaSubFields.Split(',');
                    foreach (var subField in subFields)
                    {
                        var subFieldName = subField.Trim();
                        var subFieldUniqueId = $"SUBFIELD_{cleanName}_{subFieldName}";

                        if (selectedTargetAreasForAssessment.Any(item => item.UniqueId == subFieldUniqueId))
                        {
                            Console.WriteLine($"❌ Cannot add target area: {cleanName} - its subfield '{subFieldName}' is already selected");
                            return false;
                        }
                    }
                }
            }
        }
        else
        {
            // For subfields: check if parent area is already selected
            if (!string.IsNullOrEmpty(parentArea))
            {
                var parentUniqueId = $"AREA_{parentArea}";
                if (selectedTargetAreasForAssessment.Any(item => item.UniqueId == parentUniqueId))
                {
                    Console.WriteLine($"❌ Cannot add target subfield: {cleanName} - parent area '{parentArea}' is already selected");
                    return false;
                }
            }

            // Also check if this subfield name exists as a main area in available areas
            bool existsAsMainArea = availableAreas.Any(area =>
                area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

            if (existsAsMainArea)
            {
                Console.WriteLine($"❌ Cannot add target subfield: {cleanName} - this name exists as a main area in available areas");
                return false;
            }
        }

        Console.WriteLine($"✅ Can add target: {cleanName} as {(isSubField ? "subfield" : "area")}");
        return true;
    }

    private void ValidateSelectedAreas()
    {
        Console.WriteLine("=== VALIDATING SELECTED AREAS ===");

        var uniqueIds = new HashSet<string>();
        var duplicates = new List<string>();

        foreach (var item in selectedAreasForAssessment)
        {
            Console.WriteLine($"Item: {item.FullName}, IsSubField: {item.IsSubField}, Parent: {item.ParentArea}, UniqueId: {item.UniqueId}");

            if (!uniqueIds.Add(item.UniqueId))
            {
                duplicates.Add(item.UniqueId);
            }
        }

        if (duplicates.Any())
        {
            Console.WriteLine($"FOUND DUPLICATES: {string.Join(", ", duplicates)}");
            // Force cleanup
            EnsureUniqueSelectedAreas();
        }
        else
        {
            Console.WriteLine("No duplicates found - validation passed");
        }
        Console.WriteLine($"Total items: {selectedAreasForAssessment.Count}");
        Console.WriteLine("=== VALIDATION COMPLETE ===");
    }

    private bool IsCustomArea(string areaName)
    {
        bool isSubfieldOfAvailableArea = availableAreas.Any(area =>
            area.AreaSubFields?.Split(',').Any(subField =>
                subField.Trim().Equals(areaName, StringComparison.OrdinalIgnoreCase)) == true);

        bool existsAsMainArea = availableAreas.Any(area =>
            area.AreaName.Equals(areaName, StringComparison.OrdinalIgnoreCase));

        return !isSubfieldOfAvailableArea && !existsAsMainArea;
    }

    private bool IsCustomTargetArea(string areaName)
    {
        bool isSubfieldOfAvailableArea = availableTargetAreas.Any(area =>
            area.AreaSubFields?.Split(',').Any(subField =>
                subField.Trim().Equals(areaName, StringComparison.OrdinalIgnoreCase)) == true);

        bool existsAsMainArea = availableTargetAreas.Any(area =>
            area.AreaName.Equals(areaName, StringComparison.OrdinalIgnoreCase));

        return !isSubfieldOfAvailableArea && !existsAsMainArea;
    }

    private string skillsSearchTerm = "";
    private string targetSkillsSearchTerm = "";
    private List<string> selectedAvailableSkills = new List<string>();
    private List<string> selectedSelectedSkills = new List<string>();
    private List<string> selectedAvailableTargetSkills = new List<string>();
    private List<string> selectedSelectedTargetSkills = new List<string>();
    private List<Skill> availableSkills = new List<Skill>();
    private List<SelectedSkill> availableTargetSkills = new List<SelectedSkill>();
    private List<SelectedSkill> filteredSkills = new List<SelectedSkill>();
    private List<SelectedSkill> filteredTargetSkills = new List<SelectedSkill>();

    // Helper methods to check for custom skills
    private bool IsCustomSkill(string skillName)
    {
        return !availableSkills.Any(s => s.SkillName.Equals(skillName, StringComparison.OrdinalIgnoreCase));
    }


    private bool IsCustomTargetSkill(string skillName)
    {
        // Get the original skill names from the database
        var originalSkillNames = availableSkills.Select(s => s.SkillName).ToList();
        return !originalSkillNames.Any(s => s.Equals(skillName, StringComparison.OrdinalIgnoreCase));
    }

    // Selection change handlers
    private void OnAvailableSkillSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedAvailableSkills = selectedValues?.ToList() ?? new List<string>();
    }

    private void OnSelectedSkillSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedSelectedSkills = selectedValues?.ToList() ?? new List<string>();
    }

    private void OnAvailableTargetSkillSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedAvailableTargetSkills = selectedValues?.ToList() ?? new List<string>();
    }

    private void OnSelectedTargetSkillSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = e.Value as string[];
        selectedSelectedTargetSkills = selectedValues?.ToList() ?? new List<string>();
    }

    // Filtering methods
    private void FilterAvailableSkills(ChangeEventArgs e)
    {
        skillsSearchTerm = e.Value?.ToString() ?? "";

        var selectedSkillNames = selectedSkillsForAssessment
            .Select(item => item.SkillName)
            .ToList();

        if (string.IsNullOrWhiteSpace(skillsSearchTerm))
        {
            filteredSkills = availableSkills
                .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
                .Select(skill => new SelectedSkill { SkillName = skill.SkillName, Assessment = 1 })
                .ToList();
        }
        else
        {
            filteredSkills = availableSkills
                .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
                .Where(skill => skill.SkillName.Contains(skillsSearchTerm, StringComparison.OrdinalIgnoreCase))
                .Select(skill => new SelectedSkill { SkillName = skill.SkillName, Assessment = 1 })
                .ToList();
        }

        StateHasChanged();
    }

    private void FilterAvailableTargetSkills(ChangeEventArgs e)
    {
        targetSkillsSearchTerm = e.Value?.ToString() ?? "";

        var selectedSkillNames = selectedTargetSkillsForAssessment
            .Select(item => item.SkillName)
            .ToList();

        if (string.IsNullOrWhiteSpace(targetSkillsSearchTerm))
        {
            filteredTargetSkills = availableTargetSkills
                .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
                .ToList();
        }
        else
        {
            filteredTargetSkills = availableTargetSkills
                .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
                .Where(skill => skill.SkillName.Contains(targetSkillsSearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        StateHasChanged();
    }

    // Move methods for skills
    private async Task MoveSelectedSkillToRight()
    {
        Console.WriteLine("=== MOVING SKILLS TO RIGHT ===");

        var itemsToAdd = new List<string>();

        // First, check if we should add a custom skill from search term
        if (!string.IsNullOrWhiteSpace(skillsSearchTerm))
        {
            // Check if there are actually any selected items in the listbox
            var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableSkills");

            // If no items are selected in the listbox, treat the search term as custom skill
            if (selectedOptions.Length == 0)
            {
                var customSkillName = skillsSearchTerm.Trim();

                // Check if this is not already in available skills (custom skill)
                var isCustomSkill = !availableSkills.Any(s =>
                    s.SkillName.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

                if (isCustomSkill)
                {
                    itemsToAdd.Add(customSkillName);
                    Console.WriteLine($"Will add custom skill: {customSkillName}");

                    // Clear search term after adding custom skill
                    skillsSearchTerm = "";
                }
            }
            else
            {
                // There are selected items, so process them normally
                itemsToAdd.AddRange(selectedOptions);
                Console.WriteLine($"Will add {selectedOptions.Length} selected skills");
            }
        }
        else
        {
            // No search term, process selected items normally
            itemsToAdd.AddRange(selectedAvailableSkills);
            Console.WriteLine($"Will add {selectedAvailableSkills.Count} selected skills from collection");
        }

        // Add all collected items
        foreach (var skillName in itemsToAdd)
        {
            AddSkillToSelected(skillName);
        }

        // Clear selections and update UI
        FilterAvailableSkillsBasedOnSelection();
        selectedAvailableSkills.Clear();
        StateHasChanged();
    }

    private void MoveSelectedSkillToLeft()
    {
        var itemsToRemove = new List<SelectedSkill>();

        foreach (var selectedValue in selectedSelectedSkills)
        {
            itemsToRemove.AddRange(selectedSkillsForAssessment
                .Where(item => item.SkillName == selectedValue));
        }

        foreach (var itemToRemove in itemsToRemove)
        {
            selectedSkillsForAssessment.Remove(itemToRemove);
        }

        FilterAvailableSkillsBasedOnSelection();
        selectedSelectedSkills.Clear();
        StateHasChanged();
    }

    private async Task MoveSelectedTargetSkillToRight()
    {
        Console.WriteLine("=== MOVING TARGET SKILLS TO RIGHT ===");

        var itemsToAdd = new List<string>();

        // First, check if we should add a custom skill from search term
        if (!string.IsNullOrWhiteSpace(targetSkillsSearchTerm))
        {
            // Check if there are actually any selected items in the listbox
            var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableTargetSkills");

            // If no items are selected in the listbox, treat the search term as custom skill
            if (selectedOptions.Length == 0)
            {
                var customSkillName = targetSkillsSearchTerm.Trim();

                // Check if this is not already in available target skills (custom skill)
                var isCustomSkill = !availableTargetSkills.Any(s =>
                    s.SkillName.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

                if (isCustomSkill)
                {
                    itemsToAdd.Add(customSkillName);
                    Console.WriteLine($"Will add custom target skill: {customSkillName}");

                    // Clear search term after adding custom skill
                    targetSkillsSearchTerm = "";
                }
            }
            else
            {
                // There are selected items, so process them normally
                itemsToAdd.AddRange(selectedOptions);
                Console.WriteLine($"Will add {selectedOptions.Length} selected target skills");
            }
        }
        else
        {
            // No search term, process selected items normally
            itemsToAdd.AddRange(selectedAvailableTargetSkills);
            Console.WriteLine($"Will add {selectedAvailableTargetSkills.Count} selected target skills from collection");
        }

        // Add all collected items
        foreach (var skillName in itemsToAdd)
        {
            AddTargetSkillToSelected(skillName);
        }

        // Clear selections and update UI
        FilterAvailableTargetSkillsBasedOnSelection();
        selectedAvailableTargetSkills.Clear();
        StateHasChanged();
    }

    private void MoveSelectedTargetSkillToLeft()
    {
        var itemsToRemove = new List<SelectedSkill>();

        foreach (var selectedValue in selectedSelectedTargetSkills)
        {
            itemsToRemove.AddRange(selectedTargetSkillsForAssessment
                .Where(item => item.SkillName == selectedValue));
        }

        foreach (var itemToRemove in itemsToRemove)
        {
            selectedTargetSkillsForAssessment.Remove(itemToRemove);
        }

        FilterAvailableTargetSkillsBasedOnSelection();
        selectedSelectedTargetSkills.Clear();
        StateHasChanged();
    }

    // Add methods
    private void AddSkillToSelected(string skillName)
    {
        var existingItem = selectedSkillsForAssessment
            .FirstOrDefault(item => item.SkillName == skillName);

        if (existingItem == null)
        {
            selectedSkillsForAssessment.Add(new SelectedSkill { SkillName = skillName, Assessment = 1 });
            Console.WriteLine($"Added skill: {skillName}");
        }
    }

    private void AddTargetSkillToSelected(string skillName)
    {
        var existingItem = selectedTargetSkillsForAssessment
            .FirstOrDefault(item => item.SkillName == skillName);

        if (existingItem == null)
        {
            selectedTargetSkillsForAssessment.Add(new SelectedSkill { SkillName = skillName, Assessment = 1 });
            Console.WriteLine($"Added target skill: {skillName}");
        }
    }

    // Filtering based on selection
    private void FilterAvailableSkillsBasedOnSelection()
    {
        var selectedSkillNames = selectedSkillsForAssessment
            .Select(item => item.SkillName)
            .ToList();

        filteredSkills = availableSkills
            .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
            .Select(skill => new SelectedSkill { SkillName = skill.SkillName, Assessment = 1 })
            .ToList();
    }

    private void FilterAvailableTargetSkillsBasedOnSelection()
    {
        var selectedSkillNames = selectedTargetSkillsForAssessment
            .Select(item => item.SkillName)
            .ToList();

        filteredTargetSkills = availableTargetSkills
            .Where(skill => !selectedSkillNames.Contains(skill.SkillName))
            .ToList();
    }

    private void ClearSearchSelection()
    {
        // Clear any selections in the available areas box
        ClearSelectElementSelection("availableAreas");
    }

    private void ClearTargetSearchSelection()
    {
        // Clear any selections in the available target areas boxMoveSelectedAreaToRight
        ClearSelectElementSelection("availableTargetAreas");
    }

    private async void ClearSelectElementSelection(string elementId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("clearSelection", elementId);
        }
        catch (Exception ex)
        {
            // Handle exception or ignore if JS interop fails
            Console.WriteLine($"Error clearing selection: {ex.Message}");
        }
    }

    private void ClearSkillSearchSelection()
    {
        ClearSelectElementSelection("availableSkills");
    }

    private void ClearTargetSkillSearchSelection()
    {
        ClearSelectElementSelection("availableTargetSkills");
    }

    private async Task AddCustomAreaFromSearch()
    {
        if (!string.IsNullOrWhiteSpace(areassearchTerm))
        {
            var customAreaName = areassearchTerm.Trim();

            // Check if this area already exists (either as available area or selected area)
            bool areaExistsInAvailable = availableAreas.Any(a =>
                a.AreaName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

            bool areaExistsInSelected = selectedAreasForAssessment.Any(item =>
                !item.IsSubField && item.FullName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

            if (!areaExistsInAvailable && !areaExistsInSelected)
            {
                // Add the custom area
                AddAreaToSelected(customAreaName, false);
                Console.WriteLine($"Added custom area: {customAreaName}");

                // Clear search term
                areassearchTerm = "";

                // Validate and update UI
                ValidateSelectedAreas();
                EnsureUniqueSelectedAreas();
                FilterAvailableAreasBasedOnSelection();
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Area '{customAreaName}' already exists - not adding");
                // Optional: Show user feedback here
            }
        }
    }

    private async Task AddCustomTargetAreaFromSearch()
    {
        if (!string.IsNullOrWhiteSpace(targetAreasSearchTerm))
        {
            var customAreaName = targetAreasSearchTerm.Trim();

            // Check if this is not already in available target areas (custom area)
            var isCustomArea = !availableTargetAreas.Any(a =>
                a.AreaName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

            if (isCustomArea)
            {
                // Add the custom target area
                AddTargetAreaToSelected(customAreaName, false);
                Console.WriteLine($"Added custom target area: {customAreaName}");

                // Clear search term
                targetAreasSearchTerm = "";

                // Validate and update UI
                EnsureUniqueTargetAreas();
                FilterAvailableTargetAreasBasedOnSelection();
                StateHasChanged();
            }
            else
            {
                // Area already exists in the list, you might want to show a message
                Console.WriteLine($"Target area '{customAreaName}' already exists in the list.");
            }
        }
    }

    private async Task AddCustomSkillFromSearch()
    {
        if (!string.IsNullOrWhiteSpace(skillsSearchTerm))
        {
            var customSkillName = skillsSearchTerm.Trim();

            // Check if this is not already in available skills (custom skill)
            var isCustomSkill = !availableSkills.Any(s =>
                s.SkillName.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

            if (isCustomSkill)
            {
                // Add the custom skill
                AddSkillToSelected(customSkillName);
                Console.WriteLine($"Added custom skill: {customSkillName}");

                // Clear search term
                skillsSearchTerm = "";

                // Update UI
                FilterAvailableSkillsBasedOnSelection();
                StateHasChanged();
            }
            else
            {
                // Skill already exists in the list, you might want to show a message
                Console.WriteLine($"Skill '{customSkillName}' already exists in the list.");
            }
        }
    }

    private async Task AddCustomTargetSkillFromSearch()
    {
        if (!string.IsNullOrWhiteSpace(targetSkillsSearchTerm))
        {
            var customSkillName = targetSkillsSearchTerm.Trim();

            // Check if this is not already in available target skills (custom skill)
            var isCustomSkill = !availableTargetSkills.Any(s =>
                s.SkillName.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

            if (isCustomSkill)
            {
                // Add the custom target skill
                AddTargetSkillToSelected(customSkillName);
                Console.WriteLine($"Added custom target skill: {customSkillName}");

                // Clear search term
                targetSkillsSearchTerm = "";

                // Update UI
                FilterAvailableTargetSkillsBasedOnSelection();
                StateHasChanged();
            }
            else
            {
                // Skill already exists in the list, you might want to show a message
                Console.WriteLine($"Target skill '{customSkillName}' already exists in the list.");
            }
        }
    }

    private async Task HandleSaveButtonClick()
    {
        if (isSubmitting) return;

        if (!termsAccepted)
        {
            // First click - show modal to accept terms
            await ShowUserAgreementModal(new MouseEventArgs());
        }
        else if (termsAccepted && canSubmit)
        {
            // Second click - actually submit the form
            await SubmitForm();
        }
    }

    private string ValidateTelephone(string telephone)
    {
        if (string.IsNullOrEmpty(telephone))
        {
            return "Το τηλέφωνο είναι υποχρεωτικό";
        }

        // Remove any whitespace
        telephone = telephone.Trim();

        // Check if it starts with + followed by digits, or just digits
        if (!Regex.IsMatch(telephone, @"^\+?[0-9]+$"))
        {
            return "Το τηλέφωνο μπορεί να περιέχει μόνο αριθμούς και το σύμβολο + στην αρχή";
        }

        // Remove the + for length calculation
        var numbersOnly = telephone.StartsWith('+') ? telephone.Substring(1) : telephone;

        // Check length (1-12 digits after the +)
        if (numbersOnly.Length < 1 || numbersOnly.Length > 12)
        {
            return "Ο αριθμός τηλεφώνου πρέπει να έχει από 1 έως 12 ψηφία";
        }

        return null; // No error
    }

}
