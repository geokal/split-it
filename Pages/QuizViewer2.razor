@page "/companyRegistration"

@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using QuizManager.Data
@using QuizManager.Models
@using System.IO
@using System.Reflection.Metadata
@using static System.Net.FileWebRequest
@using System.Security.Claims
@using System.Linq
@using System.Runtime.InteropServices
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.RegularExpressions
@using System.Text

@inject ILogger<QuizViewer> Logger
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager



<style>
    /* Message styles */
    .good-message {
        background-color: green;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
    }

    .error-message {
        background-color: palevioletred;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
    }

    /* Button styles - original sizes */
    .btn {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: #fff;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s;
    }

    .btn:hover {
        background-color: #0056b3;
    }

    .btn-submit {
        background-color: #28a745;
    }

    .btn-submit:hover {
        background-color: #218838;
    }

    .btn-submit1 {
        background-color: #0056b3;
    }

    .btn-upload {
        background-color: burlywood;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }

    .btn-upload:hover {
        background-color: #45a049;
    }

    /* Form structure - ultra-wide */
    .form-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 20px auto;
        width: 98%;
        max-width: 2400px; /* Extreme width */
        padding: 0 10px;
        box-sizing: border-box;
    }

	.grouped-section {
		background-color: #ffffff; /* Clean white background like Bootstrap cards */
		padding: 24px; /* Comfortable spacing inside */
		border-radius: 0.5rem; /* Subtle, smooth rounded corners */
		border: 1px solid #2d3748; /* Light gray border consistent with Bootstrap */
		box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Soft shadow for depth */
		width: 100%;
		min-width: 600px; /* Wide minimum, adjust as needed */
		box-sizing: border-box;
		transition: all 0.2s ease-in-out; /* Smooth hover/interaction transitions */
	}

		/* Optional: subtle hover effect */
		.grouped-section:hover {
			box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1); /* Slightly more prominent shadow */
			transform: translateY(-2px); /* Gentle lift effect */
		}

    /* Form groups - original sizing */
    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        width: 100%;
    }

    /* Typography */
    body {
        background-color: #f0f0f0;
        color: #000000;
    }

    h3 {
        font-size: 24px;
        color: #FF5733;
    }

    h4 {
        font-size: 24px;
        color: darkblue;
    }

    /* Input styles */
    .readonly-input {
        background-color: #888888;
        color: navajowhite;
        font-weight: bold;
        width: 100%;
        max-width: 550px; /* Wider inputs */
    }

    .select-with-arrow {
        position: relative;
        width: 100%;
        max-width: 550px; /* Matches other inputs */
    }

    .select-with-arrow select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: white;
        background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 8l3-3 3 3h0" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px 20px;
    }

    /* Tooltip styles */
    .tooltip-container {
        position: relative;
    }

    .tooltip-text {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 10px;
        z-index: 1;
        width: 200px;
        top: calc(100% + 5px);
        left: 0;
    }

    .tooltip-container.show-tooltip .tooltip-text {
        display: block;
    }

    /* Button containers */
    .button-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
    }

    .button-container button {
        padding: 10px 20px;
        font-size: 16px;
        color: white;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-bottom: 5px;
    }

    .button-container button:hover {
        background-color: #0056b3;
    }

    /* Form check elements */
    .form-check .form-check-input:disabled ~ .form-check-label {
        color: #000;
        opacity: 1;
    }

    /* Animations */
    @@keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0; }
        100% { opacity: 1; }
    }

    .blinking {
        animation: blink 1s infinite;
        color: black;
        font-size: 2em;
        text-align: left;
    }

    /* Input with hint */
    .input-with-hint {
        position: relative;
        width: 100%;
        max-width: 550px;
    }

    .input-with-hint .hint {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #495057;
    }

    .input-with-hint input {
        padding-right: 30px;
        width: 100%;
    }

    /* Telephone input group */
    .input-group-textfortelephone {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        line-height: 1.5;
        display: flex;
        align-items: center;
    }

    /* Validation animations */
	.shake {
		animation: shake 0.5s;
		border: 2px solid red !important;
	}

	@@keyframes shake {
		0% {
			transform: translateX(0);
		}

		20% {
			transform: translateX(-10px);
		}

		40% {
			transform: translateX(10px);
		}

		60% {
			transform: translateX(-10px);
		}

		80% {
			transform: translateX(10px);
		}

		100% {
			transform: translateX(0);
		}
	}

	.shake-input {
		background-color: #fff0f0 !important;
	}

	.error-message {
		color: red;
		font-weight: bold;
		padding: 10px;
		background-color: #fff0f0;
		border: 1px solid red;
		border-radius: 5px;
		margin: 10px 0;
	}

    .is-invalid {
        border: 1px solid red;
    }

    /* Responsive behavior */
    @@media (min-width: 1280px) {
        .form-container {
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        .grouped-section {
            flex: 1 1 calc(50% - 20px);
            min-width: 600px;
        }
    }

    @@media (min-width: 1920px) {
        .form-container {
            flex-wrap: nowrap;
        }
        
        .grouped-section {
            flex: 1 1 calc(33.33% - 20px);
            min-width: 600px;
        }
    }

    @@media (max-width: 1279px) {
        .form-container {
            flex-direction: column;
        }
        .grouped-section {
            width: 100%;
            min-width: 100%;
        }
    }

	.multiselect-container {
		position: relative;
	}

	.selected-items-display {
		border: 1px solid #ccc;
		border-radius: 4px;
		padding: 6px 12px;
		min-height: 38px;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: space-between;
		background-color: white;
	}

		.selected-items-display .placeholder {
			color: #6c757d;
		}

	.selected-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 4px;
	}

	.selected-tag {
		background-color: #e9ecef;
		padding: 2px 6px;
		border-radius: 3px;
		display: flex;
		align-items: center;
		gap: 4px;
	}

	.remove-tag {
		cursor: pointer;
		font-weight: bold;
		color: #6c757d;
	}

		.remove-tag:hover {
			color: #dc3545;
		}

	.dropdown-arrow {
		color: #6c757d;
	}

	.multiselect-dropdown {
		position: absolute;
		top: 100%;
		left: 0;
		right: 0;
		background: white;
		border: 1px solid #ccc;
		border-radius: 4px;
		z-index: 1000;
		max-height: 300px;
		overflow-y: auto;
		box-shadow: 0 2px 8px rgba(0,0,0,0.15);
	}

	.multiselect-option {
		padding: 8px 12px;
		cursor: pointer;
		display: flex;
		align-items: center;
		gap: 8px;
	}

		.multiselect-option:hover {
			background-color: #f8f9fa;
		}

	.multiselect-actions {
		padding: 8px;
		border-top: 1px solid #eee;
		display: flex;
		gap: 8px;
	}

	.options-container {
		max-height: 200px;
		overflow-y: auto;
	}

	.search-container {
		border-bottom: 1px solid #eee;
	}

	.step-title {
		font-weight: 600;
		font-size: 1.25rem;
		color: #2d3748; /* heading text color */
		display: flex;
		align-items: center; /* vertically center number and text */
		gap: 10px; /* space between circle and text */
	}

	.step-number {
		display: inline-flex;
		justify-content: center;
		align-items: center;
		width: 30px;
		height: 30px;
		border-radius: 50%; /* makes it a perfect circle */
		background-color: #2d3748; /* Bootstrap blue */
		color: #ffffff; /* white number */
		font-weight: 600;
		font-size: 1rem;
	}
</style>

<div class="gray-background">
@if (!hasReadAsCompanyPermission)
{
	@*
	<div class="error-message">
		<p><strong>You are Not a CompanyModel User</strong></p>
		<p><strong>Please Login as CompanyModel User!</strong></p>
	</div>
	*@
}
else
{
	<h3 style="color: #000000;"><strong>Πληροφορίες Επιχείρησης</strong></h3>
		<EditForm Model="@newCompany" OnValidSubmit="SubmitForm">
			<div class="form-container">
				<div class="grouped-section">
					<h4 class="step-title">
						<span class="step-number">1</span> Στοιχεία Φορέα
					</h4>


					<div class="form-group">
						<label><strong>Email Επικοινωνίας Εταιρίας</strong></label>
						<InputText @bind-Value="newCompany.CompanyEmail" readonly class="readonly-input" />
					</div>

					<div class="form-group">
						<label><strong>Μοναδικό ID Εταιρείας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-key"></i></span>
							<InputText @bind-Value="newCompany.Company.UniqueID"
									   readonly
									   class="readonly-input form-control"
									   style="color: blue;"
									   placeholder="Δημιουργείται αυτόματα μετά την πρώτη σας Εγγραφή" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Λογότυπο Εταιρίας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-image"></i></span>
							<InputFile OnChange="HandleFileChange" accept="image/jpeg, image/png" class="form-control" />
						</div>
						<small class="form-text text-muted">Επιτρεπόμενο Όριο Αρχείου (1MB)</small>
						@if (!string.IsNullOrEmpty(FileErrorMessage))
						{
							<div class="text-danger mt-2">@FileErrorMessage</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Όνομα Εταιρίας(ENG)</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyName"
									   class="@($"{companyNameInputClass} form-control")" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Όνομα Εταιρίας(GR)</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyNameENG"
									   class="@($"{companyNameENGInputClass} form-control")" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Όνομα Εταιρίας(Short)</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyShortName"
									   class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Τύπος Εταιρίας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<select @bind="newCompany.CompanyType" class="@($"{companyTypeInputClass} select-with-arrow")">
							<option value="">-- Είδος Φορέα --</option>
							@foreach (var foreas in ForeasType)
							{
								<option value="@foreas">@foreas</option>
							}
						</select>
					</div>

					<div class="form-group">
						<label><strong>Δραστηριότητα Εταιρίας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="multiselect-container @companyActivityInputClass">
							<div class="selected-items-display" @onclick="ToggleActivityDropdown">
								@if (selectedActivities.Count == 0)
								{
									<span class>-- Πεδίο Δραστηριότητας --</span>
								}
								else
								{
									<div class="selected-tags">
										@foreach (var activity in selectedActivities)
										{
											<span class="selected-tag">
												@activity
												<button type="button" class="remove-tag" @onclick="@(() => RemoveActivity(activity))" @onclick:stopPropagation>×</button>
											</span>
										}
									</div>
								}
								<span class="dropdown-arrow">▼</span>
							</div>

							@if (showActivityDropdown)
							{
								<div class="multiselect-dropdown">
									<div class="search-container" style="padding: 5px;">
										<input type="text"
											   class="form-control"
											   placeholder="Αναζήτηση..."
											   value="@activitySearchTerm"
											   @oninput="HandleSearchInput" />
									</div>
									<div class="options-container">
										@if (filteredActivities.Count == 0 && !string.IsNullOrEmpty(activitySearchTerm))
										{
											<div class="no-results">Δεν βρέθηκαν αποτελέσματα</div>
										}
										else
										{
											@foreach (var activity in filteredActivities)
											{
												<div class="multiselect-option" @onclick="@(() => ToggleActivity(activity))">
													<input type="checkbox" checked="@selectedActivities.Contains(activity)" />
													<span>@activity</span>
												</div>
											}
										}
									</div>
									<div class="multiselect-actions">
										<button type="button" class="btn btn-sm btn-secondary" @onclick="SelectAllActivities" @onclick:stopPropagation>
											Επιλογή όλων
										</button>
										<button type="button" class="btn btn-sm btn-secondary" @onclick="ClearAllActivities" @onclick:stopPropagation>
											Αποεπιλογή όλων
										</button>
									</div>
								</div>
							}
						</div>
					</div>

					<div class="form-group">
						<label><strong>Α.Φ.Μ</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-id-card"></i></span>
							<input type="text" @bind="newCompany.CompanyTaxID"
								   @oninput="HandleCompanyTaxIDNumberInput"
								   class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Δ.Ο.Υ</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-university"></i></span>
							<InputText @bind-Value="newCompany.CompanyTaxOffice"
									   class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Τηλέφωνο</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-phone"></i></span>
							<InputText class="@($"{companyTelephoneInputClass} form-control")"
									   @bind-Value="newCompany.CompanyTelephone"
									   @oninput="OnCompanyTelephoneInput"
									   placeholder="+30 69********"
									   maxlength="13" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Ιστοσελίδα</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-link"></i></span>
							<InputText @bind-Value="newCompany.CompanyWebsite"
									   class="@($"{companyWebsiteInputClass} form-control")" placeholder="https://www.mysite.com/" />
						</div>
						@if (!string.IsNullOrEmpty(newCompany.CompanyWebsite) && !IsValidWebsiteAtCompanyRegistration(newCompany.CompanyWebsite))
						{
							<div class="text-danger">Παρακαλώ εισάγετε μια έγκυρη διεύθυνση ιστότοπου.</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Βίντεο Παρουσίασης Εταιρείας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-link"></i></span>
							<InputText @bind-Value="newCompany.CompanyPresentationEmbeddedVideo"
									   class="form-control"
									   placeholder="https://www.youtube.com/****" />
						</div>
						@if (!string.IsNullOrEmpty(newCompany.CompanyPresentationEmbeddedVideo))
						{
							<div class="embed-responsive embed-responsive-16by9 mt-2">
								<iframe class="embed-responsive-item"
										src="@GetYoutubeEmbedUrl(newCompany.CompanyPresentationEmbeddedVideo)"
										allowfullscreen></iframe>
							</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Ιστοσελίδα Ανακοινώσεων</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-link"></i></span>
							<InputText @bind-Value="newCompany.CompanyWebsiteAnnouncements" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Ιστοσελίδα Θέσεων Εργασίας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-link"></i></span>
							<InputText @bind-Value="newCompany.CompanyWebsiteJobs" class="form-control" />
						</div>
					</div>

					<div class="form-group tooltip-container">
						<label><strong>Κωδικός ATLAS</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-key"></i></span>
							<InputText @bind-Value="newCompany.AtlasID" @onclick="ShowTooltip" class="form-control" />
						</div>
						<div id="tooltip-text" class="tooltip-text">
							<a href="https://www.dind.uoa.gr/fileadmin/depts/dind.uoa.gr/www/uploads/Plirofories_praktikis_askisis_gia_to_tmima_Technologion_PSifiakis_Biomichanias_ver2.pdf" target="_blank">Οδηγός Εγγραφής στο Σύστημα ATLAS</a>
						</div>
					</div>

					<div class="form-group">
						<label><strong>Κωδικός ΣΒΣΕ</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-key"></i></span>
							<InputText @bind-Value="newCompany.SvseID" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Ημερομηνία Εγγραφής ΣΒΣΕ</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
							<InputDate @bind-Value="newCompany.SvseDate" class="form-control" />
						</div>
					</div>

					<br />
					<h4 class="step-title">
						<span class="step-number">2</span> Στοιχεία Διεύθυνσης Παραρτήματος
					</h4>


					<div class="form-group">
						<label><strong>Χώρα</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<select @bind="newCompany.CompanyCountry" class="@($"{companyCountryInputClass} select-with-arrow")">
							<option value="" disabled selected> - Επιλέξτε Χώρα - </option>
							@foreach (var country in ExportCountries)
							{
								<option value="@country">@country</option>
							}
						</select>
					</div>

					<div class="form-group">
						<label><strong>Διεύθυνση</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<InputText id="autocomplete" @bind-Value="newCompany.CompanyLocation" class="@($"{companyLocationInputClass} form-control")" />
					</div>

					<div class="form-group">
						<label><strong>Ταχυδρομικός Κώδικας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-home"></i></span>
							<input type="text"
								   @bind="newCompany.CompanyPC"
								   @oninput="HandleCompanyPCNumberInput"
								   maxlength="5"
								   pattern="\d*"
								   class="@($"{companyPCInputClass} form-control")"
								   placeholder="xxxxx" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Περιφέρεια</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<select @bind="newCompany.CompanyRegions" class="@($"{companyRegionsInputClass} select-with-arrow")">
							<option value="">-- Επιλέξτε Περιφέρεια --</option>
							@foreach (var region in Regions)
							{
								<option value="@region">@region</option>
							}
						</select>
					</div>

					<div class="form-group">
						<label><strong>Έδρα</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<select @bind="newCompany.CompanyTown" class="@($"{companyTownInputClass} select-with-arrow")">
							<option value="">-- Επιλέξτε Πόλη --</option>
							@if (!string.IsNullOrEmpty(newCompany.CompanyRegions) && RegionToTownsMap.ContainsKey(newCompany.CompanyRegions))
							{
								foreach (var town in RegionToTownsMap[newCompany.CompanyRegions])
								{
									<option value="@town">@town</option>
								}
							}
						</select>
					</div>
					<br />
					<br />
				</div>

				<div class="grouped-section">
					<h4 class="step-title">
						<span class="step-number">3</span> Τομέας Δραστηριότητας
					</h4>

					<div class="form-group">
						<label for="companyDescription"><strong>Περιγραφή Εταιρίας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<InputTextAreaWithMaxLength @bind-Value="newCompany.CompanyDescription"
													CssClass="@($"{companyDescriptionInputClass} form-control")"
													Id="companyDescription" />
					</div>

					<div class="form-group">
						<label>
							<strong>Περιοχές Δραστηριότητας</strong>
							<span style="color: red; font-weight: bold;"> *</span>
							<span class="ms-1" data-bs-toggle="tooltip"
								  data-bs-placement="top"
								  data-bs-html="true"
								  title="Προσθήκη Προσαρμοσμένης Περιοχής: Πληκτρολογήστε το Όνομα της Περιοχής που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
								<i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
							</span>
						</label>

						<!-- Search field with icon and custom area button -->
						<div class="d-flex align-items-center mb-3">
							<div class="input-group flex-grow-1 mr-2">
								<input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Περιοχής"
									   @bind="areassearchTerm" @oninput="FilterAvailableAreas"
									   @onfocus="ClearSearchSelection" />
								<div class="input-group-append">
									<span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
								</div>
							</div>
							<button type="button" class="btn btn-outline-success align-self-start"
									@onclick="async () => await AddCustomAreaFromSearch()"
									title="Προσθήκη προσαρμοσμένης περιοχής"
									style="white-space: nowrap; height: 45px; margin-left:10px;">
								<i class="fas fa-plus-circle"></i> Προσθήκη
							</button>
						</div>

						<div class="d-flex align-items-center">
							<!-- Available areas box -->
							<div style="width: 45%;">
								<div class="text-center mb-1">
									<i class="fas fa-list-alt" style="color: #4682b4; font-size: 1.2rem;"></i>
									<span class="ml-2">Διαθέσιμες Περιοχές</span>
								</div>
								<select id="availableAreas" class="form-control" size="10" multiple
										@onchange="OnAvailableAreaSelectionChanged" style="height:200px;">
									@foreach (var area in filteredAreas)
									{
										<option @key="@($"area-{area.AreaName}")" value="@($"area:{area.AreaName}")"
												@onclick="() => ToggleExpansion(area.AreaName)">
											@area.AreaName
										</option>
										@if (expandedAreas.Contains(area.AreaName))
										{
											var subFields = area.AreaSubFields?.Split(',');
											if (subFields != null)
											{
												foreach (var subField in subFields)
												{
													<option @key="@($"subfield-{area.AreaName}-{subField}")"
															value="@($"subfield:{subField}")"
															style="padding-left: 20px;">• @subField</option>
												}
											}
										}
									}
								</select>
							</div>
							 
							<!-- Move buttons -->
							<div class="d-flex flex-column mx-1">
								<button type="button" class="btn btn-outline-primary mb-1 px-2" @onclick="async () => await MoveSelectedAreaToRight()">
									<i class="fas fa-arrow-right"></i>
								</button>
								<button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedAreaToLeft">
									<i class="fas fa-arrow-left"></i>
								</button>
							</div>

							<!-- Selected areas box -->
							<div style="width: 45%;">
								<div class="text-center mb-1">
									<i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
									<span class="ml-2">Επιλεγμένες Περιοχές</span>
								</div>
								<select id="selectedAreas" class="form-control @companyAreasInputClass"
										size="10" multiple @onchange="OnSelectedAreaSelectionChanged" style="height: 200px;">
									@foreach (var selectedItem in selectedAreasForCompany)
									{
										@if (selectedItem.IsSubField)
										{
											<option @key="@($"selected-{selectedItem.UniqueId}")"
													value="@($"subfield:{selectedItem.FullName}")">
												@selectedItem.DisplayName
											</option>
										}
										else
										{
											var isCustomArea = IsCustomArea(selectedItem.FullName);
											<option @key="@($"selected-{selectedItem.UniqueId}")"
													value="@($"area:{selectedItem.FullName}")"
													style="@(isCustomArea ? "color: blue; font-style: italic;" : "")">
												@selectedItem.DisplayName <span style="color: #666; font-size: 0.9em;">@(isCustomArea ? "(Προσαρμοσμένη)" : "")</span>
											</option>
										}
									}
								</select>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label>
							<strong>Απαιτούμενες Ικανότητες</strong>
							<span class="ms-1" data-bs-toggle="tooltip"
								  data-bs-placement="top"
								  data-bs-html="true"
								  title="Προσθήκη Προσαρμοσμένης Ικανότητας: Πληκτρολογήστε το Όνομα της Ικανότητας που θέλετε να προσθέσετε και πατήστε '+ Προσθήκη' για να την προσθέσετε στη λίστα σας">
								<i class="fas fa-info-circle" style="color: #4682b4; cursor: help;"></i>
							</span>
						</label>

						<!-- Search field with icon and custom skill button -->
						<div class="d-flex align-items-center mb-3">
							<div class="input-group flex-grow-1 mr-2">
								<input type="text" class="form-control" placeholder="Αναζήτηση/Προσθήκη Ικανότητας"
									   @bind="skillSearchTerm" @oninput="FilterAvailableSkills"
									   @onfocus="ClearSkillSearchSelection" />
								<div class="input-group-append">
									<span class="input-group-text"><i class="fas fa-search" style="color: #4682b4;"></i></span>
								</div>
							</div>
							<button type="button" class="btn btn-outline-success align-self-start"
									@onclick="async () => await AddCustomSkillFromSearch()"
									title="Προσθήκη προσαρμοσμένης ικανότητας"
									style="white-space: nowrap; height: 45px; margin-left: 10px;">
								<i class="fas fa-plus-circle"></i> Προσθήκη
							</button>
						</div>

						<div class="d-flex align-items-center">
							<!-- Available skills box -->
							<div style="width: 45%;">
								<div class="text-center mb-1">
									<i class="fas fa-list-alt" style="color: #4682b4; font-size: 1.2rem;"></i>
									<span class="ml-2">Διαθέσιμες Ικανότητες</span>
								</div>
								<select id="availableSkills" class="form-control" size="10" multiple
										@onchange="OnAvailableSkillSelectionChanged" style="height: 200px;">
									@foreach (var skill in filteredSkills)
									{
										<option @key="@($"skill-{skill}")" value="@skill">
											@skill
										</option>
									}
								</select>
							</div>

							<!-- Move buttons -->
							<div class="d-flex flex-column mx-1">
								<button type="button" class="btn btn-outline-primary mb-1 px-2" @onclick="async () => await MoveSelectedSkillToRight()">
									<i class="fas fa-arrow-right"></i>
								</button>
								<button type="button" class="btn btn-outline-primary px-2" @onclick="MoveSelectedSkillToLeft">
									<i class="fas fa-arrow-left"></i>
								</button>
							</div>

							<!-- Selected skills box -->
							<div style="width: 45%;">
								<div class="text-center mb-1">
									<i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem;"></i>
									<span class="ml-2">Επιλεγμένες Ικανότητες</span>
								</div>
								<select id="selectedSkills" class="form-control" size="10" multiple
										@onchange="OnSelectedSkillSelectionChanged" style="height: 200px;">
									@foreach (var skillItem in selectedSkillsForCompany)
									{
										var isCustomSkill = IsCustomSkill(skillItem);
										<option @key="@($"selected-{skillItem}")" value="@skillItem"
												style="@(isCustomSkill ? "color: blue; font-style: italic;" : "")">
											@skillItem <span style="color: #666; font-size: 0.9em;">@(isCustomSkill ? "(Προσαρμοσμένη)" : "")</span>
										</option>
									}
								</select>
							</div>
						</div>
					</div>

					<br />
					<br />
					<h4 class="step-title">
						<span class="step-number">4</span> Στοιχεία Υπευθύνων Διαχείρισης Πλατφόρμας
					</h4>

					<div class="form-group">
						<label><strong>Όνομα CEO</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyCEOName" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Επώνυμο CEO</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyCEOSurname" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Όνομα Υπευθύνου HR</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyHRName" class="@($"{companyHRNameInputClass} form-control")" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Επώνυμο Υπευθύνου HR</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyHRSurname" class="@($"{companyHRSurnameInputClass} form-control")" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Email Επικοινωνίας Υπευθύνου HR</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-envelope"></i></span>
							<InputText @bind-Value="newCompany.CompanyHREmail"
									   @onblur="ValidateEmailHR"
									   class="@($"{companyHREmailInputClass} form-control")" />
						</div>
						@if (!string.IsNullOrEmpty(emailValidationMessagehr))
						{
							<div class="text-danger">@emailValidationMessagehr</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Τηλέφωνο Υπευθύνου HR</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-phone"></i></span>
							<InputText class="@($"{companyHRTelephoneInputClass} form-control")"
									   @bind-Value="newCompany.CompanyHRTelephone"
									   @oninput="OnCompanyHRTelephoneInput"
									   placeholder="+30 69********"
									   maxlength="13" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Επικεφαλής Τμήματος Έρευνας και Ανάπτυξης</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span>
							<InputText @bind-Value="newCompany.RnD_HeadName" class="form-control" 
									   placeholder="Πλήρες Ονοματεπώνυμο"/>
						</div>
					</div>

					<div class="form-group">
						<label><strong>Υπεύθυνος Επικοινωνίας Τμήματος Έρευνας και Ανάπτυξης</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span>
							<InputText @bind-Value="newCompany.RnD_ContactPersonFullName" class="form-control"
										placeholder="Πλήρες Ονοματεπώνυμο" />
						</div>
					</div>


					<div class="form-group">
						<label><strong>Email Επικοινωνίας Υπευθύνου Τμήματος Έρευνας και Ανάπτυξης</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-envelope"></i></span>
							<InputText @bind-Value="newCompany.RnD_ContactPersonEmail"
									   placeholder="address@domain.gr"
									   @onblur="ValidateEmailRnD"
									   class="form-control" />
						</div>
						@if (!string.IsNullOrEmpty(emailValidationMessageRnD))
						{
							<div class="text-danger">@emailValidationMessageRnD</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Επώνυμο Διαχειριστή Πλατφόρμας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
							<InputText @bind-Value="newCompany.CompanyAdminSurname" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Email Επικοινωνίας Διαχειριστή Πλατφόρμας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-envelope"></i></span>
							<InputText @bind-Value="newCompany.CompanyAdminEmail"
								       placeholder="address@domain.gr"
									   @onblur="ValidateEmailAdmin"
									   class="form-control" />
						</div>
						@if (!string.IsNullOrEmpty(emailValidationMessageadmin))
						{
							<div class="text-danger">@emailValidationMessageadmin</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Τηλέφωνο Επικοινωνίας Διαχειριστή Πλατφόρμας</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-phone"></i></span>
							<InputText class="form-control"
									   @bind-Value="newCompany.CompanyAdminTelephone"
									   placeholder="69********"
									   maxlength="10" />
						</div>
					</div>
				</div>

				<div class="grouped-section">
					<h4 class="step-title">
						<span class="step-number">5</span> Στοιχεία Εταιρικής Δραστηριότητας
					</h4>

					<div class="form-group">
						<label><strong>Αριθμός Εργαζομένων</strong></label>
						<div class="input-group">
							<span class="input-group-text"><i class="fas fa-users"></i></span>
							<InputNumber @bind-Value="newCompany.CompanyEmployees" class="form-control" />
						</div>
					</div>

					<div class="form-group">
						<label><strong>Τελευταία Ενημέρωση Αριθμού Εργαζομένων</strong></label>
						<InputDate @bind-Value="newCompany.CompanEmployeesLastUpdate" />
					</div>

					<div class="form-group">
						<label><strong>Κύκλος Εργασιών</strong></label>
						<div class="input-with-hint">
							<InputNumber @bind-Value="newCompany.CompanyTurnover" class="form-control" />
							<div class="hint">€</div>
						</div>
					</div>

					<br />
					<div class="form-group">
						<label @onclick="ToggleCountriesVisibility" style="cursor: pointer;" title="Εμφάνισε">
							<strong>Χώρες Εξαγωγών</strong><span style="color: lightskyblue; font-style: italic;">(Άνοιγμα/Κλείσιμο)</span>
						</label>
						<br />
						@if (showCountries)
						{
							<div class="table-responsive">
								<table class="table table-bordered">
									<tbody>
										@for (var rowIndex = 0; rowIndex < Math.Ceiling((double)ExportCountries.Count / 3); rowIndex++)
										{
											<tr>
												@for (var colIndex = 0; colIndex < 3; colIndex++)
												{
													var index = rowIndex * 3 + colIndex;
													if (index < ExportCountries.Count)
													{
														var country = ExportCountries[index];
														<td style="padding: 5px; border: none; width: 33%;">
															<div class="custom-control custom-checkbox d-flex align-items-center">
																<input type="checkbox" class="custom-control-input" id="@($"country_{country.Replace(" ", "_")}")"
																	   checked="@countrySelections[country]" @onchange="() => ToggleCountrySelection(country)" style="width: 14px; height: 14px; margin-right: 5px;" />
																<label class="custom-control-label small mb-0" for="@($"country_{country.Replace(" ", "_")}")" style="font-size: 12px;">@country</label>
															</div>
														</td>
													}
													else
													{
														<td style="padding: 5px; border: none;"></td>
													}
												}
											</tr>
										}
									</tbody>
								</table>
							</div>
						}
					</div>

					<div class="form-group">
						<label><strong>Αριθμός Χωρών Εξαγωγών</strong></label>
						<InputNumber @bind-Value="newCompany.CompanyExportCountriesNumber" />
					</div>

					<div class="form-group">
						<label><strong>Τελευταία Ενημέρωση Αριθμού Χωρών Εξαγωγών</strong></label>
						<InputDate @bind-Value="newCompany.CompanyExportCountriesLastUpdate" />
					</div>

					<div>
						<label><strong>Εμφάνιση Δραστηριότητας Εταιρίας</strong><span style="color: red; font-weight: bold;"> *</span></label>
						<InputRadioGroup @bind-Value="newCompany.CompanyVisibleActivity">
							<InputRadio Value="true" /> Yes
							<InputRadio Value="false" /> No
						</InputRadioGroup>
					</div>
				</div>
			</div>
			<br />
			<!-- Add error message display here -->
			@if (!string.IsNullOrEmpty(errorMessage))
			{
				<div class="alert alert-danger" role="alert">
					<strong>Σφάλμα:</strong> @errorMessage
				</div>
			}
			@*EDW KANW TO SUBMIT TA STOIXEIA TOY COMPANY*@
			@if (!isRegistered)
			{
				<div class="form-check mb-4">
					<CustomCheckbox @bind-Value="agreeTerms" @ref="customCheckbox" />
					<label class="form-check-label" for="customCheckboxId">
						Για Εγγραφή θα πρέπει να Αποδεχτείτε τους όρους συμμετοχής στην Πλατφόρμα.
					</label>
				</div>
			}
			@if (!isRegistered)
			{
				<button type="button" class="btn btn-lg shadow px-4"
						style="background-color: #2d3748; border-color: #2d3748; color: white;"
						@onclick="HandleSaveButtonClick" 
						disabled="@(termsAccepted && !canSubmit)">
					<i class="fas fa-save me-2"></i>
					@GetSaveButtonText()
				</button>

				@if (termsAccepted)
				{
					<div class="mt-2">
						<small class="text-success">
							<i class="fas fa-check-circle me-1"></i>Έχετε αποδεχτεί τους όρους συμμετοχής. Κάντε "Ολοκλήρωση Εγγραφής" για Αποθήκευση.
						</small>
					</div>
				}
			}
			else
			{
				<button type="button" class="btn btn-lg shadow px-4"
						style="background-color: #2d3748; border-color: #2d3748; color: white;"
						@onclick="UpdateCompanyRegistration">
					<i class="fas fa-sync-alt me-2"></i>Ανανέωση Στοιχείων
				</button>

				<div class="mt-2">
					<small class="text-muted">
						<i class="fas fa-check-circle me-1"></i>Οι όροι χρήσης έχουν ήδη γίνει αποδεκτοί
					</small>
				</div>
				<br />
			}

			<UserAgreementModal OnAgree="AgreeToTerms" OnDecline="DeclineTerms" />

			<br />
			<br />
			@if (updated)
			{
				<div class="mt-3">
					<div class="alert alert-success alert-dismissible fade show" role="alert">
						<strong><i class="fas fa-check-circle me-2"></i>Η Ανανέωση των στοιχείων σας πραγματοποιήθηκε με Επιτυχία! Περιμένετε για Ανανέωση Σελίδας.... </strong>
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>
				</div>
			}
			@if (saved)
			{
				<div class="mt-3">
					<div class="alert alert-success alert-dismissible fade show" role="alert">
						<strong><i class="fas fa-check-circle me-2"></i>Η Εγγραφή σας Ολοκληρώθηκε Με Επιτυχία!</strong>
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>
				</div>
			}
			<br />
			<br />
		</EditForm>
}
</div>

<!-- Loading Modal for CompanyModel Form Submission -->
@if (showLoadingModalWhenSubmitCompanyForm)
{
    <div class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p>Αποθήκευση στοιχείων εταιρείας...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: @loadingProgressWhenSubmitCompanyForm%"></div>
            </div>
        </div>
    </div>
}

<!-- Loading Modal for CompanyModel Registration Update -->
@if (showLoadingModalWhenUpdateCompanyRegistration)
{
    <div class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p>Ενημέρωση στοιχείων εταιρείας...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: @loadingProgressWhenUpdateCompanyRegistration%"></div>
            </div>
        </div>
    </div>
}


@inject IJSRuntime JS
@code {

	private bool termsAccepted = false; 
	private bool canSubmit = false; 
	private bool isSubmitting = false;

	private async Task HandleSaveButtonClick()
	{
		if (isSubmitting) return;

		if (!termsAccepted)
		{
			// First click - show modal to accept terms
			await ShowUserAgreementModal(new MouseEventArgs());
		}
		else if (termsAccepted && canSubmit)
		{
			// Second click - actually submit the form
			await SubmitForm();
		}
	}

	private List<string> selectedAvailableItems = new List<string>();
	private List<string> selectedSelectedItems = new List<string>();
	private List<AreaItem> selectedAreasForCompany = new List<AreaItem>();
	public class AreaItem : IEquatable<AreaItem>
	{
		public string FullName { get; set; } = "";
		public string DisplayName { get; set; } = "";
		public bool IsSubField { get; set; }
		public string ParentArea { get; set; } = "";
		// No Assessment property for company

		public string UniqueId => IsSubField ?
			$"SUBFIELD_{ParentArea}_{FullName}" :
			$"AREA_{FullName}";

		public override bool Equals(object obj)
		{
			return Equals(obj as AreaItem);
		}

		public bool Equals(AreaItem other)
		{
			return other != null && UniqueId == other.UniqueId;
		}

		public override int GetHashCode()
		{
			return UniqueId.GetHashCode();
		}
	}

	private List<string> selectedSkillsForCompany = new List<string>();
	private List<string> selectedAvailableSkillItems = new List<string>();
	private List<string> selectedSelectedSkillItems = new List<string>();

	private bool showActivityDropdown = false;
	private string activitySearchTerm = string.Empty;
	private List<string> selectedActivities = new List<string>();
	private List<string> filteredActivities = new List<string>();

	private bool showStudentsWithProgrammingSkills = false;
	private bool showStudentsWithMachineLearningSkills = false;
	private bool showStudentsWithDatabaseSkills = false;
	private bool showStudentsWithNetworkAndTelecomSkills = false;
	private List<StudentModel> filteredStudents = new List<StudentModel>();
	private string companyName = "Anonymous User";
	public CompanyModel newCompany = new Company
	{
		CompanEmployeesLastUpdate = DateTime.Today.Date,
		CompanyTurnoverLastUpdate = DateTime.Today.Date,
		CompanyExportCountriesNumberLastUpdate = DateTime.Today.Date,
		CompanyExportCountriesLastUpdate = DateTime.Today.Date
	};

	public bool saved = false;
	public bool error = false;
	public bool showstudentSearch = false;
	private bool hasReadAsCompanyPermission = false;

	private bool showResultsClicked = false;

	private string keywordSearch;
	private List<StudentModel> filteredStudentsByKeyword = new List<StudentModel>();
	private bool showKeywordSearch = false;
	private IBrowserFile file;
	private CompanyModel imageData = new CompanyModel(); // Initialize companyData


	// CompanyModel validation variables
	private string errorMessage = "";
	private string? companyTaxIDNumberInput;
	private string companyTelephoneInputClass = "";
	private string? companyPCNumberInput;
	private string companyNameInputClass = "";
	private string companyNameENGInputClass = "";
	private string companyTypeInputClass = "";
	private string companyActivityInputClass = "";
	private string companyWebsiteInputClass = "";
	private string companyCountryInputClass = "";
	private string companyLocationInputClass = "";
	private string companyPCInputClass = "";
	private string companyRegionsInputClass = "";
	private string companyTownInputClass = "";
	private string companyHRNameInputClass = "";
	private string companyHRSurnameInputClass = "";
	private string companyHREmailInputClass = "";
	private string companyHRTelephoneInputClass = "";
	private string companyDescriptionInputClass = "";
	private string companyAreasInputClass = "";
	private string companySkillsInputClass = "";

	private string selectedRegion;
	private string selectedTown;

	private bool showTooltip = false;


	private List<Area> availableAreas = new List<Area>();
	private List<SelectedArea> selectedAreasForAssessment = new List<SelectedArea>();
	private HashSet<string> expandedAreas = new HashSet<string>();

	private List<string> availableSkills = new List<string> { };
	private List<string> selectedSkills = new List<string>();
	private List<string> finalSelectedSkills = new List<string>();
	private List<Skill> selectedSkillsForAssessment = new List<Skill>();

	private string emailValidationMessagehr;
	private string emailValidationMessageadmin;
	private string emailValidationMessageRnD;

	private bool agreeTerms = false;
	private CustomCheckbox customCheckbox;

	private Dictionary<string, bool> countrySelections = new Dictionary<string, bool>();

	private bool showCountries = false; 
	private bool isRegistered;
	public bool updated = false;

	List<Area> filteredAreas = new List<Area>();
	string areassearchTerm = "";
	List<string> filteredSkills = new List<string>();
	string skillSearchTerm = "";

	private string FileErrorMessage { get; set; }

	private bool showValidationError = false;

	private string websiteValidationMessageForCompanyProfile = "";
	private bool showMessage = false;


	private string GetValidationClass(string fieldValue)
	{
		return string.IsNullOrEmpty(fieldValue) && showValidationError ? "shake error" : "";
	}

	private bool IsValidWebsiteAtCompanyRegistration(string url)
	{
		// Return false if the input is null or empty
		if (string.IsNullOrEmpty(url))
			return false;

		// Simple regex to check for a valid website URL
		string pattern = @"^https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}.*$";
		return Regex.IsMatch(url, pattern);
	}




	private List<string> ForeasType = new List<string>
	{
		"Ιδιωτικός Φορέας",
		"Δημόσιος Φορέας",
		"Μ.Κ.Ο.",
		"Άλλο"
	};

	private List<string> Activity = new List<string>
	{
		"Αθλητισμός",
		"Άλλο",
		"Βιοϊατρική",
		"Βιομηχανία(γενικά)",
		"Βιοτεχνολογία",
		"Γεωργία/Κτηνοτροφία",
		"Γραφιστική/Σχέδιο",
		"Δημόσιες Σχέσεις",
		"Δημόσιες Υπηρεσίες",
		"Διατροφή/Γαστρονομία",
		"Διαφήμιση",
		"Διαχείριση Ακινήτων",
		"Διαχείριση Ανθρώπινου Δυναμικού",
		"Εκδόσεις/Εκτυπώσεις",
		"Εκπαιδευτικοί Φορείς",
		"Ενέργεια",
		"Ηλεκτρονικά",
		"Ηλεκτρονικό Εμπόριο",
		"Θέρμανση/Κλιματισμός",
		"Ιατρική",
		"Κοινωνικές Υπηρεσίες",
		"Λιανικό Εμπόριο",
		"Λογισμικό",
		"Μάρκετινγκ",
		"Μέσα Μαζικής Ενημέρωσης",
		"Μεταφορές/Logistics",
		"Μηχανολογία",
		"Μικροηλεκτρονική",
		"Μοριακή Βιολογία",
		"Νομικά",
		"Οικολογία/Προστασία Περιβάλλοντος/Ανακύκλωση",
		"Οικονομία/Τραπεζική/Ασφάλειες",
		"Οπτικά",
		"Παροχή Διαδικτυακών Υπηρεσιών",
		"Πετρελαιοειδή",
		"Πληροφορική",
		"Σύμβουλοι Επιχειρήσεων",
		"Τέχνη/Μουσεία",
		"Τεχνικά Γραφεία-Εταιρίες/Κατασκευές",
		"Τηλεοπτικές Παραγωγές",
		"Τηλεπικοινωνίες",
		"Τοπική/Κεντρική Διοίκηση",
		"Τουριστικές Επιχειρήσεις",
		"Υφάσματα/Ένδυση/Μόδα",
		"Φωτογραφία",
		"Χημικά Προϊόντα/Φάρμακα",
	};

	private List<string> Regions = new List<string>
	{
		"Ανατολική Μακεδονία και Θράκη",
		"Κεντρική Μακεδονία",
		"Δυτική Μακεδονία",
		"Ήπειρος",
		"Θεσσαλία",
		"Ιόνια Νησιά",
		"Δυτική Ελλάδα",
		"Κεντρική Ελλάδα",
		"Αττική",
		"Πελοπόννησος",
		"Βόρειο Αιγαίο",
		"Νότιο Αιγαίο",
		"Κρήτη"
};

	private List<string> ExportCountries = new List<string>
	{
		"United States", "Canada", "Afghanistan", "Albania", "Algeria", "American Samoa",
		"Andorra", "Angola", "Anguilla", "Antarctica", "Antigua and/or Barbuda", "Argentina",
		"Armenia", "Aruba", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh",
		"Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bermuda", "Bhutan", "Bolivia", "Bosnia and Herzegovina",
		 "Botswana", "Bouvet Island", "Brazil", "British Indian Ocean Territory", "Brunei Darussalam", "Bulgaria",
		 "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Cape Verde", "Cayman Islands", "Central African Republic", 
		 "Chad", "Chile", "China", "Christmas Island", "Cocos (Keeling) Islands", "Colombia", "Comoros", "Congo", "Cook Islands",
		 "Costa Rica", "Croatia (Hrvatska)", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", 
		 "Dominican Republic", "East Timor", "Ecudaor", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia",
		 "Ethiopia", "Falkland Islands (Malvinas)", "Faroe Islands", "Fiji", "Finland", "France", "France, Metropolitan", "French Guiana",
		 "French Polynesia", "French Southern Territories", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Gibraltar", "Greece",
		 "Greenland", "Grenada", "Guadeloupe", "Guam", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Heard and Mc Donald Islands",
		 "Honduras", "Hong Kong", "Hungary", "Iceland", "India", "Indonesia", "Iran (Islamic Republic of)", "Iraq", "Ireland", "Israel",
		 "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Korea, Democratic People's Republic of",
		 "Korea, Republic of", "Kosovo", "Kuwait", "Kyrgyzstan", "Lao People's Democratic Republic", "Latvia", "Lebanon", "Lesotho",
		 "Liberia", "Libyan Arab Jamahiriya", "Liechtenstein", "Lithuania", "Luxembourg", "Macau", "Macedonia", "Madagascar", "Malawi",
		 "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Martinique", "Mauritania", "Mauritius", "Mayotte", "Mexico",
		 "Micronesia, Federated States of", "Moldova, Republic of", "Monaco", "Mongolia", "Montserrat", "Morocco", "Mozambique", "Myanmar",
		 "Namibia", "Nauru", "Nepal", "Netherlands", "Netherlands Antilles", "New Caledonia", "New Zealand", "Nicaragua", "Niger", "Nigeria",
		 "Niue", "Norfork Island", "Northern Mariana Islands", "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay", "Peru",
		 "Philippines", "Pitcairn", "Poland", "Portugal", "Puerto Rico", "Qatar", "Reunion", "Romania", "Russian Federation", "Rwanda",
		 "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe",
		 "Saudi Arabia", "Senegal", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
		 "South Africa", "South Georgia South Sandwich Islands", "South Sudan", "Spain", "Sri Lanka", "St. Helena", "St. Pierre and Miquelon",
		 "Sudan", "Suriname", "Svalbarn and Jan Mayen Islands", "Swaziland", "Sweden", "Switzerland", "Syrian Arab Republic", "Taiwan", "Tajikistan",
		 "Tanzania, United Republic of", "Thailand", "Togo", "Tokelau", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", 
		 "Turks and Caicos Islands", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States minor outlying islands",
		 "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City State", "Venezuela", "Vietnam", "Virigan Islands (British)", "Virgin Islands (U.S.)", "Wallis and Futuna Islands",
		 "Western Sahara", "Yemen", "Yugoslavia", "Zaire", "Zambia", "Zimbabwe"
	};

	private Dictionary<string, List<string>> RegionToTownsMap = new Dictionary<string, List<string>>
    {
        {"Ανατολική Μακεδονία και Θράκη", new List<string> {"Κομοτηνή", "Αλεξανδρούπολη", "Καβάλα", "Ξάνθη", "Δράμα", "Ορεστιάδα", "Διδυμότειχο", "Ίασμος", "Νέα Βύσσα", "Φέρες"}},
        {"Κεντρική Μακεδονία", new List<string> {"Θεσσαλονίκη", "Κατερίνη", "Σέρρες", "Κιλκίς", "Πολύγυρος", "Ναούσα", "Έδεσσα", "Γιαννιτσά", "Καβάλα", "Άμφισσα"}},
        {"Δυτική Μακεδονία", new List<string> {"Κοζάνη", "Φλώρινα", "Καστοριά", "Γρεβενά"}},
        {"Ήπειρος", new List<string> {"Ιωάννινα", "Άρτα", "Πρέβεζα", "Ηγουμενίτσα"}},
        {"Θεσσαλία", new List<string> {"Λάρισα", "Βόλος", "Τρίκαλα", "Καρδίτσα"}},
        {"Ιόνια Νησιά", new List<string> {"Κέρκυρα", "Λευκάδα", "Κεφαλονιά", "Ζάκυνθος", "Ιθάκη", "Παξοί", "Κυθήρα"}},
        {"Δυτική Ελλάδα", new List<string> {"Πάτρα", "Μεσολόγγι", "Αμφιλοχία", "Πύργος", "Αιγίο", "Ναύπακτος"}},
        {"Κεντρική Ελλάδα", new List<string> {"Λαμία", "Χαλκίδα", "Λιβαδειά", "Θήβα", "Αλιάρτος", "Αμφίκλεια"}},
        {"Αττική", new List<string> {"Αθήνα", "Πειραιάς", "Κηφισιά", "Παλλήνη", "Αγία Παρασκευή", "Χαλάνδρι", "Καλλιθέα", "Γλυφάδα", "Περιστέρι", "Αιγάλεω"}},
        {"Πελοπόννησος", new List<string> {"Πάτρα", "Τρίπολη", "Καλαμάτα", "Κορίνθος", "Άργος", "Ναύπλιο", "Σπάρτη", "Κυπαρισσία", "Πύργος", "Μεσσήνη"}},
        {"Βόρειο Αιγαίο", new List<string> {"Μυτιλήνη", "Χίος", "Λήμνος", "Σάμος", "Ίκαρος", "Λέσβος", "Θάσος", "Σκύρος", "Ψαρά"}},
        {"Νότιο Αιγαίο", new List<string> {"Ρόδος", "Κως", "Κρήτη", "Κάρπαθος", "Σαντορίνη", "Μύκονος", "Νάξος", "Πάρος", "Σύρος", "Άνδρος"}},
        {"Κρήτη", new List<string> {"Ηράκλειο", "Χανιά", "Ρέθυμνο", "Αγία Νικόλαος", "Ιεράπετρα", "Σητεία", "Κίσαμος", "Παλαιόχωρα", "Αρχάνες", "Ανώγεια"}},
    };

	private bool showLoadingModalWhenSubmitCompanyForm = false;
	private int loadingProgressWhenSubmitCompanyForm = 0;

	private async Task SubmitForm()
	{
		error = false;
		showValidationError = false;

		// Show loading modal at the start
		showLoadingModalWhenSubmitCompanyForm = true;
		loadingProgressWhenSubmitCompanyForm = 0;
		StateHasChanged();

		try
		{
			// Step 1: Validation
			await UpdateProgressWhenSubmitCompanyForm(10, 200);

			// Reset all input classes
			companyNameInputClass = "";
			companyNameENGInputClass = "";
			companyTypeInputClass = "";
			companyActivityInputClass = "";
			companyTelephoneInputClass = "";
			companyWebsiteInputClass = "";
			companyCountryInputClass = "";
			companyLocationInputClass = "";
			companyPCInputClass = "";
			companyRegionsInputClass = "";
			companyTownInputClass = "";
			companyHRNameInputClass = "";
			companyHRSurnameInputClass = "";
			companyHREmailInputClass = "";
			companyHRTelephoneInputClass = "";
			companyDescriptionInputClass = "";
			companyAreasInputClass = "";

			// List to track missing mandatory fields
			var missingFields = new List<string>();

			// Validate ONLY mandatory fields (non-mandatory fields are excluded)
			if (string.IsNullOrEmpty(newCompany.CompanyName))
			{
				companyNameInputClass = "shake shake-input";
				missingFields.Add("Όνομα Εταιρίας(GR)");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyNameENG))
			{
				companyNameENGInputClass = "shake shake-input";
				missingFields.Add("Όνομα Εταιρίας(ENG)");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyType))
			{
				companyTypeInputClass = "shake shake-input";
				missingFields.Add("Τύπος Εταιρίας");
			}
			if (selectedActivities.Count == 0)
			{
				companyActivityInputClass = "shake shake-input";
				missingFields.Add("Δραστηριότητα Εταιρίας");
			}
			// Validate phone number format
			if (!string.IsNullOrEmpty(newCompany.CompanyTelephone))
			{
				if (!Regex.IsMatch(newCompany.CompanyTelephone, @"^\+?[0-9]{1,12}$"))
				{
					companyTelephoneInputClass = "shake shake-input";
					if (!missingFields.Contains("Τηλέφωνο"))
					{
						missingFields.Add("Τηλέφωνο (πρέπει να είναι έως 12 ψηφία με προαιρετικό + στην αρχή)");
					}
				}
			}
			if (string.IsNullOrEmpty(newCompany.CompanyWebsite))
			{
				companyWebsiteInputClass = "shake shake-input";
				missingFields.Add("Ιστοσελίδα");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyCountry))
			{
				companyCountryInputClass = "shake shake-input";
				missingFields.Add("Χώρα");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyLocation))
			{
				companyLocationInputClass = "shake shake-input";
				missingFields.Add("Διεύθυνση");
			}
			if (newCompany.CompanyPC <= 0)
			{
				companyPCInputClass = "shake shake-input";
				missingFields.Add("Ταχυδρομικός Κώδικας");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyRegions))
			{
				companyRegionsInputClass = "shake shake-input";
				missingFields.Add("Περιφέρεια");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyTown))
			{
				companyTownInputClass = "shake shake-input";
				missingFields.Add("Πόλη");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHRName))
			{
				companyHRNameInputClass = "shake shake-input";
				missingFields.Add("Όνομα Υπευθύνου HR");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHRSurname))
			{
				companyHRSurnameInputClass = "shake shake-input";
				missingFields.Add("Επώνυμο Υπευθύνου HR");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHREmail))
			{
				companyHREmailInputClass = "shake shake-input";
				missingFields.Add("Email Υπευθύνου HR");
			}
			// Validate HR phone number format
			if (!string.IsNullOrEmpty(newCompany.CompanyHRTelephone))
			{
				if (!Regex.IsMatch(newCompany.CompanyHRTelephone, @"^\+?[0-9]{1,12}$"))
				{
					companyHRTelephoneInputClass = "shake shake-input";
					if (!missingFields.Contains("Τηλέφωνο Υπευθύνου HR"))
					{
						missingFields.Add("Τηλέφωνο Υπευθύνου HR (πρέπει να είναι έως 12 ψηφία με προαιρετικό + στην αρχή)");
					}
				}
			}
			if (string.IsNullOrEmpty(newCompany.CompanyDescription))
			{
				companyDescriptionInputClass = "shake shake-input";
				missingFields.Add("Περιγραφή Εταιρίας");
			}
			// UPDATED: Use selectedAreasForCompany.Count instead of Count()
			if (selectedAreasForCompany.Count == 0)
			{
				companyAreasInputClass = "shake shake-input";
				missingFields.Add("Περιοχές Δραστηριότητας");
			}

			// Check if any mandatory field is empty
			if (missingFields.Count > 0)
			{
				showLoadingModalWhenSubmitCompanyForm = false;
				StateHasChanged();

				error = true;
				showValidationError = true;
				errorMessage = $"Συμπληρώστε τα ακόλουθα υποχρεωτικά πεδία: {string.Join(", ", missingFields)}";
				return;
			}

			// Step 2: Data preparation
			await UpdateProgressWhenSubmitCompanyForm(30, 200);

			// UPDATED: Use the same area serialization as UpdateCompanyRegistration
			newCompany.CompanyDesiredSkills = string.Join(",", selectedSkillsForCompany.Where(s => !string.IsNullOrWhiteSpace(s)));
			newCompany.CompanyAreas = string.Join(",", selectedAreasForCompany.Select(a => a.FullName).Where(a => !string.IsNullOrWhiteSpace(a)));
			newCompany.Company.UniqueID = "COMP_" + HashingHelper.HashString(newCompany.CompanyEmail);

			// Step 3: Database operations
			await UpdateProgressWhenSubmitCompanyForm(50, 200);

			using var dbContext = await DbContextFactory.CreateDbContextAsync();

			dbContext.Companies.Add(newCompany);
			await dbContext.SaveChangesAsync();

			await UpdateProgressWhenSubmitCompanyForm(100, 200);

			// Small delay to show completion
			await Task.Delay(500);

			showLoadingModalWhenSubmitCompanyForm = false;

			await Task.Delay(100); // Small delay for smooth transition

			// Show the navigation loader
			await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");

			// Give time for loader to render
			await Task.Delay(300);

			StateHasChanged();

			saved = true;
			error = false;

			// Step 4: Navigate
			NavigationManager.NavigateTo("/", forceLoad: true);
		}
		catch (Exception ex)
		{
			// Hide loading modal on error
			showLoadingModalWhenSubmitCompanyForm = false;
			StateHasChanged();

			showValidationError = true;
			error = true;
			errorMessage = "Σφάλμα κατά την αποθήκευση. Παρακαλώ δοκιμάστε ξανά.";
			Console.Error.WriteLine(ex);
		}
		finally
		{
			// Reset validation after success or error
			await Task.Delay(3000);
			companyNameInputClass = "";
			companyNameENGInputClass = "";
			companyTypeInputClass = "";
			companyActivityInputClass = "";
			companyTelephoneInputClass = "";
			companyWebsiteInputClass = "";
			companyCountryInputClass = "";
			companyLocationInputClass = "";
			companyPCInputClass = "";
			companyRegionsInputClass = "";
			companyTownInputClass = "";
			companyHRNameInputClass = "";
			companyHRSurnameInputClass = "";
			companyHREmailInputClass = "";
			companyHRTelephoneInputClass = "";
			companyDescriptionInputClass = "";
			companyAreasInputClass = "";
			errorMessage = "";
		}
	}

	// Helper method for company form submission
	private async Task UpdateProgressWhenSubmitCompanyForm(int current, int total)
	{
		loadingProgressWhenSubmitCompanyForm = (int)((double)current / total * 100);
		StateHasChanged();
		await Task.Delay(50);
	}




	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		using var dbContext = await DbContextFactory.CreateDbContextAsync();

		// Load areas from database
		availableAreas = await dbContext.Areas.ToListAsync();
		await LoadAvailableSkills();
		var companyEmail = user.Identity.Name;
		var companyFromDb = await dbContext.Companies.FirstOrDefaultAsync(s => s.CompanyEmail == companyEmail);

		filteredActivities = Activity;

		if (companyFromDb != null)
		{
			newCompany = companyFromDb;
			isRegistered = true;
		}
		else
		{
			Console.WriteLine($"CompanyModel with email {companyEmail} not found.");
			isRegistered = false;
		}

		if (user.Identity.IsAuthenticated)
		{
			Console.WriteLine($"Authentication Type: {user.Identity.AuthenticationType}");

			foreach (var claim in user.Claims)
			{
				Console.WriteLine($"Claim Type: {claim.Type}, Claim Value: {claim.Value}");
			}

			foreach (var country in ExportCountries)
			{
				countrySelections[country] = false;
			}

			// Set existing selected countries to true
			if (!string.IsNullOrWhiteSpace(newCompany.CompanyExportCountries))
			{
				var selectedCountries = newCompany.CompanyExportCountries.Split(',').Select(c => c.Trim());
				foreach (var country in selectedCountries)
				{
					if (countrySelections.ContainsKey(country))
					{
						countrySelections[country] = true;
					}
				}
			}

			var roleClaim = user.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role");

			if (roleClaim != null)
			{
				companyName = user.Identity?.Name ?? "Anonymous User";
				newCompany.CompanyEmail = companyName;
				var userRole = roleClaim.Value;
				Console.WriteLine($"User Role: {userRole}");
				Console.WriteLine($"User Email: {companyName}");
				hasReadAsCompanyPermission = userRole == "Company";
			}
			Console.WriteLine($"User Has CompanyModel Permission: {hasReadAsCompanyPermission}");
		}
		else
		{
			Console.WriteLine("User is not authenticated.");
			hasReadAsCompanyPermission = false;
		}

		if (newCompany != null)
		{
			// Load the areas already assigned to the company (CompanyAreas)
			var existingCompanyAreas = await dbContext.Companies
				.Where(c => c.Id == newCompany.Id)
				.Select(c => c.CompanyAreas)
				.FirstOrDefaultAsync();

			// FIXED: Load areas with proper custom area detection
			if (!string.IsNullOrEmpty(existingCompanyAreas))
			{
				// Split the comma-separated string into individual area names
				var selectedAreaNames = existingCompanyAreas.Split(',').Select(a => a.Trim());

				foreach (var areaName in selectedAreaNames)
				{
					var normalizedAreaName = areaName.Trim();

					// First check if it's a subfield of any available area
					bool isSubField = false;
					string parentArea = "";

					foreach (var area in availableAreas)
					{
						var subFields = area.AreaSubFields?.Split(',')
							.Select(sf => sf.Trim())
							.Where(sf => !string.IsNullOrEmpty(sf));

						if (subFields != null && subFields.Any(sf =>
							sf.Equals(normalizedAreaName, StringComparison.OrdinalIgnoreCase)))
						{
							isSubField = true;
							parentArea = area.AreaName;
							break;
						}
					}

					if (isSubField)
					{
						// It's a predefined subfield
						selectedAreasForCompany.Add(new AreaItem
							{
								FullName = normalizedAreaName,
								DisplayName = normalizedAreaName,
								IsSubField = true,
								ParentArea = parentArea
							});
						Console.WriteLine($"Loaded subfield: {normalizedAreaName} (Parent: {parentArea})");
					}
					else
					{
						// Check if it's a predefined main area
						var predefinedArea = availableAreas.FirstOrDefault(a =>
							a.AreaName.Trim().Equals(normalizedAreaName, StringComparison.OrdinalIgnoreCase));

						if (predefinedArea != null)
						{
							// It's a predefined main area
							selectedAreasForCompany.Add(new AreaItem
								{
									FullName = predefinedArea.AreaName,
									DisplayName = predefinedArea.AreaName,
									IsSubField = false,
									ParentArea = ""
								});
							Console.WriteLine($"Loaded predefined area: {predefinedArea.AreaName}");
						}
						else
						{
							// It's a custom area
							selectedAreasForCompany.Add(new AreaItem
								{
									FullName = normalizedAreaName,
									DisplayName = normalizedAreaName,
									IsSubField = false,
									ParentArea = ""
								});
							Console.WriteLine($"Loaded custom area: {normalizedAreaName}");
						}
					}
				}

				// Don't modify availableAreas here - let the filter method handle it
				Console.WriteLine($"After loading - Available areas: {availableAreas.Count}, Selected areas: {selectedAreasForCompany.Count}");
			}

			var existingCompanySkills = await dbContext.Companies
							.Where(c => c.Id == newCompany.Id)
							.Select(c => c.CompanyDesiredSkills)
							.FirstOrDefaultAsync();

			// Split the comma-separated string into a list of skills
			var skillList = existingCompanySkills?
				.Split(',')
				.Select(s => s.Trim())
				.Where(s => !string.IsNullOrEmpty(s))
				.ToList() ?? new List<string>();

			// Initialize selectedSkillsForCompany with these skills
			selectedSkillsForCompany = skillList;

			Console.WriteLine($"Loaded skills: {string.Join(", ", selectedSkillsForCompany)}");

			if (!string.IsNullOrEmpty(newCompany.CompanyActivity))
			{
				selectedActivities = newCompany.CompanyActivity.Split(',')
					.Select(a => a.Trim())
					.Where(a => !string.IsNullOrEmpty(a))
					.ToList();
			}
		}

		// Filter available areas and skills to exclude selected items
		FilterAvailableAreas(new ChangeEventArgs { Value = "" }); // Pass an empty search term to initialize
		filteredSkills = availableSkills.ToList();

		FilterAvailableAreas(new ChangeEventArgs { Value = "" });
		FilterAvailableSkillsBasedOnSelection();

		StateHasChanged();
	}

	private async Task ShowFilteredStudents()
	{
		// Clear the previously filtered students
		filteredStudents.Clear();

		using var dbContext = await DbContextFactory.CreateDbContextAsync();

		if (showStudentsWithProgrammingSkills || showStudentsWithMachineLearningSkills ||
			showStudentsWithDatabaseSkills || showStudentsWithNetworkAndTelecomSkills)
		{
			// Filter students based on the combination of selected checkboxes
			filteredStudents = dbContext.Students.Where(s =>
				(showStudentsWithProgrammingSkills && s.Programming) ||
				(showStudentsWithMachineLearningSkills && s.MachineLearning) ||
				(showStudentsWithDatabaseSkills && s.Databases) ||
				(showStudentsWithNetworkAndTelecomSkills && s.NetworksAndTelecom)
			).ToList();
		}
		showResultsClicked = true;
	}

	private async Task DownloadAttachment(byte[] attachment, string studentName)
	{
		try
		{
			if (attachment != null)
			{
				var fileName = $"{studentName}_CV.pdf";
				var content = Convert.ToBase64String(attachment);

				// Download the file
				await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, attachment);

				// Preview the file
				await PreviewPdf(content);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error downloading/previewing attachment: {ex.Message}");
		}
	}

	private async Task PreviewPdf(string content)
	{
		try
		{
			// Prepare the blob URL for the PDF content
			var blobUrl = $"data:application/pdf;base64,{content}";

			// Open the blob URL in a new tab for preview
			await JSRuntime.InvokeVoidAsync("open", blobUrl, "_blank");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error previewing PDF: {ex.Message}");
		}
	}

	private void NavigateToUploadJobs()
	{
		Console.WriteLine("Navigating to uploadJobs page...");
		NavigationManager.NavigateTo("/uploadJobs");
	}

	private void ToggleProgrammingSkillsCheckbox()
	{
		showStudentsWithProgrammingSkills = !showStudentsWithProgrammingSkills;
		ShowFilteredStudents();
	}

	private void ToggleMachineLearningSkillsCheckbox()
	{
		showStudentsWithMachineLearningSkills = !showStudentsWithMachineLearningSkills;
		ShowFilteredStudents();
	}

	private void ToggleDatabaseSkillsCheckbox()
	{
		showStudentsWithDatabaseSkills = !showStudentsWithDatabaseSkills;
		ShowFilteredStudents();
	}

	private void ToggleNetworkAndTelecomSkillsCheckbox()
	{
		showStudentsWithNetworkAndTelecomSkills = !showStudentsWithNetworkAndTelecomSkills;
		ShowFilteredStudents();
	}
	private async Task KeywordSearch()
	{
		// Clear the previously filtered students
		filteredStudentsByKeyword.Clear();

		using var dbContext = await DbContextFactory.CreateDbContextAsync();

		// Check if keywordSearch is not null or empty
		if (!string.IsNullOrEmpty(keywordSearch))
		{
			// Split the keywordSearch string based on commas
			var keywords = keywordSearch.Split(',');

			// Filter students based on each keyword
			foreach (var keyword in keywords)
			{
				var keywordTrimmed = keyword.Trim().ToLower();
				if (!string.IsNullOrEmpty(keywordTrimmed))
				{
					// Filter students where the keyword exactly matches any keyword in their list
					foreach (var student in dbContext.Students)
					{
						var studentKeywords = student.Keywords.ToLower().Split(',').Select(k => k.Trim());
						if (studentKeywords.Contains(keywordTrimmed))
						{
							filteredStudentsByKeyword.Add(student);
						}
					}
				}
			}
		}

		// Remove duplicate students, if any
		filteredStudentsByKeyword = filteredStudentsByKeyword.Distinct().ToList();

		showKeywordSearch = true;
	}

	private async Task HandleFileChange(InputFileChangeEventArgs e)
	{
		try
		{
			var selectedFiles = e.GetMultipleFiles();
			var file = selectedFiles.FirstOrDefault();

			if (file != null)
			{
				// Check file type
				var allowedTypes = new[] { "image/jpeg", "image/png" };
				if (!allowedTypes.Contains(file.ContentType))
				{
					FileErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε .jpg ή .png";
					newCompany.CompanyLogo = null;
					return;
				}

				// Check file size (1MB = 1,048,576 bytes)
				const long maxFileSize = 1048576;
				if (file.Size > maxFileSize)
				{
					FileErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 1MB";
					newCompany.CompanyLogo = null;
					return;
				}

				using (var memoryStream = new MemoryStream())
				{
					await file.OpenReadStream(maxFileSize).CopyToAsync(memoryStream);
					newCompany.CompanyLogo = memoryStream.ToArray();
				}

				// Clear any previous error message
				FileErrorMessage = null;
			}
			else
			{
				newCompany.CompanyLogo = null;
				FileErrorMessage = "Παρακαλώ επιλέξτε ένα αρχείο.";
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error uploading file: {ex.Message}");
			newCompany.CompanyLogo = null;
			FileErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
		}
	}






	private void HandleCompanyTaxIDNumberInput(ChangeEventArgs e)
	{
		if (long.TryParse(e.Value?.ToString(), out long result))
		{
			newCompany.CompanyTaxID = result;
			companyTaxIDNumberInput = result.ToString();
		}

	}

	private void HandleCompanyPCNumberInput(ChangeEventArgs e)
	{
		var inputValue = e.Value?.ToString();
		companyPCNumberInput = inputValue; 

		if (long.TryParse(inputValue, out long result))
		{
			newCompany.CompanyPC = result;
		}
		else
		{
			newCompany.CompanyPC = 0; 
		}
	}

	private void ShowTooltip()
	{
		showTooltip = true;
	}

	private void OnAreaChange(ChangeEventArgs e)
	{
		var selectedValue = e.Value.ToString();
		var selectedArea = availableAreas.FirstOrDefault(a => a.AreaName == selectedValue);
		if (selectedArea != null)
		{
			ToggleSubFields(selectedArea);
		}
	}

	private void MoveSelectedAreaToLeft()
	{
		var itemsToRemove = new List<AreaItem>();

		foreach (var selectedValue in selectedSelectedItems)
		{
			if (selectedValue.StartsWith("area:"))
			{
				var areaName = selectedValue.Substring(5);
				itemsToRemove.AddRange(selectedAreasForCompany
					.Where(item => item.FullName == areaName && !item.IsSubField));
			}
			else if (selectedValue.StartsWith("subfield:"))
			{
				var subFieldName = selectedValue.Substring(9);
				itemsToRemove.AddRange(selectedAreasForCompany
					.Where(item => item.FullName == subFieldName && item.IsSubField));
			}
		}

		foreach (var itemToRemove in itemsToRemove)
		{
			selectedAreasForCompany.Remove(itemToRemove);
		}

		FilterAvailableAreasBasedOnSelection();
		selectedSelectedItems.Clear();
		StateHasChanged();
	}





	private async Task MoveSelectedAreaToRight()
	{
		Console.WriteLine("=== MOVING AREAS TO RIGHT ===");

		var itemsToAdd = new List<(string name, bool isSubField)>();

		// First, check if we should add a custom area from search term
		if (!string.IsNullOrWhiteSpace(areassearchTerm))
		{
			// Check if there are actually any selected items in the listbox
			var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableAreas");

			// If no items are selected in the listbox, treat the search term as custom area
			if (selectedOptions.Length == 0)
			{
				var customAreaName = areassearchTerm.Trim();

				// Check if this is not already in available areas (custom area)
				var isCustomArea = !availableAreas.Any(a =>
					a.AreaName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

				if (isCustomArea)
				{
					itemsToAdd.Add((customAreaName, false));
					Console.WriteLine($"Will add custom area: {customAreaName}");

					// Clear search term after adding custom area
					areassearchTerm = "";
				}
			}
			else
			{
				// There are selected items, so process them normally
				foreach (var selectedValue in selectedOptions)
				{
					if (selectedValue.StartsWith("area:"))
					{
						var areaName = selectedValue.Substring(5);
						itemsToAdd.Add((areaName, false));
						Console.WriteLine($"Will add area: {areaName}");
					}
					else if (selectedValue.StartsWith("subfield:"))
					{
						var subFieldName = selectedValue.Substring(9);
						itemsToAdd.Add((subFieldName, true));
						Console.WriteLine($"Will add subfield: {subFieldName}");
					}
				}
			}
		}
		else
		{
			// No search term, process selected items normally
			foreach (var selectedValue in selectedAvailableItems)
			{
				if (selectedValue.StartsWith("area:"))
				{
					var areaName = selectedValue.Substring(5);
					itemsToAdd.Add((areaName, false));
					Console.WriteLine($"Will add area: {areaName}");
				}
				else if (selectedValue.StartsWith("subfield:"))
				{
					var subFieldName = selectedValue.Substring(9);
					itemsToAdd.Add((subFieldName, true));
					Console.WriteLine($"Will add subfield: {subFieldName}");
				}
			}
		}

		// Add all collected items
		foreach (var item in itemsToAdd)
		{
			AddAreaToSelected(item.name, item.isSubField);
		}

		// Validate and cleanup
		ValidateSelectedAreas();
		EnsureUniqueSelectedAreas();
		FilterAvailableAreasBasedOnSelection();
		selectedAvailableItems.Clear();

		StateHasChanged();
	}




	private void ToggleSubFields(Area area)
	{
		if (expandedAreas.Contains(area.AreaName))
		{
			expandedAreas.Remove(area.AreaName);
		}
		else
		{
			expandedAreas.Add(area.AreaName);
		}
		StateHasChanged();
	}

	private async Task<List<string>> GetSelectedAreasFromDOM(string selectId)
	{
		var selectedAreas = await JSRuntime.InvokeAsync<List<string>>("getSelectedValues", selectId);
		return selectedAreas;
		StateHasChanged();
	}

	public class SelectedArea
	{
		public string AreaName { get; set; }
		public int Assessment { get; set; } = 1; // Default assessment value is 1
	}

	private async Task MoveSelectedToLeft()
	{
		var newlySelectedSkills = await GetSelectedSkillsFromDOM("selectedSkills");

		foreach (var skill in newlySelectedSkills)
		{
			selectedSkills.Remove(skill);
			finalSelectedSkills.Remove(skill);

			var skillForAssessment = selectedSkillsForAssessment.FirstOrDefault(s => s.SkillName == skill);
			if (skillForAssessment != null)
			{
				selectedSkillsForAssessment.Remove(skillForAssessment);
			}

			if (!availableSkills.Contains(skill))
			{
				availableSkills.Add(skill);
				Console.WriteLine($"Skill {skill} added back to availableSkills (Left List Box)");
			}
		}

		StateHasChanged(); // Update the UI
	}

	private async Task MoveSelectedToRight()
	{
		var newlySelectedSkills = await GetSelectedSkillsFromDOM("availableSkills");

		// Move predefined skills to the right
		foreach (var skill in newlySelectedSkills)
		{
			availableSkills.Remove(skill);

			if (!selectedSkills.Contains(skill))
			{
				selectedSkills.Add(skill);
				finalSelectedSkills.Add(skill);
				selectedSkillsForAssessment.Add(new Skill { SkillName = skill, Assessment = 1 });
				Console.WriteLine($"Skill {skill} added to selectedSkills (Right List Box)");
			}
		}

		// Add custom skill directly if it doesn't already exist
		if (!string.IsNullOrWhiteSpace(skillSearchTerm) &&
			!selectedSkills.Any(s => s.Equals(skillSearchTerm, StringComparison.OrdinalIgnoreCase)))
		{
			selectedSkills.Add(skillSearchTerm);
			finalSelectedSkills.Add(skillSearchTerm);
			selectedSkillsForAssessment.Add(new Skill { SkillName = skillSearchTerm, Assessment = 1 });

			Console.WriteLine($"Custom skill {skillSearchTerm} added to selectedSkills (Right List Box)");

			// Clear the search term after adding the custom skill
			skillSearchTerm = string.Empty;
		}

		StateHasChanged(); // Update the UI
	}



	private async Task<List<string>> GetSelectedSkillsFromDOM(string selectId)
	{
		var selectedSkills = await JSRuntime.InvokeAsync<List<string>>("getSelectedValues", selectId);
		return selectedSkills;
	}

	public class Skill
	{
		public string SkillName { get; set; }
		public int Assessment { get; set; } = 1; // Default assessment value is 1
	}

	public class SelectedSkill
	{
		public string SkillName { get; set; }
		public int Assessment { get; set; } = 1; // Default assessment value is 1
	}

	private async Task LoadAvailableSkills()
	{
		try
		{
			using var dbContext = await DbContextFactory.CreateDbContextAsync();
			var skills = await dbContext.Skills.ToListAsync();
			availableSkills = skills.Select(s => s.SkillName).ToList();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading available skills: {ex.Message}");
		}
	}

	private async Task ShowInfoMessage(FocusEventArgs e)
	{
		await JSRuntime.InvokeVoidAsync("showMessage", "infoMessage", " ** Η πληροφορία αυτή δεν θα είναι ορατή στους χρήστες της πλατφόρμας");
	}

	private async Task HideInfoMessage(FocusEventArgs e)
	{
		await JSRuntime.InvokeVoidAsync("hideMessage", "infoMessage");
	}


	private void ValidateEmailHR(FocusEventArgs e)
	{
		if (string.IsNullOrEmpty(newCompany.CompanyHREmail))
		{
			emailValidationMessagehr = " ";
		}
		else if (!IsValidEmailHR(newCompany.CompanyHREmail))
		{
			emailValidationMessagehr = "Correct form: * address@domain.gr/com";
		}
		else if (IsValidEmailHR(newCompany.CompanyHREmail))
		{
			emailValidationMessagehr = "";
		}

	}
	private bool IsValidEmailHR(string email)
	{
		// Regular expression for validating email format
		var emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
		return Regex.IsMatch(email, emailPattern);
	}



	private void ValidateEmailAdmin(FocusEventArgs e)
	{
		if (string.IsNullOrEmpty(newCompany.CompanyAdminEmail))
		{
			emailValidationMessageadmin = " ";
		}
		else if (!IsValidEmailAdmin(newCompany.CompanyAdminEmail))
		{
			emailValidationMessageadmin = "Correct form: * address@domain.gr/com";
		}
		else if (IsValidEmailHR(newCompany.CompanyAdminEmail))
		{
			emailValidationMessageadmin = "";
		}
	}
	private bool IsValidEmailAdmin(string email)
	{
		// Regular expression for validating email format
		var emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
		return Regex.IsMatch(email, emailPattern);
	}
	//RnD Email Form Validation ////////////////////////////////////////////////////////////
	private void ValidateEmailRnD(FocusEventArgs e)
	{
		if (string.IsNullOrEmpty(newCompany.RnD_ContactPersonEmail))
		{
			emailValidationMessageRnD = " ";
		}
		else if (!IsValidEmailRnD(newCompany.RnD_ContactPersonEmail))
		{
			emailValidationMessageRnD = "Correct form: * address@domain.gr/com";
		}
		else if (IsValidEmailRnD(newCompany.RnD_ContactPersonEmail))
		{
			emailValidationMessageRnD = "";
		}
	}
	private bool IsValidEmailRnD(string email)
	{
		// Regular expression for validating email format
		var emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
		return Regex.IsMatch(email, emailPattern);
	}
	//////////////////////////////////////////////////////////////////////////////////////////
	private async Task ShowUserAgreementModal(MouseEventArgs e)
	{
		await JSRuntime.InvokeVoidAsync("showModal1", "#userAgreementModal");
	}

	private void AgreeToTerms()
	{
	// Programmatically set the checkbox value
		customCheckbox?.SetValue(true);
		agreeTerms = true;
		termsAccepted = true;
		canSubmit = true; // User can now submit by clicking save again
		showMessage = false;
		StateHasChanged(); // Re-render the component to reflect changes

	}

	private void DeclineTerms()
	{
	// Programmatically unset the checkbox value
		customCheckbox?.SetValue(false);
		agreeTerms = false;
		termsAccepted = false;
		canSubmit = false;
		showMessage = true;
		StateHasChanged(); // Re-render the component to reflect changes
	}

	private string GetSaveButtonText()
	{
		if (termsAccepted && canSubmit)
			return "Ολοκλήρωση Εγγραφής";
		else if (termsAccepted)
			return "Αποθήκευση (Έτοιμο)";
		else
			return "Αποθήκευση";
	}

	private void ToggleCountrySelection(string country)
	{
		countrySelections[country] = !countrySelections[country];
		UpdateExportCountries();
	}

	private void UpdateExportCountries()
	{
		var selectedCountries = countrySelections
			.Where(kvp => kvp.Value)
			.Select(kvp => kvp.Key)
			.ToList();

		newCompany.CompanyExportCountries = string.Join(",", selectedCountries);
		newCompany.CompanyExportCountriesNumber = selectedCountries.Count;

	}

	private void ToggleCountriesVisibility()
	{
		showCountries = !showCountries;
	}

	private bool showLoadingModalWhenUpdateCompanyRegistration = false;
	private int loadingProgressWhenUpdateCompanyRegistration = 0;

	private async Task UpdateCompanyRegistration()
	{
		error = false;
		showValidationError = false;

		// Show loading modal at the start
		showLoadingModalWhenUpdateCompanyRegistration = true;
		loadingProgressWhenUpdateCompanyRegistration = 0;
		StateHasChanged();

		try
		{
			// Step 1: Validation
			await UpdateProgressWhenUpdateCompanyRegistration(10, 200);

			// Reset all input classes
			companyNameInputClass = "";
			companyNameENGInputClass = "";
			companyTypeInputClass = "";
			companyActivityInputClass = "";
			companyTelephoneInputClass = "";
			companyWebsiteInputClass = "";
			companyCountryInputClass = "";
			companyLocationInputClass = "";
			companyPCInputClass = "";
			companyRegionsInputClass = "";
			companyTownInputClass = "";
			companyHRNameInputClass = "";
			companyHRSurnameInputClass = "";
			companyHREmailInputClass = "";
			companyHRTelephoneInputClass = "";
			companyDescriptionInputClass = "";
			companyAreasInputClass = "";

			// List to track missing mandatory fields
			var missingFields = new List<string>();

			// Validate ONLY mandatory fields (non-mandatory fields are excluded)
			if (string.IsNullOrEmpty(newCompany.CompanyName))
			{
				companyNameInputClass = "shake shake-input";
				missingFields.Add("Όνομα Εταιρίας(GR)");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyNameENG))
			{
				companyNameENGInputClass = "shake shake-input";
				missingFields.Add("Όνομα Εταιρίας(ENG)");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyType))
			{
				companyTypeInputClass = "shake shake-input";
				missingFields.Add("Τύπος Εταιρίας");
			}
			if (selectedActivities.Count == 0)
			{
				companyActivityInputClass = "shake shake-input";
				missingFields.Add("Δραστηριότητα Εταιρίας");
			}
			// Validate phone number format
			if (!string.IsNullOrEmpty(newCompany.CompanyTelephone))
			{
				if (!Regex.IsMatch(newCompany.CompanyTelephone, @"^\+?[0-9]{1,12}$"))
				{
					companyTelephoneInputClass = "shake shake-input";
					if (!missingFields.Contains("Τηλέφωνο"))
					{
						missingFields.Add("Τηλέφωνο (πρέπει να είναι έως 12 ψηφία με προαιρετικό + στην αρχή)");
					}
				}
			}
			if (string.IsNullOrEmpty(newCompany.CompanyWebsite))
			{
				companyWebsiteInputClass = "shake shake-input";
				missingFields.Add("Ιστοσελίδα");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyCountry))
			{
				companyCountryInputClass = "shake shake-input";
				missingFields.Add("Χώρα");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyLocation))
			{
				companyLocationInputClass = "shake shake-input";
				missingFields.Add("Διεύθυνση");
			}
			if (newCompany.CompanyPC <= 0)
			{
				companyPCInputClass = "shake shake-input";
				missingFields.Add("Ταχυδρομικός Κώδικας");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyRegions))
			{
				companyRegionsInputClass = "shake shake-input";
				missingFields.Add("Περιφέρεια");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyTown))
			{
				companyTownInputClass = "shake shake-input";
				missingFields.Add("Πόλη");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHRName))
			{
				companyHRNameInputClass = "shake shake-input";
				missingFields.Add("Όνομα Υπευθύνου HR");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHRSurname))
			{
				companyHRSurnameInputClass = "shake shake-input";
				missingFields.Add("Επώνυμο Υπευθύνου HR");
			}
			if (string.IsNullOrEmpty(newCompany.CompanyHREmail))
			{
				companyHREmailInputClass = "shake shake-input";
				missingFields.Add("Email Υπευθύνου HR");
			}
			// Validate HR phone number format
			if (!string.IsNullOrEmpty(newCompany.CompanyHRTelephone))
			{
				if (!Regex.IsMatch(newCompany.CompanyHRTelephone, @"^\+?[0-9]{1,12}$"))
				{
					companyHRTelephoneInputClass = "shake shake-input";
					if (!missingFields.Contains("Τηλέφωνο Υπευθύνου HR"))
					{
						missingFields.Add("Τηλέφωνο Υπευθύνου HR (πρέπει να είναι έως 12 ψηφία με προαιρετικό + στην αρχή)");
					}
				}
			}
			if (string.IsNullOrEmpty(newCompany.CompanyDescription))
			{
				companyDescriptionInputClass = "shake shake-input";
				missingFields.Add("Περιγραφή Εταιρίας");
			}
			if (selectedAreasForCompany.Count == 0)
			{
				companyAreasInputClass = "shake shake-input";
				missingFields.Add("Περιοχές Δραστηριότητας");
			}

			// Check if any mandatory field is empty
			if (missingFields.Count > 0)
			{
				showLoadingModalWhenUpdateCompanyRegistration = false;
				StateHasChanged();

				error = true;
				showValidationError = true;
				errorMessage = $"Συμπληρώστε τα ακόλουθα υποχρεωτικά πεδία: {string.Join(", ", missingFields)}";
				return;
			}

			// Step 2: Database operations
			await UpdateProgressWhenUpdateCompanyRegistration(30, 200);

			using var dbContext = await DbContextFactory.CreateDbContextAsync();
			string originalCompanyName = null;
			string companyEmail = null;

			if (isRegistered)
			{
				// Update existing company
				var existingCompany = await dbContext.Companies
					.FirstOrDefaultAsync(c => c.Company.UniqueID == newCompany.Company.UniqueID);

				if (existingCompany != null)
				{
					// Store original values before updating
					originalCompanyName = existingCompany.CompanyName;
					companyEmail = existingCompany.CompanyEmail;

					// Update all fields
					existingCompany.CompanyLogo = newCompany.CompanyLogo;
					existingCompany.CompanyName = newCompany.CompanyName;
					existingCompany.CompanyNameENG = newCompany.CompanyNameENG;
					existingCompany.CompanyShortName = newCompany.CompanyShortName;
					existingCompany.CompanyType = newCompany.CompanyType;
					existingCompany.CompanyActivity = newCompany.CompanyActivity;
					existingCompany.CompanyTaxID = newCompany.CompanyTaxID;
					existingCompany.CompanyTaxOffice = newCompany.CompanyTaxOffice;
					existingCompany.CompanyTelephone = newCompany.CompanyTelephone;
					existingCompany.CompanyWebsite = newCompany.CompanyWebsite;
					existingCompany.CompanyPresentationEmbeddedVideo = newCompany.CompanyPresentationEmbeddedVideo;
					existingCompany.CompanyWebsiteAnnouncements = newCompany.CompanyWebsiteAnnouncements;
					existingCompany.CompanyWebsiteJobs = newCompany.CompanyWebsiteJobs;
					existingCompany.AtlasID = newCompany.AtlasID;
					existingCompany.SvseID = newCompany.SvseID;
					existingCompany.SvseDate = newCompany.SvseDate;
					existingCompany.CompanyActivity = string.Join(",", selectedActivities);

					// Address Information
					existingCompany.CompanyCountry = newCompany.CompanyCountry;
					existingCompany.CompanyLocation = newCompany.CompanyLocation;
					existingCompany.CompanyPC = newCompany.CompanyPC;
					existingCompany.CompanyRegions = newCompany.CompanyRegions;
					existingCompany.CompanyTown = newCompany.CompanyTown;

					// CompanyModel Description and Areas/Skills
					existingCompany.CompanyDescription = newCompany.CompanyDescription;
					existingCompany.CompanyAreas = string.Join(",", selectedAreasForCompany.Select(a => a.FullName).Where(a => !string.IsNullOrWhiteSpace(a)));
					existingCompany.CompanyDesiredSkills = string.Join(",", selectedSkillsForCompany.Where(s => !string.IsNullOrWhiteSpace(s)));
					// Platform Management Info
					existingCompany.CompanyCEOName = newCompany.CompanyCEOName;
					existingCompany.CompanyCEOSurname = newCompany.CompanyCEOSurname;
					existingCompany.CompanyCEOTaxID = newCompany.CompanyCEOTaxID;
					existingCompany.CompanyHRName = newCompany.CompanyHRName;
					existingCompany.CompanyHRSurname = newCompany.CompanyHRSurname;
					existingCompany.CompanyHREmail = newCompany.CompanyHREmail;
					existingCompany.CompanyHRTelephone = newCompany.CompanyHRTelephone;

					//RnD
					existingCompany.RnD_HeadName = newCompany.RnD_HeadName;
					existingCompany.RnD_ContactPersonFullName = newCompany.RnD_ContactPersonFullName;
					existingCompany.RnD_ContactPersonEmail = newCompany.RnD_ContactPersonEmail;

					existingCompany.CompanyAdminName = newCompany.CompanyAdminName;
					existingCompany.CompanyAdminSurname = newCompany.CompanyAdminSurname;
					existingCompany.CompanyAdminEmail = newCompany.CompanyAdminEmail;
					existingCompany.CompanyAdminTelephone = newCompany.CompanyAdminTelephone;

					// CompanyModel Activity Info
					existingCompany.CompanyEmployees = newCompany.CompanyEmployees;
					existingCompany.CompanEmployeesLastUpdate = newCompany.CompanEmployeesLastUpdate;
					existingCompany.CompanyTurnover = newCompany.CompanyTurnover;
					existingCompany.CompanyTurnoverLastUpdate = newCompany.CompanyTurnoverLastUpdate;
					existingCompany.CompanyExportCountriesNumber = newCompany.CompanyExportCountriesNumber;
					existingCompany.CompanyExportCountries = newCompany.CompanyExportCountries;
					existingCompany.CompanyExportCountriesLastUpdate = newCompany.CompanyExportCountriesLastUpdate;
					existingCompany.CompanyVisibleActivity = newCompany.CompanyVisibleActivity;

					dbContext.Companies.Update(existingCompany);
				}
			}
			else
			{
				// Register new company
				newCompany.CompanyLogo = newCompany.CompanyLogo;
				newCompany.CompanyName = newCompany.CompanyName;
				newCompany.CompanyNameENG = newCompany.CompanyNameENG;
				newCompany.CompanyShortName = newCompany.CompanyShortName;
				newCompany.CompanyType = newCompany.CompanyType;
				newCompany.CompanyActivity = newCompany.CompanyActivity;
				newCompany.CompanyTaxID = newCompany.CompanyTaxID;
				newCompany.CompanyTaxOffice = newCompany.CompanyTaxOffice;
				newCompany.CompanyTelephone = newCompany.CompanyTelephone;
				newCompany.CompanyWebsite = newCompany.CompanyWebsite;
				newCompany.CompanyPresentationEmbeddedVideo = newCompany.CompanyPresentationEmbeddedVideo;
				newCompany.CompanyWebsiteAnnouncements = newCompany.CompanyWebsiteAnnouncements;
				newCompany.CompanyWebsiteJobs = newCompany.CompanyWebsiteJobs;
				newCompany.AtlasID = newCompany.AtlasID;
				newCompany.SvseID = newCompany.SvseID;
				newCompany.SvseDate = newCompany.SvseDate;
				newCompany.CompanyActivity = string.Join(",", selectedActivities);

				// Address Information
				newCompany.CompanyCountry = newCompany.CompanyCountry;
				newCompany.CompanyLocation = newCompany.CompanyLocation;
				newCompany.CompanyPC = newCompany.CompanyPC;
				newCompany.CompanyRegions = newCompany.CompanyRegions;
				newCompany.CompanyTown = newCompany.CompanyTown;

				// CompanyModel Description and Areas/Skills
				newCompany.CompanyDescription = newCompany.CompanyDescription;
				newCompany.CompanyAreas = string.Join(",", selectedAreasForCompany.Select(a => a.FullName).Where(a => !string.IsNullOrWhiteSpace(a)));
				newCompany.CompanyDesiredSkills = string.Join(",", selectedSkillsForAssessment.Select(s => s.SkillName).Where(s => !string.IsNullOrWhiteSpace(s)));

				// Platform Management Info
				newCompany.CompanyCEOName = newCompany.CompanyCEOName;
				newCompany.CompanyCEOSurname = newCompany.CompanyCEOSurname;
				newCompany.CompanyCEOTaxID = newCompany.CompanyCEOTaxID;
				newCompany.CompanyHRName = newCompany.CompanyHRName;
				newCompany.CompanyHRSurname = newCompany.CompanyHRSurname;
				newCompany.CompanyHREmail = newCompany.CompanyHREmail;
				newCompany.CompanyHRTelephone = newCompany.CompanyHRTelephone;
				newCompany.CompanyAdminName = newCompany.CompanyAdminName;
				newCompany.CompanyAdminSurname = newCompany.CompanyAdminSurname;
				newCompany.CompanyAdminEmail = newCompany.CompanyAdminEmail;
				newCompany.CompanyAdminTelephone = newCompany.CompanyAdminTelephone;

				// CompanyModel Activity Info
				newCompany.CompanyEmployees = newCompany.CompanyEmployees;
				newCompany.CompanEmployeesLastUpdate = newCompany.CompanEmployeesLastUpdate;
				newCompany.CompanyTurnover = newCompany.CompanyTurnover;
				newCompany.CompanyTurnoverLastUpdate = newCompany.CompanyTurnoverLastUpdate;
				newCompany.CompanyExportCountriesNumber = newCompany.CompanyExportCountriesNumber;
				newCompany.CompanyExportCountries = newCompany.CompanyExportCountries;
				newCompany.CompanyExportCountriesLastUpdate = newCompany.CompanyExportCountriesLastUpdate;
				newCompany.CompanyVisibleActivity = newCompany.CompanyVisibleActivity;

				dbContext.Companies.Add(newCompany);
			}

			// Save all changes to the company first
			await dbContext.SaveChangesAsync();

			await UpdateProgressWhenUpdateCompanyRegistration(70, 200);

			updated = true;

			// Step 3: Update related records if company name changed
			await UpdateProgressWhenUpdateCompanyRegistration(80, 200);

			// If this was an update and the company name changed, update all related jobs/thesis/internships/events
			if (isRegistered && originalCompanyName != newCompany.CompanyName && !string.IsNullOrEmpty(companyEmail))
			{
				await UpdateAllJobsForCompany(dbContext, companyEmail, newCompany.CompanyName);
				await UpdateAllThesesForCompany(dbContext, companyEmail, newCompany.CompanyName);
				await UpdateAllInternshipsForCompany(dbContext, companyEmail, newCompany.CompanyName);
				await UpdateAllEventsForCompany(dbContext, companyEmail, newCompany.CompanyName);
			}

			Console.WriteLine($"Updating jobs for {companyEmail} from {originalCompanyName} to {newCompany.CompanyName}");

			await UpdateProgressWhenUpdateCompanyRegistration(100, 200);

			// Small delay to show completion
			await Task.Delay(500);

			showLoadingModalWhenUpdateCompanyRegistration = false;
			StateHasChanged();

			await Task.Delay(100); // Small delay for smooth transition

			// Show the navigation loader
			await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");

			// Give time for loader to render
			await Task.Delay(300);

			// Step 4: Navigate
			NavigationManager.NavigateTo("/", forceLoad: true);
		}
		catch (Exception ex)
		{
			// Hide loading modal on error
			showLoadingModalWhenUpdateCompanyRegistration = false;
			StateHasChanged();

			error = true;
			showValidationError = true;
			errorMessage = "Σφάλμα κατά την ενημέρωση. Παρακαλώ δοκιμάστε ξανά.";
			Console.Error.WriteLine(ex);
			return;
		}
		finally
		{
			// Reset validation after success or error
			await Task.Delay(3000);
			companyNameInputClass = "";
			companyNameENGInputClass = "";
			companyTypeInputClass = "";
			companyActivityInputClass = "";
			companyTelephoneInputClass = "";
			companyWebsiteInputClass = "";
			companyCountryInputClass = "";
			companyLocationInputClass = "";
			companyPCInputClass = "";
			companyRegionsInputClass = "";
			companyTownInputClass = "";
			companyHRNameInputClass = "";
			companyHRSurnameInputClass = "";
			companyHREmailInputClass = "";
			companyHRTelephoneInputClass = "";
			companyDescriptionInputClass = "";
			companyAreasInputClass = "";
			errorMessage = "";
		}
	}

	// Helper method for company registration update
	private async Task UpdateProgressWhenUpdateCompanyRegistration(int current, int total)
	{
		loadingProgressWhenUpdateCompanyRegistration = (int)((double)current / total * 100);
		StateHasChanged();
		await Task.Delay(50);
	}

	private async Task UpdateAllJobsForCompany(AppDbContext dbContext, string companyEmail, string newCompanyName)
	{
		// First get the company entity
		var company = await dbContext.Companies
			.FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

		if (company == null)
		{
			// Handle case where company doesn't exist
			return;
		}

		// Update the company name
		company.CompanyName = newCompanyName;

		// Get all jobs for this company to update tracking fields
		var companyJobs = await dbContext.CompanyJobs
			.Where(j => j.EmailUsedToUploadJobs == companyEmail)
			.ToListAsync();

		// Update tracking fields for each job
		foreach (var job in companyJobs)
		{
			job.TimesUpdated++;
			job.UpdateDateTime = DateTime.Now;
		}

		// Save all changes (both company name and job updates)
		await dbContext.SaveChangesAsync();
	}

	private async Task UpdateAllThesesForCompany(AppDbContext dbContext, string companyEmail, string newCompanyName)
	{
		// No need to update thesis records directly since company name comes from CompanyModel table
		// Just update the times updated and update datetime
    
		var theses = await dbContext.CompanyTheses
			.Where(t => t.CompanyEmailUsedToUploadThesis == companyEmail)
			.ToListAsync();

		foreach (var thesis in theses)
		{
			thesis.CompanyThesisTimesUpdated++;
			thesis.CompanyThesisUpdateDateTime = DateTime.Now;
		}

		await dbContext.SaveChangesAsync();
	}

	private async Task UpdateAllInternshipsForCompany(AppDbContext dbContext, string companyEmail, string newCompanyName)
	{
		// Include the CompanyModel navigation property to ensure we can access it
		var internships = await dbContext.CompanyInternships
			.Include(i => i.Company)  // Important: Include the CompanyModel navigation property
			.Where(i => i.CompanyEmailUsedToUploadInternship == companyEmail)
			.ToListAsync();

		foreach (var internship in internships)
		{
			if (internship.Company != null)
			{
				internship.Company.CompanyName = newCompanyName;  // Update the CompanyModel's name
			}
			internship.CompanyInternshipLastUpdate = DateTime.Now;
		}

		await dbContext.SaveChangesAsync();
	}

	private async Task UpdateAllEventsForCompany(AppDbContext dbContext, string companyEmail, string newCompanyName)
	{
		var events = await dbContext.CompanyEvents
			.Include(e => e.Company)  // Include the CompanyModel navigation property
			.Where(e => e.CompanyEmailUsedToUploadEvent == companyEmail)
			.ToListAsync();

		foreach (var eventItem in events)
		{
			// Update the company name through the navigation property
			if (eventItem.Company != null)
			{
				eventItem.Company.CompanyName = newCompanyName;
			}
		}

		await dbContext.SaveChangesAsync();
	}


	private async Task AgreeToTermsAsync()
	{
		try
		{
			Logger.LogInformation("Agree button clicked.");
			customCheckbox?.SetValue(true);
			agreeTerms = true;
			await Task.Delay(10); // Optional: to simulate asynchronous delay
			StateHasChanged();
			Logger.LogInformation("Agree operation completed.");
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "Error during AgreeToTermsAsync");
		}
	}

	private async Task DeclineTermsAsync()
	{
		try
		{
			Logger.LogInformation("Decline button clicked.");
			customCheckbox?.SetValue(false);
			agreeTerms = false;
			await Task.Delay(10); // Optional: to simulate asynchronous delay
			StateHasChanged();
			Logger.LogInformation("Decline operation completed.");
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "Error during DeclineTermsAsync");
		}
	}

	private void FilterAvailableAreas(ChangeEventArgs e)
	{
		areassearchTerm = e.Value?.ToString() ?? "";

		var selectedAreaNames = selectedAreasForCompany
			.Where(item => !item.IsSubField)
			.Select(item => item.FullName)
			.ToList();

		if (string.IsNullOrWhiteSpace(areassearchTerm))
		{
			filteredAreas = availableAreas
				.Where(area => !selectedAreaNames.Contains(area.AreaName))
				.ToList();
			expandedAreas.Clear();
		}
		else
		{
			var searchTerm = areassearchTerm.Trim();

			// Clear previous expansions
			expandedAreas.Clear();

			filteredAreas = availableAreas
				.Where(area => !selectedAreaNames.Contains(area.AreaName))
				.Where(area =>
					area.AreaName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
					(area.AreaSubFields != null &&
						area.AreaSubFields.Split(',')
						.Any(subField => subField.Trim()
							.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
				)
				.ToList();

			// Check if search term doesn't match any existing area (potential custom area)
			var isPotentialCustomArea = !availableAreas.Any(a =>
				a.AreaName.Equals(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
				!selectedAreaNames.Contains(searchTerm);

			if (isPotentialCustomArea && filteredAreas.Count == 0)
			{
				Console.WriteLine($"Potential custom area detected: {searchTerm}");
			}

			// Expand areas that have matching subfields
			foreach (var area in filteredAreas)
			{
				bool hasMatchingSubfield = area.AreaSubFields != null &&
					area.AreaSubFields.Split(',')
						.Any(subField => subField.Trim()
							.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

				if (hasMatchingSubfield)
				{
					expandedAreas.Add(area.AreaName);
				}
			}
		}

		StateHasChanged();
	}



	private void FilterAvailableSkills(ChangeEventArgs e)
	{
		skillSearchTerm = e.Value?.ToString() ?? "";

		if (string.IsNullOrWhiteSpace(skillSearchTerm))
		{
			filteredSkills = availableSkills
				.Where(skill => !selectedSkillsForCompany.Contains(skill))
				.ToList();
		}
		else
		{
			var searchTerm = skillSearchTerm.Trim();
			filteredSkills = availableSkills
				.Where(skill => !selectedSkillsForCompany.Contains(skill))
				.Where(skill => skill.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
				.ToList();

			// Check if search term doesn't match any existing skill (potential custom skill)
			var isPotentialCustomSkill = !availableSkills.Any(s =>
				s.Equals(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
				!selectedSkillsForCompany.Contains(searchTerm);

			if (isPotentialCustomSkill && filteredSkills.Count == 0)
			{
				Console.WriteLine($"Potential custom skill detected: {searchTerm}");
			}
		}

		StateHasChanged();
	}



	private void OnAreaSelect(ChangeEventArgs e)
	{
		var selectedArea = e.Value.ToString();

		// If the area is selected, add it to the expanded areas
		if (expandedAreas.Contains(selectedArea))
		{
			expandedAreas.Remove(selectedArea); // Collapse the area
		}
		else
		{
			expandedAreas.Add(selectedArea); // Expand the area
		}

		// Re-trigger the UI to reflect changes
		StateHasChanged(); // Notify the UI to refresh
	}

	// Method to toggle the expansion of the selected area
	private void ToggleExpansion(string areaName)
	{
		if (expandedAreas.Contains(areaName))
		{
			expandedAreas.Remove(areaName);
		}
		else
		{
			expandedAreas.Add(areaName);
		}
		StateHasChanged();
	}

	private string GetValidationClassForEmptyAreasWhenSaveCompanyRegistration(int areasCount)
	{
		return areasCount == 0 && showValidationError ? "shake error" : "";
	}

	private string GetYoutubeEmbedUrl(string url)
	{
		if (string.IsNullOrEmpty(url))
			return string.Empty;

		var match = Regex.Match(url, @"(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})");
		if (match.Success)
		{
			string videoId = match.Groups[2].Value;
			return $"https://www.youtube.com/embed/{videoId}";
		}

		return string.Empty;
	}

	private void ShowMessage()
	{
		if (!agreeTerms)
		{
			showMessage = true;
		}
		else
		{
			showMessage = false;
		}
	}

	private void FilterActivities()
	{
		if (string.IsNullOrEmpty(activitySearchTerm))
		{
			filteredActivities = Activity;
		}
		else
		{
			filteredActivities = Activity
				.Where(a => a.Contains(activitySearchTerm, StringComparison.OrdinalIgnoreCase))
				.ToList();
		}
    
		StateHasChanged(); // Ensure UI updates
	}

	// Toggle activity selection
	private void ToggleActivity(string activity)
	{
		if (selectedActivities.Contains(activity))
		{
			selectedActivities.Remove(activity);
		}
		else
		{
			selectedActivities.Add(activity);
		}

		// Update the bound property
		newCompany.CompanyActivity = string.Join(",", selectedActivities);
		StateHasChanged();
	}

	private void RemoveActivity(string activity)
	{
		selectedActivities.Remove(activity);
		newCompany.CompanyActivity = string.Join(",", selectedActivities);
		StateHasChanged();
	}


	private void ToggleActivityDropdown()
	{
		showActivityDropdown = !showActivityDropdown;
		if (showActivityDropdown)
		{
			activitySearchTerm = string.Empty;
			FilterActivities();
		}
	}

	private void SelectAllActivities()
	{
		selectedActivities = new List<string>(Activity);
		newCompany.CompanyActivity = string.Join(",", selectedActivities);
		StateHasChanged();
	}

	private void ClearAllActivities()
	{
		selectedActivities.Clear();
		newCompany.CompanyActivity = string.Empty;
		StateHasChanged();
	}

	private void HandleSearchInput(ChangeEventArgs e)
	{
		activitySearchTerm = e.Value?.ToString() ?? string.Empty;
		FilterActivities();
	}

	private void ClearSearchSelection()
	{
		ClearSelectElementSelection("availableAreas");
	}

	private async void ClearSelectElementSelection(string elementId)
	{
		try
		{
			await JSRuntime.InvokeVoidAsync("clearSelection", elementId);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error clearing selection: {ex.Message}");
		}
	}

	private async Task AddCustomAreaFromSearch()
	{
		if (!string.IsNullOrWhiteSpace(areassearchTerm))
		{
			var customAreaName = areassearchTerm.Trim();

			// Check if this is not already in available areas (custom area)
			var isCustomArea = !availableAreas.Any(a =>
				a.AreaName.Equals(customAreaName, StringComparison.OrdinalIgnoreCase));

			if (isCustomArea)
			{
				// Add the custom area
				AddAreaToSelected(customAreaName, false);
				Console.WriteLine($"Added custom area: {customAreaName}");

				// Clear search term
				areassearchTerm = "";

				// Validate and update UI
				ValidateSelectedAreas();
				EnsureUniqueSelectedAreas();
				FilterAvailableAreasBasedOnSelection();
				StateHasChanged();
			}
			else
			{
				Console.WriteLine($"Area '{customAreaName}' already exists in the list.");
			}
		}
	}

	private void OnAvailableAreaSelectionChanged(ChangeEventArgs e)
	{
		var selectedValues = e.Value as string[];
		selectedAvailableItems = selectedValues?.ToList() ?? new List<string>();
	}

	private void OnSelectedAreaSelectionChanged(ChangeEventArgs e)
	{
		var selectedValues = e.Value as string[];
		selectedSelectedItems = selectedValues?.ToList() ?? new List<string>();
	}


	private void AddAreaToSelected(string name, bool isSubField)
	{
		var parentArea = "";
		if (isSubField)
		{
			parentArea = FindParentArea(name);
			if (string.IsNullOrEmpty(parentArea))
			{
				parentArea = "Unknown";
			}
		}

		// Strong duplicate check with detailed logging
		if (!CanAddArea(name, isSubField, parentArea))
		{
			Console.WriteLine($"BLOCKED: Attempt to add duplicate - Name: {name}, IsSubField: {isSubField}, Parent: {parentArea}");
			return;
		}

		var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{name}" : $"AREA_{name}";

		// Final safety check
		if (selectedAreasForCompany.Any(item => item.UniqueId == uniqueId))
		{
			Console.WriteLine($"SAFETY CHECK FAILED: Item with ID {uniqueId} already exists");
			return;
		}

		var newItem = new AreaItem
			{
				FullName = name,
				DisplayName = name,
				IsSubField = isSubField,
				ParentArea = parentArea
			};

		selectedAreasForCompany.Add(newItem);
		Console.WriteLine($"SUCCESS: Added area - UniqueId: {newItem.UniqueId}, Name: {name}, Type: {(isSubField ? "Subfield" : "Area")}, Custom: {!isSubField && !availableAreas.Any(a => a.AreaName.Equals(name, StringComparison.OrdinalIgnoreCase))}");
	}

	private bool CanAddArea(string name, bool isSubField, string parentArea = "")
	{
		var cleanName = name.Trim();
		var uniqueId = isSubField ? $"SUBFIELD_{parentArea}_{cleanName}" : $"AREA_{cleanName}";

		Console.WriteLine($"Checking if can add company area: '{cleanName}' as {(isSubField ? "subfield" : "area")}, Parent: '{parentArea}'");

		// 1. Check if an item with this unique ID already exists
		if (selectedAreasForCompany.Any(item => item.UniqueId == uniqueId))
		{
			Console.WriteLine($"❌ Cannot add company area: {cleanName} - already exists with ID: {uniqueId}");
			return false;
		}

		// 2. Prevent adding subfield with same name as existing area (case insensitive)
		if (isSubField && selectedAreasForCompany.Any(item => !item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
		{
			Console.WriteLine($"❌ Cannot add company subfield: {cleanName} - an area with the same name already exists");
			return false;
		}

		// 3. Prevent adding area with same name as existing subfield (case insensitive)
		if (!isSubField && selectedAreasForCompany.Any(item => item.IsSubField && item.FullName.Equals(cleanName, StringComparison.OrdinalIgnoreCase)))
		{
			Console.WriteLine($"❌ Cannot add company area: {cleanName} - a subfield with the same name already exists");
			return false;
		}

		// 4. Check for custom area vs subfield conflicts
		if (!isSubField)
		{
			// Check if this name exists as a subfield in ANY available area (not just selected ones)
			bool existsAsSubfieldInAvailableAreas = availableAreas.Any(area =>
				area.AreaSubFields?.Split(',')
					.Any(subField => subField.Trim().Equals(cleanName, StringComparison.OrdinalIgnoreCase)) == true);

			if (existsAsSubfieldInAvailableAreas)
			{
				Console.WriteLine($"❌ Cannot add company area: {cleanName} - this name exists as a subfield in available areas");
				return false;
			}

			// For regular areas (not custom), check if any of their subfields are already selected
			bool existsAsMainAreaInAvailable = availableAreas.Any(area =>
				area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

			if (existsAsMainAreaInAvailable)
			{
				// This is a regular area (not custom), check if its subfields are selected
				var area = availableAreas.First(a => a.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));
				if (area.AreaSubFields != null)
				{
					var subFields = area.AreaSubFields.Split(',');
					foreach (var subField in subFields)
					{
						var subFieldName = subField.Trim();
						var subFieldUniqueId = $"SUBFIELD_{cleanName}_{subFieldName}";

						if (selectedAreasForCompany.Any(item => item.UniqueId == subFieldUniqueId))
						{
							Console.WriteLine($"❌ Cannot add company area: {cleanName} - its subfield '{subFieldName}' is already selected");
							return false;
						}
					}
				}
			}
		}
		else
		{
			// For subfields: check if parent area is already selected
			if (!string.IsNullOrEmpty(parentArea))
			{
				var parentUniqueId = $"AREA_{parentArea}";
				if (selectedAreasForCompany.Any(item => item.UniqueId == parentUniqueId))
				{
					Console.WriteLine($"❌ Cannot add company subfield: {cleanName} - parent area '{parentArea}' is already selected");
					return false;
				}
			}

			// Also check if this subfield name exists as a main area in available areas
			bool existsAsMainArea = availableAreas.Any(area =>
				area.AreaName.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

			if (existsAsMainArea)
			{
				Console.WriteLine($"❌ Cannot add company subfield: {cleanName} - this name exists as a main area in available areas");
				return false;
			}
		}

		Console.WriteLine($"✅ Can add company area: {cleanName} as {(isSubField ? "subfield" : "area")}");
		return true;
	}


	private void ValidateSelectedAreas()
	{
		Console.WriteLine("=== VALIDATING SELECTED AREAS ===");

		var uniqueIds = new HashSet<string>();
		var duplicates = new List<string>();

		foreach (var item in selectedAreasForCompany)
		{
			Console.WriteLine($"Item: {item.FullName}, IsSubField: {item.IsSubField}, Parent: {item.ParentArea}, UniqueId: {item.UniqueId}");

			if (!uniqueIds.Add(item.UniqueId))
			{
				duplicates.Add(item.UniqueId);
			}
		}

		if (duplicates.Any())
		{
			Console.WriteLine($"FOUND DUPLICATES: {string.Join(", ", duplicates)}");
			EnsureUniqueSelectedAreas();
		}
		else
		{
			Console.WriteLine("No duplicates found - validation passed");
		}
		Console.WriteLine($"Total items: {selectedAreasForCompany.Count}");
		Console.WriteLine("=== VALIDATION COMPLETE ===");
	}

	private void EnsureUniqueSelectedAreas()
	{
		var beforeCount = selectedAreasForCompany.Count;
		selectedAreasForCompany = selectedAreasForCompany
			.GroupBy(a => a.UniqueId)
			.Select(g => g.First())
			.ToList();

		var afterCount = selectedAreasForCompany.Count;
		if (beforeCount != afterCount)
		{
			Console.WriteLine($"Removed {beforeCount - afterCount} duplicate areas");
		}
	}

	private void FilterAvailableAreasBasedOnSelection()
	{
		// Filter out only predefined main areas that are selected
		var selectedMainAreaNames = selectedAreasForCompany
			.Where(item => !item.IsSubField)
			.Select(item => item.FullName)
			.ToList();

		// filteredAreas should contain all predefined areas EXCEPT those that are selected
		filteredAreas = availableAreas
			.Where(area => !selectedMainAreaNames.Contains(area.AreaName))
			.ToList();

		Console.WriteLine($"Available areas: {availableAreas.Count}, Filtered areas: {filteredAreas.Count}, Selected areas: {selectedAreasForCompany.Count}");
	}



	private bool IsCustomArea(string areaName)
	{
		bool isSubfieldOfAvailableArea = availableAreas.Any(area =>
			area.AreaSubFields?.Split(',').Any(subField =>
				subField.Trim().Equals(areaName, StringComparison.OrdinalIgnoreCase)) == true);

		bool existsAsMainArea = availableAreas.Any(area =>
			area.AreaName.Equals(areaName, StringComparison.OrdinalIgnoreCase));

		return !isSubfieldOfAvailableArea && !existsAsMainArea;
	}


	private string FindParentAreaFromAvailableAreas(string subFieldName)
	{
		foreach (var area in availableAreas)
		{
			var subFields = area.AreaSubFields?.Split(',');
			if (subFields != null && subFields.Any(sf => sf.Trim() == subFieldName))
			{
				return area.AreaName;
			}
		}
		return "Unknown";
	}

	private string FindParentArea(string subFieldName)
	{
		foreach (var area in availableAreas)
		{
			var subFields = area.AreaSubFields?.Split(',');
			if (subFields != null && subFields.Any(sf => sf.Trim().Equals(subFieldName, StringComparison.OrdinalIgnoreCase)))
			{
				return area.AreaName;
			}
		}
		return "";
	}

	private void ClearSkillSearchSelection()
	{
		ClearSelectElementSelection("availableSkills");
	}

	private async Task AddCustomSkillFromSearch()
	{
		if (!string.IsNullOrWhiteSpace(skillSearchTerm))
		{
			var customSkillName = skillSearchTerm.Trim();

			// Check if this is not already in available skills (custom skill)
			var isCustomSkill = !availableSkills.Any(s =>
				s.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

			if (isCustomSkill)
			{
				AddSkillToSelected(customSkillName);
				Console.WriteLine($"Added custom skill: {customSkillName}");

				// Clear search term
				skillSearchTerm = "";

				// Update UI
				FilterAvailableSkillsBasedOnSelection();
				StateHasChanged();
			}
			else
			{
				Console.WriteLine($"Skill '{customSkillName}' already exists in the list.");
			}
		}
	}

	private void AddSkillToSelected(string skillName)
	{
		if (!selectedSkillsForCompany.Contains(skillName))
		{
			selectedSkillsForCompany.Add(skillName);
			Console.WriteLine($"SUCCESS: Added skill: {skillName}, Custom: {IsCustomSkill(skillName)}");
		}
		else
		{
			Console.WriteLine($"BLOCKED: Attempt to add duplicate skill: {skillName}");
		}
	}

	private void FilterAvailableSkillsBasedOnSelection()
	{
		filteredSkills = availableSkills
			.Where(skill => !selectedSkillsForCompany.Contains(skill))
			.ToList();

		Console.WriteLine($"Available skills: {availableSkills.Count}, Filtered skills: {filteredSkills.Count}, Selected skills: {selectedSkillsForCompany.Count}");
	}

	private void OnAvailableSkillSelectionChanged(ChangeEventArgs e)
	{
		var selectedValues = e.Value as string[];
		selectedAvailableSkillItems = selectedValues?.ToList() ?? new List<string>();
	}

	private void OnSelectedSkillSelectionChanged(ChangeEventArgs e)
	{
		var selectedValues = e.Value as string[];
		selectedSelectedSkillItems = selectedValues?.ToList() ?? new List<string>();
	}

	private async Task MoveSelectedSkillToRight()
	{
		Console.WriteLine("=== MOVING SKILLS TO RIGHT ===");

		var skillsToAdd = new List<string>();

		// First, check if we should add a custom skill from search term
		if (!string.IsNullOrWhiteSpace(skillSearchTerm))
		{
			// Check if there are actually any selected items in the listbox
			var selectedOptions = await JSRuntime.InvokeAsync<string[]>("getSelectedOptions", "availableSkills");

			// If no items are selected in the listbox, treat the search term as custom skill
			if (selectedOptions.Length == 0)
			{
				var customSkillName = skillSearchTerm.Trim();

				// Check if this is not already in available skills (custom skill)
				var isCustomSkill = !availableSkills.Any(s =>
					s.Equals(customSkillName, StringComparison.OrdinalIgnoreCase));

				if (isCustomSkill)
				{
					skillsToAdd.Add(customSkillName);
					Console.WriteLine($"Will add custom skill: {customSkillName}");

					// Clear search term after adding custom skill
					skillSearchTerm = "";
				}
			}
			else
			{
				// There are selected items, so process them normally
				foreach (var selectedValue in selectedOptions)
				{
					skillsToAdd.Add(selectedValue);
					Console.WriteLine($"Will add skill: {selectedValue}");
				}
			}
		}
		else
		{
			// No search term, process selected items normally
			foreach (var selectedValue in selectedAvailableSkillItems)
			{
				skillsToAdd.Add(selectedValue);
				Console.WriteLine($"Will add skill: {selectedValue}");
			}
		}

		// Add all collected skills
		foreach (var skill in skillsToAdd)
		{
			AddSkillToSelected(skill);
		}

		// Cleanup
		FilterAvailableSkillsBasedOnSelection();
		selectedAvailableSkillItems.Clear();

		StateHasChanged();
	}

	private void MoveSelectedSkillToLeft()
	{
		var skillsToRemove = new List<string>();

		foreach (var selectedValue in selectedSelectedSkillItems)
		{
			skillsToRemove.Add(selectedValue);
		}

		foreach (var skillToRemove in skillsToRemove)
		{
			selectedSkillsForCompany.Remove(skillToRemove);
		}

		FilterAvailableSkillsBasedOnSelection();
		selectedSelectedSkillItems.Clear();
		StateHasChanged();
	}

	private bool IsCustomSkill(string skillName)
	{
		return !availableSkills.Any(s => s.Equals(skillName, StringComparison.OrdinalIgnoreCase));
	}

	private void OnCompanyTelephoneInput(ChangeEventArgs e)
	{
		var input = e.Value?.ToString() ?? "";
		newCompany.CompanyTelephone = CleanPhoneNumber(input);
		StateHasChanged();
	}

	private void OnCompanyHRTelephoneInput(ChangeEventArgs e)
	{
		var input = e.Value?.ToString() ?? "";
		newCompany.CompanyHRTelephone = CleanPhoneNumber(input);
		StateHasChanged();
	}

	private string CleanPhoneNumber(string input)
	{
		if (string.IsNullOrEmpty(input))
			return "";

		var cleaned = new StringBuilder();
		bool hasPlus = false;

		foreach (char c in input)
		{
			if (c == '+' && cleaned.Length == 0)
			{
				cleaned.Append(c);
				hasPlus = true;
			}
			else if (char.IsDigit(c))
			{
				// Limit to 12 digits total (excluding the + sign)
				int currentDigits = cleaned.Length - (hasPlus ? 1 : 0);
				if (currentDigits < 12)
				{
					cleaned.Append(c);
				}
			}
		}

		return cleaned.ToString();
	}

}
