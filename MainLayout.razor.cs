using Microsoft.AspNetCore.Components;


namespace QuizManager.Shared.Components
{
    public partial class MainLayout : LayoutComponentBase
    {
        private ResearchGroup currentResearchGroup;

        // Properties for Research Group search
        private string searchResearchGroupNameAsCompanyToFindResearchGroup = "";
        private string searchResearchGroupSchoolAsCompanyToFindResearchGroup = "";
        private string searchResearchGroupUniversityDepartmentAsCompanyToFindResearchGroup = "";
        private string searchResearchGroupAreasAsCompanyToFindResearchGroup = "";
        private string searchResearchGroupSkillsAsCompanyToFindResearchGroup = "";
        private string searchResearchGroupKeywordsAsCompanyToFindResearchGroup = "";
        private bool hasSearchedForResearchGroups = false;


        private List<string> researchgroupNameSuggestions = new List<string>();
        private List<string> researchGroupAreasSuggestions = new List<string>();
        private List<string> researchGroupSkillsSuggestions = new List<string>();
        private List<string> researchGroupKeywordsSuggestions = new List<string>();

        private List<string> selectedResearchGroupAreas = new List<string>();
        private List<string> selectedResearchGroupSkills = new List<string>();
        private List<string> selectedResearchGroupKeywords = new List<string>();

        private Dictionary<string, List<string>> universityDepartments = new()
        {
            ["ΑΓΡΟΤΙΚΗΣ ΑΝΑΠΤΥΞΗΣ, ΔΙΑΤΡΟΦΗΣ ΚΑΙ ΑΕΙΦΟΡΙΑΣ"] = new List<string>
            {
                "ΤΜΗΜΑ ΑΓΡΟΤΙΚΗΣ ΑΝΑΠΤΥΞΗΣ, ΑΓΡΟΔΙΑΤΡΟΦΗΣ ΚΑΙ ΔΙΑΧΕΙΡΙΣΗΣ ΦΥΣΙΚΩΝ ΠΟΡΩΝ"
            },
            ["ΕΠΙΣΤΗΜΩΝ ΑΓΩΓΗΣ"] = new List<string>
            {
                "ΠΑΙΔΑΓΩΓΙΚΟ ΤΜΗΜΑ ΔΗΜΟΤΙΚΗΣ ΕΚΠΑΙΔΕΥΣΗΣ",
                "ΤΜΗΜΑ ΕΚΠΑΙΔΕΥΣΗΣ ΚΑΙ ΑΓΩΓΗΣ ΣΤΗΝ ΠΡΟΣΧΟΛΙΚΗ ΗΛΙΚΙΑ"
            },
            ["ΕΠΙΣΤΗΜΩΝ ΥΓΕΙΑΣ"] = new List<string>
            {
                "ΤΜΗΜΑ ΙΑΤΡΙΚΗΣ",
                "ΤΜΗΜΑ ΝΟΣΗΛΕΥΤΙΚΗΣ",
                "ΤΜΗΜΑ ΟΔΟΝΤΙΑΤΡΙΚΗΣ",
                "ΤΜΗΜΑ ΦΑΡΜΑΚΕΥΤΙΚΗΣ"
            },
            ["ΕΠΙΣΤΗΜΗΣ ΦΥΣΙΚΗΣ ΑΓΩΓΗΣ ΚΑΙ ΑΘΛΗΤΙΣΜΟΥ"] = new List<string>
            {
                "ΤΜΗΜΑ ΕΠΙΣΤΗΜΗΣ ΦΥΣΙΚΗΣ ΑΓΩΓΗΣ ΚΑΙ ΑΘΛΗΤΙΣΜΟΥ"
            },
            ["ΘΕΟΛΟΓΙΚΗ"] = new List<string>
            {
                "ΤΜΗΜΑ ΘΕΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΚΟΙΝΩΝΙΚΗΣ ΘΕΟΛΟΓΙΑΣ ΚΑΙ ΘΡΗΣΚΕΙΟΛΟΓΙΑΣ"
            },
            ["ΘΕΤΙΚΩΝ ΕΠΙΣΤΗΜΩΝ"] = new List<string>
            {
                "ΤΜΗΜΑ ΑΕΡΟΔΙΑΣΤΗΜΙΚΗΣ ΕΠΙΣΤΗΜΗΣ ΚΑΙ ΤΕΧΝΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΒΙΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΓΕΩΛΟΓΙΑΣ ΚΑΙ ΓΕΩΠΕΡΙΒΑΛΛΟΝΤΟΣ",
                "ΤΜΗΜΑ ΙΣΤΟΡΙΑΣ ΚΑΙ ΦΙΛΟΣΟΦΙΑΣ ΤΗΣ ΕΠΙΣΤΗΜΗΣ",
                "ΤΜΗΜΑ ΜΑΘΗΜΑΤΙΚΩΝ",
                "ΤΜΗΜΑ ΠΛΗΡΟΦΟΡΙΚΗΣ ΚΑΙ ΤΗΛΕΠΙΚΟΙΝΩΝΙΩΝ",
                "ΤΜΗΜΑ ΤΕΧΝΟΛΟΓΙΩΝ ΨΗΦΙΑΚΗΣ ΒΙΟΜΗΧΑΝΙΑΣ",
                "ΤΜΗΜΑ ΦΥΣΙΚΗΣ",
                "ΤΜΗΜΑ ΧΗΜΕΙΑΣ"
            },
            ["ΝΟΜΙΚΗ"] = new List<string>
            {
                "ΝΟΜΙΚΗ ΣΧΟΛΗ"
            },
            ["ΟΙΚΟΝΟΜΙΚΩΝ ΚΑΙ ΠΟΛΙΤΙΚΩΝ ΕΠΙΣΤΗΜΩΝ"] = new List<string>
            {
                "ΤΜΗΜΑ ΔΙΑΧΕΙΡΙΣΗΣ ΛΙΜΕΝΩΝ ΚΑΙ ΝΑΥΤΙΛΙΑΣ",
                "ΤΜΗΜΑ ΕΠΙΚΟΙΝΩΝΙΑΣ ΚΑΙ ΜΕΣΩΝ ΜΑΖΙΚΗΣ ΕΝΗΜΕΡΩΣΗΣ",
                "ΤΜΗΜΑ ΟΙΚΟΝΟΜΙΚΩΝ ΕΠΙΣΤΗΜΩΝ",
                "ΤΜΗΜΑ ΠΟΛΙΤΙΚΗΣ ΕΠΙΣΤΗΜΗΣ ΚΑΙ ΔΗΜΟΣΙΑΣ ΔΙΟΙΚΗΣΗΣ",
                "ΤΜΗΜΑ ΤΟΥΡΚΙΚΩΝ ΣΠΟΥΔΩΝ ΚΑΙ ΣΥΓΧΡΟΝΩΝ ΑΣΙΑΤΙΚΩΝ ΣΠΟΥΔΩΝ",
                "ΤΜΗΜΑ ΔΙΟΙΚΗΣΗΣ ΕΠΙΧΕΙΡΗΣΕΩΝ ΚΑΙ ΟΡΓΑΝΙΣΜΩΝ",
                "ΤΜΗΜΑ ΚΟΙΝΩΝΙΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΨΗΦΙΑΚΩΝ ΤΕΧΝΩΝ ΚΑΙ ΚΙΝΗΜΑΤΟΓΡΑΦΟΥ"
            },
            ["ΦΙΛΟΣΟΦΙΚΗ"] = new List<string>
            {
                "ΠΑΙΔΑΓΩΓΙΚΟ ΤΜΗΜΑ ΔΕΥΤΕΡΟΒΑΘΜΙΑΣ ΕΚΠΑΙΔΕΥΣΗΣ",
                "ΤΜΗΜΑ ΑΓΓΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΓΑΛΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΓΕΡΜΑΝΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΘΕΑΤΡΙΚΩΝ ΣΠΟΥΔΩΝ",
                "ΤΜΗΜΑ ΙΣΠΑΝΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΙΣΤΟΡΙΑΣ ΚΑΙ ΑΡΧΑΙΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΙΤΑΛΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΜΟΥΣΙΚΩΝ ΣΠΟΥΔΩΝ",
                "ΤΜΗΜΑ ΡΩΣΙΚΗΣ ΓΛΩΣΣΑΣ ΚΑΙ ΦΙΛΟΛΟΓΙΑΣ ΚΑΙ ΣΛΑΒΙΚΩΝ ΣΠΟΥΔΩΝ",
                "ΤΜΗΜΑ ΦΙΛΟΛΟΓΙΑΣ",
                "ΤΜΗΜΑ ΦΙΛΟΣΟΦΙΑΣ",
                "ΤΜΗΜΑ ΨΥΧΟΛΟΓΙΑΣ"
            }
        };

        // Property to get the list of schools for the dropdown
        private List<string> researchGroupSchools => universityDepartments.Keys.ToList();

        // Property to get the filtered departments based on selected school
        private List<string> filteredDepartments => 
            string.IsNullOrEmpty(searchResearchGroupSchoolAsCompanyToFindResearchGroup) 
                ? new List<string>() 
                : universityDepartments.ContainsKey(searchResearchGroupSchoolAsCompanyToFindResearchGroup)
                    ? universityDepartments[searchResearchGroupSchoolAsCompanyToFindResearchGroup]
                    : new List<string>();

        // Property to get the filtered departments based on selected school for Professor
        private List<string> professorFilteredDepartmentsForSearchForResearchGroup => 
            string.IsNullOrEmpty(searchResearchGroupSchoolAsProfessorToFindResearchGroup) 
                ? new List<string>() 
                : universityDepartments.ContainsKey(searchResearchGroupSchoolAsProfessorToFindResearchGroup)
                    ? universityDepartments[searchResearchGroupSchoolAsProfessorToFindResearchGroup]
                    : new List<string>();

        // Method to handle school selection change
        private async Task OnSchoolSelectionChanged(ChangeEventArgs e)
        {
            searchResearchGroupSchoolAsCompanyToFindResearchGroup = e.Value?.ToString() ?? "";
            // Clear department selection when school changes
            searchResearchGroupUniversityDepartmentAsCompanyToFindResearchGroup = "";
            await InvokeAsync(StateHasChanged);
        }
        // Search results and pagination
        private List<ResearchGroup> searchResultsAsCompanyToFindResearchGroup = new List<ResearchGroup>();
        private ResearchGroup selectedResearchGroupWhenSearchForResearchGroupsAsCompany;
        private bool showResearchGroupDetailsModalWhenSearchForResearchGroupsAsCompany = false;

        private int currentResearchGroupPage_SearchForResearchGroupsAsCompany = 1;
        private int ResearchGroupsPerPage_SearchForResearchGroupsAsCompany = 10;
        private List<int> pageSizeOptions_SearchForResearchGroupsAsCompany = new List<int> { 10, 50, 100 };

        private bool isStatisticsVisible = false;
        private int? numberOfFacultyMembers;
        private int? numberOfCollaborators;
        private int? numberOfTotalPublications;
        private int? numberOfRecentPublications;
        private int? numberOfActiveResearchActions;
        private int? numberOfInactiveResearchActions;
        private int? numberOfActivePatents;
        private int? numberOfInactivePatents;

        // Add this method to toggle visibility
        private async Task ToggleStatisticsVisibility()
        {
            // First, toggle visibility immediately
            isStatisticsVisible = !isStatisticsVisible;
            
            // If we're showing the statistics, load the data asynchronously
            if (isStatisticsVisible)
            {
                await LoadResearchGroupStatistics();
            }
            
            StateHasChanged();
        }


        private List<StudentWithAuth0Details> StudentsWithAuth0Details { get; set; } = new();
        
        // ============================================================================
        // USER ROLE MANAGEMENT
        // ============================================================================
        // UserRole: Stores the current user's role (e.g., "Student", "Company", "Professor", "Admin", "Research Group")
        // - Defined here: Line 164
        // - Initialized in: OnInitializedAsync() at line 1295 from authentication claims
        // - Used in: ShouldShowAdminTable() at line 178, and in MainLayout.razor for conditional rendering
        // - Note: This is a private field. If components need access, consider making it public or passing as parameter
        private string UserRole = "";
        
        bool isStudentRegistered;
        bool isInitializedAsStudentUser = false;
        bool isCompanyRegistered;
        bool isInitializedAsCompanyUser = false;
        bool isProfessorRegistered;
        bool isInitializedAsProfessorUser = false;
        string CurrentUserEmail = "";
        private List<Student> Students = new List<Student>();
        bool isInitializedAsResearchGroupUser = false;
        bool isResearchGroupRegistered;

        // ============================================================================
        // USER ROLE USAGE: Admin Table Visibility
        // ============================================================================
        // Checks if admin table should be displayed based on UserRole
        // Used by: Admin.razor component via ShouldShowAdminTable() method
        private bool ShouldShowAdminTable()
        {
            return UserRole == "Admin" && !NavigationManager.Uri.Contains("/profile", StringComparison.OrdinalIgnoreCase);
        }

        private async Task LoadStudentsAsync()
        {
            try 
            {
                // 1. ISOLATE: Create a fresh context for this thread
                using var context = DbFactory.CreateDbContext();

                // 2. OPTIMIZE: Use AsNoTracking for read-only lists
                // This avoids the overhead of setting up change tracking for every student object
                Students = await context.Students
                    .AsNoTracking()
                    .ToListAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading students: {ex.Message}");
                Students = new List<Student>(); // Ensure list is never null to prevent UI crashes
            }
        }


        // ============================================================================
        // SHARED DATA STRUCTURES AND PROPERTIES
        // ============================================================================
        // These properties are used across multiple user roles or are shared infrastructure
        bool showThesisApplications = false;
        bool showInternships = false;
        bool showJobApplications = false;
        private Student userData;
        private List<ProfessorThesisApplied> thesisApplications;
        private List<ProfessorThesisApplied> professorthesisApplications;
        private List<CompanyThesisApplied> companythesisApplications;
        private List<CompanyJobApplied> jobApplications;
        List<CompanyJob> jobs = new List<CompanyJob>();
        List<CompanyThesis> companytheses = new List<CompanyThesis>();
        List<ProfessorThesis> professortheses = new List<ProfessorThesis>();
        List<AnnouncementAsCompany> announcements = new List<AnnouncementAsCompany>();
        List<ProfessorThesis> theses = new List<ProfessorThesis>();
        List<CompanyInternship> companyinternships = new List<CompanyInternship>();
        private bool ShowStudentRegistrationButton = false;
        private bool ShowCompanyRegistrationButton = false;
        private bool ShowProfessorRegistrationButton = false;
        private bool ShowAdminRegistrationButton = false;
        private bool isStudentStatsFormVisibleToShowStudentStatsAsAdmin = false;
        private bool isAnalyticsVisible = false;

        string thesisSearch = "";
        string jobSearch = "";
        string companyinternshipSearch = "";

        string companyinternshipSearchByTitle = "";
        string companyinternshipSearchByType = "";
        string companyinternshipSearchByESPA = "";
        string companyinternshipSearchByRegion = "";
        string jobSearchByTown = "";
        string jobSearchByRegion = "";
        string companyjobSearchByRegion = "";
        private string companyinternshipSearchByTown = "";
        private bool companyinternshipSearchByTransportOffer;
        private bool companyjobSearchByTransportOffer;
        string companyinternshipSearchByArea = "";
        private List<Area> Areas = new();
        private List<Skill> Skills = new();
        private DateTime? internshipSearchByActiveStartDate;
        private string startDateInput;
        private string searchMonthInput;
        private string searchYearInput;
        private int? searchMonth;
        private int? searchYear;
        private int? selectedMonth;

        private bool IsCompanyRegistrationPage => NavigationManager.Uri.Contains("/companyRegistration");

        private string emailUsedToUploadThesis = "";
        private string professorNameSearch = "";
        private string professorSurnameSearch = "";
        private DateTime? thesisUploadDateTime;
        private int? thesisUploadMonth;
        bool showStudentThesisApplications = false;
        bool showStudentJobApplications = false;

        private CompanyJob job = new CompanyJob();
        private CompanyThesis thesis = new CompanyThesis();
        private AnnouncementAsCompany announcement = new AnnouncementAsCompany();
        private AnnouncementAsProfessor professorannouncement = new AnnouncementAsProfessor();
        private ProfessorThesis professorthesis = new ProfessorThesis();
        private IBrowserFile? uploadedFile;
        private bool showSuccessMessage = false;
        private bool showErrorMessage = false;

        private bool showErrorMessagesForAreasWhenUploadJobAsCompany = false;
        private bool showErrorMessagesForAreasWhenUploadInternshipAsCompany = false;
        private bool showErrorMessagesForSkillsWhenUploadThesisAsCompany = false;

        private bool showErrorMessageforUploadingjobsAsCompany = false;
        private bool showErrorMessageforUploadinginternshipsAsProfessor = false;
        private bool showErrorMessageforUploadingthesisAsCompany = false;
        private bool showErrorMessageforUploadingannouncementsAsCompany = false;
        private bool showErrorMessageforUploadingannouncementsAsProfessor = false;
        private bool showErrorMessageforUploadingThesisAsProfessor = false;
        private bool showErrorMessageForUploadingCompanyEvent = false;
        private bool showErrorMessageForUploadingProfessorEvent = false;
        private bool showSuccessUpdateMessage = false;
        private bool isEditing = false;
        private string? companyName;
        private string? companyAreas;
        private string? companyTelephone;
        private string? companyWebsite;
        private byte[]? companyLogo;
        private string? companyDescription;
        private string? companyShortName;
        private string? companyType;
        private string? companyActivity;
        private string? companyCountry;
        private string? companyLocation;
        private long? companyPermanentPC;
        private string? companyRegions;
        private string? companyTown;
        private string? companyHRName;
        private string? companyHRSurname;
        private string? companyHREmail;
        private string? companyHRTelephone;
        private string? companyAdminName;
        private string? companyAdminSurname;
        private string? companyAdminEmail;
        private string? companyAdminTelephone;
        private Dictionary<long, int> numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent = new Dictionary<long, int>();

        private string? professorName;
        private string? professorUniversity;
        private string? professorUniversityDepartment;
        private byte[]? professorImage;
        private string? professorSurname;
        private string? professorVathmidaDEP;
        private string? companyEmail;
        private string? professorPersonalTelephone;
        private string? professorWorkTelephone;
        private string? professorDepartment;
        private string? professorGeneralFieldOfWork;
        private string? professorGeneralSkills;
        private string? professorPersonalDescription;

        private string? professorLinkedInProfile;
        private string? professorPersonalWebsite;
        private string? professorScholarProfile;
        private string? professorOrchidProfile;

        private bool isForm1Visible = false;
        private bool isAnnouncementsFormVisible = false;
        private bool isResearchGroupToUploadAnnouncementsFormVisible = false;
        private bool isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsCompany = false;
        private bool isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsRG = false;
        private bool isProfessorAnnouncementsFormVisible = false;
        private bool isProfessorThesisFormVisible = false;
        private bool isProfessorInternshipFormVisible = false;
        private bool isProfessorSearchStudentFormVisible = false;
        private bool isProfessorSearchCompanyFormVisible = false;
        private bool isStudentSearchCompanyFormVisible = false;
        private bool isRGSearchCompanyFormVisible = false;
        private bool isForm2Visible = false;
        private bool isShowActiveThesesAsCompanyFormVisible = false;
        private bool isThesisApplicationsVisible = false;
        private bool isAnnouncementsAsStudentVisible = false;
        private bool isAnnouncementsAsRGVisible = false;
        private bool isAnnouncementsAsProfessorVisible = false;
        private bool isSearchInternshipsAsStudentFiltersVisible = false;
        private bool isJobApplicationsAsStudentVisible  = false;
        private bool isJobPositionAsStudentFiltersVisible = false;
        private bool isInternshipApplicationsAsStudentVisible = false;
        private bool isInternshipSearchAsStudentFiltersVisible = false;
        private bool isEventSearchAsStudentVisible = false;

        private Dictionary<int, bool> positionDetails = new Dictionary<int, bool>();
        private List<CompanyJob> companyJobs;

        bool showApplications = false;
        private List<CompanyJobApplied> jobApplicationsmadeToCompany = new List<CompanyJobApplied>(); // List for job applications
        private Company companyData;

        private Company companyDatas = new Company();

        private long? selectedPositionId = null;

        private int totalStudentsCount = 0;
        private bool isDoughnutChartVisible = false;
        private bool isDepartmentDistributionChartVisible = false;
        private Dictionary<string, int> departmentDistribution = new Dictionary<string, int>();
        private Dictionary<string, int> skillDistribution = new Dictionary<string, int>();
        private bool hasReadAsCompanyPermission = false;

        private bool isUploadCompanyInternshipsFormVisible = false;
        private bool isUploadCompanyThesisFormVisible = false;
        private bool isShowActiveInternshipsAsCompanyFormVisible = false;
        private bool isShowActiveInternshipsAsProfessorFormVisible = false;
        private bool isUploadCompanyEventFormVisible = false;

        private bool isShowActiveJobsAsCompanyFormVisible = false;
        private bool isUploadProfessorEventFormVisible = false;

        private CompanyInternship companyInternship = new CompanyInternship();
        private CompanyThesis companyThesis = new CompanyThesis();

        private string selectedRegion = "";
        private string selectedTown = "";
        private Dictionary<string, bool> selectedTownsDictionary = new Dictionary<string, bool>();
        private HashSet<string> selectedRegions = new HashSet<string>();
        private Dictionary<string, bool> selectedRegionsDictionary = new Dictionary<string, bool>();
        private List<Area> availableAreas = new List<Area>();
        private List<Skill> availableSkills = new List<Skill>();
        private List<string> expandedAreas = new List<string>();
        private List<SelectedArea> selectedAreasForAssessment = new List<SelectedArea>();

        private string companyNameSearch { get; set; }
        private string emailSearch { get; set; }
        private string positionTypeSearch { get; set; }

        private string companyThesisSearch { get; set; }
        private string companyEmailSearch { get; set; }
        private string normalizedThesisSearch { get; set; }
        private string normalizedEmailSearch { get; set; }
        private string normalizedProfessorNameSearch { get; set; }
        private string normalizedProfessorSurnameSearch { get; set; }


        private DateTime? uploadDateSearch { get; set; }

        private CompanyInternship companyinternship = new CompanyInternship();
        private string selectedRegionForInternship;
        private List<string> filteredTownsForInternship;

        private List<CompanyInternship> internships = new List<CompanyInternship>(); 
        private List<ProfessorInternship> professorInternships = new List<ProfessorInternship>();


        private List<string> InternshipAsCompanyStatusOptions = new List<string> { "Δημοσιευμένη", "Μη Δημοσιευμένη", "Αποσυρμένη" };

        private string selectedStatusFilterForInternships = "Όλα";
        private string selectedStatusFilterForProfessorInternships = "Όλα";
        private string selectedStatusFilterForCompanyTheses = "Όλα";
        private string selectedStatusFilterForJobs = "Όλα";
        private string selectedStatusFilterForAnnouncements = "Όλα";
        private string selectedStatusFilterForAnnouncementsAsProfessor = "Όλα";
        private string selectedStatusFilterForEventsAsCompany = "Όλα";
        private string selectedStatusFilterForEventsAsProfessor = "Όλα";
        private string selectedStatusFilterForThesesAsProfessor = "Όλα";

        private CompanyInternship selectedInternship;
        private ProfessorInternship selectedProfessorInternship;
        private CompanyJob selectedJob;
        private CompanyThesis selectedCompanyThesis;
        private bool isEditPopupVisibleForInternships = false;
        private bool isEditPopupVisibleForProfessorInternships = false;
        private bool isEditPopupVisibleForJobs = false;
        private bool isEditPopupVisibleForCompanyThesis = false;
        private ThesisApplication selectedThesisApplication;
        private CompanyThesisApplied selectedCompanyThesisApplicationToShowAsStudent;
        private ProfessorThesisApplied selectedProfessorThesisApplicationToShowAsStudent;
        private ProfessorThesis selectedProfessorThesis;

        private bool showStudentInternshipApplications = false;

        private List<InternshipApplied> internshipApplications = new List<InternshipApplied>();
        private List<ProfessorInternshipApplied> professorInternshipApplications = new List<ProfessorInternshipApplied>();

        private CompanyJobApplied selectedJobApplication;
        private CompanyInternshipAreasForCheckboxes companyInternshipforcheckboxes = new CompanyInternshipAreasForCheckboxes();

        private List<Area> SelectedAreasWhenUploadInternshipAsCompany = new(); 
        private List<Area> SelectedAreasWhenUploadThesisAsCompany = new();
        private List<Area> SelectedAreasWhenUploadJobAsCompany = new();
        private List<Area> SelectedAreasWhenUploadEventAsCompany = new();
        private List<Skill> SelectedSkillsWhenUploadThesisAsCompany = new(); 

        private List<Area> SelectedAreasWhenUploadInternshipAsProfessor = new(); 
        private List<Area> SelectedAreasWhenUploadThesisAsProfessor = new();
        private List<Area> SelectedAreasWhenUploadJobAsProfessor = new();
        private List<Area> SelectedAreasWhenUploadEventAsProfessor = new();


        private List<Area> SelectedAreasToEditForCompanyJob = new List<Area>();
        private List<Area> SelectedAreasToEditForCompanyInternship = new List<Area>();
        private List<Area> SelectedAreasToEditForCompanyThesis = new List<Area>();
        private List<Skill> SelectedSkillsToEditForCompanyThesis  = new List<Skill>();
        private List<Skill> SelectedSkills = new(); 

        private List<Professor> professors = new List<Professor>();
        private int? selectedProfessorId;
        private int? selectedCompanyId;
        private string statusToEdit;


        private List<string> selectedAreas = new List<string>();

        private Dictionary<long, bool> expandedInternships = new Dictionary<long, bool>();
        private Dictionary<long, bool> expandedProfessorInternships = new Dictionary<long, bool>();

        private Dictionary<long, bool> expandedJobs = new Dictionary<long, bool>();
        private Dictionary<long, bool> expandedCompanyTheses = new Dictionary<long, bool>();
        private Dictionary<long, bool> expandedCompanyThesesForProfessorInterest = new Dictionary<long, bool>();
        private Dictionary<long, bool> expandedProfessorThesesForCompanyInterest = new Dictionary<long, bool>();
        private int remainingCharactersInInternshipFieldUploadAsCompany = 120;
        private int remainingCharactersInThesisFieldUploadAsCompany = 120;
        private int remainingCharactersInThesisFieldUploadAsProfessor = 120;
        private int remainingCharactersInAnnouncementFieldUploadAsCompany = 120;
        private int remainingCharactersInAnnouncementFieldUploadAsProfessor = 120;
        private int remainingCharactersInInternshipDescriptionUploadAsCompany = 1000;
        private int remainingCharactersInInternshipDescriptionUploadAsProfessor = 1000;
        private int remainingCharactersInCompanyEventDescription = 1000;
        private int remainingCharactersInProfessorEventDescription = 1000;
        private int remainingCharactersInEventTitleField = 120;

        private int remainingCharactersInJobFieldUploadAsCompany = 120;
        private int remainingCharactersInJobDescriptionUploadAsCompany = 1000;
        private int remainingCharactersInThesisDescriptionUploadAsCompany = 1000;
        private int remainingCharactersInThesisDescriptionUploadAsProfessor = 1000;
        private int remainingCharactersInAnnouncementDescriptionUploadAsCompany = 1000;
        private int remainingCharactersInAnnouncementDescriptionUploadAsProfessor = 1000;

        private string selectedStatusFilterToCountInternships = "Όλα";
        private int totalCount, publishedCount, unpublishedCount, withdrawnCount;
        private int totalCountForCompanyTheses, publishedCountForCompanyTheses, unpublishedCountForCompanyTheses, withdrawnCountForCompanyTheses;
        private int totalCountJobs, publishedCountJobs, unpublishedCountJobs, withdrawnCountJobs;
        private int totalCountAnnouncements, publishedCountAnnouncements, unpublishedCountAnnouncements, withdrawnCountAnnouncements;
        private int totalCountAnnouncementsAsProfessor, publishedCountAnnouncementsAsProfessor, unpublishedCountAnnouncementsAsProfessor, withdrawnCountAnnouncementsAsProfessor;
        private int totalCountThesesAsProfessor, publishedCountThesesAsProfessor, unpublishedCountThesesAsProfessor, withdrawnCountThesesAsProfessor;
        private int totalCountEventsAsCompany, publishedCountEventsAsCompany, unpublishedCountEventsAsCompany, withdrawnCountEventsAsCompany;
        private int totalCountEventsAsProfessor, publishedCountEventsAsProfessor, unpublishedCountEventsAsProfessor, withdrawnCountEventsAsProfessor;

        private int totalProfessorInternshipsCount, publishedProfessorInternshipsCount, unpublishedProfessorInternshipsCount, withdrawnProfessorInternshipsCount;

        private bool actionsPerformedToAcceptorRejectInternshipsAsCompany = false;
        private bool actionsPerformedToAcceptorRejectInternshipsAsProfessor = false;
        private bool actionsPerformedToAcceptorRejectJobsAsCompany = false;
        private bool actionsPerformedToAcceptorRejectThesisAsCompany = false;
        private bool actionsPerformedToAcceptorRejectThesesAsProfessor = false;

        private List<Company> companies = new List<Company>(); // Initialize with an empty list
        private Company selectedCompany;
        private Student selectedStudent;
        private List<string> availableTowns;

        private bool isSaveAnnouncementAsCompanySuccessful = false;
        private string saveAnnouncementAsCompanyMessage = string.Empty;
        private bool isSaveAnnouncementAsProfessorSuccessful = false;
        private string saveAnnouncementAsProfessorMessage = string.Empty;
        private string saveEventAsCompanyMessage = string.Empty;
        private string saveEventAsProfessorMessage = string.Empty;
        private bool isSaveThesisAsProfessorSuccessful = false;
        private string saveThesisAsProfessorMessage = string.Empty;

        private bool isCompanySearchStudentVisible = false;
        private bool isCompanySearchProfessorVisible = false;
        private bool isCompanySearchResearchGroupVisible = false;
        private bool isProfessorSearchResearchGroupVisible = false;
        private bool isRGSearchProfessorVisible = false;
        private HashSet<string> selectedThesisAreas = new HashSet<string>();

        private bool isUploadedAnnouncementsVisible = false;
        private bool isUploadedEventsVisible = false;
        private bool isUploadedEventsVisibleAsProfessor = false;

        private bool isUploadedAnnouncementsVisibleAsProfessor = false;
        private bool isUploadedThesesVisibleAsProfessor = false;
        private bool isUploadedCompanyThesesVisibleAsProfessor = false;
        private bool isUploadedProfessorThesesVisibleAsCompany = false;
        private List<AnnouncementAsCompany> UploadedAnnouncements { get; set; } = new List<AnnouncementAsCompany>();
        private List<CompanyThesis> UploadedCompanyTheses { get; set; } = new List<CompanyThesis>();
        private List<AnnouncementAsProfessor> UploadedAnnouncementsAsProfessor { get; set; } = new List<AnnouncementAsProfessor>();
        private List<CompanyEvent> UploadedEventsAsCompany { get; set; } = new List<CompanyEvent>();
        private List<ProfessorEvent> UploadedEventsAsProfessor { get; set; } = new List<ProfessorEvent>();
        private List<ProfessorThesis> UploadedThesesAsProfessor { get; set; } = new List<ProfessorThesis>();
        private List<CompanyThesis> UploadedCompanyThesesToSeeAsProfessor { get; set; } = new List<CompanyThesis>();
        private bool isEditModalVisible = false;
        private bool isEditModalVisibleForAnnouncementsAsProfessor = false;
        private bool isEditModalVisibleForThesesAsProfessor = false;
        private bool isEditModalVisibleForEventsAsCompany = false;
        private bool isEditModalVisibleForEventsAsProfessor = false;
        private AnnouncementAsCompany currentAnnouncement;
        private CompanyEvent currentCompanyEvent;
        private ProfessorEvent currentProfessorEvent;
        private CompanyThesis currentThesis;
        private AnnouncementAsProfessor currentAnnouncementAsProfessor;
        private ProfessorThesis currentThesisAsProfessor;

        private List<AnnouncementAsCompany> FilteredAnnouncements { get; set; }
        private List<CompanyEvent> FilteredCompanyEvents { get; set; }
        private List<ProfessorEvent> FilteredProfessorEvents { get; set; }
        private List<CompanyThesis> FilteredCompanyTheses { get; set; }
        private List<AnnouncementAsProfessor> FilteredAnnouncementsAsProfessor { get; set; }
        private List<ProfessorInternship> FilteredInternshipsAsProfessor { get; set; }
        private List<ProfessorThesis> FilteredThesesAsProfessor { get; set; }
        private bool isModalVisibleForJobs = false;
        private bool isModalVisibleToShowProfessorThesisAsProfessor = false;
        private bool isModalVisibleForProfessorThesisToShowDetailsAsStudent = false;
        private bool isModalVisibleForCompanyThesisToShowDetailsAsStudent = false;
        private bool isModalVisibleToShowCompanyThesisDetails = false;
        private bool isModalVisibleToEditCompanyThesisDetails = false;
        private bool isModalVisibleToShowStudentDetailsAsCompanyFromTheirHyperlinkNameInCompanyInternships = false;
        private bool isModalVisibleToShowStudentDetailsAsProfessorFromTheirHyperlinkNameInProfessorInternships = false;
        private CompanyJob currentJob;
        private CompanyJob currentJobApplicationMadeAsStudent;

        private List<AllTheses> sumUpThesesFromBothCompanyAndProfessor = new List<AllTheses>();
        private List<AllInternships> sumUpInternshipsFromBothCompanyAndProfessor = new List<AllInternships>();

        private string thesisSearchForInternshipsAsStudent;
        private string professorNameSearchForInternshipsAsStudent;
        private string professorSurnameSearchForInternshipsAsStudent;
        private string companyNameSearchForInternshipsAsStudent;
        private int? thesisUploadMonthForInternshipsAsStudent;

        private string thesisSearchForThesesAsStudent;
        private string professorNameSearchForThesesAsStudent;
        private string professorSurnameSearchForThesesAsStudent;
        private string companyNameSearchForThesesAsStudent;
        private int? thesisUploadMonthForThesesAsStudent;
        private DateTime? thesisStartDateForThesesAsStudent;


        private List<Area> availableAreasForProfessorThesis = new List<Area>();
        private List<Skill> availableSkillsForProfessorThesis = new List<Skill>();
        private List<long> selectedAreasForProfessorThesis = new List<long>();
        private List<long> selectedSkillsForProfessorThesis = new List<long>();

        private ProfessorThesis currentProfessorThesis;
        private ProfessorThesisApplied currentProfessorThesisToShowDetailsAsStudent;
        private CompanyThesis currentCompanyThesisToShowDetailsAsStudent;
        private bool isModalVisibleToShowProfessorThesisDetails = false;

        private Dictionary<long, bool> expandedTheses = new Dictionary<long, bool>();

        private IEnumerable<CompanyThesisApplied> companyThesisApplications;
        private IEnumerable<ProfessorThesisApplied> professorThesisApplications;

        private ProfessorThesis selectedProfessorThesisDetails;
        private Professor selectedProfessorDetailsForHyperlinkNameInThesisAsStudent;
        private Company selectedCompanyDetailsForHyperlinkNameInThesisAsStudent;
        private CompanyThesis selectedCompanyThesisDetails;
        private CompanyInternship selectedCompanyInternshipDetails;
        private ProfessorInternship selectedProfessorInternshipDetails;

        private List<CompanyThesis> companyThesesResultsToFindThesesAsProfessor = new List<CompanyThesis>();
        private bool searchPerformedToFindThesesAsProfessor = false;

        private List<ProfessorThesis> professorThesesResultsToFindThesesAsCompany = new List<ProfessorThesis>();
        private bool searchPerformedToFindThesesAsCompany = false;

        private CompanyThesis selectedCompanyThesisToSeeDetailsOnEyeIconAsProfessor;

        private Company selectedCompanyToSeeDetailsOnExpandedInterestAsProfessor;

        private bool isThesisDetailEyeIconModalVisibleToSeeAsProfessor = false;

        private ProfessorThesis selectedProfessorThesisToSeeDetailsOnEyeIconAsCompany;
        private bool isThesisDetailEyeIconModalVisibleToSeeAsCompany = false;
        private bool isExpandedModalVisibleToSeeCompanyDetailsAsProfessor = false;

        private bool isCompanyDetailModalVisibleForHyperlinkNameToShowCompanyDetailsToTheProfessor = false;
        private Company selectedCompanyNameAsHyperlinkToShowDetailsToTheProfessor;

        // Search criteria
        private string searchCompanyNameToFindThesesAsProfessor;
        private string searchThesisTitleToFindThesesAsProfessor;
        private string searchSupervisorToFindThesesAsProfessor;
        private string searchDepartmentToFindThesesAsProfessor;
        private string searchSkillsToFindThesesAsProfessor;
        private DateTime? searchStartingDateToFindThesesAsProfessor;

        private string searchProfessorNameToFindThesesAsCompany;
        private string searchProfessorSurnameToFindThesesAsCompany;
        private string searchProfessorThesisTitleToFindThesesAsCompany;
        private string searchAreasToFindThesesAsCompany;
        private string searchSkillsToFindThesesAsCompany;
        private DateTime? searchStartingDateToFindThesesAsCompany;

        private Dictionary<long, bool> professorInterestStatus = new Dictionary<long, bool>();
        private List<ThesisWithInterestStatus> thesesWithInterestStatus;

        private List<ProfessorThesisWithInterestStatus> professorthesesWithInterestStatus;

        private Professor? selectedProfessor;
        private ProfessorThesis? selectedCompanyThesiss;

        private CompanyEvent companyEvent = new CompanyEvent();
        private ProfessorEvent professorEvent = new ProfessorEvent();

        private DotNetObjectReference<MainLayout> dotNetHelper;
        private List<string> suggestions = new List<string>();

        private string searchNameAsCompanyToFindStudent = string.Empty;
        private string searchSurnameAsCompanyToFindStudent = string.Empty;
        private string searchRegNumberAsCompanyToFindStudent = string.Empty;
        private string searchDepartmentAsCompanyToFindStudent = string.Empty;

        private string InternshipStatus = string.Empty;
        private string ThesisStatus = string.Empty;

        private List<Student> searchResultsAsCompanyToFindStudent;

        private List<CompanyEvent> companyEventsToSeeAsStudent;
        private List<ProfessorEvent> professorEventsToSeeAsStudent;
        private CompanyEvent selectedCompanyEventToSeeAsStudent;
        private bool isCompanyEventsVisibleToSeeAsStudent = false;
        private bool isProfessorEventsVisibleToSeeAsStudent = false;
        private bool isModalVisibleToSeeCompanyEventsAsStudent = false; 

        private Company? currentCompanyDetailsToShowOnHyperlinkAsStudentForCompanyEvents;
        private Professor? currentProfessorDetailsToShowOnHyperlinkAsStudentForProfessorEvents;
        private Dictionary<long, bool> needsTransportForCompanyEvent = new Dictionary<long, bool>(); // Use a suitable type for the event ID
        private Dictionary<long, bool> needsTransportForProfessorEvent = new Dictionary<long, bool>(); // Use a suitable type for the event ID

        private Dictionary<long, string> selectedStartingPoint = new Dictionary<long, string>();
        private List<CompanyEvent> companyEvents = new List<CompanyEvent>();

        private List<ProfessorEvent> professorEvents = new List<ProfessorEvent>();


        private bool isProfessorDetailModalVisible = false;

        private string searchEmailAsProfessorToFindStudent = string.Empty;
        private string searchNameAsProfessorToFindStudent = string.Empty;
        private string searchSurnameAsProfessorToFindStudent = string.Empty;
        private string searchRegNumberAsProfessorToFindStudent = string.Empty;
        private string searchDepartmentAsProfessorToFindStudent = string.Empty;
        private string searchAreasOfExpertiseAsProfessorToFindStudent = string.Empty;
        private string searchKeywordsAsProfessorToFindStudent = string.Empty;


        private string searchCompanyEmailAsProfessorToFindCompany = string.Empty;
        private string searchCompanyNameENGAsProfessorToFindCompany = string.Empty;
        private string searchCompanyTypeAsProfessorToFindCompany = string.Empty;
        private string searchCompanyActivityrAsProfessorToFindCompany = string.Empty;
        private string searchCompanyTownAsProfessorToFindCompany = string.Empty;
        private string searchCompanyAreasAsProfessorToFindCompany = string.Empty;
        private string searchCompanyDesiredSkillsAsProfessorToFindCompany = string.Empty;

        private string searchCompanyEmailAsRGToFindCompany = string.Empty;
        private string searchCompanyNameENGAsRGToFindCompany = string.Empty;
        private string searchCompanyTypeAsRGToFindCompany = string.Empty;
        private string searchCompanyActivityrAsRGToFindCompany = string.Empty;
        private string searchCompanyTownAsRGToFindCompany = string.Empty;
        private string searchCompanyAreasAsRGToFindCompany = string.Empty;
        private string searchCompanyDesiredSkillsAsRGToFindCompany = string.Empty;

        private List<Student> searchResultsAsProfessorToFindStudent;
        private bool showStudentDetailsModal = false;

        private List<Company> searchResultsAsProfessorToFindCompany;
        private List<Company> searchResultsAsRGToFindCompany;
        private bool showCompanyDetailsModal = false;

        private bool isModalVisibleToShowCompanyDetailsAtProfessorThesisInterest = false;
        private bool isModalVisibleToShowprofessorDetailsAtCompanyThesisInterest  = false;
        private Company currentCompanyDetails = new Company();

        private bool isModalVisibleToShowStudentDetailsInNameAsHyperlinkForProfessorThesis = false;
        private Student currentStudentDetails = new Student();

        private bool showStudentDetailsModalWhenSearchForStudentsAsCompany = false;
        private Student selectedStudentWhenSearchForStudentsAsCompany;

        private string searchNameAsCompanyToFindProfessor;
        private string searchSurnameAsCompanyToFindProfessor;
        private string searchDepartmentAsCompanyToFindProfessor;
        private string searchAreasOfInterestAsCompanyToFindProfessor;
        private List<Professor> searchResultsAsCompanyToFindProfessor;

        private bool showProfessorDetailsModalWhenSearchForProfessorsAsCompany = false;
        private bool showProfessorDetailsModalWhenSearchForProfessorsAsRG = false;
        private Professor selectedProfessorWhenSearchForProfessorsAsCompany;
        private Professor selectedProfessorWhenSearchForProfessorsAsRG;

        private Professor currentProfessorDetails = new Professor();

        private string searchNameOrSurname = string.Empty; 
        private List<string> nameSurnameSuggestions = new List<string>();

        private string searchNameSurnameAsCompanyToFindProfessor { get; set; }
        private string searchNameSurnameAsStudentToFindProfessor { get; set; }
        private List<string> professorNameSurnameSuggestions { get; set; } = new();
        private List<string> thesisTitleSuggestions { get; set; } = new();
        private List<string> companyNameSuggestionsWhenSearchForProfessorThesisAutocompleteNameAsStudent { get; set; } = new();

        ////////////////////////////////////////////////////////////////////////////////////////
        private string searchNameSurnameAsRGToFindProfessor { get; set; }
        private List<string> professorNameSurnameSuggestionsAsRG { get; set; } = new();
        private string searchDepartmentAsRGToFindProfessor;
        private string searchAreasOfInterestAsRGToFindProfessor;
        private List<Professor> searchResultsAsRGToFindProfessor;
        ////////////////////////////////////////////////////////////////////////////////////////


        private string searchAreasOfExpertise = string.Empty;
        private string searchAreasOfInterest = string.Empty;
        private List<string> areasOfExpertiseSuggestions = new List<string>();
        private List<string> areasOfInterestSuggestions = new List<string>();
        private string searchKeywords = string.Empty;
        private List<string> keywordsSuggestions = new List<string>();

        private string searchAreasOfExpertiseAsRG = string.Empty;
        private string searchAreasOfInterestAsRG = string.Empty;
        private List<string> areasOfExpertiseSuggestionsAsRG = new List<string>();
        private List<string> areasOfInterestSuggestionsAsRG = new List<string>();
        private string searchKeywordsAsRG = string.Empty;
        private List<string> keywordsSuggestionsAsRG = new List<string>();

        private string? selectedDegreeLevel { get; set; }

        private DateTime currentMonth = DateTime.Today;
        private string[] daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
        private int firstDayOfMonth => (int)new DateTime(currentMonth.Year, currentMonth.Month, 1).DayOfWeek;

        private List<ProfessorEvent> selectedProfessorDateEvents = new List<ProfessorEvent>();
        private List<CompanyEvent> selectedDateEvents = new List<CompanyEvent>();

        private bool isModalVisibleToShowEventsOnCalendarForEachClickedDay = false;
        private int daysInCurrentMonth => DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        private int totalCellsInGrid;
        private int remainingCells => totalCellsInGrid - (firstDayOfMonth + daysInCurrentMonth);
        private int remainingCellsValue; 
        private DateTime? selectedDate;

        private Dictionary<int, List<CompanyEvent>> eventsForDate = new Dictionary<int, List<CompanyEvent>>();
        private Dictionary<int, List<ProfessorEvent>> eventsForDateForProfessors = new Dictionary<int, List<ProfessorEvent>>();

        private int selectedDay = 0; // To store the selected day
        private int highlightedDay = 0; // To store the day that needs to be highlighted
        private int adjustedFirstDayOfMonth => (firstDayOfMonth == 0) ? 6 : firstDayOfMonth - 1; // Adjust Sunday (0) to Saturday (6) and Monday (1) to 0

        public List<CompanyEvent> CompanyEventsToShowAtFrontPage { get; set; }
        public List<ProfessorEvent> ProfessorEventsToShowAtFrontPage { get; set; }

        private List<InterestInCompanyEvent> InterestedStudents = new();
        private List<InterestInCompanyEventAsProfessor> InterestedProfessorsInCompanyEvent = new();
        private long? selectedEventIdForStudents;
        private long? selectedEventIdForProfessors;

        private List<InterestInProfessorEvent> InterestedStudentsForProfessorEvent = new();
        private long? selectedEventIdForStudentsWhenShowInterestForProfessorEvent;

        private bool showModal = false;
        private bool showProfessorModal = false;
        private bool showModalForStudentsAtProfessorEventInterest = false;
        private InterestInCompanyEvent selectedStudentToShowDetailsForInterestinCompanyEvent;
        private Professor selectedProfessorToShowDetailsForInterestinCompanyEvent;
        private InterestInProfessorEvent selectedStudentToShowDetailsForInterestinProfessorEvent;
        private IEnumerable<CompanyThesisApplied> companythesisapplicants;
        private bool isFormValidToSaveAnnouncementAsCompany = true;
        private bool showErrorMessageforUploadingAnnouncementAsCompany = false;
        private bool isFormValidToSaveEventAsCompany = true;
        private bool isFormValidToSaveEventAsProfessor = true;

        private List<string> selectedKeywords = new();
        private List<string> selectedAreasOfExpertise = new();
        private List<string> selectedAreasOfInterest = new();

        private List<string> selectedKeywordsAsRG = new();
        private List<string> selectedAreasOfExpertiseAsRG = new();
        private List<string> selectedAreasOfInterestAsRG = new();

        private bool showErrorMessageforPostalCode = false;

        private const long MaxFileSize = 10 * 1024 * 1024; //10MB FILE SIZE

        // Track current page and calculate the total number of pages
        private int currentPage = 1;
        private int totalPages => selectedDateEvents?.Count ?? 0;

        private CompanyEvent? eventToDisplay => selectedDateEvents?.ElementAtOrDefault(currentPage - 1);
        private ProfessorEvent? professoreventToDisplay => selectedProfessorDateEvents?.ElementAtOrDefault(currentPage - 1);

        private string selectedEventType = "all"; // Default to show all events
        private object selectedEvent = null;

        private string selectedEventFilter { get; set; } = "All";
        private List<CompanyEvent> filteredCompanyEvents => 
        selectedEventFilter == "All" || selectedEventFilter == "Company" 
            ? selectedDateEvents 
            : new List<CompanyEvent>();

        private List<ProfessorEvent> filteredProfessorEvents => 
        selectedEventFilter == "All" || selectedEventFilter == "Professor" 
            ? selectedProfessorDateEvents 
            : new List<ProfessorEvent>();

        // Get the event for the current page

        // Methods for pagination
        private void NextPage()
        {
            if (currentPage < totalPages)
                currentPage++;
        }

        private void PreviousPage()
        {
            if (currentPage > 1)
                currentPage--;
        }

        private DateTime _professorEventDate;
        private int existingEventsCountToCheckAsProfessor = 0;

        private bool isCompanyDetailsModalOpenForHyperlinkNameAsStudent = false;
        private bool isModalOpenForCompanyEventToSeeAsStudent = false;
        private bool isModalOpenForProfessorEventToSeeAsStudent = false;
        private bool isModalOpenForCompanyDetailsToSeeAsStudent = false;
        private bool isModalOpenForProfessorDetailsToSeeAsStudent = false;
        private bool isCompanyDetailsModal2Visible = false; 
        private bool isCompanyDetailsModal3Visible = false; 
        private bool isInternshipDetailsModalVisible = false;
        private bool isJobDetailsModal2Visible = false;
        private bool isCompanyDetailsModal4Visible = false;
        private bool iscompanyDetailsModalVisible = false;

        private List<InterestInCompanyEventAsProfessor> filteredProfessorInterestForCompanyEvents = new();
        private List<InterestInProfessorEventAsCompany> filteredCompanyInterestForProfessorEvents = new();
        private ProfessorInternship professorInternship = new ProfessorInternship();

        private bool isCompanyDetailsModalOpenForJobSearch = false;
        private bool isCompanyDetailsModalOpenForJobShow = false;
        private Company? selectedCompanyDetailsForJobSearch = null;
        private Company? selectedCompanyDetailsForJobShow = null;
        private bool isJobDetailsModalVisibleToSeeJobApplicationsAsStudent = false;

        private bool isModalOpenToSeeCompanyDetails_ThesisStudentApplicationsToShow = false;
        private Company selectedCompanyDetails_ThesisStudentApplicationsToShow = null;  
        private bool isModalOpenToSeeProfessorDetails_ThesisStudentApplicationsToShow = false;
        private bool isModalOpenToSeeProfessorDetails_InternshipStudentApplicationsToShow = false;
        private Professor selectedProfessorDetails_ThesisStudentApplicationsToShow = null;

        private bool isModalOpenToSeeCompanyThesisDetails_ThesisStudentApplicationsToShow = false;
        private CompanyThesis selectedCompanyThesisDetails_ThesisStudentApplicationsToShow = null;

        private bool isModalOpenToSeeProfessorThesisDetails_ThesisStudentApplicationsToShow = false;
        private ProfessorThesis selectedProfessorThesisDetails_ThesisStudentApplicationsToShow = null;

        private bool isProfessorDetailsModalVisible_StudentInternshipApplicationsShow = false;
        private Professor selectedProfessorDetails = null;
        private bool isInternshipDetailsModalVisible_StudentInternshipApplicationsShow = false;

        private bool showCompanyThesisApplications = true;
        private bool showProfessorThesisApplications = true;
        private bool isLoading = false;
        private string filterValue = "all";

        private List<CompanyThesisApplied> companyApplicationsToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private List<ProfessorThesisApplied> professorApplicationsToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private int itemsPerPageToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private int totalPagesToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private int currentPageToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private List<CompanyThesisApplied> currentCompanyApplicationsToShowOnPagination_SeeMyThesisApplicationsAsStudent;
        private List<ProfessorThesisApplied> currentProfessorApplicationsToShowOnPagination_SeeMyThesisApplicationsAsStudent;



        private bool showCompanyThesisApplicationsToSearchAsStudent = true;
        private bool showProfessorThesisApplicationsToSearchAsStudent = true;
        private string selectedThesisFilter = "all";
        private List<AllTheses> publishedTheses;
        private string dropdownState = "all";

        private bool showExpandedAreasInCompanyThesisEditModalAsCompany = false;
        private bool showExpandedSkillsInCompanyThesisEditModalAsCompany = false;
        private void ToggleAreasInEditCompanyThesisModalAsCompany() => showExpandedAreasInCompanyThesisEditModalAsCompany = !showExpandedAreasInCompanyThesisEditModalAsCompany;
        private void ToggleSkillsInEditCompanyThesisModalAsCompany() => showExpandedSkillsInCompanyThesisEditModalAsCompany = !showExpandedSkillsInCompanyThesisEditModalAsCompany; 
        private bool showExpandedAreasInCompanyInternshipEditModalAsCompany = false;
        private void ToggleAreasInEditCompanyInternshipModalAsCompany() => showExpandedAreasInCompanyInternshipEditModalAsCompany = !showExpandedAreasInCompanyInternshipEditModalAsCompany;
        private void ToggleAreasInEditCompanyEventModal() => showExpandedAreasInCompanyEventEditModal = !showExpandedAreasInCompanyEventEditModal;



        private List<Area> selectedThesisAreasForProfessor = new();
        private List<Skill> selectedThesisSkillsForProfessor = new();

        private CompanyThesis companythesis;
        private CompanyInternship companyinternshipp;
        private CompanyJob companyjobb;
        private ProfessorInternship professorinternship;

        private IEnumerable<CompanyThesisApplied> applicants;
        private IEnumerable<InternshipApplied> companyInternshipApplicants;
        private IEnumerable<CompanyJobApplied> companyJobApplicants;
        private IEnumerable<ProfessorInternshipApplied> professorInternshipApplicants;


        private bool showExpandedAreasInCompanyEventEditModal = false;

        private List<Area> SelectedAreasToEditForCompanyEvent = new List<Area>();

        private List<string> AvailableTowns = new List<string>();

        private Dictionary<long, IEnumerable<CompanyJobApplied>> jobApplicants = new Dictionary<long, IEnumerable<CompanyJobApplied>>();
        private Dictionary<long, IEnumerable<CompanyJobApplied>> jobApplicantsMap = new Dictionary<long, IEnumerable<CompanyJobApplied>>();
        private Dictionary<long, IEnumerable<InternshipApplied>> internshipApplicantsMap = new Dictionary<long, IEnumerable<InternshipApplied>>();
        private Dictionary<long, IEnumerable<ProfessorInternshipApplied>> professorInternshipApplicantsMap = new Dictionary<long, IEnumerable<ProfessorInternshipApplied>>();
        private Dictionary<long, IEnumerable<CompanyThesisApplied>> companyThesisApplicantsMap = new Dictionary<long, IEnumerable<CompanyThesisApplied>>();
        private Dictionary<long, IEnumerable<ProfessorThesisApplied>> professorThesisApplicantsMap = new Dictionary<long, IEnumerable<ProfessorThesisApplied>>();
        private Dictionary<long, IEnumerable<CompanyThesis>> companyThesesProfessorsMap = new Dictionary<long, IEnumerable<CompanyThesis>>();


        private List<string> jobTitleAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent { get; set; } = new();
        private List<string> companyNameAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent { get; set; } = new();
        private List<string> internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent { get; set; } = new();

        private int currentCompanyEventpageSize = 3;
        private int pageSize = 3;
        public List<AnnouncementAsProfessor> ProfessorAnnouncements { get; set; }
        public List<AnnouncementAsCompany> CompanyAnnouncements { get; set; }
        public List<AnnouncementAsResearchGroup> ResearchGroupAnnouncements { get; set; }
        private int totalPagesForCompanyEvents => (int)Math.Ceiling((double)CompanyEventsToShowAtFrontPage.Where(a => a.CompanyEventStatus == "Δημοσιευμένη").Count() / currentCompanyEventpageSize);
        private int expandedCompanyEventId = -1;
        private string fetchError;
        private int expandedProfessorEventId = -1;
        private int expandedAnnouncementId = -1;
        private bool isHidden = false;
        private int expandedProfessorAnnouncementId = -1;
        private int totalPagesForProfessorAnnouncements => (int)Math.Ceiling((double)ProfessorAnnouncements.Where(a => a.ProfessorAnnouncementStatus == "Δημοσιευμένη").Count() / pageSize);
        private int currentPageForProfessorAnnouncements = 1;
        private int currentCompanyEventPage = 1;
        private int currentProfessorEventPage = 1;
        private int totalPagesForProfessorEvents => (int)Math.Ceiling((double)ProfessorEventsToShowAtFrontPage.Where(a => a.ProfessorEventStatus == "Δημοσιευμένη").Count() / currentProfessorEventpageSize);
        private int currentProfessorEventpageSize = 3;

        private int totalPagesForCompanyAnnouncements => (int)Math.Ceiling((double)CompanyAnnouncements.Where(a => a.CompanyAnnouncementStatus == "Δημοσιευμένη").Count() / pageSize);
        private int currentPageForCompanyAnnouncements = 1;

        private Professor selectedProfessorDetailsForHyperlinkNameInInternshipAsStudent;
        private Company selectedCompanyDetailsForHyperlinkNameInInternshipAsStudent;
        private bool isCompanyDetailsModalOpenForHyperlinkNameAsStudentForCompanyInternship;


        private List<NewsArticle> newsArticles;
        private List<NewsArticle> svseNewsArticles;
        public List<AnnouncementAsCompany> Announcements { get; set; }

        private bool showSuccessMessageWhenSaveInternshipAsCompany = false;

        private string searchAreasInputToFindThesesAsCompany = string.Empty;
        private List<string> areaSuggestionsToFindThesesAsCompany = new();
        private List<string> selectedAreasToFindThesesAsCompany = new();

        // For filtering
        private string filterValueForInternships = "all";
        private bool showCompanyInternshipApplications = true;
        private bool showProfessorInternshipApplications = true;

        // For pagination
        private int currentPageForInternshipsToSee = 1;
        private int pageSizeForInternshipsToSee = 10; // Adjust as needed
        private int totalInternshipCount = 0;
        private int totalPagesForInternshipsToSee = 1;

        private HashSet<long> interestedProfessorEventIds = new();
        private HashSet<long> alreadyInterestedCompanyEventIds = new();
        private HashSet<long> professorThesisIdsApplied = new();
        private HashSet<long> companyThesisIdsApplied = new();
        private HashSet<long> jobIdsApplied = new();
        private HashSet<long> internshipIdsApplied = new();
        private HashSet<long> professorInternshipIdsApplied = new();


        private int currentInternshipPage = 1;
        private int InternshipsPerPage = 10; // Set to show 3 internships per page
        private int totalInternshipPages => (int)Math.Ceiling((double)publishedInternships.Count / InternshipsPerPage);


        // STUDENT PAGINATION ON TABLE DROPDOWNS - ALL TABS
        private int[] pageSizeOptions_SeeMyThesisApplicationsAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForThesisAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyJobApplicationsAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForJobsAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyInternshipApplicationsAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForInternshipsAsStudent = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForEventsAsStudent = new[] { 10, 50, 100 };

        // COMPANY PAGINATION ON TABLE DROPDOWNS - ALL TABS
        private int[] pageSizeOptions_SeeMyUploadedAnnouncementsAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedJobsAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedInternshipsAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedThesesAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForProfessorThesesAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedEventsAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForStudentsAsCompany = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SearchForProfessorsAsStudent = new[] { 10, 50, 100 };

        // SEARCH FOR PROFESSOR AS RG
        private int[] pageSizeOptions_SearchForProfessorsAsRG = new[] { 10, 50, 100 };

        // PROFESSOR PAGINATION ON TABLE DROPDOWNS - ALL TABS
        private int[] pageSizeOptions_SeeMyUploadedAnnouncementsAsProfessor = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedThesesAsProfessor = new[] { 10, 50, 100 };
        private int[] companyThesesPageSize_SearchForCompanyThesesAsProfessor = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedInternshipsAsProfessor = new[] { 10, 50, 100 };
        private int[] pageSizeOptions_SeeMyUploadedEventsAsProfessor = new[] { 10, 50, 100 };
        private int[] studentSearchPageSizeOptions = new[] { 10, 50, 100 };
        private int[] companySearchPageSizeOptions = new[] { 10, 50, 100 };


        private List<ProfessorInternshipApplied> _professorinternshipapplicants = new();
        private string uploadErrorMessage = string.Empty;
        private bool uploadSuccess = false;
        private ResearchGroup researchGroupData;

        private Student selectedStudentFromCache;

        private Dictionary<string, Student> studentDataCache = new Dictionary<string, Student>();
        private Dictionary<string, Company> companyDataCache = new Dictionary<string, Company>();
        private Dictionary<string, Professor> professorDataCache = new Dictionary<string, Professor>();
        private Dictionary<long, CompanyJob> jobDataCache = new Dictionary<long, CompanyJob>();
        private Dictionary<long, CompanyInternship> internshipDataCache = new Dictionary<long, CompanyInternship>();
        private Dictionary<long, ProfessorInternship> professorInternshipDataCache = new Dictionary<long, ProfessorInternship>();
        private Dictionary<long, CompanyThesis> thesisDataCache = new Dictionary<long, CompanyThesis>();
        private Dictionary<long, ProfessorThesis> professorThesisDataCache = new Dictionary<long, ProfessorThesis>();


        private bool hasExistingEventsOnSelectedDate = false;
        private int existingEventsCount = 0;

        private async Task CheckExistingEventsForDate()
        {
            if (companyEvent.CompanyEventActiveDate.Date > DateTime.Today.Date)
            {
                // Check for existing company events on this date
                var companyEventsCount = await dbContext.CompanyEvents
                    .CountAsync(e => e.CompanyEventActiveDate.Date == companyEvent.CompanyEventActiveDate.Date && 
                                    e.CompanyEventStatus == "Δημοσιευμένη");

                // Check for existing professor events on this date
                var professorEventsCount = await dbContext.ProfessorEvents
                    .CountAsync(e => e.ProfessorEventActiveDate.Date == companyEvent.CompanyEventActiveDate.Date && 
                                    e.ProfessorEventStatus == "Δημοσιευμένη");

                existingEventsCount = companyEventsCount + professorEventsCount;
                hasExistingEventsOnSelectedDate = existingEventsCount > 0;
            }
            else
            {
                hasExistingEventsOnSelectedDate = false;
            }

            StateHasChanged();
        }

        private async Task HandleDateChange(ChangeEventArgs e)
        {
            if (DateTime.TryParse(e.Value?.ToString(), out DateTime newDate))
            {
                companyEvent.CompanyEventActiveDate = newDate;
                await CheckExistingEventsForDate();
            }
        }


        private AnnouncementAsCompany? selectedCompanyAnnouncementToSeeDetailsAsCompany;
        private void OpenCompanyAnnouncementDetailsModal(AnnouncementAsCompany currentAnnouncement)
        {
            selectedCompanyAnnouncementToSeeDetailsAsCompany = currentAnnouncement;
        }

        private void CloseCompanyAnnouncementDetailsModal()
        {
            selectedCompanyAnnouncementToSeeDetailsAsCompany = null;
        }

        private List<string> DegreeLevel = new List<string>
        {
            "Προπτυχιακός Φοιτητής",
            "Μεταπτυχιακός Φοιτητής",
            "Υποψήφιος Διδάκτορας",
        };





        private List<string> ForeasType = new List<string>
        {
            "Ιδιωτικός Φορέας",
            "Δημόσιος Φορέας",
            "Μ.Κ.Ο.",
            "Άλλο"
        };

        private List<string> Regions = new List<string>
        {
            "Ανατολική Μακεδονία και Θράκη",
            "Κεντρική Μακεδονία",
            "Δυτική Μακεδονία",
            "Ήπειρος",
            "Θεσσαλία",
            "Ιόνια Νησιά",
            "Δυτική Ελλάδα",
            "Κεντρική Ελλάδα",
            "Αττική",
            "Πελοπόννησος",
            "Βόρειο Αιγαίο",
            "Νότιο Αιγαίο",
            "Κρήτη"
        };
        private Dictionary<string, List<string>> RegionToTownsMap = new Dictionary<string, List<string>>
        {
            {"Ανατολική Μακεδονία και Θράκη", new List<string> {"Κομοτηνή", "Αλεξανδρούπολη", "Καβάλα", "Ξάνθη", "Δράμα", "Ορεστιάδα", "Διδυμότειχο", "Ίασμος", "Νέα Βύσσα", "Φέρες"}},
            {"Κεντρική Μακεδονία", new List<string> {"Θεσσαλονίκη", "Κατερίνη", "Σέρρες", "Κιλκίς", "Πολύγυρος", "Ναούσα", "Έδεσσα", "Γιαννιτσά", "Καβάλα", "Άμφισσα"}},
            {"Δυτική Μακεδονία", new List<string> {"Κοζάνη", "Φλώρινα", "Καστοριά", "Γρεβενά"}},
            {"Ήπειρος", new List<string> {"Ιωάννινα", "Άρτα", "Πρέβεζα", "Ηγουμενίτσα"}},
            {"Θεσσαλία", new List<string> {"Λάρισα", "Βόλος", "Τρίκαλα", "Καρδίτσα"}},
            {"Ιόνια Νησιά", new List<string> {"Κέρκυρα", "Λευκάδα", "Κεφαλονιά", "Ζάκυνθος", "Ιθάκη", "Παξοί", "Κυθήρα"}},
            {"Δυτική Ελλάδα", new List<string> {"Πάτρα", "Μεσολόγγι", "Αμφιλοχία", "Πύργος", "Αιγίο", "Ναύπακτος"}},
            {"Κεντρική Ελλάδα", new List<string> {"Λαμία", "Χαλκίδα", "Λιβαδειά", "Θήβα", "Αλιάρτος", "Αμφίκλεια"}},
            {"Αττική", new List<string> {"Αθήνα", "Πειραιάς", "Κηφισιά", "Παλλήνη", "Αγία Παρασκευή", "Χαλάνδρι", "Καλλιθέα", "Γλυφάδα", "Περιστέρι", "Αιγάλεω"}},
            {"Πελοπόννησος", new List<string> {"Πάτρα", "Τρίπολη", "Καλαμάτα", "Κορίνθος", "Άργος", "Ναύπλιο", "Σπάρτη", "Κυπαρισσία", "Πύργος", "Μεσσήνη"}},
            {"Βόρειο Αιγαίο", new List<string> {"Μυτιλήνη", "Χίος", "Λήμνος", "Σάμος", "Ίκαρος", "Λέσβος", "Θάσος", "Σκύρος", "Ψαρά"}},
            {"Νότιο Αιγαίο", new List<string> {"Ρόδος", "Κως", "Κρήτη", "Κάρπαθος", "Σαντορίνη", "Μύκονος", "Νάξος", "Πάρος", "Σύρος", "Άνδρος"}},
            {"Κρήτη", new List<string> {"Ηράκλειο", "Χανιά", "Ρέθυμνο", "Αγία Νικόλαος", "Ιεράπετρα", "Σητεία", "Κίσαμος", "Παλαιόχωρα", "Αρχάνες", "Ανώγεια"}},
        };

        private DateTime selectedDateToSearchJob = DateTime.Today;

        private DateTime? selectedDateToSearchInternship = DateTime.Today;
        private DateTime? finishEstimationDateToSearchInternship = null;
        protected override async Task OnInitializedAsync()
        {
            await LoadAnalyticsAsync();
            await LoadAllStudentData();
            await LoadCompanyJobData();
            //await LoadCompanyJobApplicantData();
            await ShowMyJobApplicationsAsStudent();
            //await LoadCurrentResearchGroup();
            await LoadStudentsWithAuth0DetailsAsync();
            await LoadStudentsAsync();
            await LoadInternships();
            await LoadProfessorInternships();

            await LoadJobs();

            await LoadThesesAsCompany();

            await LoadThesesAsProfessor();

            await LoadAreasAsync();

            await LoadSkillsAsync();

            await LoadProfessors();

            await LoadCompanies();

            await LoadUploadedAnnouncementsAsync();

            await LoadUploadedAnnouncementsAsProfessorAsync();

            await LoadUploadedResearchGroupAnnouncementsAsync();

            await LoadUploadedThesesAsProfessorAsync();

            await CalculateStatusCountsForInternships();

            await CalculateStatusCountsForJobs();

            await CalculateStatusCountsForAnnouncements();

            await CalculateStatusCountsForAnnouncementsAsProfessor();

            await CalculateStatusCountsForThesesAsProfessor();

            await CalculateStatusCountsForCompanyTheses();

            await LoadToSeeUploadedCompanyThesesAsProfessorAsync();

            await LoadUploadedEventsAsync();

            await LoadUploadedEventsAsyncAsProfessor();

            await LoadThesisData();

            FilterAnnouncements();

            FilterResearchGroupAnnouncements();

            FilterAnnouncementsAsProfessor();

            FilterThesesAsProfessor();

            FilterProfessorInternships();

            //FilterThesesAsCompany();

            FilterCompanyEvents();

            FilterProfessorEvents();

            await LoadProfessorInterestsForCompanyEvents();

            professorthesisApplications = new List<ProfessorThesisApplied>();

            companythesisApplications = new List<CompanyThesisApplied>();

            UploadedCompanyTheses = await GetCompanyThesesAsync(); 

            companyThesesResultsToFindThesesAsProfessor = await dbContext.CompanyTheses.ToListAsync();

            //await SearchThesisApplicationsAsStudent();



            // Populate available schools and departments

            AvailableSchools = StudentsWithAuth0Details.Select(s => s.School).Distinct().ToList();

            AvailableDepartments = StudentsWithAuth0Details.Select(s => s.Department).Distinct().ToList();



            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

            var user = authState.User;

            // ============================================================================
            // USER ROLE INITIALIZATION
            // ============================================================================
            // UserRole is initialized here from the authentication claims
            // Possible values: "Student", "Company", "Professor", "Admin", "Research Group"
            // This value is used throughout the application for role-based UI rendering
            UserRole = user.FindFirst(ClaimTypes.Role)?.Value; // Get user's role

            var userEmail = user.FindFirst("name")?.Value; // Assuming "name" claim contains the user's email

            var userSignUpDate = user.FindFirst("created_at")?.Value;

            var userLatestLoginDate = user.FindFirst("last_login")?.Value;
            jobs = await dbContext.CompanyJobs

                .Include(j => j.Company)  // Just add this line

                .ToListAsync(); 



            totalStudentsCount = await dbContext.Students.CountAsync();



            await LoadSkillDistributionAsync();

            await LoadDepartmentDistributionAsync();



            companyInternship.CompanyInternshipActivePeriod = DateTime.Now;

            companyInternship.CompanyInternshipFinishEstimation = DateTime.Now;

            companyInternship.CompanyInternshipUploadDate = DateTime.Now;

            announcement.CompanyAnnouncementUploadDate = DateTime.Now;

            selectedDateToSearchJob = DateTime.Today;



            companyInternship.CompanyUploadedInternshipStatus = "Μη Δημοσιευμένη";



            newsArticles = await FetchNewsArticlesAsync();

            svseNewsArticles = await FetchSVSENewsArticlesAsync();

            Announcements = await FetchAnnouncementsAsync();

            ProfessorAnnouncements = await FetchProfessorAnnouncementsAsync();

            CompanyAnnouncements = await FetchCompanyAnnouncementsAsync();

            ResearchGroupAnnouncements =  await FetchResearchGroupAnnouncementsAsync();



            CompanyEventsToShowAtFrontPage = await FetchCompanyEventsAsync();

            ProfessorEventsToShowAtFrontPage = await FetchProfessorEventsAsync();





            thesisStartDateForThesesAsStudent  = DateTime.Now;

            companyEvent.CompanyEventActiveDate = DateTime.Now;



            job.PositionActivePeriod  = DateTime.Now;

            job.PositionStatus = "Μη Δημοσιευμένη";





            announcement.CompanyAnnouncementTimeToBeActive = DateTime.Now;

            professorannouncement.ProfessorAnnouncementTimeToBeActive = DateTime.Now;

            thesis.CompanyThesisStartingDate = DateTime.Now;



            availableAreasForProfessorThesis = await dbContext.Areas.ToListAsync();

            availableSkillsForProfessorThesis = await dbContext.Skills.ToListAsync();

            professorthesis.ThesisActivePeriod = DateTime.Now;



            searchStartingDateToFindThesesAsProfessor  = DateTime.Now;





            /*

            Console.WriteLine("Interest Status Dictionary: " + string.Join(", ", professorInterestStatus.Select(kv => $"{kv.Key}: {kv.Value}")));

            */



            //dotNetHelper = DotNetObjectReference.Create(this);



            /*

            CompanyEventsToShowAtFrontPage = await FetchCompanyEventsAsync();

            ProfessorEventsToShowAtFrontPage = await FetchProfessorEventsAsync();

            */



            LoadEventsForCalendar();

            CalculateRemainingCells();







            if (user.Identity.IsAuthenticated)

            {

                var roleClaim = user.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role");

                if (roleClaim != null)

                {

                    companyName = user.Identity?.Name ?? "Anonymous User";

                    var userRole = roleClaim.Value;

                    hasReadAsCompanyPermission = userRole == "Company";

                }

            }



            // Check if the user has the Student role

            if (user.IsInRole("Student"))

            {

                ShowStudentRegistrationButton = true;

            }

            // Check if the user has the Company role

            if (user.IsInRole("Company"))

            {

                ShowCompanyRegistrationButton = true;

            }

            // Check if the user has the Professor role

            if (user.IsInRole("Professor"))

            {

                ShowProfessorRegistrationButton = true;

            }

            if (user.IsInRole("Admin"))

            {

                ShowAdminRegistrationButton = true;

            }



            if (user.IsInRole("ResearchGroup"))

            {

                ShowAdminRegistrationButton = true;

            }



            if (!string.IsNullOrEmpty(userEmail))

            {

                CurrentUserEmail = userEmail; // Assign userEmail to CurrentUserEmail



                // Check if student is registered based on email

                using (var dbContext = new AppDbContext(Configuration)) // Ensure Configuration is injected or accessed correctly

                {

                    isStudentRegistered = await dbContext.Students.AnyAsync(s => s.Email == CurrentUserEmail);

                }

                isInitializedAsStudentUser = true;

                // Check if company is registered based on email

                using (var dbContext = new AppDbContext(Configuration)) // Ensure Configuration is injected or accessed correctly

                {

                    isCompanyRegistered = await dbContext.Companies.AnyAsync(s => s.CompanyEmail == CurrentUserEmail);



                    // Fetch company data

                    companyData = await dbContext.Companies

                        .FirstOrDefaultAsync(c => c.CompanyEmail == CurrentUserEmail);



                    /*

                    if (companyData == null)

                    {

                        Console.WriteLine($"Company with email {CurrentUserEmail} not found.");

                    }

                    */

                }

                isInitializedAsCompanyUser = true;

                // Check if professor is registered based on email

                using (var dbContext = new AppDbContext(Configuration)) // Ensure Configuration is injected or accessed correctly

                {

                    isProfessorRegistered = await dbContext.Professors.AnyAsync(s => s.ProfEmail == CurrentUserEmail);

                }

                isInitializedAsProfessorUser = true;

                // Load user data

                using (var dbContext = new AppDbContext(Configuration))

                {

                    userData = await dbContext.Students.FirstOrDefaultAsync(s => s.Email == userEmail);



                    

                    if (userData == null)

                    {   /*

                        Console.WriteLine($"User with email {userEmail} not found.");

                        */

                    }

                    

                    else

                    {

                        //interest in professor events as student

                        interestedProfessorEventIds = (await dbContext.InterestInProfessorEvents

                            .Where(e => e.StudentUniqueIDShowInterestForEvent == userData.Student_UniqueID && 

                                        e.StudentEmailShowInterestForEvent == userData.Email)

                            .Select(e => e.RNGForProfessorEventInterest)

                            .ToListAsync())

                            .ToHashSet();



                        //interest in company events as student

                        alreadyInterestedCompanyEventIds = (await dbContext.InterestInCompanyEvents

                            .Where(e => e.StudentUniqueIDShowInterestForEvent == userData.Student_UniqueID && 

                                        e.StudentEmailShowInterestForEvent == userData.Email)

                            .Select(e => e.RNGForCompanyEventInterest)

                            .ToListAsync())

                            .ToHashSet();



                        // Get applied professor theses

                        professorThesisIdsApplied = dbContext.ProfessorThesesApplied

                            .Where(x => x.StudentUniqueIDAppliedForProfessorThesis == userData.Student_UniqueID && 

                                        x.StudentEmailAppliedForProfessorThesis == userData.Email)

                            .Select(x => x.RNGForProfessorThesisApplied)

                            .ToHashSet();



                        // Get applied company theses

                        companyThesisIdsApplied =  dbContext.CompanyThesesApplied

                            .Where(x => x.StudentUniqueIDAppliedForThesis == userData.Student_UniqueID && 

                                        x.StudentEmailAppliedForThesis == userData.Email)

                            .Select(x => x.RNGForCompanyThesisApplied)

                            .ToHashSet();



                        // Get applied company applied jobs

                        jobIdsApplied = dbContext.CompanyJobsApplied

                            .Where(x => x.StudentUniqueIDAppliedForCompanyJob == userData.Student_UniqueID && 

                                        x.StudentEmailAppliedForCompanyJob == userData.Email)

                            .Select(x => x.RNGForCompanyJobApplied)

                            .ToHashSet();



                        // Get applied company internships

                        var companyApplied = dbContext.InternshipsApplied

                            .Include(x => x.StudentDetails)

                            .Where(x => x.StudentDetails.StudentUniqueIDAppliedForInternship == userData.Student_UniqueID)

                            .Select(x => x.RNGForInternshipApplied)

                            .ToHashSet();



                        // Get applied professor internships 

                        var professorApplied = dbContext.ProfessorInternshipsApplied

                            .Include(x => x.StudentDetails)

                            .Where(x => x.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == userData.Student_UniqueID)

                            .Select(x => x.RNGForProfessorInternshipApplied)

                            .ToHashSet();



                        // Combine both sets

                        internshipIdsApplied = companyApplied;

                        professorInternshipIdsApplied = professorApplied;

                    }

                }

                // Check if ResearchGroup is registered based on email

                using (var dbContext = new AppDbContext(Configuration)) // Ensure Configuration is injected or accessed correctly

                {

                    isResearchGroupRegistered = await dbContext.ResearchGroups.AnyAsync(s => s.ResearchGroupEmail == CurrentUserEmail);



                    // Fetch company data

                    researchGroupData = await dbContext.ResearchGroups

                        .FirstOrDefaultAsync(c => c.ResearchGroupEmail == CurrentUserEmail);



                    /*

                    if (researchGroupData == null)

                    {

                        Console.WriteLine($"ResearchGroup with email {CurrentUserEmail} not found.");

                    }

                    */

                }

                isInitializedAsResearchGroupUser = true;



            }



            if (!string.IsNullOrEmpty(userEmail))

            {

                // First get the company details from the Company table

                var company = await dbContext.Companies

                    .FirstOrDefaultAsync(c => c.CompanyEmail == userEmail);



                if (company != null)

                {

                    companyName = company.CompanyName; // Get name from Company model



                    // Now get all jobs for this company

                    jobs = await dbContext.CompanyJobs

                        .Where(job => job.EmailUsedToUploadJobs == userEmail)

                        .Include(job => job.Company) // Optional: include company details if needed

                        .ToListAsync();

                }

            }







            var professor = await dbContext.Professors.FirstOrDefaultAsync(c => c.ProfEmail == userEmail);

            if (professor != null)

            {

                professorName = professor.ProfName;

                professorSurname = professor.ProfSurname;

                professorDepartment = professor.ProfDepartment;

                professorImage = professor.ProfImage;

                professorUniversity = professor.ProfUniversity;

                professorVathmidaDEP = professor.ProfVahmidaDEP;

                professorPersonalTelephone = professor.ProfPersonalTelephone;

                professorWorkTelephone = professor.ProfWorkTelephone;

                professorLinkedInProfile = professor.ProfLinkedInSite;

                professorPersonalWebsite = professor.ProfPersonalWebsite;

                professorScholarProfile = professor.ProfScholarProfile;

                professorOrchidProfile = professor.ProfOrchidProfile;

                professorGeneralFieldOfWork = professor.ProfGeneralFieldOfWork;

                professorGeneralSkills = professor.ProfGeneralSkills;

                professorPersonalDescription = professor.ProfPersonalDescription;





            }



            foreach (var companyEvent in companyEvents)

            {

                if (!selectedStartingPoint.ContainsKey(companyEvent.RNGForEventUploadedAsCompany))

                {

                    // Initialize the value to null or a default starting point

                    selectedStartingPoint[companyEvent.RNGForEventUploadedAsCompany] = null;

                }

            }



            companyEvents = await dbContext.CompanyEvents.ToListAsync();

            foreach (var companyEvent in companyEvents)

            {

                if (!selectedStartingPoint.ContainsKey(companyEvent.RNGForEventUploadedAsCompany))

                {

                    selectedStartingPoint[companyEvent.RNGForEventUploadedAsCompany] = null;

                }

            }



            companythesis = await GetCompanyThesisAsync();

            companyinternshipp = await GetCompanyInternshipsAsync();

            companyjobb = await GetCompanyJobsAsync();



            job.PositionContactPerson = companyData?.CompanyHREmail;

            job.PositionAddressLocation = companyData?.CompanyLocation;

            job.PositionContactTelephonePerson = companyData?.CompanyHRTelephone;

            job.PositionPerifereiaLocation = companyData?.CompanyRegions;

            job.PositionDimosLocation = companyData?.CompanyTown;

            job.PositionPostalCodeLocation = companyData?.CompanyPC.ToString();





            companyInternship.CompanyInternshipContactPerson = companyData?.CompanyHREmail;

            companyInternship.CompanyInternshipAddress = companyData?.CompanyLocation;

            companyInternship.CompanyInternshipContactTelephonePerson = companyData?.CompanyHRTelephone;

            companyInternship.CompanyInternshipPerifereiaLocation = companyData?.CompanyRegions;

            companyInternship.CompanyInternshipDimosLocation = companyData?.CompanyTown;

            companyInternship.CompanyInternshipPostalCodeLocation = companyData?.CompanyPC.ToString();





            professorEvents = await dbContext.ProfessorEvents.ToListAsync();

            // Before assigning values, ensure Professor exists

            if (professorEvent.Professor == null)

            {

                professorEvent.Professor = new Professor();

            }



            // Now you can safely assign

            professorEvent.Professor.ProfUniversity = professorUniversity;

            professorEvent.ProfessorEventUniversityDepartment = professorDepartment;

            ProfessorEventDate = DateTime.Today;



            companyLogo = companyData?.CompanyLogo;

            companyTelephone = companyData?.CompanyTelephone;

            companyWebsite = companyData?.CompanyWebsite;

            companyAreas = companyData?.CompanyAreas;

            companyDescription = companyData?.CompanyDescription;

            companyShortName = companyData?.CompanyShortName;

            companyType = companyData?.CompanyType;

            companyActivity = companyData?.CompanyActivity;

            companyCountry = companyData?.CompanyCountry;

            companyLocation = companyData?.CompanyLocation;

            companyPermanentPC = companyData?.CompanyPC;

            companyRegions = companyData?.CompanyRegions;

            companyTown = companyData?.CompanyTown;

            companyHRName = companyData?.CompanyHRName;

            companyHRSurname = companyData?.CompanyHRSurname;

            companyHREmail = companyData?.CompanyHREmail;

            companyHRTelephone = companyData?.CompanyHRTelephone;

            companyAdminName = companyData?.CompanyAdminName;

            companyAdminSurname = companyData?.CompanyAdminSurname;

            companyAdminEmail = companyData?.CompanyAdminEmail;

            companyAdminTelephone = companyData?.CompanyAdminTelephone;

            numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent[professorEvent.RNGForEventUploadedAsProfessor] = 1; 



            professorInternship.ProfessorInternshipActivePeriod = DateTime.Today;

            professorInternship.ProfessorInternshipUploadDate = DateTime.Today;

            professorInternship.ProfessorInternshipFinishEstimation = DateTime.Today;

            professorInternship.ProfessorInternshipContactPerson = professorName +" "+ professorSurname;

            professorInternship.ProfessorInternshipContactTelephonePerson = professorPersonalTelephone;

            professorInternship.ProfessorEmailUsedToUploadInternship = userEmail;



            var companyjob = await dbContext.CompanyJobs.FirstOrDefaultAsync(c => c.Id == job.Id);

            SelectedAreasToEditForCompanyJob = companyjob?.PositionAreas?

                .Split(',')

                .Select(area => new Area { AreaName = area })

                .ToList() ?? new List<Area>();



            searchStartingDateToFindThesesAsCompany = DateTime.Today;





            if (companythesis != null)

            {

                applicants = await GetApplicantsForCompanyThesis(companythesis.RNGForThesisUploadedAsCompany);

            }

            else

            {

                // Handle the case where companythesis is null (maybe show a message or log an error)

                applicants = Enumerable.Empty<CompanyThesisApplied>(); // Or handle differently

            }



            if (companyinternshipp != null)

            {

                companyInternshipApplicants = await GetApplicants(companyinternshipp.RNGForInternshipUploadedAsCompany);

            }

            else

            {

                // Handle the case where companyinternshipp is null

                companyInternshipApplicants = Enumerable.Empty<InternshipApplied>();



            }



            if (companyjobb != null)

            {

                // Only call GetApplicantsForJobs if companyjobb is not null

                companyJobApplicants = await GetApplicantsForJobs(companyjobb.RNGForPositionUploaded);

            }

            else

            {

                // Handle the case where companyjobb is null (maybe show a message or log an error)

                companyJobApplicants = Enumerable.Empty<CompanyJobApplied>(); // Or handle differently

            }



            if (professorinternship != null)

            {

                // Only call GetApplicantsForJobs if professorinternship is not null

                professorInternshipApplicants = await GetProfessorInternshipApplicants(professorinternship.RNGForInternshipUploadedAsProfessor);

            }

            else

            {

                professorInternshipApplicants = Enumerable.Empty<ProfessorInternshipApplied>(); // Or handle differently

            }



        }

        private async Task<CompanyThesis?> GetCompanyThesisAsync()
    {
        return await dbContext.CompanyTheses.FirstOrDefaultAsync(); 
    }

    private async Task<CompanyInternship?> GetCompanyInternshipsAsync()
    {
        return await dbContext.CompanyInternships.FirstOrDefaultAsync(); 
    }

    private async Task<CompanyJob?> GetCompanyJobsAsync()
    {
        currentJobPage = 1;
        return await dbContext.CompanyJobs.FirstOrDefaultAsync(); 
    }

        private async Task<List<CompanyThesis>> GetCompanyThesesAsync()
        {
            return await dbContext.CompanyTheses.ToListAsync(); 
        }


        private async Task LoadAreasAsync()
        {
            Areas = await dbContext.Areas.ToListAsync();
        }

        private async Task LoadSkillsAsync()
        {
            Skills = await dbContext.Skills.ToListAsync();
        }



        private void NavigateToSearchJobs()
        {
            NavigationManager.NavigateTo("/searchjobs");
        }

        private void NavigateToSearchThesis()
        {
            NavigationManager.NavigateTo("/searchthesis");
        }


        private bool HideAllInitialCards()
        {
            var uri = NavigationManager.Uri;
            return uri.Contains("profile")
            || uri.Contains("settings")
            || uri.Contains("uploadjobs")
            || uri.Contains("searchjobs")
            || uri.Contains("companyRegistration")
            || uri.Contains("studentRegistration")
            || uri.Contains("uploadJobs")
            || uri.Contains("professorRegistration")
            || uri.Contains("uploadthesis")
            || uri.Contains("searchthesis")
            || uri.Contains("uploadinternship")
            || uri.Contains("researchGroupRegistration");

            //ALLAKSA AYTO GIA TO MAIN LAYOUT NA FIGOUN TA CARDS KAI EPISIS STO APP.RAZOR EVALA 3 FUNCTIONS GIA NA KANEI REDIRECT STO REGISTRAITON ANALOGA TO USER ROLE
            //AYTO PREPEI NA GINETAI MIA FORA STO PRWTO RENDER ALLIWS AN PATAW PANW STO X-TREND NA DEIXNEI TOUS CRAWLERS APO TO LANDING PAGE MAZI ME AYTA POU EIPE O DIONYSIS.
            //EPISIS NA GINEI TO UPDATE GIA TA STOIXEIA TOU USER STIN IDIA FORMA OPWS AKRIVWS GINETAI KAI META EDIT POSITIONS KAI EDIT THESIS
        }


        private async Task ShowMyThesisApplicationsAsStudent()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity.IsAuthenticated)
                {
                    var userEmail = user.FindFirst("name")?.Value;
                    if (string.IsNullOrEmpty(userEmail))
                    {
                        Console.WriteLine("User email is null or empty.");
                        return;
                    }

                    if (userData == null)
                    {
                        Console.WriteLine("userData is null.");
                        return;
                    }

                    if (string.IsNullOrEmpty(userData.Student_UniqueID))
                    {
                        Console.WriteLine("userData.Student_UniqueID is not set.");
                        return;
                    }

                    showThesisApplications = true;

                    // Retrieve thesis applications with includes and proper filtering
                    thesisApplications = await dbContext.ProfessorThesesApplied
                        .Include(a => a.StudentDetails)
                        .Include(a => a.ProfessorDetails)
                        .Where(j => j.StudentEmailAppliedForProfessorThesis == userEmail && 
                                j.StudentUniqueIDAppliedForProfessorThesis == userData.Student_UniqueID)
                        .OrderByDescending(j => j.DateTimeStudentAppliedForProfessorThesis)
                        .ToListAsync();

                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine("User is not authenticated.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"An error occurred: {ex.Message}");
            }
        }

        private async Task ShowMyJobApplicationsAsStudent()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity.IsAuthenticated)
                {
                    var userEmail = user.FindFirst("name")?.Value;
                    if (!string.IsNullOrEmpty(userEmail))
                    {
                        showJobApplications = true;

                        // Load applications with ALL related data
                        jobApplications = await dbContext.CompanyJobsApplied
                            .Where(j => j.StudentEmailAppliedForCompanyJob == userEmail)
                            .Include(a => a.StudentDetails)
                            .Include(a => a.CompanyDetails)
                            .ToListAsync();

                        // Load ALL related jobs WITH COMPANY DATA in one query
                        var jobIds = jobApplications.Select(a => a.RNGForCompanyJobApplied).Distinct().ToList();
                        var jobs = await dbContext.CompanyJobs
                            .Where(j => jobIds.Contains(j.RNGForPositionUploaded))
                            .Include(j => j.Company)  // Add this line to include Company data
                            .AsNoTracking()
                            .ToListAsync();

                        // Update cache
                        jobDataCache = jobs.ToDictionary(j => j.RNGForPositionUploaded, j => j);

                        StateHasChanged();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading applications: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα φόρτωσης αιτήσεων");
            }
        }



        private async Task DeleteProfessorThesisApplicationMadeAsStudent(long rngForThesisApplied)
        {
            try
            {
                // Find application by the RNG value
                var applicationToDelete = await dbContext.ProfessorThesesApplied
                    .FirstOrDefaultAsync(app => app.RNGForProfessorThesisApplied == rngForThesisApplied);

                if (applicationToDelete != null)
                {
                    // First delete related details if they exist
                    var studentDetails = await dbContext.ProfessorThesisApplied_StudentDetails
                        .FirstOrDefaultAsync(s => s.StudentUniqueIDAppliedForProfessorThesis == applicationToDelete.StudentUniqueIDAppliedForProfessorThesis 
                                            && s.StudentEmailAppliedForProfessorThesis == applicationToDelete.StudentEmailAppliedForProfessorThesis);

                    var professorDetails = await dbContext.ProfessorThesisApplied_ProfessorDetails
                        .FirstOrDefaultAsync(p => p.ProfessorUniqueIDWhereStudentAppliedForProfessorThesis == applicationToDelete.ProfessorUniqueIDWhereStudentAppliedForProfessorThesis
                                            && p.ProfessorEmailWhereStudentAppliedForProfessorThesis == applicationToDelete.ProfessorEmailWhereStudentAppliedForProfessorThesis);

                    if (studentDetails != null)
                        dbContext.ProfessorThesisApplied_StudentDetails.Remove(studentDetails);

                    if (professorDetails != null)
                        dbContext.ProfessorThesisApplied_ProfessorDetails.Remove(professorDetails);

                    // Then delete the main application
                    dbContext.ProfessorThesesApplied.Remove(applicationToDelete);
                    await dbContext.SaveChangesAsync();

                    // Update local list by RNG value
                    professorthesisApplications.RemoveAll(t => t.RNGForProfessorThesisApplied == rngForThesisApplied);
                }
                else
                {
                    Console.WriteLine($"No professor thesis application found with RNG: {rngForThesisApplied}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting Professor Thesis Application: {ex.Message}");
            }
            finally
            {
                StateHasChanged();
            }
        }



        private async Task DeleteCompanyThesisApplication(long rngForThesisApplied)
        {
            try
            {
                // Find application by the RNG value
                var applicationToDelete = await dbContext.CompanyThesesApplied
                    .FirstOrDefaultAsync(app => app.RNGForCompanyThesisApplied == rngForThesisApplied);

                if (applicationToDelete != null)
                {
                    // First delete related details if they exist
                    var studentDetails = await dbContext.CompanyThesisApplied_StudentDetails
                        .FirstOrDefaultAsync(s => s.StudentUniqueIDAppliedForThesis == applicationToDelete.StudentUniqueIDAppliedForThesis 
                                            && s.StudentEmailAppliedForThesis == applicationToDelete.StudentEmailAppliedForThesis);

                    var companyDetails = await dbContext.CompanyThesisApplied_CompanyDetails
                        .FirstOrDefaultAsync(c => c.CompanyUniqueIDWhereStudentAppliedForThesis == applicationToDelete.CompanyUniqueIDWhereStudentAppliedForThesis
                                            && c.CompanyEmailWhereStudentAppliedForThesis == applicationToDelete.CompanyEmailWhereStudentAppliedForThesis);

                    if (studentDetails != null)
                        dbContext.CompanyThesisApplied_StudentDetails.Remove(studentDetails);

                    if (companyDetails != null)
                        dbContext.CompanyThesisApplied_CompanyDetails.Remove(companyDetails);

                    // Then delete the main application
                    dbContext.CompanyThesesApplied.Remove(applicationToDelete);
                    await dbContext.SaveChangesAsync();

                    // Update local list if needed (now matching by RNG value)
                    companythesisApplications.RemoveAll(t => t.RNGForCompanyThesisApplied == rngForThesisApplied);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting thesis application: {ex.Message}");
                // Consider adding user notification
            }
        }



        private async Task DeleteJobApplication(long rngForJobApplied)
        {
            try
            {
                // Find application by the RNG value
                var applicationToDelete = await dbContext.CompanyJobsApplied
                    .FirstOrDefaultAsync(app => app.RNGForCompanyJobApplied == rngForJobApplied);

                if (applicationToDelete != null)
                {
                    // First delete related details if they exist
                    var studentDetails = await dbContext.CompanyJobApplied_StudentDetails
                        .FirstOrDefaultAsync(s => s.StudentUniqueIDAppliedForCompanyJob == applicationToDelete.StudentUniqueIDAppliedForCompanyJob 
                                            && s.StudentEmailAppliedForCompanyJob == applicationToDelete.StudentEmailAppliedForCompanyJob);

                    var companyDetails = await dbContext.CompanyJobApplied_CompanyDetails
                        .FirstOrDefaultAsync(c => c.CompanysUniqueIDWhereStudentAppliedForCompanyJob == applicationToDelete.CompanysUniqueIDWhereStudentAppliedForCompanyJob
                                            && c.CompanysEmailWhereStudentAppliedForCompanyJob == applicationToDelete.CompanysEmailWhereStudentAppliedForCompanyJob);

                    if (studentDetails != null)
                        dbContext.CompanyJobApplied_StudentDetails.Remove(studentDetails);

                    if (companyDetails != null)
                        dbContext.CompanyJobApplied_CompanyDetails.Remove(companyDetails);

                    // Then delete the main application
                    dbContext.CompanyJobsApplied.Remove(applicationToDelete);
                    await dbContext.SaveChangesAsync();

                    // Update local list if needed (now matching by RNG value)
                    jobApplications.RemoveAll(j => j.RNGForCompanyJobApplied == rngForJobApplied);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting job application: {ex.Message}");
                // Consider adding user notification
            }
        }






        public static class DiacriticsRemover
        {
            // Mapping Greek diacritics to their base characters
            private static readonly Dictionary<char, char> DiacriticRemovals = new Dictionary<char, char>
        {
            { 'ά', 'α' }, { 'έ', 'ε' }, { 'ή', 'η' }, { 'ί', 'ι' },
            { 'ϊ', 'ι' }, { 'ΐ', 'ι' }, { 'ό', 'ο' }, { 'ύ', 'υ' },
            { 'ϋ', 'υ' }, { 'ΰ', 'υ' }, { 'ώ', 'ω' }, { 'Ά', 'Α' },
            { 'Έ', 'Ε' }, { 'Ή', 'Η' }, { 'Ί', 'Ι' }, { 'Ϊ', 'Ι' },
            { 'Ό', 'Ο' }, { 'Ύ', 'Υ' }, { 'Ϋ', 'Υ' }, { 'Ώ', 'Ω' }
        };

            public static string RemoveDiacritics(string input)
            {
                if (string.IsNullOrEmpty(input))
                {
                    return input;
                }

                var normalizedString = new StringBuilder();

                foreach (var character in input)
                {
                    if (DiacriticRemovals.TryGetValue(character, out var replacement))
                    {
                        normalizedString.Append(replacement);
                    }
                    else
                    {
                        normalizedString.Append(character);
                    }
                }

                return normalizedString.ToString();
            }
        }

        // Global Search Property
        private string globalThesisSearch = string.Empty;
        private bool isLoadingSearchThesisApplicationsAsStudent = false;
        private async Task SearchThesisApplicationsAsStudent()
        {
            isLoadingSearchThesisApplicationsAsStudent = true;
            StateHasChanged(); // Force UI update to show loading state
        
            try
            {
                using var dbContext = await DbContextFactory.CreateDbContextAsync();
                dbContext.ChangeTracker.Clear();

                // Get the current student's department
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.Identity.Name;

                var currentStudent = await dbContext.Students
                    .FirstOrDefaultAsync(s => s.Email == userEmail);

                var studentDepartment = currentStudent?.Department;

                var professorThesesQuery = dbContext.ProfessorTheses
                    .Include(t => t.Professor)
                    .AsQueryable();

                var companyThesesQuery = dbContext.CompanyTheses
                    .Include(t => t.Company)
                    .AsQueryable();

                // Filter professor theses by department matching
                if (!string.IsNullOrEmpty(studentDepartment))
                {
                    professorThesesQuery = professorThesesQuery
                        .Where(t => t.Professor != null && 
                                t.Professor.ProfDepartment == studentDepartment);
                }

                // GLOBAL SEARCH - Enhanced implementation with multi-word support
                if (!string.IsNullOrEmpty(globalThesisSearch))
                {
                    var searchTerm = globalThesisSearch.Trim();
                    var searchWords = searchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            
                    // Get all areas and subfields that match any of the search words
                    var areaPredicate = PredicateBuilder.New<Area>();
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaName, $"%{tempWord}%"));
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaSubFields, $"%{tempWord}%"));
                    }

                    var matchingAreas = await dbContext.Areas
                        .Where(areaPredicate)
                        .Select(a => new { a.AreaName, a.AreaSubFields })
                        .ToListAsync();

                    // Extract area names and subfields for searching
                    var areaSearchTerms = new List<string>();
                    foreach (var area in matchingAreas)
                    {
                        areaSearchTerms.Add(area.AreaName);
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subFields = area.AreaSubFields.Split(',', StringSplitOptions.RemoveEmptyEntries);
                            areaSearchTerms.AddRange(subFields.Select(s => s.Trim()));
                        }
                    }
            
                    // Remove duplicates
                    areaSearchTerms = areaSearchTerms.Distinct().ToList();

                    // Search in professor theses across multiple fields with multi-word support
                    var professorPredicate = PredicateBuilder.New<ProfessorThesis>();
            
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        professorPredicate = professorPredicate.Or(t => EF.Functions.Like(t.ThesisTitle, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(t => EF.Functions.Like(t.ThesisDescription, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(t => EF.Functions.Like(t.ThesisAreas, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(t => EF.Functions.Like(t.ThesisSkills, $"%{tempWord}%"));
                    }
            
                    // Add area and subfield searches
                    foreach (var areaTerm in areaSearchTerms)
                    {
                        var tempTerm = areaTerm;
                        professorPredicate = professorPredicate.Or(t => EF.Functions.Like(t.ThesisAreas, $"%{tempTerm}%"));
                    }
            
                    // Search in professor names with multi-word support
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        professorPredicate = professorPredicate.Or(t => t.Professor != null && (
                            EF.Functions.Like(t.Professor.ProfName, $"%{tempWord}%") ||
                            EF.Functions.Like(t.Professor.ProfSurname, $"%{tempWord}%") ||
                            EF.Functions.Like(t.Professor.ProfName + " " + t.Professor.ProfSurname, $"%{tempWord}%") ||
                            EF.Functions.Like(t.Professor.ProfSurname + " " + t.Professor.ProfName, $"%{tempWord}%")
                        ));
                    }

                    professorThesesQuery = professorThesesQuery.Where(professorPredicate);

                    // Search in company theses across multiple fields with multi-word support
                    var companyPredicate = PredicateBuilder.New<CompanyThesis>();
            
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        companyPredicate = companyPredicate.Or(t => EF.Functions.Like(t.CompanyThesisTitle, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(t => EF.Functions.Like(t.CompanyThesisDescriptionsUploaded, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(t => EF.Functions.Like(t.CompanyThesisAreasUpload, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(t => EF.Functions.Like(t.CompanyThesisSkillsNeeded, $"%{tempWord}%"));
                    }
            
                    // Add area and subfield searches for company theses
                    foreach (var areaTerm in areaSearchTerms)
                    {
                        var tempTerm = areaTerm;
                        companyPredicate = companyPredicate.Or(t => EF.Functions.Like(t.CompanyThesisAreasUpload, $"%{tempTerm}%"));
                    }
            
                    // Search in company names with multi-word support
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        companyPredicate = companyPredicate.Or(t => t.Company != null && 
                            EF.Functions.Like(t.Company.CompanyName, $"%{tempWord}%"));
                    }

                    companyThesesQuery = companyThesesQuery.Where(companyPredicate);
                }
                else
                {
                    // Apply specific filters only when no global search is active
            
                    // Filter by Thesis Title with exact match priority
                    if (!string.IsNullOrEmpty(thesisSearchForThesesAsStudent))
                    {
                        // First try exact match using ToLower() for case-insensitive comparison
                        var exactMatchProfessor = professorThesesQuery 
                            .Where(t => t.ThesisTitle.ToLower() == thesisSearchForThesesAsStudent.ToLower());

                        var exactMatchCompany = companyThesesQuery
                            .Where(t => t.CompanyThesisTitle.ToLower() == thesisSearchForThesesAsStudent.ToLower());

                        // Check if we have any exact matches
                        var hasExactMatches = await exactMatchProfessor.AnyAsync() || await exactMatchCompany.AnyAsync();

                        if (hasExactMatches)
                        {
                            professorThesesQuery = exactMatchProfessor;
                            companyThesesQuery = exactMatchCompany;
                        }
                        else
                        {
                            // Fall back to contains search if no exact matches
                            professorThesesQuery = professorThesesQuery
                                .Where(t => EF.Functions.Like(t.ThesisTitle, $"%{thesisSearchForThesesAsStudent}%"));
                            companyThesesQuery = companyThesesQuery
                                .Where(t => EF.Functions.Like(t.CompanyThesisTitle, $"%{thesisSearchForThesesAsStudent}%"));
                        }
                    }

                    // Filter by Professor Full Name (autocomplete field)
                    if (!string.IsNullOrEmpty(searchNameSurnameAsStudentToFindProfessor))
                    {
                        var searchTerm = searchNameSurnameAsStudentToFindProfessor.Trim();
                        var nameParts = searchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);

                        if (nameParts.Length == 1)
                        {
                            professorThesesQuery = professorThesesQuery.Where(t =>
                                t.Professor != null && (
                                    EF.Functions.Like(t.Professor.ProfName, $"%{nameParts[0]}%") ||
                                    EF.Functions.Like(t.Professor.ProfSurname, $"%{nameParts[0]}%")
                                ));
                        }
                        else
                        {
                            professorThesesQuery = professorThesesQuery.Where(t =>
                                t.Professor != null && (
                                    (EF.Functions.Like(t.Professor.ProfName, $"%{nameParts[0]}%") && 
                                    EF.Functions.Like(t.Professor.ProfSurname, $"%{nameParts[1]}%")) ||
                                    (EF.Functions.Like(t.Professor.ProfName, $"%{nameParts[1]}%") && 
                                    EF.Functions.Like(t.Professor.ProfSurname, $"%{nameParts[0]}%"))
                                ));
                        }
                        companyThesesQuery = companyThesesQuery.Where(t => false);
                    }

                    // Filter by Company Name with exact match priority
                    if (!string.IsNullOrEmpty(companyNameSearchForThesesAsStudent))
                    {
                        // First try exact match using ToLower() for case-insensitive comparison
                        var exactMatchCompany = companyThesesQuery
                            .Where(t => t.Company != null && 
                                    t.Company.CompanyName.ToLower() == companyNameSearchForThesesAsStudent.ToLower());

                        // Check if we have any exact matches
                        var hasExactMatches = await exactMatchCompany.AnyAsync();

                        if (hasExactMatches)
                        {
                            companyThesesQuery = exactMatchCompany;
                        }
                        else
                        {
                            // Fall back to contains search if no exact matches
                            companyThesesQuery = companyThesesQuery
                                .Where(t => t.Company != null && 
                                        EF.Functions.Like(t.Company.CompanyName, $"%{companyNameSearchForThesesAsStudent}%"));
                        }
                        professorThesesQuery = professorThesesQuery.Where(t => false);
                    }
                }

                // Filter by Thesis Starting Date in both Professor and Company Theses
                if (thesisStartDateForThesesAsStudent.HasValue)
                {
                    var startOfDay = thesisStartDateForThesesAsStudent.Value.Date;
                    professorThesesQuery = professorThesesQuery.Where(t => t.ThesisActivePeriod.Date >= startOfDay);
                    companyThesesQuery = companyThesesQuery.Where(t => t.CompanyThesisStartingDate.Date >= startOfDay);
                }

                // Filter by Areas AND Subfields
                if (selectedThesisAreas.Any() || selectedThesisSubFields.Any())
                {
                    // Combine areas and subfields for searching
                    var allSearchTerms = selectedThesisAreas.Union(selectedThesisSubFields).ToList();

                    if (allSearchTerms.Any())
                    {
                        // For Professor Theses
                        var professorPredicate = PredicateBuilder.New<ProfessorThesis>();
                        foreach (var term in allSearchTerms)
                        {
                            var tempTerm = term;
                            professorPredicate = professorPredicate.Or(t => 
                                EF.Functions.Like(t.ThesisAreas, $"%{tempTerm}%"));
                        }
                        professorThesesQuery = professorThesesQuery.Where(professorPredicate);

                        // For Company Theses
                        var companyPredicate = PredicateBuilder.New<CompanyThesis>();
                        foreach (var term in allSearchTerms)
                        {
                            var tempTerm = term;
                            companyPredicate = companyPredicate.Or(t => 
                                EF.Functions.Like(t.CompanyThesisAreasUpload, $"%{tempTerm}%"));
                        }
                        companyThesesQuery = companyThesesQuery.Where(companyPredicate);
                    }
                }

                // Apply dropdown state filters
                if (dropdownState == "Professor")
                {
                    companyThesesQuery = companyThesesQuery.Where(t => false);
                }
                else if (dropdownState == "Company")
                {
                    professorThesesQuery = professorThesesQuery.Where(t => false);
                }

                // Execute the queries
                var allProfessorTheses = await professorThesesQuery.ToListAsync();
                var allCompanyTheses = await companyThesesQuery.ToListAsync();

                // Process results
                sumUpThesesFromBothCompanyAndProfessor.Clear();

                sumUpThesesFromBothCompanyAndProfessor.AddRange(allProfessorTheses.Select(t => new AllTheses
                {
                    ThesisTitle = t.ThesisTitle,
                    EmailUsedToUploadThesis = t.ProfessorEmailUsedToUploadThesis,
                    ProfessorName = t.Professor?.ProfName ?? "Άγνωστο Όνομα",
                    ProfessorSurname = t.Professor?.ProfSurname ?? "Άγνωστο Επώνυμο",
                    ThesisUploadDateTime = t.ThesisUploadDateTime,
                    CompanyNameUploadedThesis = "",
                    CompanyThesisAreasUpload = "",
                    ProfessorThesisAreasUpload = t.ThesisAreas,
                    ProfessorThesisSkills = t.ThesisSkills,
                    RNGForProfessorThesisUploaded = t.RNGForThesisUploaded,
                    ThesisType = ThesisType.Professor,
                    ProfessorThesisStatus = t.ThesisStatus,
                    ProfessorDepartment = t.Professor?.ProfDepartment ?? "Άγνωστο Τμήμα",
                    RNGForProfessorThesisUploaded_HashedAsUniqueID = t.RNGForThesisUploaded_HashedAsUniqueID,
                }));

                // Only add company theses if not searching by professor name
                if (string.IsNullOrEmpty(searchNameSurnameAsStudentToFindProfessor))
                {
                    sumUpThesesFromBothCompanyAndProfessor.AddRange(allCompanyTheses.Select(t => new AllTheses
                    {
                        ThesisTitle = t.CompanyThesisTitle,
                        EmailUsedToUploadThesis = t.CompanyEmailUsedToUploadThesis,
                        ProfessorName = "",
                        ProfessorSurname = "",
                        ThesisUploadDateTime = t.CompanyThesisUploadDateTime,
                        CompanyNameUploadedThesis = t.Company?.CompanyName ?? "Άγνωστη Εταιρεία",
                        CompanyThesisAreasUpload = t.CompanyThesisAreasUpload,
                        CompanyThesisSkillsNeeded = t.CompanyThesisSkillsNeeded,
                        ProfessorThesisAreasUpload = "",
                        RNGForCompanyThesisUploaded = t.RNGForThesisUploadedAsCompany,
                        ThesisType = ThesisType.Company,
                        CompanyThesisStatus = t.CompanyThesisStatus,
                        RNGForCompanyThesisUploaded_HashedAsUniqueID = t.RNGForThesisUploadedAsCompany_HashedAsUniqueID,
                    }));
                }

                StateHasChanged();
                showThesisApplications = sumUpThesesFromBothCompanyAndProfessor.Any();
                showThesisApplications = true;
                await FilterThesisApplicationsToSearchAsStudent();  

                if (sumUpThesesFromBothCompanyAndProfessor?.Any() == false)
                {
                    await Task.Delay(50);
                    await JS.InvokeVoidAsync("scrollToElement", "noThesesFoundAlert");
                }
            }
            finally
            {
                isLoadingSearchThesisApplicationsAsStudent = false;
                StateHasChanged(); // Force UI update to hide loading state
            }
        }


        // Global Search Property for Jobs
        private string globalJobSearch = string.Empty;
        private bool isLoadingSearchJobApplicationsAsStudent = false;
        private async Task SearchJobApplicationsAsStudent()
        {
            isLoadingSearchJobApplicationsAsStudent = true;
            StateHasChanged(); // Force UI update to show loading state
        
            try
            {
                dbContext.ChangeTracker.Clear();
                var query = dbContext.CompanyJobs
                    .Include(j => j.Company)
                    .AsQueryable();

                // GLOBAL SEARCH - Enhanced implementation with multi-word support
                if (!string.IsNullOrEmpty(globalJobSearch))
                {
                    var searchTerm = globalJobSearch.Trim();
                    var searchWords = searchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                
                    // Get all areas and subfields that match any of the search words
                    var areaPredicate = PredicateBuilder.New<Area>();
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaName, $"%{tempWord}%"));
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaSubFields, $"%{tempWord}%"));
                    }

                    var matchingAreas = await dbContext.Areas
                        .Where(areaPredicate)
                        .Select(a => new { a.AreaName, a.AreaSubFields })
                        .ToListAsync();

                    // Extract area names and subfields for searching
                    var areaSearchTerms = new List<string>();
                    foreach (var area in matchingAreas)
                    {
                        areaSearchTerms.Add(area.AreaName);
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subFields = area.AreaSubFields.Split(',', StringSplitOptions.RemoveEmptyEntries);
                            areaSearchTerms.AddRange(subFields.Select(s => s.Trim()));
                        }
                    }
                
                    // Remove duplicates
                    areaSearchTerms = areaSearchTerms.Distinct().ToList();

                    // Search across multiple fields with multi-word support
                    var globalPredicate = PredicateBuilder.New<CompanyJob>();
                
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionTitle, $"%{tempWord}%"));
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionDescription, $"%{tempWord}%"));
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionAreas, $"%{tempWord}%"));
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionPerifereiaLocation, $"%{tempWord}%"));
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionDimosLocation, $"%{tempWord}%"));
                    }
                
                    // Add area and subfield searches
                    foreach (var areaTerm in areaSearchTerms)
                    {
                        var tempTerm = areaTerm;
                        globalPredicate = globalPredicate.Or(j => EF.Functions.Like(j.PositionAreas, $"%{tempTerm}%"));
                    }
                
                    // Search in company names with multi-word support
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        globalPredicate = globalPredicate.Or(j => j.Company != null && 
                            EF.Functions.Like(j.Company.CompanyName, $"%{tempWord}%"));
                    }

                    query = query.Where(globalPredicate);
                }
                else
                {
                    // Apply specific filters only when no global search is active
                
                    // Filter by Position Title
                    if (!string.IsNullOrEmpty(jobSearch))
                    {
                        query = query.Where(j => EF.Functions.Like(j.PositionTitle, $"%{jobSearch}%"));
                    }

                    // Filter by Company Name
                    if (!string.IsNullOrEmpty(companyNameSearch))
                    {
                        query = query.Where(j => j.Company != null && 
                            EF.Functions.Like(j.Company.CompanyName, $"%{companyNameSearch}%"));
                    }
                }

                // Apply common filters (both global and specific searches)
                var startOfDayForJobs = selectedDateToSearchJob.Date;
                query = query.Where(j => j.PositionActivePeriod >= startOfDayForJobs);

                if (!string.IsNullOrEmpty(positionTypeSearch))
                {
                    query = query.Where(j => EF.Functions.Like(j.PositionType, $"%{positionTypeSearch}%"));
                }

                if (!string.IsNullOrEmpty(jobSearchByRegion))
                {
                    query = query.Where(j => j.PositionPerifereiaLocation == jobSearchByRegion);
                }

                if (!string.IsNullOrEmpty(jobSearchByTown))
                {
                    query = query.Where(j => j.PositionDimosLocation == jobSearchByTown);
                }

                if (companyjobSearchByTransportOffer)
                {
                    query = query.Where(j => j.PositionTransportOffer);
                }

                // Execute the query
                var allJobs = await query.ToListAsync();

                // Apply in-memory filters for areas AND subfields
                if (selectedPositionAreas.Any() || selectedPositionSubFields.Any())
                {
                    // Combine areas and subfields for searching
                    var allSearchTerms = selectedPositionAreas.Union(selectedPositionSubFields).ToList();
        
                    allJobs = allJobs.Where(j => j.PositionAreas?
                        .Split(',', StringSplitOptions.TrimEntries)
                        .Any(area => allSearchTerms.Contains(area, StringComparer.OrdinalIgnoreCase)) ?? false)
                        .ToList();
                }

                // Update results
                jobs = allJobs;
                showJobApplications = true; 
                StateHasChanged();

                // Handle empty results
                var publishedJobs = jobs?.Where(i => i.PositionStatus == "Δημοσιευμένη").ToList();
                if (publishedJobs?.Any() == false)
                {
                    await Task.Delay(50);
                    await JS.InvokeVoidAsync("scrollToElement", "noJobsFoundAlert");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Search error: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την αναζήτηση");
            }
            finally
            {
                isLoadingSearchJobApplicationsAsStudent = false;
                StateHasChanged(); // Force UI update to hide loading state
            }
        }

        private List<AllInternships> publishedInternships = new();
        private bool searchPerformedForInternships = false;
        private string globalInternshipSearch = string.Empty;
        private bool isLoadingSearchInternshipsAsStudent = false;
        private async Task SearchInternshipsAsStudent()
        {
            isLoadingSearchInternshipsAsStudent = true;
            StateHasChanged(); // Force UI update to show loading state
        
            try
            {
                searchPerformedForInternships = true;

                dbContext.ChangeTracker.Clear();

                // Initialize queries with Company and Professor included
                var companyInternshipsQuery = dbContext.CompanyInternships
                    .Include(i => i.Company)
                    .Where(i => i.CompanyUploadedInternshipStatus == "Δημοσιευμένη")
                    .AsQueryable();

                var professorInternshipsQuery = dbContext.ProfessorInternships
                    .Include(i => i.Professor)
                    .Where(i => i.ProfessorUploadedInternshipStatus == "Δημοσιευμένη")
                    .AsQueryable();

                // GLOBAL SEARCH - Enhanced implementation with multi-word support
                if (!string.IsNullOrEmpty(globalInternshipSearch))
                {
                    var searchTerm = globalInternshipSearch.Trim();
                    var searchWords = searchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                
                    // Get all areas and subfields that match any of the search words
                    var areaPredicate = PredicateBuilder.New<Area>();
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaName, $"%{tempWord}%"));
                        areaPredicate = areaPredicate.Or(a => EF.Functions.Like(a.AreaSubFields, $"%{tempWord}%"));
                    }

                    var matchingAreas = await dbContext.Areas
                        .Where(areaPredicate)
                        .Select(a => new { a.AreaName, a.AreaSubFields })
                        .ToListAsync();

                    // Extract area names and subfields for searching
                    var areaSearchTerms = new List<string>();
                    foreach (var area in matchingAreas)
                    {
                        areaSearchTerms.Add(area.AreaName);
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subFields = area.AreaSubFields.Split(',', StringSplitOptions.RemoveEmptyEntries);
                            areaSearchTerms.AddRange(subFields.Select(s => s.Trim()));
                        }
                    }
                
                    // Remove duplicates
                    areaSearchTerms = areaSearchTerms.Distinct().ToList();

                    // Search across multiple fields with multi-word support for Company Internships
                    var companyPredicate = PredicateBuilder.New<CompanyInternship>();
                    var professorPredicate = PredicateBuilder.New<ProfessorInternship>();
                
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                    
                        // Company Internship fields
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipTitle, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipDescription, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipAreas, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipPerifereiaLocation, $"%{tempWord}%"));
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipDimosLocation, $"%{tempWord}%"));
                    
                        // Professor Internship fields
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipTitle, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipDescription, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipAreas, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipPerifereiaLocation, $"%{tempWord}%"));
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipDimosLocation, $"%{tempWord}%"));
                    }
                
                    // Add area and subfield searches
                    foreach (var areaTerm in areaSearchTerms)
                    {
                        var tempTerm = areaTerm;
                        companyPredicate = companyPredicate.Or(j => EF.Functions.Like(j.CompanyInternshipAreas, $"%{tempTerm}%"));
                        professorPredicate = professorPredicate.Or(j => EF.Functions.Like(j.ProfessorInternshipAreas, $"%{tempTerm}%"));
                    }
                
                    // Search in company names with multi-word support
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        companyPredicate = companyPredicate.Or(j => j.Company != null && 
                            EF.Functions.Like(j.Company.CompanyName, $"%{tempWord}%"));
                    }
                
                    // Search in professor names with multi-word support
                    foreach (var word in searchWords)
                    {
                        var tempWord = word;
                        professorPredicate = professorPredicate.Or(j => j.Professor != null && (
                            EF.Functions.Like(j.Professor.ProfName, $"%{tempWord}%") ||
                            EF.Functions.Like(j.Professor.ProfSurname, $"%{tempWord}%") ||
                            EF.Functions.Like(j.Professor.ProfName + " " + j.Professor.ProfSurname, $"%{tempWord}%") ||
                            EF.Functions.Like(j.Professor.ProfSurname + " " + j.Professor.ProfName, $"%{tempWord}%")
                        ));
                    }

                    companyInternshipsQuery = companyInternshipsQuery.Where(companyPredicate);
                    professorInternshipsQuery = professorInternshipsQuery.Where(professorPredicate);
                }
                else
                {
                    // Apply specific filters only when no global search is active
                
                    // Title filter
                    if (!string.IsNullOrEmpty(companyinternshipSearch))
                    {
                        var searchTerm = $"%{companyinternshipSearch}%";
                        companyInternshipsQuery = companyInternshipsQuery
                            .Where(j => EF.Functions.Like(j.CompanyInternshipTitle, searchTerm));
                        professorInternshipsQuery = professorInternshipsQuery
                            .Where(j => EF.Functions.Like(j.ProfessorInternshipTitle, searchTerm));
                    }
                }

                // Apply common filters (both global and specific searches)
            
                // Type filter
                if (!string.IsNullOrEmpty(companyinternshipSearchByType))
                {
                    if (companyinternshipSearchByType == "Part-Time_Full-Time")
                    {
                        // When user selects "Πλήρους ή Μερικής", show both Full-Time AND Part-Time
                        companyInternshipsQuery = companyInternshipsQuery
                            .Where(j => j.CompanyInternshipType == "Full-Time" || 
                                    j.CompanyInternshipType == "Part-Time");
                        professorInternshipsQuery = professorInternshipsQuery
                            .Where(j => j.ProfessorInternshipType == "Full-Time" || 
                                    j.ProfessorInternshipType == "Part-Time");
                    }
                    else
                    {
                        // For specific type selection (Full-Time only or Part-Time only)
                        companyInternshipsQuery = companyInternshipsQuery
                            .Where(j => j.CompanyInternshipType == companyinternshipSearchByType);
                        professorInternshipsQuery = professorInternshipsQuery
                            .Where(j => j.ProfessorInternshipType == companyinternshipSearchByType);
                    }
                }

                // ESPA filter
                if (!string.IsNullOrEmpty(companyinternshipSearchByESPA))
                {
                    if (companyinternshipSearchByESPA == "ESPA-Funding_Self-Funding")
                    {
                        // When user selects "Μέσω ΕΣΠΑ ή Ιδίου Φορέα", show both ESPA-Funding AND Self-Funding
                        companyInternshipsQuery = companyInternshipsQuery
                            .Where(j => j.CompanyInternshipESPA == "ESPA-Funding" || 
                                    j.CompanyInternshipESPA == "Self-Funding");
                        professorInternshipsQuery = professorInternshipsQuery
                            .Where(j => j.ProfessorInternshipESPA == "ESPA-Funding" || 
                                    j.ProfessorInternshipESPA == "Self-Funding");
                    }
                    else
                    {
                        // For specific funding selection (ESPA-Funding only or Self-Funding only)
                        companyInternshipsQuery = companyInternshipsQuery
                            .Where(j => j.CompanyInternshipESPA == companyinternshipSearchByESPA);
                        professorInternshipsQuery = professorInternshipsQuery
                            .Where(j => j.ProfessorInternshipESPA == companyinternshipSearchByESPA);
                    }
                }

                // Date filters
                if (selectedDateToSearchInternship.HasValue)
                {
                    var startOfDay = selectedDateToSearchInternship.Value.Date;
                    companyInternshipsQuery = companyInternshipsQuery
                        .Where(j => j.CompanyInternshipActivePeriod >= startOfDay);
                    professorInternshipsQuery = professorInternshipsQuery
                        .Where(j => j.ProfessorInternshipActivePeriod >= startOfDay);
                }

                if (finishEstimationDateToSearchInternship.HasValue)
                {
                    var endOfDay = finishEstimationDateToSearchInternship.Value.Date;
                    companyInternshipsQuery = companyInternshipsQuery
                        .Where(j => j.CompanyInternshipFinishEstimation <= endOfDay);
                    professorInternshipsQuery = professorInternshipsQuery
                        .Where(j => j.ProfessorInternshipFinishEstimation <= endOfDay);
                }

                // Transport filter
                if (companyinternshipSearchByTransportOffer)
                {
                    companyInternshipsQuery = companyInternshipsQuery
                        .Where(j => j.CompanyInternshipTransportOffer);
                    professorInternshipsQuery = professorInternshipsQuery
                        .Where(j => j.ProfessorInternshipTransportOffer);
                }

                // Location filters
                if (!string.IsNullOrEmpty(companyinternshipSearchByTown))
                {
                    companyInternshipsQuery = companyInternshipsQuery
                        .Where(j => j.CompanyInternshipDimosLocation == companyinternshipSearchByTown);
                    professorInternshipsQuery = professorInternshipsQuery
                        .Where(j => j.ProfessorInternshipDimosLocation == companyinternshipSearchByTown);
                }
                else if (!string.IsNullOrEmpty(companyinternshipSearchByRegion))
                {
                    companyInternshipsQuery = companyInternshipsQuery
                        .Where(j => j.CompanyInternshipPerifereiaLocation == companyinternshipSearchByRegion);
                    professorInternshipsQuery = professorInternshipsQuery
                        .Where(j => j.ProfessorInternshipPerifereiaLocation == companyinternshipSearchByRegion);
                }

                var allCompanyInternships = await companyInternshipsQuery.ToListAsync();
                var allProfessorInternships = await professorInternshipsQuery.ToListAsync();

                // UPDATED: Area and subfield filter
                if (selectedInternshipAreas.Any() || selectedInternshipSubFields.Any())
                {
                    // Combine areas and subfields for searching
                    var allSearchTerms = selectedInternshipAreas.Union(selectedInternshipSubFields).ToList();
            
                    allCompanyInternships = allCompanyInternships
                        .Where(j => !string.IsNullOrEmpty(j.CompanyInternshipAreas) &&
                            j.CompanyInternshipAreas.Split(',', StringSplitOptions.TrimEntries)
                            .Any(area => allSearchTerms.Contains(area, StringComparer.OrdinalIgnoreCase)))
                        .ToList();

                    allProfessorInternships = allProfessorInternships
                        .Where(j => !string.IsNullOrEmpty(j.ProfessorInternshipAreas) &&
                            j.ProfessorInternshipAreas.Split(',', StringSplitOptions.TrimEntries)
                            .Any(area => allSearchTerms.Contains(area, StringComparer.OrdinalIgnoreCase)))
                        .ToList();
                }

                sumUpInternshipsFromBothCompanyAndProfessor.Clear();

                // Company Internship mapping
                sumUpInternshipsFromBothCompanyAndProfessor.AddRange(allCompanyInternships.Select(j => new AllInternships
                {
                    InternshipTitle = j.CompanyInternshipTitle,
                    CompanyName = j.Company?.CompanyName,
                    CompanyInternshipUploadDate = j.CompanyInternshipUploadDate,
                    InternshipStatus = j.CompanyUploadedInternshipStatus,
                    InternshipAreas = j.CompanyInternshipAreas,
                    InternshipType = "Company",
                    InternshipActivePeriod = j.CompanyInternshipActivePeriod,
                    InternshipFinishEstimation = j.CompanyInternshipFinishEstimation,
                    RNGForCompanyInternship = j.RNGForInternshipUploadedAsCompany,
                    CompanyEmail = j.CompanyEmailUsedToUploadInternship,
                    InternshipFundingType = j.CompanyInternshipESPA,
                    RNGForCompanyInternship_HashedAsUniqueID = j.RNGForInternshipUploadedAsCompany_HashedAsUniqueID
                }));

                // Professor Internship mapping
                sumUpInternshipsFromBothCompanyAndProfessor.AddRange(allProfessorInternships.Select(j => new AllInternships
                {
                    InternshipTitle = j.ProfessorInternshipTitle,
                    ProfessorName = j.Professor?.ProfName,
                    ProfessorSurname = j.Professor?.ProfSurname,
                    ProfessorEmail = j.ProfessorEmailUsedToUploadInternship,
                    ProfessorInternshipUploadDate = j.ProfessorInternshipUploadDate,
                    InternshipStatus = j.ProfessorUploadedInternshipStatus,
                    InternshipAreas = j.ProfessorInternshipAreas,
                    InternshipType = "Professor",
                    InternshipActivePeriod = j.ProfessorInternshipActivePeriod,
                    InternshipFinishEstimation = j.ProfessorInternshipFinishEstimation,
                    RNGForProfessorInternship = j.RNGForInternshipUploadedAsProfessor,
                    InternshipFundingType = j.ProfessorInternshipESPA,
                    RNGForProfessorInternship_HashedAsUniqueID = j.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID,
                    ProfessorDepartment = j.Professor?.ProfDepartment
                }));

                // Filter by department for professor internships only
                publishedInternships = sumUpInternshipsFromBothCompanyAndProfessor
                    .Where(internship => 
                        (internship.InternshipType == "Professor" && 
                        internship.ProfessorDepartment == userData.Department) ||
                        internship.InternshipType == "Company")
                    .ToList();

                showInternships = publishedInternships.Any();

                if (!showInternships)
                {
                    await Task.Delay(50); 
                    await JS.InvokeVoidAsync("scrollToElement", "noInternshipsFoundAlert");
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                searchPerformedForInternships = true;
                showInternships = false;
                Console.WriteLine($"Error searching internships: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "An error occurred while searching internships");
            }
            finally
            {
                isLoadingSearchInternshipsAsStudent = false;
                StateHasChanged(); // Force UI update to hide loading state
            }
        }

        private void NavigateToUploadThesis()
        {
            NavigationManager.NavigateTo("/uploadthesis"); 
        }
        private void NavigateToUploadInternship()
        {
            NavigationManager.NavigateTo("/uploadinternship"); 
        }
        private void NavigateToUploadJobs()
        {
            NavigationManager.NavigateTo("/uploadjobs"); 
        }


        void ClearSearchFieldsForInternshipsAsStudent()
        {
            // Clear global search
            globalInternshipSearch = string.Empty;
            
            // Clear all search input fields
            companyinternshipSearch = string.Empty;                
            companyinternshipSearchByType = string.Empty;           
            companyinternshipSearchByRegion = string.Empty;        
            companyinternshipSearchByTown = string.Empty;
            companyinternshipSearchByTransportOffer = false;  
            companyinternshipSearchByESPA = string.Empty;   

            // Clear autocomplete suggestions
            internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent.Clear();

            // Clear date filters
            selectedDateToSearchInternship = DateTime.Today;
            finishEstimationDateToSearchInternship = null;

            // Clear area and subfield filters
            selectedInternshipAreas.Clear(); 
            selectedInternshipSubFields.Clear();
            expandedInternshipAreas.Clear();
            isInternshipAreasVisible = false;

            // Clear results and flags
            publishedInternships = new List<AllInternships>();
            sumUpInternshipsFromBothCompanyAndProfessor.Clear();
            showInternships = false;              
            searchPerformedForInternships = false;

            StateHasChanged();                                      
        }



        void ClearSearchFieldsForJobApplicationsAsStudent()
        {
            // Clear global search
            globalJobSearch = string.Empty;
            
            // Clear existing fields
            jobSearch = string.Empty;
            companyNameSearch = string.Empty;
            positionTypeSearch = string.Empty;
            selectedDateToSearchJob = DateTime.Today;
            jobSearchByRegion = string.Empty; 
            jobSearchByTown = string.Empty;
            companyjobSearchByTransportOffer = false; 
        
            // Clear autocomplete suggestions
            jobTitleAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
            companyNameAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
        
            // Clear area and subfield filters
            selectedPositionAreas.Clear();
            selectedPositionSubFields.Clear();
            expandedPositionAreas.Clear();
            isPositionAreasVisible = false; 
        
            jobs = new List<CompanyJob>(); 
            showJobApplications = false;
            StateHasChanged();
        }


        void ClearSearchFieldsForThesisAsStudent()
        {
            // Clear global search field
            globalThesisSearch = string.Empty;
        
            // Clear existing specific search fields
            thesisSearchForThesesAsStudent = string.Empty;
            professorNameSearchForThesesAsStudent = string.Empty;
            professorSurnameSearchForThesesAsStudent = string.Empty;
            companyNameSearchForThesesAsStudent = string.Empty;
            thesisUploadMonthForThesesAsStudent = null;
            thesisStartDateForThesesAsStudent = DateTime.Now;

            // Clear the autocomplete fields and suggestions
            searchNameSurnameAsStudentToFindProfessor = string.Empty;
            professorNameSurnameSuggestions.Clear();
            thesisTitleSuggestions.Clear();
            companyNameSuggestionsWhenSearchForProfessorThesisAutocompleteNameAsStudent.Clear();

            // Clear area and subfield filters
            selectedThesisAreas.Clear();  
            selectedThesisSubFields.Clear();
            expandedThesisAreas.Clear();
            isThesisAreasVisible = false;  

            // Reset dropdown state
            dropdownState = "Both";

            // Reset results
            sumUpThesesFromBothCompanyAndProfessor.Clear();
            showThesisApplications = false; 

            StateHasChanged();
        }


        private async Task LoadUserThesisApplications()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                // Initialize lists and cache
                companyThesisApplications = new List<CompanyThesisApplied>();
                professorThesisApplications = new List<ProfessorThesisApplied>();
                thesisDataCache = new Dictionary<long, CompanyThesis>();
                professorThesisDataCache = new Dictionary<long, ProfessorThesis>(); 

                if (user.Identity.IsAuthenticated)
                {
                    var userEmail = user.FindFirst("name")?.Value;

                    if (!string.IsNullOrEmpty(userEmail))
                    {
                        showStudentThesisApplications = true;

                        // Get student details
                        var student = await dbContext.Students
                            .FirstOrDefaultAsync(s => s.Email == userEmail);

                        if (student != null)
                        {
                            // Fetch company thesis applications
                            companyThesisApplications = await dbContext.CompanyThesesApplied
                                .Include(a => a.StudentDetails)
                                .Include(a => a.CompanyDetails)
                                .Where(app => app.StudentEmailAppliedForThesis == userEmail && 
                                            app.StudentUniqueIDAppliedForThesis == student.Student_UniqueID)
                                .OrderByDescending(app => app.DateTimeStudentAppliedForThesis)
                                .ToListAsync();

                            // Load all related theses in one query
                            var thesisRNGs = companyThesisApplications
                                .Select(a => a.RNGForCompanyThesisApplied)
                                .ToList();

                            var theses = await dbContext.CompanyTheses
                                .Include(t => t.Company) 
                                .Where(t => thesisRNGs.Contains(t.RNGForThesisUploadedAsCompany))
                                .ToListAsync();

                            // Populate cache
                            foreach (var thesis in theses)
                            {
                                thesisDataCache[thesis.RNGForThesisUploadedAsCompany] = thesis;
                            }

                            // Fetch professor thesis applications (updated to match company pattern)
                            professorThesisApplications = await dbContext.ProfessorThesesApplied
                                .Include(a => a.StudentDetails)
                                .Include(a => a.ProfessorDetails)
                                .Where(app => app.StudentEmailAppliedForProfessorThesis == userEmail && 
                                            app.StudentUniqueIDAppliedForProfessorThesis == student.Student_UniqueID)
                                .OrderByDescending(app => app.DateTimeStudentAppliedForProfessorThesis)
                                .ToListAsync();

                            // Load all related professor theses in one query
                            var professorThesisRNGs = professorThesisApplications
                                .Select(a => a.RNGForProfessorThesisApplied)
                                .ToList();

                            var professorTheses = await dbContext.ProfessorTheses
                                .Where(t => professorThesisRNGs.Contains(t.RNGForThesisUploaded))
                                .ToListAsync();

                            // Populate professor thesis cache if needed
                            foreach (var thesis in professorTheses)
                            {
                                professorThesisDataCache[thesis.RNGForThesisUploaded] = thesis;
                            }

                        }
                    }
                }

                Console.WriteLine($"Company Thesis Applications: {companyThesisApplications.Count()}");
                Console.WriteLine($"Professor Thesis Applications: {professorThesisApplications.Count()}");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading thesis applications: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task LoadUserJobApplications()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity.IsAuthenticated)
                {
                    var userEmail = user.FindFirst("name")?.Value; // Get user's email from claim
                    if (!string.IsNullOrEmpty(userEmail))
                    {
                        showStudentJobApplications = true; // Set flag to indicate applications are loading

                        // Retrieve job applications using email and unique ID
                        jobApplications = await dbContext.CompanyJobsApplied
                            .Where(j => j.StudentEmailAppliedForCompanyJob == userEmail && 
                                    j.StudentUniqueIDAppliedForCompanyJob == userData.Student_UniqueID)
                            .OrderByDescending(j => j.DateTimeStudentAppliedForCompanyJob) // Added sorting
                            .ToListAsync();

                        StateHasChanged(); // Notify the UI to update
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading job applications: {ex.Message}");
                StateHasChanged();
            }
        }

        private bool isLoadingStudentThesisApplications = false;
        private async Task ToggleAndLoadStudentThesisApplications()
        {
            showStudentThesisApplications = !showStudentThesisApplications;

            if (showStudentThesisApplications)
            {
                isLoadingStudentThesisApplications = true;
                StateHasChanged();
            
                try
                {
                    await LoadUserThesisApplications();
                }
                finally
                {
                    isLoadingStudentThesisApplications = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingStudentJobApplications = false;
        private async Task ToggleAndLoadStudentJobApplications()
        {
            showStudentJobApplications = !showStudentJobApplications;

            if (showStudentJobApplications)
            {
                isLoadingStudentJobApplications = true;
                StateHasChanged();
            
                try
                {
                    await LoadUserJobApplications();
                }
                finally
                {
                    isLoadingStudentJobApplications = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool showLoadingModalWhenApplyForThesisAsStudent = false;
        private int loadingProgressWhenApplyForThesisAsStudent = 0;
        private async Task ApplyForThesisAsStudent(AllTheses thesis)
        {
            try
            {
                // Step 1: Initial confirmation - show JavaScript confirm first
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να κάνετε Αίτηση για την Διπλωματική Εργασία: {thesis.ThesisTitle}. Είστε σίγουρος/η;");
                if (!confirmed) return;

                // NOW show the loading modal after user confirms
                showLoadingModalWhenApplyForThesisAsStudent = true;
                loadingProgressWhenApplyForThesisAsStudent = 0;
                StateHasChanged();

                // Step 2: Status check
                await UpdateProgressWhenApplyForThesisAsStudent(10, 200);
            
                if (thesis.ThesisType == ThesisType.Professor)
                {
                    var latestThesis = await dbContext.ProfessorTheses
                        .AsNoTracking()
                        .Where(t => t.RNGForThesisUploaded == thesis.RNGForProfessorThesisUploaded)
                        .Select(t => new { t.ThesisStatus })
                        .FirstOrDefaultAsync();

                    if (latestThesis == null || latestThesis.ThesisStatus != "Δημοσιευμένη")
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Διπλωματική Εργασία του Καθηγητή Έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα");
                        return;
                    }
                }
                else if (thesis.ThesisType == ThesisType.Company)
                {
                    var latestThesis = await dbContext.CompanyTheses
                        .AsNoTracking()
                        .Where(t => t.RNGForThesisUploadedAsCompany == thesis.RNGForCompanyThesisUploaded)
                        .Select(t => new { t.CompanyThesisStatus })
                        .FirstOrDefaultAsync();

                    if (latestThesis == null || latestThesis.CompanyThesisStatus != "Δημοσιευμένη")
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Διπλωματική Εργασία της Εταιρείας Έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα");
                        return;
                    }
                }

                // Step 3: Authentication and student details
                await UpdateProgressWhenApplyForThesisAsStudent(20, 200);
            
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (!user.Identity.IsAuthenticated)
                {
                    showLoadingModalWhenApplyForThesisAsStudent = false;
                    StateHasChanged();
                    return;
                }

                var student = await GetStudentDetails(user.Identity.Name);
                if (student == null)
                {
                    showLoadingModalWhenApplyForThesisAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                if (thesis.ThesisType == ThesisType.Professor)
                {
                    Console.WriteLine("Detected thesis as Professor.");

                    // Step 4: Check for existing application
                    await UpdateProgressWhenApplyForThesisAsStudent(30, 200);
                
                    var existingApplication = await dbContext.ProfessorThesesApplied
                        .FirstOrDefaultAsync(app => 
                            app.StudentEmailAppliedForProfessorThesis == student.Email &&
                            app.RNGForProfessorThesisApplied == thesis.RNGForProfessorThesisUploaded);

                    if (existingApplication != null)
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                            $"Έχετε ήδη κάνει Αίτηση για την Διπλωματική Εργασία <span style='color: #8B0000; font-weight: bold;'>{thesis.ThesisTitle}</span> από τον Καθηγητή: <span style='color: #00008B; font-weight: bold;'>{thesis.ProfessorName} {thesis.ProfessorSurname}</span>!");
                        return;
                    }

                    // Step 5: Get professor data
                    await UpdateProgressWhenApplyForThesisAsStudent(40, 200);
                
                    var professor = await dbContext.Professors
                        .FirstOrDefaultAsync(p => p.ProfEmail == thesis.EmailUsedToUploadThesis);

                    if (professor == null)
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε ο καθηγητής.");
                        return;
                    }

                    // Step 6: Begin transaction and save data
                    await UpdateProgressWhenApplyForThesisAsStudent(50, 200);
                
                    using var transaction = await dbContext.Database.BeginTransactionAsync();
                    try
                    {
                        // Create main application with details
                        var professorThesisApplication = new ProfessorThesisApplied
                        {
                            RNGForProfessorThesisApplied = thesis.RNGForProfessorThesisUploaded,
                            DateTimeStudentAppliedForProfessorThesis = DateTime.Now,
                            StudentEmailAppliedForProfessorThesis = student.Email,
                            StudentUniqueIDAppliedForProfessorThesis = student.Student_UniqueID,
                            ProfessorEmailWhereStudentAppliedForProfessorThesis = thesis.EmailUsedToUploadThesis,
                            ProfessorUniqueIDWhereStudentAppliedForProfessorThesis = professor.Professor_UniqueID,
                            ProfessorThesisStatusAppliedAtProfessorSide = "Σε Επεξεργασία",
                            ProfessorThesisStatusAppliedAtStudentSide = "Σε Επεξεργασία",
                            RNGForProfessorThesisApplied_HashedAsUniqueID = thesis.RNGForProfessorThesisUploaded_HashedAsUniqueID,

                            // Navigation properties
                            StudentDetails = new ProfessorThesisApplied_StudentDetails
                            {
                                StudentEmailAppliedForProfessorThesis = student.Email,
                                StudentUniqueIDAppliedForProfessorThesis = student.Student_UniqueID,
                                DateTimeStudentAppliedForProfessorThesis = DateTime.Now,
                                RNGForProfessorThesisApplied_HashedAsUniqueID = thesis.RNGForProfessorThesisUploaded_HashedAsUniqueID
                            },

                            ProfessorDetails = new ProfessorThesisApplied_ProfessorDetails
                            {
                                ProfessorEmailWhereStudentAppliedForProfessorThesis = thesis.EmailUsedToUploadThesis,
                                ProfessorUniqueIDWhereStudentAppliedForProfessorThesis = professor.Professor_UniqueID
                            }
                        };

                        dbContext.ProfessorThesesApplied.Add(professorThesisApplication);

                        // Add platform action
                        dbContext.PlatformActions.Add(new PlatformActions
                        {
                            UserRole_PerformedAction = "STUDENT",
                            ForWhat_PerformedAction = "PROFESSOR_THESIS",
                            HashedPositionRNG_PerformedAction = HashingHelper.HashLong(thesis.RNGForProfessorThesisUploaded),
                            TypeOfAction_PerformedAction = "APPLY",
                            DateTime_PerformedAction = DateTime.Now
                        });

                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenApplyForThesisAsStudent(70, 200);
                    
                        await transaction.CommitAsync();
                        await UpdateProgressWhenApplyForThesisAsStudent(75, 200);

                        // Step 7: Send emails
                        await UpdateProgressWhenApplyForThesisAsStudent(80, 200);
                    
                        try
                        {
                            await InternshipEmailService.SendThesisApplicationConfirmationToStudent(
                                student.Email,
                                student.Name,
                                student.Surname,
                                thesis.ThesisTitle,
                                thesis.RNGForProfessorThesisUploaded_HashedAsUniqueID,
                                $"{thesis.ProfessorName} {thesis.ProfessorSurname}");

                            await InternshipEmailService.SendThesisApplicationNotificationToProfessor(
                                thesis.EmailUsedToUploadThesis,
                                $"{thesis.ProfessorName} {thesis.ProfessorSurname}",
                                student.Name,
                                student.Surname,
                                student.Email,
                                student.Telephone,
                                student.StudyYear,
                                thesis.RNGForProfessorThesisUploaded_HashedAsUniqueID,
                                student.Attachment,
                                thesis.ThesisTitle);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Email error: {ex.Message}");
                        }

                        await UpdateProgressWhenApplyForThesisAsStudent(90, 200);

                        // Step 8: Final success message
                        await UpdateProgressWhenApplyForThesisAsStudent(95, 200);
                    
                        // Small delay to show completion
                        await Task.Delay(500);
                    
                        // Hide loading modal before showing success message
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                    
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                            $"Η αίτηση για την Διπλωματική Εργασία {thesis.ThesisTitle} υποβλήθηκε επιτυχώς!");

                        // AFTER user clicks OK, show the navigation loader
                        await Task.Delay(100); // Small delay for smooth transition
            
                        // Show the navigation loader
                        await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                        // Give time for loader to render
                        await Task.Delay(300);

                        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

                    }
                    catch (Exception ex)
                    {
                        await transaction.RollbackAsync();
                        throw; // Re-throw to be caught by outer try-catch
                    }
                }
                else if (thesis.ThesisType == ThesisType.Company)
                {
                    Console.WriteLine("Detected thesis as Company.");

                    // Step 4: Check for existing application
                    await UpdateProgressWhenApplyForThesisAsStudent(30, 200);
                
                    var existingApplication = await dbContext.CompanyThesesApplied
                        .FirstOrDefaultAsync(app => 
                            app.StudentEmailAppliedForThesis == student.Email &&
                            app.RNGForCompanyThesisApplied == thesis.RNGForCompanyThesisUploaded);

                    if (existingApplication != null)
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                            $"Έχετε ήδη κάνει Αίτηση για την Διπλωματική Εργασία <span style='color: #8B0000; font-weight: bold;'>{thesis.ThesisTitle}</span> από την Εταιρεία: <span style='color: #00008B; font-weight: bold;'>{thesis.CompanyNameUploadedThesis}</span>!");
                        return;
                    }

                    // Step 5: Get company data
                    await UpdateProgressWhenApplyForThesisAsStudent(40, 200);
                
                    var company = await dbContext.Companies
                        .FirstOrDefaultAsync(c => c.CompanyEmail == thesis.EmailUsedToUploadThesis);

                    if (company == null)
                    {
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε η εταιρία.");
                        return;
                    }

                    // Step 6: Begin transaction and save data
                    await UpdateProgressWhenApplyForThesisAsStudent(50, 200);
                
                    using var transaction = await dbContext.Database.BeginTransactionAsync();
                    try
                    {
                        // Create main application with details
                        var companyThesisApplication = new CompanyThesisApplied
                        {
                            RNGForCompanyThesisApplied = thesis.RNGForCompanyThesisUploaded,
                            DateTimeStudentAppliedForThesis = DateTime.Now,
                            StudentEmailAppliedForThesis = student.Email,
                            StudentUniqueIDAppliedForThesis = student.Student_UniqueID,
                            CompanyEmailWhereStudentAppliedForThesis = thesis.EmailUsedToUploadThesis,
                            CompanyUniqueIDWhereStudentAppliedForThesis = company.Company_UniqueID,
                            CompanyThesisStatusAppliedAtCompanySide = "Σε Επεξεργασία",
                            CompanyThesisStatusAppliedAtStudentSide = "Σε Επεξεργασία",
                            RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID = thesis.RNGForCompanyThesisUploaded_HashedAsUniqueID,

                            // Navigation properties
                            StudentDetails = new CompanyThesisApplied_StudentDetails
                            {
                                StudentEmailAppliedForThesis = student.Email,
                                StudentUniqueIDAppliedForThesis = student.Student_UniqueID,
                                DateTimeStudentAppliedForThesis = DateTime.Now,
                                RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID = thesis.RNGForCompanyThesisUploaded_HashedAsUniqueID
                            },

                            CompanyDetails = new CompanyThesisApplied_CompanyDetails
                            {
                                CompanyEmailWhereStudentAppliedForThesis = thesis.EmailUsedToUploadThesis,
                                CompanyUniqueIDWhereStudentAppliedForThesis = company.Company_UniqueID
                            }
                        };

                        dbContext.CompanyThesesApplied.Add(companyThesisApplication);

                        // Add platform action
                        dbContext.PlatformActions.Add(new PlatformActions
                        {
                            UserRole_PerformedAction = "STUDENT",
                            ForWhat_PerformedAction = "COMPANY_THESIS",
                            HashedPositionRNG_PerformedAction = HashingHelper.HashLong(thesis.RNGForCompanyThesisUploaded),
                            TypeOfAction_PerformedAction = "APPLY",
                            DateTime_PerformedAction = DateTime.Now
                        });

                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenApplyForThesisAsStudent(70, 200);
                    
                        await transaction.CommitAsync();
                        await UpdateProgressWhenApplyForThesisAsStudent(75, 200);

                        // Step 7: Send emails
                        await UpdateProgressWhenApplyForThesisAsStudent(80, 200);
                    
                        try
                        {
                            await InternshipEmailService.SendThesisApplicationConfirmationToStudent(
                                student.Email,
                                student.Name,
                                student.Surname,
                                thesis.ThesisTitle,
                                thesis.RNGForCompanyThesisUploaded_HashedAsUniqueID,
                                thesis.CompanyNameUploadedThesis);

                            await InternshipEmailService.SendThesisApplicationNotificationToCompany(
                                thesis.EmailUsedToUploadThesis,
                                thesis.CompanyNameUploadedThesis,
                                student.Name,
                                student.Surname,
                                student.Email,
                                student.Telephone,
                                student.StudyYear,
                                thesis.RNGForCompanyThesisUploaded_HashedAsUniqueID,
                                student.Attachment,
                                thesis.ThesisTitle);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Email error: {ex.Message}");
                        }

                        await UpdateProgressWhenApplyForThesisAsStudent(90, 200);

                        // Step 8: Refresh student data
                        await UpdateProgressWhenApplyForThesisAsStudent(95, 200);
                        await RefreshStudentData();

                        // Step 9: Final success message
                        await UpdateProgressWhenApplyForThesisAsStudent(100, 200);
                    
                        // Small delay to show completion
                        await Task.Delay(500);
                    
                        // Hide loading modal before showing success message
                        showLoadingModalWhenApplyForThesisAsStudent = false;
                        StateHasChanged();
                    
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                            $"Η αίτηση για την Διπλωματική Εργασία {thesis.ThesisTitle} υποβλήθηκε επιτυχώς!");

                            // AFTER user clicks OK, show the navigation loader
                            await Task.Delay(100); // Small delay for smooth transition
            
                            // Show the navigation loader
                            await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                            // Give time for loader to render
                            await Task.Delay(300);

                        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

                    }
                    catch (Exception ex)
                    {
                        await transaction.RollbackAsync();
                        throw; // Re-throw to be caught by outer try-catch
                    }
                }
                else
                {
                    showLoadingModalWhenApplyForThesisAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν είναι γνωστός ο τύπος της Διπλωματικής Εργασίας.");
                    return;
                }

                // Step 10: Navigate
                // NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenApplyForThesisAsStudent = false;
                StateHasChanged();
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenApplyForThesisAsStudent(int current, int total)
        {
            loadingProgressWhenApplyForThesisAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }




        private async Task SaveChangesWithErrorHandling(DbContext context, string thesisTitle)
        {
            try
            {
                await context.SaveChangesAsync();
                await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Η Αίτηση σας για την Διπλωματική Εργασία: {thesisTitle} έχει πραγματοποιηθεί Επιτυχώς!");
            }
            catch (DbUpdateException ex)
            {
                var innerException = ex.InnerException?.Message ?? ex.Message;
                Console.WriteLine($"Error saving thesis application: {innerException}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Σφάλμα κατά την υποβολή της αίτησης. Δοκιμάστε ξανά. Λεπτομέρειες: {innerException}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error saving thesis application: {ex.Message}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα κατά την υποβολή της αίτησης. Δοκιμάστε ξανά.");
            }
        }

        private async Task LoadCompanyJobApplicantData()
        {
            try 
            {
                // Get all unique student emails from applications
                var studentEmails = jobApplicantsMap.Values
                    .SelectMany(x => x)
                    .Select(a => a.StudentEmailAppliedForCompanyJob)
                    .Distinct()
                    .ToList();

                // Load ALL student fields needed for the modal
                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                // Clear and repopulate cache
                //studentDataCache.Clear();
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Loaded {students.Count} student records with full details");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading student data: {ex.Message}");
            }
        }

        private async Task LoadCompanyInternshipApplicantData()
        {
            try 
            {
                var studentEmails = internshipApplicantsMap.Values
                    .SelectMany(x => x)
                    .Select(a => a.StudentEmailAppliedForInternship)
                    .Distinct()
                    .ToList();

                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                //studentDataCache.Clear(); // Optional: keep if job & internship data shouldn't mix
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Loaded {students.Count} internship student records");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading internship student data: {ex.Message}");
            }
        }

        // ============================================================================
        // PROFESSOR ROLE - INTERNSHIP APPLICANT MANAGEMENT
        // ============================================================================
        // Methods for professors to view and manage internship applicants
        private async Task LoadProfessorInternshipApplicantData()
        {
            try 
            {
                var studentEmails = professorInternshipApplicantsMap.Values
                    .SelectMany(x => x)
                    .Select(a => a.StudentDetails.StudentEmailAppliedForProfessorInternship)
                    .Distinct()
                    .ToList();

                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                //studentDataCache.Clear(); // Optional: keep if job & internship data shouldn't mix
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Loaded {students.Count} professor internship student records");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor internship student data: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadCompanyThesisApplicantData()
        {
            try 
            {
                // Get all unique student emails from applications
                var studentEmails = companyThesisApplicantsMap.Values
                    .SelectMany(x => x)
                    .Select(a => a.StudentEmailAppliedForThesis)
                    .Distinct()
                    .ToList();

                // Load ALL student fields needed for the modal
                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                // Clear and repopulate cache
                //studentDataCache.Clear();
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Loaded {students.Count} student records for thesis applicants");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading thesis applicant student data: {ex.Message}");
            }
        }



        private async Task<Student> GetStudentDetails(string email)
        {
            return await dbContext.Students
                .Where(s => s.Email.ToLower() == email.ToLower()) 
                .Select(s => new Student {
                    Id = s.Id,
                    Email = s.Email,
                    Name = s.Name,
                    Surname = s.Surname,
                    StudyYear = s.StudyYear,
                    Telephone = s.Telephone,
                    Student_UniqueID = s.Student_UniqueID,
                    RegNumber = s.RegNumber,
                    Attachment = s.Attachment
                })
                .AsNoTracking() // Better performance for read-only
                .FirstOrDefaultAsync();
        }

        private async Task<Company> GetCompanyDetails(string email)
        {
            return await dbContext.Companies
                .Where(c => c.CompanyEmail.ToLower() == email.ToLower())
                .Select(c => new Company {
                    CompanyEmail = c.CompanyEmail,
                    Company_UniqueID = c.Company_UniqueID,
                    CompanyLogo = c.CompanyLogo,
                    CompanyName = c.CompanyName,
                    CompanyShortName = c.CompanyShortName,
                    CompanyType = c.CompanyType,
                    CompanyActivity = c.CompanyActivity,
                    CompanyTelephone = c.CompanyTelephone,
                    CompanyWebsite = c.CompanyWebsite,
                    CompanyCountry = c.CompanyCountry,
                    CompanyLocation = c.CompanyLocation,
                    CompanyPC = c.CompanyPC,
                    CompanyRegions = c.CompanyRegions,
                    CompanyTown = c.CompanyTown,
                    CompanyDescription = c.CompanyDescription,
                    CompanyAreas = c.CompanyAreas,
                    CompanyHRName = c.CompanyHRName,
                    CompanyHRSurname = c.CompanyHRSurname,
                    CompanyHREmail = c.CompanyHREmail,
                    CompanyHRTelephone = c.CompanyHRTelephone,
                    CompanyAdminName = c.CompanyAdminName,
                    CompanyAdminSurname = c.CompanyAdminSurname,
                    CompanyAdminEmail = c.CompanyAdminEmail,
                    CompanyAdminTelephone = c.CompanyAdminTelephone
                })
                .AsNoTracking() // Better performance for read-only
                .FirstOrDefaultAsync();
        }

        private async Task<Professor> GetProfessorDetails(string email)
        {
            return await dbContext.Professors
                .Where(p => p.ProfEmail.ToLower() == email.ToLower())
                .Select(p => new Professor {
                    Id = p.Id,
                    ProfEmail = p.ProfEmail,
                    Professor_UniqueID = p.Professor_UniqueID,
                    ProfName = p.ProfName,
                    ProfSurname = p.ProfSurname,
                    ProfUniversity = p.ProfUniversity,
                    ProfDepartment = p.ProfDepartment,
                    ProfWorkTelephone = p.ProfWorkTelephone,
                    ProfPersonalTelephone = p.ProfPersonalTelephone,
                    ProfPersonalTelephoneVisibility = p.ProfPersonalTelephoneVisibility,
                    ProfPersonalWebsite = p.ProfPersonalWebsite,
                    ProfGeneralFieldOfWork = p.ProfGeneralFieldOfWork,
                    ProfGeneralSkills = p.ProfGeneralSkills
                })
                .AsNoTracking() // Better performance for read-only
                .FirstOrDefaultAsync();
        }

        private bool showLoadingModalWhenApplyForJobAsStudent = false;
        private int loadingProgressWhenApplyForJobAsStudent = 0;
        private async Task ApplyForJobAsStudent(CompanyJob job)
        {
            try
            {
                // NO confirmation dialog here - it's already in ConfirmApplyForJob
                // Show the loading modal immediately since user already confirmed
                showLoadingModalWhenApplyForJobAsStudent = true;
                loadingProgressWhenApplyForJobAsStudent = 0;
                StateHasChanged();

                // Step 1: Check job status
                await UpdateProgressWhenApplyForJobAsStudent(10, 200);
            
                var latestJob = await dbContext.CompanyJobs
                    .AsNoTracking()
                    .Where(j => j.RNGForPositionUploaded == job.RNGForPositionUploaded)
                    .Select(j => new { j.PositionStatus })
                    .FirstOrDefaultAsync();

                if (latestJob == null || latestJob.PositionStatus != "Δημοσιευμένη")
                {
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Θέση Εργασίας έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα.");
                    return;
                }

                // Step 2: Authentication and student details
                await UpdateProgressWhenApplyForJobAsStudent(20, 200);
            
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (!user.Identity.IsAuthenticated)
                {
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                    return;
                }

                var student = await GetStudentDetails(user.Identity.Name);
                if (student == null)
                {
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 3: Check for existing application
                await UpdateProgressWhenApplyForJobAsStudent(30, 200);
            
                var existingApplication = await dbContext.CompanyJobsApplied
                    .FirstOrDefaultAsync(app =>
                        app.StudentEmailAppliedForCompanyJob == student.Email &&
                        app.RNGForCompanyJobApplied == job.RNGForPositionUploaded);

                if (existingApplication != null)
                {
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη κάνει αίτηση για: {job.PositionTitle}!");
                    return;
                }

                // Step 4: Get company data
                await UpdateProgressWhenApplyForJobAsStudent(40, 200);
            
                var company = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == job.EmailUsedToUploadJobs);

                if (company == null)
                {
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε η εταιρία.");
                    return;
                }

                // Step 5: Begin transaction and save data
                await UpdateProgressWhenApplyForJobAsStudent(50, 200);
            
                using var transaction = await dbContext.Database.BeginTransactionAsync();
                try
                {
                    // Create main application with details
                    var jobApplication = new CompanyJobApplied
                    {
                        RNGForCompanyJobApplied = job.RNGForPositionUploaded,
                        DateTimeStudentAppliedForCompanyJob = DateTime.Now,
                        StudentEmailAppliedForCompanyJob = student.Email,
                        StudentUniqueIDAppliedForCompanyJob = student.Student_UniqueID,
                        CompanysEmailWhereStudentAppliedForCompanyJob = job.EmailUsedToUploadJobs,
                        CompanysUniqueIDWhereStudentAppliedForCompanyJob = company.Company_UniqueID,
                        CompanyPositionStatusAppliedAtTheCompanySide = "Σε Επεξεργασία",
                        CompanyPositionStatusAppliedAtTheStudentSide = "Σε Επεξεργασία",
                        RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID = job.RNGForPositionUploaded_HashedAsUniqueID,
            
                        StudentDetails = new CompanyJobApplied_StudentDetails
                        {
                            StudentEmailAppliedForCompanyJob = student.Email,
                            StudentUniqueIDAppliedForCompanyJob = student.Student_UniqueID,
                            DateTimeStudentAppliedForCompanyJob = DateTime.Now,
                            RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID = job.RNGForPositionUploaded_HashedAsUniqueID
                        },
            
                        CompanyDetails = new CompanyJobApplied_CompanyDetails
                        {
                            CompanysEmailWhereStudentAppliedForCompanyJob = job.EmailUsedToUploadJobs,
                            CompanysUniqueIDWhereStudentAppliedForCompanyJob = company.Company_UniqueID
                        }
                    };

                    dbContext.CompanyJobsApplied.Add(jobApplication);

                    // Add platform action
                    dbContext.PlatformActions.Add(new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "COMPANY_JOB",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(job.RNGForPositionUploaded),
                        TypeOfAction_PerformedAction = "APPLY",
                        DateTime_PerformedAction = DateTime.Now
                    });

                    await dbContext.SaveChangesAsync();
                    await UpdateProgressWhenApplyForJobAsStudent(70, 200);
                
                    await transaction.CommitAsync();
                    await UpdateProgressWhenApplyForJobAsStudent(75, 200);

                    // Step 6: Send emails
                    await UpdateProgressWhenApplyForJobAsStudent(80, 200);
                
                    try
                    {
                        if (job.Company == null)
                        {
                            await dbContext.Entry(job)
                                .Reference(j => j.Company)
                                .LoadAsync();
                        }

                        await InternshipEmailService.SendJobApplicationConfirmationToStudent(
                            student.Email, student.Name, student.Surname,
                            job.PositionTitle, job.RNGForPositionUploaded_HashedAsUniqueID, 
                            job.Company?.CompanyName);

                        await InternshipEmailService.SendJobApplicationNotificationToCompany(
                            job.EmailUsedToUploadJobs, job.Company?.CompanyName,
                            student.Name, student.Surname, student.Email,
                            student.Telephone, student.StudyYear, student.Attachment,
                            job.RNGForPositionUploaded_HashedAsUniqueID, job.PositionTitle);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Email error: {ex.Message}");
                    }

                    await UpdateProgressWhenApplyForJobAsStudent(90, 200);

                    // Step 7: Refresh student data
                    await UpdateProgressWhenApplyForJobAsStudent(95, 200);
                    await RefreshStudentData();

                    // Step 8: Final success message
                    await UpdateProgressWhenApplyForJobAsStudent(100, 200);
                
                    // Small delay to show completion
                    await Task.Delay(500);
                
                    // Hide loading modal before showing success message
                    showLoadingModalWhenApplyForJobAsStudent = false;
                    StateHasChanged();
                
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Η αίτηση για {job.PositionTitle} υποβλήθηκε επιτυχώς!");

                        // AFTER user clicks OK, show the navigation loader
                        await Task.Delay(100); // Small delay for smooth transition
            
                        // Show the navigation loader
                        await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                        // Give time for loader to render
                        await Task.Delay(300);
                
                    // Step 9: Navigate
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw; // Re-throw to be caught by outer try-catch
                }
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenApplyForJobAsStudent = false;
                StateHasChanged();
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenApplyForJobAsStudent(int current, int total)
        {
            loadingProgressWhenApplyForJobAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }

        private bool showLoadingModalForJob = false;
        private async Task UploadJobAsCompany(bool publishJob = false)
        {
            // Show loading modal and reset progress
            showLoadingModalForJob = true;
            loadingProgress = 0;
            showErrorMessageforUploadingjobsAsCompany = false;
            showSuccessMessage = false;
            StateHasChanged();
        
            try
            {
                // Step 1: Get user authentication and company data
                await UpdateProgressWhenSaveJobAsCompany(10);
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    var company = await dbContext.Companies.FirstOrDefaultAsync(c => c.CompanyEmail == userEmail);
                    if (company != null)
                    {
                        companyName = company.CompanyName;
                    }
                }
                await UpdateProgressWhenSaveJobAsCompany(20);

                // Step 2: Validation checks
                await UpdateProgressWhenSaveJobAsCompany(30);
                if (await HandleJobValidationWhenSaveJobAsCompany() == false)
                {
                    return;
                }
                await UpdateProgressWhenSaveJobAsCompany(40);

                // Step 3: Prepare job data
                await UpdateProgressWhenSaveJobAsCompany(50);
                job.RNGForPositionUploaded = new Random().NextInt64();
                job.RNGForPositionUploaded_HashedAsUniqueID = HashingHelper.HashLong(job.RNGForPositionUploaded);
                job.EmailUsedToUploadJobs = userEmail;
                job.UploadDateTime = DateTime.Now;
                job.PositionForeas = companyData.CompanyType;
        
                // Build areas and subfields string
                var areasWithSubfields = new List<string>();
        
                // Add selected areas (using AreaName)
                foreach (var area in SelectedAreasWhenUploadJobAsCompany)
                {
                    areasWithSubfields.Add(area.AreaName);
                }
        
                // Add subfields (just the subfield names, not with area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForCompanyJob)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }
        
                // Save all as comma-separated string in the same field
                job.PositionAreas = string.Join(",", areasWithSubfields);
        
                job.PositionStatus = publishJob ? "Δημοσιευμένη" : "Μη Δημοσιευμένη";
                await UpdateProgressWhenSaveJobAsCompany(60);

                // Step 4: Save to database
                await UpdateProgressWhenSaveJobAsCompany(70);
                dbContext.CompanyJobs.Add(job);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveJobAsCompany(80);

                // Step 5: Success - clear form and prepare for navigation
                await UpdateProgressWhenSaveJobAsCompany(90);
                showSuccessMessage = true;
                showErrorMessageforUploadingjobsAsCompany = false;

                // Clear all form fields including subfields
                job = new CompanyJob();
                SelectedAreasWhenUploadJobAsCompany.Clear();
                SelectedSubFieldsForCompanyJob.Clear();
                ExpandedAreasForCompanyJob.Clear();
            
                await UpdateProgressWhenSaveJobAsCompany(100);

                // Small delay to show completion
                await Task.Delay(500);
            
                // Navigate to refresh
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForJob = false;
            
                showSuccessMessage = false;
                showErrorMessagesForAreasWhenUploadJobAsCompany = false;
                showErrorMessageforUploadingjobsAsCompany = true;
                Console.WriteLine($"Error uploading job: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task<bool> HandleJobValidationWhenSaveJobAsCompany()
        {
            // Check each required field and scroll to it if it is missing
            if (string.IsNullOrWhiteSpace(job.PositionType))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionType");
                return false;
            }

            if (job.PositionActivePeriod.Date <= DateTime.Today)
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionActivePeriod");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionTitle))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionTitle");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionContactPerson))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionContactPerson");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionPerifereiaLocation))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionPerifereia");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionDimosLocation))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionDimos");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionDescription))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionDescription");
                return false;
            }

            if (string.IsNullOrWhiteSpace(job.PositionAddressLocation))
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionAddress");
                return false;
            }

            // Check if there are any selections (areas OR subfields)
            if (!HasAnySelectionForCompanyJob())
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("positionAreas");
                return false;
            }

            // Add Open Slots validation - MUST be at least 3
            if (job.OpenSlots < 3)
            {
                await HandleJobValidationErrorWhenSaveJobAsCompany("openSlots");
                return false;
            }

            return true;
        }

        private async Task HandleJobValidationErrorWhenSaveJobAsCompany(string elementId)
        {
            showLoadingModalForJob = false;
            showErrorMessageforUploadingjobsAsCompany = true;
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
        }

        private async Task UpdateProgressWhenSaveJobAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }


        private bool showLoadingModalForThesis = false;
        private async Task UploadThesisAsCompany(bool publishThesis = false)
        {
            // Show loading modal and reset progress
            showLoadingModalForThesis = true;
            loadingProgress = 0;
            showErrorMessageforUploadingthesisAsCompany = false;
            showSuccessMessage = false;
            StateHasChanged();
        
            try
            {
                // Step 1: Initial setup and authentication
                await UpdateProgressWhenSaveThesisAsCompany(10);
                Console.WriteLine("=== INITIAL FIELD VALUES ===");
                LogCurrentThesisState();
                Console.WriteLine("===========================");

                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    var company = await dbContext.Companies.FirstOrDefaultAsync(c => c.CompanyEmail == userEmail);
                    if (company != null)
                    {
                        companyName = company.CompanyName;
                    }
                }
                await UpdateProgressWhenSaveThesisAsCompany(20);

                // Step 2: Prepare skills and areas data
                await UpdateProgressWhenSaveThesisAsCompany(30);
                thesis.CompanyThesisSkillsNeeded = string.Join(",", SelectedSkillsWhenUploadThesisAsCompany.Select(a => a.SkillName));
        
                // Build areas and subfields string for thesis
                var areasWithSubfields = new List<string>();

                // Add selected areas (using AreaName)
                foreach (var area in SelectedAreasWhenUploadThesisAsCompany)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields (just the subfield names, not with area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForCompanyThesis)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Save all as comma-separated string in the same field
                thesis.CompanyThesisAreasUpload = string.Join(",", areasWithSubfields);
                await UpdateProgressWhenSaveThesisAsCompany(40);

                // Step 3: Validation checks
                await UpdateProgressWhenSaveThesisAsCompany(50);
                // Debug logging before validation
                Console.WriteLine("=== FIELD VALUES BEFORE VALIDATION ===");
                LogCurrentThesisState();
                Console.WriteLine("=====================================");

                if (await HandleThesisValidationWhenSaveThesisAsCompany() == false)
                {
                    return;
                }
                await UpdateProgressWhenSaveThesisAsCompany(60);

                // Step 4: Prepare thesis data
                await UpdateProgressWhenSaveThesisAsCompany(70);
                // Final debug logging before save
                Console.WriteLine("=== FINAL VALUES BEFORE SAVE ===");
                LogCurrentThesisState();
                Console.WriteLine("===============================");

                // Prepare thesis for saving
                thesis.RNGForThesisUploadedAsCompany = new Random().NextInt64();
                thesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID = HashingHelper.HashLong(thesis.RNGForThesisUploadedAsCompany);
                thesis.CompanyEmailUsedToUploadThesis = userEmail;  // This is now the foreign key
                thesis.CompanyThesisUploadDateTime = DateTime.Now;
                thesis.ThesisType = ThesisType.Company;
                thesis.IsProfessorInteresetedInCompanyThesis = false;
                thesis.IsProfessorInterestedInCompanyThesisStatus = "Δεν έχει γίνει Αποδοχή";
                thesis.CompanyThesisStatus = publishThesis ? "Δημοσιευμένη" : "Μη Δημοσιευμένη";
                thesis.OpenSlots_CompanyThesis = thesis.OpenSlots_CompanyThesis;
                await UpdateProgressWhenSaveThesisAsCompany(80);

                // Step 5: Save to database
                await UpdateProgressWhenSaveThesisAsCompany(90);
                Console.WriteLine("Before saving changes...");
                dbContext.CompanyTheses.Add(thesis);

                // Log entity states
                var entries = dbContext.ChangeTracker.Entries();
                foreach (var entry in entries)
                {
                    Console.WriteLine($"{entry.Entity.GetType().Name} - {entry.State}");
                }

                await dbContext.SaveChangesAsync();
                Console.WriteLine("After saving changes...");
                await UpdateProgressWhenSaveThesisAsCompany(95);

                // Step 6: Success
                await UpdateProgressWhenSaveThesisAsCompany(100);
                showSuccessMessage = true;
                showErrorMessageforUploadingthesisAsCompany = false;

                // Clear all form fields including subfields
                thesis = new CompanyThesis();
                SelectedAreasWhenUploadThesisAsCompany.Clear();
                SelectedSubFieldsForCompanyThesis.Clear();
                ExpandedAreasForCompanyThesis.Clear();
                SelectedSkillsWhenUploadThesisAsCompany.Clear();

                // Small delay to show completion
                await Task.Delay(500);
            
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForThesis = false;
            
                Console.WriteLine($"Error uploading thesis: {ex.Message}");
                Console.WriteLine($"Stack Trace: {ex.StackTrace}");
                showSuccessMessage = false;
                showErrorMessagesForSkillsWhenUploadThesisAsCompany = true;
                showErrorMessageforUploadingthesisAsCompany = true;
                StateHasChanged();
            }
        }

        private async Task<bool> HandleThesisValidationWhenSaveThesisAsCompany()
        {
            // Validation checks
            if (string.IsNullOrWhiteSpace(thesis.CompanyThesisTitle))
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("companyThesisTitle");
                return false;
            }

            if (string.IsNullOrWhiteSpace(thesis.CompanyThesisDescriptionsUploaded))
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("CompanyThesisDescription");
                return false;
            }

            if (string.IsNullOrWhiteSpace(thesis.CompanyThesisCompanySupervisorFullName))
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("CompanyThesisCompanySupervisorFullName");
                return false;
            }

            if (string.IsNullOrWhiteSpace(thesis.CompanyThesisContactPersonEmail))
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("thesisContactPersonEmail");
                return false;
            }

            if (thesis.CompanyThesisStartingDate.Date <= DateTime.Today)
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("CompanyThesisStartingDate");
                return false;
            }

            // Check if there are any selections (areas OR subfields)
            if (!HasAnySelectionForCompanyThesis())
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("toggleCheckboxesForThesisAreas");
                return false;
            }

            if (!SelectedSkillsWhenUploadThesisAsCompany.Any() || string.IsNullOrWhiteSpace(thesis.CompanyThesisSkillsNeeded))
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("toggleCheckboxesForThesisSkills");
                return false;
            }

            // ADDED: Open Slots validation - MUST be at least 3
            if (thesis.OpenSlots_CompanyThesis < 3)
            {
                await HandleThesisValidationErrorWhenSaveThesisAsCompany("companyThesisOpenSlots");
                return false;
            }

            return true;
        }

        private async Task HandleThesisValidationErrorWhenSaveThesisAsCompany(string elementId)
        {
            showLoadingModalForThesis = false;
            showErrorMessageforUploadingthesisAsCompany = true;
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
        }

        private async Task UpdateProgressWhenSaveThesisAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private void LogCurrentThesisState()
        {
            Console.WriteLine($"Title: {thesis.CompanyThesisTitle}");
            Console.WriteLine($"Description: {thesis.CompanyThesisDescriptionsUploaded}");
            Console.WriteLine($"Supervisor: {thesis.CompanyThesisCompanySupervisorFullName}");
            Console.WriteLine($"Email: {thesis.CompanyThesisContactPersonEmail}");
            Console.WriteLine($"Start Date: {thesis.CompanyThesisStartingDate}");
            Console.WriteLine($"Selected Areas: {SelectedAreasWhenUploadThesisAsCompany.Count}");
            Console.WriteLine($"Selected Subfields: {SelectedSubFieldsForCompanyThesis.Count}");
            Console.WriteLine($"Has Any Selection: {HasAnySelectionForCompanyThesis()}");
        
            foreach (var area in SelectedAreasWhenUploadThesisAsCompany)
            {
                Console.WriteLine($"  - Area: {area.AreaName}");
            }
        
            foreach (var subfield in SelectedSubFieldsForCompanyThesis)
            {
                Console.WriteLine($"  - Subfields for {subfield.Key}: {string.Join(", ", subfield.Value)}");
            }
        }

        // Helper method to handle validation errors
        private async Task HandleValidationError(string elementId)
        {
            showErrorMessageforUploadingthesisAsCompany = true;
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
            Console.WriteLine($"Validation failed for element: {elementId}");
        }



        private bool showLoadingModalForInternship = false;
        private async Task UploadInternshipAsCompany()
        {
            // Show loading modal and reset progress
            showLoadingModalForInternship = true;
            loadingProgress = 0;
            showErrorMessage = false;
            showSuccessMessageWhenSaveInternshipAsCompany = false;
            StateHasChanged();
        
            try
            {
                // Step 1: Validation checks
                await UpdateProgressWhenSaveInternshipAsCompany(10);
                if (await HandleInternshipValidationWhenSaveInternshipAsCompany() == false)
                {
                    return;
                }
                await UpdateProgressWhenSaveInternshipAsCompany(20);

                // Step 2: Prepare internship data
                await UpdateProgressWhenSaveInternshipAsCompany(30);
                companyInternship.RNGForInternshipUploadedAsCompany = new Random().NextInt64();
                companyInternship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID = 
                    HashingHelper.HashLong(companyInternship.RNGForInternshipUploadedAsCompany);
                companyInternship.CompanyEmailUsedToUploadInternship = companyData.CompanyEmail;

                // Set the Company navigation property
                companyInternship.Company = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == companyData.CompanyEmail);
                await UpdateProgressWhenSaveInternshipAsCompany(40);

                // Step 3: Set basic properties
                await UpdateProgressWhenSaveInternshipAsCompany(50);
                companyInternship.CompanyInternshipUploadDate = DateTime.Now;
                companyInternship.CompanyInternshipForeas = companyData.CompanyType;
                companyInternship.CompanyInternshipType = companyInternship.CompanyInternshipType;
                companyInternship.CompanyInternshipESPA = companyInternship.CompanyInternshipESPA;
                companyInternship.CompanyInternshipActivePeriod = companyInternship.CompanyInternshipActivePeriod;
                companyInternship.CompanyInternshipFinishEstimation = companyInternship.CompanyInternshipFinishEstimation;
                companyInternship.CompanyInternshipTitle = companyInternship.CompanyInternshipTitle;
                companyInternship.CompanyInternshipContactPerson = companyInternship.CompanyInternshipContactPerson;
                companyInternship.CompanyInternshipContactTelephonePerson = companyInternship.CompanyInternshipContactTelephonePerson;
                companyInternship.CompanyInternshipPerifereiaLocation = companyInternship.CompanyInternshipPerifereiaLocation;
                companyInternship.CompanyInternshipDimosLocation = companyInternship.CompanyInternshipDimosLocation;
                companyInternship.CompanyInternshipPostalCodeLocation = companyInternship.CompanyInternshipPostalCodeLocation;
                companyInternship.CompanyInternshipTransportOffer = companyInternship.CompanyInternshipTransportOffer;
                // UPDATED: Open Slots field
                companyInternship.OpenSlots_CompanyInternships = companyInternship.OpenSlots_CompanyInternships;
                await UpdateProgressWhenSaveInternshipAsCompany(60);

                // Step 4: Build areas and subfields
                await UpdateProgressWhenSaveInternshipAsCompany(70);
                var areasWithSubfields = new List<string>();

                // Add selected areas (using AreaName)
                foreach (var area in SelectedAreasWhenUploadInternshipAsCompany)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields (just the subfield names, not with area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForCompanyInternship)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Save all as comma-separated string in the same field
                companyInternship.CompanyInternshipAreas = string.Join(",", areasWithSubfields);

                companyInternship.CompanyInternshipDescription = companyInternship.CompanyInternshipDescription;
                await UpdateProgressWhenSaveInternshipAsCompany(80);

                // Step 5: EKPA supervisor logic
                await UpdateProgressWhenSaveInternshipAsCompany(85);
                if (selectedProfessorId.HasValue)
                {
                    var professor = await dbContext.Professors
                        .FirstOrDefaultAsync(p => p.Id == selectedProfessorId.Value);

                    if (professor != null)
                    {
                        companyInternship.CompanyInternshipEKPASupervisor = $"{professor.ProfName} {professor.ProfSurname}";
                    }
                    else
                    {
                        companyInternship.CompanyInternshipEKPASupervisor = "Unknown Professor";
                    }
                }
                else
                {
                    companyInternship.CompanyInternshipEKPASupervisor = "Χωρίς Προτίμηση";
                }

                companyInternship.CompanyUploadedInternshipStatus = companyInternship.CompanyUploadedInternshipStatus;
                companyInternship.CompanyInternshipAttachment = companyInternship.CompanyInternshipAttachment;
                await UpdateProgressWhenSaveInternshipAsCompany(90);

                // Step 6: Save to database
                await UpdateProgressWhenSaveInternshipAsCompany(95);
                dbContext.CompanyInternships.Add(companyInternship);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveInternshipAsCompany(100);

                // Step 7: Success - clear form and prepare for navigation
                showSuccessMessageWhenSaveInternshipAsCompany = true;
                showErrorMessage = false;

                // Clear all form fields including subfields
                companyInternship = new CompanyInternship();
                SelectedAreasWhenUploadInternshipAsCompany.Clear();
                SelectedSubFieldsForCompanyInternship.Clear();
                ExpandedAreasForCompanyInternship.Clear();

                // Small delay to show completion
                await Task.Delay(500);
            
                // Navigate to refresh
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForInternship = false;
            
                showSuccessMessageWhenSaveInternshipAsCompany = false;
                showErrorMessage = true;
                Console.WriteLine($"Error uploading internship: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task<bool> HandleInternshipValidationWhenSaveInternshipAsCompany()
        {
            // All validation checks remain exactly the same
            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipTitle))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("positionTitle");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipType))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipType");
                return false;
            }

            if (companyInternship.CompanyInternshipActivePeriod.Date <= DateTime.Today)
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipActivePeriod");
                return false;
            }

            if (companyInternship.CompanyInternshipFinishEstimation.Date <= DateTime.Today)
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipFinishEstimation");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipESPA))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipESPA");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipContactPerson))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipContactPerson");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipContactTelephonePerson))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipContactPhone");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipPerifereiaLocation))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipPerifereia");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipDimosLocation))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipDimos");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipPostalCodeLocation))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipPostalCode");
                return false;
            }

            if (string.IsNullOrWhiteSpace(companyInternship.CompanyInternshipDescription))
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipDescription");
                return false;
            }

            // Check if there are any selections (areas OR subfields)
            if (!HasAnySelectionForCompanyInternship())
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("internshipAreas");
                return false;
            }

            // UPDATED: Open Slots validation - MUST be at least 3
            if (companyInternship.OpenSlots_CompanyInternships < 3)
            {
                await HandleInternshipValidationErrorWhenSaveInternshipAsCompany("companyInternshipOpenSlots");
                return false;
            }

            return true;
        }

        private async Task HandleInternshipValidationErrorWhenSaveInternshipAsCompany(string elementId)
        {
            showLoadingModalForInternship = false;
            showErrorMessage = true;
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
        }

        private async Task UpdateProgressWhenSaveInternshipAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }




        private string PositionAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelected(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    job.PositionAttachment = null;
                    PositionAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    PositionAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    job.PositionAttachment = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    PositionAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    job.PositionAttachment = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                job.PositionAttachment = ms.ToArray();

                // Clear any previous error message
                PositionAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading position attachment: {ex.Message}");
                PositionAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                job.PositionAttachment = null;
            }
        }

        private string CompanyThesisAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForCompanyThesisAttachment(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    thesis.CompanyThesisAttachmentUpload = null;
                    CompanyThesisAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    CompanyThesisAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    thesis.CompanyThesisAttachmentUpload = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    CompanyThesisAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    thesis.CompanyThesisAttachmentUpload = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                thesis.CompanyThesisAttachmentUpload = ms.ToArray();

                // Clear any previous error message
                CompanyThesisAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading thesis attachment: {ex.Message}");
                CompanyThesisAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                thesis.CompanyThesisAttachmentUpload = null;
            }
        }

        private string AnnouncementAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForAnnouncementAttachment(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    announcement.CompanyAnnouncementAttachmentFile = null;
                    AnnouncementAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    AnnouncementAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    announcement.CompanyAnnouncementAttachmentFile = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    AnnouncementAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    announcement.CompanyAnnouncementAttachmentFile = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                announcement.CompanyAnnouncementAttachmentFile = ms.ToArray();

                // Clear any previous error message
                AnnouncementAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading announcement attachment: {ex.Message}");
                AnnouncementAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                announcement.CompanyAnnouncementAttachmentFile = null;
            }
        }

        private string ProfessorAnnouncementAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForAnnouncementAttachmentAsProfessor(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    professorannouncement.ProfessorAnnouncementAttachmentFile = null;
                    ProfessorAnnouncementAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    ProfessorAnnouncementAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    professorannouncement.ProfessorAnnouncementAttachmentFile = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    ProfessorAnnouncementAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    professorannouncement.ProfessorAnnouncementAttachmentFile = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                professorannouncement.ProfessorAnnouncementAttachmentFile = ms.ToArray();

                // Clear any previous error message
                ProfessorAnnouncementAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading professor announcement attachment: {ex.Message}");
                ProfessorAnnouncementAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                professorannouncement.ProfessorAnnouncementAttachmentFile = null;
            }
        }

    //SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO AYTO EDW LEITOURGEI KANONIKA. THA KANW TO IDIO GIA OLA TA ATTACHMENTS KAI EDW KAI STON HOST KAI STO ANEVASMA GIA KA8E ARXEIO 8ELEI ALLAGI SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO

        private string ProfessorThesisAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForThesisAttachmentAsProfessor(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    professorthesis.ThesisAttachment = null;
                    ProfessorThesisAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    ProfessorThesisAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    professorthesis.ThesisAttachment = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    ProfessorThesisAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    professorthesis.ThesisAttachment = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                professorthesis.ThesisAttachment = ms.ToArray();

                // Clear any previous error message
                ProfessorThesisAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading professor thesis attachment: {ex.Message}");
                ProfessorThesisAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                professorthesis.ThesisAttachment = null;
            }
        }
    //SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO AYTO EDW LEITOURGEI KANONIKA. THA KANW TO IDIO GIA OLA TA ATTACHMENTS KAI EDW KAI STON HOST KAI STO ANEVASMA GIA KA8E ARXEIO 8ELEI ALLAGI SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO



        private string CompanyInternshipAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForUploadInternshipAsCompany(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    companyInternship.CompanyInternshipAttachment = null;
                    CompanyInternshipAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    CompanyInternshipAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    companyInternship.CompanyInternshipAttachment = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    CompanyInternshipAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    companyInternship.CompanyInternshipAttachment = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                companyInternship.CompanyInternshipAttachment = ms.ToArray();

                // Clear any previous error message
                CompanyInternshipAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading internship attachment: {ex.Message}");
                CompanyInternshipAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                companyInternship.CompanyInternshipAttachment = null;
            }
        }

        private void ToggleFormVisibilityForUploadCompanyJobs()
        {
            isForm1Visible = !isForm1Visible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadCompanyAnnouncements()
        {
            isAnnouncementsFormVisible = !isAnnouncementsFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadResearchGroupAnnouncements()
        {
            isResearchGroupToUploadAnnouncementsFormVisible = !isResearchGroupToUploadAnnouncementsFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityToShowGeneralAnnouncementsAndEventsAsCompany()
        {
            isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsCompany = !isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsCompany;
            StateHasChanged();
        }

        private void ToggleFormVisibilityToShowGeneralAnnouncementsAndEventsAsRG()
        {
            isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsRG = !isAnnouncementsFormVisibleToShowGeneralAnnouncementsAndEventsAsRG;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadProfessorAnnouncements()
        {
            isProfessorAnnouncementsFormVisible = !isProfessorAnnouncementsFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadProfessorThesis()
        {
            isProfessorThesisFormVisible = !isProfessorThesisFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadProfessorInternship()
        {
            isProfessorInternshipFormVisible = !isProfessorInternshipFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForSearchStudentAsProfessor()
        {
            isProfessorSearchStudentFormVisible = !isProfessorSearchStudentFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForSearchCompanyAsProfessor()
        {
            isProfessorSearchCompanyFormVisible = !isProfessorSearchCompanyFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForSearchCompanyAsStudent()
        {
            isStudentSearchCompanyFormVisible = !isStudentSearchCompanyFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForSearchCompanyAsRG()
        {
            isRGSearchCompanyFormVisible = !isRGSearchCompanyFormVisible;
            StateHasChanged();
        }

        private bool isLoadingJobsHistory = false;
        private async Task ToggleFormVisibilityToShowMyActiveJobsAsCompany()
        {
            isForm2Visible = !isForm2Visible;

            if (isForm2Visible)
            {
                isLoadingJobsHistory = true;
                StateHasChanged();
        
                try
                {
                    await LoadJobs(); // Ensure jobs are loaded when the form is shown
                    InitializeSlotData_ForCompanyJob(); // NEW: Initialize slot data after loading jobs
                }
                finally
                {
                    isLoadingJobsHistory = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingThesesHistory = false;
        private async Task ToggleFormVisibilityToShowMyActiveThesesAsCompany()
        {
            isShowActiveThesesAsCompanyFormVisible = !isShowActiveThesesAsCompanyFormVisible;

            if (isShowActiveThesesAsCompanyFormVisible)
            {
                isLoadingThesesHistory = true;
                StateHasChanged();
        
                try
                {
                    await LoadThesesAsCompany(); // Ensure theses are loaded when the form is shown
                    InitializeSlotData_ForCompanyThesis(); // NEW: Initialize slot data
                }
                finally
                {
                    isLoadingThesesHistory = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }


        private async Task TogglePositionDetails(CompanyJob position)
        {
            if (positionDetails.ContainsKey(position.Id))
            {
                positionDetails[position.Id] = !positionDetails[position.Id];           

            }
            else
            {
                positionDetails[position.Id] = true; // Default to true if not found
            }
        await LoadWhoApplied(position.RNGForPositionUploaded);
        StateHasChanged();
        }

        private bool showLoadingModalForDeleteJob = false;
        private async Task DeleteJobPosition(int jobId)
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Πρόκειται να διαγράψετε οριστικά αυτή τη Θέση Εργασίας. <br>" +
                "<strong style='color: red;'>Η ενέργεια αυτή είναι μη αναστρέψιμη!</strong>"
            });

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteJob = true;
                loadingProgress = 0;
                StateHasChanged();
        
                try
                {
                    // Step 1: Find the job position
                    await UpdateProgressWhenDeleteJobAsCompany(30);
                    var job = await dbContext.CompanyJobs.FindAsync(jobId);
            
                    if (job != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteJobAsCompany(60);
                        dbContext.CompanyJobs.Remove(job);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteJobAsCompany(80);

                        // Step 3: Reload the jobs list
                        await UpdateProgressWhenDeleteJobAsCompany(90);
                        await LoadJobs();
                        await UpdateProgressWhenDeleteJobAsCompany(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Job not found - hide modal and show error
                        showLoadingModalForDeleteJob = false;
                        await JS.InvokeVoidAsync("alert", "Η θέση εργασίας δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteJob = false;
            
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteJob = false;
                }

                // Only update state since we already reloaded the data with LoadJobs()
                StateHasChanged();
            }
        }

        private async Task UpdateProgressWhenDeleteJobAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }



        private bool showLoadingModalForDeleteCompanyThesis = false;
        private async Task DeleteCompanyThesis(int companythesisId)
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Πρόκειται να διαγράψετε οριστικά αυτή τη Διπλωματική Εργασία. <br>" +
                "<strong style='color: red;'>Η ενέργεια αυτή είναι μη αναστρέψιμη!</strong>"
            });

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteCompanyThesis = true;
                loadingProgress = 0;
                StateHasChanged();
            
                try
                {
                    // Step 1: Find the company thesis
                    await UpdateProgressWhenDeleteThesisAsCompany(30);
                    var companytheses = await dbContext.CompanyTheses.FindAsync(companythesisId);
                
                    if (companytheses != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteThesisAsCompany(60);
                        dbContext.CompanyTheses.Remove(companytheses);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteThesisAsCompany(80);

                        // Step 3: Reload the theses list
                        await UpdateProgressWhenDeleteThesisAsCompany(90);
                        await LoadThesesAsCompany();
                        await UpdateProgressWhenDeleteThesisAsCompany(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Thesis not found - hide modal and show error
                        showLoadingModalForDeleteCompanyThesis = false;
                        await JS.InvokeVoidAsync("alert", "Η Διπλωματική εργασία δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteCompanyThesis = false;
                
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteCompanyThesis = false;
                }

                // Only update state since we already reloaded the data
                StateHasChanged();
            }
        }

        private async Task UpdateProgressWhenDeleteThesisAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }



        private void EditJobPosition(int positionId)
        {
            // Check if 'companyJobs' is not null before attempting to access it
            if (jobs == null)
            {
                Console.WriteLine("The companyJobs list is null.");
                return;
            }

            // Find the job to edit
            var jobToEdit = jobs.FirstOrDefault(j => j.Id == positionId);
            if (jobToEdit != null)
            {
                isEditPopupVisibleForJobs = true;
                // Set the job object to be edited
                job = jobToEdit;
                // Perform any additional logic needed for editing in the same component
                // For example, setting flags or triggering UI updates
                isEditing = true;
                StateHasChanged();

            }
            else
            {
                // Handle the case when the job position with the given positionId is not found
                Console.WriteLine($"Job position with ID {positionId} not found.");
            }
        }


        private async Task DownloadAttachmentForCompanyJobs(int jobId)
        {
            var job = await dbContext.CompanyJobs.FindAsync(jobId);
            if (job != null && job.PositionAttachment != null)
            {
                var fileName = $"{job.PositionTitle}_Attachment.pdf"; // Ensure file name ends with .pdf
                var mimeType = "application/pdf"; // Correct MIME type for PDF
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, job.PositionAttachment);
            }
        }


        private async Task DownloadAttachmentForCompanyTheses(int companyThesisId)
        {
            var companythesis = await dbContext.CompanyTheses.FindAsync(companyThesisId);
            if (companythesis != null && companythesis.CompanyThesisAttachmentUpload != null)
            {
                var fileName = $"{companythesis.CompanyThesisTitle}_Attachment";
                var mimeType = "application/octet-stream"; // or set the appropriate MIME type if known
                var fileContent = new byte[companythesis.CompanyThesisAttachmentUpload.Length];
                companythesis.CompanyThesisAttachmentUpload.CopyTo(fileContent, 0);
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, fileContent);
            }
        }

        //SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO AYTO EDW LEITOURGEI KANONIKA. THA KANW TO IDIO GIA OLA TA ATTACHMENTS KAI EDW KAI STON HOST KAI STO ANEVASMA GIA KA8E ARXEIO 8ELEI ALLAGI SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO
        private async Task DownloadAttachmentForProfessorTheses(int professorThesisId)
        {
            var professorThesis = await dbContext.ProfessorTheses.FindAsync(professorThesisId);
            if (professorThesis != null && professorThesis.ThesisAttachment != null)
            {
                // Use the ThesisTitle for file naming and ensure .pdf extension
                var fileName = $"{professorThesis.ThesisTitle}_Attachment.pdf"; 
                var mimeType = "application/pdf"; 

                // Convert byte array to base64 string for JavaScript
                var fileContentBase64 = Convert.ToBase64String(professorThesis.ThesisAttachment); 
            
                // Invoke the JavaScript download function
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentProfessorThesisFile", fileName, mimeType, fileContentBase64);
                Console.WriteLine($"File Size: {professorThesis.ThesisAttachment.Length}");

            }
        }
        //SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO AYTO EDW LEITOURGEI KANONIKA. THA KANW TO IDIO GIA OLA TA ATTACHMENTS KAI EDW KAI STON HOST KAI STO ANEVASMA GIA KA8E ARXEIO 8ELEI ALLAGI SOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSOSO





        private async Task DownloadAttachmentForCompanyInternships(int internshipId)
        {
            var internship = await dbContext.CompanyInternships.FindAsync(internshipId);
            if (internship != null && internship.CompanyInternshipAttachment != null)
            {
                var fileName = $"{internship.CompanyInternshipTitle}_Attachment.pdf"; // Ensure file name ends with .pdf
                var mimeType = "application/pdf"; // Correct MIME type for PDF
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, internship.CompanyInternshipAttachment);
            }
        }

        private async Task DownloadAttachmentForProfessorInternships(int internshipId)
        {
            var internship = await dbContext.ProfessorInternships.FindAsync(internshipId);
            if (internship != null && internship.ProfessorInternshipAttachment != null)
            {
                var fileName = $"{internship.ProfessorInternshipTitle}_Attachment.pdf"; // Ensure file name ends with .pdf
                var mimeType = "application/pdf"; // Correct MIME type for PDF
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, internship.ProfessorInternshipAttachment);
            }
        }


        private async Task UpdateJob()
        {
            try
            {
                dbContext.CompanyJobs.Update(job);
                job.TimesUpdated++;
                job.UpdateDateTime = DateTime.Now;
                await dbContext.SaveChangesAsync();


                showSuccessUpdateMessage = true;
                showErrorMessage = false;
            }
            catch (Exception)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                showSuccessUpdateMessage = false;
            }
            StateHasChanged();
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

        }

        private async Task UpdateCompanyThesis()
        {
            try
            {
                dbContext.CompanyJobs.Update(job);
                job.TimesUpdated++;
                job.UpdateDateTime = DateTime.Now;
                await dbContext.SaveChangesAsync();


                showSuccessUpdateMessage = true;
                showErrorMessage = false;
            }
            catch (Exception)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                showSuccessUpdateMessage = false;
            }
            StateHasChanged();
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

        }

        private async Task LoadUserApplications()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity.IsAuthenticated)
                {
                    var userEmail = user.FindFirst("name")?.Value;
                    if (!string.IsNullOrEmpty(userEmail))
                    {
                        showApplications = true;
                    
                        // Retrieve applications using email + unique ID instead of registration number
                        jobApplications = await dbContext.CompanyJobsApplied
                            .Where(j => j.StudentEmailAppliedForCompanyJob == userEmail && 
                                    j.StudentUniqueIDAppliedForCompanyJob == userData.Student_UniqueID)
                            .OrderByDescending(j => j.DateTimeStudentAppliedForCompanyJob)
                            .ToListAsync();

                        StateHasChanged();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading applications: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task LoadWhoApplied(long rngForPositionUploaded)
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity.IsAuthenticated)
                {
                    var companyEmail = user.FindFirst("name")?.Value;
                
                    if (!string.IsNullOrEmpty(companyEmail))
                    {
                        jobApplicationsmadeToCompany = await dbContext.CompanyJobsApplied
                            .Include(a => a.StudentDetails)
                            .Include(a => a.CompanyDetails)
                            .Where(j => j.CompanysEmailWhereStudentAppliedForCompanyJob == companyEmail &&
                                    j.RNGForCompanyJobApplied == rngForPositionUploaded)
                            .OrderByDescending(j => j.DateTimeStudentAppliedForCompanyJob)
                            .ToListAsync();

                        StateHasChanged();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading applications: {ex.Message}");
                StateHasChanged();
            }
        }


        private async Task AcceptApplicationAsCompany(CompanyJobApplied application)
        {
            try
            {
                using var transaction = await dbContext.Database.BeginTransactionAsync();

                // Update status in the main entity (since status fields were moved there)
                application.CompanyPositionStatusAppliedAtTheCompanySide = "Έχετε Αποδεχτεί";
                application.CompanyPositionStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();
                await transaction.CommitAsync();

                // Get required data for email
                var studentName = $"{userData.Name} {userData.Surname}";
                var positionTitle = companyjobb.PositionTitle;
                var companyName = companyData.CompanyName;

                // Send acceptance email
                var emailService = new InternshipEmailService(
                    "kleapali70@gmail.com",
                    "mbyuqdgdyrvtefan",
                    "kleapali69@hotmail.com"
                );

                await emailService.SendVerificationEmail(
                    application.StudentEmailAppliedForCompanyJob,
                    studentName,
                    positionTitle,
                    companyName);

                await JS.InvokeVoidAsync("alert", 
                    $"Application accepted and notification sent to {application.StudentEmailAppliedForCompanyJob}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting application: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Error processing application acceptance.");
            }
        }

        private async Task RejectApplicationAsCompany(CompanyJobApplied application)
        {
            try
            {
                using var transaction = await dbContext.Database.BeginTransactionAsync();

                // Update status in the main entity (since status fields were moved there)
                application.CompanyPositionStatusAppliedAtTheCompanySide = "Έχει Απορριφθεί";
                application.CompanyPositionStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();
                await transaction.CommitAsync();

                // Get required data for email
                var studentName = $"{userData.Name} {userData.Surname}";
                var positionTitle = companyjobb.PositionTitle;
                var companyName = companyData.CompanyName;

                // Send rejection email
                var emailService = new InternshipEmailService(
                    "kleapali70@gmail.com",
                    "mbyuqdgdyrvtefan",
                    "kleapali69@hotmail.com"
                );

                await emailService.SendRejectionEmail(
                    application.StudentEmailAppliedForCompanyJob,
                    studentName,
                    positionTitle,
                    companyName);

                await JS.InvokeVoidAsync("alert", 
                    $"Application rejected and notification sent to {application.StudentEmailAppliedForCompanyJob}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting application: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Error processing application rejection.");
            }
        }

        private async Task ToggleDoughnutChart()
        {
            isDoughnutChartVisible = !isDoughnutChartVisible;
            if (isDoughnutChartVisible)
            {
                await JS.InvokeVoidAsync("showDoughnutChart", "doughnutChart");
            }
            else
            {
                await JS.InvokeVoidAsync("hideDoughnutChart", "doughnutChart");
            }
        }

        private async Task ToggleDepartmentDistributionChart()
        {
            isDepartmentDistributionChartVisible = !isDepartmentDistributionChartVisible;
            if (isDepartmentDistributionChartVisible)
            {
                await JS.InvokeVoidAsync("showDoughnutChart", "departmentDistributionChart");
            }
            else
            {
                await JS.InvokeVoidAsync("hideDoughnutChart", "departmentDistributionChart");
            }
        }

        private async Task LoadSkillDistributionAsync()
        {
            var students = await dbContext.Students.ToListAsync();
            foreach (var student in students)
            {
                var keywords = student.Keywords.Split(',');
                foreach (var keyword in keywords)
                {
                    var trimmedKeyword = keyword.Trim();
                    if (skillDistribution.ContainsKey(trimmedKeyword))
                    {
                        skillDistribution[trimmedKeyword]++;
                    }
                    else
                    {
                        skillDistribution[trimmedKeyword] = 1;
                    }
                }
            }

            int totalSkills = skillDistribution.Values.Sum();
            foreach (var key in skillDistribution.Keys.ToList())
            {
                skillDistribution[key] = (skillDistribution[key] * 100) / totalSkills;
            }
        }

        private async Task LoadDepartmentDistributionAsync()
        {
            var students = await dbContext.Students.ToListAsync();
            foreach (var student in students)
            {
                var department = student.Department;
                if (departmentDistribution.ContainsKey(department))
                {
                    departmentDistribution[department]++;
                }
                else
                {
                    departmentDistribution[department] = 1;
                }
            }

            int totalDepartments = departmentDistribution.Values.Sum();
            foreach (var key in departmentDistribution.Keys.ToList())
            {
                departmentDistribution[key] = (departmentDistribution[key] * 100) / totalDepartments;
            }
        }

        @*
        protected override async Task OnAfterRenderAsync(bool firstRender) //EINAI TSAPATSOULIA NA VRETHEI ALLOS TROPOS GIARI ME TO ASYNC CRASHAREI OTAN PAW STO PROFILE // TO EVALA SXOLIA GIA MIN CRASHAREI TO PROFILE TOY COMPANY
        {
            if (hasReadAsCompanyPermission)
            {
                await JS.InvokeVoidAsync("createDoughnutChart", "doughnutChart", new
                {
                    labels = skillDistribution.Keys.ToArray(),
                    datasets = new[]
                    {
                        new
                        {
                            data = skillDistribution.Values.ToArray(),
                            backgroundColor = new[]
                            {
                                "#FF6384",
                                "#36A2EB",
                                "#FFCE56",
                                "#4BC0C0",
                                "#9966FF",
                                "#FF9F40"
                            }
                        }
                    }
                });

                await JS.InvokeVoidAsync("createDoughnutChart", "departmentDistributionChart", new
                {
                    labels = departmentDistribution.Keys.ToArray(),
                    datasets = new[]
                    {
                        new
                        {
                            data = departmentDistribution.Values.ToArray(),
                            backgroundColor = new[]
                            {
                                "#FF6384",
                                "#36A2EB",
                                "#FFCE56",
                                "#4BC0C0",
                                "#9966FF",
                                "#FF9F40"
                            }
                        }
                    }
                });
            }
        }
        *@
        private void ToggleFormVisibilityForUploadCompanyInternships()
        {
            isUploadCompanyInternshipsFormVisible = !isUploadCompanyInternshipsFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadCompanyThesis()
        {
            isUploadCompanyThesisFormVisible = !isUploadCompanyThesisFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadCompanyEvent()
        {
            isUploadCompanyEventFormVisible = !isUploadCompanyEventFormVisible;
            StateHasChanged();
        }

        private void ToggleFormVisibilityForUploadProfessorEvent()
        {
            isUploadProfessorEventFormVisible = !isUploadProfessorEventFormVisible;
            StateHasChanged();
        }


        private void OnAreaChange(ChangeEventArgs e)
        {
            var selectedValue = e.Value.ToString();
            var selectedArea = availableAreas.FirstOrDefault(a => a.AreaName == selectedValue);
            if (selectedArea != null)
            {
                ToggleSubFields(selectedArea);
            }
        }

        private async Task MoveSelectedAreaToLeft()
        {
            var newlySelectedAreas = await GetSelectedAreasFromDOM("selectedAreas");

            foreach (var areaName in newlySelectedAreas)
            {
                var selectedArea = selectedAreasForAssessment.FirstOrDefault(sa => sa.AreaName == areaName);
                if (selectedArea != null)
                {
                    selectedAreasForAssessment.Remove(selectedArea);

                    if (!availableAreas.Any(a => a.AreaName == areaName))
                    {
                        var areaToAdd = dbContext.Areas.FirstOrDefault(a => a.AreaName == areaName);
                        if (areaToAdd != null)
                        {
                            availableAreas.Add(areaToAdd);
                            Console.WriteLine($"Area {areaName} added back to availableAreas (Left List Box)");
                        }
                    }
                }
            }

            StateHasChanged();
        }


        private async Task MoveSelectedAreaToRight()
        {
            var newlySelectedAreas = await GetSelectedAreasFromDOM("availableAreas");

            foreach (var areaName in newlySelectedAreas)
            {
                var areaToRemove = availableAreas.FirstOrDefault(a => a.AreaName == areaName);
                if (areaToRemove != null)
                {
                    availableAreas.Remove(areaToRemove);

                    if (!selectedAreasForAssessment.Any(sa => sa.AreaName == areaToRemove.AreaName))
                    {
                        selectedAreasForAssessment.Add(new SelectedArea { AreaName = areaToRemove.AreaName });
                        Console.WriteLine($"Area {areaName} added to selectedAreas (Right List Box)");
                    }
                }
            }

            StateHasChanged();
        }

        public class SelectedArea
        {
            public string AreaName { get; set; }
            public int Assessment { get; set; } = 1; // Default assessment value is 1
        }

        private async Task<List<string>> GetSelectedAreasFromDOM(string selectId)
        {
            var selectedAreas = await JS.InvokeAsync<List<string>>("getSelectedValues", new object[] { selectId });
            return selectedAreas;
        }

        private void ToggleSubFields(Area area)
        {
            if (expandedAreas.Contains(area.AreaName))
            {
                expandedAreas.Remove(area.AreaName);
            }
            else
            {
                expandedAreas.Add(area.AreaName);
            }
            StateHasChanged();
        }

        private List<string> GetTownsForRegion(string region)
        {
            if (string.IsNullOrEmpty(region) || !RegionToTownsMap.ContainsKey(region))
            {
                return new List<string>();
            }

            return RegionToTownsMap[region];
        }


        private void UpdateTransportOffer(bool offer)
        {
            companyInternship.CompanyInternshipTransportOffer = offer;
        }

        private void UpdateTransportOfferForProfessorInternship(bool offer)
        {
            professorInternship.ProfessorInternshipTransportOffer = offer;
        }

        private bool isLoadingInternshipsHistory = false;
        private async Task ToggleFormVisibilityToShowMyActiveInternshipsAsCompany()
        {
            isShowActiveInternshipsAsCompanyFormVisible = !isShowActiveInternshipsAsCompanyFormVisible;

            if (isShowActiveInternshipsAsCompanyFormVisible)
            {
                isLoadingInternshipsHistory = true;
                StateHasChanged();
        
                try
                {
                    // Load internships data when the section is expanded
                    await LoadInternships(); // Replace with your actual data loading method
                    InitializeSlotData_ForCompanyInternship(); // NEW: Initialize slot data
                }
                finally
                {
                    isLoadingInternshipsHistory = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingInternshipsHistoryAsProfessor = false;
        private async Task ToggleFormVisibilityToShowMyActiveInternshipsAsProfessor()
        {
            isShowActiveInternshipsAsProfessorFormVisible = !isShowActiveInternshipsAsProfessorFormVisible;

            if (isShowActiveInternshipsAsProfessorFormVisible)
            {
                isLoadingInternshipsHistoryAsProfessor = true;
                StateHasChanged();
        
                try
                {
                    // Load internships data when the section is expanded
                    await LoadProfessorInternships();
                    InitializeSlotDataForProfessorInternships(); // NEW: Initialize slot data
                }
                finally
                {
                    isLoadingInternshipsHistoryAsProfessor = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
    }



        private void ToggleInternshipDetails(CompanyInternship internship)
        {
            if (positionDetails.ContainsKey(internship.Id))
            {
                positionDetails[internship.Id] = !positionDetails[internship.Id];
            }
            else
            {
                positionDetails[internship.Id] = true;
            }
        }


        private bool showLoadingModalForDeleteInternship = false;
        private async Task DeleteInternship(int internshipId)
        {
            // Call JavaScript function for confirmation with HTML content and custom styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Πρόκειται να διαγράψετε οριστικά αυτή την Θέση Πρακτικής. Είστε σίγουρος/η; <br>" +
                "<strong style='color: red;'>Η ενέργεια αυτή είναι μη αναστρέψιμη!</strong>"
            });

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteInternship = true;
                loadingProgress = 0;
                StateHasChanged();
            
                try
                {
                    // Step 1: Find the internship
                    await UpdateProgressWhenDeleteInternshipAsCompany(30);
                    var internship = await dbContext.CompanyInternships.FindAsync(internshipId);
                
                    if (internship != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteInternshipAsCompany(60);
                        dbContext.CompanyInternships.Remove(internship);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteInternshipAsCompany(80);

                        // Step 3: Reload the internships list
                        await UpdateProgressWhenDeleteInternshipAsCompany(90);
                        await LoadInternships();
                        await UpdateProgressWhenDeleteInternshipAsCompany(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Internship not found - hide modal and show error
                        showLoadingModalForDeleteInternship = false;
                        await JS.InvokeVoidAsync("alert", "Η πρακτική άσκηση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteInternship = false;
                
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteInternship = false;
                }

                // Only update state since we already reloaded the data
                StateHasChanged();
            }
        }

        private async Task UpdateProgressWhenDeleteInternshipAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }


        private bool showLoadingModalForDeleteProfessorInternship = false;
        private async Task DeleteProfessorInternship(int internshipId)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Πρακτική Άσκηση.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteProfessorInternship = true;
                loadingProgress = 0;
                StateHasChanged();
        
                try
                {
                    // Step 1: Find the internship
                    await UpdateProgressWhenDeleteProfessorInternship(30);
                    var internship = await dbContext.ProfessorInternships.FindAsync(internshipId);
            
                    if (internship != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteProfessorInternship(60);
                        dbContext.ProfessorInternships.Remove(internship);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteProfessorInternship(80);

                        // Step 3: Reload the internships list
                        await UpdateProgressWhenDeleteProfessorInternship(90);
                        await LoadProfessorInternships();
                        await UpdateProgressWhenDeleteProfessorInternship(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Internship not found - hide modal and show error
                        showLoadingModalForDeleteProfessorInternship = false;
                        await JS.InvokeVoidAsync("alert", "Η πρακτική άσκηση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteProfessorInternship = false;
            
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteProfessorInternship = false;
                }

                // Trigger UI refresh and navigation
                StateHasChanged();
                //NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
        }

        private async Task UpdateProgressWhenDeleteProfessorInternship(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private async Task LoadInternships()
        {
            try
            {
                // 1. ISOLATE: Create a fresh context for this specific task
                using var context = DbFactory.CreateDbContext();

                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // 2. OPTIMIZE: Use AsNoTracking() for faster read performance
                    internships = await context.CompanyInternships
                        .AsNoTracking()
                        .Include(i => i.Company)
                        .Where(i => i.CompanyEmailUsedToUploadInternship == userEmail)
                        .ToListAsync();

                    if (internships == null || !internships.Any())
                    {
                        Console.WriteLine("No internships found for this user.");
                        internships = new List<CompanyInternship>(); // Prevent UI null reference errors
                    }
                    else
                    {
                        // Optional: Keep debug logging if needed, or remove for production speed
                        foreach (var internship in internships)
                        {
                            // Console.WriteLine($"Internship {internship.Id} by {internship.Company?.CompanyName}");
                        }
                    }
                }
                else
                {
                    internships = new List<CompanyInternship>();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading internships: {ex.Message}");
                internships = new List<CompanyInternship>(); // Ensure list is effectively empty on error
            }
        }

        private async Task LoadProfessorInternships()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch internships related to the current professor using the new property name
                    professorInternships = await dbContext.ProfessorInternships
                        .Include(i => i.Professor) // Include professor navigation property
                        .Where(i => i.ProfessorEmailUsedToUploadInternship == userEmail)
                        .ToListAsync();
                    /*
                    if (professorInternships == null || !professorInternships.Any())
                    {
                        Console.WriteLine("No internships found for this professor.");
                    }
                    else
                    {
                        Console.WriteLine($"Found {professorInternships.Count} internships for professor {userEmail}");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor internships: {ex.Message}");
            }
        }

        private async Task LoadJobs()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch internships related to the current company
                    jobs = await dbContext.CompanyJobs
                        .Where(i => i.EmailUsedToUploadJobs == userEmail)
                        .ToListAsync();

                    // Check the loaded data
                    if (jobs == null || !jobs.Any())
                    {
                        Console.WriteLine("No internships found for this user.");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading internships: {ex.Message}");
            }
            /*
            LogJobLoadingInfo();
            */

        }

        private async Task LoadThesesAsCompany()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch theses related to the current company
                    companytheses = await dbContext.CompanyTheses
                        .Include(t => t.Company) // This ensures Company data is loaded
                        .Where(i => i.CompanyEmailUsedToUploadThesis == userEmail)
                        .ToListAsync();

                    // Check the loaded data
                    if (companytheses == null || !companytheses.Any())
                    {
                        Console.WriteLine("No theses found for this company.");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading company theses: {ex.Message}");
            }
        }

        private async Task LoadThesesAsProfessor()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch theses related to the current professor using the navigation property
                    professortheses = await dbContext.ProfessorTheses
                        .Include(t => t.Professor) // Include professor data if needed
                        .Where(t => t.ProfessorEmailUsedToUploadThesis == userEmail)
                        .ToListAsync();

                    /*
                    if (professortheses == null || !professortheses.Any())
                    {
                        Console.WriteLine("No theses found for this Professor.");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading theses for this Professor: {ex.Message}");
            }

            // Load filtered theses (if needed for other purposes)
            FilteredThesesAsProfessor = await dbContext.ProfessorTheses
                .Include(t => t.Professor) // Include professor data if needed
                .ToListAsync();
        
            StateHasChanged();
        }


        private async Task LoadProfessors()
        {
            try
            {
                // Fetch all professors from the database
                professors = await dbContext.Professors
                .AsNoTracking() //to avala 26/9 gia tin vasi multi threading
                .ToListAsync();

                /*        
                if (professors == null || !professors.Any())
                {
                    Console.WriteLine("No professors found.");
                }
                else
                {
                    Console.WriteLine($"Found {professors.Count} professors.");
                }
                */
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Exception: {ex.Message}");
            }
        }

        private async Task LoadCompanies()
        {
            try
            {
                // Fetch all professors from the database
                companies = await dbContext.Companies
                .AsNoTracking() //to avala 26/9 gia tin vasi multi threading
                .ToListAsync();

                /*
                if (companies == null || !companies.Any())
                {
                    Console.WriteLine("No companies found.");
                }
                else
                {
                    Console.WriteLine($"Found {companies.Count} companies.");
                }
                */
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Exception: {ex.Message}");
            }
        }


        private bool isModalVisibleForInternships = false;
        private bool isModalVisibleForInternshipsAsStudent = false;
        private bool isModalVisibleForProfessorInternshipsAsStudent = false;
        private CompanyInternship currentInternship = null;
        private bool isModalVisibleForProfessorInternships = false;
        private ProfessorInternship currentProfessorInternship = null;

        private void ShowInternshipDetails(CompanyInternship internship)
        {
            currentInternship = internship;
            isModalVisibleForInternships = true;

        }


        private void ShowProfessorInternshipDetails(ProfessorInternship professorinternship)
        {
            currentProfessorInternship = professorinternship;
            isModalVisibleForProfessorInternships = true;

        }

        private void CloseModalForInternships()
        {
            isModalVisibleForInternships = false;
            selectedCompanyInternshipDetails = null;
        }

        private void CloseModalForProfessorInternships()
        {
            isModalVisibleForProfessorInternships = false;
            currentProfessorInternship = null;
        }

        // Method to show the edit popup with selected internship details
        private void EditInternshipDetails(CompanyInternship internship)
        {
            // Create a deep copy of the internship for editing
            selectedInternship = new CompanyInternship
            {
                Id = internship.Id,
                CompanyInternshipTitle = internship.CompanyInternshipTitle,
                CompanyInternshipDescription = internship.CompanyInternshipDescription,
                CompanyUploadedInternshipStatus = internship.CompanyUploadedInternshipStatus,
                CompanyInternshipType = internship.CompanyInternshipType,
                CompanyInternshipForeas = internship.CompanyInternshipForeas,
                CompanyInternshipContactPerson = internship.CompanyInternshipContactPerson,
                CompanyInternshipPerifereiaLocation = internship.CompanyInternshipPerifereiaLocation,
                CompanyInternshipDimosLocation = internship.CompanyInternshipDimosLocation,
                CompanyInternshipPostalCodeLocation = internship.CompanyInternshipPostalCodeLocation,
                CompanyInternshipTransportOffer = internship.CompanyInternshipTransportOffer,
                CompanyInternshipAreas = internship.CompanyInternshipAreas,
                CompanyInternshipActivePeriod = internship.CompanyInternshipActivePeriod,
                CompanyInternshipEKPASupervisor = internship.CompanyInternshipEKPASupervisor,
                CompanyInternshipAttachment = internship.CompanyInternshipAttachment,
                RNGForInternshipUploadedAsCompany_HashedAsUniqueID = internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID,
                RNGForInternshipUploadedAsCompany = internship.RNGForInternshipUploadedAsCompany,
                CompanyInternshipLastUpdate = DateTime.Today, // Set update date
                OpenSlots_CompanyInternships = internship.OpenSlots_CompanyInternships
            };

            // Clear all previous selections
            SelectedAreasToEditForCompanyInternship.Clear();
            SelectedSubFieldsForEditCompanyInternship.Clear();
            ExpandedAreasForEditCompanyInternship.Clear();

            // Initialize area and subfield selections from the existing internship data
            InitializeAreaSelectionsForEditInternship(internship);

            isEditPopupVisibleForInternships = true;
            StateHasChanged();
        }

        private void InitializeAreaSelectionsForEditInternship(CompanyInternship internship)
        {
            if (!string.IsNullOrEmpty(internship.CompanyInternshipAreas))
            {
                // Split the stored areas string and trim each item
                var selectedItems = internship.CompanyInternshipAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: CompanyInternshipAreas = {internship.CompanyInternshipAreas}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForCompanyInternship.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditCompanyInternship.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditCompanyInternship[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditCompanyInternship[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditCompanyInternship[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditCompanyInternship.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForCompanyInternship.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditCompanyInternship.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditCompanyInternship.Count}");
            }
        }

        private void EditProfessorInternshipDetails(ProfessorInternship internship)
        {
            // Create a deep copy of the internship for editing
            selectedProfessorInternship = new ProfessorInternship
            {
                Id = internship.Id,
                ProfessorInternshipTitle = internship.ProfessorInternshipTitle,
                ProfessorInternshipDescription = internship.ProfessorInternshipDescription,
                ProfessorInternshipType = internship.ProfessorInternshipType,
                ProfessorInternshipForeas = internship.ProfessorInternshipForeas,
                ProfessorInternshipPerifereiaLocation = internship.ProfessorInternshipPerifereiaLocation,
                ProfessorInternshipDimosLocation = internship.ProfessorInternshipDimosLocation,
                ProfessorInternshipTransportOffer = internship.ProfessorInternshipTransportOffer,
                ProfessorInternshipAreas = internship.ProfessorInternshipAreas,
                ProfessorInternshipActivePeriod = internship.ProfessorInternshipActivePeriod,
                ProfessorInternshipFinishEstimation = internship.ProfessorInternshipFinishEstimation,
                ProfessorInternshipAttachment = internship.ProfessorInternshipAttachment,
                ProfessorUploadedInternshipStatus = internship.ProfessorUploadedInternshipStatus,
                RNGForInternshipUploadedAsProfessor_HashedAsUniqueID = internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID,
                RNGForInternshipUploadedAsProfessor = internship.RNGForInternshipUploadedAsProfessor,
                ProfessorInternshipUploadDate = internship.ProfessorInternshipUploadDate,
                ProfessorInternshipLastUpdate = DateTime.Now,
                OpenSlots_ProfessorInternship = internship.OpenSlots_ProfessorInternship
            };

            // Clear all previous selections
            SelectedAreasToEditForProfessorInternship.Clear();
            SelectedSubFieldsForEditProfessorInternship.Clear();
            ExpandedAreasForEditProfessorInternship.Clear();

            // Initialize area and subfield selections from the existing internship data
            InitializeAreaSelectionsForEditProfessorInternship(internship);

            isEditPopupVisibleForProfessorInternships = true;
            StateHasChanged();
        }

        private void InitializeAreaSelectionsForEditProfessorInternship(ProfessorInternship internship)
        {
            if (!string.IsNullOrEmpty(internship.ProfessorInternshipAreas))
            {
                // Split the stored areas string and trim each item
                var selectedItems = internship.ProfessorInternshipAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: ProfessorInternshipAreas = {internship.ProfessorInternshipAreas}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForProfessorInternship.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditProfessorInternship.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditProfessorInternship[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditProfessorInternship[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditProfessorInternship[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditProfessorInternship.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForProfessorInternship.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditProfessorInternship.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditProfessorInternship.Count}");
            }
        }

        // Method to close the edit popup
        private void CloseEditPopupForInternships()
        {
            isEditPopupVisibleForInternships = false; // Hide the edit popup
        }

        // Method to save the edited internship details
        private async Task SaveEditedInternship()
        {
            try
            {
                // Check if required fields are filled
                if (string.IsNullOrWhiteSpace(selectedInternship.CompanyInternshipTitle) || string.IsNullOrWhiteSpace(selectedInternship.CompanyInternshipDescription))
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    return; // Prevent saving if required fields are missing
                }

                // Build areas and subfields string (same format as create)
                var areasWithSubfields = new List<string>();

                // Add selected areas
                foreach (var area in SelectedAreasToEditForCompanyInternship)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditCompanyInternship)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Convert to comma-separated string
                selectedInternship.CompanyInternshipAreas = string.Join(",", areasWithSubfields);

                // Find the internship to update
                var internshipToUpdate = await dbContext.CompanyInternships.FindAsync(selectedInternship.Id);
                if (internshipToUpdate != null)
                {
                    // Update internship properties from the edited copy
                    internshipToUpdate.CompanyInternshipTitle = selectedInternship.CompanyInternshipTitle;
                    internshipToUpdate.CompanyInternshipDescription = selectedInternship.CompanyInternshipDescription;
                    internshipToUpdate.CompanyInternshipESPA = selectedInternship.CompanyInternshipDescription;
                    internshipToUpdate.CompanyUploadedInternshipStatus = selectedInternship.CompanyUploadedInternshipStatus;
                    internshipToUpdate.CompanyInternshipType = selectedInternship.CompanyInternshipType;
                    internshipToUpdate.CompanyInternshipForeas = selectedInternship.CompanyInternshipForeas;
                    internshipToUpdate.CompanyInternshipContactPerson = selectedInternship.CompanyInternshipContactPerson;
                    internshipToUpdate.CompanyInternshipPerifereiaLocation = selectedInternship.CompanyInternshipPerifereiaLocation;
                    internshipToUpdate.CompanyInternshipDimosLocation = selectedInternship.CompanyInternshipDimosLocation;
                    internshipToUpdate.CompanyInternshipPostalCodeLocation = selectedInternship.CompanyInternshipPostalCodeLocation;
                    internshipToUpdate.CompanyInternshipTransportOffer = selectedInternship.CompanyInternshipTransportOffer;
                    internshipToUpdate.CompanyInternshipAreas = selectedInternship.CompanyInternshipAreas;
                    internshipToUpdate.CompanyInternshipActivePeriod = selectedInternship.CompanyInternshipActivePeriod;
                    internshipToUpdate.CompanyInternshipEKPASupervisor = selectedInternship.CompanyInternshipEKPASupervisor;
                    internshipToUpdate.CompanyInternshipLastUpdate = DateTime.Today; // Use current date instead of the copy's date
                    // UPDATED: Update OpenSlots field
                    internshipToUpdate.OpenSlots_CompanyInternships = selectedInternship.OpenSlots_CompanyInternships;

                    // Only update CompanyInternshipAttachment if a new file was uploaded
                    if (selectedInternship.CompanyInternshipAttachment != null && selectedInternship.CompanyInternshipAttachment.Length > 0)
                    {
                        internshipToUpdate.CompanyInternshipAttachment = selectedInternship.CompanyInternshipAttachment;
                    }

                    // Save the changes to the database
                    await dbContext.SaveChangesAsync();
                
                    // Refresh the internships list to show updated data
                    //await LoadCompanyInternships(); // This will reload from database
                
                    showSuccessMessage = true;
                    showErrorMessage = false;
                }
                else
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                }
            }
            catch (Exception ex)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                Console.Error.WriteLine($"Error saving internship: {ex.Message}");
            }
            finally
            {
                isEditPopupVisibleForInternships = false;
                selectedInternship = null; // Clear the editing object
                StateHasChanged(); // Ensure the UI updates after saving
            }
        }

    

        private async Task ShowJobDetails(CompanyJob job)
        {
            if (job.Company == null)
            {
                await dbContext.Entry(job)
                    .Reference(j => j.Company)
                    .LoadAsync();
            }
        
            currentJob = job;
            isModalVisibleForJobs = true;
            StateHasChanged();
        }

        private void ShowProfessorThesisDetailsAsStudent(ProfessorThesis professorthesis)
        {
            currentProfessorThesis = professorthesis;
            isModalVisibleToShowProfessorThesisDetails = true;

        }

    private void ShowProfessorThesisDetailsAsProfessor(ProfessorThesis professorthesis)
    {
            currentProfessorThesis = professorthesis;
            isModalVisibleToShowProfessorThesisAsProfessor = true;
    }





        private void CloseModalForJobs()
        {
            isModalVisibleForJobs = false;
            currentJob = null;
        }

        private void EditJobDetails(CompanyJob job)
        {
            // Create a deep copy of the job for editing
            selectedJob = new CompanyJob
            {
                Id = job.Id,
                PositionTitle = job.PositionTitle,
                PositionDescription = job.PositionDescription,
                PositionStatus = job.PositionStatus,
                PositionType = job.PositionType,
                PositionForeas = job.PositionForeas,
                PositionContactPerson = job.PositionContactPerson,
                PositionPerifereiaLocation = job.PositionPerifereiaLocation,
                PositionDimosLocation = job.PositionDimosLocation,
                PositionPostalCodeLocation = job.PositionPostalCodeLocation,
                PositionTransportOffer = job.PositionTransportOffer,
                PositionAreas = job.PositionAreas,
                PositionActivePeriod = job.PositionActivePeriod,
                PositionAttachment = job.PositionAttachment,
                RNGForPositionUploaded_HashedAsUniqueID = job.RNGForPositionUploaded_HashedAsUniqueID,
                RNGForPositionUploaded = job.RNGForPositionUploaded,
                UploadDateTime = job.UploadDateTime,
                TimesUpdated = job.TimesUpdated,
                UpdateDateTime = DateTime.Today,
                OpenSlots = job.OpenSlots
            };

            // Clear all previous selections
            SelectedAreasToEditForCompanyJob.Clear();
            SelectedSubFieldsForEditCompanyJob.Clear();
            ExpandedAreasForEditCompanyJob.Clear();

            // Initialize area and subfield selections from the existing job data
            InitializeAreaSelectionsForEdit(job);

            isEditPopupVisibleForJobs = true;
            StateHasChanged();
        }

        private void InitializeAreaSelectionsForEdit(CompanyJob job)
        {
            if (!string.IsNullOrEmpty(job.PositionAreas))
            {
                // Split the stored areas string and trim each item
                var selectedItems = job.PositionAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
            
                Console.WriteLine($"Debug: PositionAreas = {job.PositionAreas}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
            
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
                
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForCompanyJob.Add(area);
                    }
                
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                    
                        bool hasSelectedSubfields = false;
                    
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditCompanyJob.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditCompanyJob[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditCompanyJob[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditCompanyJob[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                    
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditCompanyJob.Add(area.Id);
                        }
                    }
                }
            
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForCompanyJob.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditCompanyJob.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditCompanyJob.Count}");
            }
        }

        private void CloseEditPopupForJobs()
        {
            isEditPopupVisibleForJobs = false;
            StateHasChanged();
        }



        private async Task SaveEditedJob()
        {
            try
            {
                // Check if required fields are filled
                if (string.IsNullOrWhiteSpace(selectedJob.PositionTitle) || string.IsNullOrWhiteSpace(selectedJob.PositionDescription))
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    return;
                }

                // Build areas and subfields string
                var areasWithSubfields = new List<string>();

                // Add selected areas
                foreach (var area in SelectedAreasToEditForCompanyJob)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditCompanyJob)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Convert to comma-separated string
                selectedJob.PositionAreas = string.Join(",", areasWithSubfields);

                // Update job in database
                var jobToUpdate = await dbContext.CompanyJobs.FindAsync(selectedJob.Id);
                if (jobToUpdate != null)
                {
                    // Update all properties from the edited copy
                    jobToUpdate.PositionTitle = selectedJob.PositionTitle;
                    jobToUpdate.PositionDescription = selectedJob.PositionDescription;
                    jobToUpdate.PositionStatus = selectedJob.PositionStatus;
                    jobToUpdate.PositionType = selectedJob.PositionType;
                    jobToUpdate.PositionForeas = selectedJob.PositionForeas;
                    jobToUpdate.PositionContactPerson = selectedJob.PositionContactPerson;
                    jobToUpdate.PositionPerifereiaLocation = selectedJob.PositionPerifereiaLocation;
                    jobToUpdate.PositionDimosLocation = selectedJob.PositionDimosLocation;
                    jobToUpdate.PositionPostalCodeLocation = selectedJob.PositionPostalCodeLocation;
                    jobToUpdate.PositionTransportOffer = selectedJob.PositionTransportOffer;
                    jobToUpdate.PositionAreas = selectedJob.PositionAreas;
                    jobToUpdate.PositionActivePeriod = selectedJob.PositionActivePeriod;
                    jobToUpdate.UpdateDateTime = DateTime.Today;
                    jobToUpdate.TimesUpdated = selectedJob.TimesUpdated + 1; // Increment
                    jobToUpdate.OpenSlots = selectedJob.OpenSlots;

                    if (selectedJob.PositionAttachment != null && selectedJob.PositionAttachment.Length > 0)
                    {
                        jobToUpdate.PositionAttachment = selectedJob.PositionAttachment;
                    }

                    await dbContext.SaveChangesAsync();
                
                    
                    //await LoadCompanyJobs(); 
                    showSuccessMessage = true;
                    showErrorMessage = false;
                }
                else
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                }
            }
            catch (Exception ex)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                Console.Error.WriteLine($"Error saving job: {ex.Message}");
            }
            finally
            {
                isEditPopupVisibleForJobs = false;
                selectedJob = null; // Clear the editing object
                StateHasChanged();
            }
        }


        private void ShowCompanyThesisDetails(CompanyThesis companythesis)
        {
            currentThesis = companythesis;
            isModalVisibleToShowCompanyThesisDetails = true;

        }

        private void EditCompanyThesisDetails(CompanyThesis companythesis)
        {
            // Create a deep copy of the thesis for editing
            selectedCompanyThesis = new CompanyThesis
            {
                Id = companythesis.Id,
                CompanyThesisTitle = companythesis.CompanyThesisTitle,
                CompanyThesisDescriptionsUploaded = companythesis.CompanyThesisDescriptionsUploaded,
                CompanyThesisCompanySupervisorFullName = companythesis.CompanyThesisCompanySupervisorFullName,
                CompanyThesisAreasUpload = companythesis.CompanyThesisAreasUpload,
                CompanyThesisSkillsNeeded = companythesis.CompanyThesisSkillsNeeded,
                CompanyThesisDepartment = companythesis.CompanyThesisDepartment,
                CompanyThesisStartingDate = companythesis.CompanyThesisStartingDate,
                CompanyThesisContactPersonEmail = companythesis.CompanyThesisContactPersonEmail,
                CompanyThesisContactPersonTelephone = companythesis.CompanyThesisContactPersonTelephone,
                CompanyThesisStatus = companythesis.CompanyThesisStatus,
                CompanyThesisAttachmentUpload = companythesis.CompanyThesisAttachmentUpload,
                RNGForThesisUploadedAsCompany_HashedAsUniqueID = companythesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID,
                RNGForThesisUploadedAsCompany = companythesis.RNGForThesisUploadedAsCompany,
                CompanyThesisUploadDateTime = companythesis.CompanyThesisUploadDateTime,
                CompanyThesisUpdateDateTime = DateTime.Now,
                CompanyThesisTimesUpdated = companythesis.CompanyThesisTimesUpdated,
                OpenSlots_CompanyThesis = companythesis.OpenSlots_CompanyThesis

            };

            // Clear all previous selections
            SelectedAreasToEditForCompanyThesis.Clear();
            SelectedSubFieldsForEditCompanyThesis.Clear();
            ExpandedAreasForEditCompanyThesis.Clear();
            SelectedSkillsToEditForCompanyThesis.Clear();

            Console.WriteLine($"Debug: Available Skills Count: {Skills.Count}");
            Console.WriteLine($"Debug: Skills in database: {companythesis.CompanyThesisSkillsNeeded}");

            // Initialize area and subfield selections from the existing thesis data
            InitializeAreaSelectionsForEditThesis(companythesis);
        
            // Initialize skill selections from the existing thesis data
            InitializeSkillSelectionsForEditThesis(companythesis);
            isModalVisibleToEditCompanyThesisDetails = true;
            // Force UI update
            StateHasChanged();
        
            // Additional debug after initialization
            Console.WriteLine($"Debug: After init - Selected Skills: {SelectedSkillsToEditForCompanyThesis.Count}");
            foreach (var skill in SelectedSkillsToEditForCompanyThesis)
            {
                Console.WriteLine($"Debug: Selected Skill: {skill.SkillName} (ID: {skill.Id})");
            }
        }

        private void InitializeSkillSelectionsForEditThesis(CompanyThesis thesis)
        {
            if (!string.IsNullOrEmpty(thesis.CompanyThesisSkillsNeeded))
            {
                // Split the stored skills string and trim each item
                var selectedSkillNames = thesis.CompanyThesisSkillsNeeded.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();

                Console.WriteLine($"Debug: CompanyThesisSkillsNeeded = {thesis.CompanyThesisSkillsNeeded}");
                Console.WriteLine($"Debug: Selected Skills Count = {selectedSkillNames.Count}");
                Console.WriteLine($"Debug: Available Skills Count = {Skills.Count}");

                // Find and add the corresponding skill objects
                foreach (var skill in Skills)
                {
                    bool isSelected = selectedSkillNames.Contains(skill.SkillName);
                    Console.WriteLine($"Debug: Skill '{skill.SkillName}' - Selected: {isSelected}");
                
                    if (isSelected)
                    {
                        Console.WriteLine($"Debug: Skill selected: {skill.SkillName}");
                        SelectedSkillsToEditForCompanyThesis.Add(skill);
                    }
                }

                Console.WriteLine($"Debug: Final Selected Skills Count = {SelectedSkillsToEditForCompanyThesis.Count}");
            
                // Debug: List all selected skills
                foreach (var skill in SelectedSkillsToEditForCompanyThesis)
                {
                    Console.WriteLine($"Debug: Selected Skill: {skill.SkillName}");
                }
            }
            else
            {
                Console.WriteLine("Debug: CompanyThesisSkillsNeeded is null or empty");
            }
        }

        private void InitializeAreaSelectionsForEditThesis(CompanyThesis thesis)
        {
            if (!string.IsNullOrEmpty(thesis.CompanyThesisAreasUpload))
            {
                // Split the stored areas string and trim each item
                var selectedItems = thesis.CompanyThesisAreasUpload.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: CompanyThesisAreasUpload = {thesis.CompanyThesisAreasUpload}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForCompanyThesis.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditCompanyThesis.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditCompanyThesis[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditCompanyThesis[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditCompanyThesis[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditCompanyThesis.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForCompanyThesis.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditCompanyThesis.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditCompanyThesis.Count}");
            }
        }
        private void CloseModalForCompanyThesis()
        {
            isModalVisibleToShowCompanyThesisDetails = false;
            currentThesis = null;
        }

        private void CloseModalForProfessorDetails()
        {
            isModalVisibleToShowprofessorDetailsAtCompanyThesisInterest = false;
            currentProfessorDetails = null;
        }




        private async Task ShowCompanyThesisApplicationsAsStudent(CompanyThesisApplied thesis)
        {
            selectedCompanyThesisApplicationToShowAsStudent = thesis;
            await JS.InvokeVoidAsync("showModal", "thesisDetailsModal");
        }

        private async Task ShowProfessorThesisApplicationsAsStudent(ProfessorThesisApplied thesis)
        {
            selectedProfessorThesisApplicationToShowAsStudent = thesis;
            await JS.InvokeVoidAsync("showModal", "thesisDetailsModal");
        }

        private async Task ConfirmApplyForInternship(CompanyInternship internship)
        {
            var message = $"Πρόκεται να κάνετε αίτηση για την Θέση \"{internship.CompanyInternshipTitle}\". Είστε σίγουρος/η;";
        
            var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", message);

            if (confirmed)
            {
                await ApplyForInternshipAsStudent(internship);
            }
        }

        private bool showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
        private int loadingProgressWhenApplyForCompanyInternshipAsStudent = 0;
        private async Task ApplyForInternshipAsStudent(CompanyInternship internship)
        {
            try
            {

                showLoadingModalWhenApplyForCompanyInternshipAsStudent = true;
                loadingProgressWhenApplyForCompanyInternshipAsStudent = 0;
                StateHasChanged();

                // Step 1: Check internship status
                await UpdateProgressWhenApplyForCompanyInternshipAsStudent(10, 200);
            
                var latestInternship = await dbContext.CompanyInternships
                    .AsNoTracking()
                    .Where(i => i.RNGForInternshipUploadedAsCompany == internship.RNGForInternshipUploadedAsCompany)
                    .Select(i => new { i.CompanyUploadedInternshipStatus })
                    .FirstOrDefaultAsync();

                if (latestInternship == null || latestInternship.CompanyUploadedInternshipStatus != "Δημοσιευμένη")
                {
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Πρακτική Άσκηση δεν είναι πλέον διαθέσιμη. Παρακαλώ δοκιμάστε αργότερα.");
                    return;
                }

                // Step 2: Authentication and student details
                await UpdateProgressWhenApplyForCompanyInternshipAsStudent(20, 200);
            
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (!user.Identity.IsAuthenticated)
                {
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                    return;
                }

                var student = await GetStudentDetails(user.Identity.Name);
                if (student == null)
                {
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 3: Check for existing application
                await UpdateProgressWhenApplyForCompanyInternshipAsStudent(30, 200);
            
                var existingApplication = await dbContext.InternshipsApplied
                    .FirstOrDefaultAsync(app =>
                        app.StudentEmailAppliedForInternship == student.Email &&
                        app.RNGForInternshipApplied == internship.RNGForInternshipUploadedAsCompany);

                if (existingApplication != null)
                {
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη κάνει αίτηση για: {internship.CompanyInternshipTitle}!");
                    return;
                }

                // Step 4: Get company data
                await UpdateProgressWhenApplyForCompanyInternshipAsStudent(40, 200);
            
                var company = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == internship.CompanyEmailUsedToUploadInternship);

                if (company == null)
                {
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε η εταιρία.");
                    return;
                }

                // Step 5: Begin transaction and save data
                await UpdateProgressWhenApplyForCompanyInternshipAsStudent(50, 200);
            
                using var transaction = await dbContext.Database.BeginTransactionAsync();
                try
                {
                    var internshipApplication = new InternshipApplied
                    {
                        RNGForInternshipApplied = internship.RNGForInternshipUploadedAsCompany,
                        DateTimeStudentAppliedForInternship = DateTime.Now,
                        StudentEmailAppliedForInternship = student.Email,
                        StudentUniqueIDAppliedForInternship = student.Student_UniqueID,
                        CompanyEmailWhereStudentAppliedForInternship = internship.CompanyEmailUsedToUploadInternship,
                        CompanyUniqueIDWhereStudentAppliedForInternship = company.Company_UniqueID,
                        InternshipStatusAppliedAtTheCompanySide = "Σε Επεξεργασία",
                        InternshipStatusAppliedAtTheStudentSide = "Σε Επεξεργασία",
                        RNGForInternshipAppliedAsStudent_HashedAsUniqueID = internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID,

                        StudentDetails = new InternshipApplied_StudentDetails
                        {
                            StudentEmailAppliedForInternship = student.Email,
                            StudentUniqueIDAppliedForInternship = student.Student_UniqueID,
                            DateTimeStudentAppliedForInternship = DateTime.Now,
                            RNGForInternshipAppliedAsStudent_HashedAsUniqueID = internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID
                        },

                        CompanyDetails = new InternshipApplied_CompanyDetails
                        {
                            CompanyUniqueIDWhereStudentAppliedForInternship = company.Company_UniqueID,
                            CompanyEmailWhereStudentAppliedForInternship = internship.CompanyEmailUsedToUploadInternship
                        }
                    };

                    dbContext.InternshipsApplied.Add(internshipApplication);

                    // Add platform action
                    dbContext.PlatformActions.Add(new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "COMPANY_INTERNSHIP",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(internship.RNGForInternshipUploadedAsCompany),
                        TypeOfAction_PerformedAction = "APPLY",
                        DateTime_PerformedAction = DateTime.Now
                    });

                    await dbContext.SaveChangesAsync();
                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(70, 200);
                
                    await transaction.CommitAsync();
                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(75, 200);

                    // Step 6: Send emails
                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(80, 200);
                
                    try
                    {
                        await InternshipEmailService.SendCompanyInternshipApplicationConfirmationToStudent(
                            student.Email, student.Name, student.Surname,
                            internship.CompanyInternshipTitle, 
                            internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID, 
                            internship.Company?.CompanyName ?? "Unknown Company");

                        await InternshipEmailService.SendInternshipApplicationNotificationToCompany(
                            internship.CompanyEmailUsedToUploadInternship, 
                            internship.Company?.CompanyName ?? "Unknown Company",
                            student.Name, student.Surname, student.Email,
                            student.Telephone, student.StudyYear, student.Attachment,
                            internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID, 
                            internship.CompanyInternshipTitle);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Email error: {ex.Message}");
                    }

                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(90, 200);

                    // Step 7: Refresh student data
                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(95, 200);
                    await RefreshStudentData();

                    // Step 8: Final success message
                    await UpdateProgressWhenApplyForCompanyInternshipAsStudent(100, 200);
                
                    // Small delay to show completion
                    await Task.Delay(500);
                
                    // Hide loading modal before showing success message
                    showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                    StateHasChanged();
                
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Η αίτηση για {internship.CompanyInternshipTitle} υποβλήθηκε επιτυχώς!");

                        // AFTER user clicks OK, show the navigation loader
                        await Task.Delay(100); // Small delay for smooth transition
            
                        // Show the navigation loader
                        await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                        // Give time for loader to render
                        await Task.Delay(300);
                
                    // Step 9: Navigate
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw; // Re-throw to be caught by outer try-catch
                }
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenApplyForCompanyInternshipAsStudent = false;
                StateHasChanged();
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
            }
        }

        // Helper method for company internship
        private async Task UpdateProgressWhenApplyForCompanyInternshipAsStudent(int current, int total)
        {
            loadingProgressWhenApplyForCompanyInternshipAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50);
        }


        private async Task ConfirmApplyForProfessorInternship(ProfessorInternship internship)
        {
            var message = $"Πρόκεται να κάνετε αίτηση για την Θέση \"{internship.ProfessorInternshipTitle}\". Είστε σίγουρος/η;";
        
            var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", message);

            if (confirmed)
            {
                await ApplyForProfessorInternshipAsStudent(internship);
            }
        }

        private bool showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
        private int loadingProgressWhenApplyForProfessorInternshipAsStudent = 0;
        private async Task ApplyForProfessorInternshipAsStudent(ProfessorInternship internship)
        {
            try
            {
                // NO confirmation dialog here - it's already in ConfirmApplyForProfessorInternship
                // Show the loading modal immediately since user already confirmed
                showLoadingModalWhenApplyForProfessorInternshipAsStudent = true;
                loadingProgressWhenApplyForProfessorInternshipAsStudent = 0;
                StateHasChanged();

                // Step 1: Check internship status
                await UpdateProgressWhenApplyForProfessorInternshipAsStudent(10, 200);
            
                var latestInternship = await dbContext.ProfessorInternships
                    .AsNoTracking()
                    .Where(i => i.RNGForInternshipUploadedAsProfessor == internship.RNGForInternshipUploadedAsProfessor)
                    .Select(i => new { i.ProfessorUploadedInternshipStatus })
                    .FirstOrDefaultAsync();

                if (latestInternship == null || latestInternship.ProfessorUploadedInternshipStatus != "Δημοσιευμένη")
                {
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Πρακτική Άσκηση δεν είναι πλέον διαθέσιμη. Παρακαλώ δοκιμάστε αργότερα.");
                    return;
                }

                // Step 2: Authentication and student details
                await UpdateProgressWhenApplyForProfessorInternshipAsStudent(20, 200);
            
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (!user.Identity.IsAuthenticated)
                {
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                    return;
                }

                var student = await GetStudentDetails(user.Identity.Name);
                if (student == null)
                {
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 3: Check for existing application
                await UpdateProgressWhenApplyForProfessorInternshipAsStudent(30, 200);
            
                var existingApplication = await dbContext.ProfessorInternshipsApplied
                    .FirstOrDefaultAsync(app =>
                        app.StudentEmailAppliedForProfessorInternship == student.Email &&
                        app.RNGForProfessorInternshipApplied == internship.RNGForInternshipUploadedAsProfessor);

                if (existingApplication != null)
                {
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη κάνει αίτηση για: {internship.ProfessorInternshipTitle}!");
                    return;
                }

                // Step 4: Get professor data
                await UpdateProgressWhenApplyForProfessorInternshipAsStudent(40, 200);
            
                var professor = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == internship.ProfessorEmailUsedToUploadInternship);

                if (professor == null)
                {
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε ο καθηγητής.");
                    return;
                }

                // Step 5: Begin transaction and save data
                await UpdateProgressWhenApplyForProfessorInternshipAsStudent(50, 200);
            
                using var transaction = await dbContext.Database.BeginTransactionAsync();
                try
                {
                    var professorInternshipApplication = new ProfessorInternshipApplied
                    {
                        RNGForProfessorInternshipApplied = internship.RNGForInternshipUploadedAsProfessor,
                        DateTimeStudentAppliedForProfessorInternship = DateTime.Now,
                        StudentEmailAppliedForProfessorInternship = student.Email,
                        StudentUniqueIDAppliedForProfessorInternship = student.Student_UniqueID,
                        ProfessorEmailWhereStudentAppliedForInternship = internship.ProfessorEmailUsedToUploadInternship,
                        ProfessorUniqueIDWhereStudentAppliedForInternship = professor.Professor_UniqueID,
                        InternshipStatusAppliedAtTheProfessorSide = "Σε Επεξεργασία",
                        InternshipStatusAppliedAtTheStudentSide = "Σε Επεξεργασία",
                        RNGForProfessorInternshipApplied_HashedAsUniqueID = internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID,

                        StudentDetails = new ProfessorInternshipsApplied_StudentDetails
                        {
                            StudentUniqueIDAppliedForProfessorInternship = student.Student_UniqueID,
                            StudentEmailAppliedForProfessorInternship = student.Email,
                            DateTimeStudentAppliedForProfessorInternship = DateTime.Now,
                            RNGForProfessorInternshipAppliedAsStudent_HashedAsUniqueID = internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID
                        },

                        ProfessorDetails = new ProfessorInternshipsApplied_ProfessorDetails
                        {
                            ProfessorUniqueIDWhereStudentAppliedForProfessorInternship = professor.Professor_UniqueID,
                            ProfessorEmailWhereStudentAppliedForProfessorInternship = internship.ProfessorEmailUsedToUploadInternship
                        }
                    };

                    dbContext.ProfessorInternshipsApplied.Add(professorInternshipApplication);

                    // Add platform action
                    dbContext.PlatformActions.Add(new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "PROFESSOR_INTERNSHIP",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(internship.RNGForInternshipUploadedAsProfessor),
                        TypeOfAction_PerformedAction = "APPLY",
                        DateTime_PerformedAction = DateTime.Now
                    });

                    await dbContext.SaveChangesAsync();
                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(70, 200);
                
                    await transaction.CommitAsync();
                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(75, 200);

                    // Step 6: Send emails
                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(80, 200);
                
                    try
                    {
                        await InternshipEmailService.SendProfessorInternshipApplicationConfirmationToStudent(
                            student.Email,
                            student.Name,
                            student.Surname,
                            internship.ProfessorInternshipTitle,
                            internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID,
                            $"{professor.ProfName} {professor.ProfSurname}");

                        await InternshipEmailService.SendProfessorInternshipApplicationNotificationToProfessor(
                            internship.ProfessorEmailUsedToUploadInternship,
                            $"{professor.ProfName} {professor.ProfSurname}",
                            student.Name,
                            student.Surname,
                            student.Email,
                            student.Telephone,
                            student.StudyYear,
                            student.Attachment,
                            internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID,
                            internship.ProfessorInternshipTitle);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Email error: {ex.Message}");
                    }

                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(90, 200);

                    // Step 7: Refresh student data
                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(95, 200);
                    await RefreshStudentData();

                    // Step 8: Final success message
                    await UpdateProgressWhenApplyForProfessorInternshipAsStudent(100, 200);
                
                    // Small delay to show completion
                    await Task.Delay(500);
                
                    // Hide loading modal before showing success message
                    showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                    StateHasChanged();
                
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Η αίτηση για {internship.ProfessorInternshipTitle} υποβλήθηκε επιτυχώς!");

                        await Task.Delay(100); // Small delay for smooth transition
            
                        // Show the navigation loader
                        await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                        // Give time for loader to render
                        await Task.Delay(300);
                
                    // Step 9: Navigate
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw; // Re-throw to be caught by outer try-catch
                }
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenApplyForProfessorInternshipAsStudent = false;
                StateHasChanged();
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
            }
        }

        // Helper method for professor internship
        private async Task UpdateProgressWhenApplyForProfessorInternshipAsStudent(int current, int total)
        {
            loadingProgressWhenApplyForProfessorInternshipAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50);
        }


        private async Task ConfirmApplyForJob(CompanyJob job)
        {
            var message = $"Πρόκεται να κάνετε αίτηση για την Θέση \"{job.PositionTitle}\".Είστε σίγουρος/η;";
            var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", message);
        
            if (confirmed)
            {
                await ApplyForJobAsStudent(job);
            }
        }

        private bool isLoadingStudentInternshipApplications = false;
        private async Task ToggleAndLoadStudentInternshipApplications()
        {
            showStudentInternshipApplications = !showStudentInternshipApplications;

            if (showStudentInternshipApplications)
            {
                isLoadingStudentInternshipApplications = true;
                StateHasChanged();
            
                try
                {
                    await LoadUserInternshipApplications();
                }
                finally
                {
                    isLoadingStudentInternshipApplications = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }


        private async Task LoadUserInternshipApplications()
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Initialize lists and caches
            internshipApplications = new List<InternshipApplied>();
            professorInternshipApplications = new List<ProfessorInternshipApplied>();
            internshipDataCache = new Dictionary<long, CompanyInternship>();
            professorInternshipDataCache = new Dictionary<long, ProfessorInternship>();

            if (user.Identity.IsAuthenticated)
            {
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Get student details
                    var student = await dbContext.Students
                    .FirstOrDefaultAsync(s => s.Email == userEmail);

                    if (student != null)
                    {
                        // Fetch company internship applications with details (unchanged)
                        internshipApplications = await dbContext.InternshipsApplied
                            .Include(app => app.StudentDetails)
                            .Include(app => app.CompanyDetails)
                            .Where(app => app.StudentDetails.StudentUniqueIDAppliedForInternship == student.Student_UniqueID)
                            .ToListAsync();

                        // Load all related company internships in one query
                        var companyInternshipRNGs = internshipApplications.Select(a => a.RNGForInternshipApplied).ToList();
                        var companyInternships = await dbContext.CompanyInternships
                            .Include(i => i.Company)
                            .Where(i => companyInternshipRNGs.Contains(i.RNGForInternshipUploadedAsCompany))
                            .ToListAsync();

                        // Populate company internship cache
                        foreach (var internship in companyInternships)
                        {
                            internshipDataCache[internship.RNGForInternshipUploadedAsCompany] = internship;
                        }

                        // Fetch professor internship applications with details
                        professorInternshipApplications = await dbContext.ProfessorInternshipsApplied
                            .Include(app => app.StudentDetails)
                            .Include(app => app.ProfessorDetails)
                            .Where(app => app.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == student.Student_UniqueID)
                            .ToListAsync();

                        // Load all related professor internships in one query with updated property names
                        var professorInternshipRNGs = professorInternshipApplications.Select(a => a.RNGForProfessorInternshipApplied).ToList();
                        var professorInternships = await dbContext.ProfessorInternships
                            .Include(i => i.Professor) // Include professor navigation property
                            .Where(i => professorInternshipRNGs.Contains(i.RNGForInternshipUploadedAsProfessor)) // Updated property
                            .ToListAsync();

                        // Populate professor internship cache with updated property names
                        foreach (var internship in professorInternships)
                        {
                            professorInternshipDataCache[internship.RNGForInternshipUploadedAsProfessor] = internship;
                        }
                    }
                }
            }

            StateHasChanged();
        }




        private void ShowJobDetails(CompanyJobApplied jobApplication)
        {
            selectedJobApplication = jobApplication;
            ShowJobDetailsModal();
        }

        private async void ShowJobDetailsModal()
        {
            await JS.InvokeVoidAsync("ShowBootstrapModal", "#jobDetailsModal");
        }

        public class CompanyInternshipAreasForCheckboxes
        {
            public List<Area> CompanyInternshipAreas { get; set; } = new List<Area>();
        }

        private bool IsSelectedAreasWhenUploadJobAsCompany(Area area)
        {
            return SelectedAreasWhenUploadJobAsCompany.Contains(area);
        }

        private bool IsSelectedAreasWhenUploadThesisAsCompany(Area area)
        {
            return SelectedAreasWhenUploadThesisAsCompany.Contains(area);
        }

        private bool IsSelectedAreasWhenUploadInternshipAsCompany(Area area)
        {
            return SelectedAreasWhenUploadInternshipAsCompany.Contains(area);
        }

        private bool IsSelectedAreaForCompanyEvent(Area area)
        {
            return SelectedAreasWhenUploadEventAsCompany.Contains(area);
        }

        private bool IsSelectedAreaForProfessorEvent(Area area)
        {
            return SelectedAreasWhenUploadEventAsProfessor.Contains(area);
        }

        private bool IsSelectedAreaForProfessorInternship(Area area)
        {
            return SelectedAreasWhenUploadInternshipAsProfessor.Contains(area);
        }

        private bool IsSelectedForSkillsWhenUploadThesisAsCompany(Skill skill)
        {
            return SelectedSkillsWhenUploadThesisAsCompany.Contains(skill);
        }

        private void OnCheckedChangedAreasWhenUploadJobAsCompany(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadJobAsCompany.Contains(area))
                    {
                        SelectedAreasWhenUploadJobAsCompany.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadJobAsCompany.Remove(area);
                }

                if (SelectedAreasWhenUploadJobAsCompany.Any())
                {
                    showErrorMessagesForAreasWhenUploadJobAsCompany = false;
                }

            }
        }

        private void OnCheckedChangedAreasWhenUploadInternshipAsCompany(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadInternshipAsCompany.Contains(area))
                    {
                        SelectedAreasWhenUploadInternshipAsCompany.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadInternshipAsCompany.Remove(area);
                }

                if (SelectedAreasWhenUploadInternshipAsCompany.Any())
                {
                    showErrorMessagesForAreasWhenUploadInternshipAsCompany = false;
                }

            }
        }

        private void OnCheckedChangedAreasWhenUploadThesisAsCompany(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadThesisAsCompany.Contains(area))
                    {
                        SelectedAreasWhenUploadThesisAsCompany.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadThesisAsCompany.Remove(area);
                }

                if (SelectedAreasWhenUploadThesisAsCompany.Any())
                {
                    showErrorMessage = false;
                }

            }
        }

        private void OnCheckedChangedAreasWhenUploadInternshipAsProfessor(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadInternshipAsProfessor.Contains(area))
                    {
                        SelectedAreasWhenUploadInternshipAsProfessor.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadInternshipAsProfessor.Remove(area);
                }

                if (SelectedAreasWhenUploadInternshipAsProfessor.Any())
                {
                    showErrorMessage = false;
                }

            }
        }


        private void OnCheckedChangedForCompanyEvent(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadEventAsCompany.Contains(area))
                    {
                        SelectedAreasWhenUploadEventAsCompany.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadEventAsCompany.Remove(area);
                }
            }
        }

        private void OnCheckedChangedForProfessorEvent(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasWhenUploadEventAsProfessor.Contains(area))
                    {
                        SelectedAreasWhenUploadEventAsProfessor.Add(area);
                    }
                }
                else
                {
                    SelectedAreasWhenUploadEventAsProfessor.Remove(area);
                }
            }
        }

        private void OnCheckedChangedForSkillsWhenUploadThesisAsCompany(ChangeEventArgs e, Skill skill)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedSkillsWhenUploadThesisAsCompany.Contains(skill))
                    {
                        SelectedSkillsWhenUploadThesisAsCompany.Add(skill);
                    }
                }
                else
                {
                    SelectedSkillsWhenUploadThesisAsCompany.Remove(skill);
                }
                if (SelectedSkillsWhenUploadThesisAsCompany.Any())
                {
                    showErrorMessagesForSkillsWhenUploadThesisAsCompany = false;
                }

            }
        }

        private void ToggleCheckboxesForCompanyInternship()
        {
            showCheckboxesForCompanyInternship = !showCheckboxesForCompanyInternship;
            StateHasChanged();
        }

        private async Task ToggleCheckboxesForAreasForCompanyThesis()
        {
            await JS.InvokeVoidAsync("toggleCompanyThesisAreasCheckboxes");
        }

        private async Task ToggleCheckboxesForAreasForCompanyEvent()
        {
            await JS.InvokeVoidAsync("toggleCompanyEventAreasCheckboxes");
        }

        private async Task ToggleCheckboxesForAreasForProfessorEvent()
        {
            await JS.InvokeVoidAsync("toggleProfessorEventAreasCheckboxes");
        }

        private async Task ToggleCheckboxesForSkillsForCompanyThesis()
        {
            await JS.InvokeVoidAsync("toggleCompanyThesisSkillsCheckboxes");
        }

        private bool showCheckboxesForCompanyJob = false; // Start as closed
        private void ToggleCheckboxesForCompanyJob()
        {
            showCheckboxesForCompanyJob = !showCheckboxesForCompanyJob;
            StateHasChanged();
        }

    private async Task UpdateInternshipStatusAsCompany(int internshipId, string newStatus)
        {
            // Skip confirmation dialog if the new status is "Μη Δημοσιευμένη"
            if (newStatus != "Μη Δημοσιευμένη")
            {
                bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                    $"Πρόκειται να αλλάξετε την κατάσταση της Θέσης Πρακτικής σε '{newStatus}'. Είστε σίγουρος/η; <br>"
                });

                if (!isConfirmed)
                    return;
            }

            // Retrieve the internship from the database
            var internship = await dbContext.CompanyInternships
                .FirstOrDefaultAsync(i => i.Id == internshipId);

            if (internship != null)
            {
                // Update the status
                internship.CompanyUploadedInternshipStatus = newStatus;

                // If the internship status is "Αποσυρμένη", update student applications
                if (newStatus == "Αποσυρμένη")
                {
                    var rngForInternship = internship.RNGForInternshipUploadedAsCompany; // Updated property name

                    // Retrieve all student applications for this internship
                    var studentApplications = await dbContext.InternshipsApplied
                        .Where(a => a.RNGForInternshipApplied == rngForInternship)
                        .ToListAsync();

                    // Update the status for each student application
                    foreach (var application in studentApplications)
                    {
                        application.InternshipStatusAppliedAtTheCompanySide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                    }
                }

                // Save all changes
                await dbContext.SaveChangesAsync();

                // Reload data and refresh UI
                await LoadInternships();
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#internships";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("activateTab", "internships");
            }
        }



        private async Task UpdateInternshipStatusAsProfessor(int internshipId, string newStatus)
        {
            // Show confirmation dialog
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] 
            { 
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Πρακτικής Άσκησης σε '{newStatus}'. Είστε σίγουρος/η;" 
            });

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Retrieve the internship from the database
                var internship = await dbContext.ProfessorInternships
                    .FirstOrDefaultAsync(i => i.Id == internshipId);

                if (internship != null)
                {
                    // Update the status
                    internship.ProfessorUploadedInternshipStatus = newStatus;

                    // If the internship status is "Αποσυρμένη", update student applications
                    if (newStatus == "Αποσυρμένη")
                    {
                        var rngForInternship = internship.RNGForInternshipUploadedAsProfessor; // Updated property name

                        // Retrieve all student applications for this internship
                        var studentApplications = await dbContext.ProfessorInternshipsApplied
                            .Where(a => a.RNGForProfessorInternshipApplied == rngForInternship)
                            .ToListAsync();

                        // Update the status for each student application
                        foreach (var application in studentApplications)
                        {
                            application.InternshipStatusAppliedAtTheProfessorSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Καθηγητή)";
                            application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Καθηγητή)";
                        }
                    }

                    // Save all changes
                    await dbContext.SaveChangesAsync();

                    // Reload data and refresh UI
                    await LoadProfessorInternships();
                    var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#professor-internships";
                    NavigationManager.NavigateTo(tabUrl, true);
                    await Task.Delay(500);
                    await JS.InvokeVoidAsync("activateTab", "professor-internships");
                }
            }
        }


        private async Task UpdateJobStatusAsCompany(int jobId, string newStatus)
        {
            // Show confirmation dialog only if the new status is NOT "Μη Δημοσιευμένη"
            if (newStatus != "Μη Δημοσιευμένη")
            {
                var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                    $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Θέσης Εργασίας σε <strong>{newStatus}</strong>. <br><br>" +
                    "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
                });

                if (!isConfirmed) return;
            }

            // Retrieve the job from the database
            var job = await dbContext.CompanyJobs
                .FirstOrDefaultAsync(i => i.Id == jobId);

            if (job != null)
            {
                // Update the job status
                job.PositionStatus = newStatus;

                // If the job status is "Αποσυρμένη", update student applications
                if (newStatus == "Αποσυρμένη")
                {
                    var rngForJob = job.RNGForPositionUploaded;

                    // Get all applications for this job
                    var applications = await dbContext.CompanyJobsApplied
                        .Where(a => a.RNGForCompanyJobApplied == rngForJob)
                        .ToListAsync();

                    foreach (var application in applications)
                    {
                        // Update status directly on the main application entity
                        application.CompanyPositionStatusAppliedAtTheCompanySide = 
                            "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        application.CompanyPositionStatusAppliedAtTheStudentSide = 
                            "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                    }
                }

                await dbContext.SaveChangesAsync();
                await LoadJobs();

                // Refresh with tab focus
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#jobs";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("activateTab", "jobs");
            }
        }




        private async Task UpdateThesisStatusAsCompany(int companythesisId, string newCompanyThesisStatus)
        {
            try
            {
                // Skip confirmation dialog if the new status is "Μη Δημοσιευμένη"
                if (newCompanyThesisStatus != "Μη Δημοσιευμένη")
                {
                    bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        $"Πρόκειται να αλλάξετε την κατάσταση της Διπλωματικής Εργασίας σε '{newCompanyThesisStatus}'. Είστε σίγουρος/η; <br>"
                    });

                    if (!isConfirmed) return;
                }

                using var transaction = await dbContext.Database.BeginTransactionAsync();
            
                try
                {
                    // Retrieve the thesis from the database
                    var companyThesis = await dbContext.CompanyTheses
                        .FirstOrDefaultAsync(i => i.Id == companythesisId);

                    if (companyThesis == null)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκε η διπλωματική εργασία.");
                        return;
                    }

                    // Update the status
                    companyThesis.CompanyThesisStatus = newCompanyThesisStatus;
                    await dbContext.SaveChangesAsync();

                    // Handle withdrawn status
                    if (newCompanyThesisStatus == "Αποσυρμένη")
                    {
                        var studentApplications = await dbContext.CompanyThesesApplied
                            .Where(a => a.RNGForCompanyThesisApplied == companyThesis.RNGForThesisUploadedAsCompany)
                            .ToListAsync();

                        foreach (var application in studentApplications)
                        {
                            application.CompanyThesisStatusAppliedAtCompanySide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                            application.CompanyThesisStatusAppliedAtStudentSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        }

                        await dbContext.SaveChangesAsync();
                    }

                    await transaction.CommitAsync();

                    // Reload data and update UI
                    await LoadThesesAsCompany();
                    StateHasChanged();

                    // Navigate to the specific tab
                    var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#companythesis";
                    NavigationManager.NavigateTo(tabUrl, true);
                    await Task.Delay(500);
                    await JS.InvokeVoidAsync("activateTab", "companythesis");
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    Console.WriteLine($"Error updating thesis status: {ex}");
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την ενημέρωση κατάστασης: {ex.Message}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Unexpected error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    "Προέκυψε σφάλμα κατά την επεξεργασία της αίτησης.");
            }
        }





        private void OnAreaCheckboxChanged(ChangeEventArgs e, string areaName)
        {
            if (bool.TryParse(e.Value?.ToString(), out var isChecked))
            {
                if (isChecked)
                {
                    if (!selectedAreas.Contains(areaName))
                    {
                        selectedAreas.Add(areaName);
                    }
                }
                else
                {
                    selectedAreas.Remove(areaName);
                }
            }
        }


        private bool isLoadingInternshipApplicants = false;
        private long? loadingInternshipId = null;

        private long? currentlyExpandedInternshipId = null;
        private async Task ToggleInternshipExpanded(long internshipId)
        {
            // If clicking the same internship that's already expanded, close it
            if (currentlyExpandedInternshipId == internshipId)
            {
                currentlyExpandedInternshipId = null;
                internshipApplicantsMap.Remove(internshipId);
                StateHasChanged();
                return;
            }

            // Close previous internship if any
            if (currentlyExpandedInternshipId.HasValue)
            {
                internshipApplicantsMap.Remove(currentlyExpandedInternshipId.Value);
            }

            // Set the new expanded internship
            currentlyExpandedInternshipId = internshipId;

            // Show loading state
            isLoadingInternshipApplicants = true;
            loadingInternshipId = internshipId;
            StateHasChanged();

            try
            {
                if (!internshipApplicantsMap.ContainsKey(internshipId))
                {
                    internshipApplicantsMap[internshipId] = await GetApplicantsForInternships(internshipId);
                    await LoadCompanyInternshipApplicantData(); 
                
                    // ADD THIS LINE: Initialize slot data after applicants are loaded
                    InitializeSlotData_ForCompanyInternship();
                }
            }
            finally
            {
                // Hide loading state
                isLoadingInternshipApplicants = false;
                loadingInternshipId = null;
                StateHasChanged();
            }
        }

        private bool isLoadingProfessorInternshipApplicants = false;
        private long? loadingProfessorInternshipId = null;
        private async Task ToggleProfessorInternshipExpanded(long internshipId)
        {
            Console.WriteLine($"ToggleProfessorInternshipExpanded called for internship: {internshipId}");

            // Close all other expanded internships
            foreach (var key in expandedProfessorInternships.Keys.ToList())
            {
                if (key != internshipId)
                {
                    expandedProfessorInternships[key] = false;
                    professorInternshipApplicantsMap.Remove(key);
                }
            }

            // Toggle expansion state
            if (expandedProfessorInternships.ContainsKey(internshipId))
            {
                expandedProfessorInternships[internshipId] = !expandedProfessorInternships[internshipId];
            }
            else
            {
                expandedProfessorInternships[internshipId] = true;
            }

            // Load data if expanding
            if (expandedProfessorInternships[internshipId])
            {
                // Show loading state
                isLoadingProfessorInternshipApplicants = true;
                loadingProfessorInternshipId = internshipId;
                StateHasChanged();

                try
                {
                    if (!professorInternshipApplicantsMap.ContainsKey(internshipId))
                    {
                        professorInternshipApplicantsMap[internshipId] = await GetApplicantsForProfessorInternship(internshipId);
                        await LoadProfessorInternshipApplicantData();
                        // ADD THIS LINE: Initialize slot data after applicants are loaded
                        InitializeSlotDataForProfessorInternships();
                    }
                }
                finally
                {
                    // Hide loading state
                    isLoadingProfessorInternshipApplicants = false;
                    loadingProfessorInternshipId = null;
                    StateHasChanged();
                }
            }
            else
            {
                professorInternshipApplicantsMap.Remove(internshipId);
                StateHasChanged();
            }
        }



        private async Task<IEnumerable<InternshipApplied>> GetApplicantsForInternships(long internshipId)
        {
            await using var context = DbContextFactory.CreateDbContext(); //to ekana DbContextFactory gt eskage same instance error stis 09/10/2025
        
            var internship = await context.CompanyInternships
                .Where(i => i.RNGForInternshipUploadedAsCompany == internshipId)
                .FirstOrDefaultAsync();

            if (internship == null)
            {
                return Enumerable.Empty<InternshipApplied>();
            }

            return await context.InternshipsApplied
                .Where(a => a.RNGForInternshipApplied == internshipId)
                .Include(a => a.StudentDetails) 
                .AsNoTracking()
                .ToListAsync();
        }



        private void ToggleProfessorInternshipApplicants(long professorinternshipRNG)
        {
            if (expandedProfessorInternships.ContainsKey(professorinternshipRNG))
            {
                expandedProfessorInternships[professorinternshipRNG] = !expandedProfessorInternships[professorinternshipRNG];
            }
            else
            {
                expandedProfessorInternships[professorinternshipRNG] = true;
            }
            StateHasChanged();
            Console.WriteLine($"Internship ID: {professorinternshipRNG}, Expanded: {expandedProfessorInternships[professorinternshipRNG]}");
        }



        private bool isLoadingProfessorThesisApplicants = false;
        private long? loadingProfessorThesisId = null;

        private long? currentlyExpandedProfessorThesisId = null;
        private string? currentlyExpandedSectionType = null; // "students" or "company"
        private async Task ToggleProfessorThesisExpanded(long professorThesisRNG)
        {
            Console.WriteLine($"ToggleProfessorThesisExpanded called for thesis: {professorThesisRNG}");

            // If clicking the same thesis students section that's already expanded, close it
            if (currentlyExpandedProfessorThesisId == professorThesisRNG && currentlyExpandedSectionType == "students")
            {
                currentlyExpandedProfessorThesisId = null;
                currentlyExpandedSectionType = null;
                expandedTheses[professorThesisRNG] = false;
                professorThesisApplicantsMap.Remove(professorThesisRNG);
                StateHasChanged();
                return;
            }

            // Close any previously expanded sections (both students and company)
            if (currentlyExpandedProfessorThesisId.HasValue)
            {
                // Close students section if open
                if (expandedTheses.ContainsKey(currentlyExpandedProfessorThesisId.Value))
                {
                    expandedTheses[currentlyExpandedProfessorThesisId.Value] = false;
                    professorThesisApplicantsMap.Remove(currentlyExpandedProfessorThesisId.Value);
                }
            
                // Close company section if open
                if (expandedProfessorThesesForCompanyInterest.ContainsKey(currentlyExpandedProfessorThesisId.Value))
                {
                    expandedProfessorThesesForCompanyInterest[currentlyExpandedProfessorThesisId.Value] = false;
                }
            }

            // Set the new expanded thesis and section type
            currentlyExpandedProfessorThesisId = professorThesisRNG;
            currentlyExpandedSectionType = "students";

            // Show loading state
            isLoadingProfessorThesisApplicants = true;
            loadingProfessorThesisId = professorThesisRNG;
            StateHasChanged();

            try
            {
                // Set the expanded state
                expandedTheses[professorThesisRNG] = true;

                if (!professorThesisApplicantsMap.ContainsKey(professorThesisRNG))
                {
                    professorThesisApplicantsMap[professorThesisRNG] = await GetApplicantsForProfessorThesis(professorThesisRNG);
                    await LoadProfessorThesisApplicantData();
        
                    // ADD THIS LINE: Initialize slot data after applicants are loaded
                    InitializeSlotDataForProfessorThesis();
                }
            }
            finally
            {
                // Hide loading state
                isLoadingProfessorThesisApplicants = false;
                loadingProfessorThesisId = null;
                StateHasChanged();
            }
        }


        private async Task LoadProfessorThesisApplicantData()
        {
            try 
            {
                var studentEmails = professorThesisApplicantsMap.Values
                    .SelectMany(x => x)
                    .Select(a => a.StudentEmailAppliedForProfessorThesis.ToLower())
                    .Distinct()
                    .ToList();

                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                //studentDataCache.Clear(); TO EVGALA 11/09/2025 GIATI DEN EKANE RENDER TOUS APPLICANTS STO INTERNSHIP
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Loaded {students.Count} professor thesis student records");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor thesis student data: {ex.Message}");
            }
        }


        private bool isLoadingJobApplicants = false;
        private long? loadingJobPositionId = null;
        private long? currentlyExpandedJobId = null;
        private async Task ToggleJobsExpanded(long positionId)
        {
            // If clicking the same job that's already expanded, close it
            if (currentlyExpandedJobId == positionId)
            {
                currentlyExpandedJobId = null;
                jobApplicantsMap.Remove(positionId);
                StateHasChanged();
                return;
            }

            // Close previous job if any
            if (currentlyExpandedJobId.HasValue)
            {
                jobApplicantsMap.Remove(currentlyExpandedJobId.Value);
            }

            // Set the new expanded job
            currentlyExpandedJobId = positionId;

            // Show loading state
            isLoadingJobApplicants = true;
            loadingJobPositionId = positionId;
            StateHasChanged();

            try
            {
                if (!jobApplicantsMap.ContainsKey(positionId))
                {
                    jobApplicantsMap[positionId] = await GetApplicantsForJobs(positionId);
                    await LoadCompanyJobApplicantData(); 
                
                    // ADD THIS LINE: Initialize slot data after applicants are loaded
                    InitializeSlotData_ForCompanyJob();
                }
            }
            finally
            {
                // Hide loading state
                isLoadingJobApplicants = false;
                loadingJobPositionId = null;
                StateHasChanged();
            }
        }


        private bool isLoadingCompanyThesisApplicants = false;
        private long? loadingCompanyThesisId = null;
        private async Task ToggleCompanyThesesExpanded(long companyThesisRNG)
        {
            // Close professor section for the SAME position if it's open
            if (expandedCompanyThesesForProfessorInterest.ContainsKey(companyThesisRNG))
            {
                expandedCompanyThesesForProfessorInterest[companyThesisRNG] = false;
            }

            // Close all other expanded theses (applicants from other positions)
            foreach (var key in expandedCompanyTheses.Keys.ToList())
            {
                if (key != companyThesisRNG)
                {
                    expandedCompanyTheses[key] = false;
                    companyThesisApplicantsMap.Remove(key);
                }
            }

            // Close all professor expanded sections from other positions
            foreach (var key in expandedCompanyThesesForProfessorInterest.Keys.ToList())
            {
                if (key != companyThesisRNG)
                {
                    expandedCompanyThesesForProfessorInterest[key] = false;
                }
            }

            if (expandedCompanyTheses.ContainsKey(companyThesisRNG))
            {
                expandedCompanyTheses[companyThesisRNG] = !expandedCompanyTheses[companyThesisRNG];
            }
            else
            {
                expandedCompanyTheses[companyThesisRNG] = true;
            }

            if (expandedCompanyTheses[companyThesisRNG])
            {
                // Show loading state
                isLoadingCompanyThesisApplicants = true;
                loadingCompanyThesisId = companyThesisRNG;
                StateHasChanged();

                try
                {
                    if (!companyThesisApplicantsMap.ContainsKey(companyThesisRNG))
                    {
                        companyThesisApplicantsMap[companyThesisRNG] = await GetApplicantsForCompanyThesis(companyThesisRNG);
                        await LoadCompanyThesisApplicantData();
                    
                        // ADD THIS LINE: Initialize slot data after applicants are loaded
                        InitializeSlotData_ForCompanyThesis();
                    }
                }
                finally
                {
                    // Hide loading state
                    isLoadingCompanyThesisApplicants = false;
                    loadingCompanyThesisId = null;
                    StateHasChanged();
                }
            }
            else
            {
                companyThesisApplicantsMap.Remove(companyThesisRNG);
                StateHasChanged();
            }
        }

        private bool isLoadingCompanyThesisProfessors = false;
        private long? loadingCompanyThesisProfessorId = null;
        private async Task ToggleCompanyThesesExpandedForProfessorInterest(long companythesisRNG)
        {
            Console.WriteLine($"ToggleThesesExpandedProfessorInterest called for position: {companythesisRNG}");

            // Close applicant section for the SAME position if it's open
            if (expandedCompanyTheses.ContainsKey(companythesisRNG))
            {
                expandedCompanyTheses[companythesisRNG] = false;
                companyThesisApplicantsMap.Remove(companythesisRNG);
            }

            // Close all other expanded theses (professors from other positions)
            foreach (var key in expandedCompanyThesesForProfessorInterest.Keys.ToList())
            {
                if (key != companythesisRNG)
                {
                    expandedCompanyThesesForProfessorInterest[key] = false;
                }
            }
        
            // Close all applicant expanded sections from other positions
            foreach (var key in expandedCompanyTheses.Keys.ToList())
            {
                if (key != companythesisRNG)
                {
                    expandedCompanyTheses[key] = false;
                    companyThesisApplicantsMap.Remove(key);
                }
            }

            if (expandedCompanyThesesForProfessorInterest.ContainsKey(companythesisRNG))
            {
                expandedCompanyThesesForProfessorInterest[companythesisRNG] = !expandedCompanyThesesForProfessorInterest[companythesisRNG];
            }
            else
            {
                expandedCompanyThesesForProfessorInterest[companythesisRNG] = true;
            }

            if (expandedCompanyThesesForProfessorInterest[companythesisRNG])
            {
                // Show loading state
                isLoadingCompanyThesisProfessors = true;
                loadingCompanyThesisProfessorId = companythesisRNG;
                StateHasChanged();
        
                try
                {
                    if (!companyThesesProfessorsMap.ContainsKey(companythesisRNG))
                    {
                        // Load interested professors for this thesis
                        var thesisWithProfessors = await dbContext.CompanyTheses
                            .Include(t => t.ProfessorInterested)
                            .Where(t => t.RNGForThesisUploadedAsCompany == companythesisRNG && 
                                    t.IsProfessorInteresetedInCompanyThesis)
                            .ToListAsync();

                        companyThesesProfessorsMap[companythesisRNG] = thesisWithProfessors;
            
                        // Load professor data if not already cached
                        await LoadProfessorDataWhenHeShowsInterestForCompanyTheses(thesisWithProfessors);
                    }
                }
                finally
                {
                    // Hide loading state
                    isLoadingCompanyThesisProfessors = false;
                    loadingCompanyThesisProfessorId = null;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private async Task LoadProfessorDataWhenHeShowsInterestForCompanyTheses(List<CompanyThesis> theses)
        {
            try 
            {
                // Get all unique professor emails from interested theses
                var professorEmails = theses
                    .Where(t => !string.IsNullOrEmpty(t.ProfessorEmailInterestedInCompanyThesis))
                    .Select(t => t.ProfessorEmailInterestedInCompanyThesis.ToLower())
                    .Distinct()
                    .ToList();

                // Load ALL professor fields according to your model
                var professors = await dbContext.Professors
                    .Where(p => professorEmails.Contains(p.ProfEmail.ToLower()))
                    .Select(p => new Professor {
                        Id = p.Id,
                        ProfEmail = p.ProfEmail,
                        Professor_UniqueID = p.Professor_UniqueID,
                        ProfImage = p.ProfImage,
                        ProfName = p.ProfName,
                        ProfSurname = p.ProfSurname,
                        ProfUniversity = p.ProfUniversity,
                        ProfDepartment = p.ProfDepartment,
                        ProfVahmidaDEP = p.ProfVahmidaDEP,
                        ProfWorkTelephone = p.ProfWorkTelephone,
                        ProfPersonalTelephone = p.ProfPersonalTelephone,
                        ProfPersonalTelephoneVisibility = p.ProfPersonalTelephoneVisibility,
                        ProfPersonalWebsite = p.ProfPersonalWebsite,
                        ProfLinkedInSite = p.ProfLinkedInSite,
                        ProfScholarProfile = p.ProfScholarProfile,
                        ProfOrchidProfile = p.ProfOrchidProfile,
                        ProfGeneralFieldOfWork = p.ProfGeneralFieldOfWork,
                        ProfGeneralSkills = p.ProfGeneralSkills,
                        ProfPersonalDescription = p.ProfPersonalDescription,
                        ProfCVAttachment = p.ProfCVAttachment,
                        ProfRegistryNumber = p.ProfRegistryNumber,
                        ProfCourses = p.ProfCourses
                    })
                    .AsNoTracking()
                    .ToListAsync();

                // Initialize cache if null
                professorDataCache ??= new Dictionary<string, Professor>();

                // Update cache
                foreach (var professor in professors)
                {
                    professorDataCache[professor.ProfEmail.ToLower()] = professor;
                }

                Console.WriteLine($"Loaded {professors.Count} professor records for interested theses");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor data: {ex.Message}");
            }
        }


        private bool isLoadingProfessorThesisCompanies = false;
        private long? loadingProfessorThesisCompanyId = null;
        private async Task ToggleProfessorThesesExpandedForCompanyInterest(long professorthesisRNG)
        {
            Console.WriteLine($"ToggleProfessorThesesExpandedForCompanyInterest called for thesis: {professorthesisRNG}");

            // If clicking the same thesis company section that's already expanded, close it
            if (currentlyExpandedProfessorThesisId == professorthesisRNG && currentlyExpandedSectionType == "company")
            {
                currentlyExpandedProfessorThesisId = null;
                currentlyExpandedSectionType = null;
                expandedProfessorThesesForCompanyInterest[professorthesisRNG] = false;
                StateHasChanged();
                return;
            }

            // Close any previously expanded sections (both students and company)
            if (currentlyExpandedProfessorThesisId.HasValue)
            {
                // Close students section if open
                if (expandedTheses.ContainsKey(currentlyExpandedProfessorThesisId.Value))
                {
                    expandedTheses[currentlyExpandedProfessorThesisId.Value] = false;
                    professorThesisApplicantsMap.Remove(currentlyExpandedProfessorThesisId.Value);
                }
            
                // Close company section if open
                if (expandedProfessorThesesForCompanyInterest.ContainsKey(currentlyExpandedProfessorThesisId.Value))
                {
                    expandedProfessorThesesForCompanyInterest[currentlyExpandedProfessorThesisId.Value] = false;
                }
            }

            // Set the new expanded thesis and section type
            currentlyExpandedProfessorThesisId = professorthesisRNG;
            currentlyExpandedSectionType = "company";

            // Show loading state
            isLoadingProfessorThesisCompanies = true;
            loadingProfessorThesisCompanyId = professorthesisRNG;
            StateHasChanged();

            try
            {
                // Set the expanded state
                expandedProfessorThesesForCompanyInterest[professorthesisRNG] = true;

                // If you need to load company data when expanding, add it here:
                // For example, if you need to load company details:
                // await LoadCompanyDataForThesis(professorthesisRNG);
            }
            finally
            {
                // Hide loading state
                isLoadingProfessorThesisCompanies = false;
                loadingProfessorThesisCompanyId = null;
                StateHasChanged();
            }
        }


        private async Task<IEnumerable<InternshipApplied>> GetApplicants(long companyInternshipRNG)
        {
            // Get the internship details including the position information
            var internship = await dbContext.CompanyInternships
                .Where(i => i.RNGForInternshipUploadedAsCompany == companyInternshipRNG) // Updated property
                .Select(i => new {
                    i.CompanyInternshipTitle,
                    RNGForInternshipUploadedAsCompany = i.RNGForInternshipUploadedAsCompany // Updated property
                })
                .FirstOrDefaultAsync();

            if (internship == null)
                return Enumerable.Empty<InternshipApplied>();

            // Get all applications for this internship (now matching by RNG)
            return await dbContext.InternshipsApplied
                .Include(a => a.StudentDetails)
                .Include(a => a.CompanyDetails)
                .Where(a => a.RNGForInternshipApplied == companyInternshipRNG)
                .ToListAsync();
        }

        private async Task<IEnumerable<ProfessorInternshipApplied>> GetProfessorInternshipApplicants(long professorInternshipRNG)
        {
            // Get the professor internship details including the position information
            var internship = await dbContext.ProfessorInternships
                .Include(i => i.Professor) // Include professor details
                .Where(i => i.RNGForInternshipUploadedAsProfessor == professorInternshipRNG) // Updated property name
                .Select(i => new {
                    i.ProfessorInternshipTitle,
                    i.RNGForInternshipUploadedAsProfessor, // Updated property name
                    ProfessorName = i.Professor.ProfName, // From navigation property
                    ProfessorSurname = i.Professor.ProfSurname // From navigation property
                })
                .FirstOrDefaultAsync();

            if (internship == null)
                return Enumerable.Empty<ProfessorInternshipApplied>();

            // Get all applications for this internship (matching by RNG)
            return await dbContext.ProfessorInternshipsApplied
                .Include(a => a.StudentDetails)
                .Include(a => a.ProfessorDetails)
                .Where(a => a.RNGForProfessorInternshipApplied == professorInternshipRNG)
                .ToListAsync();
        }



        private async Task<IEnumerable<CompanyJobApplied>> GetApplicantsForJobs(long positionId)
        {
            // Create a new DbContext instance for this operation
            await using var context = DbContextFactory.CreateDbContext();
        
            return await context.CompanyJobsApplied
                .Where(a => a.RNGForCompanyJobApplied == positionId)
                .Include(a => a.StudentDetails)  // Make sure these are included
                .Include(a => a.CompanyDetails)
                .AsNoTracking()
                .ToListAsync();
        }


        private async Task<IEnumerable<CompanyThesisApplied>> GetApplicantsForCompanyThesis(long companyThesisRNG)
        {
            // Create a new DbContext instance for this operation
            await using var context = DbContextFactory.CreateDbContext();
        
            return await context.CompanyThesesApplied
                .Where(a => a.RNGForCompanyThesisApplied == companyThesisRNG)
                .Include(a => a.StudentDetails)  // Include student details
                .Include(a => a.CompanyDetails)  // Include company details
                .AsNoTracking()  // Add no tracking for better performance
                .ToListAsync();
        }

        private async Task<List<ProfessorThesisApplied>> GetApplicantsForProfessorThesis(long thesisRNG)
        {
            return await dbContext.ProfessorThesesApplied
                .Where(a => a.RNGForProfessorThesisApplied == thesisRNG)
                .Include(a => a.StudentDetails)
                .Include(a => a.ProfessorDetails)
                .AsNoTracking() 
                .ToListAsync();
        }



        private async Task AcceptInternshipApplicationAsCompany_MadeByStudent(long internshipRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related internship (no need to include details for status updates)
                var application = await dbContext.InternshipsApplied
                    .Join(dbContext.CompanyInternships,
                        applied => applied.RNGForInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsCompany, // Updated property
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForInternshipApplied == internshipRNG &&
                                            x.Application.StudentUniqueIDAppliedForInternship == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheCompanySide = "Επιτυχής";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForInternship);

                    // Send acceptance email to student
                    await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForInternshipPosition(
                        application.Application.StudentEmailAppliedForInternship.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Internship.CompanyInternshipTitle,
                        application.Internship.Company?.CompanyName, // Updated to use navigation property with fallback
                        application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                        student?.Attachment
                    );

                    // Send notification email to company
                    await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForInternshipPosition(
                        application.Application.CompanyEmailWhereStudentAppliedForInternship.Trim(),
                        application.Internship.Company?.CompanyName, // Updated to use navigation property with fallback
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                        application.Internship.CompanyInternshipTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Ενημερώσεις Αποδοχής στάλθηκαν τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({application.Internship.Company?.CompanyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting internship: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task RejectInternshipApplicationAsCompany_MadeByStudent(long internshipRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related internship
                var application = await dbContext.InternshipsApplied
                    .Join(dbContext.CompanyInternships,
                        applied => applied.RNGForInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsCompany, // Updated property
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForInternshipApplied == internshipRNG &&
                                        x.Application.StudentUniqueIDAppliedForInternship == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheCompanySide = "Απορρίφθηκε";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForInternship);

                    // Send rejection email to student
                    await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForInternshipPosition(
                        application.Application.StudentEmailAppliedForInternship.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Internship.CompanyInternshipTitle,
                        application.Internship.Company?.CompanyName, // Updated to use navigation property with fallback
                        application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                        student?.Attachment
                    );

                    // Send notification email to company
                    await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForInternshipPosition(
                        application.Application.CompanyEmailWhereStudentAppliedForInternship.Trim(),
                        application.Internship.Company?.CompanyName, // Updated to use navigation property with fallback
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                        application.Internship.CompanyInternshipTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2",
                        $"Η Απόρριψη της Αίτησης κοινοποιήθηκε μέσω Email τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({application.Internship.Company?.CompanyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting internship: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }



        private async Task ConfirmAndAcceptInternship(long internshipRNG, string studentUniqueID)
        {
            // First check slot availability - NEW CODE
            var internshipObj = internships.FirstOrDefault(i => i.RNGForInternshipUploadedAsCompany == internshipRNG);
            if (internshipObj == null) return;

            // Check available slots - NEW CODE
            int acceptedCount_ForCompanyInternship = acceptedApplicantsCountPerInternship_ForCompanyInternship.GetValueOrDefault(internshipRNG, 0);
            int availableSlots_ForCompanyInternship = availableSlotsPerInternship_ForCompanyInternship.GetValueOrDefault(internshipRNG, internshipObj.OpenSlots_CompanyInternships);

            if (acceptedCount_ForCompanyInternship >= availableSlots_ForCompanyInternship)
            {
                slotWarningMessage_ForCompanyInternship = $"Έχετε Αποδεχτεί {acceptedCount_ForCompanyInternship}/{availableSlots_ForCompanyInternship} Αιτούντες, πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Πρακτικής Άσκησης για να προχωρήσετε";
                showSlotWarningModal_ForCompanyInternship = true;
                return;
            }

            // If slots are available, show confirmation - EXISTING CODE
            bool isConfirmedForInternships = await JS.InvokeAsync<bool>(
                "confirmActionWithHTML", 
                "- ΑΠΟΔΟΧΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;"
            );
        
            if (isConfirmedForInternships)
            {
                await AcceptInternshipApplicationAsCompany_MadeByStudent(internshipRNG, studentUniqueID);
                actionsPerformedToAcceptorRejectInternshipsAsCompany = true;
            
                // Update accepted count on successful acceptance - NEW CODE
                acceptedApplicantsCountPerInternship_ForCompanyInternship[internshipRNG] = acceptedCount_ForCompanyInternship + 1;
            }
        }

        private async Task ConfirmAndRejectInternship(long internshipRNG, string studentUniqueID)
        {
            bool isConfirmedForInternships = await JS.InvokeAsync<bool>(
                "confirmActionWithHTML", 
                "- ΑΠΟΡΡΙΨΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;"
            );
        
            if (isConfirmedForInternships)
            {
                await RejectInternshipApplicationAsCompany_MadeByStudent(internshipRNG, studentUniqueID);
                actionsPerformedToAcceptorRejectInternshipsAsCompany = true; 
            }
        }

        private async Task AcceptJobApplicationAsCompany_MadeByStudent(long jobRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related job (no need to include details for status updates)
                var application = await dbContext.CompanyJobsApplied
                    .Join(dbContext.CompanyJobs,
                        applied => applied.RNGForCompanyJobApplied,
                        job => job.RNGForPositionUploaded,
                        (applied, job) => new { Application = applied, Job = job })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyJobApplied == jobRNG &&
                                            x.Application.StudentUniqueIDAppliedForCompanyJob == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyPositionStatusAppliedAtTheCompanySide = "Επιτυχής";
                application.Application.CompanyPositionStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForCompanyJob);
        
                    // Ensure Company data is loaded
                    if (application.Job.Company == null)
                    {
                        await dbContext.Entry(application.Job)
                            .Reference(j => j.Company)
                            .LoadAsync();
                    }

                    // Send acceptance email to student
                    await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForJobPosition(
                        application.Application.StudentEmailAppliedForCompanyJob.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Job.PositionTitle,
                        application.Job.Company?.CompanyName, // Get from Company navigation property
                        application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                        student?.Attachment
                    );

                    // Send notification email to company
                    await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForJobPosition(
                        application.Application.CompanysEmailWhereStudentAppliedForCompanyJob.Trim(),
                        application.Job.Company?.CompanyName, // Get from Company navigation property
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                        application.Job.PositionTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Ενημερώσεις Αποδοχής στάλθηκαν τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({application.Job.Company?.CompanyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting job: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task RejectJobApplicationAsCompany_MadeByStudent(long jobRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related job (no need to include details for status updates)
                var application = await dbContext.CompanyJobsApplied
                    .Join(dbContext.CompanyJobs,
                        applied => applied.RNGForCompanyJobApplied,
                        job => job.RNGForPositionUploaded,
                        (applied, job) => new { Application = applied, Job = job })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyJobApplied == jobRNG &&
                                        x.Application.StudentUniqueIDAppliedForCompanyJob == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyPositionStatusAppliedAtTheCompanySide = "Απορρίφθηκε";
                application.Application.CompanyPositionStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForCompanyJob);
        
                    // Ensure Company data is loaded if not already included
                    if (application.Job.Company == null)
                    {
                        await dbContext.Entry(application.Job)
                            .Reference(j => j.Company)
                            .LoadAsync();
                    }

                    // Send rejection email to student
                    await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForJobPosition(
                        application.Application.StudentEmailAppliedForCompanyJob.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Job.PositionTitle,
                        application.Job.Company?.CompanyName, // From Company navigation property
                        application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                        student?.Attachment
                    );

                    // Send notification email to company
                    await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForJobPosition(
                        application.Application.CompanysEmailWhereStudentAppliedForCompanyJob.Trim(),
                        application.Job.Company?.CompanyName, // From Company navigation property
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                        application.Job.PositionTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2",
                        $"Η Απόρριψη της Αίτησης κοινοποιήθηκε μέσω Email τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({application.Job.Company?.CompanyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting job: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task ConfirmAndAcceptJob(long jobRNG, string studentUniqueID)
        {
            // First check slot availability
            var job = jobs.FirstOrDefault(j => j.RNGForPositionUploaded == jobRNG);
            if (job == null) return;

            // Check available slots
            int acceptedCount_ForCompanyJob = acceptedApplicantsCountPerJob_ForCompanyJob.GetValueOrDefault(jobRNG, 0);
            int availableSlots_ForCompanyJob = availableSlotsPerJob_ForCompanyJob.GetValueOrDefault(jobRNG, job.OpenSlots);

            if (acceptedCount_ForCompanyJob >= availableSlots_ForCompanyJob)
            {
                slotWarningMessage_ForCompanyJob = $"Έχετε Αποδεχτεί {acceptedCount_ForCompanyJob}/{availableSlots_ForCompanyJob} Αιτούντες, πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Θέσης Εργασίας για να προχωρήσετε";
                showSlotWarningModal_ForCompanyJob = true;
                return;
            }

            // If slots are available, show confirmation
            bool isConfirmedForJobs = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                "- ΑΠΟΔΟΧΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");

            if (isConfirmedForJobs)
            {
                await AcceptJobApplicationAsCompany_MadeByStudent(jobRNG, studentUniqueID);
                actionsPerformedToAcceptorRejectJobsAsCompany = true;
        
                // Update accepted count on successful acceptance
                acceptedApplicantsCountPerJob_ForCompanyJob[jobRNG] = acceptedCount_ForCompanyJob + 1;
            
                // Refresh the applicants data if this job is currently expanded
                if (currentlyExpandedJobId == jobRNG && jobApplicantsMap.ContainsKey(jobRNG))
                {
                    // Reload the applicants for this job to get updated statuses
                    jobApplicantsMap[jobRNG] = await GetApplicantsForJobs(jobRNG);
                    InitializeSlotData_ForCompanyJob(); // Recalculate slot counts
                }
            
                StateHasChanged();
            }
        }

        private async Task ConfirmAndRejectJob(long jobRNG, string studentUniqueID)
        {
            bool isConfirmedForJobs = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                "- ΑΠΟΡΡΙΨΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");
        
            if (isConfirmedForJobs)
            {
                await RejectJobApplicationAsCompany_MadeByStudent(jobRNG, studentUniqueID);
                actionsPerformedToAcceptorRejectJobsAsCompany = true;
            }
        }

        private async Task AcceptThesisApplicationAsCompany_MadeByStudent(long companythesisId, string studentUniqueID)
        {
            try
            {
                // Fetch application with related thesis (similar to job approach)
                var application = await dbContext.CompanyThesesApplied
                    .Join(dbContext.CompanyTheses,
                        applied => applied.RNGForCompanyThesisApplied,
                        thesis => thesis.RNGForThesisUploadedAsCompany,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyThesisApplied == companythesisId &&
                                            x.Application.StudentUniqueIDAppliedForThesis == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyThesisStatusAppliedAtStudentSide = "Επιτυχής";
                application.Application.CompanyThesisStatusAppliedAtCompanySide = "Έχει γίνει Αποδοχή";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForThesis);
        
                    // Get company name from navigation property with fallback
                    var companyName = application.Thesis.Company?.CompanyName ?? "Άγνωστη Εταιρεία";

                    // Send acceptance email to student
                    await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForThesisPosition(
                        application.Application.StudentEmailAppliedForThesis.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Thesis.CompanyThesisTitle,
                        companyName,  // Using navigation property instead of CompanyNameUploadedThesis
                        application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                        student?.Attachment
                    );

                    // Send notification email to company
                    await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForThesisPosition(
                        application.Application.CompanyEmailWhereStudentAppliedForThesis.Trim(),
                        companyName,  // Using navigation property instead of CompanyNameUploadedThesis
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                        application.Thesis.CompanyThesisTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Ενημερώσεις Αποδοχής στάλθηκαν τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({companyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting thesis: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task RejectThesisApplicationAsCompany_MadeByStudent(long companythesisId, string studentUniqueID)
        {
            try
            {
                // Fetch application with related thesis (similar to job approach)
                var application = await dbContext.CompanyThesesApplied
                    .Join(dbContext.CompanyTheses,
                        applied => applied.RNGForCompanyThesisApplied,
                        thesis => thesis.RNGForThesisUploadedAsCompany,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyThesisApplied == companythesisId &&
                                        x.Application.StudentUniqueIDAppliedForThesis == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyThesisStatusAppliedAtCompanySide = "Έχει Απορριφθεί";
                application.Application.CompanyThesisStatusAppliedAtStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service (like in job version)
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForThesis);
        
                    // Get company name from navigation property (with fallback)
                    var companyName = application.Thesis.Company?.CompanyName ?? "Άγνωστη Εταιρεία";

                    // Send rejection email to student (using joined thesis data)
                    await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForThesisPosition(
                        application.Application.StudentEmailAppliedForThesis.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Thesis.CompanyThesisTitle, // From joined CompanyThesis
                        application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                        companyName // Using navigation property with fallback
                    );

                    // Send notification email to company (using joined thesis data)
                    await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForThesisPosition(
                        application.Application.CompanyEmailWhereStudentAppliedForThesis.Trim(),
                        companyName, // Using navigation property with fallback
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                        application.Thesis.CompanyThesisTitle // From joined CompanyThesis
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2",
                        $"Η Απόρριψη της Αίτησης κοινοποιήθηκε μέσω Email τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στην Εταιρεία ({companyName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting thesis: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task ConfirmAndAcceptStudentThesisApplicationAsCompany(long companythesisId, string studentUniqueID)
        {
            // First check slot availability - NEW CODE
            var thesisObj = companytheses.FirstOrDefault(t => t.RNGForThesisUploadedAsCompany == companythesisId);
            if (thesisObj == null) return;

            // Check available slots - NEW CODE
            int acceptedCount_ForCompanyThesis = acceptedApplicantsCountPerThesis_ForCompanyThesis.GetValueOrDefault(companythesisId, 0);
            int availableSlots_ForCompanyThesis = availableSlotsPerThesis_ForCompanyThesis.GetValueOrDefault(companythesisId, thesisObj.OpenSlots_CompanyThesis);

            if (acceptedCount_ForCompanyThesis >= availableSlots_ForCompanyThesis)
            {
                slotWarningMessage_ForCompanyThesis = $"Έχετε Αποδεχτεί {acceptedCount_ForCompanyThesis}/{availableSlots_ForCompanyThesis} Αιτούντες, πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Διπλωματικής Εργασίας για να προχωρήσετε";
                showSlotWarningModal_ForCompanyThesis = true;
                return;
            }

            // If slots are available, show confirmation - EXISTING CODE
            bool isConfirmedFortStudentThesisApplications = await JS.InvokeAsync<bool>("confirmActionWithHTML", "- ΑΠΟΔΟΧΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");
            if (isConfirmedFortStudentThesisApplications)
            {
                await AcceptThesisApplicationAsCompany_MadeByStudent(companythesisId, studentUniqueID);
                actionsPerformedToAcceptorRejectThesisAsCompany = true;
            
                // Update accepted count on successful acceptance - NEW CODE
                acceptedApplicantsCountPerThesis_ForCompanyThesis[companythesisId] = acceptedCount_ForCompanyThesis + 1;
            }
        }

        private async Task ConfirmAndRejectStudentThesisApplicationAsCompany(long companythesisId, string studentUniqueID)
        {
            bool isConfirmedFortStudentThesisApplication = await JS.InvokeAsync<bool>("confirmActionWithHTML", "- ΑΠΟΡΡΙΨΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");
            if (isConfirmedFortStudentThesisApplication)
            {
                await RejectThesisApplicationAsCompany_MadeByStudent(companythesisId, studentUniqueID);
                actionsPerformedToAcceptorRejectThesisAsCompany = true;
            }
        }

        private async Task AcceptThesisApplicationAsProfessor_MadeByStudent(long applicationId, string studentUniqueID)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.ProfessorThesesApplied
                    .Join(dbContext.ProfessorTheses,
                        applied => applied.RNGForProfessorThesisApplied,
                        thesis => thesis.RNGForThesisUploaded,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.Id == applicationId &&
                                        x.Application.StudentUniqueIDAppliedForProfessorThesis == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the application entity
                application.Application.ProfessorThesisStatusAppliedAtStudentSide = "Επιτυχής";
                application.Application.ProfessorThesisStatusAppliedAtProfessorSide = "Έχει γίνει Αποδοχή";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from navigation property with fallback
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForProfessorThesis);
            
                    // Get professor name from navigation property with fallback
                    var professorName = application.Thesis.Professor != null
                        ? $"{application.Thesis.Professor.ProfName} {application.Thesis.Professor.ProfSurname}"
                        : "Άγνωστος Καθηγητής";

                    // Send acceptance email to student
                    await InternshipEmailService.SendAcceptanceEmailAsProfessorToStudentAfterHeAppliedForThesisPosition(
                        application.Application.StudentEmailAppliedForProfessorThesis.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Thesis.ThesisTitle,
                        application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                        professorName
                    );

                    // Send notification email to professor
                    await InternshipEmailService.SendAcceptanceConfirmationEmailToProfessorAfterStudentAppliedForThesisPosition(
                        application.Application.ProfessorEmailWhereStudentAppliedForProfessorThesis.Trim(),
                        professorName,
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                        application.Thesis.ThesisTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Ενημερώσεις Αποδοχής στάλθηκαν τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στον Καθηγητή ({professorName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Email error: {ex.Message}");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Η αποδοχή καταγράφηκε, αλλά απέτυχε η αποστολή email").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting thesis: {ex.Message}\n{ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

    private async Task RejectThesisApplicationAsProfessor_MadeByStudent(long applicationId, string studentUniqueID)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.ProfessorThesesApplied
                    .Join(dbContext.ProfessorTheses,
                        applied => applied.RNGForProfessorThesisApplied,
                        thesis => thesis.RNGForThesisUploaded,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.Id == applicationId &&
                                        x.Application.StudentUniqueIDAppliedForProfessorThesis == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the application entity
                application.Application.ProfessorThesisStatusAppliedAtProfessorSide = "Έχει Απορριφθεί";
                application.Application.ProfessorThesisStatusAppliedAtStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from navigation property with fallback
                    var student = await GetStudentDetails(application.Application.StudentEmailAppliedForProfessorThesis);
            
                    // Get professor name from navigation property with fallback
                    var professorName = application.Thesis.Professor != null
                        ? $"{application.Thesis.Professor.ProfName} {application.Thesis.Professor.ProfSurname}"
                        : "Άγνωστος Καθηγητής";

                    // Send rejection email to student
                    await InternshipEmailService.SendRejectionEmailAsProfessorToStudentAfterHeAppliedForThesisPosition(
                        application.Application.StudentEmailAppliedForProfessorThesis.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Thesis.ThesisTitle,
                        application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                        professorName
                    );

                    // Send notification email to professor
                    await InternshipEmailService.SendRejectionConfirmationEmailToProfessorAfterStudentAppliedForThesisPosition(
                        application.Application.ProfessorEmailWhereStudentAppliedForProfessorThesis.Trim(),
                        professorName,
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                        application.Thesis.ThesisTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2",
                        $"Η Απόρριψη της Αίτησης κοινοποιήθηκε μέσω Email τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στον Καθηγητή ({professorName})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Email error: {ex.Message}");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Η απόρριψη καταγράφηκε, αλλά απέτυχε η αποστολή email").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting thesis: {ex.Message}\n{ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task ConfirmAndAcceptProfessorThesis(long applicationId, string studentUniqueID)
        {
            // First, get the application to find the thesis RNG
            var application = professorThesisApplicantsMap
                .SelectMany(kvp => kvp.Value)
                .FirstOrDefault(a => a.Id == applicationId && a.StudentUniqueIDAppliedForProfessorThesis == studentUniqueID);
        
            if (application == null) return;
        
            long thesisRNG = application.RNGForProfessorThesisApplied;

            // Then find the thesis
            var thesisObj = FilteredThesesAsProfessor.FirstOrDefault(t => t.RNGForThesisUploaded == thesisRNG);
            if (thesisObj == null) return;

            // Check available slots
            int acceptedCountForProfessorThesis = acceptedApplicantsCountPerProfessorThesis.GetValueOrDefault(thesisRNG, 0);
            int availableSlotsForProfessorThesis = availableSlotsPerProfessorThesis.GetValueOrDefault(thesisRNG, thesisObj.OpenSlots_ProfessorThesis);

            if (acceptedCountForProfessorThesis >= availableSlotsForProfessorThesis)
            {
                slotWarningMessageForProfessorThesis = $"Έχετε Αποδεχτεί {acceptedCountForProfessorThesis}/{availableSlotsForProfessorThesis} Αιτούντες, πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Διπλωματικής Εργασίας για να προχωρήσετε";
                showSlotWarningModalForProfessorThesis = true;
                StateHasChanged();
                return;
            }

            // If slots are available, show confirmation
            bool isConfirmedForProfessorTheses = await JS.InvokeAsync<bool>("confirmActionWithHTML", "- ΑΠΟΔΟΧΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");
            if (isConfirmedForProfessorTheses)
            {
                await AcceptThesisApplicationAsProfessor_MadeByStudent(applicationId, studentUniqueID);
                actionsPerformedToAcceptorRejectThesesAsProfessor = true;
        
                // Update accepted count on successful acceptance
                acceptedApplicantsCountPerProfessorThesis[thesisRNG] = acceptedCountForProfessorThesis + 1;
                StateHasChanged();
            }
        }


        private async Task ConfirmAndRejectProfessorThesis(long professorthesisId, string studentUniqueID)
        {
            bool isConfirmedForProfessorTheses = await JS.InvokeAsync<bool>("confirmActionWithHTML", "- ΑΠΟΡΡΙΨΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;");
            if (isConfirmedForProfessorTheses)
            {
                await RejectThesisApplicationAsProfessor_MadeByStudent(professorthesisId, studentUniqueID);
                actionsPerformedToAcceptorRejectThesesAsProfessor = true;
            }
        }
        


        private bool IsComponentActive()
        {
            return JS != null;
        }

        private async Task SafeInvokeJsAsync(Func<Task> jsAction)
        {
            try
            {
                if (IsComponentActive())
                {
                    await jsAction();
                }
            }
            catch (JSDisconnectedException)
            {
                Console.WriteLine("JS interop call failed because the circuit is disconnected.");
            }
        }


        private void CheckCharacterLimitInInternshipFieldUploadAsCompany(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInInternshipFieldUploadAsCompany = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInThesisFieldUploadAsCompany(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInThesisFieldUploadAsCompany = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInThesisFieldUploadAsProfessor(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInThesisFieldUploadAsProfessor = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInAnnouncementFieldUploadAsCompany(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInAnnouncementFieldUploadAsCompany = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInAnnouncementFieldUploadAsProfessor(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInAnnouncementFieldUploadAsProfessor = 120 - inputText.Length;
        }

    

        private void CheckCharacterLimitInInternshipDescriptionUploadAsCompany(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInInternshipDescriptionUploadAsCompany = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInInternshipDescriptionUploadAsProfessor(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInInternshipDescriptionUploadAsProfessor = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInJobFieldUploadAsCompany(ChangeEventArgs e)
        {
            // Calculate remaining characters
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInJobFieldUploadAsCompany = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInJobDescriptionUploadAsCompany(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInJobDescriptionUploadAsCompany = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInThesisDescriptionUploadAsCompany(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInThesisDescriptionUploadAsCompany = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInAnnouncementDescriptionUploadAsCompany(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInAnnouncementDescriptionUploadAsCompany = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInThesisDescriptionUploadAsProfessor(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInThesisDescriptionUploadAsProfessor = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInAnnouncementDescriptionUploadAsProfessor(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInAnnouncementDescriptionUploadAsProfessor = 1000 - inputText.Length;
        }

        private async Task CalculateStatusCountsForInternships()
        {
            await LoadInternships();
            if (internships == null) return;

            // Filter internships based on selected status
            var filteredInternships = selectedStatusFilterForInternships == "Όλα"
                ? internships
                : internships.Where(i => i.CompanyUploadedInternshipStatus == selectedStatusFilterForInternships);

            // Calculate counts
            totalCount = internships.Count();
            publishedCount = internships.Count(i => i.CompanyUploadedInternshipStatus == "Δημοσιευμένη");
            unpublishedCount = internships.Count(i => i.CompanyUploadedInternshipStatus == "Μη Δημοσιευμένη");
            withdrawnCount = internships.Count(i => i.CompanyUploadedInternshipStatus == "Αποσυρμένη");

            // Trigger UI update
            StateHasChanged();
        }

        private async Task CalculateStatusCountsForCompanyTheses()
        {
            await LoadThesesAsCompany();
            if (companytheses == null) return;

            // Filter internships based on selected status
            var filteredCompanyTheses = selectedStatusFilterForCompanyTheses == "Όλα"
                ? companytheses
                : companytheses.Where(i => i.CompanyThesisStatus == selectedStatusFilterForCompanyTheses);

            // Calculate counts
            totalCountForCompanyTheses = companytheses.Count();
            publishedCountForCompanyTheses = companytheses.Count(i => i.CompanyThesisStatus == "Δημοσιευμένη");
            unpublishedCountForCompanyTheses = companytheses.Count(i => i.CompanyThesisStatus == "Μη Δημοσιευμένη");
            withdrawnCountForCompanyTheses = companytheses.Count(i => i.CompanyThesisStatus == "Αποσυρμένη");

            // Trigger UI update
            StateHasChanged();
        }


        private async Task CalculateStatusCountsForJobs()
        {
            await LoadJobs();
            if (jobs == null) return;

            // Filter jobs based on selected status
            var filteredJobs = selectedStatusFilterForJobs == "Όλα"
                ? jobs
                : jobs.Where(i => i.PositionStatus == selectedStatusFilterForJobs);

            // Calculate counts
            totalCountJobs = jobs.Count();
            publishedCountJobs = jobs.Count(i => i.PositionStatus == "Δημοσιευμένη");
            unpublishedCountJobs = jobs.Count(i => i.PositionStatus == "Μη Δημοσιευμένη");
            withdrawnCountJobs = jobs.Count(i => i.PositionStatus == "Αποσυρμένη");

            // Trigger UI update
            StateHasChanged();
        }

        private async Task CalculateStatusCountsForAnnouncements()
        {
            await LoadUploadedAnnouncementsAsync();

            // Apply your logic to filter announcements based on the selectedStatusFilterForAnnouncements
            var filteredAnnouncements = selectedStatusFilterForAnnouncements == "Όλα"
                ? UploadedAnnouncements
                : UploadedAnnouncements.Where(i => i.CompanyAnnouncementStatus == selectedStatusFilterForAnnouncements);

            // Update counts
            totalCountAnnouncements = UploadedAnnouncements.Count();
            publishedCountAnnouncements = UploadedAnnouncements.Count(i => i.CompanyAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncements = UploadedAnnouncements.Count(i => i.CompanyAnnouncementStatus == "Μη Δημοσιευμένη");

            // Trigger UI update
            StateHasChanged();
        }

        private async Task CalculateStatusCountsForAnnouncementsAsProfessor()
        {
            await LoadUploadedAnnouncementsAsProfessorAsync();

            // Apply your logic to filter announcements based on the selectedStatusFilterForAnnouncements
            var filteredAnnouncementsAsProfessor = selectedStatusFilterForAnnouncementsAsProfessor == "Όλα"
                ? UploadedAnnouncementsAsProfessor
                : UploadedAnnouncementsAsProfessor.Where(i => i.ProfessorAnnouncementStatus == selectedStatusFilterForAnnouncementsAsProfessor);

            // Update counts
            totalCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count();
            publishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count(i => i.ProfessorAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count(i => i.ProfessorAnnouncementStatus == "Μη Δημοσιευμένη");

            // Trigger UI update
            StateHasChanged();
        }

        private async Task CalculateStatusCountsForThesesAsProfessor()
        {
            await LoadUploadedThesesAsProfessorAsync();

            // Apply your logic to filter announcements based on the selectedStatusFilterForAnnouncements
            var filteredThesesAsProfessor = selectedStatusFilterForThesesAsProfessor == "Όλα"
                ? UploadedThesesAsProfessor
                : UploadedThesesAsProfessor.Where(i => i.ThesisStatus == selectedStatusFilterForThesesAsProfessor);

            // Update counts
            totalCountThesesAsProfessor = UploadedThesesAsProfessor.Count();
            publishedCountThesesAsProfessor = UploadedThesesAsProfessor.Count(i => i.ThesisStatus == "Δημοσιευμένη");
            unpublishedCountThesesAsProfessor = UploadedThesesAsProfessor.Count(i => i.ThesisStatus == "Μη Δημοσιευμένη");
            withdrawnCountThesesAsProfessor = UploadedThesesAsProfessor.Count(i => i.ThesisStatus == "Αποσυρμένη");
            // Trigger UI update
            StateHasChanged();
        }



        @*
        rotected override async Task OnParametersSetAsync()
        {
            await base.OnParametersSetAsync();
            CalculateStatusCountsForInternships();
            CalculateStatusCountsForJobs();
        }
        *@


        private async Task UpdateStatusFilterToCountInternships()
        {
            await CalculateStatusCountsForInternships();
        }

        private async Task UpdateStatusFilterToCountJobs()
        {
            await CalculateStatusCountsForJobs();
        }

        private async Task UpdateStatusFilterToCountAnnouncements()
        {
            await CalculateStatusCountsForAnnouncements();
        }
        private async Task UpdateStatusFilterToCountCompanyTheses()
        {
            await CalculateStatusCountsForCompanyTheses();
        }





        private async Task AcceptInternshipApplicationAsProfessor_MadeByStudent(long internshipRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related internship (updated property names)
                var application = await dbContext.ProfessorInternshipsApplied
                    .Join(dbContext.ProfessorInternships.Include(i => i.Professor), // Include professor data
                        applied => applied.RNGForProfessorInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsProfessor, // Updated property
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForProfessorInternshipApplied == internshipRNG &&
                                            x.Application.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheProfessorSide = "Επιτυχής";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship);

                    // Send acceptance email to student (updated professor name source)
                    await InternshipEmailService.SendAcceptanceEmailAsProfessorToStudentAfterHeAppliedForInternshipPosition(
                        application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Internship.ProfessorInternshipTitle,
                        application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                        $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}" // From navigation property
                    );

                    // Send notification email to professor (updated professor name source)
                    await InternshipEmailService.SendAcceptanceConfirmationEmailToProfessorAfterStudentAppliedForInternshipPosition(
                        application.Application.ProfessorDetails.ProfessorEmailWhereStudentAppliedForProfessorInternship.Trim(),
                        $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}", // From navigation property
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                        application.Internship.ProfessorInternshipTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Ενημερώσεις Αποδοχής στάλθηκαν τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στον Καθηγητή ({application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting internship: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }

        private async Task RejectInternshipApplicationAsProfessor_MadeByStudent(long internshipRNG, string studentUniqueID)
        {
            try
            {
                // Fetch application with related internship (updated property names)
                var application = await dbContext.ProfessorInternshipsApplied
                    .Join(dbContext.ProfessorInternships.Include(i => i.Professor), // Include professor data
                        applied => applied.RNGForProfessorInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsProfessor, // Updated property
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForProfessorInternshipApplied == internshipRNG &&
                                        x.Application.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == studentUniqueID);

                if (application == null)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Δεν βρέθηκε η Αίτηση ή ο Φοιτητής").AsTask());
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheProfessorSide = "Απορρίφθηκε";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                try
                {
                    // Get student details from your user service
                    var student = await GetStudentDetails(application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship);

                    // Send rejection email to student (updated professor name source)
                    await InternshipEmailService.SendRejectionEmailAsProfessorToStudentAfterHeAppliedForInternshipPosition(
                        application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship.Trim(),
                        student?.Name,
                        student?.Surname,
                        application.Internship.ProfessorInternshipTitle,
                        application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                        $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}" // From navigation property
                    );

                    // Send notification email to professor (updated professor name source)
                    await InternshipEmailService.SendRejectionConfirmationEmailToProfessorAfterStudentAppliedForInternshipPosition(
                        application.Application.ProfessorDetails.ProfessorEmailWhereStudentAppliedForProfessorInternship.Trim(),
                        $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}", // From navigation property
                        student?.Name,
                        student?.Surname,
                        application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                        application.Internship.ProfessorInternshipTitle
                    );

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2",
                        $"Η Απόρριψη της Αίτησης κοινοποιήθηκε μέσω Email τόσο στον Φοιτητή " +
                        $"({student?.Name} {student?.Surname}) " +
                        $"όσο και στον Καθηγητή ({application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname})").AsTask());

                    StateHasChanged();
                }
                catch (FormatException)
                {
                    Console.WriteLine("Invalid email address format.");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        "Μη έγκυρη διεύθυνση email.").AsTask());
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting internship: {ex.Message} \n StackTrace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Παρουσιάστηκε σφάλμα: {ex.Message}").AsTask());
            }
        }


        private async Task ConfirmAndAcceptProfessorInternship(long professorInternshipId, string studentUniqueID)
        {
            // First check slot availability - NEW CODE
            var internshipObj = professorInternships.FirstOrDefault(t => t.RNGForInternshipUploadedAsProfessor == professorInternshipId);
            if (internshipObj == null) return;

            // Check available slots - NEW CODE
            int acceptedCountForProfessorInternship = acceptedApplicantsCountPerProfessorInternship.GetValueOrDefault(professorInternshipId, 0);
            int availableSlotsForProfessorInternship = availableSlotsPerProfessorInternship.GetValueOrDefault(professorInternshipId, internshipObj.OpenSlots_ProfessorInternship);

            if (acceptedCountForProfessorInternship >= availableSlotsForProfessorInternship)
            {
                slotWarningMessageForProfessorInternship = $"Έχετε Αποδεχτεί {acceptedCountForProfessorInternship}/{availableSlotsForProfessorInternship} Αιτούντες, πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Πρακτικής Άσκησης για να προχωρήσετε";
                showSlotWarningModalForProfessorInternship = true;
                StateHasChanged();
                return;
            }

            // If slots are available, show confirmation
            bool isConfirmedForProfessorInternships = await JS.InvokeAsync<bool>(
                "confirmActionWithHTML", 
                "- ΑΠΟΔΟΧΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;"
            );

            if (isConfirmedForProfessorInternships)
            {
                await AcceptInternshipApplicationAsProfessor_MadeByStudent(professorInternshipId, studentUniqueID);
                actionsPerformedToAcceptorRejectInternshipsAsProfessor = true;
        
                // Update accepted count on successful acceptance - NEW CODE
                acceptedApplicantsCountPerProfessorInternship[professorInternshipId] = acceptedCountForProfessorInternship + 1;
                StateHasChanged();
            }
        }

        private async Task ConfirmAndRejectProfessorInternship(long professorInternshipId, string studentUniqueID)
        {
            bool isConfirmedForProfessorInternships = await JS.InvokeAsync<bool>(
                "confirmActionWithHTML", 
                "- ΑΠΟΡΡΙΨΗ ΑΙΤΗΣΗΣ - \n Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;"
            );

            if (isConfirmedForProfessorInternships)
            {     
                await RejectInternshipApplicationAsProfessor_MadeByStudent(professorInternshipId, studentUniqueID);
                actionsPerformedToAcceptorRejectInternshipsAsProfessor = true;
            }
        }



        private async Task ShowCompanyDetailsinTitleAsHyperlink(string companyEmail)
        {
            try 
            {
                // Fetch company details by email (more reliable than name)
                selectedCompany = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

                if (selectedCompany != null)
                {
                    iscompanyDetailsModalVisible = true;
                    StateHasChanged();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία εταιρίας");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading company details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά τη φόρτωση των στοιχείων της εταιρίας");
            }
        }

        private async Task ShowProfessorDetailsinTitleAsHyperlink_StudentInternshipApplicationsShow(string professorEmail)
        {
            try
            {
                // Fetch professor details by email with all necessary fields
                selectedProfessor = await dbContext.Professors
                    .Where(p => p.ProfEmail == professorEmail)
                    .Select(p => new Professor {
                        Professor_UniqueID = p.Professor_UniqueID,
                        ProfEmail = p.ProfEmail,
                        ProfName = p.ProfName,
                        ProfSurname = p.ProfSurname,
                        ProfUniversity = p.ProfUniversity,
                        ProfDepartment = p.ProfDepartment,
                        ProfVahmidaDEP = p.ProfVahmidaDEP,
                        ProfWorkTelephone = p.ProfWorkTelephone,
                        ProfPersonalTelephone = p.ProfPersonalTelephoneVisibility ? p.ProfPersonalTelephone : null,
                        ProfPersonalWebsite = p.ProfPersonalWebsite,
                        ProfLinkedInSite = p.ProfLinkedInSite,
                        ProfScholarProfile = p.ProfScholarProfile,
                        ProfOrchidProfile = p.ProfOrchidProfile,
                        ProfGeneralFieldOfWork = p.ProfGeneralFieldOfWork,
                        ProfGeneralSkills = p.ProfGeneralSkills,
                        ProfPersonalDescription = p.ProfPersonalDescription,
                        ProfImage = p.ProfImage,
                        ProfCVAttachment = p.ProfCVAttachment,
                        ProfRegistryNumber = p.ProfRegistryNumber,
                        ProfCourses = p.ProfCourses
                    })
                    .AsNoTracking()
                    .FirstOrDefaultAsync();

                if (selectedProfessor != null)
                {
                    isProfessorDetailsModalVisible_StudentInternshipApplicationsShow = true;
                    StateHasChanged();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία καθηγητή");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching professor details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά την ανάκτηση των στοιχείων: {ex.Message}");
            }
        }

        @*
        private async Task ShowProfessorDetailsinTitleAsHyperlink_StudentInternshipApplicationsShow(string professorName)
        {
            // Fetch professor details by professorName from dbContext
            selectedProfessor = await dbContext.Professors.FirstOrDefaultAsync(p => p.ProfName == professorName);

            if (selectedProfessor != null)
            {
                // Set modal visibility to true
                isProfessorDetailsModalVisible_StudentInternshipApplicationsShow = true;
                StateHasChanged();
            }
        }
        *@


        private void CloseModalforHyperLinkTitle()
        {
            iscompanyDetailsModalVisible = false;
            StateHasChanged(); // Ensure UI is updated
        }


        private int _currentViewingApplicationId = 0;
        private string _currentViewingApplicationType = string.Empty; // Stores "Job", "Internship", or "Thesis"
        private async Task ShowStudentDetailsInNameAsHyperlink(string studentUniqueId, int applicationId, string applicationType)
        {
            // 1. Store context for the Download button
            _currentViewingApplicationId = applicationId;
            _currentViewingApplicationType = applicationType;

            // 2. STATISTICS: Update "Seen" flag based on Type
            try
            {
                if (applicationType == "Job")
                {
                    var record = await dbContext.CompanyJobsApplied.FirstOrDefaultAsync(x => x.Id == applicationId);
                    if (record != null && !record.CompanyJobApplied_CandidateInfoSeenFromModal)
                    {
                        record.CompanyJobApplied_CandidateInfoSeenFromModal = true;
                        await dbContext.SaveChangesAsync();
                    }
                }
                else if (applicationType == "Internship")
                {
                    // Assuming your table is CompanyInternshipApplied
                    var record = await dbContext.InternshipsApplied.FirstOrDefaultAsync(x => x.Id == applicationId);
                    if (record != null && !record.CompanyInternshipApplied_CandidateInfoSeenFromModal)
                    {
                        record.CompanyInternshipApplied_CandidateInfoSeenFromModal = true;
                        await dbContext.SaveChangesAsync();
                    }
                }
                else if (applicationType == "Thesis")
                {
                    // Assuming your table is CompanyThesisApplied
                    var record = await dbContext.CompanyThesesApplied.FirstOrDefaultAsync(x => x.Id == applicationId);
                    if (record != null && !record.CompanyThesisApplied_CandidateInfoSeenFromModal)
                    {
                        record.CompanyThesisApplied_CandidateInfoSeenFromModal = true;
                        await dbContext.SaveChangesAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating Seen Stats: {ex.Message}");
            }

            // --- EXISTING LOGIC ---

            // First try to find in cache
            selectedStudentFromCache = studentDataCache.Values
                .FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

            if (selectedStudentFromCache == null)
            {
                Console.WriteLine($"Student with ID {studentUniqueId} not found in cache - loading from DB");
                
                selectedStudentFromCache = await dbContext.Students
                    .Where(s => s.Student_UniqueID == studentUniqueId)
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords
                    })
                    .FirstOrDefaultAsync();

                if (selectedStudentFromCache != null)
                {
                    studentDataCache[selectedStudentFromCache.Email.ToLower()] = selectedStudentFromCache;
                }
            }

            isModalVisibleToShowStudentDetailsAsCompanyFromTheirHyperlinkNameInCompanyInternships = true;
            StateHasChanged();
        }


        private int _currentViewingProfessorInternshipApplicationId = 0;
        private async Task ShowStudentDetailsInNameAsHyperlink_StudentAppliedinternshipsAtProfessor(string studentUniqueId, int applicationId)
        {
            // 1. Store ID for the download button
            _currentViewingProfessorInternshipApplicationId = applicationId;

            // 2. STATISTICS: Update "Seen" flag
            try
            {
                var record = await dbContext.ProfessorInternshipsApplied // Ensure this matches your DB Set name
                    .FirstOrDefaultAsync(x => x.Id == applicationId);

                if (record != null && !record.ProfessorInternshipApplied_CandidateInfoSeenFromModal)
                {
                    record.ProfessorInternshipApplied_CandidateInfoSeenFromModal = true;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating Professor Internship Stats: {ex.Message}");
            }

            // --- EXISTING LOGIC ---
            try
            {
                // First try to find in cache
                selectedStudent = studentDataCache.Values
                    .FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

                if (selectedStudent == null)
                {
                    Console.WriteLine($"Student with ID {studentUniqueId} not found in cache - loading from DB");
                
                    selectedStudent = await dbContext.Students
                        .Where(s => s.Student_UniqueID == studentUniqueId)
                        .Select(s => new Student {
                            Id = s.Id,
                            Student_UniqueID = s.Student_UniqueID,
                            Email = s.Email,
                            Image = s.Image,
                            Name = s.Name,
                            Surname = s.Surname,
                            Telephone = s.Telephone,
                            PermanentAddress = s.PermanentAddress,
                            PermanentRegion = s.PermanentRegion,
                            PermanentTown = s.PermanentTown,
                            Attachment = s.Attachment,
                            LinkedInProfile = s.LinkedInProfile,
                            PersonalWebsite = s.PersonalWebsite,
                            Transport = s.Transport,
                            RegNumber = s.RegNumber,
                            University = s.University,
                            Department = s.Department,
                            EnrollmentDate = s.EnrollmentDate,
                            StudyYear = s.StudyYear,
                            LevelOfDegree = s.LevelOfDegree,
                            AreasOfExpertise = s.AreasOfExpertise,
                            Keywords = s.Keywords,
                            ExpectedGraduationDate = s.ExpectedGraduationDate,
                            CompletedECTS = s.CompletedECTS,
                            InternshipStatus = s.InternshipStatus,
                            ThesisStatus = s.ThesisStatus,
                            PreferedRegions = s.PreferedRegions,
                            PreferredTowns = s.PreferredTowns
                        })
                        .AsNoTracking()
                        .FirstOrDefaultAsync();

                    if (selectedStudent != null)
                    {
                        // Add to cache if found
                        studentDataCache[selectedStudent.Email.ToLower()] = selectedStudent;
                    }
                }

                isModalVisibleToShowStudentDetailsAsProfessorFromTheirHyperlinkNameInProfessorInternships = true;
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading student details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την φόρτωση των στοιχείων του φοιτητή");
            }
        }


        private async Task DownloadStudentCVForProfessorInternships(string studentEmail)
        {
            try
            {
                // First try to find in cache
                var student = studentDataCache.Values.FirstOrDefault(s => s.Email == studentEmail);
        
                // If not in cache, try database
                if (student == null)
                {
                    student = await dbContext.Students
                        .FirstOrDefaultAsync(s => s.Email == studentEmail);
                }

                if (student?.Attachment == null)
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε βιογραφικό για αυτόν τον φοιτητή");
                    return;
                }

                var fileName = $"CV_{student.Name}_{student.Surname}.pdf";
                var mimeType = "application/pdf";
            
                // Download File
                await JS.InvokeVoidAsync("downloadFile", fileName, mimeType, Convert.ToBase64String(student.Attachment));

                // STATISTICS: Update "Downloaded" flag
                if (_currentViewingProfessorInternshipApplicationId > 0)
                {
                    var record = await dbContext.ProfessorInternshipsApplied
                        .FirstOrDefaultAsync(x => x.Id == _currentViewingProfessorInternshipApplicationId);

                    if (record != null && !record.ProfessorInternshipApplied_CandidateCVDownloaded)
                    {
                        record.ProfessorInternshipApplied_CandidateCVDownloaded = true;
                        await dbContext.SaveChangesAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error downloading CV: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά τη λήψη του βιογραφικού");
            }
        }

        private void CloseModalforHyperLinkTitleStudentName()
        {
            isModalVisibleToShowStudentDetailsAsCompanyFromTheirHyperlinkNameInCompanyInternships = false;
            selectedStudentFromCache = null;
            StateHasChanged();
        }
        private void CloseModalforHyperLinkTitleStudentName_StudentAppliedinternshipsAtProfessor()
        {
            isModalVisibleToShowStudentDetailsAsProfessorFromTheirHyperlinkNameInProfessorInternships = false;
            JS.InvokeVoidAsync("eval", "$('#studentDetailsModal').modal('hide')");
        }

        private bool showLoadingModalWhenWithdrawInternshipApplication = false;
        private int loadingProgressWhenWithdrawInternshipApplication = 0;
        private async Task WithdrawInternshipApplicationMadeByStudent(InternshipApplied application)
        {
            try
            {
                // First ask for confirmation
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να αποσύρετε την Αίτησή σας για την Πρακτική Άσκηση. Είστε σίγουρος/η;");
                if (!confirmed) return;

                // Show loading modal after user confirms
                showLoadingModalWhenWithdrawInternshipApplication = true;
                loadingProgressWhenWithdrawInternshipApplication = 0;
                StateHasChanged();

                // Step 1: Get the related internship details
                await UpdateProgressWhenWithdrawInternshipApplication(10, 200);
            
                var internship = await dbContext.CompanyInternships
                    .Include(i => i.Company) // Include company data
                    .FirstOrDefaultAsync(i => i.RNGForInternshipUploadedAsCompany == application.RNGForInternshipApplied);

                if (internship == null)
                {
                    showLoadingModalWhenWithdrawInternshipApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε η πρακτική άσκηση.");
                    return;
                }

                // Step 2: Update status
                await UpdateProgressWhenWithdrawInternshipApplication(30, 200);
            
                application.InternshipStatusAppliedAtTheCompanySide = "Αποσύρθηκε από τον φοιτητή";
                application.InternshipStatusAppliedAtTheStudentSide = "Αποσύρθηκε από τον φοιτητή";

                // Step 3: Add platform action
                await UpdateProgressWhenWithdrawInternshipApplication(50, 200);
            
                var platformAction = new PlatformActions
                {
                    UserRole_PerformedAction = "STUDENT",
                    ForWhat_PerformedAction = "COMPANY_INTERNSHIP",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(application.RNGForInternshipApplied),
                    TypeOfAction_PerformedAction = "SELFWITHDRAW",
                    DateTime_PerformedAction = DateTime.Now
                };

                dbContext.PlatformActions.Add(platformAction);
                await dbContext.SaveChangesAsync();
            
                await UpdateProgressWhenWithdrawInternshipApplication(70, 200);

                // Step 4: Get student details
                await UpdateProgressWhenWithdrawInternshipApplication(80, 200);
            
                var student = await GetStudentDetails(application.StudentEmailAppliedForInternship);

                if (student == null)
                {
                    showLoadingModalWhenWithdrawInternshipApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 5: Send notifications
                await UpdateProgressWhenWithdrawInternshipApplication(90, 200);
            
                await InternshipEmailService.SendInternshipWithdrawalNotificationToCompany_AsStudent(
                    application.CompanyEmailWhereStudentAppliedForInternship,
                    internship.Company?.CompanyName,
                    student.Name,
                    student.Surname,
                    internship.CompanyInternshipTitle,
                    application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID);

                await InternshipEmailService.SendInternshipWithdrawalConfirmationToStudent_AsCompany(
                    application.StudentEmailAppliedForInternship,
                    student.Name,
                    student.Surname,
                    internship.CompanyInternshipTitle,
                    application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                    internship.Company?.CompanyName);

                await UpdateProgressWhenWithdrawInternshipApplication(100, 200);
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Hide loading modal before navigation
                showLoadingModalWhenWithdrawInternshipApplication = false;
                StateHasChanged();

                // AFTER user clicks OK, show the navigation loader
                await Task.Delay(100); // Small delay for smooth transition
            
                // Show the navigation loader
                await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                // Give time for loader to render
                await Task.Delay(300);
            
                // Step 6: Refresh the page
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenWithdrawInternshipApplication = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving withdrawal: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την αποθήκευση της απόσυρσης.");
            }
        }

        // Helper method for company internship withdrawal
        private async Task UpdateProgressWhenWithdrawInternshipApplication(int current, int total)
        {
            loadingProgressWhenWithdrawInternshipApplication = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50);
        }

        private bool showLoadingModalWhenWithdrawProfessorInternshipApplication = false;
        private int loadingProgressWhenWithdrawProfessorInternshipApplication = 0;
        private async Task WithdrawProfessorInternshipApplicationMadeByStudent(ProfessorInternshipApplied application)
        {
            try
            {
                // First ask for confirmation
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να αποσύρετε την Αίτησή σας για την Πρακτική Άσκηση. Είστε σίγουρος/η;");
                if (!confirmed) return;

                // Show loading modal after user confirms
                showLoadingModalWhenWithdrawProfessorInternshipApplication = true;
                loadingProgressWhenWithdrawProfessorInternshipApplication = 0;
                StateHasChanged();

                // Step 1: Get the related internship details
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(10, 200);
            
                var internship = await dbContext.ProfessorInternships
                    .Include(i => i.Professor)
                    .FirstOrDefaultAsync(i => i.RNGForInternshipUploadedAsProfessor == application.RNGForProfessorInternshipApplied);

                if (internship == null)
                {
                    showLoadingModalWhenWithdrawProfessorInternshipApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε η πρακτική άσκηση.");
                    return;
                }

                // Step 2: Update status
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(30, 200);
            
                application.InternshipStatusAppliedAtTheProfessorSide = "Αποσύρθηκε από τον φοιτητή";
                application.InternshipStatusAppliedAtTheStudentSide = "Αποσύρθηκε από τον φοιτητή";

                // Step 3: Add platform action
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(50, 200);
            
                var platformAction = new PlatformActions
                {
                    UserRole_PerformedAction = "STUDENT",
                    ForWhat_PerformedAction = "PROFESSOR_INTERNSHIP",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(application.RNGForProfessorInternshipApplied),
                    TypeOfAction_PerformedAction = "SELFWITHDRAW",
                    DateTime_PerformedAction = DateTime.Now
                };

                dbContext.PlatformActions.Add(platformAction);
                await dbContext.SaveChangesAsync();
            
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(70, 200);

                // Step 4: Get student details
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(80, 200);
            
                var student = await GetStudentDetails(application.StudentDetails.StudentEmailAppliedForProfessorInternship);

                if (student == null)
                {
                    showLoadingModalWhenWithdrawProfessorInternshipApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 5: Send notifications
                await UpdateProgressWhenWithdrawProfessorInternshipApplication(90, 200);
            
                await InternshipEmailService.SendProfessorInternshipWithdrawalNotificationToProfessor(
                    application.ProfessorDetails.ProfessorEmailWhereStudentAppliedForProfessorInternship,
                    $"{internship.Professor.ProfName} {internship.Professor.ProfSurname}",
                    student.Name,
                    student.Surname,
                    internship.ProfessorInternshipTitle,
                    application.RNGForProfessorInternshipApplied_HashedAsUniqueID);

                await InternshipEmailService.SendProfessorInternshipWithdrawalConfirmationToStudent(
                    application.StudentDetails.StudentEmailAppliedForProfessorInternship,
                    student.Name,
                    student.Surname,
                    internship.ProfessorInternshipTitle,
                    application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                    $"{internship.Professor.ProfName} {internship.Professor.ProfSurname}");

                await UpdateProgressWhenWithdrawProfessorInternshipApplication(100, 200);
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Hide loading modal before navigation
                showLoadingModalWhenWithdrawProfessorInternshipApplication = false;
                StateHasChanged();

                // AFTER user clicks OK, show the navigation loader
                await Task.Delay(100); // Small delay for smooth transition
            
                // Show the navigation loader
                await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                // Give time for loader to render
                await Task.Delay(300);
            
                // Step 6: Refresh the page
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenWithdrawProfessorInternshipApplication = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving withdrawal: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την αποθήκευση της απόσυρσης.");
            }
        }

        // Helper method for professor internship withdrawal
        private async Task UpdateProgressWhenWithdrawProfessorInternshipApplication(int current, int total)
        {
            loadingProgressWhenWithdrawProfessorInternshipApplication = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50);
        }

        private bool showLoadingModalWhenWithdrawJobApplication = false;
        private int loadingProgressWhenWithdrawJobApplication = 0;
        private async Task WithdrawJobApplicationMadeByStudent(CompanyJobApplied application)
        {
            try
            {
                // First ask for confirmation
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να αποσύρετε την Αίτησή σας για την Θέση Εργασίας. Είστε σίγουρος/η;");
                if (!confirmed) return;

                // Show loading modal after user confirms
                showLoadingModalWhenWithdrawJobApplication = true;
                loadingProgressWhenWithdrawJobApplication = 0;
                StateHasChanged();

                // Step 1: Get the related job details
                await UpdateProgressWhenWithdrawJobApplication(10, 200);
            
                var job = await dbContext.CompanyJobs
                    .Include(j => j.Company) // Include company for email
                    .FirstOrDefaultAsync(j => j.RNGForPositionUploaded == application.RNGForCompanyJobApplied);

                if (job == null)
                {
                    showLoadingModalWhenWithdrawJobApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε η θέση εργασίας.");
                    return;
                }

                // Step 2: Update status
                await UpdateProgressWhenWithdrawJobApplication(30, 200);
            
                application.CompanyPositionStatusAppliedAtTheCompanySide = "Αποσύρθηκε από τον φοιτητή";
                application.CompanyPositionStatusAppliedAtTheStudentSide = "Αποσύρθηκε από τον φοιτητή";

                // Step 3: Add platform action
                await UpdateProgressWhenWithdrawJobApplication(50, 200);
            
                var platformAction = new PlatformActions
                {
                    UserRole_PerformedAction = "STUDENT",
                    ForWhat_PerformedAction = "COMPANY_JOB",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(application.RNGForCompanyJobApplied),
                    TypeOfAction_PerformedAction = "SELFWITHDRAW",
                    DateTime_PerformedAction = DateTime.Now
                };

                dbContext.PlatformActions.Add(platformAction);
                await dbContext.SaveChangesAsync();
            
                await UpdateProgressWhenWithdrawJobApplication(70, 200);

                // Step 4: Get student details
                await UpdateProgressWhenWithdrawJobApplication(80, 200);
            
                var student = await GetStudentDetails(application.StudentEmailAppliedForCompanyJob);

                if (student == null)
                {
                    showLoadingModalWhenWithdrawJobApplication = false;
                    StateHasChanged();
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return;
                }

                // Step 5: Send notifications
                await UpdateProgressWhenWithdrawJobApplication(90, 200);
            
                await InternshipEmailService.SendJobWithdrawalNotificationToCompany_AsStudent(
                    application.CompanysEmailWhereStudentAppliedForCompanyJob,
                    job.Company?.CompanyName,
                    student.Name,
                    student.Surname,
                    job.PositionTitle,
                    application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID);

                await InternshipEmailService.SendJobWithdrawalConfirmationToStudent_AsCompany(
                    application.StudentEmailAppliedForCompanyJob,
                    student.Name,
                    student.Surname,
                    job.PositionTitle,
                    application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                    job.Company?.CompanyName);

                await UpdateProgressWhenWithdrawJobApplication(100, 200);
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Hide loading modal before navigation
                showLoadingModalWhenWithdrawJobApplication = false;
                StateHasChanged();

                // AFTER user clicks OK, show the navigation loader
                await Task.Delay(100); // Small delay for smooth transition
            
                // Show the navigation loader
                await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                // Give time for loader to render
                await Task.Delay(300);
            
                // Step 6: Refresh the page
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenWithdrawJobApplication = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving withdrawal: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την αποθήκευση της απόσυρσης.");
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenWithdrawJobApplication(int current, int total)
        {
            loadingProgressWhenWithdrawJobApplication = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }

        private async Task WithdrawCompanyThesisApplicationMadeByStudent(CompanyThesisApplied companythesis)
        {
            companythesis.CompanyThesisStatusAppliedAtStudentSide = "Αποσύρθηκε από τον φοιτητή";
            companythesis.CompanyThesisStatusAppliedAtCompanySide = "Αποσύρθηκε από τον φοιτητή"; 
            await dbContext.SaveChangesAsync();
        }

        private async Task WithdrawProfessorThesisApplicationMadeByStudent(ProfessorThesisApplied professorthesis)
        {
            professorthesis.ProfessorThesisStatusAppliedAtStudentSide = "Αποσύρθηκε από τον φοιτητή";
            professorthesis.ProfessorThesisStatusAppliedAtProfessorSide = "Αποσύρθηκε από τον φοιτητή"; 
            await dbContext.SaveChangesAsync();

        }

        private async Task DownloadStudentCVFromCompanyInternships(string studentEmail)
        {
            try
            {
                // First try to find in cache
                var student = studentDataCache.Values.FirstOrDefault(s => s.Email == studentEmail);
            
                // If not in cache, try database
                if (student == null)
                {
                    student = await dbContext.Students
                        .FirstOrDefaultAsync(s => s.Email == studentEmail);
                }

                if (student?.Attachment == null)
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε βιογραφικό για αυτόν τον φοιτητή");
                    return;
                }

                var fileName = $"CV_{student.Name}_{student.Surname}.pdf";
                var mimeType = "application/pdf";
                
                // Download File
                await JS.InvokeVoidAsync("downloadFile", fileName, mimeType, Convert.ToBase64String(student.Attachment));

                // --- NEW STATISTICS LOGIC ---
                // Update "Downloaded" flag based on captured Type and ID
                if (_currentViewingApplicationId > 0 && !string.IsNullOrEmpty(_currentViewingApplicationType))
                {
                    if (_currentViewingApplicationType == "Job")
                    {
                        var record = await dbContext.CompanyJobsApplied.FirstOrDefaultAsync(x => x.Id == _currentViewingApplicationId);
                        if (record != null && !record.CompanyJobApplied_CandidateCVDownloaded)
                        {
                            record.CompanyJobApplied_CandidateCVDownloaded = true;
                            await dbContext.SaveChangesAsync();
                        }
                    }
                    else if (_currentViewingApplicationType == "Internship")
                    {
                        var record = await dbContext.InternshipsApplied.FirstOrDefaultAsync(x => x.Id == _currentViewingApplicationId);
                        if (record != null && !record.CompanyInternshipApplied_CandidateCVDownloaded)
                        {
                            record.CompanyInternshipApplied_CandidateCVDownloaded = true;
                            await dbContext.SaveChangesAsync();
                        }
                    }
                    else if (_currentViewingApplicationType == "Thesis")
                    {
                        var record = await dbContext.CompanyThesesApplied.FirstOrDefaultAsync(x => x.Id == _currentViewingApplicationId);
                        if (record != null && !record.CompanyThesisApplied_CandidateCVDownloaded)
                        {
                            record.CompanyThesisApplied_CandidateCVDownloaded = true;
                            await dbContext.SaveChangesAsync();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error downloading CV: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά τη λήψη του βιογραφικού");
            }
        }

        private async Task ShowCompanyDetailsAsAHyperlinkInInternshipSearchAsStudent(string companyId)
        {
            // Fetch the company details based on the Company Name (ENG)
            selectedCompany = await dbContext.Companies.FirstOrDefaultAsync(c => c.CompanyName == companyId);

            if (selectedCompany != null)
            {
                isCompanyDetailsModal2Visible = true;
                await JS.InvokeVoidAsync("eval", "$('#companyDetailsModal2').modal('show')");
            }
        }

        private async Task CloseModalforHyperLinkTitleInSearch()
        {
            // Close the modal and set the flag to false
            isCompanyDetailsModal2Visible = false;
            await JS.InvokeVoidAsync("eval", "$('#companyDetailsModal2').modal('hide')");
        }

        private async Task ShowCompanyDetailsAsAHyperlinkInJobSearchAsStudent(string companyName)
        {
            // Fetch company details from database
            selectedCompanyDetailsForJobSearch = await dbContext.Companies
                .FirstOrDefaultAsync(c => c.CompanyName == companyName);

            if (selectedCompanyDetailsForJobSearch != null)
            {
                isCompanyDetailsModalOpenForJobSearch = true;
                StateHasChanged();  // Refresh UI
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Company details not found.");
            }
        }

        private void CloseModalForCompanyNameHyperlinkDetailsInJobSearch()
        {
            isCompanyDetailsModalOpenForJobSearch = false;
        }



        private async Task ShowCompanyDetailsAsAHyperlinkInShowJobsAsStudent(string companyEmail)
        {
            try
            {
                // First try to find in job cache
                var cachedCompany = jobDataCache.Values
                    .FirstOrDefault(j => j.EmailUsedToUploadJobs.Equals(companyEmail, StringComparison.OrdinalIgnoreCase));
            
                if (cachedCompany != null)
                {
                    selectedCompanyDetailsForJobShow = await dbContext.Companies
                        .FirstOrDefaultAsync(c => c.CompanyEmail == cachedCompany.EmailUsedToUploadJobs);
                }
                else
                {
                    // Fallback to direct lookup
                    selectedCompanyDetailsForJobShow = await dbContext.Companies
                        .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);
                }

                isCompanyDetailsModalOpenForJobShow = selectedCompanyDetailsForJobShow != null;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error showing company details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα φόρτωσης στοιχείων εταιρείας");
            }
        }

        private void CloseModalForCompanyNameHyperlinkDetailsInJobShow()
        {
            isCompanyDetailsModalOpenForJobShow = false;
        }



        private async Task ShowInternshipDetailsInInternshipTitleAsHyperlink(long internshipId)
        {
            currentInternship = await dbContext.CompanyInternships
                .Include(i => i.Company) // Include company data
                .FirstOrDefaultAsync(i => i.RNGForInternshipUploadedAsCompany == internshipId); // Updated property name

            if (currentInternship != null)
            {
                isInternshipDetailsModalVisible = true;
                StateHasChanged();
            }
        }

        private async Task CloseInternshipDetailsModal()
        {
            // Set the flag to hide the modal
            isInternshipDetailsModalVisible = false;
            StateHasChanged();
        }

        private async Task ShowProfessorInternshipDetailsInInternshipTitleAsHyperlink_StudentInternshipApplicationsShow(long internshipId)
        {
            // Fetch the internship details from the database with professor information
            currentProfessorInternship = await dbContext.ProfessorInternships
                .Include(i => i.Professor) // Include professor data
                .FirstOrDefaultAsync(i => i.RNGForInternshipUploadedAsProfessor == internshipId); // Updated property name

            if (currentProfessorInternship != null)
            {
                // Set the flag to show the modal
                isInternshipDetailsModalVisible_StudentInternshipApplicationsShow = true;

                // Trigger modal visibility change via JavaScript
                await JS.InvokeVoidAsync("eval", 
                    $"$('#internshipDetailsModal').modal('{(isInternshipDetailsModalVisible_StudentInternshipApplicationsShow ? "show" : "hide")}')");
            }
        }

        private async Task CloseProfessorInternshipDetailsModal_StudentInternshipApplicationsShow()
        {
            // Set the flag to hide the modal
            isInternshipDetailsModalVisible_StudentInternshipApplicationsShow = false;
            StateHasChanged();
        }

        private async Task ShowJobDetailsInJobTitleAsHyperlink_StudentJobApplications(long jobId)
        {
            // Fetch the job details from the database with Company included
            currentJobApplicationMadeAsStudent = await dbContext.CompanyJobs
                .Include(j => j.Company) // Include the Company data
                .FirstOrDefaultAsync(i => i.RNGForPositionUploaded == jobId);

            if (currentJobApplicationMadeAsStudent != null)
            {
                isJobDetailsModalVisibleToSeeJobApplicationsAsStudent = true;
                StateHasChanged(); // Update UI
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Job details not found.");
            }
        }

        private void CloseJobDetailsModalInJobTitleAsHyperlink_StudentJobApplications()
        {
            isJobDetailsModalVisibleToSeeJobApplicationsAsStudent = false;
            StateHasChanged();
        }



        private async Task CloseJobDetailsModal()
        {
            isJobDetailsModal2Visible = false;
            await  JS.InvokeVoidAsync("eval", "$('#jobDetailsModal2').modal('hide')");
        }

        private async Task DownloadInternshipAttachmentAsStudent(long internshipId)
        {
            var internship = dbContext.CompanyInternships.FirstOrDefault(i => i.Id == internshipId);
            if (internship == null)
            {
                Console.WriteLine("Internship not found.");
                return;
            }

            if (internship.CompanyInternshipAttachment == null)
            {
                Console.WriteLine("No attachment found.");
                return;
            }

            Console.WriteLine($"Attachment found for internship {internshipId}, size: {internship.CompanyInternshipAttachment.Length} bytes");

            // Convert byte[] to base64
            string base64String = Convert.ToBase64String(internship.CompanyInternshipAttachment);
            string fileName = $"Internship_Attachment_{internshipId}.pdf"; // Adjust file extension if needed

            // Invoke JS to download file
            await JS.InvokeVoidAsync("downloadInternshipAttachmentAsStudent", fileName, base64String);
        }

        private async Task HandleSaveClickToSaveInternshipsAsCompany()
        {
            // Call JavaScript function for confirmation with custom HTML and styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] {
                "Είστε σίγουροι πως θέλετε να υποβάλλετε Νέα Θέση Πρακτικής Άσκησης; Η Θέση θα καταχωρηθεί ως 'Μη Δημοσιευμένη' στο Ιστορικό Θέσεων Πρακτικής Άσκησης. " +
                "Αν επιθυμείτε να την Δημοσιεύσετε απαιτούνται επιπλέον ενέργειες! <br>" +
                "<strong style='color: red;'>Παρακαλώ επιβεβαιώστε την ενέργειά σας.</strong>"
        });

            if (isConfirmed)
            {
                // Proceed with the form submission
                await UploadInternshipAsCompany();
            }
        }



        private async Task ChangeInternshipStatusToUnpublished(int internshipId)
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Προχωράτε στην <strong style='color: red;'>Αποδημοσίευση</strong> της Θέσης.<br><br>" + 
                "<strong style='color: red;'>ΔΕΝ θα είναι ορατή σε νέους υποψηφίους</strong>.<br><br>" + 
                "Η κατάσταση των αιτήσεων παλαιότερων υποψηφίων θα παραμείνει ως έχει.<br><br>" + 
                "Θέλετε σίγουρα να συνεχίσετε;");

            if (isConfirmed)
            {
                // Proceed with status update to "Μη Δημοσιευμένη"
                await UpdateInternshipStatusAsCompany(internshipId, "Μη Δημοσιευμένη");
            }
        }



        private async Task ChangeProfessorInternshipStatusToUnpublished(int internshipId)
        {
            // Show confirmation dialog
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Προχωράτε στην Αποδημοσίευση της Θέσης. Η Θέση μετά από αυτήν την ενέργεια ΔΕΝ θα είναι ορατή σε νέους υποψηφίους. Η κατάσταση των αιτήσεων παλαιότερων υποψηφίων θα παραμείνει ως έχει. Θέλετε σίγουρα να συνεχίσετε ;");

            if (isConfirmed)
            {
                // Proceed with status update
                await UpdateInternshipStatusAsProfessor(internshipId, "Μη Δημοσιευμένη");
            }
        }

        private async Task ChangeJobStatusToUnpublished(int jobId)
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Προχωράτε στην <strong style='color: red;'>Αποδημοσίευση</strong> της Θέσης.<br><br>" + 
                "<strong style='color: red;'>ΔΕΝ θα είναι ορατή σε νέους υποψηφίους</strong>.<br><br>" + 
                "Η κατάσταση των αιτήσεων παλαιότερων υποψηφίων θα παραμείνει ως έχει.<br><br>" + 
                "Θέλετε σίγουρα να συνεχίσετε;");

            if (isConfirmed)
            {
                // Proceed with status update
                await UpdateJobStatusAsCompany(jobId, "Μη Δημοσιευμένη");
            }
        }



        private async Task ChangeCompanyThesisStatusToUnpublished(int companyThesisId)
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Προχωράτε στην <strong style='color: red;'>Αποδημοσίευση</strong> της Διπλωματικής Εργασίας.<br><br>" + 
                "<strong style='color: red;'>ΔΕΝ θα είναι ορατή σε νέους υποψηφίους</strong>.<br><br>" + 
                "Η κατάσταση των αιτήσεων παλαιότερων υποψηφίων θα παραμείνει ως έχει.<br><br>" + 
                "Θέλετε σίγουρα να συνεχίσετε;");

            if (isConfirmed)
            {
                // Proceed with status update
                await UpdateThesisStatusAsCompany(companyThesisId, "Μη Δημοσιευμένη");
            }
        }


        private async Task HandlePublishClickToSaveInternshipsAsCompany()
        {
            // Call JavaScript function for confirmation with custom HTML and styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] {
                "Είστε σίγουροι πως θέλετε να υποβάλλετε Νέα Θέση Πρακτικής Άσκησης; Η Θέση θα καταχωρηθεί ως 'Δημοσιευμένη' στο Ιστορικό Θέσεων Πρακτικής Άσκησης. " +
                "Αν επιθυμείτε να την Αποδημοσιεύσετε απαιτούνται επιπλέον ενέργειες! <br>" +
                "<strong style='color: red;'>Παρακαλώ επιβεβαιώστε την ενέργειά σας.</strong>"
        });

            if (isConfirmed)
            {
                // Set status to Δημοσιευμένη
                companyInternship.CompanyUploadedInternshipStatus = "Δημοσιευμένη";

                // Proceed with the form submission
                await UploadInternshipAsCompany();
            }
        }



        private void UpdateTownsForSelectedRegion(ChangeEventArgs e)
        {
            selectedRegion = e.Value?.ToString();
            if (!string.IsNullOrEmpty(selectedRegion) && RegionToTownsMap.ContainsKey(selectedRegion))
            {
                availableTowns = RegionToTownsMap[selectedRegion];
            }
            else
            {
                availableTowns = null; // Clear the town selection if no region is selected
            }
        }

        private void OnTownChangeForInternships(ChangeEventArgs e)
        {
            selectedInternship.CompanyInternshipDimosLocation = e.Value?.ToString();
        }

        /*
        private void LogJobLoadingInfo()
        {
            var message = $"Loaded jobs for company: {companyName} \n" +
                        $"Total Jobs: {totalCountJobs} \n" +
                        $"Published Jobs: {publishedCountJobs} \n" +
                        $"Unpublished Jobs: {unpublishedCountJobs} \n" +
                        $"Withdrawn Jobs: {withdrawnCountJobs}";

            Console.WriteLine(message); // This writes to the console
        }
        */

        private async Task HandleTemporarySaveJobAsCompany()
        {
            // Call JavaScript function for confirmation with HTML content and custom styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε Νέα Θέση Εργασίας; Η Θέση θα καταχωρηθεί ως 'Μη Δημοσιευμένη' στο Ιστορικό Θέσεων Εργασίας. <br>" +
                "<strong style='color: red;'>Αν επιθυμείτε να την Δημοσιεύσετε απαιτούνται επιπλέον ενέργειες!</strong>"
        });

            if (isConfirmed)
            {
                // Proceed with the temporary save
                await UploadJobAsCompany(false);
            }
            StateHasChanged();
        }

        // ============================================================================
        // COMPANY ROLE - JOB PUBLICATION
        // ============================================================================
        private async Task HandlePublishSaveJobAsCompany()
        {
            // Call JavaScript function for confirmation with HTML content and custom styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε Νέα Θέση Εργασίας; Η Θέση θα καταχωρηθεί ως 'Δημοσιευμένη' στο Ιστορικό Θέσεων Εργασίας. <br>" +
                "<strong style='color: red;'>Αν επιθυμείτε να την Αποδημοσιεύσετε απαιτούνται επιπλέον ενέργειες!</strong>"
        });

            if (isConfirmed)
            {
                // Proceed with publishing the job
                await UploadJobAsCompany(true);
            }
            StateHasChanged();
        }


        // ============================================================================
        // COMPANY ROLE - THESIS MANAGEMENT METHODS
        // ============================================================================
        // Methods for creating, saving, and managing company thesis positions
        private async Task HandleTemporarySaveThesisAsCompany()
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Είστε σίγουροι πως θέλετε να <strong style='color: blue;'>Υποβάλετε</strong> Νέα Διπλωματική Εργασία;<br><br>" +
                "Η Εργασία θα καταχωρηθεί ως <strong style='color: red;'>'Μη Δημοσιευμένη'</strong> στο Ιστορικό Θέσεων Διπλωματικών Εργασιών.<br><br>" +
                "Αν επιθυμείτε να την Δημοσιεύσετε απαιτούνται επιπλέον ενέργειες!<br><br>" +
                "Θέλετε να συνεχίσετε;");

            if (isConfirmed)
            {
                // Proceed with the temporary save
                await UploadThesisAsCompany(false);
            }
            StateHasChanged();
        }

        private async Task HandlePublishSaveThesisAsCompany()
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Είστε σίγουροι πως θέλετε να <strong style='color: green;'>Υποβάλετε</strong> Νέα Διπλωματική Εργασία;<br><br>" +
                "Η Εργασία θα καταχωρηθεί ως <strong style='color: green;'>'Δημοσιευμένη'</strong> στο Ιστορικό Θέσεων Διπλωματικών Εργασιών.<br><br>" +
                "Αν επιθυμείτε να την <strong style='color: red;'>Αποδημοσιεύσετε</strong> απαιτούνται επιπλέον ενέργειες!<br><br>" +
                "Θέλετε να συνεχίσετε;");

            if (isConfirmed)
            {
                // Proceed with publishing the thesis
                await UploadThesisAsCompany(true);
            }
            StateHasChanged();
        }



        // ============================================================================
        // COMPANY ROLE - ANNOUNCEMENT MANAGEMENT METHODS
        // ============================================================================
        // Methods for creating, saving, and managing company announcements
        private async Task SaveAnnouncementAsPublished()
        {
            // Validate mandatory fields
            isFormValidToSaveAnnouncementAsCompany = ValidateMandatoryFieldsForUploadAnnouncementAsCompany();

            if (!isFormValidToSaveAnnouncementAsCompany)
                return;

            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{announcement.CompanyAnnouncementTitle}</strong> ως '<strong>Δημοσιευμένη</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
            });

            if (!isConfirmed)
                return;

            announcement.CompanyAnnouncementStatus = "Δημοσιευμένη";
            announcement.CompanyAnnouncementUploadDate = DateTime.Now;
            announcement.CompanyAnnouncementCompanyEmail = CurrentUserEmail;
            announcement.CompanyAnnouncementRNG = new Random().NextInt64();
            announcement.CompanyAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(announcement.CompanyAnnouncementRNG ?? 0);
            await SaveAnnouncementToDatabase();
        }

        private async Task SaveAnnouncementAsUnpublished()
        {
            // Validate mandatory fields
            isFormValidToSaveAnnouncementAsCompany = ValidateMandatoryFieldsForUploadAnnouncementAsCompany();

            if (!isFormValidToSaveAnnouncementAsCompany)
                return;

            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{announcement.CompanyAnnouncementTitle}</strong> ως '<strong>Μη Δημοσιευμένη (Προσωρινή Αποθήκευση)</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
            });

            if (!isConfirmed)
                return;

            announcement.CompanyAnnouncementStatus = "Μη Δημοσιευμένη";
            announcement.CompanyAnnouncementUploadDate = DateTime.Now;
            announcement.CompanyAnnouncementCompanyEmail = CurrentUserEmail;
            announcement.CompanyAnnouncementRNG = new Random().NextInt64();
            announcement.CompanyAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(announcement.CompanyAnnouncementRNG ?? 0);
            await SaveAnnouncementToDatabase();
        }



        // Method to validate mandatory fields
        private bool ValidateMandatoryFieldsForUploadAnnouncementAsCompany()
        {
            // Check if mandatory fields are filled, including date validation for today's date
            if (string.IsNullOrWhiteSpace(announcement.CompanyAnnouncementTitle) || 
                string.IsNullOrWhiteSpace(announcement.CompanyAnnouncementDescription) ||
                announcement.CompanyAnnouncementTimeToBeActive.Date == DateTime.Today) // Ensure date is not today's date
            {
                // Trigger error message and return false for form validity
                showErrorMessageforUploadingAnnouncementAsCompany = true;
                return false;
            }

            // No errors, form is valid
            showErrorMessageforUploadingAnnouncementAsCompany = false;
            return true;
        }


        private bool showLoadingModal = false;
        private int loadingProgress = 0;
        private readonly int totalSteps = 4; // Validation + Save + Reset + Navigation
        private async Task SaveAnnouncementToDatabase()
        {
            // Show loading modal and reset progress
            showLoadingModal = true;
            loadingProgress = 0;
            StateHasChanged();
        
            try
            {
                // Step 1: Validation checks
                await UpdateProgressWhenSaveAnnouncementAsCompany(25, 100); // 25% after validation
            
                if (string.IsNullOrWhiteSpace(announcement.CompanyAnnouncementTitle))
                {
                    await HandleValidationErrorWhenSaveAnnouncementAsCompany("announcementTitle");
                    return;
                }

                if (string.IsNullOrWhiteSpace(announcement.CompanyAnnouncementDescription))
                {
                    await HandleValidationErrorWhenSaveAnnouncementAsCompany("announcementDescription");
                    return;
                }

                if (announcement.CompanyAnnouncementTimeToBeActive.Date <= DateTime.Today)
                {
                    await HandleValidationErrorWhenSaveAnnouncementAsCompany("announcementActiveDate");
                    return;
                }

                // Step 2: Save to database
                dbContext.AnnouncementsAsCompany.Add(announcement);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveAnnouncementAsCompany(50, 200); // 50% after save

                // Step 3: Set success message and reset form
                isSaveAnnouncementAsCompanySuccessful = true;
                saveAnnouncementAsCompanyMessage = "Η Ανακοίνωση Δημιουργήθηκε Επιτυχώς";
                announcement = new AnnouncementAsCompany();
                await UpdateProgressWhenSaveAnnouncementAsCompany(75, 100); // 75% after reset

                // Step 4: Final update before navigation
                await UpdateProgressWhenSaveAnnouncementAsCompany(100, 200); // 100% complete
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Navigate
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModal = false;
            
                isSaveAnnouncementAsCompanySuccessful = false;
                saveAnnouncementAsCompanyMessage = "Κάποιο πρόβλημα παρουσιάστηκε με την Δημιουργία της Ανακοίνωσης! Ανανεώστε την σελίδα και προσπαθήστε ξανά";
                Console.WriteLine($"Error saving announcement: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task HandleValidationErrorWhenSaveAnnouncementAsCompany(string elementId)
        {
            showErrorMessageforUploadingAnnouncementAsCompany = true;
            showLoadingModal = false; // Hide modal on validation error
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
        }

        private async Task UpdateProgressWhenSaveAnnouncementAsCompany(int increment, int delayMs = 0)
        {
            loadingProgress = increment;
            StateHasChanged();
        
            if (delayMs > 0)
            {
                await Task.Delay(delayMs);
            }
        }



        public async Task DeleteExpiredAnnouncements()
        {
            var expiredAnnouncements = await dbContext.AnnouncementsAsCompany
                .Where(a => a.CompanyAnnouncementTimeToBeActive < DateTime.Now)
                .ToListAsync();

            dbContext.AnnouncementsAsCompany.RemoveRange(expiredAnnouncements);
            await dbContext.SaveChangesAsync();
        }

        private bool isLoadingUploadedAnnouncements = false;
        private async Task ToggleUploadedAnnouncementsVisibility()
        {
            isUploadedAnnouncementsVisible = !isUploadedAnnouncementsVisible;

            if (isUploadedAnnouncementsVisible)
            {
                isLoadingUploadedAnnouncements = true;
                StateHasChanged();
            
                try
                {
                    // Load announcements only when the section is visible
                    await LoadUploadedAnnouncementsAsync();
                }
                finally
                {
                    isLoadingUploadedAnnouncements = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingUploadedEvents = false;
        private async Task ToggleUploadedCompanyEventsVisibility()
        {
            isUploadedEventsVisible = !isUploadedEventsVisible;

            if (isUploadedEventsVisible)
            {
                isLoadingUploadedEvents = true;
                StateHasChanged();
            
                try
                {
                    // Load events only when the section is visible
                    await LoadUploadedEventsAsync();
                }
                finally
                {
                    isLoadingUploadedEvents = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingUploadedEventsAsProfessor = false;
        private async Task ToggleUploadedProfessorEventsVisibility()
        {
            isUploadedEventsVisibleAsProfessor = !isUploadedEventsVisibleAsProfessor;

            if (isUploadedEventsVisibleAsProfessor)
            {
                isLoadingUploadedEventsAsProfessor = true;
                StateHasChanged();
            
                try
                {
                    // Load events only when the section is visible
                    await LoadUploadedEventsAsyncAsProfessor();
                }
                finally
                {
                    isLoadingUploadedEventsAsProfessor = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private bool isLoadingUploadedAnnouncementsAsProfessor = false;
        private async Task ToggleUploadedAnnouncementsVisibilityAsProfessor()
        {
            isUploadedAnnouncementsVisibleAsProfessor = !isUploadedAnnouncementsVisibleAsProfessor;

            if (isUploadedAnnouncementsVisibleAsProfessor)
            {
                isLoadingUploadedAnnouncementsAsProfessor = true;
                StateHasChanged();
            
                try
                {
                    // Load announcements only when the section is visible
                    await LoadUploadedAnnouncementsAsProfessorAsync();
                }
                finally
                {
                    isLoadingUploadedAnnouncementsAsProfessor = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private async Task ToggleCompanySearchStudentVisible()
        {
            isCompanySearchStudentVisible = !isCompanySearchStudentVisible;
            StateHasChanged();
        }

        private async Task ToggleCompanySearchProfessorVisible()
        {
            isCompanySearchProfessorVisible = !isCompanySearchProfessorVisible;
            StateHasChanged();
        }

        private async Task ToggleCompanySearchResearchGroupVisible()
        {
            isCompanySearchResearchGroupVisible = !isCompanySearchResearchGroupVisible;
            StateHasChanged();
        }

        private async Task ToggleProfessorSearchResearchGroupVisible()
        {
            isProfessorSearchResearchGroupVisible = !isProfessorSearchResearchGroupVisible;
            StateHasChanged();
        }

        private async Task ToggleRGSearchProfessorVisible()
        {
            isRGSearchProfessorVisible = !isRGSearchProfessorVisible;
            StateHasChanged();
        }

        private bool isLoadingUploadedThesesAsProfessor = false;
        private async Task ToggleUploadedThesesVisibilityAsProfessor()
        {
            isUploadedThesesVisibleAsProfessor = !isUploadedThesesVisibleAsProfessor;

            if (isUploadedThesesVisibleAsProfessor)
            {
                isLoadingUploadedThesesAsProfessor = true;
                StateHasChanged();
        
                try
                {
                    // Load theses only when the section is visible
                    await LoadUploadedThesesAsProfessorAsync();
                    InitializeSlotDataForProfessorThesis(); // NEW: Initialize slot data
                }
                finally
                {
                    isLoadingUploadedThesesAsProfessor = false;
                    StateHasChanged();
                }
            }
            else
            {
                StateHasChanged();
            }
        }

        private void ToggleToSearchForUploadedCompanyThesesAsProfessor()
        {
            isUploadedCompanyThesesVisibleAsProfessor = !isUploadedCompanyThesesVisibleAsProfessor;

            // Clear search results if toggling off the search form
            if (!isUploadedCompanyThesesVisibleAsProfessor)
            {
                companyThesesResultsToFindThesesAsProfessor = null;
                searchPerformedToFindThesesAsProfessor = false;
            }
        }

        private void ToggleToSearchForUploadedProfessorThesesAsCompany()
        {
            isUploadedProfessorThesesVisibleAsCompany = !isUploadedProfessorThesesVisibleAsCompany;

            // Clear search results if toggling off the search form
            if (!isUploadedProfessorThesesVisibleAsCompany)
            {
                professorThesesResultsToFindThesesAsCompany = null;
                searchPerformedToFindThesesAsCompany = false;
            }
        }

        private async Task<List<AnnouncementAsCompany>> GetUploadedAnnouncements()
        {
            return await dbContext.AnnouncementsAsCompany
                .Where(a => a.CompanyAnnouncementCompanyEmail == CurrentUserEmail)
                .ToListAsync();
        }

        private async Task<List<CompanyEvent>> GetUploadedCompanyEvents()
        {
            return await dbContext.CompanyEvents
                .Include(e => e.Company) // Include the Company data
                .Where(e => e.CompanyEmailUsedToUploadEvent == CurrentUserEmail)
                .ToListAsync();
        }

        private async Task<List<ProfessorEvent>> GetUploadedProfessorEvents()
        {
            return await dbContext.ProfessorEvents
                .Include(pe => pe.Professor) // Include the Professor data
                .Where(pe => pe.ProfessorEmailUsedToUploadEvent == CurrentUserEmail)
                .ToListAsync();
        }

        private async Task<List<AnnouncementAsProfessor>> GetUploadedAnnouncementsAsProfessor()
        {
            return await dbContext.AnnouncementsAsProfessor
                .Where(a => a.ProfessorAnnouncementProfessorEmail == CurrentUserEmail)
                .ToListAsync();
        }

        private bool showLoadingModalForDeleteAnnouncement = false;
        private async Task DeleteAnnouncement(int announcementId)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Ανακοίνωση.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteAnnouncement = true;
                loadingProgress = 0;
                StateHasChanged();
        
                try
                {
                    // Step 1: Find the announcement
                    await UpdateProgressWhenDeleteAnnouncementAsCompany(30);
                    var announcement = await dbContext.AnnouncementsAsCompany.FindAsync(announcementId);
            
                    if (announcement != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteAnnouncementAsCompany(60);
                        dbContext.AnnouncementsAsCompany.Remove(announcement);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteAnnouncementAsCompany(80);

                        // Step 3: Refresh BOTH announcements lists
                        await UpdateProgressWhenDeleteAnnouncementAsCompany(90);
                        UploadedAnnouncements = await GetUploadedAnnouncements();
                    
                        // CRITICAL: Also update the filtered announcements
                        await ApplyFiltersAndUpdateCounts(); // This should update FilteredAnnouncements
                    
                        await UpdateProgressWhenDeleteAnnouncementAsCompany(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Announcement not found - hide modal and show error
                        showLoadingModalForDeleteAnnouncement = false;
                        await JS.InvokeVoidAsync("alert", "Η ανακοίνωση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteAnnouncement = false;
            
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteAnnouncement = false;
                }

                // Trigger UI refresh
                StateHasChanged();
            }
        }

        private async Task ApplyFiltersAndUpdateCounts()
        {
            if (UploadedAnnouncements == null) 
            {
                UploadedAnnouncements = await GetUploadedAnnouncements();
            }

            // Apply status filter
            if (selectedStatusFilterForAnnouncements == "Όλα")
            {
                FilteredAnnouncements = UploadedAnnouncements;
            }
            else
            {
                FilteredAnnouncements = UploadedAnnouncements
                    .Where(a => a.CompanyAnnouncementStatus == selectedStatusFilterForAnnouncements)
                    .ToList();
            }

            // Update counts
            totalCountAnnouncements = UploadedAnnouncements.Count;
            publishedCountAnnouncements = UploadedAnnouncements.Count(a => a.CompanyAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncements = UploadedAnnouncements.Count(a => a.CompanyAnnouncementStatus == "Μη Δημοσιευμένη");

            // Reset to first page after filtering
            currentPageForAnnouncements = 1;
        }

        private async Task UpdateProgressWhenDeleteAnnouncementAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }


        private bool showLoadingModalForDeleteCompanyEvent = false;
        private async Task DeleteCompanyEvent(int companyeventId)
        {
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "<strong style='color: red;'>Προσοχή!</strong><br><br>" +
                "Πρόκειται να <strong style='color: red;'>διαγράψετε οριστικά</strong> αυτή την Εκδήλωση.<br><br>" +
                "Αυτή η ενέργεια <strong>δεν μπορεί να αναιρεθεί</strong>.<br><br>" +
                "Είστε σίγουρος/η;");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteCompanyEvent = true;
                loadingProgress = 0;
                StateHasChanged();
            
                try
                {
                    // Step 1: Find the company event
                    await UpdateProgressWhenDeleteEventAsCompany(30);
                    var companyevent = await dbContext.CompanyEvents.FindAsync(companyeventId);
                
                    if (companyevent != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteEventAsCompany(60);
                        dbContext.CompanyEvents.Remove(companyevent);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteEventAsCompany(80);

                        // Step 3: Refresh the events list
                        await UpdateProgressWhenDeleteEventAsCompany(90);
                        UploadedEventsAsCompany = await GetUploadedCompanyEvents();
                        FilteredCompanyEvents = UploadedEventsAsCompany.ToList();
                        await UpdateProgressWhenDeleteEventAsCompany(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Event not found - hide modal and show error
                        showLoadingModalForDeleteCompanyEvent = false;
                        await JS.InvokeVoidAsync("alert", "Η εκδήλωση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteCompanyEvent = false;
                
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteCompanyEvent = false;
                }

                StateHasChanged();
            }
        }

        private async Task UpdateProgressWhenDeleteEventAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }


        private bool showLoadingModalForDeleteProfessorEvent = false;
        private async Task DeleteProfessorEvent(int professoreventId)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Εκδήλωση.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteProfessorEvent = true;
                loadingProgress = 0;
                StateHasChanged();
        
                try
                {
                    // Step 1: Find the event
                    await UpdateProgressWhenDeleteProfessorEvent(30);
                    var professorevent = await dbContext.ProfessorEvents.FindAsync(professoreventId);
            
                    if (professorevent != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteProfessorEvent(60);
                        dbContext.ProfessorEvents.Remove(professorevent);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteProfessorEvent(80);

                        // Step 3: Refresh the lists
                        await UpdateProgressWhenDeleteProfessorEvent(90);
                        UploadedEventsAsProfessor = await GetUploadedProfessorEvents();
                        FilteredProfessorEvents = UploadedEventsAsProfessor.ToList();
                        await UpdateProgressWhenDeleteProfessorEvent(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Event not found - hide modal and show error
                        showLoadingModalForDeleteProfessorEvent = false;
                        await JS.InvokeVoidAsync("alert", "Η εκδήλωση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteProfessorEvent = false;
            
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteProfessorEvent = false;
                }

                // Trigger UI refresh and navigation
                StateHasChanged();
                //NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
        }

        private async Task UpdateProgressWhenDeleteProfessorEvent(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }


        private bool showLoadingModalForDeleteProfessorAnnouncement = false;
        private async Task DeleteAnnouncementAsProfessor(int professorannouncementId)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Ανακοίνωση.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteProfessorAnnouncement = true;
                loadingProgress = 0;
                StateHasChanged();

                try
                {
                    // Step 1: Find the announcement
                    await UpdateProgressWhenDeleteAnnouncementAsProfessor(30);
                    var professorannouncement = await dbContext.AnnouncementsAsProfessor.FindAsync(professorannouncementId);
        
                    if (professorannouncement != null)
                    {
                        // Step 2: Remove from database
                        await UpdateProgressWhenDeleteAnnouncementAsProfessor(60);
                        dbContext.AnnouncementsAsProfessor.Remove(professorannouncement);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteAnnouncementAsProfessor(80);

                        // Step 3: Refresh BOTH announcements lists
                        await UpdateProgressWhenDeleteAnnouncementAsProfessor(90);
                        UploadedAnnouncementsAsProfessor = await GetUploadedAnnouncementsAsProfessor();
                    
                        // CRITICAL: Also update the filtered announcements
                        await ApplyFiltersAndUpdateCountsAsProfessor(); // This should update FilteredAnnouncementsAsProfessor
                    
                        await UpdateProgressWhenDeleteAnnouncementAsProfessor(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Announcement not found - hide modal and show error
                        showLoadingModalForDeleteProfessorAnnouncement = false;
                        await JS.InvokeVoidAsync("alert", "Η ανακοίνωση δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteProfessorAnnouncement = false;
        
                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteProfessorAnnouncement = false;
                }

                // Trigger UI refresh
                StateHasChanged();
            }
        }

        private async Task ApplyFiltersAndUpdateCountsAsProfessor()
        {
            if (UploadedAnnouncementsAsProfessor == null) 
            {
                UploadedAnnouncementsAsProfessor = await GetUploadedAnnouncementsAsProfessor();
            }

            // Apply status filter
            if (selectedStatusFilterForAnnouncementsAsProfessor == "Όλα")
            {
                FilteredAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor;
            }
            else
            {
                FilteredAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor
                    .Where(a => a.ProfessorAnnouncementStatus == selectedStatusFilterForAnnouncementsAsProfessor)
                    .ToList();
            }

            // Update counts
            totalCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count;
            publishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count(a => a.ProfessorAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count(a => a.ProfessorAnnouncementStatus == "Μη Δημοσιευμένη");

            // Reset to first page after filtering
            currentPageForProfessorAnnouncements_ProfessorAnnouncements = 1;
        }

        private async Task UpdateProgressWhenDeleteAnnouncementAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private async Task LoadUploadedAnnouncementsAsync()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch announcements related to the current company
                    UploadedAnnouncements = await dbContext.AnnouncementsAsCompany
                        .Where(i => i.CompanyAnnouncementCompanyEmail == userEmail)
                        .ToListAsync();

                    /*
                    if (UploadedAnnouncements == null || !UploadedAnnouncements.Any())
                    {
                        Console.WriteLine("No Announcements found for this user.");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Announcements: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadUploadedAnnouncementsAsProfessorAsync()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch announcements related to the current company
                    UploadedAnnouncementsAsProfessor = await dbContext.AnnouncementsAsProfessor
                        .Where(i => i.ProfessorAnnouncementProfessorEmail == userEmail)
                        .ToListAsync();

                    /*
                    if (UploadedAnnouncementsAsProfessor == null || !UploadedAnnouncementsAsProfessor.Any())
                    {
                        Console.WriteLine("No Announcements found for this user.");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Announcements: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadUploadedResearchGroupAnnouncementsAsync()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch announcements related to the current research group
                    UploadedResearchGroupAnnouncements = await dbContext.AnnouncementAsResearchGroup
                        .Where(i => i.ResearchGroupAnnouncementResearchGroupEmail == userEmail)
                        .ToListAsync();

                    /*
                    if (UploadedResearchGroupAnnouncements == null || !UploadedResearchGroupAnnouncements.Any())
                    {
                        Console.WriteLine("No Research Group Announcements found for this user.");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Research Group Announcements: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadUploadedEventsAsync()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch events related to the current company with Company data included
                    UploadedEventsAsCompany = await dbContext.CompanyEvents
                        .Include(e => e.Company) // Include the Company data
                        .Where(e => e.CompanyEmailUsedToUploadEvent == userEmail)
                        .ToListAsync();

                    /*
                    if (UploadedEventsAsCompany == null || !UploadedEventsAsCompany.Any())
                    {
                        Console.WriteLine("No Events found for this user.");
                    }
                    else
                    {
                        Console.WriteLine($"Found {UploadedEventsAsCompany.Count} events for company: {userEmail}");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Events: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadUploadedEventsAsyncAsProfessor()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch events related to the current professor
                    UploadedEventsAsProfessor = await dbContext.ProfessorEvents
                        .Include(pe => pe.Professor) // Include professor data
                        .Where(pe => pe.ProfessorEmailUsedToUploadEvent == userEmail)
                        .ToListAsync();

                    
                    if (UploadedEventsAsProfessor == null || !UploadedEventsAsProfessor.Any())
                    {
                        /*
                        Console.WriteLine("No Events found for this professor.");
                        */
                    }
                    else
                    {
                        // Example of accessing professor data through navigation property
                        foreach (var ev in UploadedEventsAsProfessor)
                        {
                            Console.WriteLine($"Event {ev.Id} by {ev.Professor?.ProfName} from {ev.Professor?.ProfUniversity}");
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Events: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task LoadUploadedThesesAsProfessorAsync()
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var userEmail = user.FindFirst("name")?.Value;

                if (!string.IsNullOrEmpty(userEmail))
                {
                    // Fetch theses with professor details using navigation property
                    UploadedThesesAsProfessor = await dbContext.ProfessorTheses
                        .Include(t => t.Professor) // Include professor details
                        .Where(t => t.ProfessorEmailUsedToUploadThesis == userEmail)
                        .OrderByDescending(t => t.ThesisUploadDateTime) // Newest first
                        .ToListAsync();

                    /*
                    if (UploadedThesesAsProfessor == null || !UploadedThesesAsProfessor.Any())
                    {
                        Console.WriteLine("No theses found for this professor.");
                    }
                    else
                    {
                        // Log loaded theses count for debugging
                        Console.WriteLine($"Loaded {UploadedThesesAsProfessor.Count} theses for professor {userEmail}");
                    }
                    */
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor theses: {ex.Message}");
                // Consider adding user-friendly error notification
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showErrorToast", 
                    "Σφάλμα φόρτωσης Διπλωματικών").AsTask());
            }
            finally
            {
                StateHasChanged();
            }
        }

        private async Task LoadToSeeUploadedCompanyThesesAsProfessorAsync()
        {
            try
            {
                // Load all company theses for the professor to see
                UploadedCompanyThesesToSeeAsProfessor = await dbContext.CompanyTheses.ToListAsync();

                // Check if any theses were found
                if (UploadedCompanyThesesToSeeAsProfessor == null || !UploadedCompanyThesesToSeeAsProfessor.Any())
                {
                    Console.WriteLine("No Company Theses found for the Professor To See");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Company Theses: {ex.Message}");
            }
            StateHasChanged();
        }

        private async Task ChangeAnnouncementStatus(int announcementId, string newStatus)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Ανακοίνωσης σε <strong>{newStatus}</strong>.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Find the announcement by ID and update its status
                var announcement = UploadedAnnouncements.FirstOrDefault(a => a.Id == announcementId);
                if (announcement != null)
                {
                    announcement.CompanyAnnouncementStatus = newStatus;
                    // Update the status in the database
                    await dbContext.SaveChangesAsync();
                }

                // Refresh UI
                StateHasChanged();
            }
        }



        private async Task ChangeCompanyEventStatus(int companyeventId, string newStatus)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Εκδήλωσης σε " +
                $"<strong style='color: {(newStatus == "Δημοσιευμένη" ? "green" : "red")};'>{newStatus}</strong>.<br><br>" +
                "Είστε σίγουρος/η;");

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Find the event by ID and update its status
                var companyevent = UploadedEventsAsCompany.FirstOrDefault(a => a.Id == companyeventId);
                if (companyevent != null)
                {
                    companyevent.CompanyEventStatus = newStatus;
                    // Update the status in the database
                    await dbContext.SaveChangesAsync();

                    // Optionally, refresh FilteredCompanyEvents if necessary
                    FilteredCompanyEvents = UploadedEventsAsCompany.ToList();
                }

                StateHasChanged();
            }
        }


        private async Task ChangeProfessorEventStatus(int professoreventId, string newStatus)
        {
            // Show confirmation dialog
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] 
            { 
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Εκδήλωσης σε '{newStatus}'. Είστε σίγουρος/η;" 
            });

            // Proceed only if confirmed
            if (isConfirmed)
            {
                // Find the announcement by ID and update its status
                var professorevent = UploadedEventsAsProfessor.FirstOrDefault(a => a.Id == professoreventId);
                if (professorevent != null)
                {
                    professorevent.ProfessorEventStatus = newStatus;
                    // Update the status in the database as well
                    await dbContext.SaveChangesAsync();

                    // Optionally, refresh FilteredCompanyEvents if necessary
                    FilteredProfessorEvents = UploadedEventsAsProfessor.ToList();
                }

                StateHasChanged();
            }
        }


        private async Task ChangeAnnouncementStatusAsProfessor(int professorannouncementId, string professorannouncementnewStatus)
        {
            // Show confirmation dialog
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] 
            { 
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Ανακοίνωσης σε '{professorannouncementnewStatus}'. Είστε σίγουρος/η;" 
            });

            if (isConfirmed)
            {
                var professorannouncement = UploadedAnnouncementsAsProfessor.FirstOrDefault(a => a.Id == professorannouncementId);
                if (professorannouncement != null)
                {
                    professorannouncement.ProfessorAnnouncementStatus = professorannouncementnewStatus;
                    await dbContext.SaveChangesAsync();
                }
                StateHasChanged();
            }
        }

        private async Task ChangeThesisStatusAsProfessor(int professorthesisId, string professorthesisnewStatus)
        {        var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] 
            { 
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Διπλωματικής σε '{professorthesisnewStatus}'. Είστε σίγουρος/η;" 
            });

            if (isConfirmed)
            {
                var professorthesis = UploadedThesesAsProfessor.FirstOrDefault(a => a.Id == professorthesisId);
                if (professorthesis != null)
                {
                    professorthesis.ThesisStatus = professorthesisnewStatus;
                    await dbContext.SaveChangesAsync();
                }
                StateHasChanged();
            }
        }

        private void OpenEditModal(AnnouncementAsCompany announcement)
        {
            currentAnnouncement = new AnnouncementAsCompany
            {
                Id = announcement.Id,
                CompanyAnnouncementTitle = announcement.CompanyAnnouncementTitle,
                CompanyAnnouncementDescription = announcement.CompanyAnnouncementDescription,
                CompanyAnnouncementUploadDate = announcement.CompanyAnnouncementUploadDate,
                CompanyAnnouncementCompanyEmail = announcement.CompanyAnnouncementCompanyEmail,
                CompanyAnnouncementTimeToBeActive = announcement.CompanyAnnouncementTimeToBeActive,
                CompanyAnnouncementAttachmentFile = announcement.CompanyAnnouncementAttachmentFile
            };
            isEditModalVisible = true;
        }

        private void OpenEditModalForCompanyEvent(CompanyEvent companyEvent)
        {
            currentCompanyEvent = new CompanyEvent
            {
                Id = companyEvent.Id,
                RNGForEventUploadedAsCompany = companyEvent.RNGForEventUploadedAsCompany,
                CompanyEventType = companyEvent.CompanyEventType,
                CompanyEventOtherOrganizerToBeVisible = companyEvent.CompanyEventOtherOrganizerToBeVisible,
                CompanyEventOtherOrganizer = companyEvent.CompanyEventOtherOrganizer,
                CompanyEventAreasOfInterest = companyEvent.CompanyEventAreasOfInterest,
                CompanyEventTitle = companyEvent.CompanyEventTitle,
                CompanyEventDescription = companyEvent.CompanyEventDescription,
                CompanyEventStatus = companyEvent.CompanyEventStatus,
                CompanyEventResponsiblePerson = companyEvent.CompanyEventResponsiblePerson,
                CompanyEventResponsiblePersonEmail = companyEvent.CompanyEventResponsiblePersonEmail,
                CompanyEventResponsiblePersonTelephone = companyEvent.CompanyEventResponsiblePersonTelephone,
                CompanyEventCompanyDepartment = companyEvent.CompanyEventCompanyDepartment,
                CompanyEventUploadedDate = companyEvent.CompanyEventUploadedDate,
                CompanyEventActiveDate = companyEvent.CompanyEventActiveDate,
                CompanyEventPerifereiaLocation = companyEvent.CompanyEventPerifereiaLocation,
                CompanyEventDimosLocation = companyEvent.CompanyEventDimosLocation,
                CompanyEventPlaceLocation = companyEvent.CompanyEventPlaceLocation,
                CompanyEventTime = companyEvent.CompanyEventTime,
                CompanyEventPostalCodeLocation = companyEvent.CompanyEventPostalCodeLocation,
                CompanyEventAttachmentFile = companyEvent.CompanyEventAttachmentFile,
                CompanyEventOfferingTransportToEventLocation = companyEvent.CompanyEventOfferingTransportToEventLocation,
                CompanyEventStartingPointLocationToTransportPeopleToEvent1 = companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1,
                CompanyEventStartingPointLocationToTransportPeopleToEvent2 = companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2,
                CompanyEventStartingPointLocationToTransportPeopleToEvent3 = companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3,
                RNGForEventUploadedAsCompany_HashedAsUniqueID = companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID,
                CompanyEmailUsedToUploadEvent = companyEvent.CompanyEmailUsedToUploadEvent
            };

            // Clear all previous selections
            SelectedAreasToEditForCompanyEvent.Clear();
            SelectedSubFieldsForEditCompanyEvent.Clear();
            ExpandedAreasForEditCompanyEvent.Clear();

            // Initialize area and subfield selections from the existing event data
            InitializeAreaSelectionsForEditCompanyEvent(companyEvent);

            // Ensure towns are loaded when opening the modal
            AvailableTownsForEditCompanyEvent = GetTownsForRegionForEditCompanyEvent(companyEvent.CompanyEventPerifereiaLocation);

            isEditModalVisibleForEventsAsCompany = true;
            StateHasChanged();
        }

        private void InitializeAreaSelectionsForEditCompanyEvent(CompanyEvent companyEvent)
        {
            if (!string.IsNullOrEmpty(companyEvent.CompanyEventAreasOfInterest))
            {
                // Split the stored areas string and trim each item
                var selectedItems = companyEvent.CompanyEventAreasOfInterest.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: CompanyEventAreasOfInterest = {companyEvent.CompanyEventAreasOfInterest}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForCompanyEvent.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditCompanyEvent.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditCompanyEvent[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditCompanyEvent[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditCompanyEvent[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditCompanyEvent.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForCompanyEvent.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditCompanyEvent.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditCompanyEvent.Count}");
            }
        }



        private List<string> GetTownsForRegionForEditProfessorEvent(string region)
        {
            return RegionToTownsMap.ContainsKey(region) 
                ? RegionToTownsMap[region] 
                : new List<string>();
        }


        private List<Area> SelectedAreasToEditForProfessorEvent = new();
        private List<string> AvailableTownsForEditProfessorEvent = new();
        private void OpenEditModalForProfessorEvent(ProfessorEvent professorevent)
        {
            // Make sure to include Professor when loading the event
            var eventWithProfessor = dbContext.ProfessorEvents
                .Include(pe => pe.Professor)
                .FirstOrDefault(pe => pe.Id == professorevent.Id);

            if (eventWithProfessor == null) return;

            currentProfessorEvent = new ProfessorEvent
            {
                Id = eventWithProfessor.Id,
                ProfessorEventTitle = eventWithProfessor.ProfessorEventTitle,
                ProfessorEventDescription = eventWithProfessor.ProfessorEventDescription,
                ProfessorEventType = eventWithProfessor.ProfessorEventType,
                ProfessorEventOtherOrganizerToBeVisible = eventWithProfessor.ProfessorEventOtherOrganizerToBeVisible,
                ProfessorEventOtherOrganizer = eventWithProfessor.ProfessorEventOtherOrganizer,
                ProfessorEventAreasOfInterest = eventWithProfessor.ProfessorEventAreasOfInterest,
                ProfessorEventStatus = eventWithProfessor.ProfessorEventStatus,
                ProfessorEventResponsiblePerson = eventWithProfessor.ProfessorEventResponsiblePerson,
                ProfessorEventResponsiblePersonEmail = eventWithProfessor.ProfessorEventResponsiblePersonEmail,
                ProfessorEventResponsiblePersonTelephone = eventWithProfessor.ProfessorEventResponsiblePersonTelephone,
                // University and department now come from Professor navigation property
                Professor = new Professor 
                {
                    ProfUniversity = eventWithProfessor.Professor?.ProfUniversity,
                    ProfDepartment = eventWithProfessor.Professor?.ProfDepartment,
                    ProfImage = eventWithProfessor.Professor?.ProfImage
                },
                ProfessorEventPerifereiaLocation = eventWithProfessor.ProfessorEventPerifereiaLocation,
                ProfessorEventDimosLocation = eventWithProfessor.ProfessorEventDimosLocation,
                ProfessorEventPlaceLocation = eventWithProfessor.ProfessorEventPlaceLocation,
                ProfessorEventActiveDate = eventWithProfessor.ProfessorEventActiveDate,
                ProfessorEventTime = eventWithProfessor.ProfessorEventTime,
                ProfessorEventPostalCodeLocation = eventWithProfessor.ProfessorEventPostalCodeLocation,
                ProfessorEventAttachmentFile = eventWithProfessor.ProfessorEventAttachmentFile,
                ProfessorEventOfferingTransportToEventLocation = eventWithProfessor.ProfessorEventOfferingTransportToEventLocation,
                ProfessorEventStartingPointLocationToTransportPeopleToEvent1 = eventWithProfessor.ProfessorEventStartingPointLocationToTransportPeopleToEvent1,
                ProfessorEventStartingPointLocationToTransportPeopleToEvent2 = eventWithProfessor.ProfessorEventStartingPointLocationToTransportPeopleToEvent2,
                ProfessorEventStartingPointLocationToTransportPeopleToEvent3 = eventWithProfessor.ProfessorEventStartingPointLocationToTransportPeopleToEvent3,
                ProfessorEmailUsedToUploadEvent = eventWithProfessor.ProfessorEmailUsedToUploadEvent
            };

            // Clear all previous selections
            SelectedAreasToEditForProfessorEvent.Clear();
            SelectedSubFieldsForEditProfessorEvent.Clear();
            ExpandedAreasForEditProfessorEvent.Clear();

            // Initialize area and subfield selections from the existing event data
            InitializeAreaSelectionsForEditProfessorEvent(eventWithProfessor);

            // Ensure towns are loaded when opening the modal
            AvailableTownsForEditProfessorEvent = GetTownsForRegionForEditProfessorEvent(eventWithProfessor.ProfessorEventPerifereiaLocation);

            isEditModalVisibleForEventsAsProfessor = true;
            StateHasChanged();
        }

        private void InitializeAreaSelectionsForEditProfessorEvent(ProfessorEvent professorEvent)
        {
            if (!string.IsNullOrEmpty(professorEvent.ProfessorEventAreasOfInterest))
            {
                // Split the stored areas string and trim each item
                var selectedItems = professorEvent.ProfessorEventAreasOfInterest.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: ProfessorEventAreasOfInterest = {professorEvent.ProfessorEventAreasOfInterest}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForProfessorEvent.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditProfessorEvent.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditProfessorEvent[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditProfessorEvent[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditProfessorEvent[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditProfessorEvent.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForProfessorEvent.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditProfessorEvent.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditProfessorEvent.Count}");
            }
        }

        private void OpenEditModalAsProfessor(AnnouncementAsProfessor professorAnnouncement)
        {
            currentAnnouncementAsProfessor = new AnnouncementAsProfessor
            {
                Id = professorAnnouncement.Id,
                ProfessorAnnouncementRNG = professorAnnouncement.ProfessorAnnouncementRNG,
                ProfessorAnnouncementRNG_HashedAsUniqueID = professorAnnouncement.ProfessorAnnouncementRNG_HashedAsUniqueID,
                ProfessorAnnouncementTitle = professorAnnouncement.ProfessorAnnouncementTitle,
                ProfessorAnnouncementDescription = professorAnnouncement.ProfessorAnnouncementDescription,
                ProfessorAnnouncementStatus = professorAnnouncement.ProfessorAnnouncementStatus,
                ProfessorAnnouncementUploadDate = professorAnnouncement.ProfessorAnnouncementUploadDate,
                ProfessorAnnouncementProfessorEmail = professorAnnouncement.ProfessorAnnouncementProfessorEmail,
                ProfessorAnnouncementTimeToBeActive = professorAnnouncement.ProfessorAnnouncementTimeToBeActive,
                ProfessorAnnouncementAttachmentFile = professorAnnouncement.ProfessorAnnouncementAttachmentFile
            };

            // Initialize navigation property with all Professor details
            if (professorAnnouncement.Professor != null)
            {
                currentAnnouncementAsProfessor.Professor = new Professor
                {
                    Id = professorAnnouncement.Professor.Id,
                    ProfEmail = professorAnnouncement.Professor.ProfEmail,
                    Professor_UniqueID = professorAnnouncement.Professor.Professor_UniqueID,
                    ProfImage = professorAnnouncement.Professor.ProfImage,
                    ProfName = professorAnnouncement.Professor.ProfName,
                    ProfSurname = professorAnnouncement.Professor.ProfSurname,
                    ProfUniversity = professorAnnouncement.Professor.ProfUniversity,
                    ProfDepartment = professorAnnouncement.Professor.ProfDepartment,
                    ProfVahmidaDEP = professorAnnouncement.Professor.ProfVahmidaDEP,
                    ProfWorkTelephone = professorAnnouncement.Professor.ProfWorkTelephone,
                    ProfPersonalTelephone = professorAnnouncement.Professor.ProfPersonalTelephone,
                    ProfPersonalTelephoneVisibility = professorAnnouncement.Professor.ProfPersonalTelephoneVisibility,
                    ProfPersonalWebsite = professorAnnouncement.Professor.ProfPersonalWebsite,
                    ProfLinkedInSite = professorAnnouncement.Professor.ProfLinkedInSite,
                    ProfScholarProfile = professorAnnouncement.Professor.ProfScholarProfile,
                    ProfOrchidProfile = professorAnnouncement.Professor.ProfOrchidProfile,
                    ProfGeneralFieldOfWork = professorAnnouncement.Professor.ProfGeneralFieldOfWork,
                    ProfGeneralSkills = professorAnnouncement.Professor.ProfGeneralSkills,
                    ProfPersonalDescription = professorAnnouncement.Professor.ProfPersonalDescription,
                    ProfCVAttachment = professorAnnouncement.Professor.ProfCVAttachment,
                    ProfRegistryNumber = professorAnnouncement.Professor.ProfRegistryNumber,
                    ProfCourses = professorAnnouncement.Professor.ProfCourses
                };
            }

            isEditModalVisibleForAnnouncementsAsProfessor = true;
        }


        private void OpenEditModalForThesisAsProfessor(ProfessorThesis professorthesis)
        {
            try
            {
                // Create new instance with navigation properties
                currentThesisAsProfessor = new ProfessorThesis
                {
                    Id = professorthesis.Id,
                    ThesisTitle = professorthesis.ThesisTitle,
                    ThesisDescription = professorthesis.ThesisDescription,
                    ThesisType = professorthesis.ThesisType,
                    ThesisStatus = professorthesis.ThesisStatus,
                    ThesisActivePeriod = professorthesis.ThesisActivePeriod,
                    ThesisAreas = professorthesis.ThesisAreas,
                    ThesisSkills = professorthesis.ThesisSkills,
                    ThesisAttachment = professorthesis.ThesisAttachment,
                    ProfessorEmailUsedToUploadThesis = professorthesis.ProfessorEmailUsedToUploadThesis,
                    ThesisUploadDateTime = professorthesis.ThesisUploadDateTime,
                    ThesisUpdateDateTime = professorthesis.ThesisUpdateDateTime,
                    ThesisTimesUpdated = professorthesis.ThesisTimesUpdated,
                    // ADDED: Open Slots field
                    OpenSlots_ProfessorThesis = professorthesis.OpenSlots_ProfessorThesis,
                    // Include professor details if needed
                    Professor = professorthesis.Professor != null ? new Professor
                    {
                        ProfName = professorthesis.Professor.ProfName,
                        ProfSurname = professorthesis.Professor.ProfSurname,
                        ProfDepartment = professorthesis.Professor.ProfDepartment
                    } : null
                };

                // Clear all previous selections
                SelectedAreasToEditForProfessorThesis.Clear();
                SelectedSubFieldsForEditProfessorThesis.Clear();
                ExpandedAreasForEditProfessorThesis.Clear();

                // Initialize area and subfield selections from the existing thesis data
                InitializeAreaSelectionsForEditProfessorThesis(professorthesis);

                // Initialize selected skills with improved null handling
                SelectedSkillsToEditForProfessorThesis = new List<Skill>();
                if (!string.IsNullOrEmpty(professorthesis.ThesisSkills))
                {
                    var currentSkills = professorthesis.ThesisSkills.Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(s => s.Trim())
                        .Where(s => !string.IsNullOrEmpty(s));
                
                    SelectedSkillsToEditForProfessorThesis = Skills
                        .Where(skill => currentSkills.Contains(skill.SkillName))
                        .ToList();
                }

                isEditModalVisibleForThesesAsProfessor = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error opening edit modal: {ex.Message}");
                // Consider adding user notification
                SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showErrorToast", 
                    "Σφάλμα ανοίγματος επεξεργασίας").AsTask());
            }
            finally
            {
                StateHasChanged();
            }
        }

        private void InitializeAreaSelectionsForEditProfessorThesis(ProfessorThesis thesis)
        {
            if (!string.IsNullOrEmpty(thesis.ThesisAreas))
            {
                // Split the stored areas string and trim each item
                var selectedItems = thesis.ThesisAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(item => item.Trim())
                    .ToHashSet();
        
                Console.WriteLine($"Debug: ThesisAreas = {thesis.ThesisAreas}");
                Console.WriteLine($"Debug: Selected Items Count = {selectedItems.Count}");
        
                // First pass: identify all selected areas and subfields
                foreach (var area in Areas)
                {
                    Console.WriteLine($"Debug: Checking area: {area.AreaName}");
            
                    // Check if the area itself is selected
                    if (selectedItems.Contains(area.AreaName))
                    {
                        Console.WriteLine($"Debug: Area selected: {area.AreaName}");
                        SelectedAreasToEditForProfessorThesis.Add(area);
                    }
            
                    // Check if any subfields of this area are selected
                    if (!string.IsNullOrEmpty(area.AreaSubFields))
                    {
                        var subFields = area.AreaSubFields.Split(',')
                            .Select(s => s.Trim())
                            .ToList();
                
                        bool hasSelectedSubfields = false;
                
                        foreach (var subField in subFields)
                        {
                            if (selectedItems.Contains(subField))
                            {
                                Console.WriteLine($"Debug: Subfield selected: {subField} for area: {area.AreaName}");
                                if (!SelectedSubFieldsForEditProfessorThesis.ContainsKey(area.AreaName))
                                {
                                    SelectedSubFieldsForEditProfessorThesis[area.AreaName] = new List<string>();
                                }
                                if (!SelectedSubFieldsForEditProfessorThesis[area.AreaName].Contains(subField))
                                {
                                    SelectedSubFieldsForEditProfessorThesis[area.AreaName].Add(subField);
                                    hasSelectedSubfields = true;
                                }
                            }
                        }
                
                        // Auto-expand areas that have selected subfields
                        if (hasSelectedSubfields)
                        {
                            Console.WriteLine($"Debug: Auto-expanding area with subfields: {area.AreaName}");
                            ExpandedAreasForEditProfessorThesis.Add(area.Id);
                        }
                    }
                }
        
                Console.WriteLine($"Debug: Final Selected Areas Count = {SelectedAreasToEditForProfessorThesis.Count}");
                Console.WriteLine($"Debug: Final Selected Subfields Count = {SelectedSubFieldsForEditProfessorThesis.Count}");
                Console.WriteLine($"Debug: Final Expanded Areas Count = {ExpandedAreasForEditProfessorThesis.Count}");
            }
        }

        private void CloseEditModal()
        {
            isEditModalVisible = false;
        }

        private void CloseEditModalForCompanyEvent()
        {
            isEditModalVisibleForEventsAsCompany = false;
        }

        private void CloseEditModalForProfessorEvent()
        {
            isEditModalVisibleForEventsAsProfessor = false;
        }

        private void CloseEditModalForAnnouncementsAsProfessor()
        {
            isEditModalVisibleForAnnouncementsAsProfessor = false;
        }

        private void CloseEditModalForThesesAsProfessor()
        {
            isEditModalVisibleForThesesAsProfessor = false;
        }

        private async Task UpdateAnnouncement(AnnouncementAsCompany updatedAnnouncement)
        {
            var existingAnnouncement = await dbContext.AnnouncementsAsCompany.FindAsync(updatedAnnouncement.Id);

            if (existingAnnouncement != null)
            {
                existingAnnouncement.CompanyAnnouncementTitle = updatedAnnouncement.CompanyAnnouncementTitle;
                existingAnnouncement.CompanyAnnouncementDescription = updatedAnnouncement.CompanyAnnouncementDescription;
                existingAnnouncement.CompanyAnnouncementTimeToBeActive = updatedAnnouncement.CompanyAnnouncementTimeToBeActive; 
                existingAnnouncement.CompanyAnnouncementAttachmentFile = updatedAnnouncement.CompanyAnnouncementAttachmentFile; 
            
                await dbContext.SaveChangesAsync();
                CloseEditModal();
            }
        }


        private async Task UpdateCompanyEvent(CompanyEvent updatedCompanyEvent)
        {
            try
            {
                // Build areas and subfields string (same format as create)
                var areasWithSubfields = new List<string>();
        
                // Add selected areas
                foreach (var area in SelectedAreasToEditForCompanyEvent)
                {
                    areasWithSubfields.Add(area.AreaName);
                }
        
                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditCompanyEvent)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }
        
                // Convert to comma-separated string
                updatedCompanyEvent.CompanyEventAreasOfInterest = string.Join(",", areasWithSubfields);

                var existingCompanyEvent = await dbContext.CompanyEvents.FindAsync(updatedCompanyEvent.Id);

                if (existingCompanyEvent != null)
                {
                    existingCompanyEvent.CompanyEventTitle = updatedCompanyEvent.CompanyEventTitle;
                    existingCompanyEvent.CompanyEventDescription = updatedCompanyEvent.CompanyEventDescription;
                    existingCompanyEvent.CompanyEventType = updatedCompanyEvent.CompanyEventType;
                    existingCompanyEvent.CompanyEventResponsiblePerson = updatedCompanyEvent.CompanyEventResponsiblePerson;
                    existingCompanyEvent.CompanyEventResponsiblePersonEmail = updatedCompanyEvent.CompanyEventResponsiblePersonEmail;
                    existingCompanyEvent.CompanyEventResponsiblePersonTelephone = updatedCompanyEvent.CompanyEventResponsiblePersonTelephone;
                    existingCompanyEvent.CompanyEventCompanyDepartment = updatedCompanyEvent.CompanyEventCompanyDepartment;
                    existingCompanyEvent.CompanyEventPerifereiaLocation = updatedCompanyEvent.CompanyEventPerifereiaLocation;
                    existingCompanyEvent.CompanyEventDimosLocation = updatedCompanyEvent.CompanyEventDimosLocation;
                    existingCompanyEvent.CompanyEventPlaceLocation = updatedCompanyEvent.CompanyEventPlaceLocation;
                    existingCompanyEvent.CompanyEventPostalCodeLocation = updatedCompanyEvent.CompanyEventPostalCodeLocation;
                    existingCompanyEvent.CompanyEventActiveDate = updatedCompanyEvent.CompanyEventActiveDate;
                    existingCompanyEvent.CompanyEventTime = updatedCompanyEvent.CompanyEventTime;

                    // Save the areas with subfields
                    existingCompanyEvent.CompanyEventAreasOfInterest = updatedCompanyEvent.CompanyEventAreasOfInterest;

                    existingCompanyEvent.CompanyEventOfferingTransportToEventLocation = updatedCompanyEvent.CompanyEventOfferingTransportToEventLocation;
                    existingCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1 = updatedCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1;
                    existingCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2 = updatedCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2;
                    existingCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3 = updatedCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3;

                    // Save the changes to the database
                    await dbContext.SaveChangesAsync();
                    CloseEditModalForCompanyEvent();
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error updating company event: {ex.Message}");
                // Handle error appropriately
            }
        }



        private async Task UpdateProfessorEvent(ProfessorEvent updatedProfessorEvent)
        {
            try
            {
                // Build areas and subfields string (same format as create)
                var areasWithSubfields = new List<string>();
        
                // Add selected areas
                foreach (var area in SelectedAreasToEditForProfessorEvent)
                {
                    areasWithSubfields.Add(area.AreaName);
                }
        
                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditProfessorEvent)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }
        
                // Convert to comma-separated string
                updatedProfessorEvent.ProfessorEventAreasOfInterest = string.Join(",", areasWithSubfields);

                var existingProfessorEvent = await dbContext.ProfessorEvents.FindAsync(updatedProfessorEvent.Id);

                if (existingProfessorEvent != null)
                {
                    existingProfessorEvent.ProfessorEventTitle = updatedProfessorEvent.ProfessorEventTitle;
                    existingProfessorEvent.ProfessorEventDescription = updatedProfessorEvent.ProfessorEventDescription;
                    existingProfessorEvent.ProfessorEventType = updatedProfessorEvent.ProfessorEventType;
                    existingProfessorEvent.ProfessorEventResponsiblePerson = updatedProfessorEvent.ProfessorEventResponsiblePerson;
                    existingProfessorEvent.ProfessorEventResponsiblePersonEmail = updatedProfessorEvent.ProfessorEventResponsiblePersonEmail;
                    existingProfessorEvent.ProfessorEventResponsiblePersonTelephone = updatedProfessorEvent.ProfessorEventResponsiblePersonTelephone;
                    existingProfessorEvent.ProfessorEventPerifereiaLocation = updatedProfessorEvent.ProfessorEventPerifereiaLocation;
                    existingProfessorEvent.ProfessorEventDimosLocation = updatedProfessorEvent.ProfessorEventDimosLocation;
                    existingProfessorEvent.ProfessorEventPlaceLocation = updatedProfessorEvent.ProfessorEventPlaceLocation;
                    existingProfessorEvent.ProfessorEventPostalCodeLocation = updatedProfessorEvent.ProfessorEventPostalCodeLocation;
                    existingProfessorEvent.ProfessorEventActiveDate = updatedProfessorEvent.ProfessorEventActiveDate;
                    existingProfessorEvent.ProfessorEventTime = updatedProfessorEvent.ProfessorEventTime;

                    // Save the areas with subfields
                    existingProfessorEvent.ProfessorEventAreasOfInterest = updatedProfessorEvent.ProfessorEventAreasOfInterest;

                    existingProfessorEvent.ProfessorEventOfferingTransportToEventLocation = updatedProfessorEvent.ProfessorEventOfferingTransportToEventLocation;
                    existingProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent1 = updatedProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent1;
                    existingProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent2 = updatedProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent2;
                    existingProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent3 = updatedProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent3;

                    // Save the changes to the database
                    await dbContext.SaveChangesAsync();
                    CloseEditModalForProfessorEvent();
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error updating professor event: {ex.Message}");
                // Handle error appropriately
            }
        }

        private async Task UpdateAnnouncementAsProfessor(AnnouncementAsProfessor updatedAnnouncementasProfessor)
        {
            var existingAnnouncementasProfessor = await dbContext.AnnouncementsAsProfessor.FindAsync(updatedAnnouncementasProfessor.Id);

            if (existingAnnouncementasProfessor != null)
            {
                existingAnnouncementasProfessor.ProfessorAnnouncementTitle = updatedAnnouncementasProfessor.ProfessorAnnouncementTitle;
                existingAnnouncementasProfessor.ProfessorAnnouncementDescription = updatedAnnouncementasProfessor.ProfessorAnnouncementDescription;
                existingAnnouncementasProfessor.ProfessorAnnouncementAttachmentFile = updatedAnnouncementasProfessor.ProfessorAnnouncementAttachmentFile;
                await dbContext.SaveChangesAsync();
                CloseEditModalForAnnouncementsAsProfessor();
            }
        }

        private async Task UpdateThesisAsProfessor(ProfessorThesis updatedThesisProfessor)
        {
            try
            {
                // Validate required fields
                if (string.IsNullOrWhiteSpace(currentThesisAsProfessor.ThesisTitle) || 
                    string.IsNullOrWhiteSpace(currentThesisAsProfessor.ThesisDescription))
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    Console.WriteLine("Παρακαλώ συμπληρώστε όλα τα απαραίτητα πεδία");
                    return;
                }

                // Build areas and subfields string
                var areasWithSubfields = new List<string>();

                // Add selected areas
                foreach (var area in SelectedAreasToEditForProfessorThesis)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditProfessorThesis)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Convert to comma-separated string
                currentThesisAsProfessor.ThesisAreas = string.Join(",", areasWithSubfields);

                // Initialize selected skills if null/empty
                SelectedSkillsToEditForProfessorThesis ??= new List<Skill>();
                if (!SelectedSkillsToEditForProfessorThesis.Any())
                {
                    var currentSkills = currentThesisAsProfessor.ThesisSkills?
                        .Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(s => s.Trim())
                        .ToList() ?? new List<string>();
        
                    SelectedSkillsToEditForProfessorThesis = Skills
                        .Where(skill => currentSkills.Contains(skill.SkillName))
                        .ToList();
                }

                // Update skills
                currentThesisAsProfessor.ThesisSkills = string.Join(",", 
                    SelectedSkillsToEditForProfessorThesis.Select(s => s.SkillName));

                // Find and update thesis
                var thesisToUpdate = await dbContext.ProfessorTheses
                    .Include(t => t.Professor)
                    .FirstOrDefaultAsync(t => t.Id == currentThesisAsProfessor.Id);

                if (thesisToUpdate == null)
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    Console.WriteLine("Δεν βρέθηκε η Διπλωματική εργασία");
                    return;
                }

                // Update thesis properties
                thesisToUpdate.ThesisTitle = currentThesisAsProfessor.ThesisTitle;
                thesisToUpdate.ThesisDescription = currentThesisAsProfessor.ThesisDescription;
                thesisToUpdate.ThesisType = currentThesisAsProfessor.ThesisType;
                thesisToUpdate.ThesisStatus = currentThesisAsProfessor.ThesisStatus;
                thesisToUpdate.ThesisActivePeriod = currentThesisAsProfessor.ThesisActivePeriod;
                thesisToUpdate.ThesisAreas = currentThesisAsProfessor.ThesisAreas;
                thesisToUpdate.ThesisSkills = currentThesisAsProfessor.ThesisSkills;
                // ADDED: Update Open Slots field
                thesisToUpdate.OpenSlots_ProfessorThesis = currentThesisAsProfessor.OpenSlots_ProfessorThesis;

                // Update professor department if changed
                if (thesisToUpdate.Professor != null && !string.IsNullOrEmpty(currentThesisAsProfessor.Professor?.ProfDepartment))
                {
                    thesisToUpdate.Professor.ProfDepartment = currentThesisAsProfessor.Professor.ProfDepartment;
                }

                // Update attachment if new file was uploaded
                if (currentThesisAsProfessor.ThesisAttachment != null && 
                    currentThesisAsProfessor.ThesisAttachment.Length > 0)
                {
                    thesisToUpdate.ThesisAttachment = currentThesisAsProfessor.ThesisAttachment;
                }

                // Update metadata
                thesisToUpdate.ThesisUpdateDateTime = DateTime.Now;
                thesisToUpdate.ThesisTimesUpdated++;

                // Save changes
                await dbContext.SaveChangesAsync();

                showSuccessMessage = true;
                showErrorMessage = false;
                Console.WriteLine("Επιτυχής ενημέρωση Διπλωματικής εργασίας");
            }
            catch (Exception ex)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                Console.Error.WriteLine($"Error saving professor thesis: {ex.Message}");
            }
            finally
            {
                isEditModalVisibleForThesesAsProfessor = false;
                currentThesisAsProfessor = null; // Clear the editing object
                await LoadUploadedThesesAsProfessorAsync(); // Refresh the list
                StateHasChanged();
            }
        }

        private void FilterAnnouncements()
        {
            // Filter the announcements based on the selected filter
            if (selectedStatusFilterForAnnouncements == "Όλα")
            {
                FilteredAnnouncements = UploadedAnnouncements;
            }
            else if (selectedStatusFilterForAnnouncements == "Δημοσιευμένη")
            {
                FilteredAnnouncements = UploadedAnnouncements
                    .Where(a => a.CompanyAnnouncementStatus == "Δημοσιευμένη").ToList();
            }
            else if (selectedStatusFilterForAnnouncements == "Μη Δημοσιευμένη")
            {
                FilteredAnnouncements = UploadedAnnouncements
                    .Where(a => a.CompanyAnnouncementStatus == "Μη Δημοσιευμένη").ToList();
            }

            // Update counts
            totalCountAnnouncements = UploadedAnnouncements.Count;
            publishedCountAnnouncements = UploadedAnnouncements
                .Count(a => a.CompanyAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncements = UploadedAnnouncements
                .Count(a => a.CompanyAnnouncementStatus == "Μη Δημοσιευμένη");

            // Refresh UI
            StateHasChanged();
        }

        private void FilterAnnouncementsAsProfessor()
        {
            // Filter the announcements based on the selected filter
            if (selectedStatusFilterForAnnouncementsAsProfessor == "Όλα")
            {
                FilteredAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor;
            }
            else if (selectedStatusFilterForAnnouncementsAsProfessor == "Δημοσιευμένη")
            {
                FilteredAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor
                    .Where(a => a.ProfessorAnnouncementStatus == "Δημοσιευμένη").ToList();
            }
            else if (selectedStatusFilterForAnnouncementsAsProfessor == "Μη Δημοσιευμένη")
            {
                FilteredAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor
                    .Where(a => a.ProfessorAnnouncementStatus == "Μη Δημοσιευμένη").ToList();
            }

            // Update counts
            totalCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor.Count;
            publishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor
                .Count(a => a.ProfessorAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountAnnouncementsAsProfessor = UploadedAnnouncementsAsProfessor
                .Count(a => a.ProfessorAnnouncementStatus == "Μη Δημοσιευμένη");

            // Refresh UI
            StateHasChanged();
        }

        private void FilterThesesAsProfessor()
        {
            // Filter the announcements based on the selected filter
            if (selectedStatusFilterForThesesAsProfessor == "Όλα")
            {
                FilteredThesesAsProfessor = UploadedThesesAsProfessor;
            }
            else
            {
                FilteredThesesAsProfessor = UploadedThesesAsProfessor
                    .Where(a => a.ThesisStatus == selectedStatusFilterForThesesAsProfessor)
                    .ToList();
            }

            // Console.WriteLine($"Filtered Theses Count: {FilteredThesesAsProfessor.Count}");

            // Update counts
            totalCountThesesAsProfessor = UploadedThesesAsProfessor.Count;
            publishedCountThesesAsProfessor = UploadedThesesAsProfessor
                .Count(a => a.ThesisStatus == "Δημοσιευμένη");
            unpublishedCountThesesAsProfessor = UploadedThesesAsProfessor
                .Count(a => a.ThesisStatus == "Μη Δημοσιευμένη");
            withdrawnCountThesesAsProfessor = UploadedThesesAsProfessor
                .Count(a => a.ThesisStatus == "Αποσυρμένη");
        
            /*
            Console.WriteLine($"Total Count: {totalCountThesesAsProfessor}");
            Console.WriteLine($"Published Count: {publishedCountThesesAsProfessor}");
            Console.WriteLine($"Unpublished Count: {unpublishedCountThesesAsProfessor}");
            Console.WriteLine($"Withdrawn Count: {withdrawnCountThesesAsProfessor}");
            */

            // Refresh UI
            StateHasChanged();
        }

    @*
        private void FilterThesesAsCompany()
        {
            // Apply filter based on selected status
            if (selectedStatusFilterForCompanyTheses == "Όλα")
            {
                FilteredCompanyTheses = UploadedCompanyTheses;
            }
            else
            {
                FilteredCompanyTheses = UploadedCompanyTheses
                    .Where(a => a.CompanyThesisStatus == selectedStatusFilterForCompanyTheses)
                    .ToList();
            }

            // Debugging: Check if filtering works
            Console.WriteLine($"Filtered Theses Count: {FilteredCompanyTheses.Count}");

            // Recalculate counts
            totalCountForCompanyTheses = UploadedCompanyTheses.Count; // Total count of filtered theses
            publishedCountForCompanyTheses = UploadedCompanyTheses
                .Count(a => a.CompanyThesisStatus == "Δημοσιευμένη"); // Count from original list
            unpublishedCountForCompanyTheses = UploadedCompanyTheses
                .Count(a => a.CompanyThesisStatus == "Μη Δημοσιευμένη"); // Count from original list
            withdrawnCountForCompanyTheses = UploadedCompanyTheses
                .Count(a => a.CompanyThesisStatus == "Αποσυρμένη"); // Count from original list

            // Log the calculated counts to ensure they are correct
            Console.WriteLine($"Total Count: {totalCountForCompanyTheses}");
            Console.WriteLine($"Published Count: {publishedCountForCompanyTheses}");
            Console.WriteLine($"Unpublished Count: {unpublishedCountForCompanyTheses}");
            Console.WriteLine($"Withdrawn Count: {withdrawnCountForCompanyTheses}");

            // Refresh the UI
            StateHasChanged();
        }
    *@
        private void FilterCompanyEvents()
        {
            // Filter the announcements based on the selected filter
            if (selectedStatusFilterForEventsAsCompany == "Όλα")
            {
                FilteredCompanyEvents = UploadedEventsAsCompany;
            }
            else if (selectedStatusFilterForEventsAsCompany == "Δημοσιευμένη")
            {
                FilteredCompanyEvents = UploadedEventsAsCompany
                    .Where(a => a.CompanyEventStatus == "Δημοσιευμένη").ToList();
            }
            else if (selectedStatusFilterForEventsAsCompany == "Μη Δημοσιευμένη")
            {
                FilteredCompanyEvents = UploadedEventsAsCompany
                    .Where(a => a.CompanyEventStatus == "Μη Δημοσιευμένη").ToList();
            }

            // Update counts
            totalCountEventsAsCompany = UploadedEventsAsCompany.Count;
            publishedCountEventsAsCompany = UploadedEventsAsCompany
                .Count(a => a.CompanyEventStatus == "Δημοσιευμένη");
            unpublishedCountEventsAsCompany = UploadedEventsAsCompany
                .Count(a => a.CompanyEventStatus == "Μη Δημοσιευμένη");

            // Refresh UI
            StateHasChanged();
        }


        private void FilterProfessorEvents()
        {
            // Filter the announcements based on the selected filter
            if (selectedStatusFilterForEventsAsProfessor == "Όλα")
            {
                FilteredProfessorEvents = UploadedEventsAsProfessor;
            }
            else if (selectedStatusFilterForEventsAsProfessor == "Δημοσιευμένη")
            {
                FilteredProfessorEvents = UploadedEventsAsProfessor
                    .Where(a => a.ProfessorEventStatus == "Δημοσιευμένη").ToList();
            }
            else if (selectedStatusFilterForEventsAsProfessor == "Μη Δημοσιευμένη")
            {
                FilteredProfessorEvents = UploadedEventsAsProfessor
                    .Where(a => a.ProfessorEventStatus == "Μη Δημοσιευμένη").ToList();
            }

            // Update counts
            totalCountEventsAsProfessor = UploadedEventsAsProfessor.Count;
            publishedCountEventsAsProfessor = UploadedEventsAsProfessor
                .Count(a => a.ProfessorEventStatus == "Δημοσιευμένη");
            unpublishedCountEventsAsProfessor = UploadedEventsAsProfessor
                .Count(a => a.ProfessorEventStatus == "Μη Δημοσιευμένη");

            // Refresh UI
            StateHasChanged();
        }



        private void HandleStatusFilterChange(ChangeEventArgs e)
        {
            selectedStatusFilterForAnnouncements = e.Value.ToString();
            FilterAnnouncements(); // Call your filtering logic
        }

        private void HandleStatusFilterChangeForCompanyEvents(ChangeEventArgs e)
        {
            selectedStatusFilterForEventsAsCompany = e.Value.ToString();
            FilterCompanyEvents(); // Call your filtering logic
        }

        private void HandleStatusFilterChangeForProfessorEvents(ChangeEventArgs e)
        {
            selectedStatusFilterForEventsAsProfessor = e.Value.ToString();
            FilterProfessorEvents(); // Call your filtering logic
        }

        private void HandleStatusFilterChangeForAnnouncementsAsProfessor(ChangeEventArgs e)
        {
            selectedStatusFilterForAnnouncementsAsProfessor = e.Value.ToString();
            FilterAnnouncementsAsProfessor(); // Call your filtering logic
        }

        private void HandleStatusFilterChangeForThesesAsProfessor(ChangeEventArgs e)
        {
            selectedStatusFilterForThesesAsProfessor = e.Value.ToString();
            FilterThesesAsProfessor(); // Call your filtering logic
        }

        private void HandleStatusFilterChangeForThesesAsCompany(ChangeEventArgs e)
        {
            selectedStatusFilterForCompanyTheses = e.Value.ToString();
            //FilterThesesAsCompany(); // Trigger filtering and recalculation of counts
        }



        private async Task SaveAnnouncementAsPublishedAsProfessor()
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{professorannouncement.ProfessorAnnouncementTitle}</strong> ως '<strong>Δημοσιευμένη</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
        });

            if (!isConfirmed)
                return;

            professorannouncement.ProfessorAnnouncementStatus = "Δημοσιευμένη";
            professorannouncement.ProfessorAnnouncementUploadDate = DateTime.Now;
            professorannouncement.ProfessorAnnouncementProfessorEmail = CurrentUserEmail;
            professorannouncement.ProfessorAnnouncementRNG = new Random().NextInt64();
            professorannouncement.ProfessorAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(professorannouncement.ProfessorAnnouncementRNG ?? 0);

            // Initialize Professor navigation property if needed
            professorannouncement.Professor = new Professor
            {
                ProfEmail = CurrentUserEmail,
                ProfName = professorName,
                ProfSurname = professorSurname
            };

            await SaveAnnouncementToDatabaseAsProfessor();
        }

        private async Task SaveAnnouncementAsUnpublishedAsProfessor()
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{professorannouncement.ProfessorAnnouncementTitle}</strong> ως '<strong>Μη Δημοσιευμένη (Προσωρινή Αποθήκευση)</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
        });

            if (!isConfirmed)
                return;

            professorannouncement.ProfessorAnnouncementStatus = "Μη Δημοσιευμένη";
            professorannouncement.ProfessorAnnouncementUploadDate = DateTime.Now;
            professorannouncement.ProfessorAnnouncementProfessorEmail = CurrentUserEmail;
            professorannouncement.ProfessorAnnouncementRNG = new Random().NextInt64();
            professorannouncement.ProfessorAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(professorannouncement.ProfessorAnnouncementRNG ?? 0);

            // Initialize Professor navigation property if needed
            professorannouncement.Professor = new Professor
            {
                ProfEmail = CurrentUserEmail,
                ProfName = professorName,
                ProfSurname = professorSurname
            };

            await SaveAnnouncementToDatabaseAsProfessor();
        }


        private async Task SaveThesisAsPublishedAsProfessor()
        {
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Διπλωματική Εργασία με Τίτλο: <strong>{professorthesis.ThesisTitle}</strong> ως '<strong>Δημοσιευμένη</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
        });

            if (!isConfirmed) return;

            // UPDATED: Build areas and subfields string for professor thesis
            var areasWithSubfields = new List<string>();

            // Add selected areas (using AreaName)
            foreach (var area in selectedThesisAreasForProfessor)
            {
                areasWithSubfields.Add(area.AreaName);
            }

            // Add subfields (just the subfield names, not with area prefix)
            foreach (var areaSubFields in SelectedSubFieldsForProfessorThesis)
            {
                var subFields = areaSubFields.Value;
                foreach (var subField in subFields)
                {
                    areasWithSubfields.Add(subField);
                }
            }

            // Initialize new thesis
            var newThesis = new ProfessorThesis
            {
                ThesisTitle = professorthesis.ThesisTitle,
                ThesisDescription = professorthesis.ThesisDescription,
                ThesisAttachment = professorthesis.ThesisAttachment,
                ThesisStatus = "Δημοσιευμένη",
                ThesisUploadDateTime = DateTime.Now,
                ThesisActivePeriod = professorthesis.ThesisActivePeriod, // CHANGED: Use user's selected date
                ProfessorEmailUsedToUploadThesis = CurrentUserEmail,
                RNGForThesisUploaded = new Random().NextInt64(),
                RNGForThesisUploaded_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                // UPDATED: Include both areas and subfields
                ThesisAreas = string.Join(",", areasWithSubfields),
                ThesisSkills = string.Join(",", selectedThesisSkillsForProfessor.Select(s => s.SkillName)),
                ThesisType = ThesisType.Professor,
                IsCompanyInteresetedInProfessorThesis = false,
                IsCompanyInterestedInProfessorThesisStatus = "Δεν έχει γίνει Αποδοχή",
                ThesisUpdateDateTime = DateTime.Now,
                // ADDED: Open Slots field
                OpenSlots_ProfessorThesis = professorthesis.OpenSlots_ProfessorThesis
            };

            professorthesis = newThesis;
            await SaveThesisToDatabaseAsProfessor();
        }

        private async Task SaveThesisAsUnpublishedAsProfessor()
        {
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Διπλωματική Εργασία με Τίτλο: <strong>{professorthesis.ThesisTitle}</strong> ως '<strong>Μη Δημοσιευμένη</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
        });

            if (!isConfirmed) return;

            // UPDATED: Build areas and subfields string for professor thesis
            var areasWithSubfields = new List<string>();

            // Add selected areas (using AreaName)
            foreach (var area in selectedThesisAreasForProfessor)
            {
                areasWithSubfields.Add(area.AreaName);
            }

            // Add subfields (just the subfield names, not with area prefix)
            foreach (var areaSubFields in SelectedSubFieldsForProfessorThesis)
            {
                var subFields = areaSubFields.Value;
                foreach (var subField in subFields)
                {
                    areasWithSubfields.Add(subField);
                }
            }

            var newThesis = new ProfessorThesis
            {
                ThesisTitle = professorthesis.ThesisTitle,
                ThesisDescription = professorthesis.ThesisDescription,
                ThesisAttachment = professorthesis.ThesisAttachment,
                ThesisStatus = "Μη Δημοσιευμένη",
                ThesisUploadDateTime = DateTime.Now,
                ThesisActivePeriod = professorthesis.ThesisActivePeriod, // CHANGED: Use user's selected date
                ProfessorEmailUsedToUploadThesis = CurrentUserEmail,
                RNGForThesisUploaded = new Random().NextInt64(),
                RNGForThesisUploaded_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                // UPDATED: Include both areas and subfields
                ThesisAreas = string.Join(",", areasWithSubfields),
                ThesisSkills = string.Join(",", selectedThesisSkillsForProfessor.Select(s => s.SkillName)),
                ThesisType = ThesisType.Professor,
                IsCompanyInteresetedInProfessorThesis = false,
                IsCompanyInterestedInProfessorThesisStatus = "Δεν έχει γίνει Αποδοχή",
                ThesisUpdateDateTime = DateTime.Now,
                // ADDED: Open Slots field
                OpenSlots_ProfessorThesis = professorthesis.OpenSlots_ProfessorThesis
            };

            professorthesis = newThesis;
            await SaveThesisToDatabaseAsProfessor();
        }


        private bool showLoadingModalForProfessorAnnouncement = false;
        private async Task SaveAnnouncementToDatabaseAsProfessor()
        {
            // Show loading modal and reset progress
            showLoadingModalForProfessorAnnouncement = true;
            loadingProgress = 0;
            showErrorMessageforUploadingannouncementsAsProfessor = false;
            isSaveAnnouncementAsProfessorSuccessful = false;
            StateHasChanged();

            try
            {
                // Step 1: Validation checks
                await UpdateProgressWhenSaveAnnouncementAsProfessor(20);
                if (string.IsNullOrWhiteSpace(professorannouncement.ProfessorAnnouncementTitle) ||
                    string.IsNullOrWhiteSpace(professorannouncement.ProfessorAnnouncementDescription) ||
                    professorannouncement.ProfessorAnnouncementTimeToBeActive.Date == DateTime.Today)
                {
                    await HandleProfessorAnnouncementValidationErrorWhenSaveAnnouncementAsProfessor();
                    return;
                }
                await UpdateProgressWhenSaveAnnouncementAsProfessor(40);

                // Step 2: Get professor data from database
                await UpdateProgressWhenSaveAnnouncementAsProfessor(60);
                var existingProfessor = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == CurrentUserEmail);

                if (existingProfessor != null)
                {
                    // Associate existing professor with announcement
                    professorannouncement.Professor = existingProfessor;
                    professorannouncement.ProfessorAnnouncementProfessorEmail = existingProfessor.ProfEmail;
                }
                else
                {
                    // Handle case where professor doesn't exist
                    await HandleProfessorNotFoundErrorWhenSaveAnnouncementAsProfessor();
                    return;
                }
                await UpdateProgressWhenSaveAnnouncementAsProfessor(80);

                // Step 3: Save to database
                await UpdateProgressWhenSaveAnnouncementAsProfessor(90);
                dbContext.AnnouncementsAsProfessor.Add(professorannouncement);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveAnnouncementAsProfessor(100);

                // Step 4: Success
                isSaveAnnouncementAsProfessorSuccessful = true;
                saveAnnouncementAsProfessorMessage = "Η Ανακοίνωση Δημιουργήθηκε Επιτυχώς";

                // Small delay to show completion
                await Task.Delay(500);

                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForProfessorAnnouncement = false;

                isSaveAnnouncementAsProfessorSuccessful = false;
                saveAnnouncementAsProfessorMessage = "Κάποιο πρόβλημα παρουσιάστηκε με την Δημιουργία της Ανακοίνωσης! Ανανεώστε την σελίδα και προσπαθήστε ξανά";
                Console.WriteLine($"Error saving announcement: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
                StateHasChanged();
            }
        }

        private async Task HandleProfessorAnnouncementValidationErrorWhenSaveAnnouncementAsProfessor()
        {
            showLoadingModalForProfessorAnnouncement = false;
            showErrorMessageforUploadingannouncementsAsProfessor = true;
            StateHasChanged();
        }

        private async Task HandleProfessorNotFoundErrorWhenSaveAnnouncementAsProfessor()
        {
            showLoadingModalForProfessorAnnouncement = false;
            isSaveAnnouncementAsProfessorSuccessful = false;
            saveAnnouncementAsProfessorMessage = "Ο Καθηγητής δεν βρέθηκε στο σύστημα";
            StateHasChanged();
        }

        private async Task UpdateProgressWhenSaveAnnouncementAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private bool showLoadingModalForProfessorThesis = false;
        private async Task SaveThesisToDatabaseAsProfessor()
        {
            // Show loading modal and reset progress
            showLoadingModalForProfessorThesis = true;
            loadingProgress = 0;
            showErrorMessageforUploadingThesisAsProfessor = false;
            isSaveThesisAsProfessorSuccessful = false;
            StateHasChanged();

            try
            {
                // Step 1: Validation checks
                await UpdateProgressWhenSaveThesisAsProfessor(20);
                if (string.IsNullOrWhiteSpace(professorthesis.ThesisTitle) ||
                    string.IsNullOrWhiteSpace(professorthesis.ThesisDescription) ||
                    !HasAnySelectionForProfessorThesis() ||
                    professorthesis.ThesisActivePeriod.Date <= DateTime.Today  ||
                    professorthesis.OpenSlots_ProfessorThesis < 3)
                {
                    await HandleProfessorThesisValidationErrorWhenSaveThesisAsProfessor();
                    return;
                }
                await UpdateProgressWhenSaveThesisAsProfessor(40);

                // Step 2: Check if professor exists or create new
                await UpdateProgressWhenSaveThesisAsProfessor(60);
                var professor = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == CurrentUserEmail);

                if (professor == null)
                {
                    professor = new Professor 
                    {
                        ProfEmail = CurrentUserEmail,
                        ProfName = professorName,
                        ProfSurname = professorSurname,
                        ProfDepartment = professorDepartment
                    };
                    dbContext.Professors.Add(professor);
                    await dbContext.SaveChangesAsync();
                }
                await UpdateProgressWhenSaveThesisAsProfessor(80);

                // Step 3: Set required fields
                await UpdateProgressWhenSaveThesisAsProfessor(90);
                professorthesis.ThesisUpdateDateTime = DateTime.Now;
                professorthesis.Professor = professor;

                // Step 4: Save the thesis
                dbContext.ProfessorTheses.Add(professorthesis);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveThesisAsProfessor(100);

                // Step 5: Success
                isSaveThesisAsProfessorSuccessful = true;
                saveThesisAsProfessorMessage = "Η Διπλωματική Εργασία Δημιουργήθηκε Επιτυχώς";

                // Small delay to show completion
                await Task.Delay(500);

                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForProfessorThesis = false;

                isSaveThesisAsProfessorSuccessful = false;
                saveThesisAsProfessorMessage = "Κάποιο πρόβλημα παρουσιάστηκε με την Δημιουργία της Διπλωματικής Εργασίας! Ανανεώστε την σελίδα και προσπαθήστε ξανά";
                Console.WriteLine($"Πρόβλημα Δημιουργίας/Αποθήκευσης: {ex.Message}\n{ex.StackTrace}");
                StateHasChanged();
            }
        }

        private async Task HandleProfessorThesisValidationErrorWhenSaveThesisAsProfessor()
        {
            showLoadingModalForProfessorThesis = false;
            showErrorMessageforUploadingThesisAsProfessor = true;
            StateHasChanged();

            // Optional: Scroll to top to show error message
            await JS.InvokeVoidAsync("scrollToTop");
        }

        private async Task UpdateProgressWhenSaveThesisAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        // Method to toggle Area selection
        private void ToggleAreaSelectionForThesisUploadAsProfessor(long areaId, object isChecked)
        {
            if ((bool)isChecked)
            {
                if (!selectedAreasForProfessorThesis.Contains(areaId))
                    selectedAreasForProfessorThesis.Add(areaId);
            }
            else
            {
                selectedAreasForProfessorThesis.Remove(areaId);
            }
            professorthesis.ThesisAreas = string.Join(",", selectedAreas); 
        }

        // Method to toggle Skill selection
        private void ToggleSkillSelectionForThesisUploadAsProfessor(long skillId, object isChecked)
        {
            if ((bool)isChecked)
            {
                if (!selectedSkillsForProfessorThesis.Contains(skillId))
                    selectedSkillsForProfessorThesis.Add(skillId);
            }
            else
            {
                selectedSkillsForProfessorThesis.Remove(skillId);
            }
            professorthesis.ThesisSkills = string.Join(",", selectedSkillsForProfessorThesis); 
        }

        private async Task ToggleCheckboxesForThesisAreasAsProfessor()
        {
            await JS.InvokeVoidAsync("toggleProfessorThesisAreasCheckboxes");
        }

        private async Task ToggleCheckboxesForThesisSkillsAsProfessor()
        {
            await JS.InvokeVoidAsync("toggleProfessorThesisSkillsCheckboxes");
        }

        private void OnCheckedChangedForThesisAreasAsProfessor(ChangeEventArgs e, Area area)
        {
            if ((bool)e.Value) // If checked
            {
                if (!selectedThesisAreasForProfessor.Contains(area))
                {
                    selectedThesisAreasForProfessor.Add(area);
                }
            }
            else // If unchecked
            {
                selectedThesisAreasForProfessor.Remove(area);
            }
        }


        private void OnCheckedChangedForThesisSkillsAsProfessor(ChangeEventArgs e, Skill skill)
        {
            if ((bool)e.Value) // If checked
            {
                if (!selectedThesisSkillsForProfessor.Contains(skill))
                {
                    selectedThesisSkillsForProfessor.Add(skill);
                }
            }
            else // If unchecked
            {
                selectedThesisSkillsForProfessor.Remove(skill);
            }
        }


        private bool IsSelectedForThesisAreasAsProfessor(Area area)
        {
            return selectedAreasForProfessorThesis.Contains(area.Id);
        }

        private bool IsSelectedForThesisSkillsAsProfessor(Skill skill)
        {
            return selectedSkillsForProfessorThesis.Contains(skill.Id);
        }


        private bool showLoadingModalForDeleteProfessorThesis = false;
        private async Task DeleteThesisAsProfessor(int professorThesisId)
        {
            // Show custom confirmation dialog with formatted text
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Διπλωματική Εργασία.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                // Show loading modal and reset progress
                showLoadingModalForDeleteProfessorThesis = true;
                loadingProgress = 0;
                StateHasChanged();

                try
                {
                    // Step 1: Find the thesis by ID
                    await UpdateProgressWhenDeleteThesisAsProfessor(30);
                    var professorthesis = await dbContext.ProfessorTheses.FindAsync(professorThesisId);

                    // Check if the thesis exists
                    if (professorthesis != null)
                    {
                        // Step 2: Remove the thesis from the database
                        await UpdateProgressWhenDeleteThesisAsProfessor(60);
                        dbContext.ProfessorTheses.Remove(professorthesis);
                        await dbContext.SaveChangesAsync();
                        await UpdateProgressWhenDeleteThesisAsProfessor(80);

                        // Step 3: Reload the theses to reflect the deletion
                        await UpdateProgressWhenDeleteThesisAsProfessor(90);
                        await LoadThesesAsProfessor();
                        await UpdateProgressWhenDeleteThesisAsProfessor(100);

                        // Small delay to show completion
                        await Task.Delay(300);
                    }
                    else
                    {
                        // Thesis not found - hide modal and show error
                        showLoadingModalForDeleteProfessorThesis = false;
                        await JS.InvokeVoidAsync("alert", "Η διπλωματική εργασία δεν βρέθηκε.");
                        StateHasChanged();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // Hide loading modal on error
                    showLoadingModalForDeleteProfessorThesis = false;

                    await JS.InvokeVoidAsync("alert", $"Σφάλμα κατά τη διαγραφή: {ex.Message}");
                    StateHasChanged();
                    return;
                }
                finally
                {
                    // Always hide the loading modal
                    showLoadingModalForDeleteProfessorThesis = false;
                }

                // Trigger UI refresh and navigation
                StateHasChanged();
                //NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
        }

        private async Task UpdateProgressWhenDeleteThesisAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private void CloseModalForProfessorThesis()
        {
            isModalVisibleToShowProfessorThesisDetails = false; // Hide the modal
        }  


        private void ShowProfessorThesisDetailsAsStudent(ProfessorThesisApplied professorthesisdetails)
        {
            currentProfessorThesisToShowDetailsAsStudent = professorthesisdetails;
            isModalVisibleForProfessorThesisToShowDetailsAsStudent = true;
        }

        private void ShowCompanyThesisDetailsAsStudent(CompanyThesis companythesisdetails)
        {
            currentCompanyThesisToShowDetailsAsStudent = companythesisdetails;
            isModalVisibleForCompanyThesisToShowDetailsAsStudent = true;
        }

        private async Task ShowProfessorThesisDetailsAsStudent(long thesisId)
        {
            // Fetch the thesis details based on the thesisId
            selectedProfessorThesisDetails = await dbContext.ProfessorTheses
                .FirstOrDefaultAsync(t => t.RNGForThesisUploaded == thesisId);

            // Show the modal after fetching the details
            StateHasChanged();
            await JS.InvokeVoidAsync("showProfessorThesisDetailsModal"); // Show the modal using JS
        }

        private async Task ShowCompanyThesisDetailsAsStudent(long thesisId)
        {
            // Fetch the company thesis details based on the thesisId
            selectedCompanyThesisDetails = await dbContext.CompanyTheses
                .FirstOrDefaultAsync(t => t.RNGForThesisUploadedAsCompany == thesisId);

            // Show the modal after fetching the details
            StateHasChanged();
            await JS.InvokeVoidAsync("showCompanyThesisDetailsModal"); // Show the modal using JS
        }

        private async Task ShowCompanyInternshipDetailsAsStudent(long thesisId)
        {
            isModalVisibleForInternshipsAsStudent = true;
            selectedCompanyInternshipDetails = await dbContext.CompanyInternships
                .Include(i => i.Company) // Include company data
                .FirstOrDefaultAsync(t => t.RNGForInternshipUploadedAsCompany == thesisId); // Updated property name

            // Assign selectedCompanyInternshipDetails to currentInternship
            currentInternship = selectedCompanyInternshipDetails;

            // Show the modal after fetching the details
            StateHasChanged();
            await JS.InvokeVoidAsync("showCompanyInternshipDetailsModal"); // Show the modal using JS
        }

        private async Task ShowProfessorInternshipDetailsAsStudent(long thesisId)
        {
            try
            {
                isModalVisibleForProfessorInternshipsAsStudent = true;

                // Fetch internship details with professor information
                selectedProfessorInternshipDetails = await dbContext.ProfessorInternships
                    .Include(i => i.Professor)  // Include professor details
                    .FirstOrDefaultAsync(t => t.RNGForInternshipUploadedAsProfessor == thesisId);  // Updated property name

                // Assign selectedProfessorInternshipDetails to currentProfessorInternship
                currentProfessorInternship = selectedProfessorInternshipDetails;

                if (currentProfessorInternship == null)
                {
                    await JS.InvokeVoidAsync("alert", "Internship details not found");
                    isModalVisibleForProfessorInternshipsAsStudent = false;
                    return;
                }

                // Show the modal after fetching the details
                StateHasChanged();
                await JS.InvokeVoidAsync("showProfessorInternshipDetailsModal"); // Show the modal using JS
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading internship details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Error loading internship details");
                isModalVisibleForProfessorInternshipsAsStudent = false;
            }
        }

        private void CloseProfessorInternshipDetailsModal()
        {
            isModalVisibleForProfessorInternshipsAsStudent = false;
            StateHasChanged();
        }


        private async Task CloseModalForProfessorThesisDetails()
        {
            selectedProfessorThesisDetails = null; // Reset the selected thesis details
            await JS.InvokeVoidAsync("hideProfessorThesisDetailsModal"); // Close the modal using JS
            StateHasChanged(); // Update the UI
        }

        private async Task CloseModalForCompanyThesisDetails()
        {
            selectedCompanyThesisDetails = null; // Reset the selected thesis details
            await JS.InvokeVoidAsync("hideCompanyThesisDetailsModal"); // Close the modal using JS
            StateHasChanged(); // Update the UI
        }

        private async Task CloseModalForCompanyInternshipDetails()
        {
            isModalVisibleForInternships = false;
            selectedCompanyInternshipDetails = null; // Reset the selected thesis details
            await JS.InvokeVoidAsync("hideCompanyInternshipDetailsModal"); // Close the modal using JS
            StateHasChanged(); // Update the UI
        }


        private async Task ShowProfessorHyperlinkNameDetailsModalInStudentThesis(string professorEmail)
        {
            // Fetch professor details based on the professorId
            selectedProfessorDetailsForHyperlinkNameInThesisAsStudent = await dbContext.Professors
                .FirstOrDefaultAsync(p => p.ProfEmail == professorEmail);

            // Show the modal after fetching the details
            StateHasChanged();
            await JS.InvokeVoidAsync("showProfessorDetailsModal"); // Show the modal using JS
        }

        private async Task ShowCompanyHyperlinkNameDetailsModalInStudentThesis(string companyEmail)
        {
            selectedCompanyDetailsForHyperlinkNameInThesisAsStudent = await dbContext.Companies
                .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

            if (selectedCompanyDetailsForHyperlinkNameInThesisAsStudent != null)
            {
                isCompanyDetailsModalOpenForHyperlinkNameAsStudent = true;
                StateHasChanged();
                await JS.InvokeVoidAsync("showCompanyDetailsModal"); // Show the modal using JS
            }
        }


        void CloseModalForProfessorNameHyperlinkDetails()
        {
            selectedProfessorDetailsForHyperlinkNameInThesisAsStudent = null;
            StateHasChanged(); // Ensure the Razor component updates
            JS.InvokeVoidAsync("hideProfessorDetailsModal"); // Call JS to hide the modal
        }

        void CloseModalForCompanyNameHyperlinkDetails()
        {
            isCompanyDetailsModalOpenForHyperlinkNameAsStudent = false;
            selectedCompanyDetailsForHyperlinkNameInThesisAsStudent = null;
            StateHasChanged(); // Ensure the Razor component updates
            JS.InvokeVoidAsync("hideCompanyDetailsModal"); // Call JS to hide the modal
        }

        private string ShowProfileImage(byte[] imageBytes)
        {
            if (imageBytes != null)
            {
                var base64Image = Convert.ToBase64String(imageBytes);
                return $"data:image/png;base64,{base64Image}"; // Assuming the image is in PNG format
            }
            return string.Empty;
        }

        private async Task SearchCompanyThesesAsProfessor()
        {
            var query = dbContext.CompanyTheses
                .Include(t => t.Company)
                .Where(t =>
                    t.CompanyThesisStatus == "Δημοσιευμένη" &&
                    (t.IsProfessorInterestedInCompanyThesisStatus == "Δεν έχει γίνει Αποδοχή" || 
                    t.IsProfessorInterestedInCompanyThesisStatus == "Έχετε Αποδεχτεί"));

            // Apply search filters
            if (!string.IsNullOrEmpty(searchCompanyNameToFindThesesAsProfessor))
            {
                query = query.Where(t => t.Company != null && 
                                    EF.Functions.Like(t.Company.CompanyName, $"%{searchCompanyNameToFindThesesAsProfessor}%"));
            }

            if (!string.IsNullOrEmpty(searchThesisTitleToFindThesesAsProfessor))
            {
                query = query.Where(t => EF.Functions.Like(t.CompanyThesisTitle, $"%{searchThesisTitleToFindThesesAsProfessor}%"));
            }

            if (!string.IsNullOrEmpty(searchSupervisorToFindThesesAsProfessor))
            {
                query = query.Where(t => EF.Functions.Like(t.CompanyThesisCompanySupervisorFullName, $"%{searchSupervisorToFindThesesAsProfessor}%"));
            }

            if (!string.IsNullOrEmpty(searchDepartmentToFindThesesAsProfessor))
            {
                query = query.Where(t => EF.Functions.Like(t.CompanyThesisDepartment, $"%{searchDepartmentToFindThesesAsProfessor}%"));
            }

            if (searchStartingDateToFindThesesAsProfessor.HasValue)
            {
                query = query.Where(t => t.CompanyThesisStartingDate.Date >= searchStartingDateToFindThesesAsProfessor.Value.Date);
            }

            // Execute the query first
            var initialQuery = await query
                .OrderByDescending(t => t.CompanyThesisUploadDateTime)
                .ToListAsync();

            // Apply in-memory filtering for selected skills
            if (selectedSkillsToFindThesesAsProfessor.Any())
            {
                initialQuery = initialQuery
                    .Where(t => selectedSkillsToFindThesesAsProfessor.All(skill => 
                        t.CompanyThesisSkillsNeeded != null && t.CompanyThesisSkillsNeeded.Contains(skill)))
                    .ToList();
            }

            companyThesesResultsToFindThesesAsProfessor = initialQuery;
            searchPerformedToFindThesesAsProfessor = true;
            StateHasChanged();
        }



        private async Task SearchProfessorThesesAsCompany()
        {
            var query = dbContext.ProfessorTheses
                .Include(t => t.Professor)
                .Where(t =>
                    t.ThesisStatus == "Δημοσιευμένη" &&
                    (t.IsCompanyInterestedInProfessorThesisStatus == "Δεν έχει γίνει Αποδοχή" ||
                    t.IsCompanyInterestedInProfessorThesisStatus == "Έχετε Αποδεχτεί"));

            // Apply search filters
            if (!string.IsNullOrEmpty(searchProfessorNameToFindThesesAsCompany))
            {
                query = query.Where(t => t.Professor != null && 
                                    t.Professor.ProfName.Contains(searchProfessorNameToFindThesesAsCompany));
            }

            if (!string.IsNullOrEmpty(searchProfessorThesisTitleToFindThesesAsCompany))
            {
                query = query.Where(t => t.ThesisTitle.Contains(searchProfessorThesisTitleToFindThesesAsCompany));
            }

            if (!string.IsNullOrEmpty(searchProfessorSurnameToFindThesesAsCompany))
            {
                query = query.Where(t => t.Professor != null && 
                                    t.Professor.ProfSurname.Contains(searchProfessorSurnameToFindThesesAsCompany));
            }

            if (searchStartingDateToFindThesesAsCompany.HasValue)
            {
                query = query.Where(t => t.ThesisActivePeriod.Date >= searchStartingDateToFindThesesAsCompany.Value.Date);
            }

            // Execute the initial query
            var initialQuery = await query.ToListAsync();

            // Apply in-memory filtering for selected areas (including subfields)
            if (selectedAreasToFindThesesAsCompany.Any())
            {
                initialQuery = initialQuery
                    .Where(t => 
                    {
                        if (string.IsNullOrEmpty(t.ThesisAreas))
                            return false;

                        var thesisAreas = NormalizeAreas(t.ThesisAreas).ToList();
                        var expandedThesisAreas = ExpandAreasWithSubfields(thesisAreas);

                        return selectedAreasToFindThesesAsCompany.Any(selectedArea =>
                        {
                            var normalizedSelectedArea = selectedArea.Trim().ToLower();

                            // Check if any of the thesis areas match the selected area
                            return expandedThesisAreas.Any(thesisArea =>
                                thesisArea.Contains(normalizedSelectedArea) || 
                                normalizedSelectedArea.Contains(thesisArea));
                        });
                    })
                    .ToList();
            }

            // Apply in-memory filtering for selected skills
            if (selectedSkillsToFindThesesAsCompany.Any())
            {
                initialQuery = initialQuery
                    .Where(t => selectedSkillsToFindThesesAsCompany.All(skill => 
                        t.ThesisSkills != null && t.ThesisSkills.Contains(skill)))
                    .ToList();
            }

            professorThesesResultsToFindThesesAsCompany = initialQuery;
            searchPerformedToFindThesesAsCompany = true;
            StateHasChanged();
        }




        private void ClearSearchFieldsForSearchCompanyThesesAsProfessor()
        {
            // Reset search input fields
            searchCompanyNameToFindThesesAsProfessor = string.Empty;
            searchThesisTitleToFindThesesAsProfessor = string.Empty;
            searchSupervisorToFindThesesAsProfessor = string.Empty;
            searchDepartmentToFindThesesAsProfessor = string.Empty;
            searchAreasToFindThesesAsCompany = string.Empty;
            searchSkillsInputToFindThesesAsProfessor = string.Empty;
            searchStartingDateToFindThesesAsProfessor = null;

            // Clear selected skills
            selectedSkillsToFindThesesAsProfessor.Clear();

            // Clear search results - check for null first
            companyThesesResultsToFindThesesAsProfessor?.Clear();
            searchPerformedToFindThesesAsProfessor = false;

            // Clear autocomplete suggestions
            companyNameSuggestions.Clear();
            skillSuggestionsToFindThesesAsProfessor.Clear();

            // Trigger UI update
            StateHasChanged();
        }

        private void ShowThesisDetails(CompanyThesis thesis)
        {
            selectedCompanyThesisToSeeDetailsOnEyeIconAsProfessor = thesis;
            isThesisDetailEyeIconModalVisibleToSeeAsProfessor = true; // Assume this boolean controls the modal visibility
        }

        private void ShowThesisDetailsAsCompany(ProfessorThesis thesis)
        {
            selectedProfessorThesisToSeeDetailsOnEyeIconAsCompany = thesis;
            isThesisDetailEyeIconModalVisibleToSeeAsCompany = true; // Assume this boolean controls the modal visibility
        }


        private async Task ShowCompanyDetailsFromHyperlinkNameToTheProfessor(string companyEmail)
        {
            try
            {
                // Load the company details from database
                selectedCompanyToSeeDetailsOnExpandedInterestAsProfessor = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

                if (selectedCompanyToSeeDetailsOnExpandedInterestAsProfessor != null)
                {
                    // Update Blazor state
                    isExpandedModalVisibleToSeeCompanyDetailsAsProfessor = true;
                    StateHasChanged();

                    // Call JavaScript to show the modal
                    await JS.InvokeVoidAsync("showCompanyDetailsAsProfessorModal", "companyDetailsWhenSearchAsProfessorThesisDetailsModal");
                }
                else
                {
                    Console.WriteLine("Company not found with email: " + companyEmail);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error showing company details: {ex.Message}");
            }
        }

        private async Task CloseCompanyModalToShowCompanyDetailsFromHyperlinkNameToTheProfessor()
        {
            try
            {
                // Close the modal via JavaScript first
                await JS.InvokeVoidAsync("hideCompanyDetailsAsProfessorModal", "companyDetailsWhenSearchAsProfessorThesisDetailsModal");

                // Then reset the state
                isExpandedModalVisibleToSeeCompanyDetailsAsProfessor = false;
                selectedCompanyToSeeDetailsOnExpandedInterestAsProfessor = null;

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error closing modal: {ex.Message}");
            }
        }

        //EDW PREPEI NA PAIRNEI KAI TA ALLA INFO APO PROFESSOR/TO MODELO EXEI GINIE IDI UPDATE 27/11
        private bool showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
        private int loadingProgressWhenMarkInterestInCompanyThesisAsProfessor = 0;
        private async Task MarkInterestInThesisCompanyThesisAsProfessor(CompanyThesis thesis)
        {
            try
            {
                // First ask for confirmation
                var companyName = thesis.Company?.CompanyName ?? "Άγνωστη Εταιρεία";
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να δείξετε ενδιαφέρον για την Διπλωματική Εργασία: {thesis.CompanyThesisTitle} της Εταιρείας {companyName}. Είστε σίγουρος/η;");

                if (!confirmed) return;

                // Show loading modal after user confirms
                showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = true;
                loadingProgressWhenMarkInterestInCompanyThesisAsProfessor = 0;
                StateHasChanged();

                // Step 1: Initial checks and logging
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(10, 200);
            
                Console.WriteLine($"RNGForThesisUploadedAsCompany: {thesis.RNGForThesisUploadedAsCompany}");
                Console.WriteLine($"CurrentUserEmail: {CurrentUserEmail}");

                // Check if ANY professor already showed interest for this thesis
                if (thesis.IsProfessorInteresetedInCompanyThesis && 
                    !string.IsNullOrWhiteSpace(thesis.ProfessorEmailInterestedInCompanyThesis))
                {
                    showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
                    StateHasChanged();
                
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Η Διπλωματική εργασία δεν είναι πλέον διαθέσιμη. Έχει ήδη εκδηλωθεί ενδιαφέρον από άλλο καθηγητή.").AsTask());
                    return;
                }

                // Check if THIS specific professor already showed interest
                if (thesis.ProfessorEmailInterestedInCompanyThesis == CurrentUserEmail && 
                    thesis.IsProfessorInteresetedInCompanyThesis)
                {
                    showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
                    StateHasChanged();
                
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Έχετε ήδη δείξει ενδιαφέρον για αυτήν την Διπλωματική εργασία").AsTask());
                    return;
                }

                // Step 2: Get professor details
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(30, 200);
            
                var professor = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == CurrentUserEmail);

                if (professor == null)
                {
                    showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
                    StateHasChanged();
                
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Δεν βρέθηκαν στοιχεία καθηγητή").AsTask());
                    return;
                }

                // Step 3: Update thesis with professor's interest
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(50, 200);
            
                thesis.IsProfessorInteresetedInCompanyThesis = true;
                thesis.ProfessorEmailInterestedInCompanyThesis = CurrentUserEmail;
                thesis.IsProfessorInterestedInCompanyThesisStatus = "Έχετε Αποδεχτεί";
                thesis.ProfessorInterested = professor; // Set navigation property

                // Step 4: Create platform action
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(70, 200);
            
                var platformAction = new PlatformActions
                {
                    UserRole_PerformedAction = "PROFESSOR",
                    ForWhat_PerformedAction = "COMPANY_THESIS",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(thesis.RNGForThesisUploadedAsCompany),
                    TypeOfAction_PerformedAction = "SHOW_INTEREST",
                    DateTime_PerformedAction = DateTime.Now
                };

                dbContext.PlatformActions.Add(platformAction);
                dbContext.CompanyTheses.Update(thesis);
                await dbContext.SaveChangesAsync();

                // Step 5: Send notifications
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(80, 200);
            
                await InternshipEmailService.SendCompanyThesisInterestNotificationToCompany(
                    thesis.CompanyEmailUsedToUploadThesis,
                    companyName,
                    professor.ProfName,
                    professor.ProfSurname,
                    professor.ProfUniversity,
                    professor.ProfDepartment,
                    professor.ProfWorkTelephone,
                    professor.ProfPersonalTelephoneVisibility ? professor.ProfPersonalTelephone : null,
                    professor.ProfPersonalWebsite,
                    thesis.CompanyThesisTitle,
                    thesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID);

                await InternshipEmailService.SendCompanyThesisInterestConfirmationToProfessor(
                    CurrentUserEmail,
                    $"{professor.ProfName} {professor.ProfSurname}",
                    thesis.CompanyThesisTitle,
                    thesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID,
                    companyName);

                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(90, 200);

                // Step 6: Load updated thesis data
                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(95, 200);
                await LoadThesisData();

                await UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(100, 200);
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Hide loading modal before showing success message
                showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
                StateHasChanged();
            
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    "Ολοκληρώθηκε", 
                    "Επιτυχής ένδειξη ενδιαφέροντος").AsTask());
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenMarkInterestInCompanyThesisAsProfessor = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving interest: {ex.Message}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    "Απέτυχε", 
                    "Σφάλμα κατά την αποθήκευση").AsTask());
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenMarkInterestInCompanyThesisAsProfessor(int current, int total)
        {
            loadingProgressWhenMarkInterestInCompanyThesisAsProfessor = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }



        private bool showLoadingModalWhenMarkInterestInProfessorThesis = false;
        private int loadingProgressWhenMarkInterestInProfessorThesis = 0;
        private async Task MarkInterestInProfessorThesis(ProfessorThesis thesis)
        {
            try
            {
                // First ask for confirmation
                var professorName = $"{thesis.Professor?.ProfName} {thesis.Professor?.ProfSurname}" ?? "Άγνωστος Καθηγητής";
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να δείξετε ενδιαφέρον για την Διπλωματική Εργασία: {thesis.ThesisTitle} του/της Καθηγητή/τριας {professorName}. Είστε σίγουρος/η;");

                if (!confirmed)
                {
                    return; // User cancelled the action
                }

                // Show loading modal after user confirms
                showLoadingModalWhenMarkInterestInProfessorThesis = true;
                loadingProgressWhenMarkInterestInProfessorThesis = 0;
                StateHasChanged();

                // Step 1: Initial checks and logging
                await UpdateProgressWhenMarkInterestInProfessorThesis(10, 200);
            
                Console.WriteLine($"RNGForThesisUploaded: {thesis.RNGForThesisUploaded}");
                Console.WriteLine($"CurrentUserEmail: {CurrentUserEmail}");

                // Check if ANY company already showed interest for this thesis
                if (thesis.IsCompanyInteresetedInProfessorThesis && 
                    !string.IsNullOrWhiteSpace(thesis.CompanyEmailInterestedInProfessorThesis))
                {
                    showLoadingModalWhenMarkInterestInProfessorThesis = false;
                    StateHasChanged();
                
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Η Διπλωματική εργασία δεν είναι πλέον διαθέσιμη. Έχει ήδη εκδηλωθεί ενδιαφέρον από άλλη εταιρεία.").AsTask());
                    return;
                }

                // Check if THIS specific company already showed interest
                if (thesis.CompanyEmailInterestedInProfessorThesis == CurrentUserEmail && 
                    thesis.IsCompanyInteresetedInProfessorThesis)
                {
                    showLoadingModalWhenMarkInterestInProfessorThesis = false;
                    StateHasChanged();
                
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Έχετε ήδη δείξει ενδιαφέρον για αυτήν την Διπλωματική εργασία").AsTask());
                    return;
                }

                // Step 2: Get company details
                await UpdateProgressWhenMarkInterestInProfessorThesis(30, 200);
            
                var company = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == CurrentUserEmail);

                if (company == null)
                {
                    showLoadingModalWhenMarkInterestInProfessorThesis = false;
                    StateHasChanged();
                
                    Console.WriteLine("Company not found in database");
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("showToast", 
                        "error", 
                        "Δεν βρέθηκαν στοιχεία εταιρείας").AsTask());
                    return;
                }

                // Step 3: Update thesis with company interest
                await UpdateProgressWhenMarkInterestInProfessorThesis(50, 200);
            
                thesis.IsCompanyInteresetedInProfessorThesis = true;
                thesis.IsCompanyInterestedInProfessorThesisStatus = "Έχετε Αποδεχτεί";
                thesis.CompanyEmailInterestedInProfessorThesis = CurrentUserEmail;
                thesis.CompanyInterested = company;  // Set navigation property
                thesis.ThesisUpdateDateTime = DateTime.Now;

                // Update the existing record in the database
                dbContext.ProfessorTheses.Update(thesis);

                // Step 4: Create platform action
                await UpdateProgressWhenMarkInterestInProfessorThesis(70, 200);
            
                var platformAction = new PlatformActions
                {
                    UserRole_PerformedAction = "COMPANY",
                    ForWhat_PerformedAction = "PROFESSOR_THESIS",
                    HashedPositionRNG_PerformedAction = thesis.RNGForThesisUploaded_HashedAsUniqueID,
                    TypeOfAction_PerformedAction = "SHOW_INTEREST",
                    DateTime_PerformedAction = DateTime.Now
                };
                dbContext.PlatformActions.Add(platformAction);

                // Save changes to the database
                await dbContext.SaveChangesAsync();

                // Step 5: Send notifications
                await UpdateProgressWhenMarkInterestInProfessorThesis(80, 200);
            
                await InternshipEmailService.SendProfessorThesisInterestNotificationToProfessor(
                    thesis.ProfessorEmailUsedToUploadThesis,
                    professorName,
                    company.CompanyName,
                    company.CompanyHRName,
                    company.CompanyHRSurname,
                    company.CompanyHREmail,
                    company.CompanyHRTelephone,
                    thesis.ThesisTitle,
                    thesis.RNGForThesisUploaded_HashedAsUniqueID);

                await InternshipEmailService.SendProfessorThesisInterestConfirmationToCompany(
                    CurrentUserEmail,
                    company.CompanyName,
                    company.CompanyHRName,
                    company.CompanyHRSurname,
                    thesis.ThesisTitle,
                    thesis.RNGForThesisUploaded_HashedAsUniqueID,
                    professorName);

                await UpdateProgressWhenMarkInterestInProfessorThesis(90, 200);

                // Step 6: Load updated thesis data
                await UpdateProgressWhenMarkInterestInProfessorThesis(95, 200);
                await LoadThesisData();

                await UpdateProgressWhenMarkInterestInProfessorThesis(100, 200);
            
                // Small delay to show completion
                await Task.Delay(500);
            
                // Hide loading modal before showing success message
                showLoadingModalWhenMarkInterestInProfessorThesis = false;
                StateHasChanged();
            
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    "Ολοκληρώθηκε", 
                    "Επιτυχής ένδειξη ενδιαφέροντος").AsTask());
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenMarkInterestInProfessorThesis = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving interest: {ex.Message}");
                Console.WriteLine($"Stack Trace: {ex.StackTrace}");
                await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    "Απέτυχε", 
                    "Σφάλμα κατά την αποθήκευση").AsTask());
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenMarkInterestInProfessorThesis(int current, int total)
        {
            loadingProgressWhenMarkInterestInProfessorThesis = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }





        private async Task<bool> IsProfessorInterestedInThesis(CompanyThesis thesis)
        {
            var isInterested = await dbContext.CompanyTheses
                .AnyAsync(x => x.ProfessorEmailInterestedInCompanyThesis == CurrentUserEmail 
                            && x.RNGForThesisUploadedAsCompany == thesis.RNGForThesisUploadedAsCompany);

            // Log the executed condition
            Console.WriteLine($"Checking Thesis ID: {thesis.RNGForThesisUploadedAsCompany}, " +
                            $"Professor Email: {CurrentUserEmail}, Result: {isInterested}");

            return isInterested;
        }

        public class ThesisWithInterestStatus
        {
            public CompanyThesis Thesis { get; set; }
            public bool IsInterested { get; set; }
        }

        public class ProfessorThesisWithInterestStatus
        {
            public ProfessorThesis ProfessorThesis { get; set; }
            public bool IsInterested { get; set; }
        }

        private async Task LoadThesisData()
        {
            var theses = await dbContext.CompanyTheses.ToListAsync();

            // Create a list to store the status for each thesis
            thesesWithInterestStatus = theses.Select(thesis => new ThesisWithInterestStatus
            {
                Thesis = thesis,
                IsInterested = thesis.ProfessorEmailInterestedInCompanyThesis == CurrentUserEmail
            }).ToList();
        }

        private async Task LoadProfessorThesisData()
        {
            var theses = await dbContext.ProfessorTheses.ToListAsync();

            // Create a list to store the status for each thesis
            professorthesesWithInterestStatus = theses.Select(thesis => new ProfessorThesisWithInterestStatus
            {
                ProfessorThesis = thesis,
                IsInterested = thesis.CompanyEmailInterestedInProfessorThesis == CurrentUserEmail
            }).ToList();
        }

        private async Task ShowProfessorDetailsAtCompanyThesisInterest(CompanyThesis companyThesis)
        {
            try
            {
                // Try to get professor from navigation property first
                if (companyThesis.ProfessorInterested == null && 
                    !string.IsNullOrEmpty(companyThesis.ProfessorEmailInterestedInCompanyThesis))
                {
                    // Explicitly load the professor if not already loaded
                    await dbContext.Entry(companyThesis)
                        .Reference(t => t.ProfessorInterested)
                        .LoadAsync();
                }

                // Use the navigation property if available
                currentProfessorDetails = companyThesis.ProfessorInterested;

                if (currentProfessorDetails == null)
                {
                    // Create minimal professor object with just the email if no professor found
                    currentProfessorDetails = new Professor
                    {
                        ProfEmail = companyThesis.ProfessorEmailInterestedInCompanyThesis
                    };
                }

                isModalVisibleToShowprofessorDetailsAtCompanyThesisInterest = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor details: {ex.Message}");
                currentProfessorDetails = new Professor();
                isModalVisibleToShowprofessorDetailsAtCompanyThesisInterest = true;
            }
        }


        private void ShowCompanyDetailsAtProfessorThesisInterestFromHyperlinkCompanyName(ProfessorThesis professorThesis)
        {
            if (professorThesis?.CompanyInterested != null)
            {
                currentCompanyDetails = new Company
                {
                    CompanyLogo = professorThesis.CompanyInterested.CompanyLogo,
                    CompanyNameENG = professorThesis.CompanyInterested.CompanyName,
                    CompanyEmail = professorThesis.CompanyInterested.CompanyEmail,
                    CompanyType = professorThesis.CompanyInterested.CompanyType,
                    CompanyActivity = professorThesis.CompanyInterested.CompanyActivity,
                    CompanyTelephone = professorThesis.CompanyInterested.CompanyTelephone,
                    CompanyWebsite = professorThesis.CompanyInterested.CompanyWebsite,
                    CompanyWebsiteAnnouncements = professorThesis.CompanyInterested.CompanyWebsiteAnnouncements,
                    CompanyWebsiteJobs = professorThesis.CompanyInterested.CompanyWebsiteJobs,
                    CompanyCountry = professorThesis.CompanyInterested.CompanyCountry,
                    CompanyLocation = professorThesis.CompanyInterested.CompanyLocation,
                    CompanyPC = professorThesis.CompanyInterested.CompanyPC,
                    CompanyRegions = professorThesis.CompanyInterested.CompanyRegions,
                    CompanyTown = professorThesis.CompanyInterested.CompanyTown,
                    CompanyDescription = professorThesis.CompanyInterested.CompanyDescription,
                    CompanyAreas = professorThesis.CompanyInterested.CompanyAreas,
                    CompanyDesiredSkills = professorThesis.CompanyInterested.CompanyDesiredSkills,
                    CompanyHRName = professorThesis.CompanyInterested.CompanyHRName,
                    CompanyHRSurname = professorThesis.CompanyInterested.CompanyHRSurname,
                    CompanyHREmail = professorThesis.CompanyInterested.CompanyHREmail,
                    CompanyHRTelephone = professorThesis.CompanyInterested.CompanyHRTelephone,
                    RnD_HeadName = professorThesis.CompanyInterested.RnD_HeadName,
                    RnD_ContactPersonFullName = professorThesis.CompanyInterested.RnD_ContactPersonFullName,
                    RnD_ContactPersonEmail = professorThesis.CompanyInterested.RnD_ContactPersonEmail
                };

                isModalVisibleToShowCompanyDetailsAtProfessorThesisInterest = true;
            }
        }


        private async Task CloseModalWhichShowsProfessorDetailsAtCompanyThesisInterest()
        {
            await JS.InvokeVoidAsync("hideProfessorDetailsModalForThesisInterest");
        }

        private async Task CloseModalWhichShowsCompanyDetailsAtProfessorThesisInterest()
        {
            await JS.InvokeVoidAsync("hideCompanyDetailsModalForThesisInterest");
        }

        private void ClearSearchFieldsForSearchProfessorThesesAsCompany()
        {
            searchProfessorNameToFindThesesAsCompany = string.Empty;
            searchProfessorThesisTitleToFindThesesAsCompany = string.Empty;
            searchProfessorSurnameToFindThesesAsCompany = string.Empty;
            searchSkillsInputToFindThesesAsCompany = string.Empty;
            searchStartingDateToFindThesesAsCompany = DateTime.Now;
            searchAreasInputToFindThesesAsCompany = string.Empty;

            selectedAreasToFindThesesAsCompany.Clear(); 
            selectedSkillsToFindThesesAsCompany.Clear(); // Clear selected skills

            professorThesesResultsToFindThesesAsCompany = null;
            searchPerformedToFindThesesAsCompany = false;

            // Clear suggestions
            professorNameSuggestions.Clear();
            professorSurnameSuggestions.Clear();
            skillSuggestionsToFindThesesAsCompany.Clear();
            areaSuggestionsToFindThesesAsCompany.Clear();
        }




        private void CheckCharacterLimitInCompanyEventDescription(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInCompanyEventDescription = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInProfessorEventDescription(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInProfessorEventDescription = 1000 - inputText.Length;
        }

        private void CheckCharacterLimitInEventTitleField(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInEventTitleField = 120 - inputText.Length;
        }

        private async Task HandleTemporarySaveCompanyEvent()
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Είστε σίγουροι πως θέλετε να <strong style='color: blue;'>Υποβάλετε</strong> την Εκδήλωση;<br><br>" +
                "Η εκδήλωση θα καταχωρηθεί ως <strong style='color: red;'>'Μη Δημοσιευμένη'</strong>.<br><br>" +
                "Θέλετε να συνεχίσετε;");

            if (isConfirmed)
            {
                await SaveCompanyEvent(false); 
            }
        }

        private async Task HandlePublishSaveCompanyEvent()
        {
            // Show custom confirmation dialog with formatted text
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Είστε σίγουροι πως θέλετε να <strong style='color: green;'>Υποβάλετε</strong> την Εκδήλωση;<br><br>" +
                "Η εκδήλωση θα καταχωρηθεί ως <strong style='color: green;'>'Δημοσιευμένη'</strong>.<br><br>" +
                "Θέλετε να συνεχίσετε;");

            if (isConfirmed)
            {
                await SaveCompanyEvent(true); 
            }
        }

        private bool showLoadingModalForEvent = false;
        private async Task SaveCompanyEvent(bool publishEvent)
        {
            // Show loading modal and reset progress
            showLoadingModalForEvent = true;
            loadingProgress = 0;
            showErrorMessageForUploadingCompanyEvent = false;
            showSuccessMessage = false;
            StateHasChanged();

            try
            {
                // Step 1: Build areas of interest
                await UpdateProgressWhenSaveEventAsCompany(10);
                var selectedAreas = new List<string>();

                // Add selected main areas
                foreach (var area in SelectedAreasWhenUploadEventAsCompany)
                {
                    selectedAreas.Add(area.AreaName);
                }

                // Add selected subfields as areas (without the area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForCompanyEvent)
                {
                    foreach (var subField in areaSubFields.Value)
                    {
                        selectedAreas.Add(subField);
                    }
                }

                companyEvent.CompanyEventAreasOfInterest = string.Join(",", selectedAreas);
                await UpdateProgressWhenSaveEventAsCompany(20);

                // Step 2: Validation checks
                await UpdateProgressWhenSaveEventAsCompany(30);
                if (string.IsNullOrWhiteSpace(companyEvent.CompanyEventTitle) || 
                    string.IsNullOrWhiteSpace(companyEvent.CompanyEventDescription) || 
                    companyEvent.CompanyEventActiveDate <= DateTime.Today ||
                    companyEvent.CompanyEventTimeOnly == TimeOnly.MinValue ||
                    companyEvent.CompanyEventOfferingTransportToEventLocation == null ||
                    !HasAnySelectionForCompanyEvent())
                {
                    await HandleEventValidationErrorWhenSaveEventAsCompany();
                    return;
                }
                await UpdateProgressWhenSaveEventAsCompany(40);

                // Step 3: Database operations
                await UpdateProgressWhenSaveEventAsCompany(50);
                if (dbContext.Entry(companyEvent).State == EntityState.Detached)
                {
                    dbContext.CompanyEvents.Add(companyEvent);
                }

                companyEvent.RNGForEventUploadedAsCompany = new Random().NextInt64();
                companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID = HashingHelper.HashLong(companyEvent.RNGForEventUploadedAsCompany);
                companyEvent.CompanyEventStatus = publishEvent ? "Δημοσιευμένη" : "Μη Δημοσιευμένη";
                companyEvent.CompanyEventUploadedDate = DateTime.Now;
                companyEvent.CompanyEventTime = companyEvent.CompanyEventTimeOnly.ToTimeSpan();

                // Set contact information
                companyEvent.CompanyEventResponsiblePerson = $"{companyData.CompanyHRName} {companyData.CompanyHRSurname}";
                companyEvent.CompanyEventResponsiblePersonEmail = companyData.CompanyHREmail;
                companyEvent.CompanyEventResponsiblePersonTelephone = companyData.CompanyHRTelephone;
                companyEvent.CompanyEventCompanyDepartment = companyEvent.CompanyEventCompanyDepartment;

                // Set foreign key using companyData instead of Company
                companyEvent.CompanyEmailUsedToUploadEvent = companyData.CompanyEmail;

                await UpdateProgressWhenSaveEventAsCompany(70);

                // Step 4: Save to database
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveEventAsCompany(90);

                // Step 5: Success
                saveEventAsCompanyMessage = "Η Εκδήλωση Δημιουργήθηκε Επιτυχώς";
                showSuccessMessage = true;
                await UpdateProgressWhenSaveEventAsCompany(100);

                // Small delay to show completion
                await Task.Delay(500);

                // Navigate to refresh
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForEvent = false;

                Console.WriteLine($"Κάποιο Πρόβλημα Παρουσιάστηκε, Προσπαθήστε ξανά: {ex.Message}");
                Console.WriteLine($"Inner Exception: {ex.InnerException?.Message}");
                showSuccessMessage = false;
                showErrorMessageForUploadingCompanyEvent = true;
                StateHasChanged();
            }
        }

        private async Task HandleEventValidationErrorWhenSaveEventAsCompany()
        {
            showLoadingModalForEvent = false;
            showErrorMessageForUploadingCompanyEvent = true;
            isFormValidToSaveEventAsCompany = false;
            StateHasChanged();

            // Optional: Scroll to top to show error message
            await JS.InvokeVoidAsync("scrollToTop");
        }

        private async Task UpdateProgressWhenSaveEventAsCompany(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }




        protected override async Task OnAfterRenderAsync(bool firstRender)
        {

            await Task.Delay(200); 
            await JS.InvokeVoidAsync("initializeAutocomplete");
            await JS.InvokeVoidAsync("initializeAutocomplete2");
            await JS.InvokeVoidAsync("initializeAutocomplete3");
            await JS.InvokeVoidAsync("initializeAutocomplete4");

            await JS.InvokeVoidAsync("initializeAutocomplete6");
            await JS.InvokeVoidAsync("initializeAutocomplete7");
            await JS.InvokeVoidAsync("initializeAutocomplete8");

        }

        [JSInvokable]
        public static Task UpdatePlaceDetails(List<GooglePlaceComponent> addressComponents)
        {
            return Task.CompletedTask;
        }

        public class GooglePlaceComponent
        {
            public string long_name { get; set; }
            public string short_name { get; set; }
            public List<string> types { get; set; }
        }

        private void SearchStudentsAsCompanyToFindStudent()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfExpertise != null && selectedAreasOfExpertise.Any())
                combinedSearchAreas.AddRange(selectedAreasOfExpertise);

            if (!string.IsNullOrWhiteSpace(searchAreasOfExpertise))
                combinedSearchAreas.Add(searchAreasOfExpertise);

            // Use your existing NormalizeAreas method for search terms
            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var combinedSearchKeywords = new List<string>();

            if (selectedKeywords != null && selectedKeywords.Any())
                combinedSearchKeywords.AddRange(selectedKeywords);

            if (!string.IsNullOrWhiteSpace(searchKeywords))
                combinedSearchKeywords.Add(searchKeywords);

            var normalizedSearchKeywords = combinedSearchKeywords
                .SelectMany(keyword => NormalizeKeywords(keyword))
                .Distinct()
                .ToList();

            searchResultsAsCompanyToFindStudent = dbContext.Students
                .AsEnumerable()
                .Where(s =>
                {
                    // Use your existing NormalizeAreas method for student areas
                    var normalizedStudentAreas = NormalizeAreas(s.AreasOfExpertise).ToList();

                    // Extract expanded areas including subfields
                    var expandedStudentAreas = ExpandAreasWithSubfields(normalizedStudentAreas);

                    var normalizedStudentKeywords = NormalizeKeywords(s.Keywords).ToList();

                    // Debugging
                    Console.WriteLine($"Student: {s.Name} {s.Surname}");
                    Console.WriteLine($"Student Normalized Areas: {string.Join(", ", normalizedStudentAreas)}");
                    Console.WriteLine($"Student Expanded Areas: {string.Join(", ", expandedStudentAreas)}");
                    Console.WriteLine($"Search Areas: {string.Join(", ", normalizedSearchAreas)}");
                    Console.WriteLine($"Student Keywords: {string.Join(", ", normalizedStudentKeywords)}");
                    Console.WriteLine($"Search Keywords: {string.Join(", ", normalizedSearchKeywords)}");

                    // Filter by school if selected
                    bool schoolMatch = true;
                    if (!string.IsNullOrEmpty(searchSchoolAsCompanyToFindStudent))
                    {
                        var schoolDepartments = universityDepartments[searchSchoolAsCompanyToFindStudent];
                        schoolMatch = schoolDepartments.Contains(s.Department);
                    }

                    // Enhanced area matching that includes subfields
                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedStudentAreas.Any(studentArea =>
                                studentArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(studentArea, StringComparison.OrdinalIgnoreCase)));

                    var keywordMatch = !normalizedSearchKeywords.Any() ||
                        normalizedSearchKeywords.Any(searchKeyword =>
                            normalizedStudentKeywords.Any(studentKeyword =>
                                studentKeyword.Contains(searchKeyword, StringComparison.OrdinalIgnoreCase) ||
                                searchKeyword.Contains(studentKeyword, StringComparison.OrdinalIgnoreCase)));

                    return (string.IsNullOrEmpty(searchNameOrSurname) ||
                                (s.Name + " " + s.Surname).Contains(searchNameOrSurname, StringComparison.OrdinalIgnoreCase)) &&
                        (string.IsNullOrEmpty(searchRegNumberAsCompanyToFindStudent) ||
                                s.RegNumber.ToString().Contains(searchRegNumberAsCompanyToFindStudent)) &&
                        (string.IsNullOrEmpty(searchSchoolAsCompanyToFindStudent) || schoolMatch) &&
                        (string.IsNullOrEmpty(searchDepartmentAsCompanyToFindStudent) ||
                                s.Department == searchDepartmentAsCompanyToFindStudent) &&
                        (string.IsNullOrEmpty(InternshipStatus) ||
                                s.InternshipStatus == InternshipStatus) &&
                        (string.IsNullOrEmpty(ThesisStatus) ||
                                s.ThesisStatus == ThesisStatus) &&
                        areaMatch &&
                        keywordMatch &&
                        (string.IsNullOrEmpty(selectedDegreeLevel) ||
                                s.LevelOfDegree == selectedDegreeLevel);
                })
                .ToList();
        }

        private List<string> ExpandAreasWithSubfields(List<string> normalizedAreas)
        {
            var expandedAreas = new List<string>();

            foreach (var area in normalizedAreas)
            {
                // Add the original area
                expandedAreas.Add(area);

                // If the area contains a subfield (has '/'), expand it
                if (area.Contains('/'))
                {
                    var parts = area.Split('/', StringSplitOptions.RemoveEmptyEntries)
                                .Select(part => part.Trim().ToLower())
                                .Where(part => !string.IsNullOrEmpty(part))
                                .ToList();

                    if (parts.Count >= 2)
                    {
                        // Add main area only (first part)
                        expandedAreas.Add(parts[0]);

                        // Add subfield only (second part)
                        expandedAreas.Add(parts[1]);

                        // Add all individual parts
                        expandedAreas.AddRange(parts);
                    }
                }
            }

            return expandedAreas.Distinct().ToList();
        }


        private IEnumerable<string> NormalizeAreas(string Areas)
        {
            if (string.IsNullOrWhiteSpace(Areas))
                return Array.Empty<string>();

            return Areas
                .Split(new string[] { ",", "/", ", ", " / ", " ," }, StringSplitOptions.RemoveEmptyEntries)
                .Select(area => area.Trim().ToLower()) 
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .Where(area => !string.IsNullOrEmpty(area)); 
        }

        // Normalize Keywords (convert to lowercase)
        private IEnumerable<string> NormalizeKeywords(string keywords)
        {
            if (string.IsNullOrWhiteSpace(keywords))
                return Array.Empty<string>();

            return keywords
                .Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries)
                .Select(keyword => keyword.Trim().ToLower())  
                .Distinct(StringComparer.OrdinalIgnoreCase) 
                .Where(keyword => !string.IsNullOrEmpty(keyword)); 
        }



        private void ClearSearchFieldsAsCompanyToFindStudent()
        {
            searchNameOrSurname = string.Empty;
            searchRegNumberAsCompanyToFindStudent = string.Empty;
            searchSchoolAsCompanyToFindStudent = string.Empty;
            searchDepartmentAsCompanyToFindStudent = string.Empty;
            InternshipStatus = string.Empty;
            ThesisStatus = string.Empty;
            searchAreasOfExpertise = string.Empty;
            searchKeywords = string.Empty;
            selectedDegreeLevel = string.Empty;
            searchResultsAsCompanyToFindStudent = null;

            nameSurnameSuggestions.Clear();
            areasOfExpertiseSuggestions.Clear();
            keywordsSuggestions.Clear();

            selectedKeywords.Clear();
            selectedAreasOfExpertise.Clear();

            StateHasChanged();
        }



        private void OnTransportOptionChange(ChangeEventArgs e)
        {
            if (bool.TryParse(e.Value?.ToString(), out var result))
            {
                companyEvent.CompanyEventOfferingTransportToEventLocation = result;
            }
        }

        private void OnTransportOptionChangeForProfessorEvent(ChangeEventArgs e)
        {
            if (bool.TryParse(e.Value?.ToString(), out var result))
            {
                professorEvent.ProfessorEventOfferingTransportToEventLocation = result;
            }
        }

        private string CompanyEventAttachmentErrorMessage = string.Empty;
        private async Task UploadCompanyEventAttachmentFile(InputFileChangeEventArgs e)
        {
            try
            {
                // If no file is selected, clear the attachment and return
                if (e.File == null)
                {
                    companyEvent.CompanyEventAttachmentFile = null;
                    CompanyEventAttachmentErrorMessage = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (e.File.Size > maxFileSize)
                {
                    CompanyEventAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    companyEvent.CompanyEventAttachmentFile = null;
                    return;
                }

                using var memoryStream = new MemoryStream();
                await e.File.OpenReadStream(maxFileSize).CopyToAsync(memoryStream);
                companyEvent.CompanyEventAttachmentFile = memoryStream.ToArray();

                // Clear any previous error message
                CompanyEventAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading company event attachment: {ex.Message}");
                CompanyEventAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                companyEvent.CompanyEventAttachmentFile = null;
            }
        }

        private string ProfessorEventAttachmentErrorMessage = string.Empty;
        private async Task UploadProfessorEventAttachmentFile(InputFileChangeEventArgs e)
        {
            try
            {
                // If no file is selected, clear the attachment and return
                if (e.File == null)
                {
                    professorEvent.ProfessorEventAttachmentFile = null;
                    ProfessorEventAttachmentErrorMessage = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (e.File.Size > maxFileSize)
                {
                    ProfessorEventAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    professorEvent.ProfessorEventAttachmentFile = null;
                    return;
                }

                using var memoryStream = new MemoryStream();
                await e.File.OpenReadStream(maxFileSize).CopyToAsync(memoryStream);
                professorEvent.ProfessorEventAttachmentFile = memoryStream.ToArray();

                // Clear any previous error message
                ProfessorEventAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading professor event attachment: {ex.Message}");
                ProfessorEventAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                professorEvent.ProfessorEventAttachmentFile = null;
            }
        }

        private async Task ToggleAndLoadCompanyEventsAsStudent()
        {
            isCompanyEventsVisibleToSeeAsStudent = !isCompanyEventsVisibleToSeeAsStudent;
            Console.WriteLine("Toggle button clicked. Visibility: " + isCompanyEventsVisibleToSeeAsStudent);

            if (isCompanyEventsVisibleToSeeAsStudent && (companyEventsToSeeAsStudent == null || !companyEventsToSeeAsStudent.Any()))
            {
                try
                {
                    companyEventsToSeeAsStudent = await dbContext.CompanyEvents.ToListAsync();
                    Console.WriteLine("Events loaded: " + companyEventsToSeeAsStudent.Count); // Log event count

                    StateHasChanged(); // Ensure UI refresh
                }
                catch (Exception ex)
                {
                    Console.WriteLine("Error fetching company events: " + ex.Message);
                }
            }
        }


        private void ShowCompanyEventDetails(CompanyEvent eventDetails)
        {
            currentCompanyEvent = eventDetails;
            isModalOpenForCompanyEventToSeeAsStudent = true;  // Set the modal open state to true
            StateHasChanged();  // To trigger a re-render and show the modal
        }

        private void CloseModalForCompanyEventToSeeAsStudent()
        {
            currentCompanyEvent = null;
            isModalOpenForCompanyEventToSeeAsStudent = false; // Set the modal open state to false
            StateHasChanged(); // To trigger a re-render and hide the modal
        }



        private void ShowProfessorEventDetails(ProfessorEvent eventDetails)
        {
            currentProfessorEvent = eventDetails;
            isModalOpenForProfessorEventToSeeAsStudent = true;  // Set the modal open state to true
            StateHasChanged();  // To trigger a re-render and show the modal
        }

        private void CloseModalForProfessorEventToSeeAsStudent()
        {
            currentProfessorEvent = null;
            isModalOpenForProfessorEventToSeeAsStudent = false; // Set the modal open state to false
            StateHasChanged(); // To trigger a re-render and hide the modal
        }


        private async Task ShowCompanyDetailsModalAtEventsAsStudent(string companyEmail)
        {
            currentCompanyDetailsToShowOnHyperlinkAsStudentForCompanyEvents = 
                await dbContext.Companies.FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

            if (currentCompanyDetailsToShowOnHyperlinkAsStudentForCompanyEvents != null)
            {
                isModalOpenForCompanyDetailsToSeeAsStudent = true;
                await JS.InvokeVoidAsync("showCompanyDetailsModalForEventsAsStudent");
            }
            else
            {
                Console.WriteLine("Company details not found for company name with email: " + companyEmail);
            }
        }

        private void CloseCompanyDetailsModalAtEventsAsStudent()
        {
            currentCompanyDetailsToShowOnHyperlinkAsStudentForCompanyEvents = null;
            isModalOpenForCompanyDetailsToSeeAsStudent = false;
            JS.InvokeVoidAsync("hideCompanyDetailsModalForEventsAsStudent");
        }

        private async Task ShowProfessorDetailsModalAtEventsAsStudent(string professorEmail)
        {
            currentProfessorDetailsToShowOnHyperlinkAsStudentForProfessorEvents = 
                await dbContext.Professors.FirstOrDefaultAsync(c => c.ProfEmail == professorEmail);

            if (currentProfessorDetailsToShowOnHyperlinkAsStudentForProfessorEvents != null)
            {
                isModalOpenForProfessorDetailsToSeeAsStudent = true;
                await JS.InvokeVoidAsync("showProfessorDetailsModalForEventsAsStudent");
            }
            else
            {
                Console.WriteLine("Professor details not found for company name with email: " + professorEmail);
            }
        }


        private void CloseProfessorDetailsModalAtEventsAsStudent()
        {
            currentProfessorDetailsToShowOnHyperlinkAsStudentForProfessorEvents = null;
            isModalOpenForProfessorDetailsToSeeAsStudent = false;
            JS.InvokeVoidAsync("hideProfessorDetailsModalForEventsAsStudent");
        }




        private bool showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
        private int loadingProgressWhenShowInterestForCompanyEventAsStudent = 0;
        private async Task<bool> ShowInterestInCompanyEvent(CompanyEvent companyEvent, bool needsTransportForCompanyEvent)
        {
            try
            {
                // Step 1: Initial confirmation - show JavaScript confirm first
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να δείξετε Ενδιαφέρον για την Εκδήλωση: {companyEvent.CompanyEventTitle} της εταιρείας {companyEvent.Company?.CompanyName}. Είστε σίγουρος/η;");
            
                if (!confirmed)
                {
                    return false;
                }

                // NOW show the loading modal after user confirms
                showLoadingModalWhenShowInterestForCompanyEventAsStudent = true;
                loadingProgressWhenShowInterestForCompanyEventAsStudent = 0;
                StateHasChanged();

                // Step 2: Check event status
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(10, 200);
            
                var latestEvent = await dbContext.CompanyEvents
                    .AsNoTracking()
                    .Where(e => e.RNGForEventUploadedAsCompany == companyEvent.RNGForEventUploadedAsCompany)
                    .Select(e => new { e.CompanyEventStatus })
                    .FirstOrDefaultAsync();

                if (latestEvent == null || latestEvent.CompanyEventStatus != "Δημοσιευμένη")
                {
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Εκδήλωση έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα.");
                    return false;
                }

                // Step 3: Get student details
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(20, 200);
            
                var student = await GetStudentDetails(CurrentUserEmail);
                if (student == null)
                {
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return false;
                }

                // Step 4: Check for existing interest
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(30, 200);
            
                var existingInterest = await dbContext.InterestInCompanyEvents
                    .FirstOrDefaultAsync(i => 
                        i.StudentEmailShowInterestForEvent == student.Email &&
                        i.RNGForCompanyEventInterest == companyEvent.RNGForEventUploadedAsCompany);

                if (existingInterest != null)
                {
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη δείξει ενδιαφέρον για: {companyEvent.CompanyEventTitle}!");
                    return false;
                }

                // Step 5: Validate location selection
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(40, 200);
            
                if (!selectedStartingPoint.TryGetValue(companyEvent.RNGForEventUploadedAsCompany, out var chosenLocation))
                {
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await ShowAlert("Παρακαλώ επιλέξτε μια τοποθεσία μετακίνησης πριν δείξετε ενδιαφέρον.");
                    return false;
                }

                // Step 6: Get company data
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(50, 200);
            
                var company = await dbContext.Companies
                    .FirstOrDefaultAsync(c => c.CompanyEmail == companyEvent.CompanyEmailUsedToUploadEvent);

                if (company == null)
                {
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε η εταιρία.");
                    return false;
                }

                // Step 7: Begin transaction and save data
                await UpdateProgressWhenShowInterestForCompanyEventAsStudent(60, 200);
            
                using var transaction = await dbContext.Database.BeginTransactionAsync();
                try
                {
                    // Create main interest record with details
                    var interest = new InterestInCompanyEvent
                    {
                        RNGForCompanyEventInterest = companyEvent.RNGForEventUploadedAsCompany,
                        RNGForCompanyEventInterest_HashedAsUniqueID = companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID,
                        DateTimeStudentShowInterest = DateTime.Now,
                        CompanyEventStatusAtStudentSide = "Έχετε Δείξει Ενδιαφέρον",
                        CompanyEventStatusAtCompanySide = "Προς Επεξεργασία",
                        CompanyEmailWhereStudentShowedInterest = companyEvent.CompanyEmailUsedToUploadEvent,
                        CompanyUniqueIDWhereStudentShowedInterest = company.Company_UniqueID,
                        StudentEmailShowInterestForEvent = student.Email,
                        StudentUniqueIDShowInterestForEvent = student.Student_UniqueID,
                        StudentTransportNeedWhenShowInterestForCompanyEvent = needsTransportForCompanyEvent ? "Ναι" : "Όχι",
                        StudentTransportChosenLocationWhenShowInterestForCompanyEvent = chosenLocation,

                        StudentDetails = new InterestInCompanyEvent_StudentDetails
                        {
                            StudentUniqueIDShowInterestForCompanyEvent = student.Student_UniqueID,
                            StudentEmailShowInterestForCompanyEvent = student.Email,
                            DateTimeStudentShowInterestForCompanyEvent = DateTime.Now,
                            RNGForCompanyEventShowInterestAsStudent_HashedAsUniqueID = companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID
                        },

                        CompanyDetails = new InterestInCompanyEvent_CompanyDetails
                        {
                            CompanyUniqueIDWhereStudentShowInterestForCompanyEvent = company.Company_UniqueID,
                            CompanyEmailWhereStudentShowInterestForCompanyEvent = companyEvent.CompanyEmailUsedToUploadEvent
                        }
                    };

                    dbContext.InterestInCompanyEvents.Add(interest);

                    // Add platform action
                    dbContext.PlatformActions.Add(new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "COMPANY_EVENT",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(companyEvent.RNGForEventUploadedAsCompany),
                        TypeOfAction_PerformedAction = "SHOW_INTEREST",
                        DateTime_PerformedAction = DateTime.Now
                    });

                    await dbContext.SaveChangesAsync();
                    await UpdateProgressWhenShowInterestForCompanyEventAsStudent(70, 200);
                
                    await transaction.CommitAsync();
                    await UpdateProgressWhenShowInterestForCompanyEventAsStudent(75, 200);

                    // Step 8: Send emails
                    await UpdateProgressWhenShowInterestForCompanyEventAsStudent(80, 200);
                
                    try
                    {
                        await InternshipEmailService.SendConfirmationToStudentForInterestInCompanyEvent(
                            student.Email,
                            student.Name,
                            student.Surname,
                            companyEvent.CompanyEventTitle,
                            company.CompanyName,
                            companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID,
                            needsTransportForCompanyEvent,
                            chosenLocation);

                        await InternshipEmailService.SendNotificationToCompanyForStudentInterestForCompanyEvent(
                            companyEvent.CompanyEmailUsedToUploadEvent,
                            company.CompanyName,
                            student.Name,
                            student.Surname,
                            student.Email,
                            student.Telephone,
                            student.StudyYear,
                            companyEvent.CompanyEventTitle,
                            companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID,
                            needsTransportForCompanyEvent,
                            chosenLocation);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Email error: {ex.Message}");
                        // Continue even if emails fail
                    }

                    await UpdateProgressWhenShowInterestForCompanyEventAsStudent(90, 200);

                    // Step 9: Final success message
                    await UpdateProgressWhenShowInterestForCompanyEventAsStudent(100, 200);
                
                    // Small delay to show 100% completion
                    await Task.Delay(500);
                
                    // Hide loading modal before showing success message
                    showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                
                    // Wait for user to acknowledge the success message
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Η έκφραση ενδιαφέροντος για την εκδήλωση {companyEvent.CompanyEventTitle} υποβλήθηκε επιτυχώς!");
                    // AFTER user clicks OK, show the navigation loader
                    await Task.Delay(100); // Small delay for smooth transition
            
                    // Show the navigation loader
                    await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                    // Give time for loader to render
                    await Task.Delay(300);
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw; // Re-throw to be caught by outer try-catch
                }

                // Step 10: Navigate
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                return false;
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenShowInterestForCompanyEventAsStudent = false;
                StateHasChanged(); // Force UI update
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
                return false;
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenShowInterestForCompanyEventAsStudent(int current, int total)
        {
            loadingProgressWhenShowInterestForCompanyEventAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }

        private bool showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
        private int loadingProgressWhenShowInterestForProfessorEventAsStudent = 0;
        private async Task<bool> ShowInterestInProfessorEvent(ProfessorEvent professorEvent, bool needsTransportForProfessorEvent)
        {
            try
            {
                // Step 1: Initial confirmation - show JavaScript confirm first
                var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                    $"Πρόκεται να δείξετε Ενδιαφέρον για την Εκδήλωση: {professorEvent.ProfessorEventTitle} του Καθηγητή {professorEvent.Professor?.ProfName} {professorEvent.Professor?.ProfSurname}. Είστε σίγουρος/η;");
            
                if (!confirmed)
                {
                    return false;
                }

                // NOW show the loading modal after user confirms
                showLoadingModalWhenShowInterestForProfessorEventAsStudent = true;
                loadingProgressWhenShowInterestForProfessorEventAsStudent = 0;
                StateHasChanged();

                // Step 2: Check event status
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(10, 200);
            
                var latestEvent = await dbContext.ProfessorEvents
                    .Include(e => e.Professor)
                    .AsNoTracking()
                    .Where(e => e.RNGForEventUploadedAsProfessor == professorEvent.RNGForEventUploadedAsProfessor)
                    .Select(e => new { e.ProfessorEventStatus })
                    .FirstOrDefaultAsync();

                if (latestEvent == null || latestEvent.ProfessorEventStatus != "Δημοσιευμένη")
                {
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Εκδήλωση έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα.");
                    return false;
                }

                // Step 3: Get student details
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(20, 200);
            
                var student = await GetStudentDetails(CurrentUserEmail);
                if (student == null)
                {
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                    return false;
                }

                // Step 4: Check for existing interest
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(30, 200);
            
                var existingInterest = await dbContext.InterestInProfessorEvents
                    .FirstOrDefaultAsync(i => 
                        i.StudentEmailShowInterestForEvent == student.Email &&
                        i.RNGForProfessorEventInterest == professorEvent.RNGForEventUploadedAsProfessor);

                if (existingInterest != null)
                {
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη δείξει ενδιαφέρον για: {professorEvent.ProfessorEventTitle}!");
                    return false;
                }

                // Step 5: Validate location selection
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(40, 200);
            
                if (!selectedStartingPoint.TryGetValue(professorEvent.RNGForEventUploadedAsProfessor, out var chosenLocation))
                {
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await ShowAlert("Παρακαλώ επιλέξτε μια τοποθεσία μετακίνησης πριν δείξετε ενδιαφέρον.");
                    return false;
                }

                // Step 6: Get professor data
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(50, 200);
            
                var professor = professorEvent.Professor ?? await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == professorEvent.ProfessorEmailUsedToUploadEvent);

                if (professor == null)
                {
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", "Σφάλμα: Δεν βρέθηκε ο καθηγητής.");
                    return false;
                }

                // Step 7: Begin transaction and save data
                await UpdateProgressWhenShowInterestForProfessorEventAsStudent(60, 200);
            
                using var transaction = await dbContext.Database.BeginTransactionAsync();
                try
                {
                    // Create main interest record with details
                    var interest = new InterestInProfessorEvent
                    {
                        RNGForProfessorEventInterest = professorEvent.RNGForEventUploadedAsProfessor,
                        RNGForProfessorEventInterest_HashedAsUniqueID = professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                        DateTimeStudentShowInterest = DateTime.Now,
                        ProfessorEventStatusAtStudentSide = "Έχετε Δείξει Ενδιαφέρον",
                        ProfessorEventStatusAtProfessorSide = "Προς Επεξεργασία",
                        ProfessorEmailWhereStudentShowedInterest = professorEvent.ProfessorEmailUsedToUploadEvent,
                        ProfessorUniqueIDWhereStudentShowedInterest = professor.Professor_UniqueID,
                        StudentEmailShowInterestForEvent = student.Email,
                        StudentUniqueIDShowInterestForEvent = student.Student_UniqueID,
                        StudentTransportNeedWhenShowInterestForProfessorEvent = needsTransportForProfessorEvent ? "Ναι" : "Όχι",
                        StudentTransportChosenLocationWhenShowInterestForProfessorEvent = chosenLocation,

                        StudentDetails = new InterestInProfessorEvent_StudentDetails
                        {
                            StudentUniqueIDShowInterestForProfessorEvent = student.Student_UniqueID,
                            StudentEmailShowInterestForProfessorEvent = student.Email,
                            DateTimeStudentShowInterestForProfessorEvent = DateTime.Now,
                            RNGForProfessorEventShowInterestAsStudent_HashedAsUniqueID = professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID
                        },

                        ProfessorDetails = new InterestInProfessorEvent_ProfessorDetails
                        {
                            ProfessorUniqueIDWhereStudentShowInterestForProfessorEvent = professor.Professor_UniqueID,
                            ProfessorEmailWhereStudentShowInterestForProfessorEvent = professorEvent.ProfessorEmailUsedToUploadEvent
                        }
                    };

                    dbContext.InterestInProfessorEvents.Add(interest);

                    // Add platform action
                    dbContext.PlatformActions.Add(new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "PROFESSOR_EVENT",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(professorEvent.RNGForEventUploadedAsProfessor),
                        TypeOfAction_PerformedAction = "SHOW_INTEREST",
                        DateTime_PerformedAction = DateTime.Now
                    });

                    await dbContext.SaveChangesAsync();
                    await UpdateProgressWhenShowInterestForProfessorEventAsStudent(70, 200);
                
                    await transaction.CommitAsync();
                    await UpdateProgressWhenShowInterestForProfessorEventAsStudent(75, 200);

                    // Step 8: Send emails
                    await UpdateProgressWhenShowInterestForProfessorEventAsStudent(80, 200);
                
                    try
                    {
                        await InternshipEmailService.SendConfirmationToStudentForInterestInProfessorEvent(
                            student.Email,
                            student.Name,
                            student.Surname,
                            professorEvent.ProfessorEventTitle,
                            professor.ProfName,
                            professor.ProfSurname,
                            professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                            needsTransportForProfessorEvent,
                            chosenLocation);

                        await InternshipEmailService.SendNotificationToProfessorForStudentInterestForProfessorEvent(
                            professor.ProfEmail,
                            professor.ProfName,
                            professor.ProfSurname,
                            student.Name,
                            student.Surname,
                            student.Email,
                            student.Telephone,
                            student.StudyYear,
                            professorEvent.ProfessorEventTitle,
                            professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                            needsTransportForProfessorEvent,
                            chosenLocation);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Email error: {ex.Message}");
                        // Continue even if emails fail
                    }

                    await UpdateProgressWhenShowInterestForProfessorEventAsStudent(90, 200);

                    // Step 9: Final success message
                    await UpdateProgressWhenShowInterestForProfessorEventAsStudent(100, 200);
                
                    // Small delay to show 100% completion
                    await Task.Delay(500);
                
                    // Hide loading modal before showing success message
                    showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                    StateHasChanged(); // Force UI update
                
                    // Wait for user to acknowledge the success message
                    await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Η έκφραση ενδιαφέροντος για την εκδήλωση {professorEvent.ProfessorEventTitle} υποβλήθηκε επιτυχώς!");

                    // AFTER user clicks OK, show the navigation loader
                    await Task.Delay(100); // Small delay for smooth transition
            
                    // Show the navigation loader
                    await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                    // Give time for loader to render
                    await Task.Delay(300);
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw; // Re-throw to be caught by outer try-catch
                }

                // Step 10: Navigate
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                return false;
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenShowInterestForProfessorEventAsStudent = false;
                StateHasChanged(); // Force UI update
            
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
                return false;
            }
    }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenShowInterestForProfessorEventAsStudent(int current, int total)
        {
            loadingProgressWhenShowInterestForProfessorEventAsStudent = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }




        private async Task ShowAlert(string message)
        {
            await JS.InvokeVoidAsync("alert", message);
        }


        private async Task ShowProfessorDetailsFromHyperlinkName(string professorEmail)
        {
            try
            {
                selectedProfessorDetails = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == professorEmail);

                if (selectedProfessorDetails != null)
                {
                    isProfessorDetailModalVisible = true;
                }
                else
                {
                    Console.WriteLine("Professor not found");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching professor details: {ex.Message}");
            }
        }

        private void CloseProfessorModalFromHyperlinkName()
        {
            isProfessorDetailModalVisible = false;
            selectedProfessorDetails = null;
        }

        private string GetImageSource(byte[] imageBytes)
        {      
            return "data:image/png;base64," + Convert.ToBase64String(imageBytes);       
        }      

        private void SearchStudentsAsProfessorToFindStudent()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfExpertise != null && selectedAreasOfExpertise.Any())
                combinedSearchAreas.AddRange(selectedAreasOfExpertise);

            if (!string.IsNullOrEmpty(searchAreasOfExpertiseAsProfessorToFindStudent))
                combinedSearchAreas.Add(searchAreasOfExpertiseAsProfessorToFindStudent);

            // Use your existing NormalizeAreas method for search terms
            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var students = dbContext.Students
                .AsEnumerable()
                .Where(s =>
                {
                    // Use your existing NormalizeAreas method for student areas
                    var normalizedStudentAreas = NormalizeAreas(s.AreasOfExpertise).ToList();

                    // Extract expanded areas including subfields
                    var expandedStudentAreas = ExpandAreasWithSubfields(normalizedStudentAreas);

                    var normalizedStudentKeywords = NormalizeKeywords(s.Keywords).ToList();

                    // Debugging
                    Console.WriteLine($"Student: {s.Name} {s.Surname}");
                    Console.WriteLine($"Student Normalized Areas: {string.Join(", ", normalizedStudentAreas)}");
                    Console.WriteLine($"Student Expanded Areas: {string.Join(", ", expandedStudentAreas)}");
                    Console.WriteLine($"Search Areas: {string.Join(", ", normalizedSearchAreas)}");
                    Console.WriteLine($"Student Keywords: {string.Join(", ", normalizedStudentKeywords)}");

                    // Enhanced area matching that includes subfields
                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedStudentAreas.Any(studentArea =>
                                studentArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(studentArea, StringComparison.OrdinalIgnoreCase)));

                    var keywordMatch = string.IsNullOrEmpty(searchKeywordsAsProfessorToFindStudent) ||
                        normalizedStudentKeywords.Any(studentKeyword =>
                            studentKeyword.Contains(searchKeywordsAsProfessorToFindStudent.Trim().ToLower()) ||
                            searchKeywordsAsProfessorToFindStudent.Trim().ToLower().Contains(studentKeyword));

                    // Filter by school if selected
                    bool schoolMatch = true;
                    if (!string.IsNullOrEmpty(searchSchoolAsProfessorToFindStudent))
                    {
                        var schoolDepartments = universityDepartments[searchSchoolAsProfessorToFindStudent];
                        schoolMatch = schoolDepartments.Contains(s.Department);
                    }

                    return (string.IsNullOrEmpty(searchEmailAsProfessorToFindStudent) || s.Email.Contains(searchEmailAsProfessorToFindStudent)) &&
                        (string.IsNullOrEmpty(searchNameAsProfessorToFindStudent) || s.Name.Contains(searchNameAsProfessorToFindStudent)) &&
                        (string.IsNullOrEmpty(searchSurnameAsProfessorToFindStudent) || s.Surname.Contains(searchSurnameAsProfessorToFindStudent)) &&
                        (string.IsNullOrEmpty(searchRegNumberAsProfessorToFindStudent) || s.RegNumber.ToString().Contains(searchRegNumberAsProfessorToFindStudent)) &&
                        (string.IsNullOrEmpty(searchSchoolAsProfessorToFindStudent) || schoolMatch) &&
                        (string.IsNullOrEmpty(searchDepartmentAsProfessorToFindStudent) || s.Department.Contains(searchDepartmentAsProfessorToFindStudent)) &&
                        areaMatch &&
                        keywordMatch;
                })
                .ToList();

            searchResultsAsProfessorToFindStudent = students;
        }


        private void ClearSearchFieldsAsProfessorToFindStudent()
        {
            // Clear all search fields
            searchEmailAsProfessorToFindStudent = string.Empty;
            searchNameAsProfessorToFindStudent = string.Empty;
            searchSurnameAsProfessorToFindStudent = string.Empty;
            searchRegNumberAsProfessorToFindStudent = string.Empty;
            searchSchoolAsProfessorToFindStudent = string.Empty;
            searchDepartmentAsProfessorToFindStudent = string.Empty;
            searchAreasOfExpertiseAsProfessorToFindStudent = string.Empty;
            searchKeywordsAsProfessorToFindStudent = string.Empty;

            // Clear search results
            searchResultsAsProfessorToFindStudent = null;

            // Clear autocomplete suggestions
            studentNameSuggestions.Clear();
            studentSurnameSuggestions.Clear();
            areasOfExpertiseSuggestions.Clear();
            keywordsSuggestions.Clear();

            // Clear selected areas and keywords
            selectedAreasOfExpertise.Clear();
            selectedKeywords.Clear();

            StateHasChanged();
        }


        private void SearchCompaniesAsProfessor()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfInterest != null && selectedAreasOfInterest.Any())
                combinedSearchAreas.AddRange(selectedAreasOfInterest);

            if (!string.IsNullOrEmpty(searchCompanyAreasAsProfessorToFindCompany))
                combinedSearchAreas.Add(searchCompanyAreasAsProfessorToFindCompany);

            // Use your existing NormalizeAreas method for search terms
            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var companies = dbContext.Companies
                .AsEnumerable()
                .Where(c =>
                {
                    // Use your existing NormalizeAreas method for company areas
                    var normalizedCompanyAreas = NormalizeAreas(c.CompanyAreas).ToList();

                    // Extract expanded areas including subfields
                    var expandedCompanyAreas = ExpandAreasWithSubfields(normalizedCompanyAreas);

                    // Debugging
                    Console.WriteLine($"Company: {c.CompanyNameENG}");
                    Console.WriteLine($"Company Normalized Areas: {string.Join(", ", normalizedCompanyAreas)}");
                    Console.WriteLine($"Company Expanded Areas: {string.Join(", ", expandedCompanyAreas)}");
                    Console.WriteLine($"Search Areas: {string.Join(", ", normalizedSearchAreas)}");

                    // Enhanced area matching that includes subfields
                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedCompanyAreas.Any(companyArea =>
                                companyArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(companyArea, StringComparison.OrdinalIgnoreCase)));

                    // Apply other filters
                    var basicMatch = (string.IsNullOrEmpty(searchCompanyEmailAsProfessorToFindCompany) || c.CompanyEmail.Contains(searchCompanyEmailAsProfessorToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyNameENGAsProfessorToFindCompany) || c.CompanyNameENG.Contains(searchCompanyNameENGAsProfessorToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyTypeAsProfessorToFindCompany) || c.CompanyType.Contains(searchCompanyTypeAsProfessorToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyTownAsProfessorToFindCompany) || c.CompanyTown.Contains(searchCompanyTownAsProfessorToFindCompany));

                    // Apply in-memory filtering for selected activities
                    var activityMatch = !selectedCompanyActivities.Any() ||
                        selectedCompanyActivities.Any(activity => 
                            c.CompanyActivity != null && c.CompanyActivity.Contains(activity));

                    // Apply in-memory filtering for selected desired skills
                    var skillsMatch = !selectedCompanyDesiredSkills.Any() ||
                        selectedCompanyDesiredSkills.All(skill => 
                            c.CompanyDesiredSkills != null && c.CompanyDesiredSkills.Contains(skill));

                    return basicMatch && areaMatch && activityMatch && skillsMatch;
                })
                .ToList();

            searchResultsAsProfessorToFindCompany = companies;
        }

        private void ClearSearchFieldsAsProfessorToFindCompany()
        {
            // Clear all search fields
            searchCompanyEmailAsProfessorToFindCompany = string.Empty;
            searchCompanyNameENGAsProfessorToFindCompany = string.Empty;
            searchCompanyTypeAsProfessorToFindCompany = string.Empty;
            searchCompanyActivityInputAsProfessorToFindCompany = string.Empty;
            searchCompanyTownAsProfessorToFindCompany = string.Empty;
            searchCompanyAreasAsProfessorToFindCompany = string.Empty;
            searchCompanyDesiredSkillsInputAsProfessorToFindCompany = string.Empty;

            // Clear selected areas, activities, skills and suggestions
            selectedAreasOfInterest.Clear();
            selectedCompanyActivities.Clear();
            selectedCompanyDesiredSkills.Clear();
            areasOfInterestSuggestions.Clear();
            companyActivitySuggestions.Clear();
            companyDesiredSkillsSuggestions.Clear();

            // Clear search results
            searchResultsAsProfessorToFindCompany = null;

            StateHasChanged();
        }

        ///////////////////////
        private void SearchCompaniesAsRG()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfInterest != null && selectedAreasOfInterest.Any())
                combinedSearchAreas.AddRange(selectedAreasOfInterest);

            if (!string.IsNullOrEmpty(searchCompanyAreasAsRGToFindCompany))
                combinedSearchAreas.Add(searchCompanyAreasAsRGToFindCompany);

            // Use your existing NormalizeAreas method for search terms
            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var companies = dbContext.Companies
                .AsEnumerable()
                .Where(c =>
                {
                    // Use your existing NormalizeAreas method for company areas
                    var normalizedCompanyAreas = NormalizeAreas(c.CompanyAreas).ToList();

                    // Extract expanded areas including subfields
                    var expandedCompanyAreas = ExpandAreasWithSubfields(normalizedCompanyAreas);

                    // Debugging
                    Console.WriteLine($"Company: {c.CompanyNameENG}");
                    Console.WriteLine($"Company Normalized Areas: {string.Join(", ", normalizedCompanyAreas)}");
                    Console.WriteLine($"Company Expanded Areas: {string.Join(", ", expandedCompanyAreas)}");
                    Console.WriteLine($"Search Areas: {string.Join(", ", normalizedSearchAreas)}");

                    // Enhanced area matching that includes subfields
                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedCompanyAreas.Any(companyArea =>
                                companyArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(companyArea, StringComparison.OrdinalIgnoreCase)));

                    // Apply other filters
                    var basicMatch = (string.IsNullOrEmpty(searchCompanyEmailAsRGToFindCompany) || c.CompanyEmail.Contains(searchCompanyEmailAsRGToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyNameENGAsRGToFindCompany) || c.CompanyNameENG.Contains(searchCompanyNameENGAsRGToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyTypeAsRGToFindCompany) || c.CompanyType.Contains(searchCompanyTypeAsRGToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyActivityrAsRGToFindCompany) || c.CompanyActivity.Contains(searchCompanyActivityrAsRGToFindCompany)) &&
                                (string.IsNullOrEmpty(searchCompanyTownAsRGToFindCompany) || c.CompanyTown.Contains(searchCompanyTownAsRGToFindCompany));

                    // Apply in-memory filtering for selected desired skills
                    var skillsMatch = !selectedCompanyDesiredSkillsAsRG.Any() ||
                        selectedCompanyDesiredSkillsAsRG.All(skill => 
                            c.CompanyDesiredSkills != null && c.CompanyDesiredSkills.Contains(skill));

                    return basicMatch && areaMatch && skillsMatch;
                })
                .ToList();

            searchResultsAsRGToFindCompany = companies;
        }

        private void ClearSearchFieldsAsRGToFindCompany()
        {
            // Clear all search fields
            searchCompanyEmailAsRGToFindCompany = string.Empty;
            searchCompanyNameENGAsRGToFindCompany = string.Empty;
            searchCompanyTypeAsRGToFindCompany = string.Empty;
            searchCompanyActivityrAsRGToFindCompany = string.Empty;
            searchCompanyTownAsRGToFindCompany = string.Empty;
            searchCompanyAreasAsRGToFindCompany = string.Empty;
            searchCompanyDesiredSkillsInputAsRGToFindCompany = string.Empty;

            // Clear selected areas, skills and suggestions
            selectedAreasOfInterest.Clear();
            selectedCompanyDesiredSkillsAsRG.Clear();
            areasOfInterestSuggestions.Clear();
            companyDesiredSkillsSuggestionsAsRG.Clear();

            // Clear search results
            searchResultsAsRGToFindCompany = null;

            StateHasChanged();
        }

        /////////////////

        private void ShowStudentDetailsWhenSearchAsProfessor(Student student)
        {
            selectedStudent = student;
            showStudentDetailsModal = true;
        }

        private void CloseStudentDetailsModalWhenSearchAsProfessor()
        {
            showStudentDetailsModal = false;
            selectedStudent = null;
        }


        private void ShowCompanyDetailsWhenSearchAsProfessor(Company company)
        {
            selectedCompany = company;
            showCompanyDetailsModal = true;
        }


        private void ShowCompanyDetailsWhenSearchAsRG(Company company)
        {
            selectedCompany = company;
            showCompanyDetailsModal = true;
        }

        private void CloseCompanyDetailsModalWhenSearchAsProfessor()
        {
            showCompanyDetailsModal = false;
            selectedCompany = null;
        }

        private int _currentViewingProfessorThesisApplicationId = 0;
        private async Task ShowStudentDetailsInNameAsHyperlinkForProfessorThesis(string studentUniqueID, int applicationId)
        {
            // 1. Store ID for the download button
            _currentViewingProfessorThesisApplicationId = applicationId;

            // 2. STATISTICS: Update "Seen" flag
            try
            {
                var record = await dbContext.ProfessorThesesApplied
                    .FirstOrDefaultAsync(x => x.Id == applicationId);

                if (record != null && !record.ProfessorThesisApplied_CandidateInfoSeenFromModal)
                {
                    record.ProfessorThesisApplied_CandidateInfoSeenFromModal = true;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating Professor Thesis stats: {ex.Message}");
            }

            // --- EXISTING LOGIC ---
            try
            {
                // Fetch the student details using the unique ID from cache first
                if (!studentDataCache.TryGetValue(studentUniqueID, out currentStudentDetails))
                {
                    // If not in cache, fetch from database
                    currentStudentDetails = await dbContext.Students
                        .FirstOrDefaultAsync(s => s.Student_UniqueID == studentUniqueID);

                    if (currentStudentDetails != null)
                    {
                        // Add to cache
                        studentDataCache[studentUniqueID] = currentStudentDetails;
                    }
                }

                if (currentStudentDetails != null)
                {
                    isModalVisibleToShowStudentDetailsInNameAsHyperlinkForProfessorThesis = true;
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading student details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την φόρτωση των στοιχείων του φοιτητή");
            }
        }

        private async Task DownloadStudentCVForProfessorThesis(string studentEmail)
        {
            try
            {
                // First try to find in cache
                var student = studentDataCache.Values.FirstOrDefault(s => s.Email == studentEmail);
        
                // If not in cache, try database
                if (student == null)
                {
                    student = await dbContext.Students
                        .FirstOrDefaultAsync(s => s.Email == studentEmail);
                }

                if (student?.Attachment == null)
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία βιογραφικού");
                    return;
                }

                var fileName = $"CV_{student.Name}_{student.Surname}.pdf";
                var mimeType = "application/pdf";
            
                await JS.InvokeVoidAsync("downloadFile", fileName, mimeType, Convert.ToBase64String(student.Attachment));

                // STATISTICS: Update "Downloaded" flag
                if (_currentViewingProfessorThesisApplicationId > 0)
                {
                    var record = await dbContext.ProfessorThesesApplied
                        .FirstOrDefaultAsync(x => x.Id == _currentViewingProfessorThesisApplicationId);

                    if (record != null && !record.ProfessorThesisApplied_CandidateCVDownloaded)
                    {
                        record.ProfessorThesisApplied_CandidateCVDownloaded = true;
                        await dbContext.SaveChangesAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error downloading CV: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά τη λήψη του βιογραφικού");
            }
        }

        private void UpdateOrganizerVisibility(bool value)
        {
            companyEvent.CompanyEventOtherOrganizerToBeVisible = value;
            StateHasChanged(); // Ensure the UI is updated
        }

        private void UpdateOrganizerVisibilityForProfessorEvents(bool value)
        {
            professorEvent.ProfessorEventOtherOrganizerToBeVisible = value;
            StateHasChanged(); // Ensure the UI is updated
        }

        private void ShowStudentDetailsOnEyeIconWhenSearchForStudentsAsCompany(Student student)
        {
            selectedStudentWhenSearchForStudentsAsCompany = student;
            showStudentDetailsModalWhenSearchForStudentsAsCompany = true;
        }

        private void CloseModalStudentDetailsOnEyeIconWhenSearchForStudentsAsCompany()
        {
            showStudentDetailsModalWhenSearchForStudentsAsCompany = false;
            selectedStudentWhenSearchForStudentsAsCompany = null;
        }

        private void SearchProfessorsAsCompanyToFindProfessor()
        {
            var professorsQuery = dbContext.Professors.AsQueryable();

            if (!string.IsNullOrEmpty(searchNameSurnameAsCompanyToFindProfessor))
            {
                professorsQuery = professorsQuery.Where(p =>
                    (p.ProfName + " " + p.ProfSurname).Contains(searchNameSurnameAsCompanyToFindProfessor));
            }

            if (!string.IsNullOrEmpty(searchSchoolAsCompanyToFindProfessor))
            {
                var schoolDepartments = universityDepartments[searchSchoolAsCompanyToFindProfessor];
                professorsQuery = professorsQuery.Where(p => schoolDepartments.Contains(p.ProfDepartment));
            }

            if (!string.IsNullOrEmpty(searchDepartmentAsCompanyToFindProfessor))
            {
                professorsQuery = professorsQuery.Where(p => p.ProfDepartment == searchDepartmentAsCompanyToFindProfessor);
            }

            var professorsList = professorsQuery.ToList();

            // Apply area filtering with subfield support
            searchResultsAsCompanyToFindProfessor = professorsList
                .Where(p =>
                {
                    // If no area filter is applied, include all professors
                    if (string.IsNullOrEmpty(searchAreasOfInterestAsCompanyToFindProfessor) && !selectedAreasOfInterest.Any())
                        return true;

                    // If professor has no areas of interest, exclude them when area filter is active
                    if (string.IsNullOrEmpty(p.ProfGeneralFieldOfWork))
                        return false;

                    var professorAreas = NormalizeAreas(p.ProfGeneralFieldOfWork).ToList();
                    var expandedProfessorAreas = ExpandAreasWithSubfields(professorAreas);

                    // Check selected areas (from dropdown selections)
                    var selectedAreaMatch = !selectedAreasOfInterest.Any() || 
                        selectedAreasOfInterest.Any(selectedArea =>
                        {
                            var normalizedSelectedArea = selectedArea.Trim().ToLower();
                            return expandedProfessorAreas.Any(professorArea =>
                                professorArea.Contains(normalizedSelectedArea) || 
                                normalizedSelectedArea.Contains(professorArea));
                        });

                    // Check search input area
                    var searchInputMatch = string.IsNullOrEmpty(searchAreasOfInterestAsCompanyToFindProfessor) ||
                        expandedProfessorAreas.Any(professorArea =>
                            professorArea.Contains(searchAreasOfInterestAsCompanyToFindProfessor.Trim().ToLower()) ||
                            searchAreasOfInterestAsCompanyToFindProfessor.Trim().ToLower().Contains(professorArea));

                    return selectedAreaMatch && searchInputMatch;
                })
                .ToList();
        }


        private void ClearSearchFieldsAsCompanyToFindProfessor()
        {
            searchNameSurnameAsCompanyToFindProfessor = string.Empty; 
            searchSchoolAsCompanyToFindProfessor = string.Empty;
            searchDepartmentAsCompanyToFindProfessor = string.Empty;   
            searchAreasOfInterestAsCompanyToFindProfessor = string.Empty; 
            searchResultsAsCompanyToFindProfessor = null; 
            areasOfInterestSuggestions.Clear();
            selectedAreasOfInterest.Clear(); 
        }




        private void ShowProfessorDetailsOnEyeIconWhenSearchForProfessorAsCompany(Professor professor)
        {
            selectedProfessorWhenSearchForProfessorsAsCompany = professor;
            showProfessorDetailsModalWhenSearchForProfessorsAsCompany = true;
        }

        private void CloseModalProfessorDetailsOnEyeIconWhenSearchForProfessorsAsCompany()
        {
            showProfessorDetailsModalWhenSearchForProfessorsAsCompany = false;
            selectedProfessorWhenSearchForProfessorsAsCompany = null;
        }

        private string SearchNameOrSurname
        {
            get => searchNameOrSurname;
            set
            {
                searchNameOrSurname = value;
                UpdateNameSurnameSuggestions(); 
            }
        }

        private void UpdateNameSurnameSuggestions()
        {
            if (!string.IsNullOrWhiteSpace(searchNameOrSurname) && searchNameOrSurname.Length > 1)
            {
                // Fetch suggestions dynamically
                nameSurnameSuggestions = dbContext.Students
                    .Where(s => 
                        s.Name.Contains(searchNameOrSurname) || 
                        s.Surname.Contains(searchNameOrSurname))
                    .Select(s => s.Name + " " + s.Surname) // Combine Name and Surname
                    .Distinct()
                    .Take(10) // Limit results
                    .ToList();
            }
            else
            {
                // Clear suggestions when input is empty
                nameSurnameSuggestions.Clear();
            }
        }


        private void SelectNameSurnameSuggestion(string suggestion)
        {
            searchNameOrSurname = suggestion;
            nameSurnameSuggestions.Clear();
            StateHasChanged();
        }


        private async Task HandleInput(ChangeEventArgs e)
        {
            searchNameOrSurname = e.Value?.ToString().Trim() ?? string.Empty;

            if (searchNameOrSurname.Length >= 2)
            {
                try
                {
                    nameSurnameSuggestions = await Task.Run(() =>
                        dbContext.Students
                            .Where(s => 
                                s.Name.Contains(searchNameOrSurname) || 
                                s.Surname.Contains(searchNameOrSurname))
                            .Select(s => s.Name + " " + s.Surname)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error fetching student suggestions: {ex.Message}");
                    nameSurnameSuggestions.Clear();
                }
            }
            else
            {
                nameSurnameSuggestions.Clear();
            }

            StateHasChanged();
        }




        private void HandleProfessorInput(ChangeEventArgs e)
        {
            searchNameSurnameAsCompanyToFindProfessor = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchNameSurnameAsCompanyToFindProfessor) && searchNameSurnameAsCompanyToFindProfessor.Length >= 2)
            {
                professorNameSurnameSuggestions = dbContext.Professors
                    .Where(p => (p.ProfName + " " + p.ProfSurname).Contains(searchNameSurnameAsCompanyToFindProfessor))
                    .Select(p => p.ProfName + " " + p.ProfSurname) // Concatenate Name and Surname
                    .Distinct()
                    .ToList();
            }
            else
            {
                professorNameSurnameSuggestions.Clear();
            }
        }

        private void HandleResearchGroupInput(ChangeEventArgs e)
        {
            searchResearchGroupNameAsCompanyToFindResearchGroup = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchResearchGroupNameAsCompanyToFindResearchGroup) && searchResearchGroupNameAsCompanyToFindResearchGroup.Length >= 2)
            {
                researchgroupNameSuggestions = dbContext.ResearchGroups
                    .Where(p => (p.ResearchGroupName).Contains(searchResearchGroupNameAsCompanyToFindResearchGroup))
                    .Select(p => p.ResearchGroupName) 
                    .Distinct()
                    .ToList();
            }
            else
            {
                researchgroupNameSuggestions.Clear();
            }
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////
        private void HandleProfessorInputWhenSearchForProfessorAsRG(ChangeEventArgs e)
        {
            searchNameSurnameAsRGToFindProfessor = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchNameSurnameAsRGToFindProfessor) && searchNameSurnameAsRGToFindProfessor.Length >= 2)
            {
                professorNameSurnameSuggestionsAsRG = dbContext.Professors
                    .Where(p => (p.ProfName + " " + p.ProfSurname).Contains(searchNameSurnameAsRGToFindProfessor))
                    .Select(p => p.ProfName + " " + p.ProfSurname) // Concatenate Name and Surname
                    .Distinct()
                    .ToList();
            }
            else
            {
                professorNameSurnameSuggestionsAsRG.Clear();
            }
        }

        private void SelectProfessorNameSurnameSuggestionAsRG(string suggestion)
        {
            searchNameSurnameAsRGToFindProfessor = suggestion;
            professorNameSurnameSuggestionsAsRG.Clear();
        }

        private async Task HandleAreasOfInterestInputAsRG(ChangeEventArgs e)
        {
            searchAreasOfInterestAsRGToFindProfessor = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfInterestSuggestionsAsRG = new List<string>();

            if (searchAreasOfInterestAsRGToFindProfessor.Length >= 1)
            {
                try
                {
                    // Get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchAreasOfInterestAsRGToFindProfessor) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchAreasOfInterestAsRGToFindProfessor)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();

                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchAreasOfInterestAsRGToFindProfessor, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchAreasOfInterestAsRGToFindProfessor, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areasOfInterestSuggestionsAsRG = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Περιοχών Ενδιαφέροντος από την Βάση: {ex.Message}");
                    areasOfInterestSuggestionsAsRG = new List<string>();
                }
            }
            else
            {
                areasOfInterestSuggestionsAsRG.Clear();
            }

            StateHasChanged();
        }

        private void SelectAreasOfInterestSuggestionAsRG(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedAreasOfInterestAsRG.Contains(suggestion))
            {
                selectedAreasOfInterestAsRG.Add(suggestion);
                areasOfInterestSuggestionsAsRG.Clear(); // Clear suggestions
                searchAreasOfInterestAsRG = string.Empty; // Clear input field
            }
        }

        private void RemoveSelectedAreaOfInterestAsRG(string area)
        {
            selectedAreasOfInterestAsRG.Remove(area); // Remove area
            StateHasChanged(); // Refresh UI
        }

        private void SearchProfessorsAsRGToFindProfessor()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfInterestAsRG != null && selectedAreasOfInterestAsRG.Any())
                combinedSearchAreas.AddRange(selectedAreasOfInterestAsRG);

            if (!string.IsNullOrEmpty(searchAreasOfInterestAsRGToFindProfessor))
                combinedSearchAreas.Add(searchAreasOfInterestAsRGToFindProfessor);

            // Use your existing NormalizeAreas method for search terms
            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var professors = dbContext.Professors
                .AsEnumerable()
                .Where(p =>
                {
                    // Use your existing NormalizeAreas method for professor areas
                    var normalizedProfessorAreas = NormalizeAreas(p.ProfGeneralFieldOfWork).ToList();

                    // Extract expanded areas including subfields
                    var expandedProfessorAreas = ExpandAreasWithSubfields(normalizedProfessorAreas);

                    // Debugging
                    Console.WriteLine($"Professor: {p.ProfName} {p.ProfSurname}");
                    Console.WriteLine($"Professor Normalized Areas: {string.Join(", ", normalizedProfessorAreas)}");
                    Console.WriteLine($"Professor Expanded Areas: {string.Join(", ", expandedProfessorAreas)}");
                    Console.WriteLine($"Search Areas: {string.Join(", ", normalizedSearchAreas)}");

                    // Enhanced area matching that includes subfields
                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedProfessorAreas.Any(professorArea =>
                                professorArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(professorArea, StringComparison.OrdinalIgnoreCase)));

                    // Filter by school if selected
                    bool schoolMatch = true;
                    if (!string.IsNullOrEmpty(searchSchoolAsRGToFindProfessor))
                    {
                        var schoolDepartments = universityDepartments[searchSchoolAsRGToFindProfessor];
                        schoolMatch = schoolDepartments.Contains(p.ProfDepartment);
                    }

                    return (string.IsNullOrEmpty(searchNameSurnameAsRGToFindProfessor) || 
                            (p.ProfName + " " + p.ProfSurname).Contains(searchNameSurnameAsRGToFindProfessor)) &&
                        (string.IsNullOrEmpty(searchSchoolAsRGToFindProfessor) || schoolMatch) &&
                        (string.IsNullOrEmpty(searchDepartmentAsRGToFindProfessor) || p.ProfDepartment == searchDepartmentAsRGToFindProfessor) &&
                        areaMatch;
                })
                .ToList();

            searchResultsAsRGToFindProfessor = professors;
        }

        private void ClearSearchFieldsAsRGToFindProfessor()
        {
            searchNameSurnameAsRGToFindProfessor = string.Empty; 
            searchSchoolAsRGToFindProfessor = string.Empty;
            searchDepartmentAsRGToFindProfessor = string.Empty;   
            searchAreasOfInterestAsRGToFindProfessor = string.Empty; 
            searchResultsAsRGToFindProfessor = null; 
            areasOfInterestSuggestionsAsRG.Clear();
            selectedAreasOfInterestAsRG.Clear(); 

            StateHasChanged();
        }


        private int ProfessorsPerPage_SearchForProfessorsAsRG = 10; // Default value
        private int currentProfessorPage_SearchForProfessorsAsRG = 1;
        private void OnPageSizeChange_SearchForProfessorsAsRG(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                ProfessorsPerPage_SearchForProfessorsAsRG = newSize;
                currentProfessorPage_SearchForProfessorsAsRG = 1;
                StateHasChanged();
            }
        }

        private IEnumerable<Professor> GetPaginatedProfessorResultsAsRG()
        {
            return searchResultsAsRGToFindProfessor?
                .Skip((currentProfessorPage_SearchForProfessorsAsRG - 1) * ProfessorsPerPage_SearchForProfessorsAsRG)
                .Take(ProfessorsPerPage_SearchForProfessorsAsRG) 
                ?? Enumerable.Empty<Professor>();
        }

        private void ShowProfessorDetailsOnEyeIconWhenSearchForProfessorAsRG(Professor professor)
        {
            selectedProfessorWhenSearchForProfessorsAsRG = professor;
            showProfessorDetailsModalWhenSearchForProfessorsAsRG = true;
        }

        private void GoToFirstProfessorPageAsRG()
        {
            currentProfessorPage_SearchForProfessorsAsRG = 1;
            StateHasChanged();
        }

        private int totalProfessorPages_SearchForProfessorsAsRG => searchResultsAsRGToFindProfessor != null 
                ? (int)Math.Ceiling((double)searchResultsAsRGToFindProfessor.Count / ProfessorsPerPage_SearchForProfessorsAsRG) 
                : 1;
        private List<int> GetVisibleProfessorPagesAsRG()
        {
            var pagesAsRG = new List<int>();
            int currentPageAsRG = currentProfessorPage_SearchForProfessorsAsRG;
            int totalPagesAsRG = totalProfessorPages_SearchForProfessorsAsRG;

            // Always show first page
            pagesAsRG.Add(1);

            // Show pages around current page
            if (currentPageAsRG > 3) pagesAsRG.Add(-1); // Ellipsis

            int start = Math.Max(2, currentPageAsRG - 1);
            int end = Math.Min(totalPages - 1, currentPageAsRG + 1);

            for (int i = start; i <= end; i++)
            {
                pagesAsRG.Add(i);
            }

            if (currentPageAsRG < totalPagesAsRG - 2) pagesAsRG.Add(-1); // Ellipsis

            // Always show last page if different from first
            if (totalPagesAsRG > 1) pagesAsRG.Add(totalPagesAsRG);

            return pagesAsRG;
        }

        private void GoToProfessorPageAsRG(int pageNumberAsRG)
        {
            if (pageNumberAsRG >= 1 && pageNumberAsRG <= totalProfessorPages_SearchForProfessorsAsRG)
            {
                currentProfessorPage_SearchForProfessorsAsRG = pageNumberAsRG;
                StateHasChanged();
            }
        }

        private void PreviousProfessorPageAsRG()
        {
            if (currentProfessorPage_SearchForProfessorsAsRG > 1)
            {
                currentProfessorPage_SearchForProfessorsAsRG--;
                StateHasChanged();
            }
        }

        private void NextProfessorPageAsRG()
        {
            if (currentProfessorPage_SearchForProfessorsAsRG < totalProfessorPages_SearchForProfessorsAsRG)
            {
                currentProfessorPage_SearchForProfessorsAsRG++;
                StateHasChanged();
            }
        }

        private void GoToLastProfessorPageAsRG()
        {
            currentProfessorPage_SearchForProfessorsAsRG = totalProfessorPages_SearchForProfessorsAsRG;
            StateHasChanged();
        }


        private void CloseModalProfessorDetailsOnEyeIconWhenSearchForProfessorsAsRG()
        {
            showProfessorDetailsModalWhenSearchForProfessorsAsRG = false;
            selectedProfessorWhenSearchForProfessorsAsRG = null;
        }
        ////////////////////////////////////////////////////////////////////////////////////////////////////

        private void HandleProfessorInputWhenSearchForProfessorThesisAutocompleteNameAsStudent(ChangeEventArgs e)
        {
            searchNameSurnameAsStudentToFindProfessor = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchNameSurnameAsStudentToFindProfessor) && searchNameSurnameAsStudentToFindProfessor.Length >= 2)
            {
                professorNameSurnameSuggestions = dbContext.Professors
                    .Where(p => (p.ProfName + " " + p.ProfSurname).Contains(searchNameSurnameAsStudentToFindProfessor))
                    .Select(p => p.ProfName + " " + p.ProfSurname) // Concatenate Name and Surname
                    .Distinct()
                    .ToList();
            }
            else
            {
                professorNameSurnameSuggestions.Clear();
            }
        }

        // Select a suggestion for name and surname
        private void SelectProfessorNameSurnameSuggestionWhenSearchForProfessorThesisAutocompleteNameAsStudent(string suggestion)
        {
            searchNameSurnameAsStudentToFindProfessor = suggestion;
            professorNameSurnameSuggestions.Clear();
        }

        private void SelectProfessorNameSurnameSuggestion(string suggestion)
        {
            searchNameSurnameAsCompanyToFindProfessor = suggestion;
            professorNameSurnameSuggestions.Clear();
        }



        private async Task HandleAreasOfExpertiseInput(ChangeEventArgs e)
        {
            searchAreasOfExpertise = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfExpertiseSuggestions = new List<string>();

            if (searchAreasOfExpertise.Length >= 1)
            {
                try
                {
                    // First, get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchAreasOfExpertise) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchAreasOfExpertise)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();

                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchAreasOfExpertise, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchAreasOfExpertise, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areasOfExpertiseSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Περιοχών Εξειδίκευσης από την Βάση: {ex.Message}");
                    areasOfExpertiseSuggestions = new List<string>();
                }
            }
            else
            {
                areasOfExpertiseSuggestions.Clear();
            }

            StateHasChanged();
        }

        private async Task HandleAreasOfInterestInput(ChangeEventArgs e)
        {
            searchAreasOfInterestAsCompanyToFindProfessor = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfInterestSuggestions = new List<string>();

            if (searchAreasOfInterestAsCompanyToFindProfessor.Length >= 1)
            {
                try
                {
                    // Get all matching areas
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchAreasOfInterestAsCompanyToFindProfessor) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchAreasOfInterestAsCompanyToFindProfessor)))
                        .ToListAsync();

                    Console.WriteLine($"Found {allAreas.Count} matching areas in database");

                    var suggestionsSet = new HashSet<string>();

                    foreach (var area in allAreas)
                    {
                        Console.WriteLine($"Processing area: {area.AreaName} with subfields: {area.AreaSubFields}");

                        // Add main area
                        if (area.AreaName.Contains(searchAreasOfInterestAsCompanyToFindProfessor, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                            Console.WriteLine($"Added main area: {area.AreaName}");
                        }

                        // Process subfields
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchAreasOfInterestAsCompanyToFindProfessor, StringComparison.OrdinalIgnoreCase))
                                .ToList();

                            Console.WriteLine($"Found {subfields.Count} matching subfields");

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator instead of "/"
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                                Console.WriteLine($"Added combination: {combination}");
                            }
                        }
                    }

                    areasOfInterestSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();

                    Console.WriteLine($"Final suggestions count: {areasOfInterestSuggestions.Count}");
                    Console.WriteLine($"Final suggestions: {string.Join(", ", areasOfInterestSuggestions)}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Περιοχών Ενδιαφέροντος από την Βάση: {ex.Message}");
                    areasOfInterestSuggestions = new List<string>();
                }
            }
            else
            {
                areasOfInterestSuggestions.Clear();
            }

            StateHasChanged();
        }



        private void SelectAreasOfExpertiseSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedAreasOfExpertise.Contains(suggestion))
            {
                selectedAreasOfExpertise.Add(suggestion);
                areasOfExpertiseSuggestions.Clear(); // Clear suggestions
                searchAreasOfExpertise = string.Empty; // Clear input field
            }
        }

        private void SelectAreasOfInterestSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedAreasOfInterest.Contains(suggestion))
            {
                selectedAreasOfInterest.Add(suggestion);
                areasOfInterestSuggestions.Clear(); // Clear suggestions
                searchAreasOfInterest = string.Empty; // Clear input field
            }
        }

        private void RemoveSelectedAreaOfExpertise(string area)
        {
            selectedAreasOfExpertise.Remove(area); // Remove area
            StateHasChanged(); // Refresh UI
        }

        private void RemoveSelectedAreaOfInterest(string area)
        {
            selectedAreasOfInterest.Remove(area); // Remove area
            StateHasChanged(); // Refresh UI
        }


        private async Task HandleKeywordsInput(ChangeEventArgs e)
        {
            searchKeywords = e.Value?.ToString().Trim() ?? string.Empty;

            // Ensure keywordsSuggestions is never null
            keywordsSuggestions = new List<string>();

            if (searchKeywords.Length >= 1)
            {
                try
                {
                    // Fetch suggestions for Keywords/Skills with 1+ characters
                    keywordsSuggestions = await Task.Run(() =>
                        dbContext.Skills
                            .Where(k => k.SkillName.Contains(searchKeywords))
                            .Select(k => k.SkillName)
                            .Distinct()
                            .Take(10) // Limit suggestions to 10
                            .ToList() ?? new List<string>()); // Ensure empty list if null
                }
                catch (Exception ex)
                {
                    // Log the error for debugging purposes
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Ικανοτήτων από την Βάση: {ex.Message}");
                    keywordsSuggestions = new List<string>();  // Fallback to empty list
                }
            }
            else
            {
                keywordsSuggestions.Clear();  // Clear suggestions for fewer than 1 character
            }

            // Trigger UI refresh
            StateHasChanged();
        }

        private void SelectKeywordsSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedKeywords.Contains(suggestion))
            {
                selectedKeywords.Add(suggestion);  // Add to selected keywords
                searchKeywords = string.Empty;    // Clear input field
                keywordsSuggestions.Clear();      // Clear the suggestions list
            }
        }

        private void RemoveKeyword(string keyword)
        {
            if (selectedKeywords.Contains(keyword))
            {
                selectedKeywords.Remove(keyword);  // Remove from selected keywords
            }
        }



        private async Task DownloadStudentAttachmentAsCompanyInSearchForStudents(long studentId)
        {
            var student = await dbContext.Students
                .Where(s => s.Id == (int)studentId)
                .FirstOrDefaultAsync();

            if (student?.Attachment != null)
            {
                string fileName = $"{student.Name}_{student.Surname}_CV.pdf";
                string mimeType = "application/pdf";
                string base64Data = Convert.ToBase64String(student.Attachment);
                await JS.InvokeVoidAsync("downloadFile", fileName, mimeType, base64Data);
            }
        }

        private void LoadEventsForCalendar()
        {
            eventsForDate.Clear();
            eventsForDateForProfessors.Clear();
            int currentYear = currentMonth.Year;
            int currentMonthNumber = currentMonth.Month;

            // Loop through the events for the current month
            foreach (var eventItem in CompanyEventsToShowAtFrontPage)
            {
                if (eventItem.CompanyEventActiveDate.Year == currentYear &&
                    eventItem.CompanyEventActiveDate.Month == currentMonthNumber)
                {
                    int eventDay = eventItem.CompanyEventActiveDate.Day;
                    if (!eventsForDate.ContainsKey(eventDay))
                    {
                        eventsForDate[eventDay] = new List<CompanyEvent>();
                    }
                    eventsForDate[eventDay].Add(eventItem);
                }
            }


            //mpike gia ta professor events 22/1
            foreach (var eventProfessorItem in ProfessorEventsToShowAtFrontPage)
            {
                if (eventProfessorItem.ProfessorEventActiveDate.Year == currentYear &&
                    eventProfessorItem.ProfessorEventActiveDate.Month == currentMonthNumber)
                {
                    int eventDay = eventProfessorItem.ProfessorEventActiveDate.Day;
                    if (!eventsForDateForProfessors.ContainsKey(eventDay))
                    {
                        eventsForDateForProfessors[eventDay] = new List<ProfessorEvent>();
                    }
                    eventsForDateForProfessors[eventDay].Add(eventProfessorItem);
                }
            }

            // If highlighted day is not valid for this month, reset it
            if (highlightedDay != 0 && !eventsForDate.ContainsKey(highlightedDay))
            {
                highlightedDay = 0; // Reset it if there's no event for the day in the current month
            }

            // After loading events, ensure the selected and highlighted day is respected
            if (selectedDay != 0 && eventsForDate.ContainsKey(selectedDay))
            {
                highlightedDay = selectedDay; // Keep the selected day highlighted if valid
            }


            // GIA PROFESSORS EVENTS
            if (highlightedDay != 0 && !eventsForDateForProfessors.ContainsKey(highlightedDay))
            {
                highlightedDay = 0; // Reset it if there's no event for the day in the current month
            }

            // GIA PROFESSORS EVENTS
            if (selectedDay != 0 && eventsForDateForProfessors.ContainsKey(selectedDay))
            {
                highlightedDay = selectedDay; // Keep the selected day highlighted if valid
            }

            StateHasChanged();
        }



        private void ShowPreviousMonth()
        {
            currentMonth = currentMonth.AddMonths(-1);
            LoadEventsForCalendar();
            CalculateRemainingCells();  // Recalculate when changing the month
            StateHasChanged();

        }

        private void ShowNextMonth()
        {
            currentMonth = currentMonth.AddMonths(1);
            LoadEventsForCalendar();
            CalculateRemainingCells();  
            StateHasChanged();

        }

        private void OnDateClicked(DateTime clickedDate)
        {
            selectedDay = clickedDate.Day;  
            highlightedDay = selectedDay;
            selectedDate = clickedDate; // Make sure to set this for the modal display

            // Filter company events by status "Δημοσιευμένη" AND the specific date
            selectedDateEvents = dbContext.CompanyEvents
                .Include(e => e.Company)
                .Where(e => e.CompanyEventStatus == "Δημοσιευμένη" && 
                        e.CompanyEventActiveDate.Date == clickedDate.Date)
                .ToList();

            // Filter professor events by status "Δημοσιευμένη" AND the specific date
            selectedProfessorDateEvents = dbContext.ProfessorEvents
                .Include(e => e.Professor)
                .Where(e => e.ProfessorEventStatus == "Δημοσιευμένη" && 
                        e.ProfessorEventActiveDate.Date == clickedDate.Date)
                .ToList();

            // Only show modal if there are published events for this specific date
            if (selectedDateEvents.Any() || selectedProfessorDateEvents.Any())
            {
                isModalVisibleToShowEventsOnCalendarForEachClickedDay = true;
            }
            else
            {
                // Optional: Show a message that no events exist for this date
                // You could set a flag to display a message in your modal
            }

            StateHasChanged();
        }



        private void CloseModalShowingTheEventsOnCalendar()
        {
            isModalVisibleToShowEventsOnCalendarForEachClickedDay = false;
            selectedDateEvents.Clear();
            selectedProfessorDateEvents.Clear();


            // Re-render the calendar and highlight the selected day
            LoadEventsForCalendar();  // Reload events for the current month
            StateHasChanged();
        }



        private void ShowEventsForDate(List<CompanyEvent> events, List<ProfessorEvent> professorevents)
        {
            selectedDateEvents = events;
            selectedProfessorDateEvents = professorevents;

            isModalVisibleToShowEventsOnCalendarForEachClickedDay = true;
            StateHasChanged();

        }

        private void CalculateRemainingCells()
        {
            remainingCellsValue = totalCellsInGrid - (firstDayOfMonth + daysInCurrentMonth);
        }

        private void ChangeMonth(int monthChange)
        {
            currentMonth = currentMonth.AddMonths(monthChange);

            // Reset the highlighted day if it's invalid for the new month
            LoadEventsForCalendar();  // This will handle the resetting of highlightedDay
        }

        private async Task<List<CompanyEvent>> FetchCompanyEventsAsync()
        {
            var companyevents = await dbContext.CompanyEvents.AsNoTracking().ToListAsync(); 
            return companyevents;
        }

        private async Task<List<ProfessorEvent>> FetchProfessorEventsAsync()
        {
            var professorevents = await dbContext.ProfessorEvents.AsNoTracking().ToListAsync(); 
            return professorevents;
        }

        private bool isLoadingInterestedStudents = false;
        private long? loadingEventRNG = null;
        private async Task ShowInterestedStudentsInCompanyEvent(long eventRNG)
        {
            // Toggle the selectedEventIdForStudents to either show or hide the table
            if (selectedEventIdForStudents == eventRNG)
            {
                // Close the table by clearing the InterestedStudents
                selectedEventIdForStudents = null;
                InterestedStudents.Clear();
                StateHasChanged();
            }
            else
            {
                // Close professors section if it's open (from any event)
                selectedEventIdForProfessors = null;
                filteredProfessorInterestForCompanyEvents.Clear();

                // Close students section from other events if open
                if (selectedEventIdForStudents != null && selectedEventIdForStudents != eventRNG)
                {
                    selectedEventIdForStudents = null;
                    InterestedStudents.Clear();
                }

                // Show loading state
                isLoadingInterestedStudents = true;
                loadingEventRNG = eventRNG;
                StateHasChanged();

                try
                {
                    // Show the table and fetch the interested students for the selected event
                    selectedEventIdForStudents = eventRNG;

                    // Fetch the interested students with their details
                    var interestedStudentsWithDetails = await dbContext.InterestInCompanyEvents
                        .Include(x => x.StudentDetails)
                        .Where(x => x.RNGForCompanyEventInterest == eventRNG)
                        .Select(x => new 
                        {
                            Application = x,
                            Student = dbContext.Students.FirstOrDefault(s => s.Student_UniqueID == x.StudentUniqueIDShowInterestForEvent)
                        })
                        .ToListAsync();

                    // Convert to the expected type if needed
                    InterestedStudents = interestedStudentsWithDetails.Select(x => x.Application).ToList();

                    // ✅ Load full student data into cache (as in Job logic)
                    var studentEmails = interestedStudentsWithDetails
                        .Where(x => x.Student != null)
                        .Select(x => x.Student.Email.ToLower())
                        .Distinct()
                        .ToList();

                    var students = await dbContext.Students
                        .Where(s => studentEmails.Contains(s.Email.ToLower()))
                        .Select(s => new Student
                        {
                            Id = s.Id,
                            Student_UniqueID = s.Student_UniqueID,
                            Email = s.Email,
                            Image = s.Image,
                            Name = s.Name,
                            Surname = s.Surname,
                            Telephone = s.Telephone,
                            PermanentAddress = s.PermanentAddress,
                            PermanentRegion = s.PermanentRegion,
                            PermanentTown = s.PermanentTown,
                            Attachment = s.Attachment,
                            LinkedInProfile = s.LinkedInProfile,
                            PersonalWebsite = s.PersonalWebsite,
                            Transport = s.Transport,
                            RegNumber = s.RegNumber,
                            University = s.University,
                            Department = s.Department,
                            EnrollmentDate = s.EnrollmentDate,
                            StudyYear = s.StudyYear,
                            LevelOfDegree = s.LevelOfDegree,
                            AreasOfExpertise = s.AreasOfExpertise,
                            Keywords = s.Keywords,
                            ExpectedGraduationDate = s.ExpectedGraduationDate,
                            CompletedECTS = s.CompletedECTS
                        })
                        .AsNoTracking()
                        .ToListAsync();

                    studentDataCache.Clear();
                    foreach (var student in students)
                    {
                        studentDataCache[student.Email.ToLower()] = student;
                    }

                    Console.WriteLine($"Fetched {InterestedStudents.Count} students for Event RNG: {eventRNG}");
                    Console.WriteLine($"Loaded {students.Count} student records into cache.");
                }
                finally
                {
                    // Hide loading state
                    isLoadingInterestedStudents = false;
                    loadingEventRNG = null;
                    StateHasChanged();
                }
            }
        }


        private long? selectedEventIdForProfessorsWhenShowInterestForCompanyEvent;
        private bool isLoadingInterestedProfessors = false;
        private long? loadingEventRNGForProfessors = null;
        private async Task ShowInterestedProfessorsInCompanyEvent(long companyeventRNG)
        {
            if (selectedEventIdForProfessors == companyeventRNG)
            {
                // Close the table
                selectedEventIdForProfessors = null;
                filteredProfessorInterestForCompanyEvents.Clear();
                StateHasChanged();
            }
            else
            {
                // Close students section if it's open (from any event)
                selectedEventIdForStudents = null;
                InterestedStudents.Clear();

                // Close professors section from other events if open
                if (selectedEventIdForProfessors != null && selectedEventIdForProfessors != companyeventRNG)
                {
                    selectedEventIdForProfessors = null;
                    filteredProfessorInterestForCompanyEvents.Clear();
                }

                // Show loading state
                isLoadingInterestedProfessors = true;
                loadingEventRNGForProfessors = companyeventRNG;
                StateHasChanged();

                try
                {
                    // Show the table
                    selectedEventIdForProfessors = companyeventRNG;

                    // Load interests with professor details
                    filteredProfessorInterestForCompanyEvents = await dbContext.InterestInCompanyEventsAsProfessor
                        .Include(i => i.ProfessorDetails)
                        .Where(x => x.RNGForCompanyEventInterestAsProfessor == companyeventRNG)
                        .OrderByDescending(x => x.DateTimeProfessorShowInterestForCompanyEvent)
                        .AsNoTracking()
                        .ToListAsync();

                    // Get distinct professor emails not already in cache
                    var emailsToFetch = filteredProfessorInterestForCompanyEvents
                        .Select(i => i.ProfessorEmailShowInterestForCompanyEvent)
                        .Distinct()
                        .Where(email => !professorDataCache.ContainsKey(email))
                        .ToList();

                    // Fetch all needed professors in one query
                    if (emailsToFetch.Any())
                    {
                        var professors = await dbContext.Professors
                            .Where(p => emailsToFetch.Contains(p.ProfEmail))
                            .AsNoTracking()
                            .ToListAsync();

                        // Add fetched professors to cache
                        foreach (var professor in professors)
                        {
                            professorDataCache[professor.ProfEmail] = professor;
                        }
                    }
                }
                finally
                {
                    // Hide loading state
                    isLoadingInterestedProfessors = false;
                    loadingEventRNGForProfessors = null;
                    StateHasChanged();
                }
            }
        }

        private bool isLoadingInterestedStudentsForProfessorEvent = false;
        private long? loadingProfessorEventRNGForStudents = null;

        private long? currentlyExpandedProfessorEventId = null;
        private string? currentlyExpandedEventSectionType = null; // "students" or "companies"
        private async Task ShowInterestedStudentsInProfessorEvent(long professoreventRNG)
        {
            Console.WriteLine($"ShowInterestedStudentsInProfessorEvent called for event: {professoreventRNG}");

            // If clicking the same event students section that's already expanded, close it
            if (currentlyExpandedProfessorEventId == professoreventRNG && currentlyExpandedEventSectionType == "students")
            {
                currentlyExpandedProfessorEventId = null;
                currentlyExpandedEventSectionType = null;
                selectedEventIdForStudentsWhenShowInterestForProfessorEvent = null;
                InterestedStudentsForProfessorEvent.Clear();
                studentDataCache.Clear();
                StateHasChanged();
                return;
            }

            // Close any previously expanded sections (both students and companies)
            if (currentlyExpandedProfessorEventId.HasValue)
            {
                // Close students section if open
                if (selectedEventIdForStudentsWhenShowInterestForProfessorEvent == currentlyExpandedProfessorEventId.Value)
                {
                    selectedEventIdForStudentsWhenShowInterestForProfessorEvent = null;
                    InterestedStudentsForProfessorEvent.Clear();
                    studentDataCache.Clear();
                }
            
                // Close companies section if open
                if (selectedEventIdForCompaniesWhenShowInterestForProfessorEvent == currentlyExpandedProfessorEventId.Value)
                {
                    selectedEventIdForCompaniesWhenShowInterestForProfessorEvent = null;
                    filteredCompanyInterestForProfessorEvents.Clear();
                }
            }

            // Set the new expanded event and section type
            currentlyExpandedProfessorEventId = professoreventRNG;
            currentlyExpandedEventSectionType = "students";

            // Show loading state
            isLoadingInterestedStudentsForProfessorEvent = true;
            loadingProfessorEventRNGForStudents = professoreventRNG;
            StateHasChanged();

            try
            {
                // Show the table and fetch the interested students for the selected event
                selectedEventIdForStudentsWhenShowInterestForProfessorEvent = professoreventRNG;

                // Fetch the interested students with their details
                var interestedStudentsWithDetails = await dbContext.InterestInProfessorEvents
                    .Include(x => x.StudentDetails)
                    .Where(x => x.RNGForProfessorEventInterest == professoreventRNG)
                    .Select(x => new 
                    {
                        Application = x,
                        Student = dbContext.Students.FirstOrDefault(s => s.Student_UniqueID == x.StudentUniqueIDShowInterestForEvent)
                    })
                    .ToListAsync();

                // Convert to the expected type if needed
                InterestedStudentsForProfessorEvent = interestedStudentsWithDetails.Select(x => x.Application).ToList();

                // Load full student data into cache
                var studentEmails = interestedStudentsWithDetails
                    .Where(x => x.Student != null)
                    .Select(x => x.Student.Email.ToLower())
                    .Distinct()
                    .ToList();

                var students = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email.ToLower()))
                    .Select(s => new Student
                    {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords,
                        ExpectedGraduationDate = s.ExpectedGraduationDate,
                        CompletedECTS = s.CompletedECTS
                    })
                    .AsNoTracking()
                    .ToListAsync();

                studentDataCache.Clear();
                foreach (var student in students)
                {
                    studentDataCache[student.Email.ToLower()] = student;
                }

                Console.WriteLine($"Fetched {InterestedStudentsForProfessorEvent.Count} students for Event RNG: {professoreventRNG}");
                Console.WriteLine($"Loaded {students.Count} student records into cache.");
            }
            finally
            {
                // Hide loading state
                isLoadingInterestedStudentsForProfessorEvent = false;
                loadingProfessorEventRNGForStudents = null;
                StateHasChanged();
            }
        }

        private async Task ShowStudentDetailsAtCompanyEventInterest(InterestInCompanyEvent application)
        {
            // === STUDENT LOOKUP ===
            var studentUniqueId = application.StudentUniqueIDShowInterestForEvent;
            selectedStudentFromCache = studentDataCache.Values
                .FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

            if (selectedStudentFromCache == null)
            {
                Console.WriteLine($"Student with ID {studentUniqueId} not found in cache - loading from DB");

                selectedStudentFromCache = await dbContext.Students
                    .Where(s => s.Student_UniqueID == studentUniqueId)
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords
                    })
                    .FirstOrDefaultAsync();

                if (selectedStudentFromCache != null)
                {
                    studentDataCache[selectedStudentFromCache.Email.ToLower()] = selectedStudentFromCache;
                }
            }

            // === COMPANY LOOKUP ===
            var companyUniqueId = application.CompanyUniqueIDWhereStudentShowedInterest;
            Company selectedCompanyFromCache = null;

            if (!string.IsNullOrEmpty(companyUniqueId))
            {
                companyDataCache.TryGetValue(companyUniqueId, out selectedCompanyFromCache);

                if (selectedCompanyFromCache == null)
                {
                    Console.WriteLine($"Company with ID {companyUniqueId} not found in cache - loading from DB");

                    selectedCompanyFromCache = await dbContext.Companies
                        .Where(c => c.Company_UniqueID == companyUniqueId)
                        .FirstOrDefaultAsync();

                    if (selectedCompanyFromCache != null)
                    {
                        companyDataCache[companyUniqueId] = selectedCompanyFromCache;
                    }
                }
            }

            // === ASSIGN FINAL COMPOSITE OBJECT ===
            selectedStudentToShowDetailsForInterestinCompanyEvent = new InterestInCompanyEvent
            {
                Id = application.Id,
                CompanyEmailWhereStudentShowedInterest = application.CompanyEmailWhereStudentShowedInterest,
                CompanyUniqueIDWhereStudentShowedInterest = application.CompanyUniqueIDWhereStudentShowedInterest,
                StudentEmailShowInterestForEvent = application.StudentEmailShowInterestForEvent,
                StudentUniqueIDShowInterestForEvent = application.StudentUniqueIDShowInterestForEvent,
                RNGForCompanyEventInterest = application.RNGForCompanyEventInterest,
                RNGForCompanyEventInterest_HashedAsUniqueID = application.RNGForCompanyEventInterest_HashedAsUniqueID,
                DateTimeStudentShowInterest = application.DateTimeStudentShowInterest,
                StudentTransportNeedWhenShowInterestForCompanyEvent = application.StudentTransportNeedWhenShowInterestForCompanyEvent,
                StudentTransportChosenLocationWhenShowInterestForCompanyEvent = application.StudentTransportChosenLocationWhenShowInterestForCompanyEvent,
                CompanyEventStatusAtStudentSide = application.CompanyEventStatusAtStudentSide,
                CompanyEventStatusAtCompanySide = application.CompanyEventStatusAtCompanySide,

                StudentDetails = new InterestInCompanyEvent_StudentDetails
                {
                    StudentEmailShowInterestForCompanyEvent = selectedStudentFromCache?.Email,
                    StudentUniqueIDShowInterestForCompanyEvent = selectedStudentFromCache?.Student_UniqueID,
                    DateTimeStudentShowInterestForCompanyEvent = application.DateTimeStudentShowInterest,
                    RNGForCompanyEventShowInterestAsStudent_HashedAsUniqueID = application.RNGForCompanyEventInterest_HashedAsUniqueID
                },

                CompanyDetails = new InterestInCompanyEvent_CompanyDetails
                {
                    CompanyEmailWhereStudentShowInterestForCompanyEvent = selectedCompanyFromCache?.CompanyEmail,
                    CompanyUniqueIDWhereStudentShowInterestForCompanyEvent = selectedCompanyFromCache?.Company_UniqueID
                }
            };

            showModal = true;
            StateHasChanged();
        }


        private void CloseStudentDetailsModal()
        {
            showModal = false;
        }

        private bool IsValidEmailForCompanyJobs(string email)
        {
            if (string.IsNullOrWhiteSpace(email))
                return false;

            // Use simple regex for basic email validation
            return System.Text.RegularExpressions.Regex.IsMatch(email, 
                @"^[^@\s]+@[^@\s]+\.[^@\s]+$");
        }

        private bool IsValidEmailForProfessorInternships(string email)
        {
            if (string.IsNullOrWhiteSpace(email))
                return false;

            // Use simple regex for basic email validation
            return System.Text.RegularExpressions.Regex.IsMatch(email, 
                @"^[^@\s]+@[^@\s]+\.[^@\s]+$");
        }

        private bool IsValidPhoneNumber(string phoneNumber)
        {
            if (string.IsNullOrWhiteSpace(phoneNumber))
                return true;

            return System.Text.RegularExpressions.Regex.IsMatch(phoneNumber, @"^\d{10}$");
        }

        private void ValidatePostalCode(ChangeEventArgs e)
        {
            var inputValue = e.Value?.ToString() ?? string.Empty;
            showErrorMessageforPostalCode = !IsValidPostalCodeForCompanyJobs(inputValue);
        }

        private bool IsValidPostalCodeForCompanyJobs(string postalCode)
        {
            // Ensure it contains exactly 5 digits
            return !string.IsNullOrWhiteSpace(postalCode) &&
                System.Text.RegularExpressions.Regex.IsMatch(postalCode, @"^\d{5}$");
        }



        private async Task HandleTemporarySaveProfessorEvent()
        {
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε την <strong>Εκδήλωση</strong>;<br><br>" +
                "Η εκδήλωση θα καταχωρηθεί ως '<strong>Μη Δημοσιευμένη</strong>'."
        });

            if (!isConfirmed)
                return;

            await SaveProfessorEvent(false); 
        }

        private async Task HandlePublishSaveProfessorEvent()
        {
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε την <strong>Εκδήλωση</strong>;<br><br>" +
                "Η εκδήλωση θα καταχωρηθεί ως '<strong>Δημοσιευμένη</strong>'."
        });

            if (!isConfirmed)
                return;

            await SaveProfessorEvent(true); 
        }


        private bool showLoadingModalForProfessorEvent = false;
        private async Task SaveProfessorEvent(bool publishEvent)
        {
            // Show loading modal and reset progress
            showLoadingModalForProfessorEvent = true;
            loadingProgress = 0;
            showErrorMessageForUploadingProfessorEvent = false;
            isFormValidToSaveEventAsProfessor = false;
            showSuccessMessage = false;
            StateHasChanged();

            try
            {
                // Step 1: Build areas and subfields
                await UpdateProgressWhenUploadEventAsProfessor(10);
                var selectedAreas = new List<string>();

                // Add selected main areas
                foreach (var area in SelectedAreasWhenUploadEventAsProfessor)
                {
                    selectedAreas.Add(area.AreaName);
                }

                // Add selected subfields as areas (without the area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForProfessorEvent)
                {
                    foreach (var subField in areaSubFields.Value)
                    {
                        // Save subfields as individual areas
                        selectedAreas.Add(subField);
                    }
                }

                professorEvent.ProfessorEventAreasOfInterest = string.Join(",", selectedAreas);
                await UpdateProgressWhenUploadEventAsProfessor(20);

                // Step 2: Validation checks
                await UpdateProgressWhenUploadEventAsProfessor(30);
                if (await HandleProfessorEventValidationWhenUploadEventAsProfessor() == false)
                {
                    return;
                }
                await UpdateProgressWhenUploadEventAsProfessor(40);

                // Step 3: Get or create professor information
                await UpdateProgressWhenUploadEventAsProfessor(50);
                var professor = await dbContext.Professors
                    .FirstOrDefaultAsync(p => p.ProfEmail == CurrentUserEmail) ?? new Professor();

                // Update professor details
                professor.ProfEmail = CurrentUserEmail;
                professor.ProfName = professorName;
                professor.ProfSurname = professorSurname;
                professor.ProfUniversity = professorUniversity;
                professor.ProfImage = professorImage;

                if (professor.Id == 0) // New professor
                {
                    dbContext.Professors.Add(professor);
                }
                await UpdateProgressWhenUploadEventAsProfessor(60);

                // Step 4: Set event properties
                await UpdateProgressWhenUploadEventAsProfessor(70);
                professorEvent.RNGForEventUploadedAsProfessor = new Random().NextInt64();
                professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID = HashingHelper.HashLong(professorEvent.RNGForEventUploadedAsProfessor);
                professorEvent.ProfessorEventStatus = publishEvent ? "Δημοσιευμένη" : "Μη Δημοσιευμένη";
                professorEvent.ProfessorEmailUsedToUploadEvent = CurrentUserEmail;
                professorEvent.ProfessorEventUploadedDate = DateTime.Now;
                professorEvent.ProfessorEventTime = professorEvent.ProfessorEventTimeOnly.ToTimeSpan();
                professorEvent.Professor = professor;

                if (dbContext.Entry(professorEvent).State == EntityState.Detached)
                {
                    dbContext.ProfessorEvents.Add(professorEvent);
                }
                await UpdateProgressWhenUploadEventAsProfessor(80);

                // Step 5: Save to database
                await UpdateProgressWhenUploadEventAsProfessor(90);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenUploadEventAsProfessor(100);

                // Step 6: Success
                saveEventAsProfessorMessage = "Η εκδήλωση δημιουργήθηκε επιτυχώς";
                isSaveAnnouncementAsProfessorSuccessful = true;
                showSuccessMessage = true;

                // Small delay to show completion
                await Task.Delay(500);

                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForProfessorEvent = false;

                Console.WriteLine($"Σφάλμα κατά την αποθήκευση: {ex.Message}");
                Console.WriteLine($"Inner Exception: {ex.InnerException?.Message}");
                saveEventAsProfessorMessage = "Προέκυψε σφάλμα κατά την αποθήκευση. Παρακαλώ προσπαθήστε ξανά.";
                isSaveAnnouncementAsProfessorSuccessful = false;
                showSuccessMessage = false;
                showErrorMessageForUploadingProfessorEvent = true;
                StateHasChanged();
            }
        }

        private async Task<bool> HandleProfessorEventValidationWhenUploadEventAsProfessor()
        {
            // Validate required fields
            if (string.IsNullOrWhiteSpace(professorEvent.ProfessorEventType) ||
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventTitle) || 
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventDescription) || 
                professorEvent.ProfessorEventActiveDate.Date < DateTime.Today ||
                professorEvent.ProfessorEventTimeOnly == TimeOnly.MinValue ||
                IsTimeInRestrictedRangeWhenUploadEventAsProfessor(professorEvent.ProfessorEventTimeOnly) || 
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventPerifereiaLocation) ||
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventDimosLocation) ||
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventPlaceLocation) ||
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventPostalCodeLocation) ||
                professorEvent.ProfessorEventOfferingTransportToEventLocation == null ||
                !HasAnySelectionForProfessorEvent())
            {
                await HandleProfessorEventValidationErrorWhenUploadEventAsProfessor();
                return false;
            }

            // Validate transport starting points if transport is offered
            if (professorEvent.ProfessorEventOfferingTransportToEventLocation == true && 
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent1))
            {
                await HandleProfessorEventValidationErrorWhenUploadEventAsProfessor();
                return false;
            }

            // Validate other organizer if visible
            if (professorEvent.ProfessorEventOtherOrganizerToBeVisible && 
                string.IsNullOrWhiteSpace(professorEvent.ProfessorEventOtherOrganizer))
            {
                await HandleProfessorEventValidationErrorWhenUploadEventAsProfessor();
                return false;
            }

            // All validations passed
            isFormValidToSaveEventAsProfessor = true;
            showErrorMessageForUploadingProfessorEvent = false;
            return true;
        }

        private async Task HandleProfessorEventValidationErrorWhenUploadEventAsProfessor()
        {
            showLoadingModalForProfessorEvent = false;
            showErrorMessageForUploadingProfessorEvent = true;
            isFormValidToSaveEventAsProfessor = false;
            StateHasChanged();

            // Optional: Scroll to top to show error message
            await JS.InvokeVoidAsync("scrollToTop");
        }

        private async Task UpdateProgressWhenUploadEventAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }

        private async Task ShowStudentDetailsAtProfessorEventInterest(InterestInProfessorEvent application)
        {
            // === STUDENT LOOKUP ===
            var studentUniqueId = application.StudentUniqueIDShowInterestForEvent;
            selectedStudentFromCache = studentDataCache.Values
                .FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

            if (selectedStudentFromCache == null)
            {
                Console.WriteLine($"Student with ID {studentUniqueId} not found in cache - loading from DB");

                selectedStudentFromCache = await dbContext.Students
                    .Where(s => s.Student_UniqueID == studentUniqueId)
                    .Select(s => new Student {
                        Id = s.Id,
                        Student_UniqueID = s.Student_UniqueID,
                        Email = s.Email,
                        Image = s.Image,
                        Name = s.Name,
                        Surname = s.Surname,
                        Telephone = s.Telephone,
                        PermanentAddress = s.PermanentAddress,
                        PermanentRegion = s.PermanentRegion,
                        PermanentTown = s.PermanentTown,
                        Attachment = s.Attachment,
                        LinkedInProfile = s.LinkedInProfile,
                        PersonalWebsite = s.PersonalWebsite,
                        Transport = s.Transport,
                        RegNumber = s.RegNumber,
                        University = s.University,
                        Department = s.Department,
                        EnrollmentDate = s.EnrollmentDate,
                        StudyYear = s.StudyYear,
                        LevelOfDegree = s.LevelOfDegree,
                        AreasOfExpertise = s.AreasOfExpertise,
                        Keywords = s.Keywords
                    })
                    .FirstOrDefaultAsync();

                if (selectedStudentFromCache != null)
                {
                    studentDataCache[selectedStudentFromCache.Email.ToLower()] = selectedStudentFromCache;
                }
            }

            // === PROFESSOR LOOKUP ===
            var professorUniqueId = application.ProfessorUniqueIDWhereStudentShowedInterest;
            Professor selectedProfessorFromCache = null;

            if (!string.IsNullOrEmpty(professorUniqueId))
            {
                professorDataCache.TryGetValue(professorUniqueId, out selectedProfessorFromCache);

                if (selectedProfessorFromCache == null)
                {
                    Console.WriteLine($"Professor with ID {professorUniqueId} not found in cache - loading from DB");

                    selectedProfessorFromCache = await dbContext.Professors
                        .Where(p => p.Professor_UniqueID == professorUniqueId)
                        .FirstOrDefaultAsync();

                    if (selectedProfessorFromCache != null)
                    {
                        professorDataCache[professorUniqueId] = selectedProfessorFromCache;
                    }
                }
            }

            // === ASSIGN FINAL COMPOSITE OBJECT ===
            selectedStudentToShowDetailsForInterestinProfessorEvent = new InterestInProfessorEvent
            {
                Id = application.Id,
                ProfessorEmailWhereStudentShowedInterest = application.ProfessorEmailWhereStudentShowedInterest,
                ProfessorUniqueIDWhereStudentShowedInterest = application.ProfessorUniqueIDWhereStudentShowedInterest,
                StudentEmailShowInterestForEvent = application.StudentEmailShowInterestForEvent,
                StudentUniqueIDShowInterestForEvent = application.StudentUniqueIDShowInterestForEvent,
                RNGForProfessorEventInterest = application.RNGForProfessorEventInterest,
                RNGForProfessorEventInterest_HashedAsUniqueID = application.RNGForProfessorEventInterest_HashedAsUniqueID,
                DateTimeStudentShowInterest = application.DateTimeStudentShowInterest,
                StudentTransportNeedWhenShowInterestForProfessorEvent = application.StudentTransportNeedWhenShowInterestForProfessorEvent,
                StudentTransportChosenLocationWhenShowInterestForProfessorEvent = application.StudentTransportChosenLocationWhenShowInterestForProfessorEvent,
                ProfessorEventStatusAtStudentSide = application.ProfessorEventStatusAtStudentSide,
                ProfessorEventStatusAtProfessorSide = application.ProfessorEventStatusAtProfessorSide,

                StudentDetails = new InterestInProfessorEvent_StudentDetails
                {
                    StudentEmailShowInterestForProfessorEvent = selectedStudentFromCache?.Email,
                    StudentUniqueIDShowInterestForProfessorEvent = selectedStudentFromCache?.Student_UniqueID,
                    DateTimeStudentShowInterestForProfessorEvent = application.DateTimeStudentShowInterest,
                    RNGForProfessorEventShowInterestAsStudent_HashedAsUniqueID = application.RNGForProfessorEventInterest_HashedAsUniqueID
                },

                ProfessorDetails = new InterestInProfessorEvent_ProfessorDetails
                {
                    ProfessorEmailWhereStudentShowInterestForProfessorEvent = selectedProfessorFromCache?.ProfEmail,
                    ProfessorUniqueIDWhereStudentShowInterestForProfessorEvent = selectedProfessorFromCache?.Professor_UniqueID
                }
            };

            showModalForStudentsAtProfessorEventInterest = true;
            StateHasChanged();
        }

        private void CloseStudentDetailsModalAtProfessorEventInterest()
        {
            showModalForStudentsAtProfessorEventInterest = false;
        }


        private bool isLoadingEvents = false;
        private string selectedEventStatus = "all"; 
        private async Task ToggleAndLoadCompanyAndProfessorEventsAsStudent()
        {
            if (isLoadingEvents) return;

            isLoadingEvents = true;
            StateHasChanged(); // Show loading state

            try
            {
                // Check if we're opening the section
                bool isOpening = !isCompanyEventsVisibleToSeeAsStudent && !isProfessorEventsVisibleToSeeAsStudent;

                isCompanyEventsVisibleToSeeAsStudent = !isCompanyEventsVisibleToSeeAsStudent;
                isProfessorEventsVisibleToSeeAsStudent = isCompanyEventsVisibleToSeeAsStudent;

                if (isCompanyEventsVisibleToSeeAsStudent)
                {
                    // If opening, force load all events
                    if (isOpening)
                    {
                        await LoadAllEvents(); // Load without any date filtering
                    }
                    else
                    {
                        await LoadEventsWithFilter(); // Use current filter when reopening
                    }
                }
                else
                {
                    // Clear the lists when toggling off
                    companyEventsToSeeAsStudent = new List<CompanyEvent>();
                    professorEventsToSeeAsStudent = new List<ProfessorEvent>();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error toggling events: {ex.Message}");
                companyEventsToSeeAsStudent = new List<CompanyEvent>();
                professorEventsToSeeAsStudent = new List<ProfessorEvent>();
            }
            finally
            {
                isLoadingEvents = false;
                StateHasChanged(); // Hide loading indicator
            }
        }

        private async Task LoadAllEvents()
        {
            try
            {
                // Load all company events without date filtering
                companyEventsToSeeAsStudent = await dbContext.CompanyEvents
                    .Where(e => e.CompanyEventStatus == "Δημοσιευμένη")
                    .ToListAsync();

                // Load all professor events without date filtering
                professorEventsToSeeAsStudent = await dbContext.ProfessorEvents
                    .Include(e => e.Professor)
                    .Where(e => e.ProfessorEventStatus == "Δημοσιευμένη")
                    .ToListAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading all events: {ex.Message}");
                companyEventsToSeeAsStudent = new List<CompanyEvent>();
                professorEventsToSeeAsStudent = new List<ProfessorEvent>();
            }
        }

        private async Task OnEventStatusChange()
        {
            if (isCompanyEventsVisibleToSeeAsStudent || isProfessorEventsVisibleToSeeAsStudent)
            {
                await ToggleAndLoadCompanyAndProfessorEventsAsStudent();
            }
        }

        private void ToggleTransport(long rngForEventUploadedAsProfessor, object value)
        {
            bool isChecked = (bool)value;

            // Update transport need
            needsTransportForProfessorEvent[rngForEventUploadedAsProfessor] = isChecked;

            // If "Χρειάζομαι Μεταφορά" is unticked, remove the selected starting point entirely
            if (!isChecked)
            {
                selectedStartingPoint.Remove(rngForEventUploadedAsProfessor);
            }
        }



        private void CloseEventDetails()
        {
            selectedEvent = null; // Reset the selected event
        }

        private void ShowEventDetails(object eventDetails)
        {
            selectedEvent = eventDetails;
        }


        private void CloseModalForCompanyAndProfessorEventTitles()
        {
            selectedEvent = null; // Reset the selected event
            isModalVisibleToShowEventsOnCalendarForEachClickedDay = false;
            StateHasChanged(); // Refresh the modal content

        }

        private void CloseModal()
        {
            isModalVisibleToShowEventsOnCalendarForEachClickedDay = false;
            selectedEvent = null; // Reset any selected event
            StateHasChanged();
        }



        private DateTime ProfessorEventDate
        {
            get => _professorEventDate;
            set
            {
                _professorEventDate = value;
                CheckForExistingEventsAsProfessor();
            }
        }

        private void CheckForExistingEventsAsProfessor()
        {
            existingEventsCountToCheckAsProfessor = (eventsForDate.ContainsKey(ProfessorEventDate.Day) ? eventsForDate[ProfessorEventDate.Day].Count() : 0) + 
                                                    (eventsForDateForProfessors.ContainsKey(ProfessorEventDate.Day) ? eventsForDateForProfessors[ProfessorEventDate.Day].Count() : 0);
        }

        private async Task LoadProfessorInterestsForCompanyEvents()
        {
            filteredProfessorInterestForCompanyEvents = await dbContext.InterestInCompanyEventsAsProfessor
                .Where(i => i.ProfessorEmailShowInterestForCompanyEvent == CurrentUserEmail)
                .ToListAsync();
        }

        private async Task<bool> ShowInterestInCompanyEventAsProfessor(CompanyEvent companyEvent)
        {
            // First ask for confirmation
            var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                $"Πρόκεται να δείξετε Ενδιαφέρον για την Εκδήλωση: {companyEvent.CompanyEventTitle} της εταιρείας {companyEvent.Company?.CompanyName}. Είστε σίγουρος/η;");
            if (!confirmed) return false;

            // Retrieve the latest event status
            var latestEvent = await dbContext.CompanyEvents
                .AsNoTracking()
                .Where(e => e.RNGForEventUploadedAsCompany == companyEvent.RNGForEventUploadedAsCompany)
                .Select(e => new { e.CompanyEventStatus })
                .FirstOrDefaultAsync();

            if (latestEvent == null || latestEvent.CompanyEventStatus != "Δημοσιευμένη")
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Εκδήλωση έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα.");
                return false;
            }

            var professor = await GetProfessorDetails(CurrentUserEmail);
            if (professor == null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία καθηγητή.");
                return false;
            }

            var company = await GetCompanyDetails(companyEvent.CompanyEmailUsedToUploadEvent);
            if (company == null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία εταιρείας.");
                return false;
            }

            // Check for existing interest
            var existingInterest = await dbContext.InterestInCompanyEventsAsProfessor
                .FirstOrDefaultAsync(i => 
                    i.ProfessorEmailShowInterestForCompanyEvent == professor.ProfEmail &&
                    i.RNGForCompanyEventInterestAsProfessor == companyEvent.RNGForEventUploadedAsCompany);

            if (existingInterest != null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη δείξει ενδιαφέρον για: {companyEvent.CompanyEventTitle}!");
                return false;
            }

            using var transaction = await dbContext.Database.BeginTransactionAsync();
            try
            {
                // Create main interest record with details
                var interest = new InterestInCompanyEventAsProfessor
                {
                    RNGForCompanyEventInterestAsProfessor = companyEvent.RNGForEventUploadedAsCompany,
                    RNGForCompanyEventInterestAsProfessor_HashedAsUniqueID = companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID,
                    DateTimeProfessorShowInterestForCompanyEvent = DateTime.Now,
                    CompanyEventStatus_ShowInterestAsProfessor_AtCompanySide = "Προς Επεξεργασία",
                    CompanyEventStatus_ShowInterestAsProfessor_AtProfessorSide = "Έχετε Δείξει Ενδιαφέρον",
                    ProfessorEmailShowInterestForCompanyEvent = professor.ProfEmail,
                    ProfessorUniqueIDShowInterestForCompanyEvent = professor.Professor_UniqueID,
                    CompanyEmailWhereProfessorShowedInterest = companyEvent.CompanyEmailUsedToUploadEvent,
                    CompanyUniqueIDWhereProfessorShowedInterest = company.Company_UniqueID,

                    ProfessorDetails = new InterestInCompanyEventAsProfessor_ProfessorDetails
                    {
                        ProfessorUniqueIDShowInterestForCompanyEvent = professor.Professor_UniqueID,
                        ProfessorEmailShowInterestForCompanyEvent = professor.ProfEmail,
                        DateTimeProfessorShowInterestForCompanyEvent = DateTime.Now,
                        RNGForCompanyEventShowInterestAsProfessor_HashedAsUniqueID = companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID
                    },

                    CompanyDetails = new InterestInCompanyEventAsProfessor_CompanyDetails
                    {
                        CompanyUniqueIDWhereProfessorShowInterestForCompanyEvent = company.Company_UniqueID,
                        CompanyEmailWhereProfessorShowInterestForCompanyEvent = companyEvent.CompanyEmailUsedToUploadEvent
                    }
                };

                dbContext.InterestInCompanyEventsAsProfessor.Add(interest);

                // Add platform action
                dbContext.PlatformActions.Add(new PlatformActions
                {
                    UserRole_PerformedAction = "PROFESSOR",
                    ForWhat_PerformedAction = "COMPANY_EVENT",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(companyEvent.RNGForEventUploadedAsCompany),
                    TypeOfAction_PerformedAction = "SHOW_INTEREST",
                    DateTime_PerformedAction = DateTime.Now
                });

                await dbContext.SaveChangesAsync();
                await transaction.CommitAsync();

                // Send emails
                try
                {
                    await InternshipEmailService.SendConfirmationToProfessorForInterestInCompanyEvent(
                        professor.ProfEmail,
                        professor.ProfName,
                        professor.ProfSurname,
                        companyEvent.CompanyEventTitle,
                        company.CompanyName,
                        companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID);

                    await InternshipEmailService.SendNotificationToCompanyForProfessorInterestInEvent(
                        companyEvent.CompanyEmailUsedToUploadEvent,
                        company.CompanyName,
                        professor.ProfName,
                        professor.ProfSurname,
                        professor.ProfEmail,
                        professor.ProfWorkTelephone,
                        companyEvent.CompanyEventTitle,
                        companyEvent.RNGForEventUploadedAsCompany_HashedAsUniqueID);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Email error: {ex.Message}");
                }

                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Η έκφραση ενδιαφέροντος για την εκδήλωση {companyEvent.CompanyEventTitle} υποβλήθηκε επιτυχώς!");
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
                return false;
            }

            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            return false;
        }


        private async Task<bool> ShowInterestInProfessorEventAsCompany(ProfessorEvent professorEvent)
        {
            // First ask for confirmation - now using navigation property for professor name
            var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                $"Πρόκεται να δείξετε Ενδιαφέρον για την Εκδήλωση: {professorEvent.ProfessorEventTitle} του καθηγητή {professorEvent.Professor?.ProfName} {professorEvent.Professor?.ProfSurname}. Είστε σίγουρος/η;");
            if (!confirmed) return false;

            // Retrieve the latest event status with professor included
            var latestEvent = await dbContext.ProfessorEvents
                .Include(e => e.Professor)
                .AsNoTracking()
                .Where(e => e.RNGForEventUploadedAsProfessor == professorEvent.RNGForEventUploadedAsProfessor)
                .Select(e => new { e.ProfessorEventStatus })
                .FirstOrDefaultAsync();

            if (latestEvent == null || latestEvent.ProfessorEventStatus != "Δημοσιευμένη")
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Η Εκδήλωση έχει Αποδημοσιευτεί. Παρακαλώ δοκιμάστε αργότερα.");
                return false;
            }

            var company = await GetCompanyDetails(CurrentUserEmail);
            if (company == null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία εταιρείας.");
                return false;
            }

            // Get professor from navigation property or fall back to query
            var professor = professorEvent.Professor ?? await dbContext.Professors
                .FirstOrDefaultAsync(p => p.ProfEmail == professorEvent.ProfessorEmailUsedToUploadEvent);

            if (professor == null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν βρέθηκαν στοιχεία καθηγητή.");
                return false;
            }

            // Check for existing interest
            var existingInterest = await dbContext.InterestInProfessorEventsAsCompany
                .FirstOrDefaultAsync(i => 
                    i.CompanyEmailShowInterestForProfessorEvent == company.CompanyEmail &&
                    i.RNGForProfessorEventInterestAsCompany == professorEvent.RNGForEventUploadedAsProfessor);

            if (existingInterest != null)
            {
                await JS.InvokeVoidAsync("confirmActionWithHTML2", $"Έχετε ήδη δείξει ενδιαφέρον για: {professorEvent.ProfessorEventTitle}!");
                return false;
            }

            if (!numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent.TryGetValue(professorEvent.RNGForEventUploadedAsProfessor, out var numberOfPeople))
            {
                await ShowAlert("Παρακαλώ επιλέξτε αριθμό ατόμων πριν δείξετε ενδιαφέρον.");
                return false;
            }

            using var transaction = await dbContext.Database.BeginTransactionAsync();
            try
            {
                // Create main interest record with details
                var interest = new InterestInProfessorEventAsCompany
                {
                    RNGForProfessorEventInterestAsCompany = professorEvent.RNGForEventUploadedAsProfessor,
                    RNGForProfessorEventInterestAsCompany_HashedAsUniqueID = professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                    DateTimeCompanyShowInterestForProfessorEvent = DateTime.Now,
                    ProfessorEventStatus_ShowInterestAsCompany_AtCompanySide = "Έχετε Δείξει Ενδιαφέρον",
                    ProfessorEventStatus_ShowInterestAsCompany_AtProfessorSide = "Προς Επεξεργασία",
                    ProfessorEmailWhereCompanyShowedInterest = professorEvent.ProfessorEmailUsedToUploadEvent, // Updated to use foreign key
                    ProfessorUniqueIDWhereCompanyShowedInterest = professor.Professor_UniqueID,
                    CompanyEmailShowInterestForProfessorEvent = company.CompanyEmail,
                    CompanyUniqueIDShowInterestForProfessorEvent = company.Company_UniqueID,
                    CompanyNumberOfPeopleToShowUpWhenShowInterestForProfessorEvent = numberOfPeople.ToString(),

                    CompanyDetails = new InterestInProfessorEventAsCompany_CompanyDetails
                    {
                        CompanyUniqueIDShowInterestForProfessorEvent = company.Company_UniqueID,
                        CompanyEmailShowInterestForProfessorEvent = company.CompanyEmail,
                        DateTimeCompanyShowInterestForProfessorEvent = DateTime.Now,
                        RNGForProfessorEventShowInterestAsCompany_HashedAsUniqueID = professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID
                    },

                    ProfessorDetails = new InterestInProfessorEventAsCompany_ProfessorDetails
                    {
                        ProfessorUniqueIDWhereCompanyShowInterestForProfessorEvent = professor.Professor_UniqueID,
                        ProfessorEmailWhereCompanyShowInterestForProfessorEvent = professorEvent.ProfessorEmailUsedToUploadEvent // Updated to use foreign key
                    }
                };

                dbContext.InterestInProfessorEventsAsCompany.Add(interest);

                // Add platform action
                dbContext.PlatformActions.Add(new PlatformActions
                {
                    UserRole_PerformedAction = "COMPANY",
                    ForWhat_PerformedAction = "PROFESSOR_EVENT",
                    HashedPositionRNG_PerformedAction = HashingHelper.HashLong(professorEvent.RNGForEventUploadedAsProfessor),
                    TypeOfAction_PerformedAction = "SHOW_INTEREST",
                    DateTime_PerformedAction = DateTime.Now
                });

                await dbContext.SaveChangesAsync();
                await transaction.CommitAsync();

                // Send emails - updated to use professor from navigation property
                try
                {
                    await InternshipEmailService.SendConfirmationToCompanyForInterestInProfessorEvent(
                        company.CompanyEmail,
                        company.CompanyName,
                        professorEvent.ProfessorEventTitle,
                        professor.ProfName,
                        professor.ProfSurname,
                        professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                        numberOfPeople);

                    await InternshipEmailService.SendNotificationToProfessorForCompanyInterestInEvent(
                        professor.ProfEmail,
                        professor.ProfName,
                        professor.ProfSurname,
                        company.CompanyName,
                        company.CompanyEmail,
                        company.CompanyTelephone,
                        professorEvent.ProfessorEventTitle,
                        professorEvent.RNGForEventUploadedAsProfessor_HashedAsUniqueID,
                        numberOfPeople);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Email error: {ex.Message}");
                }

                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Η έκφραση ενδιαφέροντος για την εκδήλωση {professorEvent.ProfessorEventTitle} υποβλήθηκε επιτυχώς!");
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                Console.WriteLine($"Full error: {ex}");
                await JS.InvokeVoidAsync("confirmActionWithHTML2", 
                    $"Σφάλμα κατά την υποβολή: {ex.InnerException?.Message ?? ex.Message}");
                return false;
            }

            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            return false;
        }

        private int GetOrAddNumberOfPeople(long eventId)
        {
            if (!numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent.ContainsKey(eventId))
            {
                numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent[eventId] = 1; // Default value
            }
            return numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent[eventId];
        }

        private void SetNumberOfPeople(long eventId, int value)
        {
            if (numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent.ContainsKey(eventId))
            {
                numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent[eventId] = value;
            }
            else
            {
                numberOfCompanyPeopleInputWhenCompanyShowsInterestInProfessorEvent.Add(eventId, value);
            }
        }


        private string ProfessorInternshipAttachmentErrorMessage = string.Empty;
        private async Task HandleFileUploadForProfessorInternships(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;

                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    professorInternship.ProfessorInternshipAttachment = null;
                    ProfessorInternshipAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    ProfessorInternshipAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    professorInternship.ProfessorInternshipAttachment = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    ProfessorInternshipAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    professorInternship.ProfessorInternshipAttachment = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                professorInternship.ProfessorInternshipAttachment = ms.ToArray();

                // Clear any previous error message
                ProfessorInternshipAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading professor internship attachment: {ex.Message}");
                ProfessorInternshipAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                professorInternship.ProfessorInternshipAttachment = null;
            }
        }

        private bool showLoadingModalForProfessorInternship = false;
        private async Task SaveProfessorInternship(bool isPublished)
        {
            // Show loading modal and reset progress
            showLoadingModalForProfessorInternship = true;
            loadingProgress = 0;
            showErrorMessage = false;
            showSuccessMessage = false;
            StateHasChanged();

            // Debug logging
            Console.WriteLine($"Validation check - Title: {professorInternship.ProfessorInternshipTitle}");
            Console.WriteLine($"Validation check - Type: {professorInternship.ProfessorInternshipType}");
            Console.WriteLine($"Validation check - ESPA: {professorInternship.ProfessorInternshipESPA}");
            Console.WriteLine($"Validation check - ContactPerson: {professorInternship.ProfessorInternshipContactPerson}");
            Console.WriteLine($"Validation check - Description: {professorInternship.ProfessorInternshipDescription}");
            Console.WriteLine($"Validation check - ActivePeriod: {professorInternship.ProfessorInternshipActivePeriod} (Today: {DateTime.Today})");
            Console.WriteLine($"Validation check - FinishEstimation: {professorInternship.ProfessorInternshipFinishEstimation} (Today: {DateTime.Today})");
            Console.WriteLine($"Validation check - SelectedAreas count: {SelectedAreasWhenUploadInternshipAsProfessor.Count}");
            Console.WriteLine($"Validation check - SelectedSubFields count: {SelectedSubFieldsForProfessorInternship.Count}");
            Console.WriteLine($"Validation check - HasAnySelection: {HasAnySelectionForProfessorInternship()}");
            Console.WriteLine($"Validation check - Email: {professorInternship.ProfessorEmailUsedToUploadInternship} (Valid: {IsValidEmailForProfessorInternships(professorInternship.ProfessorEmailUsedToUploadInternship)})");
            Console.WriteLine($"Validation check - Region: {professorInternship.ProfessorInternshipPerifereiaLocation}");
            Console.WriteLine($"Validation check - Town: {professorInternship.ProfessorInternshipDimosLocation}");

            try
            {
                // Step 1: Build areas and subfields
                await UpdateProgressWhenSaveInternshipAsProfessor(10);
                var areasWithSubfields = new List<string>();

                // Add selected areas (using AreaName)
                foreach (var area in SelectedAreasWhenUploadInternshipAsProfessor)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields (just the subfield names, not with area prefix)
                foreach (var areaSubFields in SelectedSubFieldsForProfessorInternship)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }
                await UpdateProgressWhenSaveInternshipAsProfessor(20);

                // Step 2: Validation checks
                await UpdateProgressWhenSaveInternshipAsProfessor(30);
                if (await HandleProfessorInternshipValidationWhenSaveInternshipAsProfessor(areasWithSubfields) == false)
                {
                    return;
                }
                await UpdateProgressWhenSaveInternshipAsProfessor(40);

                // Step 3: Prepare internship data
                await UpdateProgressWhenSaveInternshipAsProfessor(50);
                professorInternship.RNGForInternshipUploadedAsProfessor = new Random().NextInt64();
                professorInternship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID = HashingHelper.HashLong(professorInternship.RNGForInternshipUploadedAsProfessor);
                professorInternship.ProfessorUploadedInternshipStatus = isPublished ? "Δημοσιευμένη" : "Μη Δημοσιευμένη";
                professorInternship.ProfessorInternshipUploadDate = DateTime.Now;
                professorInternship.ProfessorInternshipAreas = string.Join(",", areasWithSubfields);
                professorInternship.OpenSlots_ProfessorInternship = professorInternship.OpenSlots_ProfessorInternship;
                await UpdateProgressWhenSaveInternshipAsProfessor(60);

                // Step 4: Set EKPA supervisor (if applicable)
                await UpdateProgressWhenSaveInternshipAsProfessor(70);
                if (selectedCompanyId.HasValue)
                {
                    var company = await dbContext.Companies
                        .FirstOrDefaultAsync(p => p.Id == selectedCompanyId.Value);

                    professorInternship.ProfessorInternshipEKPASupervisor = company?.CompanyName ?? "Unknown Company";
                }
                else
                {
                    professorInternship.ProfessorInternshipEKPASupervisor = "Χωρίς Προτίμηση";
                }
                await UpdateProgressWhenSaveInternshipAsProfessor(80);

                // Step 5: Save to database
                await UpdateProgressWhenSaveInternshipAsProfessor(90);
                Console.WriteLine($"Saving internship: {professorInternship.ProfessorInternshipTitle}, Status: {professorInternship.ProfessorUploadedInternshipStatus}");

                dbContext.ProfessorInternships.Add(professorInternship);
                await dbContext.SaveChangesAsync();
                await UpdateProgressWhenSaveInternshipAsProfessor(100);

                // Step 6: Success
                showSuccessMessage = true;
                showErrorMessage = false;

                // Reset form and update UI
                professorInternship = new ProfessorInternship();
                SelectedAreasWhenUploadInternshipAsProfessor.Clear();
                SelectedSubFieldsForProfessorInternship.Clear();
                ExpandedAreasForProfessorInternship.Clear();

                // Small delay to show completion
                await Task.Delay(500);
            
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalForProfessorInternship = false;
            
                showSuccessMessage = false;
                showErrorMessage = true;
                Console.WriteLine($"Error uploading professor internship: {ex.Message}");
                await JS.InvokeVoidAsync("alert", $"Error saving internship: {ex.Message}");
                StateHasChanged();
            }
        }

        private async Task<bool> HandleProfessorInternshipValidationWhenSaveInternshipAsProfessor(List<string> areasWithSubfields)
        {
            // UPDATED VALIDATION: Fixed date validation to match the new rules
            if (string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipTitle) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipType) ||
                (professorInternship.OpenSlots_ProfessorInternship < 3) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipESPA) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipContactPerson) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipDescription) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipPerifereiaLocation) ||
                string.IsNullOrWhiteSpace(professorInternship.ProfessorInternshipDimosLocation) ||
                !IsValidEmailForProfessorInternships(professorInternship.ProfessorEmailUsedToUploadInternship) ||
                professorInternship.ProfessorInternshipActivePeriod.Date <= DateTime.Today || // CHANGED: <= instead of <
                professorInternship.ProfessorInternshipFinishEstimation.Date <= professorInternship.ProfessorInternshipActivePeriod.Date || // CHANGED: Check if finish date is after start date
                // UPDATED: Check if there are any selections (areas OR subfields)
                !HasAnySelectionForProfessorInternship())
            {
                await HandleProfessorInternshipValidationErrorWhenSaveInternshipAsProfessor();
                return false;
            }


            return true;
        }

        private async Task HandleProfessorInternshipValidationErrorWhenSaveInternshipAsProfessor()
        {
            showLoadingModalForProfessorInternship = false;
            showErrorMessage = true;
            Console.WriteLine("Validation failed: Missing fields or invalid date.");
            StateHasChanged();
        
        }

        private async Task UpdateProgressWhenSaveInternshipAsProfessor(int progress)
        {
            loadingProgress = progress;
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth progress animation
        }



        private async Task HandleSaveClickToSaveProfessorInternship()
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε <strong>Νέα Θέση Πρακτικής Άσκησης</strong>;<br><br>" +
                "Η Θέση θα καταχωρηθεί ως '<strong>Μη Δημοσιευμένη</strong>' στο Ιστορικό Θέσεων Πρακτικής Άσκησης.<br><br>" +
                "<strong style='color: red;'>Αν επιθυμείτε να την Δημοσιεύσετε, απαιτούνται επιπλέον ενέργειες!</strong>"
            });

            if (!isConfirmed)
                return;

            // Save as "Μη Δημοσιευμένη"
            professorInternship.ProfessorUploadedInternshipStatus = "Μη Δημοσιευμένη";

            // Pass 'false' to indicate it's not published
            await SaveProfessorInternship(false);
        }


        private async Task HandlePublishClickToSaveProfessorInternship()
        {
            // Show custom confirmation dialog with HTML styling
            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                "Είστε σίγουροι πως θέλετε να υποβάλλετε <strong>Νέα Θέση Πρακτικής Άσκησης</strong>;<br><br>" +
                "Η Θέση θα καταχωρηθεί ως '<strong>Δημοσιευμένη</strong>' στο Ιστορικό Θέσεων Πρακτικής Άσκησης.<br><br>" +
                "<strong style='color: red;'>Αν επιθυμείτε να την Αποδημοσιεύσετε, απαιτούνται επιπλέον ενέργειες!</strong>"
            });

            if (!isConfirmed)
                return;

            // Save as "Δημοσιευμένη"
            professorInternship.ProfessorUploadedInternshipStatus = "Δημοσιευμένη";

            // Pass 'true' to indicate it's published
            await SaveProfessorInternship(true);
        }


        private CompanyInternship ConvertToCompanyInternship(AllInternships internship)
        {
            return new CompanyInternship
            {
                RNGForInternshipUploadedAsCompany = internship.RNGForCompanyInternship, // Updated property
                CompanyInternshipTitle = internship.InternshipTitle,
                CompanyInternshipType = internship.InternshipType,
                CompanyEmailUsedToUploadInternship = internship.CompanyEmail, // Updated property
                RNGForInternshipUploadedAsCompany_HashedAsUniqueID = internship.RNGForCompanyInternship_HashedAsUniqueID, // Updated property
                Company = new Company { CompanyName = internship.CompanyName } // Set via navigation property
            };
        }

        private ProfessorInternship ConvertToProfessorInternship(AllInternships internship)
        {
            return new ProfessorInternship
            {
                RNGForInternshipUploadedAsProfessor = internship.RNGForProfessorInternship,
                ProfessorInternshipTitle = internship.InternshipTitle,
                ProfessorInternshipType = internship.InternshipType,
                ProfessorEmailUsedToUploadInternship = internship.ProfessorEmail,
                RNGForInternshipUploadedAsProfessor_HashedAsUniqueID = internship.RNGForProfessorInternship_HashedAsUniqueID,
                Professor = new Professor { ProfName = internship.ProfessorName } // Set via navigation property

            };
        }

        private async Task ShowCompanyDetailsInThesisCompanyName_StudentThesisApplications(string companyEmail)
        {
            try
            {
                // First check if we already have the company details in cache
                if (companyDataCache.TryGetValue(companyEmail, out var cachedCompany))
                {
                    selectedCompanyDetails_ThesisStudentApplicationsToShow = cachedCompany;
                }
                else
                {
                    // Fetch the company details from the database using email (more reliable than name)
                    selectedCompanyDetails_ThesisStudentApplicationsToShow = await dbContext.Companies
                        .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

                    // Add to cache if found
                    if (selectedCompanyDetails_ThesisStudentApplicationsToShow != null)
                    { 
                        companyDataCache[companyEmail] = selectedCompanyDetails_ThesisStudentApplicationsToShow;
                    }
                }

                if (selectedCompanyDetails_ThesisStudentApplicationsToShow != null)
                {
                    isModalOpenToSeeCompanyDetails_ThesisStudentApplicationsToShow = true;
                    StateHasChanged();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία εταιρείας");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading company details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα φόρτωσης στοιχείων εταιρείας");
            }
        }

        private void CloseCompanyDetailsModal_StudentThesisApplications()
        {
            isModalOpenToSeeCompanyDetails_ThesisStudentApplicationsToShow = false;
            StateHasChanged();
        }

        private async Task ShowProfessorDetailsInThesisProfessorName_StudentThesisApplications(string professorEmail)
        {
            try
            {
                // First check if we already have the professor details in cache
                if (professorDataCache.TryGetValue(professorEmail, out var cachedProfessor))
                {
                    selectedProfessorDetails_ThesisStudentApplicationsToShow = cachedProfessor;
                }
                else
                {
                    // Fetch the professor details from the database using email (more reliable than name)
                    selectedProfessorDetails_ThesisStudentApplicationsToShow = await dbContext.Professors
                        .FirstOrDefaultAsync(p => p.ProfEmail == professorEmail);

                    // Add to cache if found
                    if (selectedProfessorDetails_ThesisStudentApplicationsToShow != null)
                    { 
                        professorDataCache[professorEmail] = selectedProfessorDetails_ThesisStudentApplicationsToShow;
                    }
                }

                if (selectedProfessorDetails_ThesisStudentApplicationsToShow != null)
                {
                    isModalOpenToSeeProfessorDetails_ThesisStudentApplicationsToShow = true;
                    StateHasChanged();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία καθηγητή");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading professor details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα φόρτωσης στοιχείων καθηγητή");
            }
        }


        private void CloseProfessorDetailsModal_StudentThesisApplications()
        {
            isModalOpenToSeeProfessorDetails_ThesisStudentApplicationsToShow = false;
            StateHasChanged();
        }

        private void CloseProfessorDetailsModal_StudentInternshipApplications()
        {
            isProfessorDetailsModalVisible_StudentInternshipApplicationsShow = false;
            StateHasChanged();
        }

        private async Task ShowCompanyThesisDetailsModal_StudentThesisApplications(long thesisRNG)
        {
            // Fetch the company thesis details asynchronously
            selectedCompanyThesisDetails_ThesisStudentApplicationsToShow = await dbContext.CompanyTheses
                .FirstOrDefaultAsync(t => t.RNGForThesisUploadedAsCompany == thesisRNG);

            if (selectedCompanyThesisDetails_ThesisStudentApplicationsToShow != null)
            {
                // Open the modal if the thesis details are found
                isModalOpenToSeeCompanyThesisDetails_ThesisStudentApplicationsToShow = true;
                StateHasChanged(); // Update the UI
            }
            else
            {
                // Show an alert if no thesis details are found
                await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν μπορούν να εμφανιστούν οι λεπτομέρειες της Διπλωματικής. <span style='color:darkred;'>Η Διπλωματική Δεν Είναι Πλέον Διαθέσιμη από τον Φορέα</span>");
            }
        }

        private void CloseCompanyThesisDetailsModal_StudentThesisApplications()
        {
            // Close the modal and reset the thesis details
            isModalOpenToSeeCompanyThesisDetails_ThesisStudentApplicationsToShow = false;
            StateHasChanged(); // Update the UI
        }

        private async Task ShowProfessorThesisDetailsModal_StudentThesisApplications(long thesisRNG)
        {
            // Fetch the professor thesis details asynchronously
            selectedProfessorThesisDetails_ThesisStudentApplicationsToShow = await dbContext.ProfessorTheses
                .FirstOrDefaultAsync(t => t.RNGForThesisUploaded == thesisRNG);

            if (selectedProfessorThesisDetails_ThesisStudentApplicationsToShow != null)
            {
                // Open the modal if the thesis details are found
                isModalOpenToSeeProfessorThesisDetails_ThesisStudentApplicationsToShow = true;
                StateHasChanged(); // Update the UI
            }
            else
            {
                // Show an alert if no thesis details are found
                await JS.InvokeVoidAsync("alert", "Professor thesis details not found.");
            }
        }

        private void CloseProfessorThesisDetailsModal_StudentThesisApplications()
        {
            isModalOpenToSeeProfessorThesisDetails_ThesisStudentApplicationsToShow = false;
            StateHasChanged(); 
        }

        private void CloseCompanyThesisEditModal()
        {
            isModalVisibleToEditCompanyThesisDetails = false;
        }

        private async Task SaveEditedCompanyThesis()
        {
            try
            {
                // Check if required fields are filled
                if (string.IsNullOrWhiteSpace(selectedCompanyThesis.CompanyThesisTitle) ||
                    string.IsNullOrWhiteSpace(selectedCompanyThesis.CompanyThesisDescriptionsUploaded))
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    return; // Prevent saving if required fields are missing
                }

                // Build areas and subfields string (same format as create)
                var areasWithSubfields = new List<string>();

                // Add selected areas
                foreach (var area in SelectedAreasToEditForCompanyThesis)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditCompanyThesis)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Convert to comma-separated string
                selectedCompanyThesis.CompanyThesisAreasUpload = string.Join(",", areasWithSubfields);

                // Ensure SelectedSkillsToEditForCompanyThesis contains all checked skills (even if no changes were made)
                if (SelectedSkillsToEditForCompanyThesis == null || !SelectedSkillsToEditForCompanyThesis.Any())
                {
                    var currentSkills = selectedCompanyThesis.CompanyThesisSkillsNeeded?.Split(",").ToList() ?? new List<string>();
                    SelectedSkillsToEditForCompanyThesis = Skills
                        .Where(skill => currentSkills.Contains(skill.SkillName))
                        .ToList();
                }

                // Convert the selected skills to a comma-separated string
                selectedCompanyThesis.CompanyThesisSkillsNeeded = string.Join(",", SelectedSkillsToEditForCompanyThesis.Select(skill => skill.SkillName));

                // Find and update the thesis in the database
                var thesisToUpdate = await dbContext.CompanyTheses.FindAsync(selectedCompanyThesis.Id);
                if (thesisToUpdate != null)
                {
                    // Update properties from the edited copy
                    thesisToUpdate.CompanyThesisTitle = selectedCompanyThesis.CompanyThesisTitle;
                    thesisToUpdate.CompanyThesisCompanySupervisorFullName = selectedCompanyThesis.CompanyThesisCompanySupervisorFullName;
                    thesisToUpdate.CompanyThesisDescriptionsUploaded = selectedCompanyThesis.CompanyThesisDescriptionsUploaded;
                    thesisToUpdate.CompanyThesisAreasUpload = selectedCompanyThesis.CompanyThesisAreasUpload;
                    thesisToUpdate.CompanyThesisSkillsNeeded = selectedCompanyThesis.CompanyThesisSkillsNeeded;
                    thesisToUpdate.CompanyThesisDepartment = selectedCompanyThesis.CompanyThesisDepartment;
                    thesisToUpdate.CompanyThesisStartingDate = selectedCompanyThesis.CompanyThesisStartingDate;
                    thesisToUpdate.CompanyThesisContactPersonEmail = selectedCompanyThesis.CompanyThesisContactPersonEmail;
                    thesisToUpdate.CompanyThesisContactPersonTelephone = selectedCompanyThesis.CompanyThesisContactPersonTelephone;
                    thesisToUpdate.OpenSlots_CompanyThesis = selectedCompanyThesis.OpenSlots_CompanyThesis;


                    // Update timestamp and count
                    thesisToUpdate.CompanyThesisUpdateDateTime = DateTime.Now;
                    thesisToUpdate.CompanyThesisTimesUpdated += 1;

                    // Only update attachment if a new file was uploaded
                    if (selectedCompanyThesis.CompanyThesisAttachmentUpload != null && selectedCompanyThesis.CompanyThesisAttachmentUpload.Length > 0)
                    {
                        thesisToUpdate.CompanyThesisAttachmentUpload = selectedCompanyThesis.CompanyThesisAttachmentUpload;
                    }

                    await dbContext.SaveChangesAsync();
                
                    // Refresh the theses list to show updated data
                    //await LoadCompanyTheses();
                
                    showSuccessMessage = true;
                    showErrorMessage = false;
                }
                else
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                }
            }
            catch (Exception ex)
            {
                showSuccessMessage = false;
                showErrorMessage = true;
                Console.Error.WriteLine($"Error saving company thesis: {ex.Message}");
            }
            finally
            {
                isModalVisibleToEditCompanyThesisDetails = false;
                selectedCompanyThesis = null; // Clear the editing object
                StateHasChanged();
            }
        }



        private async Task FilterThesisApplications(ChangeEventArgs e)
        {

            filterValue = e.Value?.ToString() ?? "all"; // Ensure "all" is the default

            if (filterValue == "company")
            {
                showCompanyThesisApplications = true;
                showProfessorThesisApplications = false;
            }
            else if (filterValue == "professor")
            {
                showCompanyThesisApplications = false;
                showProfessorThesisApplications = true;
            }
            else
            {
                showCompanyThesisApplications = true;
                showProfessorThesisApplications = true;
            }

            await Task.Delay(1000); // Simulate loading delay

            StateHasChanged(); // Update UI
        }

        private async Task OnFilterChange(ChangeEventArgs e)
        {
            // Update the selected filter value
            selectedThesisFilter = e.Value.ToString();
        
            // Check dropdown state
            if (dropdownState == "All")
            {
                // Show all data, no filtering by professor name
                await SearchThesisApplicationsAsStudent(); // Assuming this method fetches all data
            }
            else
            {
                // Show only filtered data (e.g., professor name or other criteria)
                await FilterThesisApplicationsToSearchAsStudent();
            }
        }


        private async Task FilterThesisApplicationsToSearchAsStudent()
        {
            var filteredTheses = sumUpThesesFromBothCompanyAndProfessor
                ?.Where(thesis =>
                    (selectedThesisFilter == "company" && thesis.CompanyThesisStatus == "Δημοσιευμένη") ||
                    (selectedThesisFilter == "professor" && thesis.ProfessorThesisStatus == "Δημοσιευμένη") ||
                    selectedThesisFilter == "all" &&
                    (thesis.CompanyThesisStatus == "Δημοσιευμένη" || thesis.ProfessorThesisStatus == "Δημοσιευμένη"))
                .ToList();

            publishedTheses = filteredTheses;

            // Optionally log the filtered count
            Console.WriteLine($"Filtered theses count: {publishedTheses.Count}");

            await Task.Delay(1000); // Optional delay to simulate async loading
            StateHasChanged(); // Trigger UI update
        }


        private int currentPageForThesisToSee = 1;
        private int pageSizeForThesisToSee = 10; // Show only 3 thesis per page
        private int totalThesisCountForThesisToSee = 4; // For example, set to 4 total thesis
        private int totalPagesForThesisToSee = 1; // Initialize to 1 to avoid divide by zero error

        // Method to set the thesis count and calculate total pages
        private void SetTotalThesisCount(int count)
        {
            totalThesisCountForThesisToSee = count;
            totalPagesForThesisToSee = (int)Math.Ceiling((double)totalThesisCountForThesisToSee / pageSizeForThesisToSee);
        }

        private bool IsPreviousDisabled => currentPageForThesisToSee == 1;
        private bool IsNextDisabled => currentPageForThesisToSee >= totalPagesForThesisToSee; // Disable if on the last page

        private void PreviousPageForThesisToSee()
        {
            if (currentPageForThesisToSee > 1)
            {
                currentPageForThesisToSee--;
            }
        }

        private void NextPageForThesisToSee()
        {
            if (currentPageForThesisToSee < totalPagesForThesisToSee)
            {
                currentPageForThesisToSee++;
            }
        }

        private void UpdatePagination()
        {
            totalPagesForThesisToSee = (int)Math.Ceiling((double)totalThesisCountForThesisToSee / pageSizeForThesisToSee);
            StateHasChanged(); // Triggers a re-render to apply changes
        }




        private string GetThesisRowColor(object thesis)
        {
            if (thesis is CompanyThesisApplied companyThesis)
            {
                return companyThesis.CompanyThesisStatusAppliedAtStudentSide switch
                {
                    "Επιτυχής" => "lightgreen",
                    "Απορρίφθηκε" => "lightcoral",
                    "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)" => "coral",
                    "Αποσύρθηκε από τον φοιτητή" => "lightyellow",
                    _ => "transparent"
                };
            }
            else if (thesis is ProfessorThesisApplied professorThesis)
            {
                return professorThesis.ProfessorThesisStatusAppliedAtStudentSide switch
                {
                    "Επιτυχής" => "lightgreen",
                    "Απορρίφθηκε" => "lightcoral",
                    "Απορρίφθηκε (Απόσυρση Θέσεως Από τον Καθηγητή)" => "coral",
                    "Αποσύρθηκε από τον φοιτητή" => "lightyellow",
                    _ => "transparent"
                };
            }
            return "transparent";
        }


        private bool showLoadingModalWhenWithdrawThesisApplication = false;
        private int loadingProgressWhenWithdrawThesisApplication = 0;
        private async Task WithdrawThesisApplication(object thesis)
        {
            try
            {
                PlatformActions platformAction = null;

                if (thesis is CompanyThesisApplied companyThesis)
                {
                    var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                        $"Πρόκεται να αποσύρετε την Αίτησή σας για την Διπλωματική Εργασία. Είστε σίγουρος/η;");
                    if (!confirmed) return;

                    // Show loading modal after user confirms
                    showLoadingModalWhenWithdrawThesisApplication = true;
                    loadingProgressWhenWithdrawThesisApplication = 0;
                    StateHasChanged();

                    // Step 1: Get thesis details
                    await UpdateProgressWhenWithdrawThesisApplication(10, 200);
                
                    var thesisDetails = await dbContext.CompanyTheses
                        .Include(t => t.Company)
                        .FirstOrDefaultAsync(t => t.RNGForThesisUploadedAsCompany == companyThesis.RNGForCompanyThesisApplied);

                    if (thesisDetails == null)
                    {
                        showLoadingModalWhenWithdrawThesisApplication = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε η Διπλωματικής Εργασία.");
                        return;
                    }

                    // Step 2: Update thesis status
                    await UpdateProgressWhenWithdrawThesisApplication(30, 200);
                
                    companyThesis.CompanyThesisStatusAppliedAtStudentSide = "Αποσύρθηκε από τον φοιτητή";
                    companyThesis.CompanyThesisStatusAppliedAtCompanySide = "Αποσύρθηκε από τον φοιτητή";

                    // Step 3: Add platform action
                    await UpdateProgressWhenWithdrawThesisApplication(50, 200);
                
                    platformAction = new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "COMPANY_THESIS",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(companyThesis.RNGForCompanyThesisApplied),
                        TypeOfAction_PerformedAction = "SELFWITHDRAW",
                        DateTime_PerformedAction = DateTime.Now
                    };

                    dbContext.PlatformActions.Add(platformAction);
                    await dbContext.SaveChangesAsync();
                
                    await UpdateProgressWhenWithdrawThesisApplication(70, 200);

                    // Step 4: Get student details
                    await UpdateProgressWhenWithdrawThesisApplication(80, 200);
                
                    var student = await GetStudentDetails(companyThesis.StudentEmailAppliedForThesis);
                    if (student == null)
                    {
                        showLoadingModalWhenWithdrawThesisApplication = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                        return;
                    }

                    var companyName = thesisDetails.Company?.CompanyName ?? "Άγνωστη Εταιρεία";

                    // Step 5: Send emails
                    await UpdateProgressWhenWithdrawThesisApplication(90, 200);
                
                    await InternshipEmailService.SendStudentThesisWithdrawalNotificationToCompanyOrProfessor(
                        companyThesis.CompanyEmailWhereStudentAppliedForThesis,
                        companyName,
                        student.Name,
                        student.Surname,
                        thesisDetails.CompanyThesisTitle,
                        companyThesis.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID);

                    await InternshipEmailService.SendStudentThesisWithdrawalConfirmationToStudent(
                        companyThesis.StudentEmailAppliedForThesis,
                        student.Name,
                        student.Surname,
                        thesisDetails.CompanyThesisTitle,
                        companyThesis.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                        companyName);

                    await UpdateProgressWhenWithdrawThesisApplication(100, 200);
                
                    // Small delay to show completion
                    await Task.Delay(500);
                
                    // Hide loading modal before navigation
                    showLoadingModalWhenWithdrawThesisApplication = false;
                    StateHasChanged();

                    // AFTER user clicks OK, show the navigation loader
                    await Task.Delay(100); // Small delay for smooth transition
            
                    // Show the navigation loader
                    await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                    // Give time for loader to render
                    await Task.Delay(300);
                
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
                else if (thesis is ProfessorThesisApplied professorThesis)
                {
                    var confirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", 
                        $"Πρόκεται να αποσύρετε την Αίτησή σας για την Διπλωματική Εργασία. Είστε σίγουρος/η;");
                    if (!confirmed) return;

                    // Show loading modal after user confirms
                    showLoadingModalWhenWithdrawThesisApplication = true;
                    loadingProgressWhenWithdrawThesisApplication = 0;
                    StateHasChanged();

                    // Step 1: Get thesis details
                    await UpdateProgressWhenWithdrawThesisApplication(10, 200);
                
                    var thesisDetails = await dbContext.ProfessorTheses
                        .Include(t => t.Professor)
                        .FirstOrDefaultAsync(t => t.RNGForThesisUploaded == professorThesis.RNGForProfessorThesisApplied);

                    if (thesisDetails == null)
                    {
                        showLoadingModalWhenWithdrawThesisApplication = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("alert", "Δεν βρέθηκε η Διπλωματική εργασία.");
                        return;
                    }

                    // Step 2: Update thesis status
                    await UpdateProgressWhenWithdrawThesisApplication(30, 200);
                
                    professorThesis.ProfessorThesisStatusAppliedAtStudentSide = "Αποσύρθηκε από τον φοιτητή";
                    professorThesis.ProfessorThesisStatusAppliedAtProfessorSide = "Αποσύρθηκε από τον φοιτητή";

                    // Step 3: Add platform action
                    await UpdateProgressWhenWithdrawThesisApplication(50, 200);
                
                    platformAction = new PlatformActions
                    {
                        UserRole_PerformedAction = "STUDENT",
                        ForWhat_PerformedAction = "PROFESSOR_THESIS",
                        HashedPositionRNG_PerformedAction = HashingHelper.HashLong(professorThesis.RNGForProfessorThesisApplied),
                        TypeOfAction_PerformedAction = "SELFWITHDRAW",
                        DateTime_PerformedAction = DateTime.Now
                    };

                    dbContext.PlatformActions.Add(platformAction);
                    await dbContext.SaveChangesAsync();
                
                    await UpdateProgressWhenWithdrawThesisApplication(70, 200);

                    // Step 4: Get student details
                    await UpdateProgressWhenWithdrawThesisApplication(80, 200);
                
                    var student = await GetStudentDetails(professorThesis.StudentEmailAppliedForProfessorThesis);
                    if (student == null)
                    {
                        showLoadingModalWhenWithdrawThesisApplication = false;
                        StateHasChanged();
                        await JS.InvokeVoidAsync("alert", "Δεν βρέθηκαν στοιχεία φοιτητή.");
                        return;
                    }

                    var professorName = thesisDetails.Professor != null 
                        ? $"{thesisDetails.Professor.ProfName} {thesisDetails.Professor.ProfSurname}" 
                        : "Άγνωστος Καθηγητής";

                    // Step 5: Send emails
                    await UpdateProgressWhenWithdrawThesisApplication(90, 200);
                
                    await InternshipEmailService.SendStudentThesisWithdrawalNotificationToCompanyOrProfessor(
                        professorThesis.ProfessorEmailWhereStudentAppliedForProfessorThesis,
                        professorName,
                        student.Name,
                        student.Surname,
                        thesisDetails.ThesisTitle,
                        professorThesis.RNGForProfessorThesisApplied_HashedAsUniqueID);

                    await InternshipEmailService.SendStudentThesisWithdrawalConfirmationToStudent(
                        professorThesis.StudentEmailAppliedForProfessorThesis,
                        student.Name,
                        student.Surname,
                        thesisDetails.ThesisTitle,
                        professorThesis.RNGForProfessorThesisApplied_HashedAsUniqueID,
                        professorName);

                    await UpdateProgressWhenWithdrawThesisApplication(100, 200);
                
                    // Small delay to show completion
                    await Task.Delay(500);
                
                    // Hide loading modal before navigation
                    showLoadingModalWhenWithdrawThesisApplication = false;
                    StateHasChanged();

                    // AFTER user clicks OK, show the navigation loader
                    await Task.Delay(100); // Small delay for smooth transition
            
                    // Show the navigation loader
                    await JS.InvokeVoidAsync("showBlazorNavigationLoader", "Παρακαλώ Περιμένετε...");
            
                    // Give time for loader to render
                    await Task.Delay(300);
                
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
            }
            catch (Exception ex)
            {
                // Hide loading modal on error
                showLoadingModalWhenWithdrawThesisApplication = false;
                StateHasChanged();
            
                Console.WriteLine($"Error saving withdrawal: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την αποθήκευση της απόσυρσης.");
            }
        }

        // Helper method to update progress and refresh UI
        private async Task UpdateProgressWhenWithdrawThesisApplication(int current, int total)
        {
            loadingProgressWhenWithdrawThesisApplication = (int)((double)current / total * 100);
            StateHasChanged();
            await Task.Delay(50); // Small delay for smooth animation
        }

        private async Task HandleFileUploadToEditCompanyAnnouncementAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;  
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);  
                            currentAnnouncement.CompanyAnnouncementAttachmentFile = memoryStream.ToArray();  
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }

        private async Task HandleFileUploadToEditProfessorAnnouncementAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;  // Access the selected file
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                // Ensure the file is a PDF (optional)
                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);  // Copy the file stream to memory stream
                            currentAnnouncementAsProfessor.ProfessorAnnouncementAttachmentFile = memoryStream.ToArray();  // Store file as byte array
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }


        private async Task HandleFileUploadToEditCompanyJobAttachment(InputFileChangeEventArgs e)
        {
            Console.WriteLine("File upload method triggered.");

            var file = e.File;
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                // Ensure the file is a PDF
                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);
                            selectedJob.PositionAttachment = memoryStream.ToArray();  // Store the file as byte array
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }

        private async Task HandleFileUploadToEditCompanyInternshipAttachment(InputFileChangeEventArgs e)
        {
            Console.WriteLine("File upload method triggered.");

            var file = e.File;
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                // Ensure the file is a PDF
                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);
                            selectedInternship.CompanyInternshipAttachment = memoryStream.ToArray();  // Store the file as byte array
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }

        private void OnCheckedChangedForEditCompanyJobAreas(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasToEditForCompanyJob.Any(a => a.AreaName == area.AreaName))  // Check by AreaName or Id
                    {
                        SelectedAreasToEditForCompanyJob.Add(area);  // Add the area object
                    }
                }
                else
                {
                    SelectedAreasToEditForCompanyJob.RemoveAll(a => a.AreaName == area.AreaName);  // Remove by AreaName or Id
                }
            }
            StateHasChanged();
        }

        private void OnCheckedChangedForEditCompanyInternshipAreas(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasToEditForCompanyInternship.Any(a => a.AreaName == area.AreaName))  // Check by AreaName or Id
                    {
                        SelectedAreasToEditForCompanyInternship.Add(area);  // Add the area object
                    }
                }
                else
                {
                    SelectedAreasToEditForCompanyInternship.RemoveAll(a => a.AreaName == area.AreaName);  // Remove by AreaName or Id
                }
            }
            StateHasChanged();
        }

        private void OnCheckedChangedForEditCompanyThesisAreas(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasToEditForCompanyThesis.Any(a => a.AreaName == area.AreaName))  // Check by AreaName or Id
                    {
                        SelectedAreasToEditForCompanyThesis.Add(area);  // Add the area object
                    }
                }
                else
                {
                    SelectedAreasToEditForCompanyThesis.RemoveAll(a => a.AreaName == area.AreaName);  // Remove by AreaName or Id
                }
            }
            StateHasChanged();
        }

        private void OnCheckedChangedForEditCompanyThesisSkills(ChangeEventArgs e, Skill skill)
        {
            if (e.Value is bool isChecked)
            {
                Console.WriteLine($"Checkbox changed - Skill: {skill.SkillName}, Checked: {isChecked}");
            
                if (isChecked)
                {
                    if (!SelectedSkillsToEditForCompanyThesis.Any(s => s.Id == skill.Id))
                    {
                        SelectedSkillsToEditForCompanyThesis.Add(skill);
                    }
                }
                else
                {
                    SelectedSkillsToEditForCompanyThesis.RemoveAll(s => s.Id == skill.Id);
                }
            
                // Update the skills string for the thesis
                selectedCompanyThesis.CompanyThesisSkillsNeeded = string.Join(", ", SelectedSkillsToEditForCompanyThesis.Select(s => s.SkillName));
                Console.WriteLine($"Updated skills: {selectedCompanyThesis.CompanyThesisSkillsNeeded}");
            
                // Force UI update
                StateHasChanged();
            }
        }

        private async Task ShowProfessorDetailsAtCompanyEventInterest(InterestInCompanyEventAsProfessor interest)
        {
            try
            {
                // Try to get professor from cache first
                if (!professorDataCache.TryGetValue(interest.ProfessorEmailShowInterestForCompanyEvent, out var professor))
                {
                    // If not in cache, fetch from database
                    professor = await dbContext.Professors
                        .FirstOrDefaultAsync(p => p.ProfEmail == interest.ProfessorEmailShowInterestForCompanyEvent);
                
                    if (professor != null)
                    {
                        professorDataCache[interest.ProfessorEmailShowInterestForCompanyEvent] = professor;
                    }
                }

                if (professor == null)
                {
                    await JS.InvokeVoidAsync("alert", "Professor details not found");
                    return;
                }

                selectedProfessorToShowDetailsForInterestinCompanyEvent = professor;
                showProfessorModal = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error showing professor details: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Σφάλμα κατά την εμφάνιση των στοιχείων του καθηγητή");
            }
            finally
            {
                StateHasChanged();
            }
        }

        


        private void CloseProfessorDetailsModal()
        {
            showProfessorModal = false;
        }

        private async Task UploadFileToUpdateCompanyEventAttachment(ChangeEventArgs e)
        {
            var file = (IBrowserFile)e.Value;
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer, 0, (int)file.Size);
            currentCompanyEvent.CompanyEventAttachmentFile = buffer;
        }

        

        private void OnCheckedChangedForEditCompanyEventAreas(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasToEditForCompanyEvent.Any(a => a.AreaName == area.AreaName))  // Check by AreaName or Id
                    {
                        SelectedAreasToEditForCompanyEvent.Add(area);  // Add the area object
                    }
                }
                else
                {
                    SelectedAreasToEditForCompanyEvent.RemoveAll(a => a.AreaName == area.AreaName);  // Remove by AreaName or Id
                }
            }
            StateHasChanged();
        }


        private void UpdateSelectedAreasForCompanyEvent()
        {
            currentCompanyEvent.CompanyEventAreasOfInterest = string.Join(", ", SelectedAreasToEditForCompanyEvent.Select(a => a.AreaName));
        }

        private void OnRegionChangedForEditCompanyEvent(string selectedRegion)
        {
            AvailableTownsForEditCompanyEvent = GetTownsForRegionForEditCompanyEvent(selectedRegion);
            currentCompanyEvent.CompanyEventDimosLocation = ""; // Reset town when region changes
        }




        private List<string> AvailableTownsForEditCompanyEvent = new List<string>();

        private List<string> GetTownsForRegionForEditCompanyEvent(string region)
        {
            if (string.IsNullOrEmpty(region) || !RegionToTownsMap.ContainsKey(region))
            {
                return new List<string>();
            }

            return RegionToTownsMap[region];
        }

        private string _selectedRegion;

        private string SelectedRegion
        {
            get => _selectedRegion;
            set
            {
                _selectedRegion = value;
                OnRegionChangedForEditCompanyEvent(value);
            }
        }


        private void ClearField(int fieldIndex)
        {
            switch (fieldIndex)
            {
                case 1:
                    currentCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1 = string.Empty;
                    break;
                case 2:
                    currentCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2 = string.Empty;
                    break;
                case 3:
                    currentCompanyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3 = string.Empty;
                    break;
            }
        }

        private async Task DownloadStudentListForInterestInCompanyEventAsCompany()
        {
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

            using var package = new ExcelPackage();
            var worksheet = package.Workbook.Worksheets.Add("Interested Students");

            worksheet.Cells["A1"].Value = "Πανεπιστήμιο";
            worksheet.Cells["B1"].Value = "Τμήμα Φοίτησης";
            worksheet.Cells["C1"].Value = "Επίπεδο Σπουδών";
            worksheet.Cells["D1"].Value = "Όνομα Φοιτητή";
            worksheet.Cells["E1"].Value = "Επώνυμο Φοιτητή";
            worksheet.Cells["F1"].Value = "Email";
            worksheet.Cells["G1"].Value = "Τηλέφωνο";
            worksheet.Cells["H1"].Value = "Χρειάζεται Μεταφορά";
            worksheet.Cells["I1"].Value = "Επιλεγμένα Σημεία Εκκίνησης";

            using (var headerRange = worksheet.Cells["A1:I1"])
            {
                headerRange.Style.Font.Bold = true;
                headerRange.Style.Fill.PatternType = ExcelFillStyle.Solid;
                headerRange.Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                headerRange.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            int row = 2;

            foreach (var application in InterestedStudents)
            {
                var studentUniqueId = application.StudentUniqueIDShowInterestForEvent;
                var student = studentDataCache.Values.FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

                if (student == null)
                {
                    student = await dbContext.Students
                        .Where(s => s.Student_UniqueID == studentUniqueId)
                        .Select(s => new Student
                        {
                            Name = s.Name,
                            Surname = s.Surname,
                            Email = s.Email,
                            Telephone = s.Telephone,
                            University = s.University,
                            Department = s.Department,
                            LevelOfDegree = s.LevelOfDegree
                        })
                        .FirstOrDefaultAsync();

                    if (student != null)
                    {
                        studentDataCache[student.Email.ToLower()] = student;
                    }
                }

                if (student != null)
                {
                    worksheet.Cells[$"A{row}"].Value = student.University;
                    worksheet.Cells[$"B{row}"].Value = student.Department;
                    worksheet.Cells[$"C{row}"].Value = student.LevelOfDegree;
                    worksheet.Cells[$"D{row}"].Value = student.Name;
                    worksheet.Cells[$"E{row}"].Value = student.Surname;
                    worksheet.Cells[$"F{row}"].Value = student.Email;
                    worksheet.Cells[$"G{row}"].Value = student.Telephone;
                    worksheet.Cells[$"H{row}"].Value = string.IsNullOrWhiteSpace(application.StudentTransportNeedWhenShowInterestForCompanyEvent)
                                                    ? "Όχι"
                                                    : application.StudentTransportNeedWhenShowInterestForCompanyEvent;
                    worksheet.Cells[$"I{row}"].Value = string.IsNullOrWhiteSpace(application.StudentTransportChosenLocationWhenShowInterestForCompanyEvent)
                                                    ? "N/A"
                                                    : application.StudentTransportChosenLocationWhenShowInterestForCompanyEvent;

                    row++;
                }
            }

            worksheet.Cells.AutoFitColumns();

            var fileBytes = package.GetAsByteArray();
            string fileName = "Ενδιαφερόμενοι_Φοιτητές_Εκδήλωσης.xlsx";
            await JS.InvokeVoidAsync("saveStudentShownInterestForCompanyEventAsExcelListFile", fileName, Convert.ToBase64String(fileBytes));
        }


        private async Task DownloadStudentListForInterestInProfessorEventAsProfessor()
        {
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

            using var package = new ExcelPackage();
            var worksheet = package.Workbook.Worksheets.Add("Interested Students");

            // Set column headers
            worksheet.Cells["A1"].Value = "Πανεπιστήμιο";
            worksheet.Cells["B1"].Value = "Τμήμα Φοίτησης";
            worksheet.Cells["C1"].Value = "Επίπεδο Σπουδών";
            worksheet.Cells["D1"].Value = "Όνομα Φοιτητή";
            worksheet.Cells["E1"].Value = "Επώνυμο Φοιτητή";
            worksheet.Cells["F1"].Value = "Email";
            worksheet.Cells["G1"].Value = "Τηλέφωνο";
            worksheet.Cells["H1"].Value = "Χρειάζεται Μεταφορά";
            worksheet.Cells["I1"].Value = "Επιλεγμένα Σημεία Εκκίνησης";

            // Format headers
            using (var headerRange = worksheet.Cells["A1:I1"])
            {
                headerRange.Style.Font.Bold = true;
                headerRange.Style.Fill.PatternType = ExcelFillStyle.Solid;
                headerRange.Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                headerRange.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            int row = 2;

            foreach (var application in InterestedStudentsForProfessorEvent)
            {
                var studentUniqueId = application.StudentUniqueIDShowInterestForEvent;
                var student = studentDataCache.Values.FirstOrDefault(s => s.Student_UniqueID == studentUniqueId);

                if (student == null)
                {
                    student = await dbContext.Students
                        .Where(s => s.Student_UniqueID == studentUniqueId)
                        .Select(s => new Student
                        {
                            Name = s.Name,
                            Surname = s.Surname,
                            Email = s.Email,
                            Telephone = s.Telephone,
                            University = s.University,
                            Department = s.Department,
                            LevelOfDegree = s.LevelOfDegree
                        })
                        .FirstOrDefaultAsync();

                    if (student != null)
                    {
                        studentDataCache[student.Email.ToLower()] = student;
                    }
                }

                if (student != null)
                {
                    worksheet.Cells[$"A{row}"].Value = student.University;
                    worksheet.Cells[$"B{row}"].Value = student.Department;
                    worksheet.Cells[$"C{row}"].Value = student.LevelOfDegree;
                    worksheet.Cells[$"D{row}"].Value = student.Name;
                    worksheet.Cells[$"E{row}"].Value = student.Surname;
                    worksheet.Cells[$"F{row}"].Value = student.Email;
                    worksheet.Cells[$"G{row}"].Value = student.Telephone;
                    worksheet.Cells[$"H{row}"].Value = string.IsNullOrWhiteSpace(application.StudentTransportNeedWhenShowInterestForProfessorEvent)
                                                    ? "Όχι"
                                                    : application.StudentTransportNeedWhenShowInterestForProfessorEvent;
                    worksheet.Cells[$"I{row}"].Value = string.IsNullOrWhiteSpace(application.StudentTransportChosenLocationWhenShowInterestForProfessorEvent)
                                                    ? "N/A"
                                                    : application.StudentTransportChosenLocationWhenShowInterestForProfessorEvent;

                    row++;
                }
            }

            worksheet.Cells.AutoFitColumns();

            var fileBytes = package.GetAsByteArray();
            string fileName = "Ενδιαφερόμενοι_Φοιτητές_Εκδήλωσης.xlsx";
            await JS.InvokeVoidAsync("saveStudentShownInterestForProfessorEventAsExcelListFile", fileName, Convert.ToBase64String(fileBytes));
        }

        private async Task DownloadProfessorListForInterestInCompanyEventAsCompany()
        {
            // 🔹 Set the License Context BEFORE using ExcelPackage
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;  

            using var package = new ExcelPackage();
            var worksheet = package.Workbook.Worksheets.Add("Interested Professors");

            // 🔹 Set Column Headers
            worksheet.Cells["A1"].Value = "Όνομα";
            worksheet.Cells["B1"].Value = "Επώνυμο";
            worksheet.Cells["C1"].Value = "Πανεπιστήμιο";
            worksheet.Cells["D1"].Value = "Τμήμα";
            worksheet.Cells["E1"].Value = "Βαθμίδα ΔΕΠ";
            worksheet.Cells["F1"].Value = "Email";
            worksheet.Cells["G1"].Value = "Τηλέφωνο Εργασίας";
            worksheet.Cells["H1"].Value = "Τηλέφωνο Προσωπικό";
            worksheet.Cells["I1"].Value = "Ημερομηνία Δήλωσης";
            worksheet.Cells["J1"].Value = "Κατάσταση";

            // 🔹 Apply Bold Style to Column Titles
            using (var headerRange = worksheet.Cells["A1:J1"])
            {
                headerRange.Style.Font.Bold = true; 
                headerRange.Style.Fill.PatternType = ExcelFillStyle.Solid;
                headerRange.Style.Fill.BackgroundColor.SetColor(Color.LightGray); 
                headerRange.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center; 
            }

            int row = 2; // Start inserting data from row 2

            foreach (var interest in filteredProfessorInterestForCompanyEvents)
            {
                // Get professor details from the database
                var professor = await GetProfessorDetails(interest.ProfessorEmailShowInterestForCompanyEvent);
        
                worksheet.Cells[$"A{row}"].Value = professor?.ProfName ?? "N/A";
                worksheet.Cells[$"B{row}"].Value = professor?.ProfSurname ?? "N/A";
                worksheet.Cells[$"C{row}"].Value = professor?.ProfUniversity ?? "N/A";
                worksheet.Cells[$"D{row}"].Value = professor?.ProfDepartment ?? "N/A";
                worksheet.Cells[$"E{row}"].Value = professor?.ProfVahmidaDEP ?? "N/A";
                worksheet.Cells[$"F{row}"].Value = interest.ProfessorEmailShowInterestForCompanyEvent;
                worksheet.Cells[$"G{row}"].Value = professor?.ProfWorkTelephone ?? "N/A";
                worksheet.Cells[$"H{row}"].Value = professor?.ProfPersonalTelephoneVisibility == true ? professor?.ProfPersonalTelephone ?? "N/A" : "Μη Δημόσιο";
                worksheet.Cells[$"I{row}"].Value = interest.DateTimeProfessorShowInterestForCompanyEvent.ToString("g");
                worksheet.Cells[$"J{row}"].Value = interest.CompanyEventStatus_ShowInterestAsProfessor_AtCompanySide;
                row++;
            }

            // 🔹 AutoFit Columns for better readability
            worksheet.Cells.AutoFitColumns();

            // 🔹 Format date column
            worksheet.Column(9).Style.Numberformat.Format = "dd/MM/yyyy HH:mm";

            var fileBytes = package.GetAsByteArray();

            // 🔹 Call JavaScript to trigger download
            string fileName = $"Ενδιαφερόμενοι_Καθηγητές_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            await JS.InvokeVoidAsync("saveProfessorShownInterestForCompanyEventAsExcelListFile", fileName, Convert.ToBase64String(fileBytes));
        }

        private async Task DownloadCompanyListForInterestInProfessorEventAsProfessor()
        {
            // 🔹 Set the License Context BEFORE using ExcelPackage
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;  

            using var package = new ExcelPackage();
            var worksheet = package.Workbook.Worksheets.Add("Interested Companies");

            // 🔹 Set Column Headers
            worksheet.Cells["A1"].Value = "Επωνυμία";
            worksheet.Cells["B1"].Value = "Τοποθεσία (Πόλη)";
            worksheet.Cells["C1"].Value = "Διεύθυνση";
            worksheet.Cells["D1"].Value = "Email Επικοινωνίας";
            worksheet.Cells["E1"].Value = "Τηλέφωνο Επικοινωνίας";
            worksheet.Cells["F1"].Value = "Τομείς Ενδιαφέροντος";
            worksheet.Cells["G1"].Value = "Αριθμός Συμμετεχόντων";
            worksheet.Cells["H1"].Value = "Ημερομηνία Δήλωσης";
            worksheet.Cells["I1"].Value = "Κατάσταση";

            // 🔹 Apply Bold Style to Column Titles
            using (var headerRange = worksheet.Cells["A1:I1"])
            {
                headerRange.Style.Font.Bold = true; 
                headerRange.Style.Fill.PatternType = ExcelFillStyle.Solid;
                headerRange.Style.Fill.BackgroundColor.SetColor(Color.LightGray); 
                headerRange.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center; 
            }

            int row = 2; // Start inserting data from row 2

            foreach (var interest in filteredCompanyInterestForProfessorEvents)
            {
                // Get company details from the navigation property
                var company = await GetCompanyDetails(interest.CompanyEmailShowInterestForProfessorEvent);
            
                worksheet.Cells[$"A{row}"].Value = company?.CompanyName ?? "N/A";
                worksheet.Cells[$"B{row}"].Value = company?.CompanyTown ?? "N/A";
                worksheet.Cells[$"C{row}"].Value = company?.CompanyLocation ?? "N/A";
                worksheet.Cells[$"D{row}"].Value = interest.CompanyEmailShowInterestForProfessorEvent;
                worksheet.Cells[$"E{row}"].Value = company?.CompanyTelephone ?? "N/A";
                worksheet.Cells[$"F{row}"].Value = company?.CompanyAreas ?? "N/A";
                worksheet.Cells[$"G{row}"].Value = interest.CompanyNumberOfPeopleToShowUpWhenShowInterestForProfessorEvent;
                worksheet.Cells[$"H{row}"].Value = interest.DateTimeCompanyShowInterestForProfessorEvent.ToString("g");
                worksheet.Cells[$"I{row}"].Value = interest.ProfessorEventStatus_ShowInterestAsCompany_AtProfessorSide;
            
                row++;
            }

            // 🔹 AutoFit Columns for better readability
            worksheet.Cells.AutoFitColumns();

            // 🔹 Format date column
            worksheet.Column(8).Style.Numberformat.Format = "dd/MM/yyyy HH:mm";

            var fileBytes = package.GetAsByteArray();

            // 🔹 Call JavaScript to trigger download
            string fileName = $"Ενδιαφερόμενες_Εταιρείες_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            await JS.InvokeVoidAsync("saveCompanyShownInterestForProfessorEventAsExcelListFile", fileName, Convert.ToBase64String(fileBytes));
        }

        private void HandleNumberChangeForParticipantsWhenShowInterestAsACompanyForAProfessorEvent(ChangeEventArgs e, long professorEventId)
        {
            if (int.TryParse(e.Value?.ToString(), out int number))
            {
                SetNumberOfPeople(professorEventId, number);
            }
            else
            {
                Console.WriteLine("Invalid number entered");
            }
        }

        private void ToggleThesisApplicationsVisibility()
        {
            isThesisApplicationsVisible = !isThesisApplicationsVisible;
            StateHasChanged();
        }

        private void ToggleAnnouncementsAsStudentVisibility()
        {
            isAnnouncementsAsStudentVisible = !isAnnouncementsAsStudentVisible;
            StateHasChanged();
        }

        private void ToggleAnnouncementsAsRGVisibility()
        {
            isAnnouncementsAsRGVisible = !isAnnouncementsAsRGVisible;
            StateHasChanged();
        }

        private void ToggleAnnouncementsAsProfessorVisibility()
        {
            isAnnouncementsAsProfessorVisible = !isAnnouncementsAsProfessorVisible;
            StateHasChanged();
        }

        private void ToggleSearchInternshipsAsStudentFiltersVisibility()
        {
            isSearchInternshipsAsStudentFiltersVisible = !isSearchInternshipsAsStudentFiltersVisible;
            StateHasChanged();
        }

        private void ToggleJobApplicationsAsStudentVisibility()
        {
            isJobApplicationsAsStudentVisible = !isJobApplicationsAsStudentVisible;
            StateHasChanged();
        }

        private void ToggleJobPositionAsStudentFiltersVisibility()
        {
            isJobPositionAsStudentFiltersVisible = !isJobPositionAsStudentFiltersVisible;
            StateHasChanged();
        }

        private void ToggleInternshipApplicationsAsStudentVisibility()
        {
            isInternshipApplicationsAsStudentVisible = !isInternshipApplicationsAsStudentVisible;
            StateHasChanged();
        }

        private void ToggleInternshipSearchAsStudentFiltersVisibility()
        {
            isInternshipSearchAsStudentFiltersVisible = !isInternshipSearchAsStudentFiltersVisible;
            StateHasChanged();
        }

        private void ToggleEventSearchAsStudentVisibility()
        {
            isEventSearchAsStudentVisible = !isEventSearchAsStudentVisible;
            StateHasChanged();
        }

        @inject AppDbContext DbContext  // Replace with your actual DbContext type
        private async Task HandleThesisTitleInputForBothCompaniesAndProfessorsWhenSearchForThesisAsStudent(ChangeEventArgs e)
        {
            thesisSearchForThesesAsStudent = e.Value?.ToString();

            if (!string.IsNullOrWhiteSpace(thesisSearchForThesesAsStudent) && 
                thesisSearchForThesesAsStudent.Length >= 2)
            {
                try 
                {
                    // Clear ChangeTracker to prevent conflicts
                    DbContext.ChangeTracker.Clear();

                    var professorTitles = await DbContext.ProfessorTheses
                        .AsNoTracking()
                        .Where(t => EF.Functions.Like(t.ThesisTitle, $"%{thesisSearchForThesesAsStudent}%"))
                        .Select(t => t.ThesisTitle)
                        .Distinct()
                        .Take(5)
                        .ToListAsync();

                    var companyTitles = await DbContext.CompanyTheses
                        .AsNoTracking()
                        .Where(t => EF.Functions.Like(t.CompanyThesisTitle, $"%{thesisSearchForThesesAsStudent}%"))
                        .Select(t => t.CompanyThesisTitle)
                        .Distinct()
                        .Take(5)
                        .ToListAsync();

                    // Combine and order the results
                    thesisTitleSuggestions = professorTitles
                        .Concat(companyTitles)
                        .Distinct()
                        .OrderBy(t => t)
                        .Take(10) 
                        .ToList();
                }
                catch (Exception ex)
                {
                    // Log error if needed
                    Console.WriteLine($"Error fetching suggestions: {ex.Message}");
                    thesisTitleSuggestions.Clear();
                }
            }
            else
            {
                thesisTitleSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectThesisTitleSuggestionForBothCompaniesAndProfessorsWhenSearchForThesisAsStudent(string suggestion)
        {
            thesisSearchForThesesAsStudent = suggestion;
            thesisTitleSuggestions.Clear();
            StateHasChanged();
        }

        private async Task HandleCompanyNameInputWhenSearchForProfessorThesisAutocompleteNameAsStudent(ChangeEventArgs e)
        {
            companyNameSearchForThesesAsStudent = e.Value?.ToString();

            if (!string.IsNullOrWhiteSpace(companyNameSearchForThesesAsStudent) && 
                companyNameSearchForThesesAsStudent.Length >= 2)
            {
                companyNameSuggestionsWhenSearchForProfessorThesisAutocompleteNameAsStudent = await dbContext.CompanyTheses
                    .Include(t => t.Company) // Include Company for navigation property access
                    .Where(t => t.Company != null && 
                            EF.Functions.Like(t.Company.CompanyName, $"%{companyNameSearchForThesesAsStudent}%"))
                    .Select(t => t.Company.CompanyName) // Get name from navigation property
                    .Distinct()
                    .Take(10)
                    .ToListAsync();
            }
            else
            {
                companyNameSuggestionsWhenSearchForProfessorThesisAutocompleteNameAsStudent.Clear();
            }

            StateHasChanged();
        }



        private async Task SelectCompanyNameSuggestionWhenSearchForProfessorThesisAutocompleteNameAsStudent(string suggestion)
        {
            companyNameSearchForThesesAsStudent = suggestion;
            companyNameSuggestionsWhenSearchForProfessorThesisAutocompleteNameAsStudent.Clear();
            StateHasChanged();
        }

        @inject IDbContextFactory<AppDbContext> DbFactory
        private async Task HandleJobTitleAutocompleteInputWhenSearchCompanyJobsAsStudent(ChangeEventArgs e)
        {
            jobSearch = e.Value?.ToString();

            if (!string.IsNullOrWhiteSpace(jobSearch) && jobSearch.Length >= 2)
            {
                await using var context = await DbFactory.CreateDbContextAsync();

                jobTitleAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent = await context.CompanyJobs
                    .Where(j => EF.Functions.Like(j.PositionTitle, $"%{jobSearch}%"))
                    .Select(j => j.PositionTitle)
                    .Distinct()
                    .OrderBy(t => t)
                    .Take(10)
                    .ToListAsync();
            }
            else
            {
                jobTitleAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
            }

            StateHasChanged();
        }


        private async Task SelectJobTitleAutocompleteSuggestionWhenSearchCompanyJobsAsStudent(string suggestion)
        {
            jobSearch = suggestion;
            jobTitleAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
            StateHasChanged();
        }

        private async Task HandleCompanyNameAutocompleteInputWhenSearchCompanyJobsAsStudent(ChangeEventArgs e)
        {
            companyNameSearch = e.Value?.ToString();

            if (!string.IsNullOrWhiteSpace(companyNameSearch) && companyNameSearch.Length >= 2)
            {
                companyNameAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent = await dbContext.CompanyJobs
                    .Include(j => j.Company) // Include the Company navigation property
                    .Where(j => j.Company != null && 
                        EF.Functions.Like(j.Company.CompanyName, $"%{companyNameSearch}%"))
                    .Select(j => j.Company.CompanyName)
                    .Distinct()
                    .OrderBy(c => c)
                    .Take(10)
                    .ToListAsync();
            }
            else
            {
                companyNameAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
            }

            StateHasChanged();
        }

        private async Task SelectCompanyNameAutocompleteSuggestionWhenSearchCompanyJobsAsStudent(string suggestion)
        {
            companyNameSearch = suggestion;
            companyNameAutocompleteSuggestionsWhenSearchForCompanyJobsAsStudent.Clear();
            StateHasChanged();
        }

        private async Task HandleInternshipTitleAutocompleteInputWhenSearchInternshipAsStudent(ChangeEventArgs e)
        {
            companyinternshipSearch = e.Value?.ToString();

            if (!string.IsNullOrWhiteSpace(companyinternshipSearch) && 
                companyinternshipSearch.Length >= 2)
            {
                try 
                {
                    // Clear ChangeTracker to prevent conflicts
                    DbContext.ChangeTracker.Clear();

                    var searchTerm = $"%{companyinternshipSearch}%";
            
                    var companyTitles = await DbContext.CompanyInternships
                        .AsNoTracking()
                        .Where(i => EF.Functions.Like(i.CompanyInternshipTitle, searchTerm))
                        .Select(i => i.CompanyInternshipTitle)
                        .Distinct()
                        .Take(5)
                        .ToListAsync();

                    var professorTitles = await DbContext.ProfessorInternships
                        .AsNoTracking()
                        .Where(i => EF.Functions.Like(i.ProfessorInternshipTitle, searchTerm))
                        .Select(i => i.ProfessorInternshipTitle)
                        .Distinct()
                        .Take(5)
                        .ToListAsync();

                    // Combine and order the results
                    internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent = companyTitles
                        .Concat(professorTitles)
                        .Distinct()
                        .OrderBy(t => t)
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    // Log error if needed
                    Console.WriteLine($"Error fetching internship suggestions: {ex.Message}");
                    internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent.Clear();
                }
            }
            else
            {
                internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent.Clear();
            }

            StateHasChanged();
        }

        private void SelectInternshipTitleAutocompleteSuggestionWhenSearchInternshipAsStudent(string suggestion)
        {
            companyinternshipSearch = suggestion;
            internshipTitleAutocompleteSuggestionsWhenSearchInternshipAsStudent.Clear();
            StateHasChanged();
        }


        public class NewsArticle
        {
            public string Title { get; set; }
            public string Url { get; set; }
            public string Date { get; set; }
            public string Category { get; set; }
        }

        public class WeatherData
        {
            public int is_day { get; set; }
            public double temp_c { get; set; }
        }

        public class ConditionInfo
        {
            public string Text { get; set; }
        }
        public class WeatherResponse
        {
            public WeatherData current { get; set; }
        }

        private void ToggleDescriptionForCompanyEvent(int companyeventId)
        {
            if (expandedCompanyEventId == companyeventId)
            {
                expandedCompanyEventId = -1;
                Console.WriteLine($"Collapsed event {companyeventId}");
            }
            else
            {
                expandedCompanyEventId = companyeventId;
                Console.WriteLine($"Expanded event {companyeventId}");
            }
        }

        private void ToggleDescriptionForProfessorEvent(int professoreventId)
        {
            if (expandedProfessorEventId == professoreventId)
            {
                expandedProfessorEventId = -1;
                Console.WriteLine($"Collapsed event {professoreventId}");
            }
            else
            {
                expandedProfessorEventId = professoreventId;
                Console.WriteLine($"Expanded event {professoreventId}");
            }
        }


    
        private async Task<List<AnnouncementAsCompany>> FetchAnnouncementsAsync()
        {
            var announcements = await dbContext.AnnouncementsAsCompany
                .AsNoTracking()
                .Include(a => a.Company)  // This ensures Company data is loaded
                .ToListAsync();
            return announcements;
        }


        private async Task<List<NewsArticle>> FetchNewsArticlesAsync()
        {
            try
            {
                var response = await HttpClient.GetAsync("https://www.uoa.gr/anakoinoseis_kai_ekdiloseis");
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();

                var htmlDocument = new HtmlAgilityPack.HtmlDocument();
                htmlDocument.LoadHtml(content);

                var articles = new List<NewsArticle>();

                var articleNodes = htmlDocument.DocumentNode.SelectNodes("//div[contains(@class, 'topnews')]");
                if (articleNodes != null)
                {
                    // Limit the number of articles to 3
                    for (int i = 0; i < Math.Min(articleNodes.Count, 3); i++)
                    {
                        var articleNode = articleNodes[i];

                        var titleNode = articleNode.SelectSingleNode(".//h3[@class='article__title']/a");
                        var title = titleNode?.InnerText.Trim();
                        var relativeUrl = titleNode?.Attributes["href"]?.Value;
                        var url = new Uri(new Uri("https://www.uoa.gr"), relativeUrl).ToString(); 

                        var dateNode = articleNode.SelectSingleNode(".//span[@class='article__date']/time");
                        var date = dateNode?.Attributes["datetime"]?.Value;

                        var categoryNode = articleNode.SelectSingleNode(".//span[@class='article__category']/a");
                        var category = categoryNode?.InnerText.Trim();

                        articles.Add(new NewsArticle
                            {
                                Title = title,
                                Url = url,
                                Date = date,
                                Category = category
                            });
                    }
                }

                return articles;
            }
            catch (Exception ex)
            {
                fetchError = ex.Message;
                return null;
            }


        }

        private async Task<List<NewsArticle>> FetchSVSENewsArticlesAsync()
        {
            try
            {
                var response = await HttpClient.GetAsync("https://svse.gr/index.php/nea-anakoinoseis");
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();

                var htmlDocument = new HtmlAgilityPack.HtmlDocument();
                htmlDocument.LoadHtml(content);

                var articles = new List<NewsArticle>();

                var articleNodes = htmlDocument.DocumentNode.SelectNodes("/html/body/div[1]/div/section[2]/div/div/div/main/div/div[3]/div[1]/div/div");

                if (articleNodes != null)
                {
                    foreach (var articleNode in articleNodes.Take(3)) // Take only the first 3 articles
                    {
                        var titleNode = articleNode.SelectSingleNode(".//h2/a");
                        var title = titleNode?.InnerText.Trim();
                        var relativeUrl = titleNode?.Attributes["href"]?.Value;
                        var url = new Uri(new Uri("https://svse.gr"), relativeUrl).ToString(); 

                        var dateNode = articleNode.SelectSingleNode(".//time");
                        var date = dateNode?.InnerText.Trim();

                        articles.Add(new NewsArticle
                            {
                                Title = title,
                                Url = url,
                                Date = date,
                                Category = "SVSE News" 
                            });
                    }
                }
                else
                {
                    fetchError = "No articles found with the specified XPath.";
                }

                return articles;
            }
            catch (Exception ex)
            {
                fetchError = ex.Message;
                return null;
            }
        }

        private void ToggleDescription(int announcementId)
        {
            if (expandedAnnouncementId == announcementId)
            {
                expandedAnnouncementId = -1;
            }
            else
            {
                expandedAnnouncementId = announcementId;
            }
        }

        private void ToggleContainer()
        {
            isHidden = !isHidden;
        }

        private async Task DownloadAnnouncementAttachmentFrontPage(byte[] attachmentData, string fileName)
        {
            if (attachmentData != null && attachmentData.Length > 0)
            {
                var mimeType = "application/pdf"; // Correct MIME type for PDF
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, attachmentData);
            }
        }


        private void ChangePage(int pageNumber)
        {
            if (pageNumber >= 1 && pageNumber <= totalPagesForCompanyAnnouncements)
            {
                currentPageForCompanyAnnouncements = pageNumber;
            }
            StateHasChanged();
        }

        private void ToggleDescriptionForProfessorAnnouncements(int announcementId)
        {
            if (expandedProfessorAnnouncementId == announcementId)
            {
                // Collapse if the same announcement is clicked again
                expandedProfessorAnnouncementId = -1;
            }
            else
            {
                // Expand the selected announcement
                expandedProfessorAnnouncementId = announcementId;
            }
        }

        private async Task DownloadProfessorAnnouncementAttachmentFrontPage(byte[] attachmentData, string fileName)
        {
            if (attachmentData != null && attachmentData.Length > 0)
            {
                var mimeType = "application/pdf"; // Correct MIME type for PDF

                // Ensure the file name ends with .pdf
                if (!fileName.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
                {
                    fileName += ".pdf";
                }

                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, attachmentData);
            }
        }



        private void ChangePageForProfessorAnnouncements(int pageNumberForProfessorAnnouncements)
        {
            if (pageNumberForProfessorAnnouncements >= 1 && pageNumberForProfessorAnnouncements <= totalPagesForProfessorAnnouncements)
            {
                currentPageForProfessorAnnouncements = pageNumberForProfessorAnnouncements;
            }
            StateHasChanged();
        }

        private async Task<List<AnnouncementAsProfessor>> FetchProfessorAnnouncementsAsync()
        {
            var professorannouncements = await dbContext.AnnouncementsAsProfessor
                .Include(a => a.Professor)  // Eager load professor data
                .AsNoTracking()
                .OrderByDescending(a => a.ProfessorAnnouncementUploadDate) // Optional: order by date
                .ToListAsync(); 
            return professorannouncements;
        }

        private async Task<List<AnnouncementAsCompany>> FetchCompanyAnnouncementsAsync()
        {
            var companyannouncements = await dbContext.AnnouncementsAsCompany
                .Include(a => a.Company)  // Eager load company data
                .AsNoTracking()
                .OrderByDescending(a => a.CompanyAnnouncementUploadDate) // Optional: order by date
                .ToListAsync();
            return companyannouncements;
        }

        private async Task<List<AnnouncementAsResearchGroup>> FetchResearchGroupAnnouncementsAsync()
        {
            var researchgroupannouncements = await dbContext.AnnouncementAsResearchGroup
                .Include(a => a.ResearchGroup)  // Eager load rg data
                .AsNoTracking()
                .OrderByDescending(a => a.ResearchGroupAnnouncementUploadDate) // Optional: order by date
                .ToListAsync();
            return researchgroupannouncements;
        }


        private async Task DownloadCompanyEventAttachmentFrontPage(byte[] attachmentData, string fileName)
        {
            if (attachmentData != null && attachmentData.Length > 0)
            {
                var base64 = Convert.ToBase64String(attachmentData);
                var fileUrl = $"data:application/pdf;base64,{base64}";

                await JS.InvokeVoidAsync("triggerDownload", fileUrl, fileName);
            }
        }

        private async Task DownloadProfessorEventAttachmentFrontPage(byte[] attachmentData, string fileName)
        {
            if (attachmentData != null && attachmentData.Length > 0)
            {
                var base64 = Convert.ToBase64String(attachmentData);
                var fileUrl = $"data:application/pdf;base64,{base64}";

                await JS.InvokeVoidAsync("triggerDownload", fileUrl, fileName);
            }
        }

        private void ChangePageForCompanyEvents(int pageNumberForCompanyEvents)
        {
            if (pageNumberForCompanyEvents >= 1 && pageNumberForCompanyEvents <= totalPagesForCompanyEvents)
            {
                currentCompanyEventPage = pageNumberForCompanyEvents;
            }
            StateHasChanged();
        }

        private void ChangePageForProfessorEvents(int pageNumberForProfessorEvents)
        {
            if (pageNumberForProfessorEvents >= 1 && pageNumberForProfessorEvents <= totalPagesForProfessorEvents)
            {
                currentProfessorEventPage = pageNumberForProfessorEvents;
            }
            StateHasChanged();
        }

        private bool isUniversityNewsVisible = false; // Default to visible
        private void ToggleUniversityNewsVisibility()
        {
            isUniversityNewsVisible = !isUniversityNewsVisible;
            StateHasChanged();
        }

        private bool isSvseNewsVisible = false;
        private void ToggleSvseNewsVisibility()
        {
            isSvseNewsVisible = !isSvseNewsVisible;
            StateHasChanged();
        }

        private bool isCompanyAnnouncementsVisible = false;
        private void ToggleCompanyAnnouncementsVisibility()
        {
            isCompanyAnnouncementsVisible = !isCompanyAnnouncementsVisible;
            StateHasChanged();
        }

        private bool isProfessorAnnouncementsVisible = false;
        private void ToggleProfessorAnnouncementsVisibility()
        {
            isProfessorAnnouncementsVisible = !isProfessorAnnouncementsVisible;
            StateHasChanged();
        }

        private bool isCompanyEventsVisible = false; 
        private void ToggleCompanyEventsVisibility()
        {
            isCompanyEventsVisible = !isCompanyEventsVisible;
            StateHasChanged();
        }

        private bool isProfessorEventsVisible = false;
        private void ToggleProfessorEventsVisibility()
        {
            isProfessorEventsVisible = !isProfessorEventsVisible;
            StateHasChanged();
        }

        private async Task ScrollToElementById(string elementId)
        {
            await JS.InvokeVoidAsync("scrollToElementById", elementId);
        }

        private bool IsTimeInRestrictedRangeWhenUploadEventAsCompany(TimeOnly time)
        {
            // Check if time is before 06:00 or after 22:00
            return time < new TimeOnly(6, 0) || time > new TimeOnly(22, 0);
        }

        private bool IsTimeInRestrictedRangeWhenUploadEventAsProfessor(TimeOnly time)
        {
            // Check if time is before 06:00 or after 22:00
            return time < new TimeOnly(6, 0) || time > new TimeOnly(22, 0);
        }

        private bool HasAtLeastOneStartingPointWhenUploadEventAsCompany()
        {
            return !string.IsNullOrWhiteSpace(companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1) ||
                !string.IsNullOrWhiteSpace(companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2) ||
                !string.IsNullOrWhiteSpace(companyEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3);
        }


        private async Task HandleAreasInputToFindThesesAsCompany(ChangeEventArgs e)
        {
            searchAreasInputToFindThesesAsCompany = e.Value?.ToString().Trim() ?? string.Empty;
            areaSuggestionsToFindThesesAsCompany = new List<string>();

            if (searchAreasInputToFindThesesAsCompany.Length >= 1)
            {
                try
                {
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchAreasInputToFindThesesAsCompany) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchAreasInputToFindThesesAsCompany)))
                        .ToListAsync();

                    var suggestionsSet = new HashSet<string>();
            
                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchAreasInputToFindThesesAsCompany, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchAreasInputToFindThesesAsCompany, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Always use " - " as separator to avoid confusion with slashes in area names
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areaSuggestionsToFindThesesAsCompany = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση περιοχών: {ex.Message}");
                    areaSuggestionsToFindThesesAsCompany = new List<string>();
                }
            }
            else
            {
                areaSuggestionsToFindThesesAsCompany.Clear();
            }

            StateHasChanged();
        }

        private void SelectAreaSuggestionToFindThesesAsCompany(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedAreasToFindThesesAsCompany.Contains(suggestion))
            {
                selectedAreasToFindThesesAsCompany.Add(suggestion);
                areaSuggestionsToFindThesesAsCompany.Clear();
                searchAreasInputToFindThesesAsCompany = string.Empty;
            }
        }

        private void RemoveSelectedAreaToFindThesesAsCompany(string area)
        {
            selectedAreasToFindThesesAsCompany.Remove(area);
            StateHasChanged();
        }

        private async Task DownloadProfessorThesisAttachmentWhenSearchForProfessorThesisAsCompany(int thesisId)
        {
            var thesis = dbContext.ProfessorTheses.FirstOrDefault(t => t.Id == thesisId);
            if (thesis == null)
            {
                Console.WriteLine("Thesis not found.");
                return;
            }

            if (thesis.ThesisAttachment == null)
            {
                Console.WriteLine("No attachment found.");
                return;
            }

            Console.WriteLine($"Attachment found for thesis {thesisId}, size: {thesis.ThesisAttachment.Length} bytes");

            string base64String = Convert.ToBase64String(thesis.ThesisAttachment);
            string fileName = $"Thesis_Attachment_{thesisId}.pdf"; // Adjust file extension if needed

            await JS.InvokeVoidAsync("downloadInternshipAttachmentAsStudent", fileName, base64String); // Reusing the same JS function
        }

        private async Task ScrollToAlertWhenNoJobsFoundWhenSearchAsStudent()
        {
            await JS.InvokeVoidAsync("scrollToElement", "noJobsFoundAlert");
        }
        private async Task ScrollToAlertWhenNoThesesFoundWhenSearchAsStudent()
        {
            await JS.InvokeVoidAsync("scrollToElement", "noThesesFoundAlert");
        }
            private async Task ScrollToAlertWhenNoInternshipsFoundWhenSearchAsStudent()
        {
            await JS.InvokeVoidAsync("scrollToElement", "noInternshipsFoundAlert");
        }


        private async Task ShowProfessorHyperlinkNameDetailsModalInStudentInternship(string professorEmail)
        {
            selectedProfessorDetailsForHyperlinkNameInInternshipAsStudent = await dbContext.Professors
                .FirstOrDefaultAsync(p => p.ProfEmail == professorEmail);

            // Show the modal after fetching the details
            StateHasChanged();
            await JS.InvokeVoidAsync("showProfessorDetailsModal"); // Show the modal using JS
        }

        private async Task ShowCompanyHyperlinkNameDetailsModalInStudentInternship(string companyEmail)
        {
            selectedCompanyDetailsForHyperlinkNameInInternshipAsStudent = await dbContext.Companies
                .FirstOrDefaultAsync(c => c.CompanyEmail == companyEmail);

            if (selectedCompanyDetailsForHyperlinkNameInInternshipAsStudent != null)
            {
                isCompanyDetailsModalOpenForHyperlinkNameAsStudentForCompanyInternship = true;
                StateHasChanged();
                await JS.InvokeVoidAsync("showCompanyDetailsModal"); // Show the modal using JS
            }
        }

        void CloseModalForProfessorNameHyperlinkDetailsInInternship()
        {
            selectedProfessorDetailsForHyperlinkNameInInternshipAsStudent = null;
            StateHasChanged();
            JS.InvokeVoidAsync("hideProfessorDetailsModal");
        }

        void CloseModalForCompanyNameHyperlinkDetailsInInternship()
        {
            isCompanyDetailsModalOpenForHyperlinkNameAsStudentForCompanyInternship = false;
            selectedCompanyDetailsForHyperlinkNameInInternshipAsStudent = null;
            StateHasChanged();
            JS.InvokeVoidAsync("hideCompanyDetailsModal");
        }

        private void OnInternshipFilterChange(ChangeEventArgs e)
        {
            var filterValue = e.Value?.ToString();
        
            if (sumUpInternshipsFromBothCompanyAndProfessor == null) return;

            publishedInternships = filterValue switch
            {
                "company" => sumUpInternshipsFromBothCompanyAndProfessor
                    .Where(i => !string.IsNullOrEmpty(i.CompanyName))
                    .ToList(),
                "professor" => sumUpInternshipsFromBothCompanyAndProfessor
                    .Where(i => !string.IsNullOrEmpty(i.ProfessorName))
                    .ToList(),
                _ => sumUpInternshipsFromBothCompanyAndProfessor.ToList() // "all" or default
            };
        
            StateHasChanged();
        }

        // Filtering logic for internships
        private async Task FilterInternshipApplications(ChangeEventArgs e)
        {
            filterValueForInternships = e.Value?.ToString()?.ToLower() ?? "all";

            // Set visibility flags
            showCompanyInternshipApplications = filterValueForInternships == "all" || filterValueForInternships == "company";
            showProfessorInternshipApplications = filterValueForInternships == "all" || filterValueForInternships == "professor";

            try 
            {
                await Task.Delay(1000); // Simulate async operation
            }
            finally
            {
                StateHasChanged(); // Ensure UI updates even if delay fails
            }
        }


        private void SetTotalInternshipCount(int count)
        {
            totalInternshipCount = count;
            totalPagesForInternshipsToSee = (int)Math.Ceiling((double)totalInternshipCount / pageSizeForInternshipsToSee);
        }

        private bool IsPreviousDisabledForInternships => currentPageForInternshipsToSee == 1;
        private bool IsNextDisabledForInternships => currentPageForInternshipsToSee == totalPagesForInternshipsToSee;

        // Helper method to get row color
        private string GetInternshipRowColor(object application)
        {
            if (application is InternshipApplied companyApp)
            {
                return companyApp.InternshipStatusAppliedAtTheStudentSide switch
                {
                    "Επιτυχής" => "lightgreen",
                    "Απορρίφθηκε" => "lightcoral",
                    "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)" => "coral",
                    "Αποσύρθηκε από τον φοιτητή" => "lightyellow",
                    _ => "transparent"
                };
            }
            else if (application is ProfessorInternshipApplied professorApp)
            {
                return professorApp.InternshipStatusAppliedAtTheStudentSide switch
                {
                    "Επιτυχής" => "lightgreen",
                    "Απορρίφθηκε" => "lightcoral",
                    "Απορρίφθηκε (Απόσυρση Θέσεως Από τον Καθηγητή)" => "coral",
                    "Αποσύρθηκε από τον φοιτητή" => "lightyellow",
                    _ => "transparent"
                };
            }
            return "transparent";
        }

        // Pagination variables
        private int currentThesisPage = 1;
        private int thesisPageSize = 10; // Adjust as needed


        // Method to reset to first page when filtering
        private async Task OnFilterChange_PaginationForStudentThesisSearch(ChangeEventArgs e)
        {
            currentThesisPage = 1; // Reset to first page when filter changes
            filterValue = e.Value?.ToString() ?? "all";
            // Your existing filter logic here...
            await LoadThesisData(); // Or whatever your data loading method is
            StateHasChanged();
        }

        private int currentJobPage = 1;
        private int jobPageSize = 10; // Adjust as needed
        private void ChangeJobPage(int newPage)
        {
            var totalPages = (int)Math.Ceiling((double)jobApplications.Count / jobPageSize);
            if (newPage > 0 && newPage <= totalPages)
            {
                currentJobPage = newPage;
            }
        }


        private int currentJobPositionPage = 1;
        private int jobPositionPageSize = 10; // Adjust as needed
        private void ChangeJobPositionPage(int newPage)
        {
            var publishedJobs = jobs?.Where(i => i.PositionStatus == "Δημοσιευμένη").ToList();
            if (publishedJobs != null)
            {
                var totalPages = (int)Math.Ceiling((double)publishedJobs.Count / jobPositionPageSize);
                if (newPage > 0 && newPage <= totalPages)
                {
                    currentJobPositionPage = newPage;
                }
            }
        }

        private void GoToFirstPage()
        {
            currentPageForThesisToSee = 1;
        }

        private void GoToLastPage()
        {
            currentPageForThesisToSee = totalPagesForThesisToSee;
        }

        private void GoToPage(int pageNumber)
        {
            currentPageForThesisToSee = pageNumber;
        }

        private List<int> GetVisiblePages()
        {
            var pages = new List<int>();
            int current = currentPageForThesisToSee;
            int total = totalPagesForThesisToSee;
        
            pages.Add(1);
        
            if (current > 3)
            {
                pages.Add(-1);
            }
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }
        
            if (current < total - 2)
            {
                pages.Add(-1);
            }
        
            if (total > 1)
            {
                pages.Add(total);
            }
        
            return pages;
        }

        private string GetPageButtonStyle(int pageNumber)
        {
            return pageNumber == currentPageForThesisToSee 
                ? "background-color: #0056b3; color: white;" 
                : "background-color: #007bff; color: white;";
        }

        private List<int> GetVisiblePages(int currentPage, int totalPages)
        {
            var pages = new List<int>();
            
            // Always show first page
            pages.Add(1);
            
            // Show pages around current page
            if (currentPage > 3) pages.Add(-1); // Ellipsis
            
            int start = Math.Max(2, currentPage - 1);
            int end = Math.Min(totalPages - 1, currentPage + 1);
            
            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }
            
            if (currentPage < totalPages - 2) pages.Add(-1); // Ellipsis
            
            // Always show last page if different from first
            if (totalPages > 1) pages.Add(totalPages);
            
            return pages;
        }


        private int totalThesisPages_SearchThesisAsStudent => (int)Math.Ceiling((double)publishedTheses.Count / thesisPageSize);
        private void ChangeThesisPage(int newPage)
        {
            if (newPage > 0 && newPage <= totalThesisPages_SearchThesisAsStudent)
            {
                currentThesisPage = newPage;
                StateHasChanged(); // Ensure UI updates
            }
        }


        private void GoToFirstPageForInternships()
        {
            currentPageForInternshipsToSee = 1;
            StateHasChanged();
        }

        private void GoToLastPageForInternships()
        {
            currentPageForInternshipsToSee = totalPagesForInternshipsToSee;
            StateHasChanged();
        }

        private void GoToPageForInternships(int page)
        {
            if (page > 0 && page <= totalPagesForInternshipsToSee)
            {
                currentPageForInternshipsToSee = page;
                StateHasChanged();
            }
        }

        private List<int> GetVisiblePagesForInternships()
        {
            var pages = new List<int>();
            int current = currentPageForInternshipsToSee;
            int total = totalPagesForInternshipsToSee;
            
            // Always show first page
            pages.Add(1);
            
            // Show pages around current page
            if (current > 3) pages.Add(-1); // Ellipsis
            
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
            
            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }
            
            if (current < total - 2) pages.Add(-1); // Ellipsis
            
            // Always show last page if different from first
            if (total > 1) pages.Add(total);
            
            return pages;
        }

        // Keep your existing methods
        private void PreviousPageForInternshipsToSee()
        {
            if (currentPageForInternshipsToSee > 1)
            {
                currentPageForInternshipsToSee--;
                StateHasChanged();
            }
        }

        private void NextPageForInternshipsToSee()
        {
            if (currentPageForInternshipsToSee < totalPagesForInternshipsToSee)
            {
                currentPageForInternshipsToSee++;
                StateHasChanged();
            }
        }

        // Pagination methods for internships


    // Pagination methods
        private void GoToFirstInternshipPage()
        {
            currentInternshipPage = 1;
            StateHasChanged();
        }

        private void GoToLastInternshipPage()
        {
            currentInternshipPage = totalInternshipPages;
            StateHasChanged();
        }

        private void GoToInternshipPage(int page)
        {
            if (page > 0 && page <= totalInternshipPages)
            {
                currentInternshipPage = page;
                StateHasChanged();
            }
        }

        private void PreviousInternshipPage()
        {
            if (currentInternshipPage > 1)
            {
                currentInternshipPage--;
                StateHasChanged();
            }
        }

        private void NextInternshipPage()
        {
            if (currentInternshipPage < totalInternshipPages)
            {
                currentInternshipPage++;
                StateHasChanged();
            }
        }

        private List<int> GetVisibleInternshipPages()
        {
            var pages = new List<int>();
            int current = currentInternshipPage;
            int total = totalInternshipPages;
            
            // Always show first page
            pages.Add(1);
            
            // Show pages around current page
            if (current > 3) pages.Add(-1); // Ellipsis
            
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
            
            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }
            
            if (current < total - 2) pages.Add(-1); // Ellipsis
            
            // Always show last page if different from first
            if (total > 1) pages.Add(total);
            
            return pages;
        }

        // Method to get paginated internships (3 per page)
        private IEnumerable<AllInternships> GetPaginatedInternships()
        {
            return publishedInternships?
                .Skip((currentInternshipPage - 1) * InternshipsPerPage)
                .Take(InternshipsPerPage);
        }

        private int currentPageForAnnouncements = 1;
        private int pageSizeForAnnouncements = 10;
        private int totalPagesForAnnouncements => (int)Math.Ceiling((double)(FilteredAnnouncements?.Count ?? 0) / pageSizeForAnnouncements);
        private IEnumerable<AnnouncementAsCompany> GetPaginatedAnnouncements()
        {
            return FilteredAnnouncements?
                .Skip((currentPageForAnnouncements - 1) * pageSizeForAnnouncements)
                .Take(pageSizeForAnnouncements) ?? Enumerable.Empty<AnnouncementAsCompany>();
        }

        private List<int> GetVisiblePagesForAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForAnnouncements;
            int total = totalPagesForAnnouncements;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        private void GoToFirstPageForAnnouncements() => ChangePageForAnnouncements(1);
        private void GoToLastPageForAnnouncements() => ChangePageForAnnouncements(totalPagesForAnnouncements);
        private void PreviousPageForAnnouncements() => ChangePageForAnnouncements(currentPageForAnnouncements - 1);
        private void NextPageForAnnouncements() => ChangePageForAnnouncements(currentPageForAnnouncements + 1);

        private void GoToPageForAnnouncements(int page)
        {
            if (page > 0 && page <= totalPagesForAnnouncements)
            {
                currentPageForAnnouncements = page;
                StateHasChanged();
            }
        }

        private void ChangePageForAnnouncements(int newPage)
        {
            if (newPage > 0 && newPage <= totalPagesForAnnouncements)
            {
                currentPageForAnnouncements = newPage;
                StateHasChanged();
            }
        }

        // Pagination variables for jobs
        private int currentPageForJobs = 1;
        private int JobsPerPage = 10;
        private int totalPagesForJobs => 
            (int)Math.Ceiling((double)(GetFilteredJobs()?.Count() ?? 0) / JobsPerPage);

        // Get filtered jobs based on status
        private IEnumerable<CompanyJob> GetFilteredJobs()
        {
            return jobs?
                .Where(j => selectedStatusFilterForJobs == "Όλα" || j.PositionStatus == selectedStatusFilterForJobs)
                ?? Enumerable.Empty<CompanyJob>();
        }

        // Get paginated jobs
        private IEnumerable<CompanyJob> GetPaginatedJobs()
        {
            return GetFilteredJobs()
                .Skip((currentPageForJobs - 1) * JobsPerPage)
                .Take(JobsPerPage);
        }

        // Navigation methods
        private void GoToFirstPageForJobs()
        {
            currentPageForJobs = 1;
            StateHasChanged();
        }

        private void GoToLastPageForJobs()
        {
            currentPageForJobs = totalPagesForJobs;
            StateHasChanged();
        }

        private void PreviousPageForJobs()
        {
            if (currentPageForJobs > 1)
            {
                currentPageForJobs--;
                StateHasChanged();
            }
        }

        private void NextPageForJobs()
        {
            if (currentPageForJobs < totalPagesForJobs)
            {
                currentPageForJobs++;
                StateHasChanged();
            }
        }

        private void GoToPageForJobs(int page)
        {
            if (page > 0 && page <= totalPagesForJobs)
            {
                currentPageForJobs = page;
                StateHasChanged();
            }
        }

        private List<int> GetVisiblePagesForJobs()
        {
            var pages = new List<int>();
            int current = currentPageForJobs;
            int total = totalPagesForJobs;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        // Pagination variables for company internships
        private int currentPageForCompanyInternships = 1;
        private int companyInternshipsPerPage = 10;
        private int totalPagesForCompanyInternships => 
            (int)Math.Ceiling((double)(GetFilteredCompanyInternships()?.Count() ?? 0) / companyInternshipsPerPage);

        // Get filtered company internships based on status
        private IEnumerable<CompanyInternship> GetFilteredCompanyInternships()
        {
            return internships?
                .Where(i => selectedStatusFilterForInternships == "Όλα" || i.CompanyUploadedInternshipStatus == selectedStatusFilterForInternships)
                ?? Enumerable.Empty<CompanyInternship>();
        }

        // Get paginated company internships
        private IEnumerable<CompanyInternship> GetPaginatedCompanyInternships()
        {
            return GetFilteredCompanyInternships()
                .Skip((currentPageForCompanyInternships - 1) * companyInternshipsPerPage)
                .Take(companyInternshipsPerPage);
        }

        // Navigation methods
        private void GoToFirstPageForCompanyInternships()
        {
            currentPageForCompanyInternships = 1;
            StateHasChanged();
        }

        private void GoToLastPageForCompanyInternships()
        {
            currentPageForCompanyInternships = totalPagesForCompanyInternships;
            StateHasChanged();
        }

        private void PreviousPageForCompanyInternships()
        {
            if (currentPageForCompanyInternships > 1)
            {
                currentPageForCompanyInternships--;
                StateHasChanged();
            }
        }

        private void NextPageForCompanyInternships()
        {
            if (currentPageForCompanyInternships < totalPagesForCompanyInternships)
            {
                currentPageForCompanyInternships++;
                StateHasChanged();
            }
        }

        private void GoToPageForCompanyInternships(int page)
        {
            if (page > 0 && page <= totalPagesForCompanyInternships)
            {
                currentPageForCompanyInternships = page;
                StateHasChanged();
            }
        }

        private List<int> GetVisiblePagesForCompanyInternships()
        {
            var pages = new List<int>();
            int current = currentPageForCompanyInternships;
            int total = totalPagesForCompanyInternships;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        // Pagination variables for company theses
        private int currentPageForCompanyTheses = 1;
        private int CompanyThesesPerPage = 10;
        private int totalPagesForCompanyTheses => 
            (int)Math.Ceiling((double)(GetFilteredCompanyTheses()?.Count() ?? 0) / CompanyThesesPerPage);

        // Get filtered company theses based on status
        private IEnumerable<CompanyThesis> GetFilteredCompanyTheses()
        {
            return companytheses?
                .Where(j => selectedStatusFilterForCompanyTheses == "Όλα" || j.CompanyThesisStatus == selectedStatusFilterForCompanyTheses)
                ?? Enumerable.Empty<CompanyThesis>();
        }

        // Get paginated company theses
        private IEnumerable<CompanyThesis> GetPaginatedCompanyTheses()
        {
            return GetFilteredCompanyTheses()
                .Skip((currentPageForCompanyTheses - 1) * CompanyThesesPerPage)
                .Take(CompanyThesesPerPage);
        }

        // Navigation methods
        private void GoToFirstPageForCompanyTheses()
        {
            currentPageForCompanyTheses = 1;
            StateHasChanged();
        }

        private void GoToLastPageForCompanyTheses()
        {
            currentPageForCompanyTheses = totalPagesForCompanyTheses;
            StateHasChanged();
        }

        private void PreviousPageForCompanyTheses()
        {
            if (currentPageForCompanyTheses > 1)
            {
                currentPageForCompanyTheses--;
                StateHasChanged();
            }
        }

        private void NextPageForCompanyTheses()
        {
            if (currentPageForCompanyTheses < totalPagesForCompanyTheses)
            {
                currentPageForCompanyTheses++;
                StateHasChanged();
            }
        }

        private void GoToPageForCompanyTheses(int page)
        {
            if (page > 0 && page <= totalPagesForCompanyTheses)
            {
                currentPageForCompanyTheses = page;
                StateHasChanged();
            }
        }

        // Make sure to reset to page 1 when filter changes
        private void HandleStatusFilterChangeForCompanyTheses(ChangeEventArgs e)
        {
            selectedStatusFilterForCompanyTheses = e.Value.ToString();
            currentPageForCompanyTheses = 1; // Reset to first page
            StateHasChanged();
        }

            private List<int> GetVisiblePagesForCompanyTheses()
        {
            var pages = new List<int>();
            int current = currentPageForCompanyTheses;
            int total = totalPagesForCompanyTheses;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        // Pagination variables for company events
        private int currentPageForCompanyEvents = 1;
        private int CompanyEventsPerPage = 10;
        private int totalPagesForCompanyEvents_CompanyEventsToSee => 
            (int)Math.Ceiling((double)(FilteredCompanyEvents?.Count ?? 0) / CompanyEventsPerPage);

        // Get paginated company events
        private IEnumerable<CompanyEvent> GetPaginatedCompanyEvents()
        {
            return FilteredCompanyEvents?
                .Skip((currentPageForCompanyEvents - 1) * CompanyEventsPerPage)
                .Take(CompanyEventsPerPage) ?? Enumerable.Empty<CompanyEvent>();
        }

        private List<int> GetVisiblePagesForCompanyEvents()
        {
            var pages = new List<int>();
            int current = currentPageForCompanyEvents;
            int total = totalPagesForCompanyEvents_CompanyEventsToSee;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        // Navigation methods
        private void GoToFirstPageForCompanyEvents()
        {
            currentPageForCompanyEvents = 1;
            StateHasChanged();
        }

        private void GoToLastPageForCompanyEvents()
        {
            currentPageForCompanyEvents = totalPagesForCompanyEvents_CompanyEventsToSee;
            StateHasChanged();
        }

        private void PreviousPageForCompanyEvents()
        {
            if (currentPageForCompanyEvents > 1)
            {
                currentPageForCompanyEvents--;
                StateHasChanged();
            }
        }

        private void NextPageForCompanyEvents()
        {
            if (currentPageForCompanyEvents < totalPagesForCompanyEvents_CompanyEventsToSee)
            {
                currentPageForCompanyEvents++;
                StateHasChanged();
            }
        }

        private void GoToPageForCompanyEvents(int page)
        {
            if (page > 0 && page <= totalPagesForCompanyEvents_CompanyEventsToSee)
            {
                currentPageForCompanyEvents = page;
                StateHasChanged();
            }
        }

        // Renamed pagination variables
        private int currentPageForProfessorAnnouncements_ProfessorAnnouncements = 1;
        private int professorAnnouncementsPerPage_SeeMyUploadedAnnouncementsAsProfessor = 10; // Default value
        private int totalPagesForProfessorAnnouncements_ProfessorAnnouncements => 
            (int)Math.Ceiling((double)(FilteredAnnouncementsAsProfessor?.Count ?? 0) / professorAnnouncementsPerPage_SeeMyUploadedAnnouncementsAsProfessor);

        // Renamed methods
        private IEnumerable<AnnouncementAsProfessor> GetPaginatedProfessorAnnouncements_ProfessorAnnouncements()
        {
            return FilteredAnnouncementsAsProfessor?
                .Skip((currentPageForProfessorAnnouncements_ProfessorAnnouncements - 1) * professorAnnouncementsPerPage_SeeMyUploadedAnnouncementsAsProfessor)
                .Take(professorAnnouncementsPerPage_SeeMyUploadedAnnouncementsAsProfessor) ?? Enumerable.Empty<AnnouncementAsProfessor>();
        }

        private List<int> GetVisiblePagesForProfessorAnnouncements_ProfessorAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForProfessorAnnouncements_ProfessorAnnouncements;
            int total = totalPagesForProfessorAnnouncements_ProfessorAnnouncements;

            // Always add first page
            pages.Add(1);

            // Add ellipsis (...) if current page is far from the start
            if (current > 3) 
            {
                pages.Add(-1); // -1 represents ellipsis
            }

            // Add pages around current page (1 page before & after)
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) 
            {
                pages.Add(i);
            }

            // Add ellipsis (...) if current page is far from the end
            if (current < total - 2) 
            {
                pages.Add(-1);
            }

            // Add last page if there's more than 1 page
            if (total > 1) 
            {
                pages.Add(total);
            }

            return pages;
        }

        // Renamed navigation methods
        private void GoToFirstPageForProfessorAnnouncements_ProfessorAnnouncements()
        {
            currentPageForProfessorAnnouncements_ProfessorAnnouncements = 1;
            StateHasChanged();
        }

        private void GoToLastPageForProfessorAnnouncements_ProfessorAnnouncements()
        {
            currentPageForProfessorAnnouncements_ProfessorAnnouncements = totalPagesForProfessorAnnouncements_ProfessorAnnouncements;
            StateHasChanged();
        }

        private void PreviousPageForProfessorAnnouncements_ProfessorAnnouncements()
        {
            if (currentPageForProfessorAnnouncements_ProfessorAnnouncements > 1)
            {
                currentPageForProfessorAnnouncements_ProfessorAnnouncements--;
                StateHasChanged();
            }
        }

        private void NextPageForProfessorAnnouncements_ProfessorAnnouncements()
        {
            if (currentPageForProfessorAnnouncements_ProfessorAnnouncements < totalPagesForProfessorAnnouncements_ProfessorAnnouncements)
            {
                currentPageForProfessorAnnouncements_ProfessorAnnouncements++;
                StateHasChanged();
            }
        }

        private void GoToPageForProfessorAnnouncements_ProfessorAnnouncements(int page)
        {
            if (page > 0 && page <= totalPagesForProfessorAnnouncements_ProfessorAnnouncements)
            {
                currentPageForProfessorAnnouncements_ProfessorAnnouncements = page;
                StateHasChanged();
            }
        }

        // Renamed filter handler
        private void HandleStatusFilterChangeForProfessorAnnouncements_ProfessorAnnouncements(ChangeEventArgs e)
        {
            // Your existing filter logic
            currentPageForProfessorAnnouncements_ProfessorAnnouncements = 1;
            StateHasChanged();
        }

        // Pagination variables for professor theses
        private int currentPageForProfessorTheses = 1;
        private int ProfessorThesesPerPage = 10;
        private int totalPagesForProfessorTheses => 
            (int)Math.Ceiling((double)(GetFilteredProfessorTheses()?.Count() ?? 0) / ProfessorThesesPerPage);

        // Get filtered professor theses based on status
        private IEnumerable<ProfessorThesis> GetFilteredProfessorTheses()
        {
            return FilteredThesesAsProfessor?
                .Where(j => selectedStatusFilterForThesesAsProfessor == "Όλα" || j.ThesisStatus == selectedStatusFilterForThesesAsProfessor)
                ?? Enumerable.Empty<ProfessorThesis>();
        }

        // Get paginated professor theses
        private IEnumerable<ProfessorThesis> GetPaginatedProfessorTheses()
        {
            return GetFilteredProfessorTheses()
                .Skip((currentPageForProfessorTheses - 1) * ProfessorThesesPerPage)
                .Take(ProfessorThesesPerPage);
        }

        private List<int> GetVisiblePagesForProfessorTheses()
        {
            var pages = new List<int>();
            int current = currentPageForProfessorTheses;
            int total = totalPagesForProfessorTheses;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        // Navigation methods
        private void GoToFirstPageForProfessorTheses()
        {
            currentPageForProfessorTheses = 1;
            StateHasChanged();
        }

        private void GoToLastPageForProfessorTheses()
        {
            currentPageForProfessorTheses = totalPagesForProfessorTheses;
            StateHasChanged();
        }

        private void PreviousPageForProfessorTheses()
        {
            if (currentPageForProfessorTheses > 1)
            {
                currentPageForProfessorTheses--;
                StateHasChanged();
            }
        }

        private void NextPageForProfessorTheses()
        {
            if (currentPageForProfessorTheses < totalPagesForProfessorTheses)
            {
                currentPageForProfessorTheses++;
                StateHasChanged();
            }
        }

        private void GoToPageForProfessorTheses(int page)
        {
            if (page > 0 && page <= totalPagesForProfessorTheses)
            {
                currentPageForProfessorTheses = page;
                StateHasChanged();
            }
        }

        // Make sure to reset to page 1 when filter changes
        private void HandleStatusFilterChangeForProfessorTheses(ChangeEventArgs e)
        {
            selectedStatusFilterForThesesAsProfessor = e.Value.ToString();
            currentPageForProfessorTheses = 1; // Reset to first page
            StateHasChanged();
        }

        private int currentPage_CompanyTheses = 1;
        private int itemsPerPage_CompanyTheses = 10; // adjust as needed
        private int totalPages_CompanyTheses =>
            (int)Math.Ceiling((double)(companyThesesResultsToFindThesesAsProfessor?.Count ?? 0) / itemsPerPage_CompanyTheses);

        private IEnumerable<CompanyThesis> GetPaginatedCompanyTheses_AsProfessor()
        {
            return companyThesesResultsToFindThesesAsProfessor?
                .Skip((currentPage_CompanyTheses - 1) * itemsPerPage_CompanyTheses)
                .Take(itemsPerPage_CompanyTheses) ?? Enumerable.Empty<CompanyThesis>();
        }

        private List<int> GetVisiblePages_CompanyTheses_AsProfessor()
        {
            var pages = new List<int>();
            int current = currentPage_CompanyTheses;
            int total = totalPages_CompanyTheses;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_CompanyTheses() => currentPage_CompanyTheses = 1;
        private void GoToLastPage_CompanyTheses() => currentPage_CompanyTheses = totalPages_CompanyTheses;
        private void PreviousPage_CompanyTheses()
        {
            if (currentPage_CompanyTheses > 1) currentPage_CompanyTheses--;
        }
        private void NextPage_CompanyTheses()
        {
            if (currentPage_CompanyTheses < totalPages_CompanyTheses) currentPage_CompanyTheses++;
        }
        private void GoToPage_CompanyTheses(int page)
        {
            if (page >= 1 && page <= totalPages_CompanyTheses)
                currentPage_CompanyTheses = page;
        }

        private int currentPage_ProfessorInternships = 1;
        private int itemsPerPage_ProfessorInternships = 10;
        private int totalPages_ProfessorInternships =>
            (int)Math.Ceiling((double)(professorInternships?.Count ?? 0) / itemsPerPage_ProfessorInternships);

        private IEnumerable<ProfessorInternship> GetPaginatedProfessorInternships()
        {
            return professorInternships?
                .Skip((currentPage_ProfessorInternships - 1) * itemsPerPage_ProfessorInternships)
                .Take(itemsPerPage_ProfessorInternships) ?? Enumerable.Empty<ProfessorInternship>();
        }

        private List<int> GetVisiblePages_ProfessorInternships()
        {
            var pages = new List<int>();
            int current = currentPage_ProfessorInternships;
            int total = totalPages_ProfessorInternships;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_ProfessorInternships() => currentPage_ProfessorInternships = 1;
        private void GoToLastPage_ProfessorInternships() => currentPage_ProfessorInternships = totalPages_ProfessorInternships;
        private void PreviousPage_ProfessorInternships()
        {
            if (currentPage_ProfessorInternships > 1) currentPage_ProfessorInternships--;
        }
        private void NextPage_ProfessorInternships()
        {
            if (currentPage_ProfessorInternships < totalPages_ProfessorInternships) currentPage_ProfessorInternships++;
        }
        private void GoToPage_ProfessorInternships(int page)
        {
            if (page >= 1 && page <= totalPages_ProfessorInternships)
                currentPage_ProfessorInternships = page;
        }

        private int currentPage_ProfessorEvents = 1;
        private int itemsPerPage_ProfessorEvents = 10;
        private int totalPages_ProfessorEvents =>
            (int)Math.Ceiling((double)(FilteredProfessorEvents?.Count ?? 0) / itemsPerPage_ProfessorEvents);

        private IEnumerable<ProfessorEvent> GetPaginatedProfessorEvents()
        {
            return FilteredProfessorEvents?
                .Skip((currentPage_ProfessorEvents - 1) * itemsPerPage_ProfessorEvents)
                .Take(itemsPerPage_ProfessorEvents) ?? Enumerable.Empty<ProfessorEvent>();
        }

        private List<int> GetVisiblePages_ProfessorEvents()
        {
            var pages = new List<int>();
            int current = currentPage_ProfessorEvents;
            int total = totalPages_ProfessorEvents;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_ProfessorEvents() => currentPage_ProfessorEvents = 1;
        private void GoToLastPage_ProfessorEvents() => currentPage_ProfessorEvents = totalPages_ProfessorEvents;
        private void PreviousPage_ProfessorEvents()
        {
            if (currentPage_ProfessorEvents > 1) currentPage_ProfessorEvents--;
        }
        private void NextPage_ProfessorEvents()
        {
            if (currentPage_ProfessorEvents < totalPages_ProfessorEvents) currentPage_ProfessorEvents++;
        }
        private void GoToPage_ProfessorEvents(int page)
        {
            if (page >= 1 && page <= totalPages_ProfessorEvents)
                currentPage_ProfessorEvents = page;
        }

        private int currentPage_ProfessorTheses = 1;
        private int itemsPerPage_ProfessorTheses = 10; // Adjust as needed
        private int totalPages_ProfessorTheses =>
            (int)Math.Ceiling((double)(professorThesesResultsToFindThesesAsCompany?.Count ?? 0) / itemsPerPage_ProfessorTheses);

        private IEnumerable<ProfessorThesis> GetPaginatedProfessorTheses_AsCompany()
        {
            return professorThesesResultsToFindThesesAsCompany?
                .Skip((currentPage_ProfessorTheses - 1) * itemsPerPage_ProfessorTheses)
                .Take(itemsPerPage_ProfessorTheses) ?? Enumerable.Empty<ProfessorThesis>();
        }

        private List<int> GetVisiblePages_ProfessorTheses_AsCompany()
        {
            var pages = new List<int>();
            int current = currentPage_ProfessorTheses;
            int total = totalPages_ProfessorTheses;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_ProfessorTheses() => currentPage_ProfessorTheses = 1;
        private void GoToLastPage_ProfessorTheses() => currentPage_ProfessorTheses = totalPages_ProfessorTheses;
        private void PreviousPage_ProfessorTheses()
        {
            if (currentPage_ProfessorTheses > 1) currentPage_ProfessorTheses--;
        }
        private void NextPage_ProfessorTheses()
        {
            if (currentPage_ProfessorTheses < totalPages_ProfessorTheses) currentPage_ProfessorTheses++;
        }
        private void GoToPage_ProfessorTheses(int page)
        {
            if (page >= 1 && page <= totalPages_ProfessorTheses)
                currentPage_ProfessorTheses = page;
        }

        // Pagination variables for events
        private int currentPageForEvents = 1;
        private int itemsPerPageForEvents = 10; // Adjust as needed
        private int totalPagesForEvents => 
            (int)Math.Ceiling((double)GetFilteredEventsCount() / itemsPerPageForEvents);

        // Helper methods for pagination
        private IEnumerable<CompanyEvent> GetPaginatedCompanyEvents_StudentSearchEvents()
        {
            if (selectedEventType == "professor") return Enumerable.Empty<CompanyEvent>();
        
            var filtered = companyEventsToSeeAsStudent;
            if (selectedEventType == "all" || selectedEventType == "company")
            {
                return filtered
                    .Skip((currentPageForEvents - 1) * itemsPerPageForEvents)
                    .Take(itemsPerPageForEvents);
            }
            return Enumerable.Empty<CompanyEvent>();
        }

        private IEnumerable<ProfessorEvent> GetPaginatedProfessorEvents_StudentSearchEvents()
        {
            if (selectedEventType == "company") return Enumerable.Empty<ProfessorEvent>();
        
            var filtered = professorEventsToSeeAsStudent;
            if (selectedEventType == "all" || selectedEventType == "professor")
            {
                return filtered
                    .Skip((currentPageForEvents - 1) * itemsPerPageForEvents)
                    .Take(itemsPerPageForEvents);
            }
            return Enumerable.Empty<ProfessorEvent>();
        }

        private int GetFilteredEventsCount()
        {
            int count = 0;
        
            if (selectedEventType == "all" || selectedEventType == "company")
            {
                count += companyEventsToSeeAsStudent?.Count() ?? 0;
            }
        
            if (selectedEventType == "all" || selectedEventType == "professor")
            {
                count += professorEventsToSeeAsStudent?.Count() ?? 0;
            }
        
            return count;
        }

        // Pagination methods
        private List<int> GetVisiblePagesForEvents()
        {
            var pages = new List<int>();
            int current = currentPageForEvents;
            int total = totalPagesForEvents;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);

            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);

            return pages;
        }

        private void GoToFirstPageForEvents() => currentPageForEvents = 1;
        private void PreviousPageForEvents() => currentPageForEvents = Math.Max(1, currentPageForEvents - 1);
        private void NextPageForEvents() => currentPageForEvents = Math.Min(totalPagesForEvents, currentPageForEvents + 1);
        private void GoToLastPageForEvents() => currentPageForEvents = totalPagesForEvents;
        private void GoToPageForEvents(int page) => currentPageForEvents = page;

        private void OnPageSizeChange_SearchForThesisAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                thesisPageSize = newSize;
                currentThesisPage = 1; // Reset to first page when changing page size (Idio approach me tis alles methodous)
                StateHasChanged();
            }
        }

        private void OnPageSizeChangeForApplications_SeeMyThesisApplicationsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                pageSizeForThesisToSee = newSize;
                currentPageForThesisToSee = 1;  //reset sto page poy 8elw otan allazw to dropdown menu
                StateHasChanged();
            }
        }

        private void OnJobPageSizeChange_SeeMyJobApplicationsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                jobPageSize = newSize;
                currentJobPage = 1; 
                StateHasChanged();
            }
        }

        private void OnJobPageSizeChange_SearchForJobsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                jobPositionPageSize = newSize;
                currentJobPositionPage = 1; 
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyInternshipApplicationsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                pageSizeForInternshipsToSee = newSize;
                currentPageForInternshipsToSee = 1; 
                StateHasChanged();
            }
        } 
        
        private void OnPageSizeChange_SearchForInternshipsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                InternshipsPerPage = newSize;
                currentInternshipPage = 1; 
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SearchForEventsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                itemsPerPageForEvents = newSize;
                currentPageForEvents = 1; 
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedAnnouncementsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                pageSizeForAnnouncements = newSize;
                currentPageForAnnouncements = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedJobsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                JobsPerPage = newSize;
                currentPageForJobs = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedInternshipsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                companyInternshipsPerPage = newSize;
                currentPageForCompanyInternships = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedThesesAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                CompanyThesesPerPage = newSize;
                currentPageForCompanyTheses = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SearchForProfessorThesesAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                itemsPerPage_ProfessorTheses = newSize;
                currentPage_ProfessorTheses = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedEventsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                CompanyEventsPerPage = newSize;
                currentPageForCompanyEvents = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        // Pagination variables for students search
        private int currentPageForStudents_SearchForStudentsAsCompany = 1;
        private int StudentsPerPage_SearchForStudentsAsCompany = 10; // Na einai initiated me 3 stoixeia ana selida tou pinaka
        private int totalPagesForStudents_SearchForStudentsAsCompany => 
            (int)Math.Ceiling((double)(searchResultsAsCompanyToFindStudent?.Count() ?? 0) / StudentsPerPage_SearchForStudentsAsCompany);

        // Get paginated students
        private IEnumerable<Student> GetPaginatedStudents_SearchForStudentsAsCompany()
        {
            return searchResultsAsCompanyToFindStudent?
                .Skip((currentPageForStudents_SearchForStudentsAsCompany - 1) * StudentsPerPage_SearchForStudentsAsCompany)
                .Take(StudentsPerPage_SearchForStudentsAsCompany)
                ?? Enumerable.Empty<Student>();
        }

        // Navigation methods
        private void GoToFirstPageForStudents_SearchForStudentsAsCompany()
        {
            currentPageForStudents_SearchForStudentsAsCompany = 1;
            StateHasChanged();
        }

        private void GoToLastPageForStudents_SearchForStudentsAsCompany()
        {
            currentPageForStudents_SearchForStudentsAsCompany = totalPagesForStudents_SearchForStudentsAsCompany;
            StateHasChanged();
        }

        private void PreviousPageForStudents_SearchForStudentsAsCompany()
        {
            if (currentPageForStudents_SearchForStudentsAsCompany > 1)
            {
                currentPageForStudents_SearchForStudentsAsCompany--;
                StateHasChanged();
            }
        }

        private void NextPageForStudents_SearchForStudentsAsCompany()
        {
            if (currentPageForStudents_SearchForStudentsAsCompany < totalPagesForStudents_SearchForStudentsAsCompany)
            {
                currentPageForStudents_SearchForStudentsAsCompany++;
                StateHasChanged();
            }
        }

        private void GoToPageForStudents_SearchForStudentsAsCompany(int page)
        {
            if (page > 0 && page <= totalPagesForStudents_SearchForStudentsAsCompany)
            {
                currentPageForStudents_SearchForStudentsAsCompany = page;
                StateHasChanged();
            }
        }

        private List<int> GetVisiblePagesForStudents_SearchForStudentsAsCompany()
        {
            var pages = new List<int>();
            int current = currentPageForStudents_SearchForStudentsAsCompany;
            int total = totalPagesForStudents_SearchForStudentsAsCompany;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);

            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);

            return pages;
        }

        private void OnPageSizeChange_SearchForStudentsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                StudentsPerPage_SearchForStudentsAsCompany = newSize;
                currentPageForStudents_SearchForStudentsAsCompany = 1; 
                StateHasChanged();
            }
        }


        private int ProfessorsPerPage_SearchForProfessorsAsStudent = 10; // Default value
        private int currentProfessorPage_SearchForProfessorsAsStudent = 1;

        private void OnPageSizeChange_SearchForProfessorsAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                ProfessorsPerPage_SearchForProfessorsAsStudent = newSize;
                currentProfessorPage_SearchForProfessorsAsStudent = 1;
                StateHasChanged();
            }
        }

        private IEnumerable<Professor> GetPaginatedProfessorResults()
        {
            return searchResultsAsCompanyToFindProfessor?
                .Skip((currentProfessorPage_SearchForProfessorsAsStudent - 1) * ProfessorsPerPage_SearchForProfessorsAsStudent)
                .Take(ProfessorsPerPage_SearchForProfessorsAsStudent) 
                ?? Enumerable.Empty<Professor>();
        }

        private int totalProfessorPages_SearchForProfessorsAsStudent => 
            searchResultsAsCompanyToFindProfessor != null 
                ? (int)Math.Ceiling((double)searchResultsAsCompanyToFindProfessor.Count / ProfessorsPerPage_SearchForProfessorsAsStudent) 
                : 1;

        private List<int> GetVisibleProfessorPages()
        {
            var pages = new List<int>();
            int currentPage = currentProfessorPage_SearchForProfessorsAsStudent;
            int totalPages = totalProfessorPages_SearchForProfessorsAsStudent;
        
            // Always show first page
            pages.Add(1);
        
            // Show pages around current page
            if (currentPage > 3) pages.Add(-1); // Ellipsis
        
            int start = Math.Max(2, currentPage - 1);
            int end = Math.Min(totalPages - 1, currentPage + 1);
        
            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }
        
            if (currentPage < totalPages - 2) pages.Add(-1); // Ellipsis
        
            // Always show last page if different from first
            if (totalPages > 1) pages.Add(totalPages);
        
            return pages;
        }

        private void GoToFirstProfessorPage()
        {
            currentProfessorPage_SearchForProfessorsAsStudent = 1;
            StateHasChanged();
        }

        private void PreviousProfessorPage()
        {
            if (currentProfessorPage_SearchForProfessorsAsStudent > 1)
            {
                currentProfessorPage_SearchForProfessorsAsStudent--;
                StateHasChanged();
            }
        }

        private void NextProfessorPage()
        {
            if (currentProfessorPage_SearchForProfessorsAsStudent < totalProfessorPages_SearchForProfessorsAsStudent)
            {
                currentProfessorPage_SearchForProfessorsAsStudent++;
                StateHasChanged();
            }
        }

        private void GoToLastProfessorPage()
        {
            currentProfessorPage_SearchForProfessorsAsStudent = totalProfessorPages_SearchForProfessorsAsStudent;
            StateHasChanged();
        }

        private void GoToProfessorPage(int pageNumber)
        {
            if (pageNumber >= 1 && pageNumber <= totalProfessorPages_SearchForProfessorsAsStudent)
            {
                currentProfessorPage_SearchForProfessorsAsStudent = pageNumber;
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedAnnouncementsAsProfessor(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                professorAnnouncementsPerPage_SeeMyUploadedAnnouncementsAsProfessor = newSize;
                currentPageForProfessorAnnouncements_ProfessorAnnouncements = 1; // Reset to first page
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedThesesAsProfessor(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                ProfessorThesesPerPage = newSize;
                currentPageForProfessorTheses = 1; // Reset to first page
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SearchForCompanyThesesAsProfessor(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                itemsPerPage_CompanyTheses = newSize;
                currentPage_CompanyTheses = 1; // Reset to first page
                StateHasChanged();
            }
        }

        private void OnPageSizeChange_SeeMyUploadedInternshipsAsProfessor(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                itemsPerPage_ProfessorInternships = newSize;
                currentPage_ProfessorInternships = 1; 
                StateHasChanged();
            }
        }

        private void HandleStatusFilterChangeForProfessorInternships(ChangeEventArgs e)
        {
            selectedStatusFilterForProfessorInternships = e.Value.ToString();
            FilterProfessorInternships();
        }

        private void FilterProfessorInternships()
        {
            // Filter the internships based on the selected filter
            if (selectedStatusFilterForProfessorInternships == "Όλα")
            {
                FilteredInternshipsAsProfessor = professorInternships;
            }
            else
            {
                FilteredInternshipsAsProfessor = professorInternships
                    .Where(i => i.ProfessorUploadedInternshipStatus == selectedStatusFilterForProfessorInternships)
                    .ToList();
            }

            totalProfessorInternshipsCount = professorInternships.Count;
            publishedProfessorInternshipsCount = professorInternships
                .Count(i => i.ProfessorUploadedInternshipStatus == "Δημοσιευμένη");
            unpublishedProfessorInternshipsCount = professorInternships
                .Count(i => i.ProfessorUploadedInternshipStatus == "Μη Δημοσιευμένη");
            withdrawnProfessorInternshipsCount = professorInternships
                .Count(i => i.ProfessorUploadedInternshipStatus == "Αποσυρμένη");

            currentPage_ProfessorInternships = 1;
            StateHasChanged();
        }

        private void OnPageSizeChange_SeeMyUploadedEventsAsProfessor(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value.ToString(), out int newSize))
            {
                itemsPerPage_ProfessorEvents = newSize;
                currentPage_ProfessorEvents = 1; // Reset to first page when changing page size
                StateHasChanged();
            }
        }

        private List<string> companyNameSuggestions = new List<string>();
        private void HandleCompanyInput(ChangeEventArgs e)
        {
            searchCompanyNameENGAsProfessorToFindCompany = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchCompanyNameENGAsProfessorToFindCompany) && searchCompanyNameENGAsProfessorToFindCompany.Length >= 2)
            {
                companyNameSuggestions = dbContext.Companies
                    .Where(c => c.CompanyNameENG.Contains(searchCompanyNameENGAsProfessorToFindCompany))
                    .Select(c => c.CompanyNameENG)
                    .Distinct()
                    .ToList();
            }
            else
            {
                companyNameSuggestions.Clear();
            }
        }


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        private List<string> companyNameSuggestionsAsRG = new List<string>();
        private void HandleCompanyInputAsRG(ChangeEventArgs e)
        {
            searchCompanyNameENGAsRGToFindCompany = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchCompanyNameENGAsRGToFindCompany) && searchCompanyNameENGAsRGToFindCompany.Length >= 2)
            {
                companyNameSuggestionsAsRG = dbContext.Companies
                    .Where(c => c.CompanyName.Contains(searchCompanyNameENGAsRGToFindCompany))
                    .Select(c => c.CompanyName)
                    .Distinct()
                    .ToList();
            }
            else
            {
                companyNameSuggestionsAsRG.Clear();
            }
        }

        private void SelectCompanyNameSuggestionAsRG(string suggestion)
        {
            searchCompanyNameENGAsRGToFindCompany = suggestion;
            companyNameSuggestionsAsRG.Clear();
        }
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        private async Task HandleAreasOfInterestInput_WhenSearchForCompanyAsProfessor(ChangeEventArgs e)
        {
            searchCompanyAreasAsProfessorToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfInterestSuggestions = new List<string>();

            if (searchCompanyAreasAsProfessorToFindCompany.Length >= 1)
            {
                try
                {
                    // Get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchCompanyAreasAsProfessorToFindCompany) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchCompanyAreasAsProfessorToFindCompany)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();
            
                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchCompanyAreasAsProfessorToFindCompany, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchCompanyAreasAsProfessorToFindCompany, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areasOfInterestSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error retrieving Areas of Interest from Database: {ex.Message}");
                    areasOfInterestSuggestions = new List<string>();
                }
            }
            else
            {
                areasOfInterestSuggestions.Clear();
            }

            StateHasChanged();
        }

        private async Task HandleAreasOfInterestInput_WhenSearchForCompanyAsRG(ChangeEventArgs e)
        {
            searchCompanyAreasAsRGToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfInterestSuggestions = new List<string>();

            if (searchCompanyAreasAsRGToFindCompany.Length >= 1)
            {
                try
                {
                    // Get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchCompanyAreasAsRGToFindCompany) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchCompanyAreasAsRGToFindCompany)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();
            
                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchCompanyAreasAsRGToFindCompany, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchCompanyAreasAsRGToFindCompany, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areasOfInterestSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error retrieving Areas of Interest from Database: {ex.Message}");
                    areasOfInterestSuggestions = new List<string>();
                }
            }
            else
            {
                areasOfInterestSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectAreasOfInterestSuggestion_WhenSearchForCompanyAsProfessor(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion))
            {
                selectedAreasOfInterest.Add(suggestion);
                searchCompanyAreasAsProfessorToFindCompany = suggestion;
                areasOfInterestSuggestions.Clear();
                StateHasChanged();
            }
        }

        private void SelectAreasOfInterestSuggestion_WhenSearchForCompanyAsRG(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion))
            {
                selectedAreasOfInterest.Add(suggestion);
                searchCompanyAreasAsRGToFindCompany = suggestion;
                areasOfInterestSuggestions.Clear();
                StateHasChanged();
            }
        }

        private void RemoveSelectedAreaOfInterest_WhenSearchForCompanyAsProfessor(string area)
        {
            selectedAreasOfInterest.Remove(area);
            StateHasChanged();
        }

        private void RemoveSelectedAreaOfInterest_WhenSearchForCompanyAsRG(string area)
        {
            selectedAreasOfInterest.Remove(area);
            StateHasChanged();
        }

        // Pagination variables for student search as Professor
        private int currentPage_StudentSearch = 1;
        private int StudentSearchPerPage = 10; // Default value

        // Total pages calculation
        private int totalPages_StudentSearch => 
            (int)Math.Ceiling((double)(searchResultsAsProfessorToFindStudent?.Count ?? 0) / StudentSearchPerPage);


        private void OnPageSizeChangeForStudentSearch(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                StudentSearchPerPage = newSize;
                currentPage_StudentSearch = 1; // Reset to first page
                StateHasChanged();
            }
        }

        private IEnumerable<Student> GetPaginatedStudentSearchResults()
        {
            return searchResultsAsProfessorToFindStudent?
                .Skip((currentPage_StudentSearch - 1) * StudentSearchPerPage)
                .Take(StudentSearchPerPage) ?? Enumerable.Empty<Student>();
        }

        private List<int> GetVisiblePages_StudentSearch()
        {
            var pages = new List<int>();
            int current = currentPage_StudentSearch;
            int total = totalPages_StudentSearch;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_StudentSearch()
        {
            currentPage_StudentSearch = 1;
            StateHasChanged();
        }

        private void GoToLastPage_StudentSearch()
        {
            currentPage_StudentSearch = totalPages_StudentSearch;
            StateHasChanged();
        }

        private void PreviousPage_StudentSearch()
        {
            if (currentPage_StudentSearch > 1)
            {
                currentPage_StudentSearch--;
                StateHasChanged();
            }
        }

        private void NextPage_StudentSearch()
        {
            if (currentPage_StudentSearch < totalPages_StudentSearch)
            {
                currentPage_StudentSearch++;
                StateHasChanged();
            }
        }

        private void GoToPage_StudentSearch(int page)
        {
            if (page > 0 && page <= totalPages_StudentSearch)
            {
                currentPage_StudentSearch = page;
                StateHasChanged();
            }
        }

        // Pagination variables for company search
        private int currentPage_CompanySearch = 1;
        private int CompanySearchPerPage = 10; // Default value
        // Total pages calculation
        private int totalPages_CompanySearch => 
            (int)Math.Ceiling((double)(searchResultsAsProfessorToFindCompany?.Count ?? 0) / CompanySearchPerPage);


        // Pagination variables for company search as Research Group
        private int currentPage_CompanySearchAsRG = 1;
        private int CompanySearchPerPageAsRG = 10; // Default value
        // Total pages calculation
        private int totalPages_CompanySearchAsRG => 
            (int)Math.Ceiling((double)(searchResultsAsRGToFindCompany?.Count ?? 0) / CompanySearchPerPageAsRG);



        private void OnPageSizeChangeForCompanySearch(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                CompanySearchPerPage = newSize;
                currentPage_CompanySearch = 1; // Reset to first page
                StateHasChanged();
            }
        }


        private IEnumerable<Company> GetPaginatedCompanySearchResults()
        {
            return searchResultsAsProfessorToFindCompany?
                .Skip((currentPage_CompanySearch - 1) * CompanySearchPerPage)
                .Take(CompanySearchPerPage) ?? Enumerable.Empty<Company>();
        }


        private List<int> GetVisiblePages_CompanySearch()
        {
            var pages = new List<int>();
            int current = currentPage_CompanySearch;
            int total = totalPages_CompanySearch;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }


        private void GoToFirstPage_CompanySearch()
        {
            currentPage_CompanySearch = 1;
            StateHasChanged();
        }

        private void GoToLastPage_CompanySearch()
        {
            currentPage_CompanySearch = totalPages_CompanySearch;
            StateHasChanged();
        }

        private void PreviousPage_CompanySearch()
        {
            if (currentPage_CompanySearch > 1)
            {
                currentPage_CompanySearch--;
                StateHasChanged();
            }
        }

        private void NextPage_CompanySearch()
        {
            if (currentPage_CompanySearch < totalPages_CompanySearch)
            {
                currentPage_CompanySearch++;
                StateHasChanged();
            }
        }

        private void GoToPage_CompanySearch(int page)
        {
            if (page > 0 && page <= totalPages_CompanySearch)
            {
                currentPage_CompanySearch = page;
                StateHasChanged();
            }
        }

    //////////////////////////////////////////////////////////////////////////////////////////////////
        private void OnPageSizeChangeForCompanySearchAsRG(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                CompanySearchPerPageAsRG = newSize;
                currentPage_CompanySearchAsRG = 1; // Reset to first page
                StateHasChanged();
            }
        }

        private IEnumerable<Company> GetPaginatedCompanySearchResultsAsRG()
        {
            return searchResultsAsRGToFindCompany?
                .Skip((currentPage_CompanySearchAsRG - 1) * CompanySearchPerPageAsRG)
                .Take(CompanySearchPerPageAsRG) ?? Enumerable.Empty<Company>();
        }
        ///
        private List<int> GetVisiblePages_CompanySearchAsRG()
        {
            var pages = new List<int>();
            int current = currentPage_CompanySearchAsRG;
            int total = totalPages_CompanySearchAsRG;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }


        private void GoToFirstPage_CompanySearchAsRG()
        {
            currentPage_CompanySearchAsRG = 1;
            StateHasChanged();
        }

        private void GoToLastPage_CompanySearchAsRG()
        {
            currentPage_CompanySearchAsRG = totalPages_CompanySearchAsRG;
            StateHasChanged();
        }

        private void PreviousPage_CompanySearchAsRG()
        {
            if (currentPage_CompanySearchAsRG > 1)
            {
                currentPage_CompanySearchAsRG--;
                StateHasChanged();
            }
        }

        private void NextPage_CompanySearchAsRG()
        {
            if (currentPage_CompanySearchAsRG < totalPages_CompanySearchAsRG)
            {
                currentPage_CompanySearchAsRG++;
                StateHasChanged();
            }
        }

        private void GoToPage_CompanySearchAsRG(int page)
        {
            if (page > 0 && page <= totalPages_CompanySearchAsRG)
            {
                currentPage_CompanySearchAsRG = page;
                StateHasChanged();
            }
        }
    //////////////////////////////////////////////////////////////////////////////////////////////////

        private AnnouncementAsProfessor? selectedProfessorAnnouncementToSeeDetails; 
        private void OpenProfessorAnnouncementDetailsModal(AnnouncementAsProfessor currentAnnouncement)
        {
            selectedProfessorAnnouncementToSeeDetails = currentAnnouncement;
        }

        private void CloseProfessorAnnouncementDetailsModal()
        {
            selectedProfessorAnnouncementToSeeDetails = null;
        }

        private async Task HandleProfessorThesisFileUpload(InputFileChangeEventArgs e)
        {
            var file = e.File;  // Access the selected file
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                // Ensure the file is a PDF (optional)
                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);  // Copy the file stream to memory stream
                            currentThesisAsProfessor.ThesisAttachment = memoryStream.ToArray();  // Store file as byte array
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }

        private bool showExpandedAreasInProfessorThesisEditModal = false;
        private bool showExpandedSkillsInProfessorThesisEditModal = false;
        private List<Area> SelectedAreasToEditForProfessorThesis = new List<Area>();
        private List<Skill> SelectedSkillsToEditForProfessorThesis = new List<Skill>();

        private void ToggleAreasInEditProfessorThesisModal() => 
            showExpandedAreasInProfessorThesisEditModal = !showExpandedAreasInProfessorThesisEditModal;

        private void ToggleSkillsInEditProfessorThesisModal() => 
            showExpandedSkillsInProfessorThesisEditModal = !showExpandedSkillsInProfessorThesisEditModal;

        private void OnCheckedChangedForEditProfessorThesisAreas(ChangeEventArgs e, Area area)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedAreasToEditForProfessorThesis.Any(a => a.AreaName == area.AreaName))
                    {
                        SelectedAreasToEditForProfessorThesis.Add(area);
                    }
                }
                else
                {
                    SelectedAreasToEditForProfessorThesis.RemoveAll(a => a.AreaName == area.AreaName);
                }
            
                // Update the thesis object immediately
                currentThesisAsProfessor.ThesisAreas = string.Join(",", SelectedAreasToEditForProfessorThesis.Select(a => a.AreaName));
            }
            StateHasChanged();
        }

        private void OnCheckedChangedForEditProfessorThesisSkills(ChangeEventArgs e, Skill skill)
        {
            if (e.Value is bool isChecked)
            {
                if (isChecked)
                {
                    if (!SelectedSkillsToEditForProfessorThesis.Any(s => s.SkillName == skill.SkillName))
                    {
                        SelectedSkillsToEditForProfessorThesis.Add(skill);
                    }
                }
                else
                {
                    SelectedSkillsToEditForProfessorThesis.RemoveAll(s => s.SkillName == skill.SkillName);
                }
            
                // Update the thesis object immediately
                currentThesisAsProfessor.ThesisSkills = string.Join(",", SelectedSkillsToEditForProfessorThesis.Select(s => s.SkillName));
            }
            StateHasChanged();
        }

        private void OpenUrl(string url)
        {
            if (!string.IsNullOrWhiteSpace(url))
            {
                if (!url.StartsWith("http://") && !url.StartsWith("https://"))
                {
                    url = "http://" + url;
                }
                NavigationManager.NavigateTo(url, true);
            }
        }

        private void OpenMap(string location)
        {
            if (!string.IsNullOrWhiteSpace(location))
            {
                var mapUrl = $"https://www.google.com/maps/search/{Uri.EscapeDataString(location)}";
                NavigationManager.NavigateTo(mapUrl, true);
            }
        }

        private async Task<IEnumerable<ProfessorInternshipApplied>> GetApplicantsForProfessorInternship(long professorInternshipRNG)
        {
            // Get the professor internship details with professor information
            var internship = await dbContext.ProfessorInternships
                .Include(i => i.Professor) // Include professor details
                .Where(i => i.RNGForInternshipUploadedAsProfessor == professorInternshipRNG) // Updated property
                .Select(i => new {
                    i.ProfessorInternshipTitle,
                    i.RNGForInternshipUploadedAsProfessor, // Updated property
                    ProfessorName = i.Professor.ProfName,
                    ProfessorSurname = i.Professor.ProfSurname
                })
                .FirstOrDefaultAsync();

            if (internship == null)
                return Enumerable.Empty<ProfessorInternshipApplied>();

            // Get all applications for this internship (matching by RNG)
            return await dbContext.ProfessorInternshipsApplied
                .Include(a => a.StudentDetails)
                .Include(a => a.ProfessorDetails)
                .Where(a => a.RNGForProfessorInternshipApplied == professorInternshipRNG)
                .ToListAsync();


        }

        private bool showExpandedAreasInProfessorInternshipEditModal = false;
        private List<Area> SelectedAreasToEditForProfessorInternship = new List<Area>();
        private bool showExpandedAreasInProfessorEventEditModal = false;
        // Method to close the edit popup
        private void CloseEditPopupForProfessorInternships()
        {
            isEditPopupVisibleForProfessorInternships = false;
        }

        private async Task SaveEditedProfessorInternship()
        {
            try
            {
                // Check if required fields are filled
                if (string.IsNullOrWhiteSpace(selectedProfessorInternship.ProfessorInternshipTitle) || 
                    string.IsNullOrWhiteSpace(selectedProfessorInternship.ProfessorInternshipDescription))
                {
                    showSuccessMessage = false;
                    showErrorMessage = true;
                    return;
                }

                // Set timeout for the database operation
                dbContext.Database.SetCommandTimeout(120); // 120 seconds timeout

                // Build areas and subfields string (same format as create)
                var areasWithSubfields = new List<string>();

                // Add selected areas
                foreach (var area in SelectedAreasToEditForProfessorInternship)
                {
                    areasWithSubfields.Add(area.AreaName);
                }

                // Add subfields
                foreach (var areaSubFields in SelectedSubFieldsForEditProfessorInternship)
                {
                    var subFields = areaSubFields.Value;
                    foreach (var subField in subFields)
                    {
                        areasWithSubfields.Add(subField);
                    }
                }

                // Convert to comma-separated string
                selectedProfessorInternship.ProfessorInternshipAreas = string.Join(",", areasWithSubfields);

                // Find and update the internship
                var internshipToUpdate = await dbContext.ProfessorInternships.FindAsync(selectedProfessorInternship.Id);
                if (internshipToUpdate != null)
                {
                    // Update properties from the edited copy
                    internshipToUpdate.ProfessorInternshipTitle = selectedProfessorInternship.ProfessorInternshipTitle;
                    internshipToUpdate.ProfessorInternshipDescription = selectedProfessorInternship.ProfessorInternshipDescription;
                    internshipToUpdate.ProfessorInternshipType = selectedProfessorInternship.ProfessorInternshipType;
                    internshipToUpdate.ProfessorInternshipForeas = selectedProfessorInternship.ProfessorInternshipForeas;
                    internshipToUpdate.ProfessorInternshipPerifereiaLocation = selectedProfessorInternship.ProfessorInternshipPerifereiaLocation;
                    internshipToUpdate.ProfessorInternshipDimosLocation = selectedProfessorInternship.ProfessorInternshipDimosLocation;
                    internshipToUpdate.ProfessorInternshipTransportOffer = selectedProfessorInternship.ProfessorInternshipTransportOffer;
                    internshipToUpdate.ProfessorInternshipAreas = selectedProfessorInternship.ProfessorInternshipAreas;
                    internshipToUpdate.ProfessorInternshipActivePeriod = selectedProfessorInternship.ProfessorInternshipActivePeriod;
                    internshipToUpdate.ProfessorInternshipFinishEstimation = selectedProfessorInternship.ProfessorInternshipFinishEstimation;
                    internshipToUpdate.ProfessorInternshipLastUpdate = DateTime.Now;
                    internshipToUpdate.OpenSlots_ProfessorInternship = selectedProfessorInternship.OpenSlots_ProfessorInternship;

                    // Handle file attachment separately with null check
                    if (selectedProfessorInternship.ProfessorInternshipAttachment != null && 
                        selectedProfessorInternship.ProfessorInternshipAttachment.Length > 0)
                    {
                        internshipToUpdate.ProfessorInternshipAttachment = selectedProfessorInternship.ProfessorInternshipAttachment;
                    }

                    // Save changes with try-catch
                    try
                    {
                        await dbContext.SaveChangesAsync();
                    
                        // Refresh the internships list to show updated data
                        await LoadProfessorInternships();
                    
                        showSuccessMessage = true;
                        showErrorMessage = false;
                    }
                    catch (Exception dbEx)
                    {
                        Console.Error.WriteLine($"Database save error: {dbEx.Message}");
                        showSuccessMessage = false;
                        showErrorMessage = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error in SaveEditedProfessorInternship: {ex.Message}");
                showSuccessMessage = false;
                showErrorMessage = true;
            }
            finally
            {
                isEditPopupVisibleForProfessorInternships = false;
                selectedProfessorInternship = null; // Clear the editing object
                StateHasChanged();
            }
        }

        private async Task HandleFileUploadToEditProfessorInternshipAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;  // Access the selected file
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                // Ensure the file is a PDF (optional)
                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);  // Copy the file stream to memory stream
                            selectedProfessorInternship.ProfessorInternshipAttachment = memoryStream.ToArray();  // Store file as byte array
                            Console.WriteLine($"File uploaded: {file.Name}");
                        
                            // Optional: Add user feedback
                            uploadSuccess = true;
                            uploadErrorMessage = string.Empty;
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                    uploadErrorMessage = "Μόνο αρχεία PDF επιτρέπονται";
                    uploadSuccess = false;
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
                uploadErrorMessage = "Δεν επιλέχθηκε αρχείο";
                uploadSuccess = false;
            }
            StateHasChanged(); // Update UI to show feedback
        }

        // Method to toggle areas visibility in edit modal
        private void ToggleAreasInEditProfessorInternshipModal()
        {
            showExpandedAreasInProfessorInternshipEditModal = !showExpandedAreasInProfessorInternshipEditModal;
        }

        // Method to handle area selection changes
        private void OnCheckedChangedForEditProfessorInternshipAreas(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForProfessorInternship.Any(a => a.Id == area.Id))
                {
                    SelectedAreasToEditForProfessorInternship.Add(area);
                }
            }
            else
            {
                var areaToRemove = SelectedAreasToEditForProfessorInternship.FirstOrDefault(a => a.Id == area.Id);
                if (areaToRemove != null)
                {
                    SelectedAreasToEditForProfessorInternship.Remove(areaToRemove);
                }
            }
        }

    
        private void ClearProfessorEventField(int fieldNumber)
        {
            switch (fieldNumber)
            {
                case 1:
                    currentProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent1 = string.Empty;
                    break;
                case 2:
                    currentProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent2 = string.Empty;
                    break;
                case 3:
                    currentProfessorEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent3 = string.Empty;
                    break;
            }
        }

        private void ToggleAreasInEditProfessorEventModal()
        {
            showExpandedAreasInProfessorEventEditModal = !showExpandedAreasInProfessorEventEditModal;
        }

        private void OnCheckedChangedForEditProfessorEventAreas(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForProfessorEvent.Any(a => a.Id == area.Id))
                {
                    SelectedAreasToEditForProfessorEvent.Add(area);
                }
            }
            else
            {
                var areaToRemove = SelectedAreasToEditForProfessorEvent.FirstOrDefault(a => a.Id == area.Id);
                if (areaToRemove != null)
                {
                    SelectedAreasToEditForProfessorEvent.Remove(areaToRemove);
                }
            }
        }

        private async Task HandleFileUploadToEditProfessorEventAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;
            if (file != null)
            {
                using (var stream = file.OpenReadStream())
                {
                    using (var memoryStream = new MemoryStream())
                    {
                        await stream.CopyToAsync(memoryStream);
                        currentProfessorEvent.ProfessorEventAttachmentFile = memoryStream.ToArray();
                    }
                }
            }
        }

        private List<InterestInProfessorEventAsCompany> InterestedCompaniesForProfessorEvent = new();
        private long? selectedEventIdForCompaniesWhenShowInterestForProfessorEvent;
        private bool isLoadingInterestedCompaniesForProfessorEvent = false;
        private long? loadingProfessorEventRNGForCompanies = null;
        private async Task ShowInterestedCompaniesInProfessorEvent(long professoreventRNG)
        {
            Console.WriteLine($"ShowInterestedCompaniesInProfessorEvent called for event: {professoreventRNG}");

            // If clicking the same event companies section that's already expanded, close it
            if (currentlyExpandedProfessorEventId == professoreventRNG && currentlyExpandedEventSectionType == "companies")
            {
                currentlyExpandedProfessorEventId = null;
                currentlyExpandedEventSectionType = null;
                selectedEventIdForCompaniesWhenShowInterestForProfessorEvent = null;
                filteredCompanyInterestForProfessorEvents.Clear();
                StateHasChanged();
                return;
            }

            // Close any previously expanded sections (both students and companies)
            if (currentlyExpandedProfessorEventId.HasValue)
            {
                // Close students section if open
                if (selectedEventIdForStudentsWhenShowInterestForProfessorEvent == currentlyExpandedProfessorEventId.Value)
                {
                    selectedEventIdForStudentsWhenShowInterestForProfessorEvent = null;
                    InterestedStudentsForProfessorEvent.Clear();
                    studentDataCache.Clear();
                }
            
                // Close companies section if open
                if (selectedEventIdForCompaniesWhenShowInterestForProfessorEvent == currentlyExpandedProfessorEventId.Value)
                {
                    selectedEventIdForCompaniesWhenShowInterestForProfessorEvent = null;
                    filteredCompanyInterestForProfessorEvents.Clear();
                }
            }

            // Set the new expanded event and section type
            currentlyExpandedProfessorEventId = professoreventRNG;
            currentlyExpandedEventSectionType = "companies";

            // Show loading state
            isLoadingInterestedCompaniesForProfessorEvent = true;
            loadingProfessorEventRNGForCompanies = professoreventRNG;
            StateHasChanged();

            try
            {
                // Show the table
                selectedEventIdForCompaniesWhenShowInterestForProfessorEvent = professoreventRNG;
                filteredCompanyInterestForProfessorEvents = await dbContext.InterestInProfessorEventsAsCompany
                    .Include(i => i.CompanyDetails)
                    .Where(x => x.RNGForProfessorEventInterestAsCompany == professoreventRNG)
                    .OrderByDescending(x => x.DateTimeCompanyShowInterestForProfessorEvent)
                    .ToListAsync();

                // Load company data for all interests
                foreach (var interest in filteredCompanyInterestForProfessorEvents)
                {
                    if (!companyDataCache.ContainsKey(interest.CompanyEmailShowInterestForProfessorEvent))
                    {
                        var company = await dbContext.Companies
                            .FirstOrDefaultAsync(c => c.CompanyEmail == interest.CompanyEmailShowInterestForProfessorEvent);
        
                        if (company != null)
                        {
                            companyDataCache[interest.CompanyEmailShowInterestForProfessorEvent] = company;
                        }
                    }
                }
            }
            finally
            {
                // Hide loading state
                isLoadingInterestedCompaniesForProfessorEvent = false;
                loadingProfessorEventRNGForCompanies = null;
                StateHasChanged();
            }
        }


        private bool showModalForCompaniesAtProfessorEventInterest = false;
        private InterestInProfessorEventAsCompany selectedCompanyToShowDetailsForInterestinProfessorEvent;

        private void ShowCompanyDetailsAtProfessorEventInterest(InterestInProfessorEventAsCompany company)
        {
            selectedCompanyToShowDetailsForInterestinProfessorEvent = company;
            showModalForCompaniesAtProfessorEventInterest = true;
            StateHasChanged();
        }

        private void CloseCompanyDetailsModalAtProfessorEventInterest()
        {
            showModalForCompaniesAtProfessorEventInterest = false;
            selectedCompanyToShowDetailsForInterestinProfessorEvent = null;
        }


        private async Task ToggleFormVisibilityToShowStudentStatsAsAdmin()
        {
            isStudentStatsFormVisibleToShowStudentStatsAsAdmin = !isStudentStatsFormVisibleToShowStudentStatsAsAdmin;
            StateHasChanged();
        }

        private Dictionary<string, int> areaDistribution = new();
        private Dictionary<string, int> skillDistributionforadmin = new();
        private void ToggleAnalyticsVisibility()
        {
            isAnalyticsVisible = !isAnalyticsVisible;
            if (isAnalyticsVisible)
            {
                LoadAnalyticsAsync();
            }
        }

        private async Task LoadAnalyticsAsync()
        {
            try
            {
                // 1. ISOLATE: Use a fresh context so this runs in parallel with other loaders
                using var context = DbFactory.CreateDbContext();

                // 2. FETCH: Query only the specific columns needed for analytics.
                // This is much faster than loading full Student objects.
                var rawData = await context.Students
                    .AsNoTracking()
                    .Where(s => s.AreasOfExpertise != null || s.Keywords != null)
                    .Select(s => new { s.AreasOfExpertise, s.Keywords })
                    .ToListAsync();

                // 3. PROCESS: Perform string splitting and counting on a local variable first.
                // This prevents half-finished data from flickering on the UI.
                var tempAreaDist = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
                var tempSkillDist = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

                foreach (var item in rawData)
                {
                    // Process Areas
                    if (!string.IsNullOrWhiteSpace(item.AreasOfExpertise))
                    {
                        var areas = item.AreasOfExpertise.Split(',', StringSplitOptions.RemoveEmptyEntries);
                        foreach (var area in areas)
                        {
                            var trimmed = area.Trim();
                            if (tempAreaDist.ContainsKey(trimmed))
                                tempAreaDist[trimmed]++;
                            else
                                tempAreaDist[trimmed] = 1;
                        }
                    }

                    // Process Skills
                    if (!string.IsNullOrWhiteSpace(item.Keywords))
                    {
                        var skills = item.Keywords.Split(',', StringSplitOptions.RemoveEmptyEntries);
                        foreach (var skill in skills)
                        {
                            var trimmed = skill.Trim();
                            if (tempSkillDist.ContainsKey(trimmed))
                                tempSkillDist[trimmed]++;
                            else
                                tempSkillDist[trimmed] = 1;
                        }
                    }
                }

                // 4. UPDATE: Assign the fully calculated dictionaries to the class variables
                areaDistribution = tempAreaDist;
                skillDistributionforadmin = tempSkillDist;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading analytics: {ex.Message}");
            }
        }



        private async Task LoadStudentsWithAuth0DetailsAsync()
        {
            try
            {
                // 1. ISOLATE: Create a fresh context for parallel execution
                using var context = DbFactory.CreateDbContext();

                // 2. FETCH: Get local students (Fast read-only)
                var students = await context.Students.AsNoTracking().ToListAsync();
            
                if (!students.Any())
                {
                    StudentsWithAuth0Details = new List<StudentWithAuth0Details>();
                    return;
                }

                // 3. BATCH FETCH: Get Auth0 Data efficiently
                // This makes ~4 API calls for 100 students instead of 100 calls.
                var auth0UsersDict = await FetchAuth0UsersInBatches(students.Select(s => s.Email).ToList());

                // 4. MAP: Merge Local DB data with Auth0 Data
                var results = new List<StudentWithAuth0Details>(students.Count);

                foreach (var student in students)
                {
                    // Find Auth0 data in our dictionary (or null if not found)
                    var auth0User = auth0UsersDict.GetValueOrDefault(student.Email);

                    results.Add(new StudentWithAuth0Details
                    {
                        // -- Local Data --
                        Name = student.Name,
                        Surname = student.Surname,
                        Email = student.Email,
                        Department = student.Department,
                        School = student.School,
                        AreasOfExpertise = student.AreasOfExpertise,
                        Keywords = student.Keywords,

                        // -- Auth0 Data --
                        SignUpDate = auth0User?.CreatedAt,
                        LatestLogin = auth0User?.LastLogin,
                        LoginTimes = auth0User?.LoginsCount?.ToString(),
                        LastIp = auth0User?.LastIpAddress,
                        IsEmailVerified = auth0User?.EmailVerified,
                    
                        // Note: Browser info requires a separate "Log" API call per user, which is too slow for lists.
                        // We set defaults here to keep loading fast.
                        LoginBrowser = "N/A", 
                        IsMobile = false, 
                        LocationInfo = null 
                    });
                }

                StudentsWithAuth0Details = results;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading students with Auth0 details: {ex.Message}");
            }
        }

        // --- HELPER METHOD (Paste this right below the method above) ---

        private async Task<Dictionary<string, Auth0User>> FetchAuth0UsersInBatches(List<string> emails)
        {
            var result = new Dictionary<string, Auth0User>(StringComparer.OrdinalIgnoreCase);
        
            // Batch size of 25 is safe for URL length limits in Lucene queries
            const int batchSize = 25; 
            var batches = emails.Chunk(batchSize);
        
            // Use a Semaphore to prevent hitting Auth0 Rate Limits (Too Many Requests)
            var semaphore = new SemaphoreSlim(5); 

            var tasks = batches.Select(async batch => 
            {
                await semaphore.WaitAsync();
                try
                {
                    // Build Query: email:"bob@test.com" OR email:"alice@test.com"
                    var query = string.Join(" OR ", batch.Select(e => $"email:\"{e}\""));
                
                    // Call the new service method
                    var users = await Auth0Service.GetUsersByQueryAsync(query);
                
                    // Lock the dictionary to safely add results from multiple threads
                    lock (result)
                    {
                        foreach (var u in users)
                        {
                            // Ensure the user object has the Email property populated or mapped correctly
                            if (!string.IsNullOrEmpty(u.Email) && !result.ContainsKey(u.Email))
                            {
                                result[u.Email] = u;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Batch Auth0 fetch warning: {ex.Message}");
                }
                finally
                {
                    semaphore.Release();
                }
            });

            await Task.WhenAll(tasks);
            return result;
        }

        private async Task<CompanyJob> GetJobDetails(long rngForJob)
        {
            return await dbContext.CompanyJobs
                .FirstOrDefaultAsync(j => j.RNGForPositionUploaded == rngForJob);
        }

        private async Task LoadCompanyJobData()
        {
            try
            {
                // 1. ISOLATE: Create a fresh context for parallel execution
                using var context = DbFactory.CreateDbContext();

                // 2. DECOUPLE: Instead of waiting for the 'jobApplications' list to be populated in memory,
                // we query the database directly to find which Jobs have applications.
                // This allows this method to start immediately without waiting for other methods.
                var rngsToLoad = await context.CompanyJobsApplied
                    .AsNoTracking()
                    .Select(a => a.RNGForCompanyJobApplied) // Selecting the Job IDs
                    .Distinct()
                    .ToListAsync();

                // Filter out IDs we already have in the cache
                // (Fast in-memory operation)
                var missingRngs = rngsToLoad
                    .Where(rng => !jobDataCache.ContainsKey(rng))
                    .ToList();

                if (missingRngs.Any())
                {
                    // 3. LOAD: Fetch only the missing job entities
                    var jobs = await context.CompanyJobs
                        .AsNoTracking()
                        .Where(j => missingRngs.Contains(j.RNGForPositionUploaded))
                        .ToListAsync();

                    // 4. CACHE: Update the dictionary
                    foreach (var job in jobs)
                    {
                        jobDataCache[job.RNGForPositionUploaded] = job;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading job data: {ex.Message}");
            }
        }

        private async Task LoadAllStudentData()
        {
            try
            {
                // 1. ISOLATE: Use a fresh context so this can run in parallel
                using var context = DbFactory.CreateDbContext();

                // 2. DECOUPLE: Fetch unique emails directly from DB instead of waiting for 'jobApplicantsMap'
                // This breaks the dependency chain so this task doesn't have to wait.
                var studentEmails = await context.CompanyJobsApplied
                    .AsNoTracking() // Faster read-only query
                    .Select(a => a.StudentEmailAppliedForCompanyJob)
                    .Distinct()
                    .ToListAsync();

                if (studentEmails.Count == 0) return;

                // 3. LOAD: Fetch the actual student objects
                // EF Core automatically batches the 'Contains' into an optimized SQL 'IN' clause
                var students = await context.Students
                    .AsNoTracking() // Significant speed boost for read-only lists
                    .Where(s => studentEmails.Contains(s.Email))
                    .ToListAsync();

                // 4. CACHE: Update the dictionary
                // Note: Since this runs in parallel, ensure studentDataCache is thread-safe 
                // (e.g., use ConcurrentDictionary or lock) if other methods write to it simultaneously.
                // If this is the only writer, standard Dictionary is fine.
                foreach (var student in students)
                {
                    studentDataCache[student.Email] = student;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading student data: {ex.Message}");
            }
        }

        // Call this when new applications are added
        public async Task RefreshStudentData()
        {
            await LoadAllStudentData();
            StateHasChanged();
        }

        private string GetStatusColor(string status)
        {
            return status switch
            {
                "Επιτυχής" => "lightgreen",
                "Απορρίφθηκε" => "lightcoral",
                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)" => "coral",
                "Αποσύρθηκε από τον φοιτητή" => "lightyellow",
                _ => "transparent"
            };
        }

        private async Task HandleProfessorDateChange(ChangeEventArgs e)
        {
            if (DateTime.TryParse(e.Value?.ToString(), out DateTime newDate))
            {
                professorEvent.ProfessorEventActiveDate = newDate;
                await CheckExistingEventsForProfessorDate(); // You'll need to create this method
            }
        }

        private bool hasExistingEventsOnSelectedDateForProfessor = false;
        private async Task CheckExistingEventsForProfessorDate()
        {
            if (professorEvent.ProfessorEventActiveDate.Date >= DateTime.Today.Date)
            {
                // Check for existing company events on this date
                var companyEventsCount = await dbContext.CompanyEvents
                    .CountAsync(e => e.CompanyEventActiveDate.Date == professorEvent.ProfessorEventActiveDate.Date && 
                                    e.CompanyEventStatus == "Δημοσιευμένη");
            
                // Check for existing professor events on this date
                var professorEventsCount = await dbContext.ProfessorEvents
                    .CountAsync(e => e.ProfessorEventActiveDate.Date == professorEvent.ProfessorEventActiveDate.Date && 
                                    e.ProfessorEventStatus == "Δημοσιευμένη");
            
                existingEventsCountToCheckAsProfessor = companyEventsCount + professorEventsCount;
                hasExistingEventsOnSelectedDateForProfessor = existingEventsCountToCheckAsProfessor > 0;
            }
            else
            {
                hasExistingEventsOnSelectedDateForProfessor = false;
                existingEventsCountToCheckAsProfessor = 0;
            }
        
            StateHasChanged();
        }

        private int? numberOfIpodomes;
        private bool showIpodomesModal = false;
        private List<ResearchGroup_Ipodomes> ipodomesDetails = new();
        private async Task LoadResearchGroupStatistics()
        {
            try
            {
                if (currentResearchGroup == null)
                {
                    await LoadCurrentResearchGroup();
                }

                var currentResearchGroupEmail = CurrentUserEmail;

                // Get faculty members count
                numberOfFacultyMembers = await dbContext.ResearchGroup_Professors
                    .Where(rp => rp.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .CountAsync();

                // Get collaborators count (non-faculty members/students)
                numberOfCollaborators = await dbContext.ResearchGroup_NonFacultyMembers
                    .Where(rnf => rnf.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .CountAsync();

                // Get research actions count
                numberOfActiveResearchActions = await dbContext.ResearchGroup_ResearchActions
                    .Where(ra => ra.ResearchGroupEmail == currentResearchGroupEmail && 
                                ra.ResearchGroup_ProjectStatus == "OnGoing")
                    .CountAsync();

                numberOfInactiveResearchActions = await dbContext.ResearchGroup_ResearchActions
                    .Where(ra => ra.ResearchGroupEmail == currentResearchGroupEmail && 
                                ra.ResearchGroup_ProjectStatus == "Past")
                    .CountAsync();

                // Get patents count
                numberOfActivePatents = await dbContext.ResearchGroup_Patents
                    .Where(p => p.ResearchGroupEmail == currentResearchGroupEmail && 
                            p.ResearchGroup_Patent_PatentStatus == "Ενεργή")
                    .CountAsync();

                numberOfInactivePatents = await dbContext.ResearchGroup_Patents
                    .Where(p => p.ResearchGroupEmail == currentResearchGroupEmail && 
                            p.ResearchGroup_Patent_PatentStatus == "Ανενεργή")
                    .CountAsync();

                    numberOfIpodomes = await dbContext.ResearchGroup_Ipodomes
                    .Where(i => i.ResearchGroupEmail == currentResearchGroupEmail)
                    .CountAsync();

                // Fetch publications from Google Scholar for all members
                await FetchPublicationsFromGoogleScholar();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading statistics: {ex.Message}");
            }
        }

        private async Task ShowIpodomesDetails()
        {
            var currentResearchGroupEmail = CurrentUserEmail;

            // Fetch detailed list
            ipodomesDetails = await dbContext.ResearchGroup_Ipodomes
                .Where(i => i.ResearchGroupEmail == currentResearchGroupEmail)
                .AsNoTracking()
                .ToListAsync();

            showIpodomesModal = true;
        }

        private void CloseIpodomesModal()
        {
            showIpodomesModal = false;
        }

        private async Task FetchPublicationsFromGoogleScholar()
        {
            try
            {
                var currentResearchGroupEmail = CurrentUserEmail;
            
                // Get all professor emails in this research group with Google Scholar profiles
                var professorEmails = await dbContext.ResearchGroup_Professors
                    .Where(rp => rp.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .Select(rp => rp.PK_ProfessorEmail)
                    .ToListAsync();
            
                var professorsWithScholar = await dbContext.Professors
                    .Where(p => professorEmails.Contains(p.ProfEmail) && 
                            !string.IsNullOrEmpty(p.ProfScholarProfile))
                    .Select(p => new { p.ProfEmail, p.ProfScholarProfile })
                    .ToListAsync();
            
                // Get all student emails in this research group with Google Scholar profiles
                var studentEmails = await dbContext.ResearchGroup_NonFacultyMembers
                    .Where(rnf => rnf.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .Select(rnf => rnf.PK_NonFacultyMemberEmail)
                    .ToListAsync();
            
                var studentsWithScholar = await dbContext.Students
                    .Where(s => studentEmails.Contains(s.Email) && 
                            !string.IsNullOrEmpty(s.StudentGoogleScholarProfile))
                    .Select(s => new { s.Email, s.StudentGoogleScholarProfile })
                    .ToListAsync();
            
                // Combine all members with Google Scholar profiles
                var allMembersWithScholar = professorsWithScholar
                    .Select(p => new { Email = p.ProfEmail, ScholarProfile = p.ProfScholarProfile, Type = "Professor" })
                    .Concat(studentsWithScholar
                        .Select(s => new { Email = s.Email, ScholarProfile = s.StudentGoogleScholarProfile, Type = "Student" }))
                    .ToList();
            
                Console.WriteLine($"Found {allMembersWithScholar.Count} members with Google Scholar profiles");
            
                // Fetch publications for each member
                var allPublications = new List<ScholarPublication>();
                var fiveYearsAgo = DateTime.Now.AddYears(-5).Year;
            
                foreach (var member in allMembersWithScholar)
                {
                    try
                    {
                        Console.WriteLine($"Fetching publications for {member.Email} from {member.ScholarProfile}");
                        var publications = await _googleScholarService.GetPublications(member.ScholarProfile);
                        Console.WriteLine($"Found {publications.Count} publications for {member.Email}");
                    
                        allPublications.AddRange(publications);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error fetching publications for {member.Email}: {ex.Message}");
                    }
                }
            
                // Update statistics
                numberOfTotalPublications = allPublications.Count;
                numberOfRecentPublications = allPublications
                    .Where(p => !string.IsNullOrEmpty(p.Year) && 
                            int.TryParse(p.Year, out int year) && 
                            year >= fiveYearsAgo)
                    .Count();
            
                Console.WriteLine($"Total publications: {numberOfTotalPublications}, Recent publications: {numberOfRecentPublications}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in FetchPublicationsForStatistics: {ex.Message}");
                // Set publications to 0 if fetching fails
                numberOfTotalPublications = 0;
                numberOfRecentPublications = 0;
            }
        }

        // Add these fields to your component
        private bool showFacultyMembersModal = false;
        private bool showNonFacultyMembersModal = false;
        private List<FacultyMemberDetail> facultyMembersDetails = new();
        private List<NonFacultyMemberDetail> nonFacultyMembersDetails = new();

        // Add these classes for the modal data
        public class FacultyMemberDetail
        {
            public byte[]? Image { get; set; }
            public string Name { get; set; } = string.Empty;
            public string Surname { get; set; } = string.Empty;
            public string School { get; set; } = string.Empty;
            public string Department { get; set; } = string.Empty;
            public string Role { get; set; } = string.Empty;
        }

        public class NonFacultyMemberDetail
        {
            public byte[]? Image { get; set; }
            public string Name { get; set; } = string.Empty;
            public string Surname { get; set; } = string.Empty;
            public string LevelOfStudies { get; set; } = string.Empty;
            public string Department { get; set; } = string.Empty;
            public string School { get; set; } = string.Empty;
            public DateTime RegistrationDate { get; set; }
        }

        // Add these methods
        private async Task ShowFacultyMembersDetails()
        {
            try
            {
                var currentResearchGroupEmail = CurrentUserEmail;
            
                // Get faculty members with their details
                facultyMembersDetails = await dbContext.ResearchGroup_Professors
                    .Where(rp => rp.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .Join(dbContext.Professors,
                        rp => rp.PK_ProfessorEmail,
                        p => p.ProfEmail,
                        (rp, p) => new FacultyMemberDetail
                        {
                            Image = p.ProfImage,
                            Name = p.ProfName ?? "",
                            Surname = p.ProfSurname ?? "",
                            School = p.ProfSchool ?? "",
                            Department = p.ProfDepartment ?? "",
                            Role = rp.PK_ProfessorRole ?? ""
                        })
                    .ToListAsync();
            
                showFacultyMembersModal = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading faculty members details: {ex.Message}");
            }
        }

        private async Task ShowNonFacultyMembersDetails()
        {
            try
            {
                var currentResearchGroupEmail = CurrentUserEmail;
            
                // Get non-faculty members with their details
                nonFacultyMembersDetails = await dbContext.ResearchGroup_NonFacultyMembers
                    .Where(rnf => rnf.PK_ResearchGroupEmail == currentResearchGroupEmail)
                    .Join(dbContext.Students,
                        rnf => rnf.PK_NonFacultyMemberEmail,
                        s => s.Email,
                        (rnf, s) => new NonFacultyMemberDetail
                        {
                            Image = s.Image,
                            Name = s.Name,
                            Surname = s.Surname,
                            LevelOfStudies = rnf.PK_NonFacultyMemberLevelOfStudies ?? "",
                            Department = s.Department,
                            School = s.School,
                            RegistrationDate = rnf.DateOfRegistrationOnResearchGroup_ForNonFacultyMember
                        })
                    .ToListAsync();
            
                showNonFacultyMembersModal = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading non-faculty members details: {ex.Message}");
            }
        }

        private void CloseFacultyMembersModal()
        {
            showFacultyMembersModal = false;
            StateHasChanged();
        }

        private void CloseNonFacultyMembersModal()
        {
            showNonFacultyMembersModal = false;
            StateHasChanged();
        }

        private bool showResearchActionsModal = false;
        private List<ResearchActionDetail> researchActionsDetails = new();
        public class ResearchActionDetail
        {
            public string ProjectTitle { get; set; } = string.Empty;
            public string ProjectAcronym { get; set; } = string.Empty;
            public string GrantAgreementNumber { get; set; } = string.Empty;
            public DateTime? StartDate { get; set; }
            public DateTime? EndDate { get; set; }
            public string ProjectCoordinator { get; set; } = string.Empty;
            public string ELKECode { get; set; } = string.Empty;
            public string ScientificResponsibleEmail { get; set; } = string.Empty;
            public string ProjectStatus { get; set; } = string.Empty; // Use the actual status field
        }

        private async Task ShowResearchActionsDetails()
        {
            try
            {
                var currentResearchGroupEmail = CurrentUserEmail;
            
                // Get research actions with their details
                researchActionsDetails = await dbContext.ResearchGroup_ResearchActions
                    .Where(ra => ra.ResearchGroupEmail == currentResearchGroupEmail)
                    .Select(ra => new ResearchActionDetail
                    {
                        ProjectTitle = ra.ResearchGroup_ProjectTitle ?? "",
                        ProjectAcronym = ra.ResearchGroup_ProjectAcronym ?? "",
                        GrantAgreementNumber = ra.ResearchGroup_ProjectGrantAgreementNumber ?? "",
                        StartDate = ra.ResearchGroup_ProjectStartDate,
                        EndDate = ra.ResearchGroup_ProjectEndDate,
                        ProjectCoordinator = ra.ResearchGroup_ProjectCoordinator ?? "",
                        ELKECode = ra.ResearchGroup_ProjectELKECode ?? "",
                        ScientificResponsibleEmail = ra.ResearchGroup_ProjectScientificResponsibleEmail ?? "",
                        ProjectStatus = ra.ResearchGroup_ProjectStatus ?? "" 
                    })
                    .ToListAsync();
            
                showResearchActionsModal = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading research actions details: {ex.Message}");
            }
        }

        private void CloseResearchActionsModal()
        {
            showResearchActionsModal = false;
            StateHasChanged();
        }

        private bool showPatentsModal = false;
        private List<PatentDetail> patentsDetails = new();
        public class PatentDetail
        {
            public string PatentTitle { get; set; } = string.Empty;
            public string PatentType { get; set; } = string.Empty;
            public string PatentDOI { get; set; } = string.Empty;
            public string PatentURL { get; set; } = string.Empty;
            public string PatentDescription { get; set; } = string.Empty;
            public string PatentStatus { get; set; } = string.Empty;
        }


        private async Task ShowPatentsDetails()
        {
            try
            {
                var currentResearchGroupEmail = CurrentUserEmail;
            
                patentsDetails = await dbContext.ResearchGroup_Patents
                    .Where(p => p.ResearchGroupEmail == currentResearchGroupEmail)
                    .Select(p => new PatentDetail
                    {
                        PatentTitle = p.ResearchGroup_Patent_PatentTitle ?? "",
                        PatentType = p.ResearchGroup_Patent_PatentType ?? "",
                        PatentDOI = p.ResearchGroup_Patent_PatentDOI ?? "",
                        PatentURL = p.ResearchGroup_Patent_PatentURL ?? "",
                        PatentDescription = p.ResearchGroup_Patent_PatentDescription ?? "",
                        PatentStatus = p.ResearchGroup_Patent_PatentStatus ?? ""
                    })
                    .ToListAsync();
            
                showPatentsModal = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading patents details: {ex.Message}");
            }
        }

        private void ClosePatentsModal()
        {
            showPatentsModal = false;
            StateHasChanged();
        }


        // Methods for handling inputs and selections
        private async Task HandleResearchGroupNameInput(ChangeEventArgs e)
        {
            searchResearchGroupNameAsCompanyToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            researchgroupNameSuggestions = new List<string>();

            if (searchResearchGroupNameAsCompanyToFindResearchGroup.Length >= 1)
            {
                try
                {
                    researchgroupNameSuggestions = await Task.Run(() =>
                        dbContext.ResearchGroups
                            .Where(rg => rg.ResearchGroupName.Contains(searchResearchGroupNameAsCompanyToFindResearchGroup))
                            .Select(rg => rg.ResearchGroupName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Ονομάτων Ερευνητικών Ομάδων: {ex.Message}");
                    researchgroupNameSuggestions = new List<string>();
                }
            }
            else
            {
                researchgroupNameSuggestions.Clear();
            }

            StateHasChanged();
        }

        private async Task HandleResearchGroupAreasInput(ChangeEventArgs e)
        {
            searchResearchGroupAreasAsCompanyToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            researchGroupAreasSuggestions = new List<string>();

            if (searchResearchGroupAreasAsCompanyToFindResearchGroup.Length >= 1)
            {
                try
                {
                    // Get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchResearchGroupAreasAsCompanyToFindResearchGroup) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchResearchGroupAreasAsCompanyToFindResearchGroup)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();
            
                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchResearchGroupAreasAsCompanyToFindResearchGroup, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchResearchGroupAreasAsCompanyToFindResearchGroup, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    researchGroupAreasSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Περιοχών Έρευνας: {ex.Message}");
                    researchGroupAreasSuggestions = new List<string>();
                }
            }
            else
            {
                researchGroupAreasSuggestions.Clear();
            }

            StateHasChanged();
        }

        private async Task HandleResearchGroupSkillsInput(ChangeEventArgs e)
        {
            searchResearchGroupSkillsAsCompanyToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            researchGroupSkillsSuggestions = new List<string>();

            if (searchResearchGroupSkillsAsCompanyToFindResearchGroup.Length >= 1)
            {
                try
                {
                    // Use the Skills table instead of parsing from ResearchGroups
                    researchGroupSkillsSuggestions = await dbContext.Skills
                        .Where(s => s.SkillName.Contains(searchResearchGroupSkillsAsCompanyToFindResearchGroup))
                        .Select(s => s.SkillName)
                        .Distinct()
                        .Take(10)
                        .ToListAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Τεχνολογιών: {ex.Message}");
                    researchGroupSkillsSuggestions = new List<string>();
                }
            }
            else
            {
                researchGroupSkillsSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void HandleResearchGroupSkillsKeyDown(KeyboardEventArgs e)
        {
            if (e.Key == "Enter" || e.Key == "Tab")
            {
                // Add manual text as a selected skill on Enter/Tab
                if (!string.IsNullOrWhiteSpace(searchResearchGroupSkillsAsCompanyToFindResearchGroup) &&
                    !selectedResearchGroupSkills.Contains(searchResearchGroupSkillsAsCompanyToFindResearchGroup))
                {
                    selectedResearchGroupSkills.Add(searchResearchGroupSkillsAsCompanyToFindResearchGroup);
                    searchResearchGroupSkillsAsCompanyToFindResearchGroup = string.Empty;
                    researchGroupSkillsSuggestions.Clear();
                }
            }
        }



        private async Task HandleResearchGroupKeywordsInput(ChangeEventArgs e)
        {
            searchResearchGroupKeywordsAsCompanyToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            researchGroupKeywordsSuggestions = new List<string>();

            if (searchResearchGroupKeywordsAsCompanyToFindResearchGroup.Length >= 1)
            {
                try
                {
                    // First fetch all research groups from the database
                    var allResearchGroups = await dbContext.ResearchGroups.ToListAsync();
                
                    // Then perform the split operation on the client side
                    researchGroupKeywordsSuggestions = allResearchGroups
                        .SelectMany(rg => rg.ResearchGroupKeywords.Split(',', StringSplitOptions.RemoveEmptyEntries))
                        .Select(keyword => keyword.Trim())
                        .Where(keyword => keyword.Contains(searchResearchGroupKeywordsAsCompanyToFindResearchGroup, StringComparison.OrdinalIgnoreCase))
                        .Distinct()
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Λέξεων Κλειδιών: {ex.Message}");
                    researchGroupKeywordsSuggestions = new List<string>();
                }
            }
            else
            {
                researchGroupKeywordsSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectResearchGroupNameSuggestion(string suggestion)
        {
            searchResearchGroupNameAsCompanyToFindResearchGroup = suggestion;
            researchgroupNameSuggestions.Clear();
        }

        private void SelectResearchGroupAreasSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedResearchGroupAreas.Contains(suggestion))
            {
                selectedResearchGroupAreas.Add(suggestion);
                researchGroupAreasSuggestions.Clear();
                searchResearchGroupAreasAsCompanyToFindResearchGroup = string.Empty;
            }
        }

        private void SelectResearchGroupSkillsSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedResearchGroupSkills.Contains(suggestion))
            {
                selectedResearchGroupSkills.Add(suggestion);
                researchGroupSkillsSuggestions.Clear();
                searchResearchGroupSkillsAsCompanyToFindResearchGroup = string.Empty;
            }
        }

        private void SelectResearchGroupKeywordsSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedResearchGroupKeywords.Contains(suggestion))
            {
                selectedResearchGroupKeywords.Add(suggestion);
                researchGroupKeywordsSuggestions.Clear();
                searchResearchGroupKeywordsAsCompanyToFindResearchGroup = string.Empty;
            }
        }

        private void RemoveSelectedResearchGroupArea(string area)
        {
            selectedResearchGroupAreas.Remove(area);
            StateHasChanged();
        }

        private void RemoveSelectedResearchGroupSkill(string skill)
        {
            selectedResearchGroupSkills.Remove(skill);
            StateHasChanged();
        }

        private void RemoveSelectedResearchGroupKeyword(string keyword)
        {
            selectedResearchGroupKeywords.Remove(keyword);
            StateHasChanged();
        }

        private async Task SearchResearchGroupsAsCompany()
        {
            try
            {
                hasSearchedForResearchGroups = true;
        
                // First get all research groups from the database
                var allResearchGroups = await dbContext.ResearchGroups.ToListAsync();
        
                // Then filter on the client side
                var filteredResearchGroups = allResearchGroups.AsEnumerable();

                if (!string.IsNullOrEmpty(searchResearchGroupNameAsCompanyToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupName.Contains(searchResearchGroupNameAsCompanyToFindResearchGroup, StringComparison.OrdinalIgnoreCase));
                }

                if (!string.IsNullOrEmpty(searchResearchGroupSchoolAsCompanyToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupSchool == searchResearchGroupSchoolAsCompanyToFindResearchGroup);
                }

                if (!string.IsNullOrEmpty(searchResearchGroupUniversityDepartmentAsCompanyToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupUniversityDepartment == searchResearchGroupUniversityDepartmentAsCompanyToFindResearchGroup);
                }

                // UPDATED AREAS FILTER: Support both selected areas AND manual text input
                if (selectedResearchGroupAreas.Any() || !string.IsNullOrEmpty(searchResearchGroupAreasAsCompanyToFindResearchGroup))
                {
                    // Create a combined list of search terms
                    var areaSearchTerms = new List<string>();

                    // Add manually typed text (if any)
                    if (!string.IsNullOrEmpty(searchResearchGroupAreasAsCompanyToFindResearchGroup))
                    {
                        areaSearchTerms.Add(searchResearchGroupAreasAsCompanyToFindResearchGroup.Trim());
                    }

                    // Add selected areas from dropdown
                    areaSearchTerms.AddRange(selectedResearchGroupAreas);

                    // Remove duplicates and empty entries
                    areaSearchTerms = areaSearchTerms.Where(a => !string.IsNullOrWhiteSpace(a)).Distinct().ToList();

                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => areaSearchTerms.Any(area => 
                        {
                            var researchGroupAreas = rg.ResearchGroupAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(a => a.Trim())
                                .ToList();

                            // Check if any research group area contains the search term
                            return researchGroupAreas.Any(researchArea => 
                                researchArea.Contains(area, StringComparison.OrdinalIgnoreCase) ||
                                area.Contains(researchArea, StringComparison.OrdinalIgnoreCase));
                        }));
                }

                // UPDATED SKILLS FILTER: Support both selected skills AND manual text input
                if (selectedResearchGroupSkills.Any() || !string.IsNullOrEmpty(searchResearchGroupSkillsAsCompanyToFindResearchGroup))
                {
                    // Create a combined list of search terms
                    var skillSearchTerms = new List<string>();
                
                    // Add manually typed text (if any)
                    if (!string.IsNullOrEmpty(searchResearchGroupSkillsAsCompanyToFindResearchGroup))
                    {
                        skillSearchTerms.Add(searchResearchGroupSkillsAsCompanyToFindResearchGroup.Trim());
                    }
                
                    // Add selected skills from dropdown
                    skillSearchTerms.AddRange(selectedResearchGroupSkills);
                
                    // Remove duplicates and empty entries
                    skillSearchTerms = skillSearchTerms.Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().ToList();

                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => skillSearchTerms.Any(skill => 
                            rg.ResearchGroupSkills.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(s => s.Trim())
                                .Any(s => s.Contains(skill, StringComparison.OrdinalIgnoreCase))
                        ));
                }

                // UPDATED KEYWORDS FILTER: Simple text search (no suggestions/selection)
                if (!string.IsNullOrEmpty(searchResearchGroupKeywordsAsCompanyToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupKeywords != null && 
                                    rg.ResearchGroupKeywords.Contains(searchResearchGroupKeywordsAsCompanyToFindResearchGroup, StringComparison.OrdinalIgnoreCase));
                }

                searchResultsAsCompanyToFindResearchGroup = filteredResearchGroups.ToList();
                currentResearchGroupPage_SearchForResearchGroupsAsCompany = 1;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Πρόβλημα στην Αναζήτηση Ερευνητικών Ομάδων: {ex.Message}");
                searchResultsAsCompanyToFindResearchGroup = new List<ResearchGroup>();
            }

            StateHasChanged();
        }

        private void HandleResearchGroupAreasKeyDown(KeyboardEventArgs e)
        {
            if (e.Key == "Enter" || e.Key == "Tab")
            {
                if (!string.IsNullOrWhiteSpace(searchResearchGroupAreasAsCompanyToFindResearchGroup) &&
                    !selectedResearchGroupAreas.Contains(searchResearchGroupAreasAsCompanyToFindResearchGroup))
                {
                    selectedResearchGroupAreas.Add(searchResearchGroupAreasAsCompanyToFindResearchGroup);
                    searchResearchGroupAreasAsCompanyToFindResearchGroup = string.Empty;
                    researchGroupAreasSuggestions.Clear();
                }
            }
        }

        private void ClearSearchFieldsAsCompanyToFindResearchGroup()
        {
            searchResearchGroupNameAsCompanyToFindResearchGroup = "";
            searchResearchGroupSchoolAsCompanyToFindResearchGroup = "";
            searchResearchGroupUniversityDepartmentAsCompanyToFindResearchGroup = "";
            searchResearchGroupAreasAsCompanyToFindResearchGroup = "";
            searchResearchGroupSkillsAsCompanyToFindResearchGroup = "";
            searchResearchGroupKeywordsAsCompanyToFindResearchGroup = "";
        
            selectedResearchGroupAreas.Clear();
            selectedResearchGroupSkills.Clear();
        
            researchgroupNameSuggestions.Clear();
            researchGroupAreasSuggestions.Clear();
            researchGroupSkillsSuggestions.Clear();
        
            searchResultsAsCompanyToFindResearchGroup = new List<ResearchGroup>();
            hasSearchedForResearchGroups = false;
        
            StateHasChanged();
        }

        private void ShowResearchGroupDetailsOnEyeIconWhenSearchForResearchGroupAsCompany(ResearchGroup researchGroup)
        {
            selectedResearchGroupWhenSearchForResearchGroupsAsCompany = researchGroup;
            showResearchGroupDetailsModalWhenSearchForResearchGroupsAsCompany = true;
            StateHasChanged();
        }


        // Pagination methods (similar to professor search)
        private IEnumerable<ResearchGroup> GetPaginatedResearchGroupResults()
        {
            return searchResultsAsCompanyToFindResearchGroup
                .Skip((currentResearchGroupPage_SearchForResearchGroupsAsCompany - 1) * ResearchGroupsPerPage_SearchForResearchGroupsAsCompany)
                .Take(ResearchGroupsPerPage_SearchForResearchGroupsAsCompany);
        }

        private int totalResearchGroupPages_SearchForResearchGroupsAsCompany => 
            (int)Math.Ceiling((double)searchResultsAsCompanyToFindResearchGroup.Count / ResearchGroupsPerPage_SearchForResearchGroupsAsCompany);

        private void GoToResearchGroupPage(int pageNumber)
        {
            currentResearchGroupPage_SearchForResearchGroupsAsCompany = pageNumber;
        }

        private void OnPageSizeChange_SearchForResearchGroupsAsCompany(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                ResearchGroupsPerPage_SearchForResearchGroupsAsCompany = newSize;
                currentResearchGroupPage_SearchForResearchGroupsAsCompany = 1;
                StateHasChanged();
            }
        }

        private void GoToFirstResearchGroupPage()
        {
            currentResearchGroupPage_SearchForResearchGroupsAsCompany = 1;
            StateHasChanged();
        }

        private void PreviousResearchGroupPage()
        {
            if (currentResearchGroupPage_SearchForResearchGroupsAsCompany > 1)
            {
                currentResearchGroupPage_SearchForResearchGroupsAsCompany--;
                StateHasChanged();
            }
        }

        private List<int> GetVisibleResearchGroupPages()
        {
            var pages = new List<int>();
            int currentPage = currentResearchGroupPage_SearchForResearchGroupsAsCompany;
            int totalPages = totalResearchGroupPages_SearchForResearchGroupsAsCompany;

            // Always show first page
            pages.Add(1);

            // Show pages around current page
            if (currentPage > 3) pages.Add(-1); // Ellipsis

            int start = Math.Max(2, currentPage - 1);
            int end = Math.Min(totalPages - 1, currentPage + 1);

            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }

            if (currentPage < totalPages - 2) pages.Add(-1); // Ellipsis

            // Always show last page if different from first
            if (totalPages > 1) pages.Add(totalPages);

            return pages;
        }

        private void NextResearchGroupPage()
        {
            if (currentResearchGroupPage_SearchForResearchGroupsAsCompany < totalResearchGroupPages_SearchForResearchGroupsAsCompany)
            {
                currentResearchGroupPage_SearchForResearchGroupsAsCompany++;
                StateHasChanged();
            }
        }

        private void GoToLastResearchGroupPage()
        {
            currentResearchGroupPage_SearchForResearchGroupsAsCompany = totalResearchGroupPages_SearchForResearchGroupsAsCompany;
            StateHasChanged();
        }

        private string searchSchoolAsCompanyToFindProfessor = "";
        // Property to get the filtered departments for professors based on selected school
        private List<string> filteredProfessorDepartments => 
            string.IsNullOrEmpty(searchSchoolAsCompanyToFindProfessor) 
                ? GetAllProfessorDepartments() 
                : universityDepartments.ContainsKey(searchSchoolAsCompanyToFindProfessor)
                    ? universityDepartments[searchSchoolAsCompanyToFindProfessor]
                    : new List<string>();

        // Method to get all departments from all schools (for when no school is selected)
        private List<string> GetAllProfessorDepartments()
        {
            return universityDepartments.Values.SelectMany(depts => depts).Distinct().ToList();
        }

        // Method to handle school change for professor search
        private void OnProfessorSchoolChanged()
        {
            // Clear department selection when school changes
            searchDepartmentAsCompanyToFindProfessor = "";
            StateHasChanged();
        }

        private void HandleProfessorSchoolChanged(ChangeEventArgs e)
        {
            searchSchoolAsCompanyToFindProfessor = e.Value?.ToString();
            OnProfessorSchoolChanged();
        }


        private string searchSchoolAsCompanyToFindStudent = "";
        // Property to get the filtered departments for students based on selected school
        private List<string> filteredStudentDepartments => 
            string.IsNullOrEmpty(searchSchoolAsCompanyToFindStudent) 
                ? GetAllStudentDepartments() 
                : universityDepartments.ContainsKey(searchSchoolAsCompanyToFindStudent)
                    ? universityDepartments[searchSchoolAsCompanyToFindStudent]
                    : new List<string>();

        // Method to get all departments from all schools (for when no school is selected)
        private List<string> GetAllStudentDepartments()
        {
            return universityDepartments.Values.SelectMany(depts => depts).Distinct().ToList();
        }

        // Method to handle school change for student search
        private async Task OnStudentSchoolChanged(ChangeEventArgs e)
        {
            searchSchoolAsCompanyToFindStudent = e.Value?.ToString() ?? "";
            // Clear department selection when school changes
            searchDepartmentAsCompanyToFindStudent = "";
            await InvokeAsync(StateHasChanged);
        }

        private string searchSchoolAsProfessorToFindStudent = "";
        private List<string> filteredStudentDepartmentsAsProfessor => 
        string.IsNullOrEmpty(searchSchoolAsProfessorToFindStudent) 
            ? GetAllStudentDepartments() 
            : universityDepartments.ContainsKey(searchSchoolAsProfessorToFindStudent)
                ? universityDepartments[searchSchoolAsProfessorToFindStudent]
                : new List<string>();

        // Method to handle school change for student search as Professor
        private async Task OnStudentSchoolChangedAsProfessor(ChangeEventArgs e)
        {
            searchSchoolAsProfessorToFindStudent = e.Value?.ToString() ?? "";
            // Clear department selection when school changes
            searchDepartmentAsProfessorToFindStudent = "";
            await InvokeAsync(StateHasChanged);
        }

        private string searchSchoolAsRGToFindProfessor = "";
        // Property to get the filtered departments for professors based on selected school (Research Group search)
        private List<string> filteredProfessorDepartmentsAsRG => 
            string.IsNullOrEmpty(searchSchoolAsRGToFindProfessor) 
                ? GetAllProfessorDepartments() 
                : universityDepartments.ContainsKey(searchSchoolAsRGToFindProfessor)
                    ? universityDepartments[searchSchoolAsRGToFindProfessor]
                    : new List<string>();

        // Method to handle school change for professor search as Research Group
        private async Task OnProfessorSchoolChangedAsRG(ChangeEventArgs e)
        {
            searchSchoolAsRGToFindProfessor = e.Value?.ToString() ?? "";
            // Clear department selection when school changes
            searchDepartmentAsRGToFindProfessor = "";
            await InvokeAsync(StateHasChanged);
        }







        // Add these variables to your component
        private List<FacultyMemberInfo> facultyMembers = new List<FacultyMemberInfo>();
        private List<NonFacultyMemberInfo> nonFacultyMembers = new List<NonFacultyMemberInfo>();
        private List<SpinOffCompanyInfo> spinOffCompanies = new List<SpinOffCompanyInfo>();
        private List<IpodomiInfo> researchGroupIpodomes = new();

        private int facultyMembersCount = 0;
        private int nonFacultyMembersCount = 0;
        private int activeResearchActionsCount = 0;
        private int patentsCount = 0;

        // Helper classes
        public class FacultyMemberInfo
        {
            public string FullName { get; set; } = "";
            public string Email { get; set; } = "";
        }

        public class NonFacultyMemberInfo
        {
            public string FullName { get; set; } = "";
            public string Email { get; set; } = "";
        }

        public class SpinOffCompanyInfo
        {
            public string CompanyTitle { get; set; } = "";
            public string CompanyAFM { get; set; } = "";
        }

        public class IpodomiInfo
        {
            public string Title { get; set; }
            public string Description { get; set; }
        }


        // Method to load modal data
        private async Task LoadResearchGroupDetailsData(string researchGroupEmail)
        {
            try
            {
                // Load Faculty Members - Get from Professors table using PK_ProfessorEmail
                var facultyMembersData = await dbContext.ResearchGroup_Professors
                    .Where(rp => rp.PK_ResearchGroupEmail == researchGroupEmail)
                    .Join(dbContext.Professors,
                        rp => rp.PK_ProfessorEmail,
                        p => p.ProfEmail,
                        (rp, p) => new FacultyMemberInfo
                        {
                            FullName = $"{p.ProfName} {p.ProfSurname}",
                            Email = p.ProfEmail
                        })
                    .ToListAsync();

                facultyMembers = facultyMembersData;
                facultyMembersCount = facultyMembers.Count;

                // Load Non-Faculty Members - Get from Students table using PK_NonFacultyMemberEmail
                var nonFacultyMembersData = await dbContext.ResearchGroup_NonFacultyMembers
                    .Where(rn => rn.PK_ResearchGroupEmail == researchGroupEmail)
                    .Join(dbContext.Students,
                        rn => rn.PK_NonFacultyMemberEmail,
                        s => s.Email,
                        (rn, s) => new NonFacultyMemberInfo
                        {
                            FullName = $"{s.Name} {s.Surname}",
                            Email = s.Email
                        })
                    .ToListAsync();

                nonFacultyMembers = nonFacultyMembersData;
                nonFacultyMembersCount = nonFacultyMembers.Count;

                // Load Spin-off Companies
                spinOffCompanies = await dbContext.ResearchGroup_SpinOffCompany
                    .Where(s => s.ResearchGroupEmail == researchGroupEmail)
                    .Select(s => new SpinOffCompanyInfo
                    {
                        CompanyTitle = s.ResearchGroup_SpinOff_CompanyTitle,
                        CompanyAFM = s.ResearchGroup_SpinOff_CompanyAFM
                    })
                    .ToListAsync();

                // Count Active Research Actions
                activeResearchActionsCount = await dbContext.ResearchGroup_ResearchActions
                    .Where(r => r.ResearchGroupEmail == researchGroupEmail && 
                            r.ResearchGroup_ProjectStatus == "OnGoing")
                    .CountAsync();

                // Count Patents
                patentsCount = await dbContext.ResearchGroup_Patents
                    .Where(p => p.ResearchGroupEmail == researchGroupEmail)
                    .CountAsync();

                researchGroupIpodomes = await dbContext.ResearchGroup_Ipodomes
                    .Where(i => i.ResearchGroupEmail == researchGroupEmail)
                    .Select(i => new IpodomiInfo
                    {
                        Title = i.ResearchGroup_Ipodomes_Title,
                        Description = i.ResearchGroup_Ipodomes_Description
                    })
                    .ToListAsync();

                /*
                Console.WriteLine($"Faculty Members: {facultyMembersCount}");
                Console.WriteLine($"Non-Faculty Members: {nonFacultyMembersCount}");
                Console.WriteLine($"Spin-off Companies: {spinOffCompanies.Count}");
                Console.WriteLine($"Active Research Actions: {activeResearchActionsCount}");
                Console.WriteLine($"Patents: {patentsCount}");
                Console.WriteLine($"Ipodomes found: {researchGroupIpodomes.Count}");
                */
            }
            catch (Exception ex)
            {   /*
                Console.WriteLine($"Πρόβλημα στην φόρτωση λεπτομερειών ομάδας: {ex.Message}");
                */
                Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            }
        }

        private async Task ShowResearchGroupDetailsModal(ResearchGroup researchGroup)
        {
            selectedResearchGroupWhenSearchForResearchGroupsAsCompany = researchGroup;
            showResearchGroupDetailsModalWhenSearchForResearchGroupsAsCompany = true;
        
            // Load additional data
            if (!string.IsNullOrEmpty(researchGroup.ResearchGroupEmail))
            {
                await LoadResearchGroupDetailsData(researchGroup.ResearchGroupEmail);
            }
        
            StateHasChanged();
        }

        private void CloseModalResearchGroupDetailsOnEyeIconWhenSearchForResearchGroupsAsCompany()
        {
            showResearchGroupDetailsModalWhenSearchForResearchGroupsAsCompany = false;
            selectedResearchGroupWhenSearchForResearchGroupsAsCompany = null;
            facultyMembers.Clear();
            nonFacultyMembers.Clear();
            spinOffCompanies.Clear();
            facultyMembersCount = 0;
            nonFacultyMembersCount = 0;
            activeResearchActionsCount = 0;
            patentsCount = 0;
        }

        private void GoToFirstPageForCompanyAnnouncements()
        {
            currentPageForCompanyAnnouncements = 1;
        }

        private void PreviousPageForCompanyAnnouncements()
        {
            if (currentPageForCompanyAnnouncements > 1)
            {
                currentPageForCompanyAnnouncements--;
            }
        }

        private void NextPageForCompanyAnnouncements()
        {
            if (currentPageForCompanyAnnouncements < totalPagesForCompanyAnnouncements)
            {
                currentPageForCompanyAnnouncements++;
            }
        }

        private void GoToLastPageForCompanyAnnouncements()
        {
            currentPageForCompanyAnnouncements = totalPagesForCompanyAnnouncements;
        }

        private void GoToPageForCompanyAnnouncements(int pageNumber)
        {
            currentPageForCompanyAnnouncements = pageNumber;
        }

        private List<int> GetVisiblePagesForCompanyAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForCompanyAnnouncements;
            int total = totalPagesForCompanyAnnouncements;

            pages.Add(1);

            if (current > 3)
            {
                pages.Add(-1);
            }

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }

            if (current < total - 2)
            {
                pages.Add(-1);
            }

            if (total > 1)
            {
                pages.Add(total);
            }

            return pages;
        }

        private void GoToFirstPageForProfessorAnnouncements()
        {
            currentPageForProfessorAnnouncements = 1;
        }

        private void PreviousPageForProfessorAnnouncements()
        {
            if (currentPageForProfessorAnnouncements > 1)
            {
                currentPageForProfessorAnnouncements--;
            }
        }

        private void NextPageForProfessorAnnouncements()
        {
            if (currentPageForProfessorAnnouncements < totalPagesForProfessorAnnouncements)
            {
                currentPageForProfessorAnnouncements++;
            }
        }

        private void GoToLastPageForProfessorAnnouncements()
        {
            currentPageForProfessorAnnouncements = totalPagesForProfessorAnnouncements;
        }

        private void GoToPageForProfessorAnnouncements(int pageNumber)
        {
            currentPageForProfessorAnnouncements = pageNumber;
        }

        private List<int> GetVisiblePagesForProfessorAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForProfessorAnnouncements;
            int total = totalPagesForProfessorAnnouncements;

            pages.Add(1);

            if (current > 3)
            {
                pages.Add(-1);
            }

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }

            if (current < total - 2)
            {
                pages.Add(-1);
            }

            if (total > 1)
            {
                pages.Add(total);
            }

            return pages;
        }


        List<string> AvailableSchools = new();
        List<string> AvailableDepartments = new();
        string SelectedAreaSchool = "";
        string SelectedAreaDepartment = "";
        string SelectedSkillSchool = "";
        string SelectedSkillDepartment = "";



        // Event handlers for dropdowns
        private void FilterAreasBySchool(ChangeEventArgs e)
        {
            SelectedAreaSchool = e.Value?.ToString();
            UpdateAreasChart();
        }

        private void FilterAreasByDepartment(ChangeEventArgs e)
        {
            SelectedAreaDepartment = e.Value?.ToString();
            UpdateAreasChart();
        }

        private void FilterSkillsBySchool(ChangeEventArgs e)
        {
            SelectedSkillSchool = e.Value?.ToString();
            UpdateSkillsChart();
        }

        private void FilterSkillsByDepartment(ChangeEventArgs e)
        {
            SelectedSkillDepartment = e.Value?.ToString();
            UpdateSkillsChart();
        }

        private void UpdateAreasChart()
        {
            var filtered = StudentsWithAuth0Details
                .Where(s => (string.IsNullOrEmpty(SelectedAreaSchool) || s.School == SelectedAreaSchool) &&
                        (string.IsNullOrEmpty(SelectedAreaDepartment) || s.Department == SelectedAreaDepartment))
                .ToList();

            // Calculate distribution for filtered data - SPLIT comma-separated areas
            var filteredAreaDistribution = new Dictionary<string, int>();
            foreach (var student in filtered)
            {
                if (!string.IsNullOrWhiteSpace(student.AreasOfExpertise))
                {
                    var areas = student.AreasOfExpertise.Split(',', StringSplitOptions.RemoveEmptyEntries);
                    foreach (var area in areas.Select(a => a.Trim()))
                    {
                        if (filteredAreaDistribution.ContainsKey(area))
                            filteredAreaDistribution[area]++;
                        else
                            filteredAreaDistribution[area] = 1;
                    }
                }
            }

            var areaLabels = filteredAreaDistribution.Keys.ToArray();
            var areaValues = filteredAreaDistribution.Values.ToArray();

            // Update only the areas chart, preserve skills chart
            JS.InvokeVoidAsync("renderCharts", 
                new { labels = areaLabels, values = areaValues },
                null); // null means don't update skills
        }

        private void UpdateSkillsChart()
        {
            var filtered = StudentsWithAuth0Details
                .Where(s => (string.IsNullOrEmpty(SelectedSkillSchool) || s.School == SelectedSkillSchool) &&
                        (string.IsNullOrEmpty(SelectedSkillDepartment) || s.Department == SelectedSkillDepartment))
                .ToList();

            // Calculate distribution for filtered data
            var filteredSkillDistribution = new Dictionary<string, int>();
            foreach (var student in filtered)
            {
                if (!string.IsNullOrWhiteSpace(student.Keywords))
                {
                    var skills = student.Keywords.Split(',', StringSplitOptions.RemoveEmptyEntries);
                    foreach (var skill in skills.Select(s => s.Trim()))
                    {
                        if (filteredSkillDistribution.ContainsKey(skill))
                            filteredSkillDistribution[skill]++;
                        else
                            filteredSkillDistribution[skill] = 1;
                    }
                }
            }

            var skillLabels = filteredSkillDistribution.Keys.ToArray();
            var skillValues = filteredSkillDistribution.Values.ToArray();

            // Update only the skills chart, preserve areas chart
            JS.InvokeVoidAsync("renderCharts", 
                null, // null means don't update areas
                new { labels = skillLabels, values = skillValues });
        }

        // Add this method to update both charts when needed
        private void UpdateBothCharts()
        {
            UpdateAreasChart();
            UpdateSkillsChart();
        }

        // Properties for Research Group Announcements Creation
        private bool isResearchGroupAnnouncementsFormVisible = true;
        private AnnouncementAsResearchGroup researchGroupAnnouncement = new();
        private bool showErrorMessageforUploadingResearchGroupAnnouncement = false;
        private bool isFormValidToSaveResearchGroupAnnouncement = true;
        private bool isSaveResearchGroupAnnouncementSuccessful = false;
        private string saveResearchGroupAnnouncementMessage = string.Empty;
        private int remainingCharactersInResearchGroupAnnouncementField = 120;
        private int remainingCharactersInResearchGroupAnnouncementDescription = 1000;

        // Properties for Viewing Research Group Announcements
        private bool isUploadedResearchGroupAnnouncementsVisible = false;
        private string selectedStatusFilterForResearchGroupAnnouncements = "Όλα";
        private int[] pageSizeOptions_SeeMyUploadedAnnouncementsAsResearchGroup = new[] { 10, 50, 100 };
        private int pageSizeForResearchGroupAnnouncements = 10;
        private int currentPageForResearchGroupAnnouncements = 1;
        private List<AnnouncementAsResearchGroup> UploadedResearchGroupAnnouncements { get; set; } = new();
        private List<AnnouncementAsResearchGroup> FilteredResearchGroupAnnouncements { get; set; } = new();
        private int totalCountResearchGroupAnnouncements, publishedCountResearchGroupAnnouncements, unpublishedCountResearchGroupAnnouncements;

        // Current announcement for editing
        private AnnouncementAsResearchGroup currentResearchGroupAnnouncement = new();
        private bool isResearchGroupEditModalVisible = false;
        private byte[]? researchGroupAnnouncementAttachmentFile;

        // Selected announcement for viewing details
        private AnnouncementAsResearchGroup? selectedResearchGroupAnnouncementToSeeDetails;

        // ============ CREATE ANNOUNCEMENT METHODS ============



        private void CheckCharacterLimitInResearchGroupAnnouncementField(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInResearchGroupAnnouncementField = 120 - inputText.Length;
        }

        private void CheckCharacterLimitInResearchGroupAnnouncementDescription(ChangeEventArgs e)
        {
            var inputText = e.Value?.ToString() ?? string.Empty;
            remainingCharactersInResearchGroupAnnouncementDescription = 1000 - inputText.Length;
        }

        private string ResearchGroupAnnouncementAttachmentErrorMessage = string.Empty;
        private async Task HandleFileSelectedForResearchGroupAnnouncementAttachment(InputFileChangeEventArgs e)
        {
            try
            {
                var file = e.File;
            
                // If no file is selected, clear the attachment and return
                if (file == null)
                {
                    researchGroupAnnouncement.ResearchGroupAnnouncementAttachmentFile = null;
                    ResearchGroupAnnouncementAttachmentErrorMessage = null;
                    return;
                }

                // Check file type
                if (file.ContentType != "application/pdf")
                {
                    ResearchGroupAnnouncementAttachmentErrorMessage = "Λάθος τύπος αρχείου. Επιλέξτε αρχείο PDF.";
                    researchGroupAnnouncement.ResearchGroupAnnouncementAttachmentFile = null;
                    return;
                }

                // Check file size (10MB = 10,485,760 bytes)
                const long maxFileSize = 10485760;
                if (file.Size > maxFileSize)
                {
                    ResearchGroupAnnouncementAttachmentErrorMessage = "Το αρχείο είναι πολύ μεγάλο. Μέγιστο μέγεθος: 10MB";
                    researchGroupAnnouncement.ResearchGroupAnnouncementAttachmentFile = null;
                    return;
                }

                using var ms = new MemoryStream();
                await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                researchGroupAnnouncement.ResearchGroupAnnouncementAttachmentFile = ms.ToArray();

                // Clear any previous error message
                ResearchGroupAnnouncementAttachmentErrorMessage = null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading research group announcement attachment: {ex.Message}");
                ResearchGroupAnnouncementAttachmentErrorMessage = "Προέκυψε ένα σφάλμα κατά την μεταφόρτωση του αρχείου.";
                researchGroupAnnouncement.ResearchGroupAnnouncementAttachmentFile = null;
            }
        }

        private async Task SaveResearchGroupAnnouncementAsPublished()
        {
            isFormValidToSaveResearchGroupAnnouncement = ValidateMandatoryFieldsForUploadResearchGroupAnnouncement();

            if (!isFormValidToSaveResearchGroupAnnouncement)
                return;

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{researchGroupAnnouncement.ResearchGroupAnnouncementTitle}</strong> ως '<strong>Δημοσιευμένη</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
            });

            if (!isConfirmed)
                return;

            researchGroupAnnouncement.ResearchGroupAnnouncementStatus = "Δημοσιευμένη";
            researchGroupAnnouncement.ResearchGroupAnnouncementUploadDate = DateTime.Now;
            researchGroupAnnouncement.ResearchGroupAnnouncementResearchGroupEmail = CurrentUserEmail;
            researchGroupAnnouncement.ResearchGroupAnnouncementRNG = new Random().NextInt64();
            researchGroupAnnouncement.ResearchGroupAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(researchGroupAnnouncement.ResearchGroupAnnouncementRNG ?? 0);
            await SaveResearchGroupAnnouncementToDatabase();
        }

        private async Task SaveResearchGroupAnnouncementAsUnpublished()
        {
            isFormValidToSaveResearchGroupAnnouncement = ValidateMandatoryFieldsForUploadResearchGroupAnnouncement();

            if (!isFormValidToSaveResearchGroupAnnouncement)
                return;

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                $"Πρόκεται να Δημιουργήσετε μια Ανακοίνωση με Τίτλο: <strong>{researchGroupAnnouncement.ResearchGroupAnnouncementTitle}</strong> ως '<strong>Μη Δημοσιευμένη (Προσωρινή Αποθήκευση)</strong>'.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>"
            });

            if (!isConfirmed)
                return;

            researchGroupAnnouncement.ResearchGroupAnnouncementStatus = "Μη Δημοσιευμένη";
            researchGroupAnnouncement.ResearchGroupAnnouncementUploadDate = DateTime.Now;
            researchGroupAnnouncement.ResearchGroupAnnouncementResearchGroupEmail = CurrentUserEmail;
            researchGroupAnnouncement.ResearchGroupAnnouncementRNG = new Random().NextInt64();
            researchGroupAnnouncement.ResearchGroupAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(researchGroupAnnouncement.ResearchGroupAnnouncementRNG ?? 0);
            await SaveResearchGroupAnnouncementToDatabase();
        }

        private async Task SaveResearchGroupAnnouncementToDatabase()
        {
            try
            {
                if (string.IsNullOrWhiteSpace(researchGroupAnnouncement.ResearchGroupAnnouncementTitle))
                {
                    showErrorMessageforUploadingResearchGroupAnnouncement = true;
                    await JS.InvokeVoidAsync("scrollToElementById", "researchGroupAnnouncementTitle");
                    return;
                }

                if (string.IsNullOrWhiteSpace(researchGroupAnnouncement.ResearchGroupAnnouncementDescription))
                {
                    showErrorMessageforUploadingResearchGroupAnnouncement = true;
                    await JS.InvokeVoidAsync("scrollToElementById", "ResearchGroupAnnouncementDescription");
                    return;
                }

                if (researchGroupAnnouncement.ResearchGroupAnnouncementTimeToBeActive.Date <= DateTime.Today)
                {
                    showErrorMessageforUploadingResearchGroupAnnouncement = true;
                    await JS.InvokeVoidAsync("scrollToElementById", "ResearchGroupAnnouncementTimeToBeActive");
                    return;
                }

                dbContext.AnnouncementAsResearchGroup.Add(researchGroupAnnouncement);
                await dbContext.SaveChangesAsync();
        
                isSaveResearchGroupAnnouncementSuccessful = true;
                saveResearchGroupAnnouncementMessage = "Η Ανακοίνωση Δημιουργήθηκε Επιτυχώς";
        
                // Clear form and refresh the list
                researchGroupAnnouncement = new AnnouncementAsResearchGroup();
                UploadedResearchGroupAnnouncements = await GetUploadedResearchGroupAnnouncements();
                FilterResearchGroupAnnouncements();
            }
            catch (Exception ex)
            {
                isSaveResearchGroupAnnouncementSuccessful = false;
                saveResearchGroupAnnouncementMessage = "Κάποιο πρόβλημα παρουσιάστηκε με την Δημιουργία της Ανακοίνωσης! Ανανεώστε την σελίδα και προσπαθήστε ξανά";
                Console.WriteLine($"Error saving research group announcement: {ex.Message}");
            }

            StateHasChanged();
        }

        private bool ValidateMandatoryFieldsForUploadResearchGroupAnnouncement()
        {
            if (string.IsNullOrWhiteSpace(researchGroupAnnouncement.ResearchGroupAnnouncementTitle) || 
                string.IsNullOrWhiteSpace(researchGroupAnnouncement.ResearchGroupAnnouncementDescription) ||
                researchGroupAnnouncement.ResearchGroupAnnouncementTimeToBeActive.Date <= DateTime.Today)
            {
                showErrorMessageforUploadingResearchGroupAnnouncement = true;
                return false;
            }

            showErrorMessageforUploadingResearchGroupAnnouncement = false;
            return true;
        }


        private async Task ToggleUploadedResearchGroupAnnouncementsVisibility()
        {
            isUploadedResearchGroupAnnouncementsVisible = !isUploadedResearchGroupAnnouncementsVisible;

            if (isUploadedResearchGroupAnnouncementsVisible)
            {
                // Load research group announcements only when the section is visible
                await LoadUploadedResearchGroupAnnouncementsAsync();
            }

            StateHasChanged();
        }

        private void HandleResearchGroupStatusFilterChange(ChangeEventArgs e)
        {
            selectedStatusFilterForResearchGroupAnnouncements = e.Value.ToString();
            FilterResearchGroupAnnouncements();
        }

        private void FilterResearchGroupAnnouncements()
        {
            if (UploadedResearchGroupAnnouncements == null) return;

            FilteredResearchGroupAnnouncements = selectedStatusFilterForResearchGroupAnnouncements switch
            {
                "Δημοσιευμένη" => UploadedResearchGroupAnnouncements.Where(a => a.ResearchGroupAnnouncementStatus == "Δημοσιευμένη").ToList(),
                "Μη Δημοσιευμένη" => UploadedResearchGroupAnnouncements.Where(a => a.ResearchGroupAnnouncementStatus == "Μη Δημοσιευμένη").ToList(),
                _ => UploadedResearchGroupAnnouncements.ToList()
            };

            totalCountResearchGroupAnnouncements = UploadedResearchGroupAnnouncements.Count;
            publishedCountResearchGroupAnnouncements = UploadedResearchGroupAnnouncements.Count(a => a.ResearchGroupAnnouncementStatus == "Δημοσιευμένη");
            unpublishedCountResearchGroupAnnouncements = UploadedResearchGroupAnnouncements.Count(a => a.ResearchGroupAnnouncementStatus == "Μη Δημοσιευμένη");

            currentPageForResearchGroupAnnouncements = 1;
            StateHasChanged();
        }

        private int totalPagesForResearchGroupAnnouncements => (int)Math.Ceiling((double)(FilteredResearchGroupAnnouncements?.Count ?? 0) / pageSizeForResearchGroupAnnouncements);

        private IEnumerable<AnnouncementAsResearchGroup> GetPaginatedResearchGroupAnnouncements()
        {
            return FilteredResearchGroupAnnouncements?
                .Skip((currentPageForResearchGroupAnnouncements - 1) * pageSizeForResearchGroupAnnouncements)
                .Take(pageSizeForResearchGroupAnnouncements) ?? Enumerable.Empty<AnnouncementAsResearchGroup>();
        }

        private async Task DeleteResearchGroupAnnouncement(int announcementId)
        {
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                "Πρόκειται να διαγράψετε οριστικά αυτή την Ανακοίνωση.<br><br>" + 
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                var announcement = await dbContext.AnnouncementAsResearchGroup.FindAsync(announcementId);
                if (announcement != null)
                {
                    dbContext.AnnouncementAsResearchGroup.Remove(announcement);
                    await dbContext.SaveChangesAsync();

                    UploadedResearchGroupAnnouncements = await GetUploadedResearchGroupAnnouncements();
                    FilterResearchGroupAnnouncements();
                }

                StateHasChanged();
            }
        }

        private void OpenResearchGroupAnnouncementDetailsModal(AnnouncementAsResearchGroup currentAnnouncement)
        {
            selectedResearchGroupAnnouncementToSeeDetails = currentAnnouncement;
        }

        private void CloseResearchGroupAnnouncementDetailsModal()
        {
            selectedResearchGroupAnnouncementToSeeDetails = null;
        }

        private async Task ChangeResearchGroupAnnouncementStatus(int announcementId, string newStatus)
        {
            var isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML",
                $"Πρόκειται να αλλάξετε την κατάσταση αυτής της Ανακοίνωσης σε <strong>{newStatus}</strong>.<br><br>" +
                "<strong style='color: red;'>Είστε σίγουρος/η;</strong>");

            if (isConfirmed)
            {
                var announcement = UploadedResearchGroupAnnouncements.FirstOrDefault(a => a.Id == announcementId);
                if (announcement != null)
                {
                    announcement.ResearchGroupAnnouncementStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                
                    UploadedResearchGroupAnnouncements = await GetUploadedResearchGroupAnnouncements();
                    FilterResearchGroupAnnouncements();
                }

                StateHasChanged();
            }
        }

        private void OpenResearchGroupEditModal(AnnouncementAsResearchGroup announcement)
        {
            currentResearchGroupAnnouncement = new AnnouncementAsResearchGroup
            {
                Id = announcement.Id,
                ResearchGroupAnnouncementTitle = announcement.ResearchGroupAnnouncementTitle,
                ResearchGroupAnnouncementDescription = announcement.ResearchGroupAnnouncementDescription,
                ResearchGroupAnnouncementUploadDate = announcement.ResearchGroupAnnouncementUploadDate,
                ResearchGroupAnnouncementResearchGroupEmail = announcement.ResearchGroupAnnouncementResearchGroupEmail,
                ResearchGroupAnnouncementTimeToBeActive = announcement.ResearchGroupAnnouncementTimeToBeActive,
                ResearchGroupAnnouncementAttachmentFile = announcement.ResearchGroupAnnouncementAttachmentFile
            };
            isResearchGroupEditModalVisible = true;
        }

        private void CloseResearchGroupEditModal()
        {
            isResearchGroupEditModalVisible = false;
            currentResearchGroupAnnouncement = new AnnouncementAsResearchGroup();
        }

        private async Task UpdateResearchGroupAnnouncement(AnnouncementAsResearchGroup announcement)
        {
            var existingAnnouncement = await dbContext.AnnouncementAsResearchGroup.FindAsync(announcement.Id);
            if (existingAnnouncement != null)
            {
                existingAnnouncement.ResearchGroupAnnouncementTitle = announcement.ResearchGroupAnnouncementTitle;
                existingAnnouncement.ResearchGroupAnnouncementDescription = announcement.ResearchGroupAnnouncementDescription;
                existingAnnouncement.ResearchGroupAnnouncementUploadDate = announcement.ResearchGroupAnnouncementUploadDate;
                existingAnnouncement.ResearchGroupAnnouncementTimeToBeActive = announcement.ResearchGroupAnnouncementTimeToBeActive;
            
                if (researchGroupAnnouncementAttachmentFile != null)
                {
                    existingAnnouncement.ResearchGroupAnnouncementAttachmentFile = researchGroupAnnouncementAttachmentFile;
                }

                await dbContext.SaveChangesAsync();
            
                UploadedResearchGroupAnnouncements = await GetUploadedResearchGroupAnnouncements();
                FilterResearchGroupAnnouncements();
            
                isResearchGroupEditModalVisible = false;
                StateHasChanged();
            }
        }

        private async Task HandleFileUploadToEditResearchGroupAnnouncementAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;
            if (file != null)
            {
                using var memoryStream = new MemoryStream();
                await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(memoryStream);
                researchGroupAnnouncementAttachmentFile = memoryStream.ToArray();
            }
        }

        // ============ PAGINATION METHODS ============

        private void GoToFirstPageForResearchGroupAnnouncements() => ChangePageForResearchGroupAnnouncements(1);
        private void PreviousPageForResearchGroupAnnouncements() => ChangePageForResearchGroupAnnouncements(currentPageForResearchGroupAnnouncements - 1);
        private void NextPageForResearchGroupAnnouncements() => ChangePageForResearchGroupAnnouncements(currentPageForResearchGroupAnnouncements + 1);
        private void GoToLastPageForResearchGroupAnnouncements() => ChangePageForResearchGroupAnnouncements(totalPagesForResearchGroupAnnouncements);

        private void ChangePageForResearchGroupAnnouncements(int newPage)
        {
            if (newPage > 0 && newPage <= totalPagesForResearchGroupAnnouncements)
            {
                currentPageForResearchGroupAnnouncements = newPage;
                StateHasChanged();
            }
        }

        private void GoToPageForResearchGroupAnnouncements(int pageNum) => ChangePageForResearchGroupAnnouncements(pageNum);

        private List<int> GetVisiblePagesForResearchGroupAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForResearchGroupAnnouncements;
            int total = totalPagesForResearchGroupAnnouncements;
        
            pages.Add(1);
            if (current > 3) pages.Add(-1);
        
            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);
        
            for (int i = start; i <= end; i++) pages.Add(i);
        
            if (current < total - 2) pages.Add(-1);
            if (total > 1) pages.Add(total);
        
            return pages;
        }

        private void OnPageSizeChange_SeeMyUploadedAnnouncementsAsResearchGroup(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize))
            {
                pageSizeForResearchGroupAnnouncements = newSize;
                currentPageForResearchGroupAnnouncements = 1;
                StateHasChanged();
            }
        }


        private async Task<List<AnnouncementAsResearchGroup>> GetUploadedResearchGroupAnnouncements()
        {
            return await dbContext.AnnouncementAsResearchGroup
                .Include(a => a.ResearchGroup)
                .Where(a => a.ResearchGroupAnnouncementResearchGroupEmail == CurrentUserEmail)
                .OrderByDescending(a => a.ResearchGroupAnnouncementUploadDate)
                .ToListAsync();
        }

        private bool isResearchGroupPublicAnnouncementsVisible = false;
        private void ToggleResearchGroupPublicAnnouncementsVisibility()
        {
            isResearchGroupPublicAnnouncementsVisible = !isResearchGroupPublicAnnouncementsVisible;
            StateHasChanged();
        }

        private int currentPageForResearchGroupPublicAnnouncements = 1;
        private int totalPagesForResearchGroupPublicAnnouncements => (int)Math.Ceiling((ResearchGroupAnnouncements?.Where(a => a.ResearchGroupAnnouncementStatus == "Δημοσιευμένη").Count() ?? 0) / (double)pageSize);

        private void GoToFirstPageForResearchGroupPublicAnnouncements()
        {
            currentPageForResearchGroupPublicAnnouncements = 1;
        }

        private void PreviousPageForResearchGroupPublicAnnouncements()
        {
            if (currentPageForResearchGroupPublicAnnouncements > 1)
            {
                currentPageForResearchGroupPublicAnnouncements--;
            }
        }

        private void NextPageForResearchGroupPublicAnnouncements()
        {
            if (currentPageForResearchGroupPublicAnnouncements < totalPagesForResearchGroupPublicAnnouncements)
            {
                currentPageForResearchGroupPublicAnnouncements++;
            }
        }

        private void GoToLastPageForResearchGroupPublicAnnouncements()
        {
            currentPageForResearchGroupPublicAnnouncements = totalPagesForResearchGroupPublicAnnouncements;
        }

        private void GoToPageForResearchGroupPublicAnnouncements(int pageNumber)
        {
            currentPageForResearchGroupPublicAnnouncements = pageNumber;
        }

        private List<int> GetVisiblePagesForResearchGroupPublicAnnouncements()
        {
            var pages = new List<int>();
            int current = currentPageForResearchGroupPublicAnnouncements;
            int total = totalPagesForResearchGroupPublicAnnouncements;

            pages.Add(1);

            if (current > 3)
            {
                pages.Add(-1);
            }

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++)
            {
                pages.Add(i);
            }

            if (current < total - 2)
            {
                pages.Add(-1);
            }

            if (total > 1)
            {
                pages.Add(total);
            }

            return pages;
        }

        private int expandedResearchGroupPublicAnnouncementId = 0;
        private void ToggleDescriptionForResearchGroupPublicAnnouncements(int announcementId)
        {
            expandedResearchGroupPublicAnnouncementId = expandedResearchGroupPublicAnnouncementId == announcementId ? 0 : announcementId;
            StateHasChanged();
        }


        private async Task DownloadResearchGroupPublicAnnouncementAttachmentFrontPage(byte[] attachmentData, string fileName)
        {
            if (attachmentData != null && attachmentData.Length > 0)
            {
                var mimeType = "application/pdf"; // Correct MIME type for PDF
                await JS.InvokeVoidAsync("BlazorDownloadAttachmentPositionFile", fileName, mimeType, attachmentData);
            }
        }

        private List<string> professorNameSuggestions = new List<string>();
        private List<string> professorSurnameSuggestions = new List<string>();
        private async Task HandleProfessorNameInput(ChangeEventArgs e)
        {
            searchProfessorNameToFindThesesAsCompany = e.Value?.ToString() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchProfessorNameToFindThesesAsCompany))
            {
                professorNameSuggestions.Clear();
                return;
            }

            // Get unique professor names from the database that match the input
            professorNameSuggestions = await dbContext.ProfessorTheses
                .Include(t => t.Professor)
                .Where(t => t.Professor != null && 
                        t.Professor.ProfName.Contains(searchProfessorNameToFindThesesAsCompany))
                .Select(t => t.Professor.ProfName)
                .Distinct()
                .ToListAsync();
        }

        private async Task HandleProfessorSurnameInput(ChangeEventArgs e)
        {
            searchProfessorSurnameToFindThesesAsCompany = e.Value?.ToString() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchProfessorSurnameToFindThesesAsCompany))
            {
                professorSurnameSuggestions.Clear();
                return;
            }

            // Get unique professor surnames from the database that match the input
            professorSurnameSuggestions = await dbContext.ProfessorTheses
                .Include(t => t.Professor)
                .Where(t => t.Professor != null && 
                        t.Professor.ProfSurname.Contains(searchProfessorSurnameToFindThesesAsCompany))
                .Select(t => t.Professor.ProfSurname)
                .Distinct()
                .ToListAsync();
        }

        private void SelectProfessorNameSuggestion(string name)
        {
            searchProfessorNameToFindThesesAsCompany = name;
            professorNameSuggestions.Clear();
        }

        private void SelectProfessorSurnameSuggestion(string surname)
        {
            searchProfessorSurnameToFindThesesAsCompany = surname;
            professorSurnameSuggestions.Clear();
        }

        private string searchSkillsInputToFindThesesAsCompany = string.Empty;
        private List<string> skillSuggestionsToFindThesesAsCompany = new List<string>();
        private List<string> selectedSkillsToFindThesesAsCompany = new List<string>();

        private async Task HandleSkillsInputToFindThesesAsCompany(ChangeEventArgs e)
        {
            searchSkillsInputToFindThesesAsCompany = e.Value?.ToString().Trim() ?? string.Empty;
            skillSuggestionsToFindThesesAsCompany = new();

            if (searchSkillsInputToFindThesesAsCompany.Length >= 1)
            {
                try
                {
                    // Get unique skills from the Skills table that match the input
                    skillSuggestionsToFindThesesAsCompany = await Task.Run(() =>
                        dbContext.Skills
                            .Where(s => s.SkillName.Contains(searchSkillsInputToFindThesesAsCompany))
                            .Select(s => s.SkillName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση δεξιοτήτων: {ex.Message}");
                    skillSuggestionsToFindThesesAsCompany = new List<string>();
                }
            }
            else
            {
                skillSuggestionsToFindThesesAsCompany.Clear();
            }

            StateHasChanged();
        }

        private void SelectSkillSuggestionToFindThesesAsCompany(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedSkillsToFindThesesAsCompany.Contains(suggestion))
            {
                selectedSkillsToFindThesesAsCompany.Add(suggestion);
                skillSuggestionsToFindThesesAsCompany.Clear();
                searchSkillsInputToFindThesesAsCompany = string.Empty;
            }
        }

        private void RemoveSelectedSkillToFindThesesAsCompany(string skill)
        {
            selectedSkillsToFindThesesAsCompany.Remove(skill);
            StateHasChanged();
        }

        private async Task HandleCompanyNameInput(ChangeEventArgs e)
        {
            searchCompanyNameToFindThesesAsProfessor = e.Value?.ToString().Trim() ?? string.Empty;

            if (searchCompanyNameToFindThesesAsProfessor.Length >= 2)
            {
                try
                {
                    companyNameSuggestions = await Task.Run(() =>
                        dbContext.Companies // Assuming your Companies table/entity is named "Companies"
                            .Where(c => c.CompanyName.Contains(searchCompanyNameToFindThesesAsProfessor))
                            .Select(c => c.CompanyName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση εταιρειών: {ex.Message}");
                    companyNameSuggestions.Clear();
                }
            }
            else
            {
                companyNameSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectCompanyNameSuggestion(string suggestion)
        {
            searchCompanyNameToFindThesesAsProfessor = suggestion;
            companyNameSuggestions.Clear();
            StateHasChanged();
        }

        private string searchSkillsInputToFindThesesAsProfessor = string.Empty;
        private List<string> skillSuggestionsToFindThesesAsProfessor = new List<string>();
        private List<string> selectedSkillsToFindThesesAsProfessor = new List<string>();

        private async Task HandleSkillsInputToFindThesesAsProfessor(ChangeEventArgs e)
        {
            searchSkillsInputToFindThesesAsProfessor = e.Value?.ToString().Trim() ?? string.Empty;
            skillSuggestionsToFindThesesAsProfessor = new();

            if (searchSkillsInputToFindThesesAsProfessor.Length >= 1)
            {
                try
                {
                    // Get unique skills from the Skills table that match the input
                    skillSuggestionsToFindThesesAsProfessor = await Task.Run(() =>
                        dbContext.Skills
                            .Where(s => s.SkillName.Contains(searchSkillsInputToFindThesesAsProfessor))
                            .Select(s => s.SkillName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση δεξιοτήτων: {ex.Message}");
                    skillSuggestionsToFindThesesAsProfessor = new List<string>();
                }
            }
            else
            {
                skillSuggestionsToFindThesesAsProfessor.Clear();
            }

            StateHasChanged();
        }

        private void SelectSkillSuggestionToFindThesesAsProfessor(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedSkillsToFindThesesAsProfessor.Contains(suggestion))
            {
                selectedSkillsToFindThesesAsProfessor.Add(suggestion);
                skillSuggestionsToFindThesesAsProfessor.Clear();
                searchSkillsInputToFindThesesAsProfessor = string.Empty;
            }
        }

        private void RemoveSelectedSkillToFindThesesAsProfessor(string skill)
        {
            selectedSkillsToFindThesesAsProfessor.Remove(skill);
            StateHasChanged();
        }

        private List<string> studentNameSuggestions = new List<string>();
        private List<string> studentSurnameSuggestions = new List<string>();

        private async Task HandleStudentNameInput(ChangeEventArgs e)
        {
            searchNameAsProfessorToFindStudent = e.Value?.ToString() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchNameAsProfessorToFindStudent))
            {
                studentNameSuggestions.Clear();
                return;
            }

            // Get unique student names from the database that match the input
            studentNameSuggestions = await dbContext.Students
                .Where(s => s.Name.Contains(searchNameAsProfessorToFindStudent))
                .Select(s => s.Name)
                .Distinct()
                .Take(10)
                .ToListAsync();
        }

        private async Task HandleStudentSurnameInput(ChangeEventArgs e)
        {
            searchSurnameAsProfessorToFindStudent = e.Value?.ToString() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchSurnameAsProfessorToFindStudent))
            {
                studentSurnameSuggestions.Clear();
                return;
            }

            // Get unique student surnames from the database that match the input
            studentSurnameSuggestions = await dbContext.Students
                .Where(s => s.Surname.Contains(searchSurnameAsProfessorToFindStudent))
                .Select(s => s.Surname)
                .Distinct()
                .Take(10)
                .ToListAsync();
        }

        private void SelectStudentNameSuggestion(string name)
        {
            searchNameAsProfessorToFindStudent = name;
            studentNameSuggestions.Clear();
            StateHasChanged();
        }

        private void SelectStudentSurnameSuggestion(string surname)
        {
            searchSurnameAsProfessorToFindStudent = surname;
            studentSurnameSuggestions.Clear();
            StateHasChanged();
        }


        private string searchCompanyActivityInputAsProfessorToFindCompany = string.Empty;
        private List<string> companyActivitySuggestions = new List<string>();
        private List<string> selectedCompanyActivities = new List<string>();
        private List<string> Activity = new List<string>
        {
            "Αθλητισμός",
            "Άλλο",
            "Βιοϊατρική",
            "Βιομηχανία(γενικά)",
            "Βιοτεχνολογία",
            "Γεωργία/Κτηνοτροφία",
            "Γραφιστική/Σχέδιο",
            "Δημόσιες Σχέσεις",
            "Δημόσιες Υπηρεσίες",
            "Διατροφή/Γαστρονομία",
            "Διαφήμιση",
            "Διαχείριση Ακινήτων",
            "Διαχείριση Ανθρώπινου Δυναμικού",
            "Εκδόσεις/Εκτυπώσεις",
            "Εκπαιδευτικοί Φορείς",
            "Ενέργεια",
            "Ηλεκτρονικά",
            "Ηλεκτρονικό Εμπόριο",
            "Θέρμανση/Κλιματισμός",
            "Ιατρική",
            "Κοινωνικές Υπηρεσίες",
            "Λιανικό Εμπόριο",
            "Λογισμικό",
            "Μάρκετινγκ",
            "Μέσα Μαζικής Ενημέρωσης",
            "Μεταφορές/Logistics",
            "Μηχανολογία",
            "Μικροηλεκτρονική",
            "Μοριακή Βιολογία",
            "Νομικά",
            "Οικολογία/Προστασία Περιβάλλοντος/Ανακύκλωση",
            "Οικονομία/Τραπεζική/Ασφάλειες",
            "Οπτικά",
            "Παροχή Διαδικτυακών Υπηρεσιών",
            "Πετρελαιοειδή",
            "Πληροφορική",
            "Σύμβουλοι Επιχειρήσεων",
            "Τέχνη/Μουσεία",
            "Τεχνικά Γραφεία-Εταιρίες/Κατασκευές",
            "Τηλεοπτικές Παραγωγές",
            "Τηλεπικοινωνίες",
            "Τοπική/Κεντρική Διοίκηση",
            "Τουριστικές Επιχειρήσεις",
            "Υφάσματα/Ένδυση/Μόδα",
            "Φωτογραφία",
            "Χημικά Προϊόντα/Φάρμακα",
        };

        private void HandleCompanyActivityInput(ChangeEventArgs e)
        {
            searchCompanyActivityInputAsProfessorToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchCompanyActivityInputAsProfessorToFindCompany))
            {
                companyActivitySuggestions.Clear();
                return;
            }

            // Filter activities from the predefined list
            companyActivitySuggestions = Activity
                .Where(activity => activity.Contains(searchCompanyActivityInputAsProfessorToFindCompany, StringComparison.OrdinalIgnoreCase))
                .Take(10)
                .ToList();
        }

        private void SelectCompanyActivitySuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedCompanyActivities.Contains(suggestion))
            {
                selectedCompanyActivities.Add(suggestion);
                companyActivitySuggestions.Clear();
                searchCompanyActivityInputAsProfessorToFindCompany = string.Empty;
                StateHasChanged();
            }
        }

        private void RemoveSelectedCompanyActivity(string activity)
        {
            selectedCompanyActivities.Remove(activity);
            StateHasChanged();
        }

        private string searchCompanyDesiredSkillsInputAsProfessorToFindCompany = string.Empty;
        private List<string> companyDesiredSkillsSuggestions = new List<string>();
        private List<string> selectedCompanyDesiredSkills = new List<string>();

        private async Task HandleCompanyDesiredSkillsInput(ChangeEventArgs e)
        {
            searchCompanyDesiredSkillsInputAsProfessorToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            companyDesiredSkillsSuggestions = new();

            if (searchCompanyDesiredSkillsInputAsProfessorToFindCompany.Length >= 1)
            {
                try
                {
                    // Get unique skills from the Skills table that match the input
                    companyDesiredSkillsSuggestions = await Task.Run(() =>
                        dbContext.Skills
                            .Where(s => s.SkillName.Contains(searchCompanyDesiredSkillsInputAsProfessorToFindCompany))
                            .Select(s => s.SkillName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση δεξιοτήτων: {ex.Message}");
                    companyDesiredSkillsSuggestions = new List<string>();
                }
            }
            else
            {
                companyDesiredSkillsSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectCompanyDesiredSkillSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedCompanyDesiredSkills.Contains(suggestion))
            {
                selectedCompanyDesiredSkills.Add(suggestion);
                companyDesiredSkillsSuggestions.Clear();
                searchCompanyDesiredSkillsInputAsProfessorToFindCompany = string.Empty;
            }
        }

        private void RemoveSelectedCompanyDesiredSkill(string skill)
        {
            selectedCompanyDesiredSkills.Remove(skill);
            StateHasChanged();
        }

        private string searchCompanyDesiredSkillsInputAsRGToFindCompany = string.Empty;
        private List<string> companyDesiredSkillsSuggestionsAsRG = new List<string>();
        private List<string> selectedCompanyDesiredSkillsAsRG = new List<string>();

        private async Task HandleCompanyDesiredSkillsInputAsRG(ChangeEventArgs e)
        {
            searchCompanyDesiredSkillsInputAsRGToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            companyDesiredSkillsSuggestionsAsRG = new();

            if (searchCompanyDesiredSkillsInputAsRGToFindCompany.Length >= 1)
            {
                try
                {
                    // Get unique skills from the Skills table that match the input
                    companyDesiredSkillsSuggestionsAsRG = await Task.Run(() =>
                        dbContext.Skills
                            .Where(s => s.SkillName.Contains(searchCompanyDesiredSkillsInputAsRGToFindCompany))
                            .Select(s => s.SkillName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση δεξιοτήτων: {ex.Message}");
                    companyDesiredSkillsSuggestionsAsRG = new List<string>();
                }
            }
            else
            {
                companyDesiredSkillsSuggestionsAsRG.Clear();
            }

            StateHasChanged();
        }

        private void SelectCompanyDesiredSkillSuggestionAsRG(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedCompanyDesiredSkillsAsRG.Contains(suggestion))
            {
                selectedCompanyDesiredSkillsAsRG.Add(suggestion);
                companyDesiredSkillsSuggestionsAsRG.Clear();
                searchCompanyDesiredSkillsInputAsRGToFindCompany = string.Empty;
            }
        }

        private void RemoveSelectedCompanyDesiredSkillAsRG(string skill)
        {
            selectedCompanyDesiredSkillsAsRG.Remove(skill);
            StateHasChanged();
        }

        private HashSet<int> ExpandedAreasForCompanyJob = new HashSet<int>();
        private Dictionary<string, List<string>> SelectedSubFieldsForCompanyJob = new Dictionary<string, List<string>>();
        private List<string> SelectedAreasAndSubFieldsWhenUploadJobAsCompany = new List<string>();
        private void ToggleSubFieldsForCompanyJob(Area area)
        {
            if (ExpandedAreasForCompanyJob.Contains(area.Id))
            {
                ExpandedAreasForCompanyJob.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForCompanyJob.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForCompanyJob(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
            
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadJobAsCompany.Contains(area))
                {
                    SelectedAreasWhenUploadJobAsCompany.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadJobAsCompany.Remove(area);
                
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForCompanyJob.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForCompanyJob.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForCompanyJob(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
            
            if (!SelectedSubFieldsForCompanyJob.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForCompanyJob[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForCompanyJob[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForCompanyJob[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForCompanyJob[area.AreaName].Remove(subField);
                
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForCompanyJob[area.AreaName].Any())
                {
                    SelectedSubFieldsForCompanyJob.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool HasAnySelectionForCompanyJob()
        {
            return SelectedAreasWhenUploadJobAsCompany.Any() || SelectedSubFieldsForCompanyJob.Any();
        }


        private bool IsAreaSelectedForCompanyJob(Area area)
        {
            return SelectedAreasAndSubFieldsWhenUploadJobAsCompany.Contains(area.AreaName);
        }

        private bool IsSubFieldSelectedForCompanyJob(Area area, string subField)
        {
            return SelectedSubFieldsForCompanyJob.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForCompanyJob[area.AreaName].Contains(subField);
        }


        private bool showCheckboxesForEditCompanyJob = false;
        private HashSet<int> ExpandedAreasForEditCompanyJob = new HashSet<int>();
        private Dictionary<string, List<string>> SelectedSubFieldsForEditCompanyJob = new Dictionary<string, List<string>>();

        // Edit modal methods
        private void ToggleCheckboxesForEditCompanyJob()
        {
            showCheckboxesForEditCompanyJob = !showCheckboxesForEditCompanyJob;
            StateHasChanged();
        }

        private void ToggleSubFieldsForEditCompanyJob(Area area)
        {
            if (ExpandedAreasForEditCompanyJob.Contains(area.Id))
            {
                ExpandedAreasForEditCompanyJob.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditCompanyJob.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditCompanyJob(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
            
            if (isChecked)
            {
                if (!SelectedAreasToEditForCompanyJob.Contains(area))
                {
                    SelectedAreasToEditForCompanyJob.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForCompanyJob.Remove(area);
                
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditCompanyJob.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditCompanyJob.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditCompanyJob(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
            
            if (!SelectedSubFieldsForEditCompanyJob.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditCompanyJob[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditCompanyJob[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditCompanyJob[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditCompanyJob[area.AreaName].Remove(subField);
                
                if (!SelectedSubFieldsForEditCompanyJob[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditCompanyJob.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditCompanyJob(Area area)
        {
            return SelectedAreasToEditForCompanyJob.Contains(area);
        }

        private bool IsSubFieldSelectedForEditCompanyJob(Area area, string subField)
        {
            return SelectedSubFieldsForEditCompanyJob.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditCompanyJob[area.AreaName].Contains(subField);
        }

        private bool showCheckboxesForCompanyEvent = false; // Start as closed
        private HashSet<int> ExpandedAreasForCompanyEvent = new HashSet<int>();
        private Dictionary<string, List<string>> SelectedSubFieldsForCompanyEvent = new Dictionary<string, List<string>>();
        private List<string> SelectedAreasAndSubFieldsWhenUploadEventAsCompany = new List<string>();
        private void ToggleCheckboxesForCompanyEvent()
        {
            showCheckboxesForCompanyEvent = !showCheckboxesForCompanyEvent;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForCompanyEvent(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadEventAsCompany.Contains(area))
                {
                    SelectedAreasWhenUploadEventAsCompany.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadEventAsCompany.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForCompanyEvent.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForCompanyEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForCompanyEvent(Area area)
        {
            return SelectedAreasWhenUploadEventAsCompany.Contains(area);
        }

        private void ToggleSubFieldsForCompanyEvent(Area area)
        {
            if (ExpandedAreasForCompanyEvent.Contains(area.Id))
            {
                ExpandedAreasForCompanyEvent.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForCompanyEvent.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForCompanyEvent(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForCompanyEvent.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForCompanyEvent[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForCompanyEvent[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForCompanyEvent[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForCompanyEvent[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForCompanyEvent[area.AreaName].Any())
                {
                    SelectedSubFieldsForCompanyEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForCompanyEvent(Area area, string subField)
        {
            return SelectedSubFieldsForCompanyEvent.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForCompanyEvent[area.AreaName].Contains(subField);
        }

        private bool HasAnySelectionForCompanyEvent()
        {
            return SelectedAreasWhenUploadEventAsCompany.Any() || SelectedSubFieldsForCompanyEvent.Any();
        }

        private Dictionary<string, List<string>> SelectedSubFieldsForEditCompanyEvent = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditCompanyEvent = new HashSet<int>();
        private bool showCheckboxesForEditCompanyEvent = false;

        // Edit modal methods for Company Events
        private void ToggleCheckboxesForEditCompanyEvent()
        {
            showCheckboxesForEditCompanyEvent = !showCheckboxesForEditCompanyEvent;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditCompanyEvent(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForCompanyEvent.Contains(area))
                {
                    SelectedAreasToEditForCompanyEvent.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForCompanyEvent.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditCompanyEvent.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditCompanyEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditCompanyEvent(Area area)
        {
            return SelectedAreasToEditForCompanyEvent.Contains(area);
        }

        private void ToggleSubFieldsForEditCompanyEvent(Area area)
        {
            if (ExpandedAreasForEditCompanyEvent.Contains(area.Id))
            {
                ExpandedAreasForEditCompanyEvent.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditCompanyEvent.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditCompanyEvent(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditCompanyEvent.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditCompanyEvent[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditCompanyEvent[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditCompanyEvent[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditCompanyEvent[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditCompanyEvent[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditCompanyEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditCompanyEvent(Area area, string subField)
        {
            return SelectedSubFieldsForEditCompanyEvent.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditCompanyEvent[area.AreaName].Contains(subField);
        }

        private Dictionary<string, List<string>> SelectedSubFieldsForCompanyInternship = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForCompanyInternship = new HashSet<int>();
        private bool showCheckboxesForCompanyInternship = false;


        // Area checkbox change handler
        private void OnAreaCheckedChangedForCompanyInternship(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadInternshipAsCompany.Contains(area))
                {
                    SelectedAreasWhenUploadInternshipAsCompany.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadInternshipAsCompany.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForCompanyInternship.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForCompanyInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if area is selected
        private bool IsAreaSelectedForCompanyInternship(Area area)
        {
            return SelectedAreasWhenUploadInternshipAsCompany.Contains(area);
        }

        // Toggle subfields expansion
        private void ToggleSubFieldsForCompanyInternship(Area area)
        {
            if (ExpandedAreasForCompanyInternship.Contains(area.Id))
            {
                ExpandedAreasForCompanyInternship.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForCompanyInternship.Add(area.Id);
            }
            StateHasChanged();
        }

        // Subfield checkbox change handler
        private void OnSubFieldCheckedChangedForCompanyInternship(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForCompanyInternship.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForCompanyInternship[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForCompanyInternship[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForCompanyInternship[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForCompanyInternship[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForCompanyInternship[area.AreaName].Any())
                {
                    SelectedSubFieldsForCompanyInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if subfield is selected
        private bool IsSubFieldSelectedForCompanyInternship(Area area, string subField)
        {
            return SelectedSubFieldsForCompanyInternship.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForCompanyInternship[area.AreaName].Contains(subField);
        }

        // Check if there are any selections
        private bool HasAnySelectionForCompanyInternship()
        {
            return SelectedAreasWhenUploadInternshipAsCompany.Any() || SelectedSubFieldsForCompanyInternship.Any();
        }

        private Dictionary<string, List<string>> SelectedSubFieldsForEditCompanyInternship = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditCompanyInternship = new HashSet<int>();
        private bool showCheckboxesForEditCompanyInternship = false;
        private void ToggleCheckboxesForEditCompanyInternship()
        {
            showCheckboxesForEditCompanyInternship = !showCheckboxesForEditCompanyInternship;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditCompanyInternship(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForCompanyInternship.Contains(area))
                {
                    SelectedAreasToEditForCompanyInternship.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForCompanyInternship.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditCompanyInternship.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditCompanyInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditCompanyInternship(Area area)
        {
            return SelectedAreasToEditForCompanyInternship.Contains(area);
        }

        private void ToggleSubFieldsForEditCompanyInternship(Area area)
        {
            if (ExpandedAreasForEditCompanyInternship.Contains(area.Id))
            {
                ExpandedAreasForEditCompanyInternship.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditCompanyInternship.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditCompanyInternship(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditCompanyInternship.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditCompanyInternship[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditCompanyInternship[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditCompanyInternship[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditCompanyInternship[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditCompanyInternship[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditCompanyInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditCompanyInternship(Area area, string subField)
        {
            return SelectedSubFieldsForEditCompanyInternship.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditCompanyInternship[area.AreaName].Contains(subField);
        }

        // State variables for Company Thesis
        private bool showCheckboxesForCompanyThesis = false;
        private Dictionary<string, List<string>> SelectedSubFieldsForCompanyThesis = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForCompanyThesis = new HashSet<int>();

        // Toggle checkbox container
        private void ToggleCheckboxesForCompanyThesis()
        {
            showCheckboxesForCompanyThesis = !showCheckboxesForCompanyThesis;
            StateHasChanged();
        }

        // Area checkbox change handler
        private void OnAreaCheckedChangedForCompanyThesis(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadThesisAsCompany.Contains(area))
                {
                    SelectedAreasWhenUploadThesisAsCompany.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadThesisAsCompany.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForCompanyThesis.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForCompanyThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if area is selected
        private bool IsAreaSelectedForCompanyThesis(Area area)
        {
            return SelectedAreasWhenUploadThesisAsCompany.Contains(area);
        }

        // Toggle subfields expansion
        private void ToggleSubFieldsForCompanyThesis(Area area)
        {
            if (ExpandedAreasForCompanyThesis.Contains(area.Id))
            {
                ExpandedAreasForCompanyThesis.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForCompanyThesis.Add(area.Id);
            }
            StateHasChanged();
        }

        // Subfield checkbox change handler
        private void OnSubFieldCheckedChangedForCompanyThesis(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForCompanyThesis.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForCompanyThesis[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForCompanyThesis[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForCompanyThesis[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForCompanyThesis[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForCompanyThesis[area.AreaName].Any())
                {
                    SelectedSubFieldsForCompanyThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if subfield is selected
        private bool IsSubFieldSelectedForCompanyThesis(Area area, string subField)
        {
            return SelectedSubFieldsForCompanyThesis.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForCompanyThesis[area.AreaName].Contains(subField);
        }

        // Check if there are any selections
        private bool HasAnySelectionForCompanyThesis()
        {
            return SelectedAreasWhenUploadThesisAsCompany.Any() || SelectedSubFieldsForCompanyThesis.Any();
        }

        // Add these variables to your component
        private Dictionary<string, List<string>> SelectedSubFieldsForEditCompanyThesis = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditCompanyThesis = new HashSet<int>();
        private bool showCheckboxesForEditCompanyThesis = false;
        private void ToggleCheckboxesForEditCompanyThesis()
        {
            showCheckboxesForEditCompanyThesis = !showCheckboxesForEditCompanyThesis;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditCompanyThesis(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForCompanyThesis.Contains(area))
                {
                    SelectedAreasToEditForCompanyThesis.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForCompanyThesis.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditCompanyThesis.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditCompanyThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditCompanyThesis(Area area)
        {
            return SelectedAreasToEditForCompanyThesis.Contains(area);
        }

        private void ToggleSubFieldsForEditCompanyThesis(Area area)
        {
            if (ExpandedAreasForEditCompanyThesis.Contains(area.Id))
            {
                ExpandedAreasForEditCompanyThesis.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditCompanyThesis.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditCompanyThesis(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditCompanyThesis.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditCompanyThesis[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditCompanyThesis[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditCompanyThesis[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditCompanyThesis[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditCompanyThesis[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditCompanyThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditCompanyThesis(Area area, string subField)
        {
            return SelectedSubFieldsForEditCompanyThesis.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditCompanyThesis[area.AreaName].Contains(subField);
        }

        // State variables for Professor Event
        private bool showCheckboxesForProfessorEvent = false;
        private Dictionary<string, List<string>> SelectedSubFieldsForProfessorEvent = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForProfessorEvent = new HashSet<int>();

        // Toggle checkbox container
        private void ToggleCheckboxesForProfessorEvent()
        {
            showCheckboxesForProfessorEvent = !showCheckboxesForProfessorEvent;
            StateHasChanged();
        }

        // Area checkbox change handler
        private void OnAreaCheckedChangedForProfessorEvent(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadEventAsProfessor.Contains(area))
                {
                    SelectedAreasWhenUploadEventAsProfessor.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadEventAsProfessor.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForProfessorEvent.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForProfessorEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if area is selected
        private bool IsAreaSelectedForProfessorEvent(Area area)
        {
            return SelectedAreasWhenUploadEventAsProfessor.Contains(area);
        }

        // Toggle subfields expansion
        private void ToggleSubFieldsForProfessorEvent(Area area)
        {
            if (ExpandedAreasForProfessorEvent.Contains(area.Id))
            {
                ExpandedAreasForProfessorEvent.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForProfessorEvent.Add(area.Id);
            }
            StateHasChanged();
        }

        // Subfield checkbox change handler
        private void OnSubFieldCheckedChangedForProfessorEvent(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForProfessorEvent.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForProfessorEvent[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForProfessorEvent[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForProfessorEvent[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForProfessorEvent[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForProfessorEvent[area.AreaName].Any())
                {
                    SelectedSubFieldsForProfessorEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if subfield is selected
        private bool IsSubFieldSelectedForProfessorEvent(Area area, string subField)
        {
            return SelectedSubFieldsForProfessorEvent.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForProfessorEvent[area.AreaName].Contains(subField);
        }

        // Check if there are any selections
        private bool HasAnySelectionForProfessorEvent()
        {
            return SelectedAreasWhenUploadEventAsProfessor.Any() || SelectedSubFieldsForProfessorEvent.Any();
        }

        // Add these variables to your component
        private Dictionary<string, List<string>> SelectedSubFieldsForEditProfessorEvent = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditProfessorEvent = new HashSet<int>();
        private bool showCheckboxesForEditProfessorEvent = false;
        // Edit modal methods for Professor Event
        private void ToggleCheckboxesForEditProfessorEvent()
        {
            showCheckboxesForEditProfessorEvent = !showCheckboxesForEditProfessorEvent;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditProfessorEvent(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForProfessorEvent.Contains(area))
                {
                    SelectedAreasToEditForProfessorEvent.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForProfessorEvent.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditProfessorEvent.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditProfessorEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditProfessorEvent(Area area)
        {
            return SelectedAreasToEditForProfessorEvent.Contains(area);
        }

        private void ToggleSubFieldsForEditProfessorEvent(Area area)
        {
            if (ExpandedAreasForEditProfessorEvent.Contains(area.Id))
            {
                ExpandedAreasForEditProfessorEvent.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditProfessorEvent.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditProfessorEvent(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditProfessorEvent.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditProfessorEvent[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditProfessorEvent[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditProfessorEvent[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditProfessorEvent[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditProfessorEvent[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditProfessorEvent.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditProfessorEvent(Area area, string subField)
        {
            return SelectedSubFieldsForEditProfessorEvent.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditProfessorEvent[area.AreaName].Contains(subField);
        }

        // State variables for Professor Thesis
        private bool showCheckboxesForProfessorThesis = false;
        private Dictionary<string, List<string>> SelectedSubFieldsForProfessorThesis = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForProfessorThesis = new HashSet<int>();

        // Toggle checkbox container
        private void ToggleCheckboxesForProfessorThesis()
        {
            showCheckboxesForProfessorThesis = !showCheckboxesForProfessorThesis;
            StateHasChanged();
        }

        // Area checkbox change handler
        private void OnAreaCheckedChangedForProfessorThesis(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!selectedThesisAreasForProfessor.Contains(area))
                {
                    selectedThesisAreasForProfessor.Add(area);
                }
            }
            else
            {
                selectedThesisAreasForProfessor.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForProfessorThesis.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForProfessorThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if area is selected
        private bool IsAreaSelectedForProfessorThesis(Area area)
        {
            return selectedThesisAreasForProfessor.Contains(area);
        }

        // Toggle subfields expansion
        private void ToggleSubFieldsForProfessorThesis(Area area)
        {
            if (ExpandedAreasForProfessorThesis.Contains(area.Id))
            {
                ExpandedAreasForProfessorThesis.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForProfessorThesis.Add(area.Id);
            }
            StateHasChanged();
        }

        // Subfield checkbox change handler
        private void OnSubFieldCheckedChangedForProfessorThesis(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForProfessorThesis.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForProfessorThesis[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForProfessorThesis[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForProfessorThesis[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForProfessorThesis[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForProfessorThesis[area.AreaName].Any())
                {
                    SelectedSubFieldsForProfessorThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if subfield is selected
        private bool IsSubFieldSelectedForProfessorThesis(Area area, string subField)
        {
            return SelectedSubFieldsForProfessorThesis.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForProfessorThesis[area.AreaName].Contains(subField);
        }

        // Check if there are any selections
        private bool HasAnySelectionForProfessorThesis()
        {
            return selectedThesisAreasForProfessor.Any() || SelectedSubFieldsForProfessorThesis.Any();
        }

        // Add these variables to your component
        private Dictionary<string, List<string>> SelectedSubFieldsForEditProfessorThesis = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditProfessorThesis = new HashSet<int>();
        private bool showCheckboxesForEditProfessorThesis = false;
        private void ToggleCheckboxesForEditProfessorThesis()
        {
            showCheckboxesForEditProfessorThesis = !showCheckboxesForEditProfessorThesis;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditProfessorThesis(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForProfessorThesis.Contains(area))
                {
                    SelectedAreasToEditForProfessorThesis.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForProfessorThesis.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditProfessorThesis.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditProfessorThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditProfessorThesis(Area area)
        {
            return SelectedAreasToEditForProfessorThesis.Contains(area);
        }

        private void ToggleSubFieldsForEditProfessorThesis(Area area)
        {
            if (ExpandedAreasForEditProfessorThesis.Contains(area.Id))
            {
                ExpandedAreasForEditProfessorThesis.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditProfessorThesis.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditProfessorThesis(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditProfessorThesis.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditProfessorThesis[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditProfessorThesis[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditProfessorThesis[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditProfessorThesis[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditProfessorThesis[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditProfessorThesis.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditProfessorThesis(Area area, string subField)
        {
            return SelectedSubFieldsForEditProfessorThesis.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditProfessorThesis[area.AreaName].Contains(subField);
        }

        // State variables for Professor Internship
        private bool showCheckboxesForProfessorInternship = false;
        private Dictionary<string, List<string>> SelectedSubFieldsForProfessorInternship = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForProfessorInternship = new HashSet<int>();
        private void ToggleCheckboxesForProfessorInternship()
        {
            showCheckboxesForProfessorInternship = !showCheckboxesForProfessorInternship;
            StateHasChanged();
        }

        // Area checkbox change handler
        private void OnAreaCheckedChangedForProfessorInternship(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasWhenUploadInternshipAsProfessor.Contains(area))
                {
                    SelectedAreasWhenUploadInternshipAsProfessor.Add(area);
                }
            }
            else
            {
                SelectedAreasWhenUploadInternshipAsProfessor.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForProfessorInternship.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForProfessorInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if area is selected
        private bool IsAreaSelectedForProfessorInternship(Area area)
        {
            return SelectedAreasWhenUploadInternshipAsProfessor.Contains(area);
        }

        // Toggle subfields expansion
        private void ToggleSubFieldsForProfessorInternship(Area area)
        {
            if (ExpandedAreasForProfessorInternship.Contains(area.Id))
            {
                ExpandedAreasForProfessorInternship.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForProfessorInternship.Add(area.Id);
            }
            StateHasChanged();
        }

        // Subfield checkbox change handler
        private void OnSubFieldCheckedChangedForProfessorInternship(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForProfessorInternship.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForProfessorInternship[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForProfessorInternship[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForProfessorInternship[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForProfessorInternship[area.AreaName].Remove(subField);
            
                // Remove the area from subfields dictionary if no subfields are selected
                if (!SelectedSubFieldsForProfessorInternship[area.AreaName].Any())
                {
                    SelectedSubFieldsForProfessorInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        // Check if subfield is selected
        private bool IsSubFieldSelectedForProfessorInternship(Area area, string subField)
        {
            return SelectedSubFieldsForProfessorInternship.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForProfessorInternship[area.AreaName].Contains(subField);
        }

        // Check if there are any selections
        private bool HasAnySelectionForProfessorInternship()
        {
            return SelectedAreasWhenUploadInternshipAsProfessor.Any() || SelectedSubFieldsForProfessorInternship.Any();
        }

        // Add these variables to your component
        private Dictionary<string, List<string>> SelectedSubFieldsForEditProfessorInternship = new Dictionary<string, List<string>>();
        private HashSet<int> ExpandedAreasForEditProfessorInternship = new HashSet<int>();
        private bool showCheckboxesForEditProfessorInternship = false;
        private void ToggleCheckboxesForEditProfessorInternship()
        {
            showCheckboxesForEditProfessorInternship = !showCheckboxesForEditProfessorInternship;
            StateHasChanged();
        }

        private void OnAreaCheckedChangedForEditProfessorInternship(ChangeEventArgs e, Area area)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                if (!SelectedAreasToEditForProfessorInternship.Contains(area))
                {
                    SelectedAreasToEditForProfessorInternship.Add(area);
                }
            }
            else
            {
                SelectedAreasToEditForProfessorInternship.Remove(area);
            
                // Remove all subfields for this area when area is deselected
                if (SelectedSubFieldsForEditProfessorInternship.ContainsKey(area.AreaName))
                {
                    SelectedSubFieldsForEditProfessorInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsAreaSelectedForEditProfessorInternship(Area area)
        {
            return SelectedAreasToEditForProfessorInternship.Contains(area);
        }

        private void ToggleSubFieldsForEditProfessorInternship(Area area)
        {
            if (ExpandedAreasForEditProfessorInternship.Contains(area.Id))
            {
                ExpandedAreasForEditProfessorInternship.Remove(area.Id);
            }
            else
            {
                ExpandedAreasForEditProfessorInternship.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnSubFieldCheckedChangedForEditProfessorInternship(ChangeEventArgs e, Area area, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (!SelectedSubFieldsForEditProfessorInternship.ContainsKey(area.AreaName))
            {
                SelectedSubFieldsForEditProfessorInternship[area.AreaName] = new List<string>();
            }

            if (isChecked)
            {
                if (!SelectedSubFieldsForEditProfessorInternship[area.AreaName].Contains(subField))
                {
                    SelectedSubFieldsForEditProfessorInternship[area.AreaName].Add(subField);
                }
            }
            else
            {
                SelectedSubFieldsForEditProfessorInternship[area.AreaName].Remove(subField);
            
                if (!SelectedSubFieldsForEditProfessorInternship[area.AreaName].Any())
                {
                    SelectedSubFieldsForEditProfessorInternship.Remove(area.AreaName);
                }
            }
            StateHasChanged();
        }

        private bool IsSubFieldSelectedForEditProfessorInternship(Area area, string subField)
        {
            return SelectedSubFieldsForEditProfessorInternship.ContainsKey(area.AreaName) && 
                SelectedSubFieldsForEditProfessorInternship[area.AreaName].Contains(subField);
        }

        // Add these variables to your component
        private HashSet<string> selectedThesisSubFields = new HashSet<string>();
        private HashSet<int> expandedThesisAreas = new HashSet<int>();
        private bool isThesisAreasVisible = false;
        private void ToggleThesisAreasVisibility()
        {
            isThesisAreasVisible = !isThesisAreasVisible;
            StateHasChanged();
        }

        private void ToggleThesisSubFields(Area area)
        {
            if (expandedThesisAreas.Contains(area.Id))
            {
                expandedThesisAreas.Remove(area.Id);
            }
            else
            {
                expandedThesisAreas.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnThesisAreaCheckboxChanged(ChangeEventArgs e, string areaName)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedThesisAreas.Add(areaName);
            }
            else
            {
                selectedThesisAreas.Remove(areaName);
            
                // Also remove any subfields that belong to this area
                var area = Areas.FirstOrDefault(a => a.AreaName == areaName);
                if (area != null && !string.IsNullOrEmpty(area.AreaSubFields))
                {
                    var subFields = area.AreaSubFields.Split(',').Select(s => s.Trim()).ToList();
                    foreach (var subField in subFields)
                    {
                        selectedThesisSubFields.Remove(subField);
                    }
                }
            }
            StateHasChanged();
        }

        private void OnThesisSubFieldCheckboxChanged(ChangeEventArgs e, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedThesisSubFields.Add(subField);
            }
            else
            {
                selectedThesisSubFields.Remove(subField);
            }
            StateHasChanged();
        }

        // Add these variables to your component
        private HashSet<string> selectedPositionAreas = new HashSet<string>();
        private HashSet<string> selectedPositionSubFields = new HashSet<string>();
        private HashSet<int> expandedPositionAreas = new HashSet<int>();
        private bool isPositionAreasVisible = false;
        private void TogglePositionAreasVisibility()
        {
            isPositionAreasVisible = !isPositionAreasVisible;
            StateHasChanged();
        }

        private void TogglePositionSubFields(Area area)
        {
            if (expandedPositionAreas.Contains(area.Id))
            {
                expandedPositionAreas.Remove(area.Id);
            }
            else
            {
                expandedPositionAreas.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnPositionAreaCheckboxChanged(ChangeEventArgs e, string areaName)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedPositionAreas.Add(areaName);
            }
            else
            {
                selectedPositionAreas.Remove(areaName);
            
                // Also remove any subfields that belong to this area
                var area = Areas.FirstOrDefault(a => a.AreaName == areaName);
                if (area != null && !string.IsNullOrEmpty(area.AreaSubFields))
                {
                    var subFields = area.AreaSubFields.Split(',').Select(s => s.Trim()).ToList();
                    foreach (var subField in subFields)
                    {
                        selectedPositionSubFields.Remove(subField);
                    }
                }
            }
            StateHasChanged();
        }

        private void OnPositionSubFieldCheckboxChanged(ChangeEventArgs e, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedPositionSubFields.Add(subField);
            }
            else
            {
                selectedPositionSubFields.Remove(subField);
            }
            StateHasChanged();
        }

        // Add these variables to your component
        private HashSet<string> selectedInternshipAreas = new HashSet<string>();
        private HashSet<string> selectedInternshipSubFields = new HashSet<string>();
        private HashSet<int> expandedInternshipAreas = new HashSet<int>();
        private bool isInternshipAreasVisible = false;
        private void ToggleInternshipAreasVisibility()
        {
            isInternshipAreasVisible = !isInternshipAreasVisible;
            StateHasChanged();
        }

        private void ToggleInternshipSubFields(Area area)
        {
            if (expandedInternshipAreas.Contains(area.Id))
            {
                expandedInternshipAreas.Remove(area.Id);
            }
            else
            {
                expandedInternshipAreas.Add(area.Id);
            }
            StateHasChanged();
        }

        private void OnInternshipAreaCheckboxChanged(ChangeEventArgs e, string areaName)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedInternshipAreas.Add(areaName);
            }
            else
            {
                selectedInternshipAreas.Remove(areaName);
            
                var area = Areas.FirstOrDefault(a => a.AreaName == areaName);
                if (area != null && !string.IsNullOrEmpty(area.AreaSubFields))
                {
                    var subFields = area.AreaSubFields.Split(',').Select(s => s.Trim()).ToList();
                    foreach (var subField in subFields)
                    {
                        selectedInternshipSubFields.Remove(subField);
                    }
                }
            }
            StateHasChanged();
        }

        private void OnInternshipSubFieldCheckboxChanged(ChangeEventArgs e, string subField)
        {
            var isChecked = (bool)e.Value!;
        
            if (isChecked)
            {
                selectedInternshipSubFields.Add(subField);
            }
            else
            {
                selectedInternshipSubFields.Remove(subField);
            }
            StateHasChanged();
        }

        private async Task ForceNewTab(string researchGroupId)
        {
            var url = $"/researchGroupDetails/{researchGroupId}";
            await JS.InvokeVoidAsync("eval", $"window.open('{url}', '_blank', 'noopener,noreferrer');");
        }

        private async Task LoadCurrentResearchGroup()
        {
            try
            {
                // Get the research group based on current user's email
                currentResearchGroup = await dbContext.ResearchGroups
                    .FirstOrDefaultAsync(rg => rg.ResearchGroupEmail == CurrentUserEmail);
                    
                if (currentResearchGroup == null)
                {
                    Console.WriteLine("Research group not found for current user");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading research group: {ex.Message}");
            }
        }

        private bool isLoadingDetails = false;
        private bool isLoadingStatistics = false;
        private async Task NavigateToResearchGroupDetails()
        {
            isLoadingDetails = true;
            StateHasChanged(); 
            
            await Task.Delay(100);
            
            NavigationManager.NavigateTo($"researchGroupDetails/{currentResearchGroup.ResearchGroup_UniqueID}");
        }

        private async Task ReloadEventsWithCurrentFilter()
        {
            if (isCompanyEventsVisibleToSeeAsStudent || isProfessorEventsVisibleToSeeAsStudent)
            {
                await LoadEventsWithFilter();
            }
        }

        private async Task LoadEventsWithFilter()
        {
            if (isLoadingEvents) return;

            isLoadingEvents = true;
            StateHasChanged();

            try
            {
                var today = DateTime.Today;
            
                // Load company events with date filtering
                var companyQuery = dbContext.CompanyEvents
                    .Where(e => e.CompanyEventStatus == "Δημοσιευμένη");

                // Apply date filter based on selection
                if (selectedEventStatus == "upcoming")
                {
                    companyQuery = companyQuery.Where(e => e.CompanyEventActiveDate >= today);
                }
                else if (selectedEventStatus == "past") 
                {
                    companyQuery = companyQuery.Where(e => e.CompanyEventActiveDate < today);
                }
                // If it's "all", no date filter is applied

                companyEventsToSeeAsStudent = await companyQuery.ToListAsync();

                // Load professor events with date filtering
                var professorQuery = dbContext.ProfessorEvents
                    .Include(e => e.Professor)
                    .Where(e => e.ProfessorEventStatus == "Δημοσιευμένη");

                // Apply date filter based on selection
                if (selectedEventStatus == "upcoming")
                {
                    professorQuery = professorQuery.Where(e => e.ProfessorEventActiveDate >= today);
                }
                else if (selectedEventStatus == "past")
                {
                    professorQuery = professorQuery.Where(e => e.ProfessorEventActiveDate < today);
                }
                // If it's "all", no date filter is applied

                professorEventsToSeeAsStudent = await professorQuery.ToListAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading events: {ex.Message}");
                companyEventsToSeeAsStudent = new List<CompanyEvent>();
                professorEventsToSeeAsStudent = new List<ProfessorEvent>();
            }
            finally
            {
                isLoadingEvents = false;
                StateHasChanged();
            }
        }

        private async Task OnEventStatusChanged(ChangeEventArgs e)
        {
            selectedEventStatus = e.Value?.ToString() ?? "upcoming";
            await ReloadEventsWithCurrentFilter();
        }

        private bool IsPastEvent(DateTime? eventDate)
        {
            if (eventDate == null) return true; 
        
            return eventDate.Value.Date < DateTime.Today;
        }

        private void OnPhoneNumberInput(ChangeEventArgs e)
        {
            var input = e.Value?.ToString() ?? "";
        
            // Remove all non-digit characters
            var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
            // Limit to 10 digits
            if (digitsOnly.Length > 10)
            {
                digitsOnly = digitsOnly.Substring(0, 10);
            }
        
            job.PositionContactTelephonePerson = digitsOnly;
        }

        private void OnCompanyCreateInternshipPhoneNumberInput(ChangeEventArgs e)
        {
            var input = e.Value?.ToString() ?? "";
        
            // Remove all non-digit characters
            var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
            // Limit to 10 digits
            if (digitsOnly.Length > 10)
            {
                digitsOnly = digitsOnly.Substring(0, 10);
            }
        
            companyInternship.CompanyInternshipContactTelephonePerson = digitsOnly;
        }

        private void OnCompanyCreateThesisPhoneNumberInput(ChangeEventArgs e)
        {
            var input = e.Value?.ToString() ?? "";
        
            // Remove all non-digit characters
            var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
            // Limit to 10 digits
            if (digitsOnly.Length > 10)
            {
                digitsOnly = digitsOnly.Substring(0, 10);
            }
        
            thesis.CompanyThesisContactPersonTelephone = digitsOnly;
        }

        private void OnCompanyCreateEventPhoneNumberInput(ChangeEventArgs e)
        {
            var input = e.Value?.ToString() ?? "";
        
            // Remove all non-digit characters
            var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
            // Limit to 10 digits
            if (digitsOnly.Length > 10)
            {
                digitsOnly = digitsOnly.Substring(0, 10);
            }
        
            companyEvent.CompanyEventResponsiblePersonTelephone = digitsOnly;
        }

        private int remainingCharactersInInternshipFieldUploadAsProfessor = 120;
        private void CheckCharacterLimitInInternshipFieldUploadAsProfessor()
        {
            if (professorInternship?.ProfessorInternshipTitle != null)
            {
                remainingCharactersInInternshipFieldUploadAsProfessor = 120 - professorInternship.ProfessorInternshipTitle.Length;
            }
            else
            {
                remainingCharactersInInternshipFieldUploadAsProfessor = 120;
            }
        }

        private async Task OpenResearchGroupJS(string researchGroupId)
        {
            await JS.InvokeVoidAsync("openResearchGroup", researchGroupId);
        }

        // State variables for Professor Research Group Search
        private string searchResearchGroupNameAsProfessorToFindResearchGroup = "";
        private string searchResearchGroupSchoolAsProfessorToFindResearchGroup = "";
        private string searchResearchGroupUniversityDepartmentAsProfessorToFindResearchGroup = "";
        private string searchResearchGroupAreasAsProfessorToFindResearchGroup = "";
        private string searchResearchGroupSkillsAsProfessorToFindResearchGroup = "";
        private string searchResearchGroupKeywordsAsProfessorToFindResearchGroup = "";

        private List<string> professorSelectedResearchGroupAreas = new();
        private List<string> professorSelectedResearchGroupSkills = new();
        private List<string> professorResearchGroupNameSuggestions = new();
        private List<string> professorResearchGroupAreasSuggestions = new();
        private List<string> professorResearchGroupSkillsSuggestions = new();

        private List<ResearchGroup> professorSearchResultsToFindResearchGroup = new();
        private bool professorHasSearchedForResearchGroups = false;

        // Pagination variables for Professor
        private int professorCurrentResearchGroupPage_SearchForResearchGroups = 1;
        private int professorResearchGroupsPerPage_SearchForResearchGroups = 10;
        private readonly int[] professorPageSizeOptions_SearchForResearchGroups = { 5, 10, 20, 50 };

        // Data lists
        private List<string> professorResearchGroupSchools = new();
        private List<string> professorFilteredDepartments = new();

        // Modal variables for Professor
        private ResearchGroup selectedResearchGroupWhenSearchForResearchGroupsAsProfessor;
        private bool showResearchGroupDetailsModalWhenSearchForResearchGroupsAsProfessor = false;
        private List<ResearchGroup_Professors> professorFacultyMembers = new();
        private List<ResearchGroup_NonFacultyMembers> professorNonFacultyMembers = new();
        private int professorPatentsCount = 0;
        private int professorActiveResearchActionsCount = 0;
        private List<Company> professorSpinOffCompanies = new();


        // Methods for handling inputs and selections for Professor
        private async Task HandleProfessorResearchGroupNameInput(ChangeEventArgs e)
        {
            searchResearchGroupNameAsProfessorToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            professorResearchGroupNameSuggestions = new List<string>();

            if (searchResearchGroupNameAsProfessorToFindResearchGroup.Length >= 1)
            {
                try
                {
                    professorResearchGroupNameSuggestions = await Task.Run(() =>
                        dbContext.ResearchGroups
                            .Where(rg => rg.ResearchGroupName.Contains(searchResearchGroupNameAsProfessorToFindResearchGroup))
                            .Select(rg => rg.ResearchGroupName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Ονομάτων Ερευνητικών Ομάδων: {ex.Message}");
                    professorResearchGroupNameSuggestions = new List<string>();
                }
            }
            else
            {
                professorResearchGroupNameSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void SelectProfessorResearchGroupNameSuggestion(string suggestion)
        {
            searchResearchGroupNameAsProfessorToFindResearchGroup = suggestion;
            professorResearchGroupNameSuggestions.Clear();
        }

        // Method to handle school selection change for Professor
        private async Task OnProfessorSchoolSelectionChanged(ChangeEventArgs e)
        {
            searchResearchGroupSchoolAsProfessorToFindResearchGroup = e.Value?.ToString() ?? "";
            // Clear department selection when school changes
            searchResearchGroupUniversityDepartmentAsProfessorToFindResearchGroup = "";
            await InvokeAsync(StateHasChanged);
        }

        private async Task HandleProfessorResearchGroupAreasInput(ChangeEventArgs e)
        {
            searchResearchGroupAreasAsProfessorToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            professorResearchGroupAreasSuggestions = new List<string>();

            if (searchResearchGroupAreasAsProfessorToFindResearchGroup.Length >= 1)
            {
                try
                {
                    // Get all areas from the database that match the search
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchResearchGroupAreasAsProfessorToFindResearchGroup) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchResearchGroupAreasAsProfessorToFindResearchGroup)))
                        .ToListAsync();

                    // Use HashSet to prevent duplicates
                    var suggestionsSet = new HashSet<string>();
        
                    foreach (var area in allAreas)
                    {
                        // Add the main area name if it matches
                        if (area.AreaName.Contains(searchResearchGroupAreasAsProfessorToFindResearchGroup, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        // Process subfields - ONLY add if the subfield itself matches
                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchResearchGroupAreasAsProfessorToFindResearchGroup, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                // Use " - " as separator
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    professorResearchGroupAreasSuggestions = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Περιοχών Έρευνας: {ex.Message}");
                    professorResearchGroupAreasSuggestions = new List<string>();
                }
            }
            else
            {
                professorResearchGroupAreasSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void HandleProfessorResearchGroupAreasKeyDown(KeyboardEventArgs e)
        {
            if (e.Key == "Enter" || e.Key == "Tab")
            {
                if (!string.IsNullOrWhiteSpace(searchResearchGroupAreasAsProfessorToFindResearchGroup) &&
                    !professorSelectedResearchGroupAreas.Contains(searchResearchGroupAreasAsProfessorToFindResearchGroup))
                {
                    professorSelectedResearchGroupAreas.Add(searchResearchGroupAreasAsProfessorToFindResearchGroup);
                    searchResearchGroupAreasAsProfessorToFindResearchGroup = string.Empty;
                    professorResearchGroupAreasSuggestions.Clear();
                }
            }
        }

        private void SelectProfessorResearchGroupAreasSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !professorSelectedResearchGroupAreas.Contains(suggestion))
            {
                professorSelectedResearchGroupAreas.Add(suggestion);
                professorResearchGroupAreasSuggestions.Clear();
                searchResearchGroupAreasAsProfessorToFindResearchGroup = string.Empty;
            }
        }

        private void RemoveProfessorSelectedResearchGroupArea(string area)
        {
            professorSelectedResearchGroupAreas.Remove(area);
            StateHasChanged();
        }

        private async Task HandleProfessorResearchGroupSkillsInput(ChangeEventArgs e)
        {
            searchResearchGroupSkillsAsProfessorToFindResearchGroup = e.Value?.ToString().Trim() ?? string.Empty;
            professorResearchGroupSkillsSuggestions = new List<string>();

            if (searchResearchGroupSkillsAsProfessorToFindResearchGroup.Length >= 1)
            {
                try
                {
                    // Use the Skills table instead of parsing from ResearchGroups
                    professorResearchGroupSkillsSuggestions = await dbContext.Skills
                        .Where(s => s.SkillName.Contains(searchResearchGroupSkillsAsProfessorToFindResearchGroup))
                        .Select(s => s.SkillName)
                        .Distinct()
                        .Take(10)
                        .ToListAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Πρόβλημα στην Ανάκτηση Τεχνολογιών: {ex.Message}");
                    professorResearchGroupSkillsSuggestions = new List<string>();
                }
            }
            else
            {
                professorResearchGroupSkillsSuggestions.Clear();
            }

            StateHasChanged();
        }

        private void HandleProfessorResearchGroupSkillsKeyDown(KeyboardEventArgs e)
        {
            if (e.Key == "Enter" || e.Key == "Tab")
            {
                // Add manual text as a selected skill on Enter/Tab
                if (!string.IsNullOrWhiteSpace(searchResearchGroupSkillsAsProfessorToFindResearchGroup) &&
                    !professorSelectedResearchGroupSkills.Contains(searchResearchGroupSkillsAsProfessorToFindResearchGroup))
                {
                    professorSelectedResearchGroupSkills.Add(searchResearchGroupSkillsAsProfessorToFindResearchGroup);
                    searchResearchGroupSkillsAsProfessorToFindResearchGroup = string.Empty;
                    professorResearchGroupSkillsSuggestions.Clear();
                }
            }
        }

        private void SelectProfessorResearchGroupSkillsSuggestion(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !professorSelectedResearchGroupSkills.Contains(suggestion))
            {
                professorSelectedResearchGroupSkills.Add(suggestion);
                professorResearchGroupSkillsSuggestions.Clear();
                searchResearchGroupSkillsAsProfessorToFindResearchGroup = string.Empty;
            }
        }

        private void RemoveProfessorSelectedResearchGroupSkill(string skill)
        {
            professorSelectedResearchGroupSkills.Remove(skill);
            StateHasChanged();
        }

        // Search method for Professor
        private async Task SearchResearchGroupsAsProfessor()
        {
            try
            {
                professorHasSearchedForResearchGroups = true;

                // First get all research groups from the database
                var allResearchGroups = await dbContext.ResearchGroups.ToListAsync();

                // Then filter on the client side
                var filteredResearchGroups = allResearchGroups.AsEnumerable();

                if (!string.IsNullOrEmpty(searchResearchGroupNameAsProfessorToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupName.Contains(searchResearchGroupNameAsProfessorToFindResearchGroup, StringComparison.OrdinalIgnoreCase));
                }

                if (!string.IsNullOrEmpty(searchResearchGroupSchoolAsProfessorToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupSchool == searchResearchGroupSchoolAsProfessorToFindResearchGroup);
                }

                if (!string.IsNullOrEmpty(searchResearchGroupUniversityDepartmentAsProfessorToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupUniversityDepartment == searchResearchGroupUniversityDepartmentAsProfessorToFindResearchGroup);
                }

                // UPDATED AREAS FILTER: Support both selected areas AND manual text input
                if (professorSelectedResearchGroupAreas.Any() || !string.IsNullOrEmpty(searchResearchGroupAreasAsProfessorToFindResearchGroup))
                {
                    // Create a combined list of search terms
                    var areaSearchTerms = new List<string>();

                    // Add manually typed text (if any)
                    if (!string.IsNullOrEmpty(searchResearchGroupAreasAsProfessorToFindResearchGroup))
                    {
                        areaSearchTerms.Add(searchResearchGroupAreasAsProfessorToFindResearchGroup.Trim());
                    }

                    // Add selected areas from dropdown
                    areaSearchTerms.AddRange(professorSelectedResearchGroupAreas);

                    // Remove duplicates and empty entries
                    areaSearchTerms = areaSearchTerms.Where(a => !string.IsNullOrWhiteSpace(a)).Distinct().ToList();

                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => areaSearchTerms.Any(area => 
                        {
                            var researchGroupAreas = rg.ResearchGroupAreas.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(a => a.Trim())
                                .ToList();

                            // Check if any research group area contains the search term
                            return researchGroupAreas.Any(researchArea => 
                                researchArea.Contains(area, StringComparison.OrdinalIgnoreCase) ||
                                area.Contains(researchArea, StringComparison.OrdinalIgnoreCase));
                        }));
                }

                // UPDATED SKILLS FILTER: Support both selected skills AND manual text input
                if (professorSelectedResearchGroupSkills.Any() || !string.IsNullOrEmpty(searchResearchGroupSkillsAsProfessorToFindResearchGroup))
                {
                    // Create a combined list of search terms
                    var skillSearchTerms = new List<string>();
            
                    // Add manually typed text (if any)
                    if (!string.IsNullOrEmpty(searchResearchGroupSkillsAsProfessorToFindResearchGroup))
                    {
                        skillSearchTerms.Add(searchResearchGroupSkillsAsProfessorToFindResearchGroup.Trim());
                    }
            
                    // Add selected skills from dropdown
                    skillSearchTerms.AddRange(professorSelectedResearchGroupSkills);
            
                    // Remove duplicates and empty entries
                    skillSearchTerms = skillSearchTerms.Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().ToList();

                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => skillSearchTerms.Any(skill => 
                            rg.ResearchGroupSkills.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(s => s.Trim())
                                .Any(s => s.Contains(skill, StringComparison.OrdinalIgnoreCase))
                        ));
                }

                // UPDATED KEYWORDS FILTER: Simple text search (no suggestions/selection)
                if (!string.IsNullOrEmpty(searchResearchGroupKeywordsAsProfessorToFindResearchGroup))
                {
                    filteredResearchGroups = filteredResearchGroups
                        .Where(rg => rg.ResearchGroupKeywords != null && 
                                    rg.ResearchGroupKeywords.Contains(searchResearchGroupKeywordsAsProfessorToFindResearchGroup, StringComparison.OrdinalIgnoreCase));
                }

                professorSearchResultsToFindResearchGroup = filteredResearchGroups.ToList();
                professorCurrentResearchGroupPage_SearchForResearchGroups = 1;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Πρόβλημα στην Αναζήτηση Ερευνητικών Ομάδων: {ex.Message}");
                professorSearchResultsToFindResearchGroup = new List<ResearchGroup>();
            }

            StateHasChanged();
        }

        private void ClearProfessorSearchFieldsToFindResearchGroup()
        {
            searchResearchGroupNameAsProfessorToFindResearchGroup = "";
            searchResearchGroupSchoolAsProfessorToFindResearchGroup = "";
            searchResearchGroupUniversityDepartmentAsProfessorToFindResearchGroup = "";
            searchResearchGroupAreasAsProfessorToFindResearchGroup = "";
            searchResearchGroupSkillsAsProfessorToFindResearchGroup = "";
            searchResearchGroupKeywordsAsProfessorToFindResearchGroup = "";
        
            professorSelectedResearchGroupAreas.Clear();
            professorSelectedResearchGroupSkills.Clear();
        
            professorResearchGroupNameSuggestions.Clear();
            professorResearchGroupAreasSuggestions.Clear();
            professorResearchGroupSkillsSuggestions.Clear();
        
            professorSearchResultsToFindResearchGroup = new List<ResearchGroup>();
            professorHasSearchedForResearchGroups = false;
        
            StateHasChanged();
        }

        // Pagination methods for Professor
        private IEnumerable<ResearchGroup> GetProfessorPaginatedResearchGroupResults()
        {
            var skip = (professorCurrentResearchGroupPage_SearchForResearchGroups - 1) * professorResearchGroupsPerPage_SearchForResearchGroups;
            return professorSearchResultsToFindResearchGroup.Skip(skip).Take(professorResearchGroupsPerPage_SearchForResearchGroups);
        }

        private int professorTotalResearchGroupPages_SearchForResearchGroups => 
            (int)Math.Ceiling(professorSearchResultsToFindResearchGroup.Count / (double)professorResearchGroupsPerPage_SearchForResearchGroups);

        private void GoToProfessorResearchGroupPage(int pageNumber)
        {
            professorCurrentResearchGroupPage_SearchForResearchGroups = pageNumber;
        }

        private void NextProfessorResearchGroupPage()
        {
            if (professorCurrentResearchGroupPage_SearchForResearchGroups < professorTotalResearchGroupPages_SearchForResearchGroups)
            {
                professorCurrentResearchGroupPage_SearchForResearchGroups++;
                StateHasChanged();
            }
        }

        private void PreviousProfessorResearchGroupPage()
        {
            if (professorCurrentResearchGroupPage_SearchForResearchGroups > 1)
            {
                professorCurrentResearchGroupPage_SearchForResearchGroups--;
                StateHasChanged();
            }
        }

        private void GoToProfessorFirstResearchGroupPage()
        {
            professorCurrentResearchGroupPage_SearchForResearchGroups = 1;
            StateHasChanged();
        }

        private void GoToProfessorLastResearchGroupPage()
        {
            professorCurrentResearchGroupPage_SearchForResearchGroups = professorTotalResearchGroupPages_SearchForResearchGroups;
            StateHasChanged();
        }

        private IEnumerable<int> GetProfessorVisibleResearchGroupPages()
        {
            var currentPage = professorCurrentResearchGroupPage_SearchForResearchGroups;
            var totalPages = professorTotalResearchGroupPages_SearchForResearchGroups;
            var pages = new List<int>();

            if (totalPages <= 7)
            {
                for (int i = 1; i <= totalPages; i++)
                    pages.Add(i);
            }
            else
            {
                if (currentPage <= 4)
                {
                    for (int i = 1; i <= 5; i++)
                        pages.Add(i);
                    pages.Add(-1); // Ellipsis
                    pages.Add(totalPages);
                }
                else if (currentPage >= totalPages - 3)
                {
                    pages.Add(1);
                    pages.Add(-1); // Ellipsis
                    for (int i = totalPages - 4; i <= totalPages; i++)
                        pages.Add(i);
                }
                else
                {
                    pages.Add(1);
                    pages.Add(-1); // Ellipsis
                    for (int i = currentPage - 1; i <= currentPage + 1; i++)
                        pages.Add(i);
                    pages.Add(-1); // Ellipsis
                    pages.Add(totalPages);
                }
            }

            return pages;
        }

        private void OnProfessorPageSizeChange_SearchForResearchGroups(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                professorResearchGroupsPerPage_SearchForResearchGroups = newSize;
                professorCurrentResearchGroupPage_SearchForResearchGroups = 1;
                StateHasChanged();
            }
        }

        // Modal methods for Professor
        private async Task ShowProfessorResearchGroupDetailsModal(ResearchGroup researchGroup)
        {
            selectedResearchGroupWhenSearchForResearchGroupsAsProfessor = researchGroup;
            showResearchGroupDetailsModalWhenSearchForResearchGroupsAsProfessor = true;
        
            // Load additional data
            if (!string.IsNullOrEmpty(researchGroup.ResearchGroupEmail))
            {
                await LoadResearchGroupDetailsData(researchGroup.ResearchGroupEmail);
            }
        
            StateHasChanged();
        }

        private void CloseModalResearchGroupDetailsOnEyeIconWhenSearchForResearchGroupsAsProfessor()
        {
            showResearchGroupDetailsModalWhenSearchForResearchGroupsAsProfessor = false;
            selectedResearchGroupWhenSearchForResearchGroupsAsProfessor = null;
            professorFacultyMembers.Clear();
            professorNonFacultyMembers.Clear();
            professorSpinOffCompanies.Clear();
            professorPatentsCount = 0;
            professorActiveResearchActionsCount = 0;
            StateHasChanged();
        }


        // SEARCH COMPANY AS STUDENT ADDED 29/10/25
        private string searchCompanyEmailAsStudentToFindCompany = string.Empty;
        private string searchCompanyNameENGAsStudentToFindCompany = string.Empty;
        private string searchCompanyTypeAsStudentToFindCompany = string.Empty;
        private string searchCompanyActivityInputAsStudentToFindCompany = string.Empty;
        private string searchCompanyTownAsStudentToFindCompany = string.Empty;
        private string searchCompanyAreasAsStudentToFindCompany = string.Empty;
        private string searchCompanyDesiredSkillsInputAsStudentToFindCompany = string.Empty;

        private List<string> companyNameSuggestionsAsStudent = new List<string>();
        private List<string> companyActivitySuggestionsAsStudent = new List<string>();
        private List<string> companyDesiredSkillsSuggestionsAsStudent = new List<string>();
        private List<string> areasOfInterestSuggestionsAsStudent = new List<string>();

        private List<string> selectedCompanyActivitiesAsStudent = new List<string>();
        private List<string> selectedCompanyDesiredSkillsAsStudent = new List<string>();
        private List<string> selectedAreasOfInterestAsStudent = new List<string>();

        private List<Company> searchResultsAsStudentToFindCompany;

        // Pagination variables for student company search
        private int currentPage_CompanySearchAsStudent = 1;
        private int CompanySearchPerPageAsStudent = 10;
        private int[] companySearchPageSizeOptionsAsStudent = new[] { 10, 50, 100 };

        private int totalPages_CompanySearchAsStudent => 
            (int)Math.Ceiling((double)(searchResultsAsStudentToFindCompany?.Count ?? 0) / CompanySearchPerPageAsStudent);


        // Search Methods for Student
        private void HandleCompanyInputAsStudent(ChangeEventArgs e)
        {
            searchCompanyNameENGAsStudentToFindCompany = e.Value?.ToString();
            if (!string.IsNullOrWhiteSpace(searchCompanyNameENGAsStudentToFindCompany) && searchCompanyNameENGAsStudentToFindCompany.Length >= 2)
            {
                companyNameSuggestionsAsStudent = dbContext.Companies
                    .Where(c => c.CompanyNameENG.Contains(searchCompanyNameENGAsStudentToFindCompany))
                    .Select(c => c.CompanyNameENG)
                    .Distinct()
                    .ToList();
            }
            else
            {
                companyNameSuggestionsAsStudent.Clear();
            }
        }

        private void SelectCompanyNameSuggestionAsStudent(string suggestion)
        {
            searchCompanyNameENGAsStudentToFindCompany = suggestion;
            companyNameSuggestionsAsStudent.Clear();
            StateHasChanged();
        }

        private void HandleCompanyActivityInputAsStudent(ChangeEventArgs e)
        {
            searchCompanyActivityInputAsStudentToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
        
            if (string.IsNullOrWhiteSpace(searchCompanyActivityInputAsStudentToFindCompany))
            {
                companyActivitySuggestionsAsStudent.Clear();
                return;
            }

            companyActivitySuggestionsAsStudent = Activity
                .Where(activity => activity.Contains(searchCompanyActivityInputAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase))
                .Take(10)
                .ToList();
        }

        private void SelectCompanyActivitySuggestionAsStudent(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedCompanyActivitiesAsStudent.Contains(suggestion))
            {
                selectedCompanyActivitiesAsStudent.Add(suggestion);
                companyActivitySuggestionsAsStudent.Clear();
                searchCompanyActivityInputAsStudentToFindCompany = string.Empty;
                StateHasChanged();
            }
        }

        private void RemoveSelectedCompanyActivityAsStudent(string activity)
        {
            selectedCompanyActivitiesAsStudent.Remove(activity);
            StateHasChanged();
        }

        private async Task HandleAreasOfInterestInput_WhenSearchForCompanyAsStudent(ChangeEventArgs e)
        {
            searchCompanyAreasAsStudentToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            areasOfInterestSuggestionsAsStudent = new List<string>();

            if (searchCompanyAreasAsStudentToFindCompany.Length >= 1)
            {
                try
                {
                    var allAreas = await dbContext.Areas
                        .Where(a => a.AreaName.Contains(searchCompanyAreasAsStudentToFindCompany) || 
                                (a.AreaSubFields != null && a.AreaSubFields.Contains(searchCompanyAreasAsStudentToFindCompany)))
                        .ToListAsync();

                    var suggestionsSet = new HashSet<string>();
        
                    foreach (var area in allAreas)
                    {
                        if (area.AreaName.Contains(searchCompanyAreasAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase))
                        {
                            suggestionsSet.Add(area.AreaName);
                        }

                        if (!string.IsNullOrEmpty(area.AreaSubFields))
                        {
                            var subfields = area.AreaSubFields
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(sub => sub.Trim())
                                .Where(sub => !string.IsNullOrEmpty(sub) &&
                                            sub.Contains(searchCompanyAreasAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase));

                            foreach (var subfield in subfields)
                            {
                                var combination = $"{area.AreaName} - {subfield}";
                                suggestionsSet.Add(combination);
                            }
                        }
                    }

                    areasOfInterestSuggestionsAsStudent = suggestionsSet
                        .Take(10)
                        .ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error retrieving Areas of Interest from Database: {ex.Message}");
                    areasOfInterestSuggestionsAsStudent = new List<string>();
                }
            }
            else
            {
                areasOfInterestSuggestionsAsStudent.Clear();
            }

            StateHasChanged();
        }

        private void SelectAreasOfInterestSuggestion_WhenSearchForCompanyAsStudent(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion))
            {
                selectedAreasOfInterestAsStudent.Add(suggestion);
                searchCompanyAreasAsStudentToFindCompany = suggestion;
                areasOfInterestSuggestionsAsStudent.Clear();
                StateHasChanged();
            }
        }

        private void RemoveSelectedAreaOfInterest_WhenSearchForCompanyAsStudent(string area)
        {
            selectedAreasOfInterestAsStudent.Remove(area);
            StateHasChanged();
        }

        private async Task HandleCompanyDesiredSkillsInputAsStudent(ChangeEventArgs e)
        {
            searchCompanyDesiredSkillsInputAsStudentToFindCompany = e.Value?.ToString().Trim() ?? string.Empty;
            companyDesiredSkillsSuggestionsAsStudent = new List<string>();

            if (searchCompanyDesiredSkillsInputAsStudentToFindCompany.Length >= 1)
            {
                try
                {
                    companyDesiredSkillsSuggestionsAsStudent = await Task.Run(() =>
                        dbContext.Skills
                            .Where(s => s.SkillName.Contains(searchCompanyDesiredSkillsInputAsStudentToFindCompany))
                            .Select(s => s.SkillName)
                            .Distinct()
                            .Take(10)
                            .ToList());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Σφάλμα κατά την ανάκτηση δεξιοτήτων: {ex.Message}");
                    companyDesiredSkillsSuggestionsAsStudent = new List<string>();
                }
            }
            else
            {
                companyDesiredSkillsSuggestionsAsStudent.Clear();
            }

            StateHasChanged();
        }

        private void SelectCompanyDesiredSkillSuggestionAsStudent(string suggestion)
        {
            if (!string.IsNullOrWhiteSpace(suggestion) && !selectedCompanyDesiredSkillsAsStudent.Contains(suggestion))
            {
                selectedCompanyDesiredSkillsAsStudent.Add(suggestion);
                companyDesiredSkillsSuggestionsAsStudent.Clear();
                searchCompanyDesiredSkillsInputAsStudentToFindCompany = string.Empty;
            }
        }

        private void RemoveSelectedCompanyDesiredSkillAsStudent(string skill)
        {
            selectedCompanyDesiredSkillsAsStudent.Remove(skill);
            StateHasChanged();
        }

        // Global Search Property for Companies
        private string globalCompanySearch = string.Empty;
        private void SearchCompaniesAsStudent()
        {
            var combinedSearchAreas = new List<string>();

            if (selectedAreasOfInterestAsStudent != null && selectedAreasOfInterestAsStudent.Any())
                combinedSearchAreas.AddRange(selectedAreasOfInterestAsStudent);

            if (!string.IsNullOrEmpty(searchCompanyAreasAsStudentToFindCompany))
                combinedSearchAreas.Add(searchCompanyAreasAsStudentToFindCompany);

            var normalizedSearchAreas = combinedSearchAreas
                .SelectMany(area => NormalizeAreas(area))
                .Distinct()
                .ToList();

            var companies = dbContext.Companies
                .AsEnumerable()
                .Where(c =>
                {
                    // GLOBAL SEARCH - Multi-word search across all fields
                    if (!string.IsNullOrEmpty(globalCompanySearch))
                    {
                        var searchTerm = globalCompanySearch.Trim();
                        var searchWords = searchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                    
                        var globalMatch = searchWords.Any(word =>
                            (c.CompanyEmail?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyNameENG?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyType?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyActivity?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyTown?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyAreas?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyDesiredSkills?.Contains(word, StringComparison.OrdinalIgnoreCase) == true) ||
                            (c.CompanyDescription?.Contains(word, StringComparison.OrdinalIgnoreCase) == true)); 

                        if (!globalMatch) return false;
                    }
                    else
                    {
                        // Apply specific filters only when no global search is active
                        var basicMatch = (string.IsNullOrEmpty(searchCompanyEmailAsStudentToFindCompany) || 
                                        (c.CompanyEmail?.Contains(searchCompanyEmailAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase) == true)) &&
                                    (string.IsNullOrEmpty(searchCompanyNameENGAsStudentToFindCompany) || 
                                        (c.CompanyNameENG?.Contains(searchCompanyNameENGAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase) == true)) &&
                                    (string.IsNullOrEmpty(searchCompanyTypeAsStudentToFindCompany) || 
                                        (c.CompanyType?.Contains(searchCompanyTypeAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase) == true)) &&
                                    (string.IsNullOrEmpty(searchCompanyTownAsStudentToFindCompany) || 
                                        (c.CompanyTown?.Contains(searchCompanyTownAsStudentToFindCompany, StringComparison.OrdinalIgnoreCase) == true));

                        if (!basicMatch) return false;
                    }

                    // Apply area matching (both global and specific searches)
                    var normalizedCompanyAreas = NormalizeAreas(c.CompanyAreas).ToList();
                    var expandedCompanyAreas = ExpandAreasWithSubfields(normalizedCompanyAreas);

                    var areaMatch = !normalizedSearchAreas.Any() ||
                        normalizedSearchAreas.Any(searchArea =>
                            expandedCompanyAreas.Any(companyArea =>
                                companyArea.Contains(searchArea, StringComparison.OrdinalIgnoreCase) ||
                                searchArea.Contains(companyArea, StringComparison.OrdinalIgnoreCase)));

                    // Apply activity matching (both global and specific searches)
                    var activityMatch = !selectedCompanyActivitiesAsStudent.Any() ||
                        selectedCompanyActivitiesAsStudent.Any(activity => 
                            c.CompanyActivity != null && c.CompanyActivity.Contains(activity, StringComparison.OrdinalIgnoreCase));

                    // Apply skills matching (both global and specific searches)
                    var skillsMatch = !selectedCompanyDesiredSkillsAsStudent.Any() ||
                        selectedCompanyDesiredSkillsAsStudent.All(skill => 
                            c.CompanyDesiredSkills != null && c.CompanyDesiredSkills.Contains(skill, StringComparison.OrdinalIgnoreCase));

                    return areaMatch && activityMatch && skillsMatch;
                })
                .ToList();

            searchResultsAsStudentToFindCompany = companies;
        }

        private void ClearSearchFieldsAsStudentToFindCompany()
        {
            // Clear global search
            globalCompanySearch = string.Empty;
            
            // Clear existing fields
            searchCompanyEmailAsStudentToFindCompany = string.Empty;
            searchCompanyNameENGAsStudentToFindCompany = string.Empty;
            searchCompanyTypeAsStudentToFindCompany = string.Empty;
            searchCompanyActivityInputAsStudentToFindCompany = string.Empty;
            searchCompanyTownAsStudentToFindCompany = string.Empty;
            searchCompanyAreasAsStudentToFindCompany = string.Empty;
            searchCompanyDesiredSkillsInputAsStudentToFindCompany = string.Empty;

            // Clear autocomplete suggestions
            companyNameSuggestionsAsStudent.Clear();
            companyActivitySuggestionsAsStudent.Clear();
            companyDesiredSkillsSuggestionsAsStudent.Clear();
            areasOfInterestSuggestionsAsStudent.Clear();

            // Clear selected items
            selectedAreasOfInterestAsStudent.Clear();
            selectedCompanyActivitiesAsStudent.Clear();
            selectedCompanyDesiredSkillsAsStudent.Clear();

            searchResultsAsStudentToFindCompany = null;

            StateHasChanged();
        }

        // Pagination Methods for Student
        private void OnPageSizeChangeForCompanySearchAsStudent(ChangeEventArgs e)
        {
            if (int.TryParse(e.Value?.ToString(), out int newSize) && newSize > 0)
            {
                CompanySearchPerPageAsStudent = newSize;
                currentPage_CompanySearchAsStudent = 1;
                StateHasChanged();
            }
        }

        private IEnumerable<Company> GetPaginatedCompanySearchResultsAsStudent()
        {
            return searchResultsAsStudentToFindCompany?
                .Skip((currentPage_CompanySearchAsStudent - 1) * CompanySearchPerPageAsStudent)
                .Take(CompanySearchPerPageAsStudent) ?? Enumerable.Empty<Company>();
        }

        private List<int> GetVisiblePages_CompanySearchAsStudent()
        {
            var pages = new List<int>();
            int current = currentPage_CompanySearchAsStudent;
            int total = totalPages_CompanySearchAsStudent;

            pages.Add(1);
            if (current > 3) pages.Add(-1);

            int start = Math.Max(2, current - 1);
            int end = Math.Min(total - 1, current + 1);

            for (int i = start; i <= end; i++) pages.Add(i);
            if (current < total - 2) pages.Add(-1);

            if (total > 1) pages.Add(total);
            return pages;
        }

        private void GoToFirstPage_CompanySearchAsStudent() => currentPage_CompanySearchAsStudent = 1;
        private void GoToLastPage_CompanySearchAsStudent() => currentPage_CompanySearchAsStudent = totalPages_CompanySearchAsStudent;

        private void PreviousPage_CompanySearchAsStudent()
        {
            if (currentPage_CompanySearchAsStudent > 1)
            {
                currentPage_CompanySearchAsStudent--;
                StateHasChanged();
            }
        }

        private void NextPage_CompanySearchAsStudent()
        {
            if (currentPage_CompanySearchAsStudent < totalPages_CompanySearchAsStudent)
            {
                currentPage_CompanySearchAsStudent++;
                StateHasChanged();
            }
        }

        private void GoToPage_CompanySearchAsStudent(int page)
        {
            if (page > 0 && page <= totalPages_CompanySearchAsStudent)
            {
                currentPage_CompanySearchAsStudent = page;
                StateHasChanged();
            }
        }

        private bool showCompanyDetailsModalAsStudent = false;
        private Company selectedCompanyAsStudent;

        // Student Modal Methods
        private void ShowCompanyDetailsWhenSearchAsStudent(Company company)
        {
            selectedCompanyAsStudent = company;
            showCompanyDetailsModalAsStudent = true;
            StateHasChanged();
        }

        private void CloseCompanyDetailsModalWhenSearchAsStudent()
        {
            showCompanyDetailsModalAsStudent = false;
            selectedCompanyAsStudent = null;
            StateHasChanged();
        }

        // Bulk edit variables
        private bool isBulkEditMode = false;
        private HashSet<int> selectedJobIds = new HashSet<int>();
        private string bulkAction = "";
        private bool showBulkActionModal = false;
        private List<CompanyJob> selectedJobsForAction = new List<CompanyJob>();
        private string newStatusForBulkAction = "Μη Δημοσιευμένη";

        private void EnableBulkEditMode()
        {
            isBulkEditMode = true;
            selectedJobIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEdit()
        {
            isBulkEditMode = false;
            selectedJobIds.Clear();
            StateHasChanged();
        }

        private void ToggleJobSelection(int jobId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedJobIds.Add(jobId);
            }
            else
            {
                selectedJobIds.Remove(jobId);
            }
            StateHasChanged();
        }

        private void ToggleAllJobsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var filteredJobs = GetPaginatedJobs().Where(j => selectedStatusFilterForJobs == "Όλα" || j.PositionStatus == selectedStatusFilterForJobs);
        
            if (isChecked)
            {
                selectedJobIds = new HashSet<int>(filteredJobs.Select(j => j.Id));
            }
            else
            {
                selectedJobIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptions()
        {
            if (selectedJobIds.Count == 0) return;
        
            selectedJobsForAction = jobs.Where(j => selectedJobIds.Contains(j.Id)).ToList();
            bulkAction = "";
            newStatusForBulkAction = "Μη Δημοσιευμένη";
            showBulkActionModal = true;
            StateHasChanged();
        }

        private void CloseBulkActionModal()
        {
            showBulkActionModal = false;
            bulkAction = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkAction()
        {
            if (string.IsNullOrEmpty(bulkAction) || selectedJobIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkAction == "status")
            {
                // Check if any jobs already have the target status
                var jobsWithSameStatus = selectedJobsForAction
                    .Where(j => j.PositionStatus == newStatusForBulkAction)
                    .ToList();

                if (jobsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {jobsWithSameStatus.Count} από τις επιλεγμένες θέσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkAction}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Θέσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var job in jobsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {job.PositionTitle} ({job.RNGForPositionUploaded_HashedAsUniqueID})<br>";
                    }

                    if (jobsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {jobsWithSameStatus.Count - 5} θέσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες θέσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModal();
                        return;
                    }

                    // Remove jobs that already have the target status from the selection
                    foreach (var job in jobsWithSameStatus)
                    {
                        selectedJobIds.Remove(job.Id);
                    }

                    // Update the selected jobs list
                    selectedJobsForAction = selectedJobsForAction
                        .Where(j => !jobsWithSameStatus.Contains(j))
                        .ToList();

                    // If no jobs left after filtering, show message and return
                    if (selectedJobIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν θέσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες θέσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModal();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkAction}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedJobIds.Count} επιλεγμένων θέσεων σε <strong>'{newStatusForBulkAction}'</strong>?<br><br>";
            }
            else if (bulkAction == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedJobIds.Count} επιλεγμένες θέσεις?<br>Οι νέες θέσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Θέσεις:</strong><br>";
            foreach (var job in selectedJobsForAction.Take(10))
            {
                confirmationMessage += $"- {job.PositionTitle} ({job.RNGForPositionUploaded_HashedAsUniqueID})<br>";
            }

            if (selectedJobsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedJobsForAction.Count - 10} θέσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModal();
                return;
            }

            try
            {
                showBulkActionModal = false;
        
                if (bulkAction == "status")
                {
                    await UpdateMultipleJobStatuses();
                }
                else if (bulkAction == "copy")
                {
                    await CopyMultipleJobs();
                }

                // Refresh data after bulk operation
                await LoadCompanyJobData();
                CancelBulkEdit();

                // Refresh with tab focus
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#jobs";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("activateTab", "jobs");
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action: {ex.Message}");
            }
        }


        private async Task CopyMultipleJobs()
        {
            var jobsToCopy = jobs.Where(j => selectedJobIds.Contains(j.Id)).ToList();

            foreach (var originalJob in jobsToCopy)
            {
                try
                {
                    var newJob = new CompanyJob
                    {
                        // Copy all properties from original job
                        PositionTitle = originalJob.PositionTitle,
                        PositionDescription = originalJob.PositionDescription,
                        PositionType = originalJob.PositionType,
                        PositionForeas = originalJob.PositionForeas,
                        PositionContactPerson = originalJob.PositionContactPerson,
                        PositionContactTelephonePerson = originalJob.PositionContactTelephonePerson,
                        PositionAddressLocation = originalJob.PositionAddressLocation,
                        PositionPerifereiaLocation = originalJob.PositionPerifereiaLocation,
                        PositionDimosLocation = originalJob.PositionDimosLocation,
                        PositionPostalCodeLocation = originalJob.PositionPostalCodeLocation,
                        PositionTransportOffer = originalJob.PositionTransportOffer,
                        PositionAreas = originalJob.PositionAreas,
                        PositionActivePeriod = originalJob.PositionActivePeriod,
                        PositionDepartment = originalJob.PositionDepartment,
                    
                        RNGForPositionUploaded = new Random().NextInt64(),
                        RNGForPositionUploaded_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        PositionStatus = "Μη Δημοσιευμένη",
                    
                        EmailUsedToUploadJobs = originalJob.EmailUsedToUploadJobs,
                        UploadDateTime = DateTime.Now,
                    
                        PositionAttachment = originalJob.PositionAttachment,
                    
                        TimesUpdated = 0,
                        UpdateDateTime = DateTime.Now
                    };

                    dbContext.CompanyJobs.Add(newJob);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying job {originalJob.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleJobStatuses()
        {
            foreach (var jobId in selectedJobIds)
            {
                await UpdateJobStatusDirectly(jobId, newStatusForBulkAction);
            }
        }

        private async Task UpdateJobStatusDirectly(int jobId, string newStatus)
        {
            try
            {
                
                var job = await dbContext.CompanyJobs
                    .FirstOrDefaultAsync(i => i.Id == jobId);

                if (job != null)
                {
                    
                    job.PositionStatus = newStatus;

                
                    if (newStatus == "Αποσυρμένη")
                    {
                        var rngForJob = job.RNGForPositionUploaded;

                        
                        var applications = await dbContext.CompanyJobsApplied
                            .Where(a => a.RNGForCompanyJobApplied == rngForJob)
                            .ToListAsync();

                        foreach (var application in applications)
                        {
                            
                            application.CompanyPositionStatusAppliedAtTheCompanySide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                            application.CompanyPositionStatusAppliedAtTheStudentSide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        }
                    }

                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating job status for job {jobId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForJobs(string newStatus)
        {
            if (selectedJobIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkAction = "status";
            newStatusForBulkAction = newStatus;
        
            // Set the selected jobs for action (this is needed for your existing logic)
            selectedJobsForAction = jobs.Where(j => selectedJobIds.Contains(j.Id)).ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkAction();
        }

        private async Task ExecuteBulkCopyForJobs()
        {
            if (selectedJobIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkAction = "copy";
        
            // Set the selected jobs for action (this is needed for your existing logic)
            selectedJobsForAction = jobs.Where(j => selectedJobIds.Contains(j.Id)).ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkAction();
        }

        // Bulk edit variables for internships
        private bool isBulkEditModeForInternships = false;
        private HashSet<int> selectedInternshipIds = new HashSet<int>();
        private string bulkActionForInternships = "";
        private bool showBulkActionModalForInternships = false;
        private List<CompanyInternship> selectedInternshipsForAction = new List<CompanyInternship>();
        private string newStatusForBulkActionForInternships = "Μη Δημοσιευμένη";

        // Bulk edit methods for internships
        private void EnableBulkEditModeForInternships()
        {
            isBulkEditModeForInternships = true;
            selectedInternshipIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForInternships()
        {
            isBulkEditModeForInternships = false;
            selectedInternshipIds.Clear();
            StateHasChanged();
        }

        private void ToggleInternshipSelection(int internshipId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedInternshipIds.Add(internshipId);
            }
            else
            {
                selectedInternshipIds.Remove(internshipId);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForInternships()
        {
            if (selectedInternshipIds.Count == 0) return;
        
            selectedInternshipsForAction = internships.Where(i => selectedInternshipIds.Contains(i.Id)).ToList();
            bulkActionForInternships = "";
            newStatusForBulkActionForInternships = "Μη Δημοσιευμένη";
            showBulkActionModalForInternships = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForInternships()
        {
            showBulkActionModalForInternships = false;
            bulkActionForInternships = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForInternships()
        {
            if (string.IsNullOrEmpty(bulkActionForInternships) || selectedInternshipIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForInternships == "status")
            {
                // Check if any internships already have the target status
                var internshipsWithSameStatus = selectedInternshipsForAction
                    .Where(i => i.CompanyUploadedInternshipStatus == newStatusForBulkActionForInternships)
                    .ToList();

                if (internshipsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {internshipsWithSameStatus.Count} από τις επιλεγμένες θέσεις πρακτικής άσκησης είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForInternships}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Θέσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var internship in internshipsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {internship.CompanyInternshipTitle} ({internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID})<br>";
                    }

                    if (internshipsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {internshipsWithSameStatus.Count - 5} θέσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες θέσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForInternships();
                        return;
                    }

                    // Remove internships that already have the target status from the selection
                    foreach (var internship in internshipsWithSameStatus)
                    {
                        selectedInternshipIds.Remove(internship.Id);
                    }

                    // Update the selected internships list
                    selectedInternshipsForAction = selectedInternshipsForAction
                        .Where(i => !internshipsWithSameStatus.Contains(i))
                        .ToList();

                    // If no internships left after filtering, show message and return
                    if (selectedInternshipIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν θέσεις πρακτικής άσκησης για αλλαγή κατάστασης. Όλες οι επιλεγμένες θέσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForInternships();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForInternships}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedInternshipIds.Count} επιλεγμένων θέσεων πρακτικής άσκησης σε <strong>'{newStatusForBulkActionForInternships}'</strong>?<br><br>";
            }
            else if (bulkActionForInternships == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedInternshipIds.Count} επιλεγμένες θέσεις πρακτικής άσκησης?<br>Οι νέες θέσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Θέσεις Πρακτικής Άσκησης:</strong><br>";
            foreach (var internship in selectedInternshipsForAction.Take(10))
            {
                confirmationMessage += $"- {internship.CompanyInternshipTitle} ({internship.RNGForInternshipUploadedAsCompany_HashedAsUniqueID})<br>";
            }

            if (selectedInternshipsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedInternshipsForAction.Count - 10} θέσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForInternships();
                return;
            }

            try
            {
                showBulkActionModalForInternships = false;
        
                if (bulkActionForInternships == "status")
                {
                    await UpdateMultipleInternshipStatuses();
                }
                else if (bulkActionForInternships == "copy")
                {
                    await CopyMultipleInternships();
                }

                // Refresh data after bulk operation
                await LoadInternships();
                CancelBulkEditForInternships();

                // Refresh with tab focus
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#internships";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("activateTab", "internships");
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for internships: {ex.Message}");
            }
        }

        private async Task UpdateMultipleInternshipStatuses()
        {
            foreach (var internshipId in selectedInternshipIds)
            {
                await UpdateInternshipStatusDirectly(internshipId, newStatusForBulkActionForInternships);
            }
        }

        private async Task UpdateInternshipStatusDirectly(int internshipId, string newStatus)
        {
            try
            {
                var internship = await dbContext.CompanyInternships.FirstOrDefaultAsync(i => i.Id == internshipId);
                if (internship != null)
                {
                    internship.CompanyUploadedInternshipStatus = newStatus;
                
                    // If the internship status is "Αποσυρμένη", update student applications
                    if (newStatus == "Αποσυρμένη")
                    {
                        var rngForInternship = internship.RNGForInternshipUploadedAsCompany;

                        // Get all applications for this internship
                        var applications = await dbContext.InternshipsApplied
                            .Where(a => a.RNGForInternshipApplied == rngForInternship)
                            .ToListAsync();

                        foreach (var application in applications)
                        {
                            // Update status directly on the main application entity
                            application.InternshipStatusAppliedAtTheCompanySide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                            application.InternshipStatusAppliedAtTheStudentSide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        }
                    }

                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating internship status for internship {internshipId}: {ex.Message}");
            }
        }

        private async Task CopyMultipleInternships()
        {
            var internshipsToCopy = internships.Where(i => selectedInternshipIds.Contains(i.Id)).ToList();

            foreach (var originalInternship in internshipsToCopy)
            {
                try
                {
                    // Generate new unique identifiers
                    long newRng = new Random().NextInt64();
                
                    var newInternship = new CompanyInternship
                    {
                        // Copy all properties from original internship
                        CompanyInternshipTitle = originalInternship.CompanyInternshipTitle,
                        CompanyInternshipDescription = originalInternship.CompanyInternshipDescription,
                        CompanyInternshipType = originalInternship.CompanyInternshipType,
                        CompanyInternshipForeas = originalInternship.CompanyInternshipForeas,
                        CompanyInternshipContactPerson = originalInternship.CompanyInternshipContactPerson,
                        CompanyInternshipContactTelephonePerson = originalInternship.CompanyInternshipContactTelephonePerson,
                        CompanyInternshipAddress = originalInternship.CompanyInternshipAddress,
                        CompanyInternshipPerifereiaLocation = originalInternship.CompanyInternshipPerifereiaLocation,
                        CompanyInternshipDimosLocation = originalInternship.CompanyInternshipDimosLocation,
                        CompanyInternshipPostalCodeLocation = originalInternship.CompanyInternshipPostalCodeLocation,
                        CompanyInternshipTransportOffer = originalInternship.CompanyInternshipTransportOffer,
                        CompanyInternshipAreas = originalInternship.CompanyInternshipAreas,
                        CompanyInternshipActivePeriod = originalInternship.CompanyInternshipActivePeriod,
                        CompanyInternshipESPA = originalInternship.CompanyInternshipESPA,
                        CompanyInternshipFinishEstimation = originalInternship.CompanyInternshipFinishEstimation,
                        CompanyInternshipEKPASupervisor = originalInternship.CompanyInternshipEKPASupervisor,
                    
                        // New unique identifiers
                        RNGForInternshipUploadedAsCompany = newRng,
                        RNGForInternshipUploadedAsCompany_HashedAsUniqueID = HashingHelper.HashLong(newRng),
                    
                        // Set as unpublished
                        CompanyUploadedInternshipStatus = "Μη Δημοσιευμένη",
                    
                        // Metadata
                        CompanyEmailUsedToUploadInternship = originalInternship.CompanyEmailUsedToUploadInternship,
                        CompanyInternshipUploadDate = DateTime.Now,
                    
                        // Copy attachment if exists
                        CompanyInternshipAttachment = originalInternship.CompanyInternshipAttachment,
                    
                        // Set company relationship
                        Company = originalInternship.Company
                    };

                    dbContext.CompanyInternships.Add(newInternship);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying internship {originalInternship.Id}: {ex.Message}");
                }
            }

            await dbContext.SaveChangesAsync();
        }

        private async Task HandleFileUploadForEditCompanyThesisAttachment(InputFileChangeEventArgs e)
        {
            var file = e.File;  
            if (file != null)
            {
                Console.WriteLine($"File selected: {file.Name}");

                if (file.ContentType == "application/pdf")
                {
                    using (var stream = file.OpenReadStream())
                    {
                        using (var memoryStream = new MemoryStream())
                        {
                            await stream.CopyToAsync(memoryStream);  
                            // Replace with your actual property for storing the thesis attachment
                            currentThesis.CompanyThesisAttachmentUpload = memoryStream.ToArray();  
                            Console.WriteLine($"File uploaded: {file.Name}");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Selected file is not a PDF.");
                }
            }
            else
            {
                Console.WriteLine("No file selected.");
            }
        }

        private bool showAreasForEditCompanyThesis = false;
        private bool showSkillsForEditCompanyThesis = false;

        private void ToggleAreasForEditCompanyThesis()
        {
            showAreasForEditCompanyThesis = !showAreasForEditCompanyThesis;
        }

        private void ToggleSkillsForEditCompanyThesis()
        {
            showSkillsForEditCompanyThesis = !showSkillsForEditCompanyThesis;
        }

        // Bulk edit variables for theses
        private bool isBulkEditModeForTheses = false;
        private HashSet<int> selectedThesisIds = new HashSet<int>();
        private string bulkActionForTheses = "";
        private bool showBulkActionModalForTheses = false;
        private List<CompanyThesis> selectedThesesForAction = new List<CompanyThesis>();
        private string newStatusForBulkActionForTheses = "Μη Δημοσιευμένη";

        // Bulk edit methods for theses
        private void EnableBulkEditModeForTheses()
        {
            isBulkEditModeForTheses = true;
            selectedThesisIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForTheses()
        {
            isBulkEditModeForTheses = false;
            selectedThesisIds.Clear();
            StateHasChanged();
        }

        private void ToggleThesisSelection(int thesisId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedThesisIds.Add(thesisId);
            }
            else
            {
                selectedThesisIds.Remove(thesisId);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForTheses()
        {
            if (selectedThesisIds.Count == 0) return;
        
            selectedThesesForAction = companytheses.Where(t => selectedThesisIds.Contains(t.Id)).ToList();
            bulkActionForTheses = "";
            newStatusForBulkActionForTheses = "Μη Δημοσιευμένη";
            showBulkActionModalForTheses = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForTheses()
        {
            showBulkActionModalForTheses = false;
            bulkActionForTheses = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForTheses()
        {
            if (string.IsNullOrEmpty(bulkActionForTheses) || selectedThesisIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForTheses == "status")
            {
                // Check if any theses already have the target status
                var thesesWithSameStatus = selectedThesesForAction
                    .Where(t => t.CompanyThesisStatus == newStatusForBulkActionForTheses)
                    .ToList();

                if (thesesWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {thesesWithSameStatus.Count} από τις επιλεγμένες θέσεις Διπλωματικών εργασιών είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForTheses}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Θέσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var thesis in thesesWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {thesis.CompanyThesisTitle} ({thesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID})<br>";
                    }

                    if (thesesWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {thesesWithSameStatus.Count - 5} θέσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες θέσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForTheses();
                        return;
                    }

                    // Remove theses that already have the target status from the selection
                    foreach (var thesis in thesesWithSameStatus)
                    {
                        selectedThesisIds.Remove(thesis.Id);
                    }

                    // Update the selected theses list
                    selectedThesesForAction = selectedThesesForAction
                        .Where(t => !thesesWithSameStatus.Contains(t))
                        .ToList();

                    // If no theses left after filtering, show message and return
                    if (selectedThesisIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν θέσεις Διπλωματικών εργασιών για αλλαγή κατάστασης. Όλες οι επιλεγμένες θέσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForTheses();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForTheses}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedThesisIds.Count} επιλεγμένων θέσεων Διπλωματικής Εργασίας σε <strong>'{newStatusForBulkActionForTheses}'</strong>?<br><br>";
            }
            else if (bulkActionForTheses == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedThesisIds.Count} επιλεγμένες θέσεις Διπλωματικής Εργασίας?<br>Οι νέες θέσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Θέσεις Διπλωματικής Εργασίας:</strong><br>";
            foreach (var thesis in selectedThesesForAction.Take(10))
            {
                confirmationMessage += $"- {thesis.CompanyThesisTitle} ({thesis.RNGForThesisUploadedAsCompany_HashedAsUniqueID})<br>";
            }

            if (selectedThesesForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedThesesForAction.Count - 10} θέσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForTheses();
                return;
            }

            try
            {
                showBulkActionModalForTheses = false;
        
                if (bulkActionForTheses == "status")
                {
                    await UpdateMultipleThesisStatuses();
                }
                else if (bulkActionForTheses == "copy")
                {
                    await CopyMultipleTheses();
                }

                // Refresh data after bulk operation
                await LoadThesesAsCompany();
                CancelBulkEditForTheses();

                // Refresh with tab focus
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#theses";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("activateTab", "theses");
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for theses: {ex.Message}");
            }
        }

        private async Task UpdateMultipleThesisStatuses()
        {
            foreach (var thesisId in selectedThesisIds)
            {
                await UpdateThesisStatusDirectly(thesisId, newStatusForBulkActionForTheses);
            }
        }

        private async Task UpdateThesisStatusDirectly(int thesisId, string newStatus)
        {
            try
            {
                var thesis = await dbContext.CompanyTheses.FirstOrDefaultAsync(t => t.Id == thesisId);
                if (thesis != null)
                {
                    thesis.CompanyThesisStatus = newStatus;
                    thesis.CompanyThesisTimesUpdated += 1;
                    thesis.CompanyThesisUpdateDateTime = DateTime.Now;
                
                    // If the thesis status is "Αποσυρμένη", update student applications
                    if (newStatus == "Αποσυρμένη")
                    {
                        var rngForThesis = thesis.RNGForThesisUploadedAsCompany;

                        // Get all applications for this thesis
                        var applications = await dbContext.CompanyThesesApplied
                            .Where(a => a.RNGForCompanyThesisApplied == rngForThesis)
                            .ToListAsync();

                        foreach (var application in applications)
                        {
                            // Update status directly on the main application entity
                            application.CompanyThesisStatusAppliedAtCompanySide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                            application.CompanyThesisStatusAppliedAtStudentSide = 
                                "Απορρίφθηκε (Απόσυρση Θέσεως Από Εταιρία)";
                        }
                    }

                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating thesis status for thesis {thesisId}: {ex.Message}");
            }
        }

        private async Task CopyMultipleTheses()
        {
            var thesesToCopy = companytheses.Where(t => selectedThesisIds.Contains(t.Id)).ToList();

            foreach (var originalThesis in thesesToCopy)
            {
                try
                {
                    // Generate new unique identifiers
                    long newRng = new Random().NextInt64();
                
                    var newThesis = new CompanyThesis
                    {
                        // Copy all properties from original thesis
                        CompanyThesisTitle = originalThesis.CompanyThesisTitle,
                        CompanyThesisCompanySupervisorFullName = originalThesis.CompanyThesisCompanySupervisorFullName,
                        CompanyThesisDescriptionsUploaded = originalThesis.CompanyThesisDescriptionsUploaded,
                        CompanyThesisAreasUpload = originalThesis.CompanyThesisAreasUpload,
                        CompanyThesisSkillsNeeded = originalThesis.CompanyThesisSkillsNeeded,
                        CompanyThesisDepartment = originalThesis.CompanyThesisDepartment,
                        CompanyThesisContactPersonEmail = originalThesis.CompanyThesisContactPersonEmail,
                        CompanyThesisContactPersonTelephone = originalThesis.CompanyThesisContactPersonTelephone,
                        CompanyThesisStartingDate = originalThesis.CompanyThesisStartingDate,
                    
                        // New unique identifiers
                        RNGForThesisUploadedAsCompany = newRng,
                        RNGForThesisUploadedAsCompany_HashedAsUniqueID = HashingHelper.HashLong(newRng),
                    
                        // Set as unpublished
                        CompanyThesisStatus = "Μη Δημοσιευμένη",
                    
                        // Metadata
                        CompanyEmailUsedToUploadThesis = originalThesis.CompanyEmailUsedToUploadThesis,
                        CompanyThesisUploadDateTime = DateTime.Now,
                        CompanyThesisUpdateDateTime = DateTime.Now,
                        CompanyThesisTimesUpdated = 0,
                    
                        // Copy attachment if exists
                        CompanyThesisAttachmentUpload = originalThesis.CompanyThesisAttachmentUpload,
                    
                        // Thesis type
                        ThesisType = ThesisType.Company,
                    
                        // Professor interest information (reset for new thesis)
                        IsProfessorInteresetedInCompanyThesis = false,
                        IsProfessorInterestedInCompanyThesisStatus = "Δεν έχει γίνει Αποδοχή",
                        ProfessorEmailInterestedInCompanyThesis = null,
                    
                        // Set company relationship
                        Company = originalThesis.Company
                    };

                    dbContext.CompanyTheses.Add(newThesis);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying thesis {originalThesis.Id}: {ex.Message}");
                }
            }

            await dbContext.SaveChangesAsync();
        }

        private async Task ExecuteBulkStatusChangeForTheses(string newStatus)
        {
            if (selectedThesisIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForTheses = "status";
            newStatusForBulkActionForTheses = newStatus;

            // Set the selected theses for action (this is needed for your existing logic)
            selectedThesesForAction = companytheses.Where(t => selectedThesisIds.Contains(t.Id)).ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForTheses();
        }

        private async Task ExecuteBulkCopyForTheses()
        {
            if (selectedThesisIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForTheses = "copy";

            // Set the selected theses for action (this is needed for your existing logic)
            selectedThesesForAction = companytheses.Where(t => selectedThesisIds.Contains(t.Id)).ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForTheses();
        }

        // Bulk edit variables for Announcements
        private bool isBulkEditModeForAnnouncements = false;
        private HashSet<int> selectedAnnouncementIds = new HashSet<int>();
        private string bulkActionForAnnouncements = "";
        private bool showBulkActionModalForAnnouncements = false;
        private List<AnnouncementAsCompany> selectedAnnouncementsForAction = new List<AnnouncementAsCompany>();
        private string newStatusForBulkActionForAnnouncements = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForAnnouncements()
        {
            isBulkEditModeForAnnouncements = true;
            selectedAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForAnnouncements()
        {
            isBulkEditModeForAnnouncements = false;
            selectedAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void ToggleAnnouncementSelection(int announcementId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedAnnouncementIds.Add(announcementId);
            }
            else
            {
                selectedAnnouncementIds.Remove(announcementId);
            }
            StateHasChanged();
        }

        private void ToggleAllAnnouncementsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var paginatedAnnouncements = GetPaginatedAnnouncements();
        
            if (isChecked)
            {
                selectedAnnouncementIds = new HashSet<int>(paginatedAnnouncements.Select(a => a.Id));
            }
            else
            {
                selectedAnnouncementIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForAnnouncements()
        {
            if (selectedAnnouncementIds.Count == 0) return;
        
            selectedAnnouncementsForAction = FilteredAnnouncements
                .Where(a => selectedAnnouncementIds.Contains(a.Id))
                .ToList();
            bulkActionForAnnouncements = "";
            newStatusForBulkActionForAnnouncements = "Μη Δημοσιευμένη";
            showBulkActionModalForAnnouncements = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForAnnouncements()
        {
            showBulkActionModalForAnnouncements = false;
            bulkActionForAnnouncements = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForAnnouncements()
        {
            if (string.IsNullOrEmpty(bulkActionForAnnouncements) || selectedAnnouncementIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForAnnouncements == "status")
            {
                // Check if any announcements already have the target status
                var announcementsWithSameStatus = selectedAnnouncementsForAction
                    .Where(a => a.CompanyAnnouncementStatus == newStatusForBulkActionForAnnouncements)
                    .ToList();

                if (announcementsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {announcementsWithSameStatus.Count} από τις επιλεγμένες ανακοινώσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForAnnouncements}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Ανακοινώσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var announcement in announcementsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {announcement.CompanyAnnouncementTitle} ({announcement.CompanyAnnouncementRNG_HashedAsUniqueID})<br>";
                    }

                    if (announcementsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {announcementsWithSameStatus.Count - 5} ανακοινώσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες ανακοινώσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForAnnouncements();
                        return;
                    }

                    // Remove announcements that already have the target status from the selection
                    foreach (var announcement in announcementsWithSameStatus)
                    {
                        selectedAnnouncementIds.Remove(announcement.Id);
                    }

                    // Update the selected announcements list
                    selectedAnnouncementsForAction = selectedAnnouncementsForAction
                        .Where(a => !announcementsWithSameStatus.Contains(a))
                        .ToList();

                    // If no announcements left after filtering, show message and return
                    if (selectedAnnouncementIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν ανακοινώσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες ανακοινώσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForAnnouncements();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForAnnouncements}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedAnnouncementIds.Count} επιλεγμένων ανακοινώσεων σε <strong>'{newStatusForBulkActionForAnnouncements}'</strong>?<br><br>";
            }
            else if (bulkActionForAnnouncements == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedAnnouncementIds.Count} επιλεγμένες ανακοινώσεις?<br>Οι νέες ανακοινώσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Ανακοινώσεις:</strong><br>";
            foreach (var announcement in selectedAnnouncementsForAction.Take(10))
            {
                confirmationMessage += $"- {announcement.CompanyAnnouncementTitle} ({announcement.CompanyAnnouncementRNG_HashedAsUniqueID})<br>";
            }

            if (selectedAnnouncementsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedAnnouncementsForAction.Count - 10} ανακοινώσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForAnnouncements();
                return;
            }

            try
            {
                showBulkActionModalForAnnouncements = false;
        
                if (bulkActionForAnnouncements == "status")
                {
                    await UpdateMultipleAnnouncementStatuses();
                }
                else if (bulkActionForAnnouncements == "copy")
                {
                    await CopyMultipleAnnouncements();
                }

                // Refresh data after bulk operation
                await LoadUploadedAnnouncementsAsync();
                CancelBulkEditForAnnouncements();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#announcements";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
                // If you have a tab activation function for announcements
                // await JS.InvokeVoidAsync("activateTab", "announcements");
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for announcements: {ex.Message}");
            }
        }

        private async Task CopyMultipleAnnouncements()
        {
            var announcementsToCopy = FilteredAnnouncements
                .Where(a => selectedAnnouncementIds.Contains(a.Id))
                .ToList();

            foreach (var originalAnnouncement in announcementsToCopy)
            {
                try
                {
                    var newAnnouncement = new AnnouncementAsCompany
                    {
                        // Copy all properties from original announcement
                        CompanyAnnouncementTitle = originalAnnouncement.CompanyAnnouncementTitle,
                        CompanyAnnouncementDescription = originalAnnouncement.CompanyAnnouncementDescription,
                        CompanyAnnouncementTimeToBeActive = originalAnnouncement.CompanyAnnouncementTimeToBeActive,
                        CompanyAnnouncementAttachmentFile = originalAnnouncement.CompanyAnnouncementAttachmentFile,
                        CompanyAnnouncementCompanyEmail = originalAnnouncement.CompanyAnnouncementCompanyEmail,
                    
                        CompanyAnnouncementRNG = new Random().NextInt64(),
                        CompanyAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        CompanyAnnouncementStatus = "Μη Δημοσιευμένη",
                        CompanyAnnouncementUploadDate = DateTime.Now
                    };

                    dbContext.AnnouncementsAsCompany.Add(newAnnouncement);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying announcement {originalAnnouncement.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleAnnouncementStatuses()
        {
            foreach (var announcementId in selectedAnnouncementIds)
            {
                await UpdateAnnouncementStatusDirectly(announcementId, newStatusForBulkActionForAnnouncements);
            }
        }

        private async Task UpdateAnnouncementStatusDirectly(int announcementId, string newStatus)
        {
            try
            {
                var announcement = await dbContext.AnnouncementsAsCompany
                    .FirstOrDefaultAsync(a => a.Id == announcementId);

                if (announcement != null)
                {
                    announcement.CompanyAnnouncementStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating announcement status for announcement {announcementId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChange(string newStatus)
        {
            if (selectedAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForAnnouncements = "status";
            newStatusForBulkActionForAnnouncements = newStatus;
        
            // Set the selected announcements for action (this is needed for your existing logic)
            selectedAnnouncementsForAction = FilteredAnnouncements
                .Where(a => selectedAnnouncementIds.Contains(a.Id))
                .ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForAnnouncements();
        }

        private async Task ExecuteBulkCopy()
        {
            if (selectedAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForAnnouncements = "copy";
        
            // Set the selected announcements for action (this is needed for your existing logic)
            selectedAnnouncementsForAction = FilteredAnnouncements
                .Where(a => selectedAnnouncementIds.Contains(a.Id))
                .ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForAnnouncements();
        }

        // Bulk edit variables for Events
        private bool isBulkEditModeForEvents = false;
        private HashSet<int> selectedEventIds = new HashSet<int>();
        private string bulkActionForEvents = "";
        private bool showBulkActionModalForEvents = false;
        private List<CompanyEvent> selectedEventsForAction = new List<CompanyEvent>();
        private string newStatusForBulkActionForEvents = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForEvents()
        {
            isBulkEditModeForEvents = true;
            selectedEventIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForEvents()
        {
            isBulkEditModeForEvents = false;
            selectedEventIds.Clear();
            StateHasChanged();
        }

        private void ToggleEventSelection(int eventId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedEventIds.Add(eventId);
            }
            else
            {
                selectedEventIds.Remove(eventId);
            }
            StateHasChanged();
        }

        private void ToggleAllEventsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var paginatedEvents = GetPaginatedCompanyEvents();
        
            if (isChecked)
            {
                selectedEventIds = new HashSet<int>(paginatedEvents.Select(ev => ev.Id));
            }
            else
            {
                selectedEventIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForEvents()
        {
            if (selectedEventIds.Count == 0) return;
        
            selectedEventsForAction = FilteredCompanyEvents
                .Where(ev => selectedEventIds.Contains(ev.Id))
                .ToList();
            bulkActionForEvents = "";
            newStatusForBulkActionForEvents = "Μη Δημοσιευμένη";
            showBulkActionModalForEvents = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForEvents()
        {
            showBulkActionModalForEvents = false;
            bulkActionForEvents = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForEvents()
        {
            if (string.IsNullOrEmpty(bulkActionForEvents) || selectedEventIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForEvents == "status")
            {
                // Check if any events already have the target status
                var eventsWithSameStatus = selectedEventsForAction
                    .Where(ev => ev.CompanyEventStatus == newStatusForBulkActionForEvents)
                    .ToList();

                if (eventsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {eventsWithSameStatus.Count} από τις επιλεγμένες εκδηλώσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForEvents}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Εκδηλώσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var ev in eventsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {ev.CompanyEventTitle} ({ev.RNGForEventUploadedAsCompany_HashedAsUniqueID})<br>";
                    }

                    if (eventsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {eventsWithSameStatus.Count - 5} εκδηλώσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες εκδηλώσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForEvents();
                        return;
                    }

                    // Remove events that already have the target status from the selection
                    foreach (var ev in eventsWithSameStatus)
                    {
                        selectedEventIds.Remove(ev.Id);
                    }

                    // Update the selected events list
                    selectedEventsForAction = selectedEventsForAction
                        .Where(ev => !eventsWithSameStatus.Contains(ev))
                        .ToList();

                    // If no events left after filtering, show message and return
                    if (selectedEventIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν εκδηλώσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες εκδηλώσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForEvents();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForEvents}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedEventIds.Count} επιλεγμένων εκδηλώσεων σε <strong>'{newStatusForBulkActionForEvents}'</strong>?<br><br>";
            }
            else if (bulkActionForEvents == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedEventIds.Count} επιλεγμένες εκδηλώσεις?<br>Οι νέες εκδηλώσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Εκδηλώσεις:</strong><br>";
            foreach (var ev in selectedEventsForAction.Take(10))
            {
                confirmationMessage += $"- {ev.CompanyEventTitle} ({ev.RNGForEventUploadedAsCompany_HashedAsUniqueID})<br>";
            }

            if (selectedEventsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedEventsForAction.Count - 10} εκδηλώσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForEvents();
                return;
            }

            try
            {
                showBulkActionModalForEvents = false;
        
                if (bulkActionForEvents == "status")
                {
                    await UpdateMultipleEventStatuses();
                }
                else if (bulkActionForEvents == "copy")
                {
                    await CopyMultipleEvents();
                }

                // Refresh data after bulk operation
                await LoadUploadedEventsAsync();
                CancelBulkEditForEvents();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#events";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for events: {ex.Message}");
            }
        }

        private async Task CopyMultipleEvents()
        {
            var eventsToCopy = FilteredCompanyEvents
                .Where(ev => selectedEventIds.Contains(ev.Id))
                .ToList();

            foreach (var originalEvent in eventsToCopy)
            {
                try
                {
                    var newEvent = new CompanyEvent
                    {
                        // Copy all properties from original event
                        CompanyEventTitle = originalEvent.CompanyEventTitle,
                        CompanyEventDescription = originalEvent.CompanyEventDescription,
                        CompanyEventType = originalEvent.CompanyEventType,
                        CompanyEventOtherOrganizerToBeVisible = originalEvent.CompanyEventOtherOrganizerToBeVisible,
                        CompanyEventOtherOrganizer = originalEvent.CompanyEventOtherOrganizer,
                        CompanyEventAreasOfInterest = originalEvent.CompanyEventAreasOfInterest,
                        CompanyEventStatus = "Μη Δημοσιευμένη",
                        CompanyEventResponsiblePerson = originalEvent.CompanyEventResponsiblePerson,
                        CompanyEventResponsiblePersonEmail = originalEvent.CompanyEventResponsiblePersonEmail,
                        CompanyEventResponsiblePersonTelephone = originalEvent.CompanyEventResponsiblePersonTelephone,
                        CompanyEventCompanyDepartment = originalEvent.CompanyEventCompanyDepartment,
                        CompanyEventUploadedDate = DateTime.Now,
                        CompanyEventActiveDate = originalEvent.CompanyEventActiveDate,
                        CompanyEventPerifereiaLocation = originalEvent.CompanyEventPerifereiaLocation,
                        CompanyEventDimosLocation = originalEvent.CompanyEventDimosLocation,
                        CompanyEventPlaceLocation = originalEvent.CompanyEventPlaceLocation,
                        CompanyEventTime = originalEvent.CompanyEventTime,
                        CompanyEventPostalCodeLocation = originalEvent.CompanyEventPostalCodeLocation,
                        CompanyEventAttachmentFile = originalEvent.CompanyEventAttachmentFile,
                        CompanyEventOfferingTransportToEventLocation = originalEvent.CompanyEventOfferingTransportToEventLocation,
                        CompanyEventStartingPointLocationToTransportPeopleToEvent1 = originalEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent1,
                        CompanyEventStartingPointLocationToTransportPeopleToEvent2 = originalEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent2,
                        CompanyEventStartingPointLocationToTransportPeopleToEvent3 = originalEvent.CompanyEventStartingPointLocationToTransportPeopleToEvent3,
                    
                        // Generate new unique identifiers
                        RNGForEventUploadedAsCompany = new Random().NextInt64(),
                        RNGForEventUploadedAsCompany_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        // Set the company email
                        CompanyEmailUsedToUploadEvent = originalEvent.CompanyEmailUsedToUploadEvent
                    };

                    dbContext.CompanyEvents.Add(newEvent);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying event {originalEvent.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleEventStatuses()
        {
            foreach (var eventId in selectedEventIds)
            {
                await UpdateEventStatusDirectly(eventId, newStatusForBulkActionForEvents);
            }
        }

        private async Task UpdateEventStatusDirectly(int eventId, string newStatus)
        {
            try
            {
                var companyEvent = await dbContext.CompanyEvents
                    .FirstOrDefaultAsync(ev => ev.Id == eventId);

                if (companyEvent != null)
                {
                    companyEvent.CompanyEventStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating event status for event {eventId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForEvents(string newStatus)
        {
            if (selectedEventIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForEvents = "status";
            newStatusForBulkActionForEvents = newStatus;
        
            // Set the selected events for action (this is needed for your existing logic)
            selectedEventsForAction = FilteredCompanyEvents
                .Where(ev => selectedEventIds.Contains(ev.Id))
                .ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForEvents();
        }

        private async Task ExecuteBulkCopyForEvents()
        {
            if (selectedEventIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForEvents = "copy";
        
            // Set the selected events for action (this is needed for your existing logic)
            selectedEventsForAction = FilteredCompanyEvents
                .Where(ev => selectedEventIds.Contains(ev.Id))
                .ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForEvents();
        }

        // Bulk edit variables for Professor Announcements
        private bool isBulkEditModeForProfessorAnnouncements = false;
        private HashSet<int> selectedProfessorAnnouncementIds = new HashSet<int>();
        private string bulkActionForProfessorAnnouncements = "";
        private bool showBulkActionModalForProfessorAnnouncements = false;
        private List<AnnouncementAsProfessor> selectedProfessorAnnouncementsForAction = new List<AnnouncementAsProfessor>();
        private string newStatusForBulkActionForProfessorAnnouncements = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForProfessorAnnouncements()
        {
            isBulkEditModeForProfessorAnnouncements = true;
            selectedProfessorAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorAnnouncements()
        {
            isBulkEditModeForProfessorAnnouncements = false;
            selectedProfessorAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void ToggleProfessorAnnouncementSelection(int announcementId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedProfessorAnnouncementIds.Add(announcementId);
            }
            else
            {
                selectedProfessorAnnouncementIds.Remove(announcementId);
            }
            StateHasChanged();
        }

        private void ToggleAllProfessorAnnouncementsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var paginatedAnnouncements = GetPaginatedProfessorAnnouncements_ProfessorAnnouncements();
        
            if (isChecked)
            {
                selectedProfessorAnnouncementIds = new HashSet<int>(paginatedAnnouncements.Select(a => a.Id));
            }
            else
            {
                selectedProfessorAnnouncementIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForProfessorAnnouncements()
        {
            if (selectedProfessorAnnouncementIds.Count == 0) return;
        
            selectedProfessorAnnouncementsForAction = FilteredAnnouncementsAsProfessor
                .Where(a => selectedProfessorAnnouncementIds.Contains(a.Id))
                .ToList();
            bulkActionForProfessorAnnouncements = "";
            newStatusForBulkActionForProfessorAnnouncements = "Μη Δημοσιευμένη";
            showBulkActionModalForProfessorAnnouncements = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorAnnouncements()
        {
            showBulkActionModalForProfessorAnnouncements = false;
            bulkActionForProfessorAnnouncements = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorAnnouncements()
        {
            if (string.IsNullOrEmpty(bulkActionForProfessorAnnouncements) || selectedProfessorAnnouncementIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForProfessorAnnouncements == "status")
            {
                // Check if any announcements already have the target status
                var announcementsWithSameStatus = selectedProfessorAnnouncementsForAction
                    .Where(a => a.ProfessorAnnouncementStatus == newStatusForBulkActionForProfessorAnnouncements)
                    .ToList();

                if (announcementsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {announcementsWithSameStatus.Count} από τις επιλεγμένες ανακοινώσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForProfessorAnnouncements}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Ανακοινώσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var announcement in announcementsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {announcement.ProfessorAnnouncementTitle} ({announcement.ProfessorAnnouncementRNG_HashedAsUniqueID})<br>";
                    }

                    if (announcementsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {announcementsWithSameStatus.Count - 5} ανακοινώσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες ανακοινώσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForProfessorAnnouncements();
                        return;
                    }

                    // Remove announcements that already have the target status from the selection
                    foreach (var announcement in announcementsWithSameStatus)
                    {
                        selectedProfessorAnnouncementIds.Remove(announcement.Id);
                    }

                    // Update the selected announcements list
                    selectedProfessorAnnouncementsForAction = selectedProfessorAnnouncementsForAction
                        .Where(a => !announcementsWithSameStatus.Contains(a))
                        .ToList();

                    // If no announcements left after filtering, show message and return
                    if (selectedProfessorAnnouncementIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν ανακοινώσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες ανακοινώσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForProfessorAnnouncements();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForProfessorAnnouncements}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedProfessorAnnouncementIds.Count} επιλεγμένων ανακοινώσεων σε <strong>'{newStatusForBulkActionForProfessorAnnouncements}'</strong>?<br><br>";
            }
            else if (bulkActionForProfessorAnnouncements == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedProfessorAnnouncementIds.Count} επιλεγμένες ανακοινώσεις?<br>Οι νέες ανακοινώσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Ανακοινώσεις:</strong><br>";
            foreach (var announcement in selectedProfessorAnnouncementsForAction.Take(10))
            {
                confirmationMessage += $"- {announcement.ProfessorAnnouncementTitle} ({announcement.ProfessorAnnouncementRNG_HashedAsUniqueID})<br>";
            }

            if (selectedProfessorAnnouncementsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedProfessorAnnouncementsForAction.Count - 10} ανακοινώσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForProfessorAnnouncements();
                return;
            }

            try
            {
                showBulkActionModalForProfessorAnnouncements = false;
        
                if (bulkActionForProfessorAnnouncements == "status")
                {
                    await UpdateMultipleProfessorAnnouncementStatuses();
                }
                else if (bulkActionForProfessorAnnouncements == "copy")
                {
                    await CopyMultipleProfessorAnnouncements();
                }

                // Refresh data after bulk operation
                await LoadUploadedAnnouncementsAsProfessorAsync();
                CancelBulkEditForProfessorAnnouncements();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#professor-announcements";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for professor announcements: {ex.Message}");
            }
        }

        private async Task CopyMultipleProfessorAnnouncements()
        {
            var announcementsToCopy = FilteredAnnouncementsAsProfessor
                .Where(a => selectedProfessorAnnouncementIds.Contains(a.Id))
                .ToList();

            foreach (var originalAnnouncement in announcementsToCopy)
            {
                try
                {
                    var newAnnouncement = new AnnouncementAsProfessor
                    {
                        // Copy all properties from original announcement
                        ProfessorAnnouncementTitle = originalAnnouncement.ProfessorAnnouncementTitle,
                        ProfessorAnnouncementDescription = originalAnnouncement.ProfessorAnnouncementDescription,
                        ProfessorAnnouncementTimeToBeActive = originalAnnouncement.ProfessorAnnouncementTimeToBeActive,
                        ProfessorAnnouncementAttachmentFile = originalAnnouncement.ProfessorAnnouncementAttachmentFile,
                        ProfessorAnnouncementProfessorEmail = originalAnnouncement.ProfessorAnnouncementProfessorEmail,
                    
                        ProfessorAnnouncementRNG = new Random().NextInt64(),
                        ProfessorAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        ProfessorAnnouncementStatus = "Μη Δημοσιευμένη",
                        ProfessorAnnouncementUploadDate = DateTime.Now
                    };

                    dbContext.AnnouncementsAsProfessor.Add(newAnnouncement);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying professor announcement {originalAnnouncement.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleProfessorAnnouncementStatuses()
        {
            foreach (var announcementId in selectedProfessorAnnouncementIds)
            {
                await UpdateProfessorAnnouncementStatusDirectly(announcementId, newStatusForBulkActionForProfessorAnnouncements);
            }
        }

        private async Task UpdateProfessorAnnouncementStatusDirectly(int announcementId, string newStatus)
        {
            try
            {
                var announcement = await dbContext.AnnouncementsAsProfessor
                    .FirstOrDefaultAsync(a => a.Id == announcementId);

                if (announcement != null)
                {
                    announcement.ProfessorAnnouncementStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating professor announcement status for announcement {announcementId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForProfessorAnnouncements(string newStatus)
        {
            if (selectedProfessorAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorAnnouncements = "status";
            newStatusForBulkActionForProfessorAnnouncements = newStatus;

            // Set the selected announcements for action (this is needed for your existing logic)
            selectedProfessorAnnouncementsForAction = FilteredAnnouncementsAsProfessor
                .Where(a => selectedProfessorAnnouncementIds.Contains(a.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorAnnouncements();
        }

        private async Task ExecuteBulkCopyForProfessorAnnouncements()
        {
            if (selectedProfessorAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorAnnouncements = "copy";

            // Set the selected announcements for action (this is needed for your existing logic)
            selectedProfessorAnnouncementsForAction = FilteredAnnouncementsAsProfessor
                .Where(a => selectedProfessorAnnouncementIds.Contains(a.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorAnnouncements();
        }

        // Bulk edit variables for Professor Events
        private bool isBulkEditModeForProfessorEvents = false;
        private HashSet<int> selectedProfessorEventIds = new HashSet<int>();
        private string bulkActionForProfessorEvents = "";
        private bool showBulkActionModalForProfessorEvents = false;
        private List<ProfessorEvent> selectedProfessorEventsForAction = new List<ProfessorEvent>();
        private string newStatusForBulkActionForProfessorEvents = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForProfessorEvents()
        {
            isBulkEditModeForProfessorEvents = true;
            selectedProfessorEventIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorEvents()
        {
            isBulkEditModeForProfessorEvents = false;
            selectedProfessorEventIds.Clear();
            StateHasChanged();
        }

        private void ToggleProfessorEventSelection(int eventId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedProfessorEventIds.Add(eventId);
            }
            else
            {
                selectedProfessorEventIds.Remove(eventId);
            }
            StateHasChanged();
        }

        private void ToggleAllProfessorEventsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var paginatedEvents = GetPaginatedProfessorEvents();
        
            if (isChecked)
            {
                selectedProfessorEventIds = new HashSet<int>(paginatedEvents.Select(ev => ev.Id));
            }
            else
            {
                selectedProfessorEventIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForProfessorEvents()
        {
            if (selectedProfessorEventIds.Count == 0) return;
        
            selectedProfessorEventsForAction = FilteredProfessorEvents
                .Where(ev => selectedProfessorEventIds.Contains(ev.Id))
                .ToList();
            bulkActionForProfessorEvents = "";
            newStatusForBulkActionForProfessorEvents = "Μη Δημοσιευμένη";
            showBulkActionModalForProfessorEvents = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorEvents()
        {
            showBulkActionModalForProfessorEvents = false;
            bulkActionForProfessorEvents = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorEvents()
        {
            if (string.IsNullOrEmpty(bulkActionForProfessorEvents) || selectedProfessorEventIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForProfessorEvents == "status")
            {
                // Check if any events already have the target status
                var eventsWithSameStatus = selectedProfessorEventsForAction
                    .Where(ev => ev.ProfessorEventStatus == newStatusForBulkActionForProfessorEvents)
                    .ToList();

                if (eventsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {eventsWithSameStatus.Count} από τις επιλεγμένες εκδηλώσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForProfessorEvents}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Εκδηλώσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var ev in eventsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {ev.ProfessorEventTitle} ({ev.RNGForEventUploadedAsProfessor_HashedAsUniqueID})<br>";
                    }

                    if (eventsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {eventsWithSameStatus.Count - 5} εκδηλώσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες εκδηλώσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForProfessorEvents();
                        return;
                    }

                    // Remove events that already have the target status from the selection
                    foreach (var ev in eventsWithSameStatus)
                    {
                        selectedProfessorEventIds.Remove(ev.Id);
                    }

                    // Update the selected events list
                    selectedProfessorEventsForAction = selectedProfessorEventsForAction
                        .Where(ev => !eventsWithSameStatus.Contains(ev))
                        .ToList();

                    // If no events left after filtering, show message and return
                    if (selectedProfessorEventIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν εκδηλώσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες εκδηλώσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForProfessorEvents();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForProfessorEvents}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedProfessorEventIds.Count} επιλεγμένων εκδηλώσεων σε <strong>'{newStatusForBulkActionForProfessorEvents}'</strong>?<br><br>";
            }
            else if (bulkActionForProfessorEvents == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedProfessorEventIds.Count} επιλεγμένες εκδηλώσεις?<br>Οι νέες εκδηλώσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Εκδηλώσεις:</strong><br>";
            foreach (var ev in selectedProfessorEventsForAction.Take(10))
            {
                confirmationMessage += $"- {ev.ProfessorEventTitle} ({ev.RNGForEventUploadedAsProfessor_HashedAsUniqueID})<br>";
            }

            if (selectedProfessorEventsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedProfessorEventsForAction.Count - 10} εκδηλώσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForProfessorEvents();
                return;
            }

            try
            {
                showBulkActionModalForProfessorEvents = false;
        
                if (bulkActionForProfessorEvents == "status")
                {
                    await UpdateMultipleProfessorEventStatuses();
                }
                else if (bulkActionForProfessorEvents == "copy")
                {
                    await CopyMultipleProfessorEvents();
                }

                // Refresh data after bulk operation
                await LoadUploadedEventsAsyncAsProfessor();
                CancelBulkEditForProfessorEvents();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#professor-events";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for professor events: {ex.Message}");
            }
        }

        private async Task CopyMultipleProfessorEvents()
        {
            var eventsToCopy = FilteredProfessorEvents
                .Where(ev => selectedProfessorEventIds.Contains(ev.Id))
                .ToList();

            foreach (var originalEvent in eventsToCopy)
            {
                try
                {
                    var newEvent = new ProfessorEvent
                    {
                        // Copy all properties from original event
                        ProfessorEventTitle = originalEvent.ProfessorEventTitle,
                        ProfessorEventDescription = originalEvent.ProfessorEventDescription,
                        ProfessorEventType = originalEvent.ProfessorEventType,
                        ProfessorEventOtherOrganizerToBeVisible = originalEvent.ProfessorEventOtherOrganizerToBeVisible,
                        ProfessorEventOtherOrganizer = originalEvent.ProfessorEventOtherOrganizer,
                        ProfessorEventAreasOfInterest = originalEvent.ProfessorEventAreasOfInterest,
                        ProfessorEventStatus = "Μη Δημοσιευμένη",
                        ProfessorEventResponsiblePerson = originalEvent.ProfessorEventResponsiblePerson,
                        ProfessorEventResponsiblePersonEmail = originalEvent.ProfessorEventResponsiblePersonEmail,
                        ProfessorEventResponsiblePersonTelephone = originalEvent.ProfessorEventResponsiblePersonTelephone,
                        ProfessorEventUniversityDepartment = originalEvent.ProfessorEventUniversityDepartment,
                        ProfessorEventUploadedDate = DateTime.Now,
                        ProfessorEventActiveDate = originalEvent.ProfessorEventActiveDate,
                        ProfessorEventPerifereiaLocation = originalEvent.ProfessorEventPerifereiaLocation,
                        ProfessorEventDimosLocation = originalEvent.ProfessorEventDimosLocation,
                        ProfessorEventPlaceLocation = originalEvent.ProfessorEventPlaceLocation,
                        ProfessorEventTime = originalEvent.ProfessorEventTime,
                        ProfessorEventPostalCodeLocation = originalEvent.ProfessorEventPostalCodeLocation,
                        ProfessorEventAttachmentFile = originalEvent.ProfessorEventAttachmentFile,
                        ProfessorEventOfferingTransportToEventLocation = originalEvent.ProfessorEventOfferingTransportToEventLocation,
                        ProfessorEventStartingPointLocationToTransportPeopleToEvent1 = originalEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent1,
                        ProfessorEventStartingPointLocationToTransportPeopleToEvent2 = originalEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent2,
                        ProfessorEventStartingPointLocationToTransportPeopleToEvent3 = originalEvent.ProfessorEventStartingPointLocationToTransportPeopleToEvent3,
                    
                        // Generate new unique identifiers
                        RNGForEventUploadedAsProfessor = new Random().NextInt64(),
                        RNGForEventUploadedAsProfessor_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        // Set the professor email
                        ProfessorEmailUsedToUploadEvent = originalEvent.ProfessorEmailUsedToUploadEvent
                    };

                    dbContext.ProfessorEvents.Add(newEvent);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying professor event {originalEvent.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleProfessorEventStatuses()
        {
            foreach (var eventId in selectedProfessorEventIds)
            {
                await UpdateProfessorEventStatusDirectly(eventId, newStatusForBulkActionForProfessorEvents);
            }
        }

        private async Task UpdateProfessorEventStatusDirectly(int eventId, string newStatus)
        {
            try
            {
                var professorEvent = await dbContext.ProfessorEvents
                    .FirstOrDefaultAsync(ev => ev.Id == eventId);

                if (professorEvent != null)
                {
                    professorEvent.ProfessorEventStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating professor event status for event {eventId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForProfessorEvents(string newStatus)
        {
            if (selectedProfessorEventIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorEvents = "status";
            newStatusForBulkActionForProfessorEvents = newStatus;

            // Set the selected events for action (this is needed for your existing logic)
            selectedProfessorEventsForAction = FilteredProfessorEvents
                .Where(ev => selectedProfessorEventIds.Contains(ev.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorEvents();
        }

        private async Task ExecuteBulkCopyForProfessorEvents()
        {
            if (selectedProfessorEventIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorEvents = "copy";

            // Set the selected events for action (this is needed for your existing logic)
            selectedProfessorEventsForAction = FilteredProfessorEvents
                .Where(ev => selectedProfessorEventIds.Contains(ev.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorEvents();
        }

        // Bulk edit variables for Professor Theses
        private bool isBulkEditModeForProfessorTheses = false;
        private HashSet<int> selectedProfessorThesisIds = new HashSet<int>();
        private string bulkActionForProfessorTheses = "";
        private bool showBulkActionModalForProfessorTheses = false;
        private List<ProfessorThesis> selectedProfessorThesesForAction = new List<ProfessorThesis>();
        private string newStatusForBulkActionForProfessorTheses = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForProfessorTheses()
        {
            isBulkEditModeForProfessorTheses = true;
            selectedProfessorThesisIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorTheses()
        {
            isBulkEditModeForProfessorTheses = false;
            selectedProfessorThesisIds.Clear();
            StateHasChanged();
        }

        private void ToggleProfessorThesisSelection(int thesisId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedProfessorThesisIds.Add(thesisId);
            }
            else
            {
                selectedProfessorThesisIds.Remove(thesisId);
            }
            StateHasChanged();
        }

        private void ToggleAllProfessorThesesSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var filteredTheses = GetPaginatedProfessorTheses().Where(j => selectedStatusFilterForThesesAsProfessor == "Όλα" || j.ThesisStatus == selectedStatusFilterForThesesAsProfessor);
        
            if (isChecked)
            {
                selectedProfessorThesisIds = new HashSet<int>(filteredTheses.Select(t => t.Id));
            }
            else
            {
                selectedProfessorThesisIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForProfessorTheses()
        {
            if (selectedProfessorThesisIds.Count == 0) return;
        
            selectedProfessorThesesForAction = FilteredThesesAsProfessor
                .Where(t => selectedProfessorThesisIds.Contains(t.Id))
                .ToList();
            bulkActionForProfessorTheses = "";
            newStatusForBulkActionForProfessorTheses = "Μη Δημοσιευμένη";
            showBulkActionModalForProfessorTheses = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorTheses()
        {
            showBulkActionModalForProfessorTheses = false;
            bulkActionForProfessorTheses = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorTheses()
        {
            if (string.IsNullOrEmpty(bulkActionForProfessorTheses) || selectedProfessorThesisIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForProfessorTheses == "status")
            {
                // Check if any theses already have the target status
                var thesesWithSameStatus = selectedProfessorThesesForAction
                    .Where(t => t.ThesisStatus == newStatusForBulkActionForProfessorTheses)
                    .ToList();

                if (thesesWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {thesesWithSameStatus.Count} από τις επιλεγμένες Διπλωματικές είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForProfessorTheses}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Διπλωματικές που δεν θα αλλάξουν:</strong><br>";

                    foreach (var thesis in thesesWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {thesis.ThesisTitle} ({thesis.RNGForThesisUploaded_HashedAsUniqueID})<br>";
                    }

                    if (thesesWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {thesesWithSameStatus.Count - 5} Διπλωματικές<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες Διπλωματικές;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForProfessorTheses();
                        return;
                    }

                    // Remove theses that already have the target status from the selection
                    foreach (var thesis in thesesWithSameStatus)
                    {
                        selectedProfessorThesisIds.Remove(thesis.Id);
                    }

                    // Update the selected theses list
                    selectedProfessorThesesForAction = selectedProfessorThesesForAction
                        .Where(t => !thesesWithSameStatus.Contains(t))
                        .ToList();

                    // If no theses left after filtering, show message and return
                    if (selectedProfessorThesisIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν Διπλωματικές για αλλαγή κατάστασης. Όλες οι επιλεγμένες Διπλωματικές είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForProfessorTheses();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForProfessorTheses}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedProfessorThesisIds.Count} επιλεγμένων Διπλωματικών σε <strong>'{newStatusForBulkActionForProfessorTheses}'</strong>?<br><br>";
            }
            else if (bulkActionForProfessorTheses == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedProfessorThesisIds.Count} επιλεγμένες Διπλωματικές?<br>Οι νέες Διπλωματικές θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Διπλωματικές:</strong><br>";
            foreach (var thesis in selectedProfessorThesesForAction.Take(10))
            {
                confirmationMessage += $"- {thesis.ThesisTitle} ({thesis.RNGForThesisUploaded_HashedAsUniqueID})<br>";
            }

            if (selectedProfessorThesesForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedProfessorThesesForAction.Count - 10} Διπλωματικές<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForProfessorTheses();
                return;
            }

            try
            {
                showBulkActionModalForProfessorTheses = false;
        
                if (bulkActionForProfessorTheses == "status")
                {
                    await UpdateMultipleProfessorThesisStatuses();
                }
                else if (bulkActionForProfessorTheses == "copy")
                {
                    await CopyMultipleProfessorTheses();
                }

                // Refresh data after bulk operation
                await LoadUploadedThesesAsProfessorAsync();
                CancelBulkEditForProfessorTheses();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#professor-theses";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for professor theses: {ex.Message}");
            }
        }

        private async Task CopyMultipleProfessorTheses()
        {
            var thesesToCopy = FilteredThesesAsProfessor
                .Where(t => selectedProfessorThesisIds.Contains(t.Id))
                .ToList();

            foreach (var originalThesis in thesesToCopy)
            {
                try
                {
                    var newThesis = new ProfessorThesis
                    {
                        // Copy all properties from original thesis
                        ThesisTitle = originalThesis.ThesisTitle,
                        ThesisDescription = originalThesis.ThesisDescription,
                        ThesisAreas = originalThesis.ThesisAreas,
                        ThesisSkills = originalThesis.ThesisSkills,
                        ThesisAttachment = originalThesis.ThesisAttachment,
                        ThesisActivePeriod = originalThesis.ThesisActivePeriod,
                        ThesisType = originalThesis.ThesisType,
                        ProfessorEmailUsedToUploadThesis = originalThesis.ProfessorEmailUsedToUploadThesis,
                    
                        RNGForThesisUploaded = new Random().NextInt64(),
                        RNGForThesisUploaded_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        ThesisStatus = "Μη Δημοσιευμένη",
                        IsCompanyInterestedInProfessorThesisStatus = "Δεν έχει γίνει Αποδοχή",
                        ThesisUploadDateTime = DateTime.Now,
                        ThesisUpdateDateTime = DateTime.Now,
                        ThesisTimesUpdated = 0,
                    
                        // Reset company interest for copied thesis
                        IsCompanyInteresetedInProfessorThesis = false,
                        CompanyEmailInterestedInProfessorThesis = null
                    };

                    dbContext.ProfessorTheses.Add(newThesis);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying professor thesis {originalThesis.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleProfessorThesisStatuses()
        {
            foreach (var thesisId in selectedProfessorThesisIds)
            {
                await UpdateProfessorThesisStatusDirectly(thesisId, newStatusForBulkActionForProfessorTheses);
            }
        }

        private async Task UpdateProfessorThesisStatusDirectly(int thesisId, string newStatus)
        {
            try
            {
                var thesis = await dbContext.ProfessorTheses
                    .FirstOrDefaultAsync(t => t.Id == thesisId);

                if (thesis != null)
                {
                    thesis.ThesisStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating professor thesis status for thesis {thesisId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForProfessorTheses(string newStatus)
        {
            if (selectedProfessorThesisIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorTheses = "status";
            newStatusForBulkActionForProfessorTheses = newStatus;

            // Set the selected theses for action (this is needed for your existing logic)
            selectedProfessorThesesForAction = FilteredThesesAsProfessor
                .Where(t => selectedProfessorThesisIds.Contains(t.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorTheses();
        }

        private async Task ExecuteBulkCopyForProfessorTheses()
        {
            if (selectedProfessorThesisIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorTheses = "copy";

            // Set the selected theses for action (this is needed for your existing logic)
            selectedProfessorThesesForAction = FilteredThesesAsProfessor
                .Where(t => selectedProfessorThesisIds.Contains(t.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorTheses();
        }

        // Bulk edit variables for Professor Internships
        private bool isBulkEditModeForProfessorInternships = false;
        private HashSet<int> selectedProfessorInternshipIds = new HashSet<int>();
        private string bulkActionForProfessorInternships = "";
        private bool showBulkActionModalForProfessorInternships = false;
        private List<ProfessorInternship> selectedProfessorInternshipsForAction = new List<ProfessorInternship>();
        private string newStatusForBulkActionForProfessorInternships = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForProfessorInternships()
        {
            isBulkEditModeForProfessorInternships = true;
            selectedProfessorInternshipIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorInternships()
        {
            isBulkEditModeForProfessorInternships = false;
            selectedProfessorInternshipIds.Clear();
            StateHasChanged();
        }

        private void ToggleProfessorInternshipSelection(int internshipId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedProfessorInternshipIds.Add(internshipId);
            }
            else
            {
                selectedProfessorInternshipIds.Remove(internshipId);
            }
            StateHasChanged();
        }

        private void ToggleAllProfessorInternshipsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var filteredInternships = GetPaginatedProfessorInternships().Where(i => selectedStatusFilterForProfessorInternships == "Όλα" || i.ProfessorUploadedInternshipStatus == selectedStatusFilterForProfessorInternships);
        
            if (isChecked)
            {
                selectedProfessorInternshipIds = new HashSet<int>(filteredInternships.Select(i => i.Id));
            }
            else
            {
                selectedProfessorInternshipIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForProfessorInternships()
        {
            if (selectedProfessorInternshipIds.Count == 0) return;
        
            selectedProfessorInternshipsForAction = professorInternships
                .Where(i => selectedProfessorInternshipIds.Contains(i.Id))
                .ToList();
            bulkActionForProfessorInternships = "";
            newStatusForBulkActionForProfessorInternships = "Μη Δημοσιευμένη";
            showBulkActionModalForProfessorInternships = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorInternships()
        {
            showBulkActionModalForProfessorInternships = false;
            bulkActionForProfessorInternships = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorInternships()
        {
            if (string.IsNullOrEmpty(bulkActionForProfessorInternships) || selectedProfessorInternshipIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForProfessorInternships == "status")
            {
                // Check if any internships already have the target status
                var internshipsWithSameStatus = selectedProfessorInternshipsForAction
                    .Where(i => i.ProfessorUploadedInternshipStatus == newStatusForBulkActionForProfessorInternships)
                    .ToList();

                if (internshipsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {internshipsWithSameStatus.Count} από τις επιλεγμένες πρακτικές είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForProfessorInternships}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Πρακτικές που δεν θα αλλάξουν:</strong><br>";

                    foreach (var internship in internshipsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {internship.ProfessorInternshipTitle} ({internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID})<br>";
                    }

                    if (internshipsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {internshipsWithSameStatus.Count - 5} πρακτικές<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες πρακτικές;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForProfessorInternships();
                        return;
                    }

                    // Remove internships that already have the target status from the selection
                    foreach (var internship in internshipsWithSameStatus)
                    {
                        selectedProfessorInternshipIds.Remove(internship.Id);
                    }

                    // Update the selected internships list
                    selectedProfessorInternshipsForAction = selectedProfessorInternshipsForAction
                        .Where(i => !internshipsWithSameStatus.Contains(i))
                        .ToList();

                    // If no internships left after filtering, show message and return
                    if (selectedProfessorInternshipIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν πρακτικές για αλλαγή κατάστασης. Όλες οι επιλεγμένες πρακτικές είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForProfessorInternships();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForProfessorInternships}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedProfessorInternshipIds.Count} επιλεγμένων πρακτικών σε <strong>'{newStatusForBulkActionForProfessorInternships}'</strong>?<br><br>";
            }
            else if (bulkActionForProfessorInternships == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedProfessorInternshipIds.Count} επιλεγμένες πρακτικές?<br>Οι νέες πρακτικές θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Πρακτικές:</strong><br>";
            foreach (var internship in selectedProfessorInternshipsForAction.Take(10))
            {
                confirmationMessage += $"- {internship.ProfessorInternshipTitle} ({internship.RNGForInternshipUploadedAsProfessor_HashedAsUniqueID})<br>";
            }

            if (selectedProfessorInternshipsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedProfessorInternshipsForAction.Count - 10} πρακτικές<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForProfessorInternships();
                return;
            }

            try
            {
                showBulkActionModalForProfessorInternships = false;
        
                if (bulkActionForProfessorInternships == "status")
                {
                    await UpdateMultipleProfessorInternshipStatuses();
                }
                else if (bulkActionForProfessorInternships == "copy")
                {
                    await CopyMultipleProfessorInternships();
                }

                // Refresh data after bulk operation
                await LoadProfessorInternships();
                CancelBulkEditForProfessorInternships();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#professor-internships";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for professor internships: {ex.Message}");
            }
        }

        private async Task CopyMultipleProfessorInternships()
        {
            var internshipsToCopy = professorInternships
                .Where(i => selectedProfessorInternshipIds.Contains(i.Id))
                .ToList();

            foreach (var originalInternship in internshipsToCopy)
            {
                try
                {
                    var newInternship = new ProfessorInternship
                    {
                        // Copy all properties from original internship
                        ProfessorInternshipESPA = originalInternship.ProfessorInternshipESPA,
                        ProfessorInternshipType = originalInternship.ProfessorInternshipType,
                        ProfessorInternshipTitle = originalInternship.ProfessorInternshipTitle,
                        ProfessorInternshipForeas = originalInternship.ProfessorInternshipForeas,
                        ProfessorInternshipContactPerson = originalInternship.ProfessorInternshipContactPerson,
                        ProfessorInternshipContactTelephonePerson = originalInternship.ProfessorInternshipContactTelephonePerson,
                        ProfessorInternshipAddress = originalInternship.ProfessorInternshipAddress,
                        ProfessorInternshipPerifereiaLocation = originalInternship.ProfessorInternshipPerifereiaLocation,
                        ProfessorInternshipDimosLocation = originalInternship.ProfessorInternshipDimosLocation,
                        ProfessorInternshipPostalCodeLocation = originalInternship.ProfessorInternshipPostalCodeLocation,
                        ProfessorInternshipTransportOffer = originalInternship.ProfessorInternshipTransportOffer,
                        ProfessorInternshipAreas = originalInternship.ProfessorInternshipAreas,
                        ProfessorInternshipActivePeriod = originalInternship.ProfessorInternshipActivePeriod,
                        ProfessorInternshipFinishEstimation = originalInternship.ProfessorInternshipFinishEstimation,
                        ProfessorInternshipLastUpdate = DateTime.Now,
                        ProfessorInternshipDescription = originalInternship.ProfessorInternshipDescription,
                        ProfessorInternshipAttachment = originalInternship.ProfessorInternshipAttachment,
                        ProfessorInternshipEKPASupervisor = originalInternship.ProfessorInternshipEKPASupervisor,
                        ProfessorEmailUsedToUploadInternship = originalInternship.ProfessorEmailUsedToUploadInternship,
                    
                        RNGForInternshipUploadedAsProfessor = new Random().NextInt64(),
                        RNGForInternshipUploadedAsProfessor_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        ProfessorUploadedInternshipStatus = "Μη Δημοσιευμένη",
                        ProfessorInternshipUploadDate = DateTime.Now
                    };

                    dbContext.ProfessorInternships.Add(newInternship);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying professor internship {originalInternship.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleProfessorInternshipStatuses()
        {
            foreach (var internshipId in selectedProfessorInternshipIds)
            {
                await UpdateProfessorInternshipStatusDirectly(internshipId, newStatusForBulkActionForProfessorInternships);
            }
        }

        private async Task UpdateProfessorInternshipStatusDirectly(int internshipId, string newStatus)
        {
            try
            {
                var internship = await dbContext.ProfessorInternships
                    .FirstOrDefaultAsync(i => i.Id == internshipId);

                if (internship != null)
                {
                    internship.ProfessorUploadedInternshipStatus = newStatus;
                
                    // If status is changed to "Αποσυρμένη", handle student applications
                    if (newStatus == "Αποσυρμένη")
                    {
                        var rngForInternship = internship.RNGForInternshipUploadedAsProfessor;

                        // Update all applications for this internship
                        var applications = await dbContext.ProfessorInternshipsApplied
                            .Where(a => a.RNGForProfessorInternshipApplied == rngForInternship)
                            .ToListAsync();

                        foreach (var application in applications)
                        {
                            application.InternshipStatusAppliedAtTheProfessorSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Καθηγητή)";
                            application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε (Απόσυρση Θέσεως Από Καθηγητή)";
                        }
                    }

                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating professor internship status for internship {internshipId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForProfessorInternships(string newStatus)
        {
            if (selectedProfessorInternshipIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorInternships = "status";
            newStatusForBulkActionForProfessorInternships = newStatus;

            // Set the selected internships for action (this is needed for your existing logic)
            selectedProfessorInternshipsForAction = professorInternships
                .Where(i => selectedProfessorInternshipIds.Contains(i.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorInternships();
        }

        private async Task ExecuteBulkCopyForProfessorInternships()
        {
            if (selectedProfessorInternshipIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForProfessorInternships = "copy";

            // Set the selected internships for action (this is needed for your existing logic)
            selectedProfessorInternshipsForAction = professorInternships
                .Where(i => selectedProfessorInternshipIds.Contains(i.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForProfessorInternships();
        }

        // Bulk edit variables for Research Group Announcements
        private bool isBulkEditModeForResearchGroupAnnouncements = false;
        private HashSet<int> selectedResearchGroupAnnouncementIds = new HashSet<int>();
        private string bulkActionForResearchGroupAnnouncements = "";
        private bool showBulkActionModalForResearchGroupAnnouncements = false;
        private List<AnnouncementAsResearchGroup> selectedResearchGroupAnnouncementsForAction = new List<AnnouncementAsResearchGroup>();
        private string newStatusForBulkActionForResearchGroupAnnouncements = "Μη Δημοσιευμένη";

        private void EnableBulkEditModeForResearchGroupAnnouncements()
        {
            isBulkEditModeForResearchGroupAnnouncements = true;
            selectedResearchGroupAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForResearchGroupAnnouncements()
        {
            isBulkEditModeForResearchGroupAnnouncements = false;
            selectedResearchGroupAnnouncementIds.Clear();
            StateHasChanged();
        }

        private void ToggleResearchGroupAnnouncementSelection(int announcementId, ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            if (isChecked)
            {
                selectedResearchGroupAnnouncementIds.Add(announcementId);
            }
            else
            {
                selectedResearchGroupAnnouncementIds.Remove(announcementId);
            }
            StateHasChanged();
        }

        private void ToggleAllResearchGroupAnnouncementsSelection(ChangeEventArgs e)
        {
            var isChecked = (bool)(e.Value ?? false);
            var paginatedAnnouncements = GetPaginatedResearchGroupAnnouncements();
        
            if (isChecked)
            {
                selectedResearchGroupAnnouncementIds = new HashSet<int>(paginatedAnnouncements.Select(a => a.Id));
            }
            else
            {
                selectedResearchGroupAnnouncementIds.Clear();
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForResearchGroupAnnouncements()
        {
            if (selectedResearchGroupAnnouncementIds.Count == 0) return;
        
            selectedResearchGroupAnnouncementsForAction = FilteredResearchGroupAnnouncements
                .Where(a => selectedResearchGroupAnnouncementIds.Contains(a.Id))
                .ToList();
            bulkActionForResearchGroupAnnouncements = "";
            newStatusForBulkActionForResearchGroupAnnouncements = "Μη Δημοσιευμένη";
            showBulkActionModalForResearchGroupAnnouncements = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForResearchGroupAnnouncements()
        {
            showBulkActionModalForResearchGroupAnnouncements = false;
            bulkActionForResearchGroupAnnouncements = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForResearchGroupAnnouncements()
        {
            if (string.IsNullOrEmpty(bulkActionForResearchGroupAnnouncements) || selectedResearchGroupAnnouncementIds.Count == 0) return;

            string confirmationMessage = "";
            string actionDescription = "";

            if (bulkActionForResearchGroupAnnouncements == "status")
            {
                // Check if any announcements already have the target status
                var announcementsWithSameStatus = selectedResearchGroupAnnouncementsForAction
                    .Where(a => a.ResearchGroupAnnouncementStatus == newStatusForBulkActionForResearchGroupAnnouncements)
                    .ToList();

                if (announcementsWithSameStatus.Any())
                {
                    string alreadySameStatusMessage = 
                        $"<strong style='color: orange;'>Προσοχή:</strong> {announcementsWithSameStatus.Count} από τις επιλεγμένες ανακοινώσεις είναι ήδη στην κατάσταση <strong>'{newStatusForBulkActionForResearchGroupAnnouncements}'</strong> και δεν θα επηρεαστούν.<br><br>" +
                        "<strong>Ανακοινώσεις που δεν θα αλλάξουν:</strong><br>";

                    foreach (var announcement in announcementsWithSameStatus.Take(5))
                    {
                        alreadySameStatusMessage += $"- {announcement.ResearchGroupAnnouncementTitle} ({announcement.ResearchGroupAnnouncementRNG_HashedAsUniqueID})<br>";
                    }

                    if (announcementsWithSameStatus.Count > 5)
                    {
                        alreadySameStatusMessage += $"- ... και άλλες {announcementsWithSameStatus.Count - 5} ανακοινώσεις<br>";
                    }

                    alreadySameStatusMessage += "<br>";

                    // Show warning first
                    bool continueAfterWarning = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { 
                        alreadySameStatusMessage +
                        "Θέλετε να συνεχίσετε με τις υπόλοιπες ανακοινώσεις;"
                    });

                    if (!continueAfterWarning)
                    {
                        CloseBulkActionModalForResearchGroupAnnouncements();
                        return;
                    }

                    // Remove announcements that already have the target status from the selection
                    foreach (var announcement in announcementsWithSameStatus)
                    {
                        selectedResearchGroupAnnouncementIds.Remove(announcement.Id);
                    }

                    // Update the selected announcements list
                    selectedResearchGroupAnnouncementsForAction = selectedResearchGroupAnnouncementsForAction
                        .Where(a => !announcementsWithSameStatus.Contains(a))
                        .ToList();

                    // If no announcements left after filtering, show message and return
                    if (selectedResearchGroupAnnouncementIds.Count == 0)
                    {
                        await JS.InvokeVoidAsync("confirmActionWithHTML2", "Δεν υπάρχουν ανακοινώσεις για αλλαγή κατάστασης. Όλες οι επιλεγμένες ανακοινώσεις είναι ήδη στην επιθυμητή κατάσταση.");
                        CloseBulkActionModalForResearchGroupAnnouncements();
                        return;
                    }
                }

                actionDescription = $"αλλαγή κατάστασης σε '{newStatusForBulkActionForResearchGroupAnnouncements}'";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αλλάξετε την κατάσταση των {selectedResearchGroupAnnouncementIds.Count} επιλεγμένων ανακοινώσεων σε <strong>'{newStatusForBulkActionForResearchGroupAnnouncements}'</strong>?<br><br>";
            }
            else if (bulkActionForResearchGroupAnnouncements == "copy")
            {
                actionDescription = "αντιγραφή";
                confirmationMessage = $"Είστε σίγουροι πως θέλετε να αντιγράψετε τις {selectedResearchGroupAnnouncementIds.Count} επιλεγμένες ανακοινώσεις?<br>Οι νέες ανακοινώσεις θα έχουν κατάσταση <strong>'Μη Δημοσιευμένη'</strong>.<br><br>";
            }

            confirmationMessage += "<strong>Επιλεγμένες Ανακοινώσεις:</strong><br>";
            foreach (var announcement in selectedResearchGroupAnnouncementsForAction.Take(10))
            {
                confirmationMessage += $"- {announcement.ResearchGroupAnnouncementTitle} ({announcement.ResearchGroupAnnouncementRNG_HashedAsUniqueID})<br>";
            }

            if (selectedResearchGroupAnnouncementsForAction.Count > 10)
            {
                confirmationMessage += $"- ... και άλλες {selectedResearchGroupAnnouncementsForAction.Count - 10} ανακοινώσεις<br>";
            }

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", new object[] { confirmationMessage });

            if (!isConfirmed)
            {
                CloseBulkActionModalForResearchGroupAnnouncements();
                return;
            }

            try
            {
                showBulkActionModalForResearchGroupAnnouncements = false;
        
                if (bulkActionForResearchGroupAnnouncements == "status")
                {
                    await UpdateMultipleResearchGroupAnnouncementStatuses();
                }
                else if (bulkActionForResearchGroupAnnouncements == "copy")
                {
                    await CopyMultipleResearchGroupAnnouncements();
                }

                // Refresh data after bulk operation
                await LoadUploadedResearchGroupAnnouncementsAsync();
                CancelBulkEditForResearchGroupAnnouncements();

                // Refresh with tab focus if needed
                var tabUrl = $"{NavigationManager.Uri.Split('?')[0]}#research-group-announcements";
                NavigationManager.NavigateTo(tabUrl, true);
                await Task.Delay(500);
        
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during bulk action for research group announcements: {ex.Message}");
            }
        }

        private async Task CopyMultipleResearchGroupAnnouncements()
        {
            var announcementsToCopy = FilteredResearchGroupAnnouncements
                .Where(a => selectedResearchGroupAnnouncementIds.Contains(a.Id))
                .ToList();

            foreach (var originalAnnouncement in announcementsToCopy)
            {
                try
                {
                    var newAnnouncement = new AnnouncementAsResearchGroup
                    {
                        // Copy all properties from original announcement
                        ResearchGroupAnnouncementTitle = originalAnnouncement.ResearchGroupAnnouncementTitle,
                        ResearchGroupAnnouncementDescription = originalAnnouncement.ResearchGroupAnnouncementDescription,
                        ResearchGroupAnnouncementTimeToBeActive = originalAnnouncement.ResearchGroupAnnouncementTimeToBeActive,
                        ResearchGroupAnnouncementAttachmentFile = originalAnnouncement.ResearchGroupAnnouncementAttachmentFile,
                        ResearchGroupAnnouncementResearchGroupEmail = originalAnnouncement.ResearchGroupAnnouncementResearchGroupEmail,
                    
                        ResearchGroupAnnouncementRNG = new Random().NextInt64(),
                        ResearchGroupAnnouncementRNG_HashedAsUniqueID = HashingHelper.HashLong(new Random().NextInt64()),
                    
                        ResearchGroupAnnouncementStatus = "Μη Δημοσιευμένη",
                        ResearchGroupAnnouncementUploadDate = DateTime.Now
                    };

                    dbContext.AnnouncementAsResearchGroup.Add(newAnnouncement);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error copying research group announcement {originalAnnouncement.Id}: {ex.Message}");
                }
            }
        
            await dbContext.SaveChangesAsync();
        }

        private async Task UpdateMultipleResearchGroupAnnouncementStatuses()
        {
            foreach (var announcementId in selectedResearchGroupAnnouncementIds)
            {
                await UpdateResearchGroupAnnouncementStatusDirectly(announcementId, newStatusForBulkActionForResearchGroupAnnouncements);
            }
        }

        private async Task UpdateResearchGroupAnnouncementStatusDirectly(int announcementId, string newStatus)
        {
            try
            {
                var announcement = await dbContext.AnnouncementAsResearchGroup
                    .FirstOrDefaultAsync(a => a.Id == announcementId);

                if (announcement != null)
                {
                    announcement.ResearchGroupAnnouncementStatus = newStatus;
                    await dbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating research group announcement status for announcement {announcementId}: {ex.Message}");
            }
        }

        private async Task ExecuteBulkStatusChangeForResearchGroupAnnouncements(string newStatus)
        {
            if (selectedResearchGroupAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForResearchGroupAnnouncements = "status";
            newStatusForBulkActionForResearchGroupAnnouncements = newStatus;

            // Set the selected announcements for action (this is needed for your existing logic)
            selectedResearchGroupAnnouncementsForAction = FilteredResearchGroupAnnouncements
                .Where(a => selectedResearchGroupAnnouncementIds.Contains(a.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForResearchGroupAnnouncements();
        }

        private async Task ExecuteBulkCopyForResearchGroupAnnouncements()
        {
            if (selectedResearchGroupAnnouncementIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForResearchGroupAnnouncements = "copy";

            // Set the selected announcements for action (this is needed for your existing logic)
            selectedResearchGroupAnnouncementsForAction = FilteredResearchGroupAnnouncements
                .Where(a => selectedResearchGroupAnnouncementIds.Contains(a.Id))
                .ToList();

            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForResearchGroupAnnouncements();
        }

        // Add these variables to your existing variables section
        private bool isBulkEditModeForApplicants = false;
        private bool showBulkActionModalForApplicants = false;
        private string bulkActionForApplicants = "";
        private HashSet<(long RNG, string StudentId)> selectedApplicantIds = new();
        private string currentJobIdForBulkApplicants = "";
        private bool showEmailConfirmationModalForApplicants = false;
        private string pendingBulkActionForApplicants = "";

        private void ShowEmailConfirmationModalForApplicants(string actionType)
        {
            if (selectedApplicantIds.Count == 0) return;
        
            pendingBulkActionForApplicants = actionType;
            sendEmailsForBulkAction = true; // Default to sending emails
            showEmailConfirmationModalForApplicants = true;
            StateHasChanged();
        }

        private void CloseEmailConfirmationModalForApplicants()
        {
            showEmailConfirmationModalForApplicants = false;
            pendingBulkActionForApplicants = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForApplicants()
        {
            if (string.IsNullOrEmpty(pendingBulkActionForApplicants) || selectedApplicantIds.Count == 0)
                return;

            // NEW CODE: Check slot availability for bulk acceptance
            if (pendingBulkActionForApplicants == "accept")
            {
                // Group applicants by job
                var applicantsByJob = selectedApplicantIds
                    .GroupBy(x => x.RNG)
                    .ToDictionary(g => g.Key, g => g.ToList());

                foreach (var (jobRNG, applicants) in applicantsByJob)
                {
                    var job = jobs.FirstOrDefault(j => j.RNGForPositionUploaded == jobRNG);
                    if (job == null) continue;

                    int acceptedCount = acceptedApplicantsCountPerJob_ForCompanyJob.GetValueOrDefault(jobRNG, 0);
                    int availableSlots = availableSlotsPerJob_ForCompanyJob.GetValueOrDefault(jobRNG, job.OpenSlots);
                    int applicantsToAccept = applicants.Count;

                    if (acceptedCount + applicantsToAccept > availableSlots)
                    {
                        // Close email modal first before showing slot warning
                        CloseEmailConfirmationModalForApplicants();
                
                        slotWarningMessage_ForCompanyJob = $"Για τη θέση '{job.PositionTitle}' έχετε Αποδεχτεί {acceptedCount}/{availableSlots} Αιτούντες, επιλέξατε να αποδεχτείτε {applicantsToAccept} ακόμη. Πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Θέσης Εργασίας για να προχωρήσετε";
                        showSlotWarningModal_ForCompanyJob = true;
                        return; // Stop execution if any job exceeds slots
                    }
                }
            }

            // Show confirmation dialog
            var actionText = pendingBulkActionForApplicants == "accept" ? "ΑΠΟΔΟΧΗ" : "ΑΠΟΡΡΙΨΗ";
            var emailText = sendEmailsForBulkAction ? "και αποστολή email" : "χωρίς αποστολή email";
            var confirmMessage = $"- ΜΑΖΙΚΗ {actionText} ΑΙΤΗΣΕΩΝ - \n" +
                                $"Θα εφαρμοστεί σε {selectedApplicantIds.Count} αιτήσεις {emailText}.\n\n" +
                                $"Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;";

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", confirmMessage);

            if (isConfirmed)
            {
                try
                {
                    var successCount = 0;
                    var failCount = 0;
                    var emailSuccessCount = 0;
                    var emailFailCount = 0;

                    // Store the email setting for this bulk operation
                    var shouldSendEmails = sendEmailsForBulkAction;

                    foreach (var (rng, studentId) in selectedApplicantIds)
                    {
                        try
                        {
                            if (pendingBulkActionForApplicants == "accept")
                            {
                                await AcceptJobApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                                // Update slot count for accepted applications
                                acceptedApplicantsCountPerJob_ForCompanyJob[rng] = 
                                    acceptedApplicantsCountPerJob_ForCompanyJob.GetValueOrDefault(rng, 0) + 1;
                            }
                            else
                            {
                                await RejectJobApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                            }
                            successCount++;

                            // Small delay to avoid overwhelming the server
                            await Task.Delay(100);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error processing application {rng}-{studentId}: {ex.Message}");
                            failCount++;
                        }
                    }

                    // Show comprehensive results summary
                    var resultMessage = $"Ολοκληρώθηκε η μαζική ενέργεια!\n\n" +
                                    $"Επιτυχείς Ενημερώσεις: {successCount}\n" +
                                    $"Αποτυχίες Ενημερώσεων: {failCount}";

                    if (shouldSendEmails)
                    {
                        resultMessage += $"\n\nΑποστολή Email:\n" +
                                    $"Επιτυχείς Αποστολές: {emailSuccessCount}\n" +
                                    $"Αποτυχίες Αποστολής: {emailFailCount}";
                    }
                    else
                    {
                        resultMessage += $"\n\nΔεν στάλθηκαν email ειδοποιήσεις.\n" +
                                    $"Οι φοιτητές θα δουν την αλλαγή κατάστασης όταν συνδεθούν στην εφαρμογή.";
                    }

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", resultMessage).AsTask());

                    // Set the flag to trigger refresh
                    actionsPerformedToAcceptorRejectJobsAsCompany = true;
                }
                catch (Exception ex)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την μαζική επεξεργασία: {ex.Message}").AsTask());
                }
                finally
                {
                    CloseEmailConfirmationModalForApplicants();
                    CancelBulkEditForApplicants();
                    // Reset email option to default for next time
                    sendEmailsForBulkAction = true;
                }
            }
            else
            {
                CloseEmailConfirmationModalForApplicants();
            }
        }

        // Add these methods to your existing methods section
        private void EnableBulkEditModeForApplicants(long jobId)
        {
            isBulkEditModeForApplicants = true;
            currentJobIdForBulkApplicants = jobId.ToString(); // Convert to string for storage
            selectedApplicantIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForApplicants()
        {
            isBulkEditModeForApplicants = false;
            selectedApplicantIds.Clear();
            currentJobIdForBulkApplicants = "";
            StateHasChanged();
        }

        private void ToggleApplicantSelection(long rng, string studentId, ChangeEventArgs e)
        {
            var applicantKey = (rng, studentId);
        
            if ((bool)e.Value!)
            {
                selectedApplicantIds.Add(applicantKey);
            }
            else
            {
                selectedApplicantIds.Remove(applicantKey);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForApplicants()
        {
            showBulkActionModalForApplicants = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForApplicants()
        {
            showBulkActionModalForApplicants = false;
            bulkActionForApplicants = "";
            StateHasChanged();
        }

        private bool sendEmailsForBulkAction = true; 
        

        private async Task AcceptJobApplicationAsCompany_MadeByStudent_Bulk(long jobRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related job
                var application = await dbContext.CompanyJobsApplied
                    .Join(dbContext.CompanyJobs,
                        applied => applied.RNGForCompanyJobApplied,
                        job => job.RNGForPositionUploaded,
                        (applied, job) => new { Application = applied, Job = job })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyJobApplied == jobRNG &&
                                            x.Application.StudentUniqueIDAppliedForCompanyJob == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Application not found: {jobRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyPositionStatusAppliedAtTheCompanySide = "Επιτυχής";
                application.Application.CompanyPositionStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForCompanyJob);

                        // Ensure Company data is loaded
                        if (application.Job.Company == null)
                        {
                            await dbContext.Entry(application.Job)
                                .Reference(j => j.Company)
                                .LoadAsync();
                        }

                        // Send acceptance email to student
                        await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForJobPosition(
                            application.Application.StudentEmailAppliedForCompanyJob.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Job.PositionTitle,
                            application.Job.Company?.CompanyName,
                            application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                            student?.Attachment
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForJobPosition(
                            application.Application.CompanysEmailWhereStudentAppliedForCompanyJob.Trim(),
                            application.Job.Company?.CompanyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                            application.Job.PositionTitle
                        );

                        Console.WriteLine($"Emails sent for application: {jobRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for: {jobRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending emails for {jobRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting job {jobRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task RejectJobApplicationAsCompany_MadeByStudent_Bulk(long jobRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related job
                var application = await dbContext.CompanyJobsApplied
                    .Join(dbContext.CompanyJobs,
                        applied => applied.RNGForCompanyJobApplied,
                        job => job.RNGForPositionUploaded,
                        (applied, job) => new { Application = applied, Job = job })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyJobApplied == jobRNG &&
                                        x.Application.StudentUniqueIDAppliedForCompanyJob == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Application not found: {jobRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyPositionStatusAppliedAtTheCompanySide = "Απορρίφθηκε";
                application.Application.CompanyPositionStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForCompanyJob);

                        // Ensure Company data is loaded if not already included
                        if (application.Job.Company == null)
                        {
                            await dbContext.Entry(application.Job)
                                .Reference(j => j.Company)
                                .LoadAsync();
                        }

                        // Send rejection email to student
                        await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForJobPosition(
                            application.Application.StudentEmailAppliedForCompanyJob.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Job.PositionTitle,
                            application.Job.Company?.CompanyName,
                            application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                            student?.Attachment
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForJobPosition(
                            application.Application.CompanysEmailWhereStudentAppliedForCompanyJob.Trim(),
                            application.Job.Company?.CompanyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForCompanyJobAppliedAsStudent_HashedAsUniqueID,
                            application.Job.PositionTitle
                        );

                        Console.WriteLine($"Emails sent for application: {jobRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for: {jobRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending emails for {jobRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting job {jobRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        // Add these with your other bulk action variables
        private bool isBulkEditModeForInternshipApplicants = false;
        private bool showBulkActionModalForInternshipApplicants = false;
        private string bulkActionForInternshipApplicants = "";
        private HashSet<(long RNG, string StudentId)> selectedInternshipApplicantIds = new();
        private string currentInternshipIdForBulkApplicants = "";
        private string pendingBulkActionForInternshipApplicants = "";
        private bool showEmailConfirmationModalForInternshipApplicants = false;
        private bool sendEmailsForBulkInternshipAction = true;



        private void ShowEmailConfirmationModalForInternshipApplicants(string actionType)
        {
            if (selectedInternshipApplicantIds.Count == 0) return;

            pendingBulkActionForInternshipApplicants = actionType;
            sendEmailsForBulkInternshipAction = true; // Default to sending emails
            showEmailConfirmationModalForInternshipApplicants = true;
            StateHasChanged();
        }

        private void CloseEmailConfirmationModalForInternshipApplicants()
        {
            showEmailConfirmationModalForInternshipApplicants = false;
            pendingBulkActionForInternshipApplicants = "";
            StateHasChanged();
        }

        private void EnableBulkEditModeForInternshipApplicants(string internshipId)
        {
            isBulkEditModeForInternshipApplicants = true;
            currentInternshipIdForBulkApplicants = internshipId;
            selectedInternshipApplicantIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForInternshipApplicants()
        {
            isBulkEditModeForInternshipApplicants = false;
            selectedInternshipApplicantIds.Clear();
            currentInternshipIdForBulkApplicants = "";
            StateHasChanged();
        }

        private void ToggleInternshipApplicantSelection(long rng, string studentId, ChangeEventArgs e)
        {
            var applicantKey = (rng, studentId);
        
            if ((bool)e.Value!)
            {
                selectedInternshipApplicantIds.Add(applicantKey);
            }
            else
            {
                selectedInternshipApplicantIds.Remove(applicantKey);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForInternshipApplicants()
        {
            showBulkActionModalForInternshipApplicants = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForInternshipApplicants()
        {
            showBulkActionModalForInternshipApplicants = false;
            bulkActionForInternshipApplicants = "";
            StateHasChanged();
        }

    private async Task ExecuteBulkActionForInternshipApplicants()
        {
            if (string.IsNullOrEmpty(pendingBulkActionForInternshipApplicants) || selectedInternshipApplicantIds.Count == 0)
                return;

            // NEW CODE: Check slot availability for bulk acceptance
            if (pendingBulkActionForInternshipApplicants == "accept")
            {
                // Group applicants by internship
                var applicantsByInternship = selectedInternshipApplicantIds
                    .GroupBy(x => x.RNG)
                    .ToDictionary(g => g.Key, g => g.ToList());

                foreach (var (internshipRNG, applicants) in applicantsByInternship)
                {
                    var internship = internships.FirstOrDefault(i => i.RNGForInternshipUploadedAsCompany == internshipRNG);
                    if (internship == null) continue;

                    int acceptedCount = acceptedApplicantsCountPerInternship_ForCompanyInternship.GetValueOrDefault(internshipRNG, 0);
                    int availableSlots = availableSlotsPerInternship_ForCompanyInternship.GetValueOrDefault(internshipRNG, internship.OpenSlots_CompanyInternships);
                    int applicantsToAccept = applicants.Count;

                    if (acceptedCount + applicantsToAccept > availableSlots)
                    {
                        // Close email modal first before showing slot warning
                        CloseEmailConfirmationModalForInternshipApplicants();
            
                        slotWarningMessage_ForCompanyInternship = $"Για τη πρακτική άσκηση '{internship.CompanyInternshipTitle}' έχετε Αποδεχτεί {acceptedCount}/{availableSlots} Αιτούντες, επιλέξατε να αποδεχτείτε {applicantsToAccept} ακόμη. Πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Πρακτικής Άσκησης για να προχωρήσετε";
                        showSlotWarningModal_ForCompanyInternship = true;
                        return; // Stop execution if any internship exceeds slots
                    }
                }
            }

            // Show confirmation dialog
            var actionText = pendingBulkActionForInternshipApplicants == "accept" ? "ΑΠΟΔΟΧΗ" : "ΑΠΟΡΡΙΨΗ";
            var emailText = sendEmailsForBulkInternshipAction ? "και αποστολή email" : "χωρίς αποστολή email";
            var confirmMessage = $"- ΜΑΖΙΚΗ {actionText} ΑΙΤΗΣΕΩΝ ΠΡΑΚΤΙΚΗΣ - \n" +
                                $"Θα εφαρμοστεί σε {selectedInternshipApplicantIds.Count} αιτήσεις {emailText}.\n\n" +
                                $"Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;";

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", confirmMessage);

            if (isConfirmed)
            {
                try
                {
                    var successCount = 0;
                    var failCount = 0;

                    // Store the email setting for this bulk operation
                    var shouldSendEmails = sendEmailsForBulkInternshipAction;

                    foreach (var (rng, studentId) in selectedInternshipApplicantIds)
                    {
                        try
                        {
                            if (pendingBulkActionForInternshipApplicants == "accept")
                            {
                                await AcceptInternshipApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                                // Update slot count for accepted applications
                                acceptedApplicantsCountPerInternship_ForCompanyInternship[rng] = 
                                    acceptedApplicantsCountPerInternship_ForCompanyInternship.GetValueOrDefault(rng, 0) + 1;
                            }
                            else
                            {
                                await RejectInternshipApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                            }
                            successCount++;

                            // Small delay to avoid overwhelming the server
                            await Task.Delay(100);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error processing internship application {rng}-{studentId}: {ex.Message}");
                            failCount++;
                        }
                    }

                    // Show results summary
                    var resultMessage = $"Ολοκληρώθηκε η μαζική ενέργεια!\n\n" +
                                    $"Επιτυχείς Ενημερώσεις: {successCount}\n" +
                                    $"Αποτυχίες Ενημερώσεων: {failCount}";

                    if (shouldSendEmails)
                    {
                        resultMessage += $"\n\nΑποστολή Email: Ολοκληρώθηκε";
                    }
                    else
                    {
                        resultMessage += $"\n\nΔεν στάλθηκαν email ειδοποιήσεις.\n" +
                                    $"Οι φοιτητές θα δουν την αλλαγή κατάστασης όταν συνδεθούν στην εφαρμογή.";
                    }

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", resultMessage).AsTask());

                    // Set the flag to trigger refresh
                    actionsPerformedToAcceptorRejectInternshipsAsCompany = true;
                }
                catch (Exception ex)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την μαζική επεξεργασία: {ex.Message}").AsTask());
                }
                finally
                {
                    CloseEmailConfirmationModalForInternshipApplicants();
                    CancelBulkEditForInternshipApplicants();
                    // Reset email option to default for next time
                    sendEmailsForBulkInternshipAction = true;
                }
            }
            else
            {
                CloseEmailConfirmationModalForInternshipApplicants();
            }
        }

        private async Task AcceptInternshipApplicationAsCompany_MadeByStudent_Bulk(long internshipRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related internship
                var application = await dbContext.InternshipsApplied
                    .Join(dbContext.CompanyInternships,
                        applied => applied.RNGForInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsCompany,
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForInternshipApplied == internshipRNG &&
                                            x.Application.StudentUniqueIDAppliedForInternship == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Internship application not found: {internshipRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheCompanySide = "Επιτυχής";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForInternship);

                        // Send acceptance email to student
                        await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForInternshipPosition(
                            application.Application.StudentEmailAppliedForInternship.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Internship.CompanyInternshipTitle,
                            application.Internship.Company?.CompanyName,
                            application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                            student?.Attachment
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForInternshipPosition(
                            application.Application.CompanyEmailWhereStudentAppliedForInternship.Trim(),
                            application.Internship.Company?.CompanyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                            application.Internship.CompanyInternshipTitle
                        );

                        Console.WriteLine($"Internship acceptance emails sent for: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for internship: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending internship emails for {internshipRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting internship {internshipRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task RejectInternshipApplicationAsCompany_MadeByStudent_Bulk(long internshipRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related internship
                var application = await dbContext.InternshipsApplied
                    .Join(dbContext.CompanyInternships,
                        applied => applied.RNGForInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsCompany,
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForInternshipApplied == internshipRNG &&
                                        x.Application.StudentUniqueIDAppliedForInternship == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Internship application not found: {internshipRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheCompanySide = "Απορρίφθηκε";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForInternship);

                        // Send rejection email to student
                        await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForInternshipPosition(
                            application.Application.StudentEmailAppliedForInternship.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Internship.CompanyInternshipTitle,
                            application.Internship.Company?.CompanyName,
                            application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                            student?.Attachment
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForInternshipPosition(
                            application.Application.CompanyEmailWhereStudentAppliedForInternship.Trim(),
                            application.Internship.Company?.CompanyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForInternshipAppliedAsStudent_HashedAsUniqueID,
                            application.Internship.CompanyInternshipTitle
                        );

                        Console.WriteLine($"Internship rejection emails sent for: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for internship: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending internship emails for {internshipRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting internship {internshipRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task ExecuteBulkStatusChangeForInternships(string newStatus)
        {
            if (selectedInternshipIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForInternships = "status";
            newStatusForBulkActionForInternships = newStatus;
        
            // Set the selected internships for action (this is needed for your existing logic)
            selectedInternshipsForAction = internships.Where(i => selectedInternshipIds.Contains(i.Id)).ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForInternships();
        }

        private async Task ExecuteBulkCopyForInternships()
        {
            if (selectedInternshipIds.Count == 0) return;

            // Use your existing bulk action logic
            bulkActionForInternships = "copy";
        
            // Set the selected internships for action (this is needed for your existing logic)
            selectedInternshipsForAction = internships.Where(i => selectedInternshipIds.Contains(i.Id)).ToList();
        
            // Execute the bulk action directly without showing the modal
            await ExecuteBulkActionForInternships();
        }

        // Add these with your other bulk action variables
        private bool isBulkEditModeForThesisApplicants = false;
        private bool showBulkActionModalForThesisApplicants = false;
        private string bulkActionForThesisApplicants = "";
        private bool sendEmailsForBulkThesisAction = true;
        private HashSet<(long RNG, string StudentId)> selectedThesisApplicantIds = new();
        private string currentThesisIdForBulkApplicants = "";

        // Add these with your other bulk action variables
        private bool showEmailConfirmationModalForThesisApplicants = false;
        private string pendingBulkActionForThesisApplicants = "";

        private void ShowEmailConfirmationModalForThesisApplicants(string actionType)
        {
            if (selectedThesisApplicantIds.Count == 0) return;

            pendingBulkActionForThesisApplicants = actionType;
            sendEmailsForBulkThesisAction = true; // Default to sending emails
            showEmailConfirmationModalForThesisApplicants = true;
            StateHasChanged();
        }

        private void CloseEmailConfirmationModalForThesisApplicants()
        {
            showEmailConfirmationModalForThesisApplicants = false;
            pendingBulkActionForThesisApplicants = "";
            StateHasChanged();
        }


        private void EnableBulkEditModeForThesisApplicants(string thesisId)
        {
            isBulkEditModeForThesisApplicants = true;
            currentThesisIdForBulkApplicants = thesisId;
            selectedThesisApplicantIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForThesisApplicants()
        {
            isBulkEditModeForThesisApplicants = false;
            selectedThesisApplicantIds.Clear();
            currentThesisIdForBulkApplicants = "";
            StateHasChanged();
        }

        private void ToggleThesisApplicantSelection(long rng, string studentId, ChangeEventArgs e)
        {
            var applicantKey = (rng, studentId);
        
            if ((bool)e.Value!)
            {
                selectedThesisApplicantIds.Add(applicantKey);
            }
            else
            {
                selectedThesisApplicantIds.Remove(applicantKey);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForThesisApplicants()
        {
            showBulkActionModalForThesisApplicants = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForThesisApplicants()
        {
            showBulkActionModalForThesisApplicants = false;
            bulkActionForThesisApplicants = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForThesisApplicants()
        {
            if (string.IsNullOrEmpty(pendingBulkActionForThesisApplicants) || selectedThesisApplicantIds.Count == 0)
                return;

            // Check slot availability for bulk acceptance
            if (pendingBulkActionForThesisApplicants == "accept")
            {
                // Group applicants by thesis
                var applicantsByThesis = selectedThesisApplicantIds
                    .GroupBy(x => x.RNG)
                    .ToDictionary(g => g.Key, g => g.ToList());

                foreach (var (thesisRNG, applicants) in applicantsByThesis)
                {
                    var thesis = companytheses.FirstOrDefault(t => t.RNGForThesisUploadedAsCompany == thesisRNG);
                    if (thesis == null) continue;

                    int acceptedCount = acceptedApplicantsCountPerThesis_ForCompanyThesis.GetValueOrDefault(thesisRNG, 0);
                    int availableSlots = availableSlotsPerThesis_ForCompanyThesis.GetValueOrDefault(thesisRNG, thesis.OpenSlots_CompanyThesis);
                    int applicantsToAccept = applicants.Count;

                    if (acceptedCount + applicantsToAccept > availableSlots)
                    {
                        // Close email modal first before showing slot warning
                        CloseEmailConfirmationModalForThesisApplicants();
        
                        slotWarningMessage_ForCompanyThesis = $"Για την Διπλωματική εργασία '{thesis.CompanyThesisTitle}' έχετε Αποδεχτεί {acceptedCount}/{availableSlots} Αιτούντες, επιλέξατε να αποδεχτείτε {applicantsToAccept} ακόμη. Πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Διπλωματικής Εργασίας για να προχωρήσετε";
                        showSlotWarningModal_ForCompanyThesis = true;
                        return; // Stop execution if any thesis exceeds slots
                    }
                }
            }

            // Show confirmation dialog
            var actionText = pendingBulkActionForThesisApplicants == "accept" ? "ΑΠΟΔΟΧΗ" : "ΑΠΟΡΡΙΨΗ";
            var emailText = sendEmailsForBulkThesisAction ? "και αποστολή email" : "χωρίς αποστολή email";
            var confirmMessage = $"- ΜΑΖΙΚΗ {actionText} ΑΙΤΗΣΕΩΝ ΠΤΥΧΙΑΚΗΣ - \n" +
                                $"Θα εφαρμοστεί σε {selectedThesisApplicantIds.Count} αιτήσεις {emailText}.\n\n" +
                                $"Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;";

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", confirmMessage);

            if (isConfirmed)
            {
                try
                {
                    var successCount = 0;
                    var failCount = 0;

                    // Store the email setting for this bulk operation
                    var shouldSendEmails = sendEmailsForBulkThesisAction;

                    foreach (var (rng, studentId) in selectedThesisApplicantIds)
                    {
                        try
                        {
                            if (pendingBulkActionForThesisApplicants == "accept")
                            {
                                await AcceptThesisApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                                // Update slot count for accepted applications
                                acceptedApplicantsCountPerThesis_ForCompanyThesis[rng] = 
                                    acceptedApplicantsCountPerThesis_ForCompanyThesis.GetValueOrDefault(rng, 0) + 1;
                            }
                            else
                            {
                                await RejectThesisApplicationAsCompany_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                            }
                            successCount++;

                            // Small delay to avoid overwhelming the server
                            await Task.Delay(100);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error processing thesis application {rng}-{studentId}: {ex.Message}");
                            failCount++;
                        }
                    }

                    // Show results summary
                    var resultMessage = $"Ολοκληρώθηκε η μαζική ενέργεια!\n\n" +
                                    $"Επιτυχείς Ενημερώσεις: {successCount}\n" +
                                    $"Αποτυχίες Ενημερώσεων: {failCount}";

                    if (shouldSendEmails)
                    {
                        resultMessage += $"\n\nΑποστολή Email: Ολοκληρώθηκε";
                    }
                    else
                    {
                        resultMessage += $"\n\nΔεν στάλθηκαν email ειδοποιήσεων.\n" +
                                    $"Οι φοιτητές θα δουν την αλλαγή κατάστασης όταν συνδεθούν στην εφαρμογή.";
                    }

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", resultMessage).AsTask());

                    // Set the flag to trigger refresh
                    actionsPerformedToAcceptorRejectThesisAsCompany = true;
                }
                catch (Exception ex)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την μαζική επεξεργασία: {ex.Message}").AsTask());
                }
                finally
                {
                    CloseEmailConfirmationModalForThesisApplicants();
                    CancelBulkEditForThesisApplicants();
                    // Reset email option to default for next time
                    sendEmailsForBulkThesisAction = true;
                }
            }
            else
            {
                CloseEmailConfirmationModalForThesisApplicants();
            }
        }

        private async Task AcceptThesisApplicationAsCompany_MadeByStudent_Bulk(long companythesisId, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.CompanyThesesApplied
                    .Join(dbContext.CompanyTheses,
                        applied => applied.RNGForCompanyThesisApplied,
                        thesis => thesis.RNGForThesisUploadedAsCompany,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyThesisApplied == companythesisId &&
                                            x.Application.StudentUniqueIDAppliedForThesis == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Thesis application not found: {companythesisId}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyThesisStatusAppliedAtStudentSide = "Επιτυχής";
                application.Application.CompanyThesisStatusAppliedAtCompanySide = "Έχει γίνει Αποδοχή";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForThesis);

                        // Get company name from navigation property with fallback
                        var companyName = application.Thesis.Company?.CompanyName ?? "Άγνωστη Εταιρεία";

                        // Send acceptance email to student
                        await InternshipEmailService.SendAcceptanceEmailAsCompanyToStudentAfterHeAppliedForThesisPosition(
                            application.Application.StudentEmailAppliedForThesis.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Thesis.CompanyThesisTitle,
                            companyName,
                            application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                            student?.Attachment
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendAcceptanceConfirmationEmailToCompanyAfterStudentAppliedForThesisPosition(
                            application.Application.CompanyEmailWhereStudentAppliedForThesis.Trim(),
                            companyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                            application.Thesis.CompanyThesisTitle
                        );

                        Console.WriteLine($"Thesis acceptance emails sent for: {companythesisId}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for thesis: {companythesisId}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending thesis emails for {companythesisId}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting thesis {companythesisId}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task RejectThesisApplicationAsCompany_MadeByStudent_Bulk(long companythesisId, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.CompanyThesesApplied
                    .Join(dbContext.CompanyTheses,
                        applied => applied.RNGForCompanyThesisApplied,
                        thesis => thesis.RNGForThesisUploadedAsCompany,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.RNGForCompanyThesisApplied == companythesisId &&
                                        x.Application.StudentUniqueIDAppliedForThesis == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Thesis application not found: {companythesisId}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.CompanyThesisStatusAppliedAtCompanySide = "Έχει Απορριφθεί";
                application.Application.CompanyThesisStatusAppliedAtStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForThesis);

                        // Get company name from navigation property with fallback
                        var companyName = application.Thesis.Company?.CompanyName ?? "Άγνωστη Εταιρεία";

                        // Send rejection email to student
                        await InternshipEmailService.SendRejectionEmailAsCompanyToStudentAfterHeAppliedForThesisPosition(
                            application.Application.StudentEmailAppliedForThesis.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Thesis.CompanyThesisTitle,
                            application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                            companyName
                        );

                        // Send notification email to company
                        await InternshipEmailService.SendRejectionConfirmationEmailToCompanyAfterStudentAppliedForThesisPosition(
                            application.Application.CompanyEmailWhereStudentAppliedForThesis.Trim(),
                            companyName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForCompanyThesisAppliedAsStudent_HashedAsUniqueID,
                            application.Thesis.CompanyThesisTitle
                        );

                        Console.WriteLine($"Thesis rejection emails sent for: {companythesisId}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for thesis: {companythesisId}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending thesis emails for {companythesisId}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting thesis {companythesisId}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }


        // Add these with your other bulk action variables
        private bool isBulkEditModeForProfessorThesisApplicants = false;
        private bool showBulkActionModalForProfessorThesisApplicants = false;
        private string bulkActionForProfessorThesisApplicants = "";
        private bool sendEmailsForBulkProfessorThesisAction = true;
        private HashSet<(long RNG, string StudentId)> selectedProfessorThesisApplicantIds = new();
        private string currentProfessorThesisIdForBulkApplicants = "";
        private bool showEmailConfirmationModalForProfessorThesisApplicants = false;
        private string pendingBulkActionForProfessorThesisApplicants = "";

        private void ShowEmailConfirmationModalForProfessorThesisApplicants(string actionType)
        {
            if (selectedProfessorThesisApplicantIds.Count == 0) return;

            pendingBulkActionForProfessorThesisApplicants = actionType;
            sendEmailsForBulkProfessorThesisAction = true; // Default to sending emails
            showEmailConfirmationModalForProfessorThesisApplicants = true;
            StateHasChanged();
        }

        private void CloseEmailConfirmationModalForProfessorThesisApplicants()
        {
            showEmailConfirmationModalForProfessorThesisApplicants = false;
            pendingBulkActionForProfessorThesisApplicants = "";
            StateHasChanged();
        }

        private void EnableBulkEditModeForProfessorThesisApplicants(string thesisId)
        {
            isBulkEditModeForProfessorThesisApplicants = true;
            currentProfessorThesisIdForBulkApplicants = thesisId;
            selectedProfessorThesisApplicantIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorThesisApplicants()
        {
            isBulkEditModeForProfessorThesisApplicants = false;
            selectedProfessorThesisApplicantIds.Clear();
            currentProfessorThesisIdForBulkApplicants = "";
            StateHasChanged();
        }

        private void ToggleProfessorThesisApplicantSelection(long id, string studentId, ChangeEventArgs e)
        {
            // Make sure you're getting the RNG for this applicant, not the database ID
            var applicant = professorThesisApplicantsMap
                .SelectMany(kvp => kvp.Value)
                .FirstOrDefault(a => a.Id == id && a.StudentUniqueIDAppliedForProfessorThesis == studentId);
        
            if (applicant != null)
            {
                var applicantKey = (applicant.RNGForProfessorThesisApplied, studentId);
        
                if ((bool)e.Value!)
                {
                    selectedProfessorThesisApplicantIds.Add(applicantKey);
                }
                else
                {
                    selectedProfessorThesisApplicantIds.Remove(applicantKey);
                }
                StateHasChanged();
            }
        }

        private void ShowBulkActionOptionsForProfessorThesisApplicants()
        {
            showBulkActionModalForProfessorThesisApplicants = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorThesisApplicants()
        {
            showBulkActionModalForProfessorThesisApplicants = false;
            bulkActionForProfessorThesisApplicants = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorThesisApplicants()
        {
            if (string.IsNullOrEmpty(pendingBulkActionForProfessorThesisApplicants) || selectedProfessorThesisApplicantIds.Count == 0)
                return;

            // Check slot availability for bulk acceptance - MATCHING COMPANY THESIS PATTERN
            if (pendingBulkActionForProfessorThesisApplicants == "accept")
            {
                // Group applicants by thesis - MATCHING COMPANY THESIS PATTERN
                var applicantsByThesisForProfessorThesis = selectedProfessorThesisApplicantIds
                    .GroupBy(x => x.RNG) // Use RNG directly (long)
                    .ToDictionary(g => g.Key, g => g.ToList());

                foreach (var (thesisRNG, applicants) in applicantsByThesisForProfessorThesis)
                {
                    var thesis = FilteredThesesAsProfessor.FirstOrDefault(t => t.RNGForThesisUploaded == thesisRNG);
                    if (thesis == null) continue;

                    int acceptedCountForProfessorThesis = acceptedApplicantsCountPerProfessorThesis.GetValueOrDefault(thesisRNG, 0);
                    int availableSlotsForProfessorThesis = availableSlotsPerProfessorThesis.GetValueOrDefault(thesisRNG, thesis.OpenSlots_ProfessorThesis);
                    int applicantsToAcceptForProfessorThesis = applicants.Count;

                    if (acceptedCountForProfessorThesis + applicantsToAcceptForProfessorThesis > availableSlotsForProfessorThesis)
                    {
                        // Close email modal first before showing slot warning
                        CloseEmailConfirmationModalForProfessorThesisApplicants();
            
                        slotWarningMessageForProfessorThesis = $"Για την Διπλωματική εργασία '{thesis.ThesisTitle}' έχετε Αποδεχτεί {acceptedCountForProfessorThesis}/{availableSlotsForProfessorThesis} Αιτούντες, επιλέξατε να αποδεχτείτε {applicantsToAcceptForProfessorThesis} ακόμη. Πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Διπλωματικής Εργασίας για να προχωρήσετε";
                        showSlotWarningModalForProfessorThesis = true;
                        StateHasChanged();
                        return; // Stop execution if any thesis exceeds slots
                    }
                }
            }

            // Show confirmation dialog
            var actionText = pendingBulkActionForProfessorThesisApplicants == "accept" ? "ΑΠΟΔΟΧΗ" : "ΑΠΟΡΡΙΨΗ";
            var emailText = sendEmailsForBulkProfessorThesisAction ? "και αποστολή email" : "χωρίς αποστολή email";
            var confirmMessage = $"- ΜΑΖΙΚΗ {actionText} ΑΙΤΗΣΕΩΝ ΔΙΠΛΩΜΑΤΙΚΗΣ - \n" +
                                $"Θα εφαρμοστεί σε {selectedProfessorThesisApplicantIds.Count} αιτήσεις {emailText}.\n\n" +
                                $"Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;";

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", confirmMessage);

            if (isConfirmed)
            {
                try
                {
                    var successCount = 0;
                    var failCount = 0;

                    // Store the email setting for this bulk operation
                    var shouldSendEmails = sendEmailsForBulkProfessorThesisAction;

                    foreach (var (rng, studentId) in selectedProfessorThesisApplicantIds)
                    {
                        try
                        {
                            if (pendingBulkActionForProfessorThesisApplicants == "accept")
                            {
                                await AcceptThesisApplicationAsProfessor_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                                // Update slot count for accepted applications - MATCHING COMPANY THESIS PATTERN
                                acceptedApplicantsCountPerProfessorThesis[rng] = 
                                    acceptedApplicantsCountPerProfessorThesis.GetValueOrDefault(rng, 0) + 1;
                            }
                            else
                            {
                                await RejectThesisApplicationAsProfessor_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                            }
                            successCount++;

                            // Small delay to avoid overwhelming the server
                            await Task.Delay(100);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error processing professor thesis application {rng}-{studentId}: {ex.Message}");
                            failCount++;
                        }
                    }

                    // Show results summary
                    var resultMessage = $"Ολοκληρώθηκε η μαζική ενέργεια!\n\n" +
                                    $"Επιτυχείς Ενημερώσεις: {successCount}\n" +
                                    $"Αποτυχίες Ενημερώσεων: {failCount}";

                    if (shouldSendEmails)
                    {
                        resultMessage += $"\n\nΑποστολή Email: Ολοκληρώθηκε";
                    }
                    else
                    {
                        resultMessage += $"\n\nΔεν στάλθηκαν email ειδοποιήσεων.\n" +
                                    $"Οι φοιτητές θα δουν την αλλαγή κατάστασης όταν συνδεθούν στην εφαρμογή.";
                    }

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", resultMessage).AsTask());

                    // Set the flag to trigger refresh
                    actionsPerformedToAcceptorRejectThesesAsProfessor = true;
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την μαζική επεξεργασία: {ex.Message}").AsTask());
                }
                finally
                {
                    CloseEmailConfirmationModalForProfessorThesisApplicants();
                    CancelBulkEditForProfessorThesisApplicants();
                    // Reset email option to default for next time
                    sendEmailsForBulkProfessorThesisAction = true;
                }
            }
            else
            {
                CloseEmailConfirmationModalForProfessorThesisApplicants();
            }
        }
        private async Task AcceptThesisApplicationAsProfessor_MadeByStudent_Bulk(long professorThesisId, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.ProfessorThesesApplied
                    .Join(dbContext.ProfessorTheses,
                        applied => applied.RNGForProfessorThesisApplied,
                        thesis => thesis.RNGForThesisUploaded,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.Id == professorThesisId &&
                                            x.Application.StudentUniqueIDAppliedForProfessorThesis == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Professor thesis application not found: {professorThesisId}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the application entity
                application.Application.ProfessorThesisStatusAppliedAtStudentSide = "Επιτυχής";
                application.Application.ProfessorThesisStatusAppliedAtProfessorSide = "Έχει γίνει Αποδοχή";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForProfessorThesis);
                
                        // Get professor name from navigation property with fallback
                        var professorName = application.Thesis.Professor != null
                            ? $"{application.Thesis.Professor.ProfName} {application.Thesis.Professor.ProfSurname}"
                            : "Άγνωστος Καθηγητής";

                        // Send acceptance email to student
                        await InternshipEmailService.SendAcceptanceEmailAsProfessorToStudentAfterHeAppliedForThesisPosition(
                            application.Application.StudentEmailAppliedForProfessorThesis.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Thesis.ThesisTitle,
                            application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                            professorName
                        );

                        // Send notification email to professor
                        await InternshipEmailService.SendAcceptanceConfirmationEmailToProfessorAfterStudentAppliedForThesisPosition(
                            application.Application.ProfessorEmailWhereStudentAppliedForProfessorThesis.Trim(),
                            professorName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                            application.Thesis.ThesisTitle
                        );

                        Console.WriteLine($"Professor thesis acceptance emails sent for: {professorThesisId}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for professor thesis: {professorThesisId}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending professor thesis emails for {professorThesisId}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting professor thesis {professorThesisId}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task RejectThesisApplicationAsProfessor_MadeByStudent_Bulk(long professorThesisId, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related thesis
                var application = await dbContext.ProfessorThesesApplied
                    .Join(dbContext.ProfessorTheses,
                        applied => applied.RNGForProfessorThesisApplied,
                        thesis => thesis.RNGForThesisUploaded,
                        (applied, thesis) => new { Application = applied, Thesis = thesis })
                    .FirstOrDefaultAsync(x => x.Application.Id == professorThesisId &&
                                            x.Application.StudentUniqueIDAppliedForProfessorThesis == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Professor thesis application not found: {professorThesisId}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the application entity
                application.Application.ProfessorThesisStatusAppliedAtProfessorSide = "Έχει Απορριφθεί";
                application.Application.ProfessorThesisStatusAppliedAtStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentEmailAppliedForProfessorThesis);
                
                        // Get professor name from navigation property with fallback
                        var professorName = application.Thesis.Professor != null
                            ? $"{application.Thesis.Professor.ProfName} {application.Thesis.Professor.ProfSurname}"
                            : "Άγνωστος Καθηγητής";

                        // Send rejection email to student
                        await InternshipEmailService.SendRejectionEmailAsProfessorToStudentAfterHeAppliedForThesisPosition(
                            application.Application.StudentEmailAppliedForProfessorThesis.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Thesis.ThesisTitle,
                            application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                            professorName
                        );

                        // Send notification email to professor
                        await InternshipEmailService.SendRejectionConfirmationEmailToProfessorAfterStudentAppliedForThesisPosition(
                            application.Application.ProfessorEmailWhereStudentAppliedForProfessorThesis.Trim(),
                            professorName,
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForProfessorThesisApplied_HashedAsUniqueID,
                            application.Thesis.ThesisTitle
                        );

                        Console.WriteLine($"Professor thesis rejection emails sent for: {professorThesisId}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for professor thesis: {professorThesisId}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending professor thesis emails for {professorThesisId}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting professor thesis {professorThesisId}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        // Add these with your other bulk action variables
        private bool isBulkEditModeForProfessorInternshipApplicants = false;
        private bool showBulkActionModalForProfessorInternshipApplicants = false;
        private string bulkActionForProfessorInternshipApplicants = "";
        private bool sendEmailsForBulkProfessorInternshipAction = true;
        private HashSet<(long RNG, string StudentId)> selectedProfessorInternshipApplicantIds = new();
        private string currentProfessorInternshipIdForBulkApplicants = "";
        private bool showEmailConfirmationModalForProfessorInternshipApplicants = false;
        private string pendingBulkActionForProfessorInternshipApplicants = "";

        private void ShowEmailConfirmationModalForProfessorInternshipApplicants(string actionType)
        {
            if (selectedProfessorInternshipApplicantIds.Count == 0) return;

            pendingBulkActionForProfessorInternshipApplicants = actionType;
            sendEmailsForBulkProfessorInternshipAction = true; // Default to sending emails
            showEmailConfirmationModalForProfessorInternshipApplicants = true;
            StateHasChanged();
        }

        private void CloseEmailConfirmationModalForProfessorInternshipApplicants()
        {
            showEmailConfirmationModalForProfessorInternshipApplicants = false;
            pendingBulkActionForProfessorInternshipApplicants = "";
            StateHasChanged();
        }

        private void EnableBulkEditModeForProfessorInternshipApplicants(string internshipId)
        {
            isBulkEditModeForProfessorInternshipApplicants = true;
            currentProfessorInternshipIdForBulkApplicants = internshipId;
            selectedProfessorInternshipApplicantIds.Clear();
            StateHasChanged();
        }

        private void CancelBulkEditForProfessorInternshipApplicants()
        {
            isBulkEditModeForProfessorInternshipApplicants = false;
            selectedProfessorInternshipApplicantIds.Clear();
            currentProfessorInternshipIdForBulkApplicants = "";
            StateHasChanged();
        }

        private void ToggleProfessorInternshipApplicantSelection(long rng, string studentId, ChangeEventArgs e)
        {
            var applicantKey = (rng, studentId);
        
            if ((bool)e.Value!)
            {
                selectedProfessorInternshipApplicantIds.Add(applicantKey);
            }
            else
            {
                selectedProfessorInternshipApplicantIds.Remove(applicantKey);
            }
            StateHasChanged();
        }

        private void ShowBulkActionOptionsForProfessorInternshipApplicants()
        {
            showBulkActionModalForProfessorInternshipApplicants = true;
            StateHasChanged();
        }

        private void CloseBulkActionModalForProfessorInternshipApplicants()
        {
            showBulkActionModalForProfessorInternshipApplicants = false;
            bulkActionForProfessorInternshipApplicants = "";
            StateHasChanged();
        }

        private async Task ExecuteBulkActionForProfessorInternshipApplicants()
        {
            if (string.IsNullOrEmpty(pendingBulkActionForProfessorInternshipApplicants) || selectedProfessorInternshipApplicantIds.Count == 0)
                return;

            // Check slot availability for bulk acceptance - MATCHING COMPANY INTERNSHIP PATTERN
            if (pendingBulkActionForProfessorInternshipApplicants == "accept")
            {
                // Group applicants by internship - MATCHING COMPANY INTERNSHIP PATTERN
                var applicantsByInternshipForProfessorInternship = selectedProfessorInternshipApplicantIds
                    .GroupBy(x => x.RNG) // Use RNG directly (long)
                    .ToDictionary(g => g.Key, g => g.ToList());

                foreach (var (internshipRNG, applicants) in applicantsByInternshipForProfessorInternship)
                {
                    var internship = professorInternships.FirstOrDefault(t => t.RNGForInternshipUploadedAsProfessor == internshipRNG);
                    if (internship == null) continue;

                    int acceptedCountForProfessorInternship = acceptedApplicantsCountPerProfessorInternship.GetValueOrDefault(internshipRNG, 0);
                    int availableSlotsForProfessorInternship = availableSlotsPerProfessorInternship.GetValueOrDefault(internshipRNG, internship.OpenSlots_ProfessorInternship);
                    int applicantsToAcceptForProfessorInternship = applicants.Count;

                    if (acceptedCountForProfessorInternship + applicantsToAcceptForProfessorInternship > availableSlotsForProfessorInternship)
                    {
                        // Close email modal first before showing slot warning
                        CloseEmailConfirmationModalForProfessorInternshipApplicants();
            
                        slotWarningMessageForProfessorInternship = $"Για την πρακτική άσκηση '{internship.ProfessorInternshipTitle}' έχετε Αποδεχτεί {acceptedCountForProfessorInternship}/{availableSlotsForProfessorInternship} Αιτούντες, επιλέξατε να αποδεχτείτε {applicantsToAcceptForProfessorInternship} ακόμη. Πρέπει να αλλάξετε τον Αριθμό των διαθέσιμων Slots της Πρακτικής Άσκησης για να προχωρήσετε";
                        showSlotWarningModalForProfessorInternship = true;
                        StateHasChanged();
                        return; // Stop excecution if any internship exceeds slots
                    }
                }
            }

            // Show confirmation dialog
            var actionText = pendingBulkActionForProfessorInternshipApplicants == "accept" ? "ΑΠΟΔΟΧΗ" : "ΑΠΟΡΡΙΨΗ";
            var emailText = sendEmailsForBulkProfessorInternshipAction ? "και αποστολή email" : "χωρίς αποστολή email";
            var confirmMessage = $"- ΜΑΖΙΚΗ {actionText} ΑΙΤΗΣΕΩΝ ΠΡΑΚΤΙΚΗΣ - \n" +
                                $"Θα εφαρμοστεί σε {selectedProfessorInternshipApplicantIds.Count} αιτήσεις {emailText}.\n\n" +
                                $"Η ενέργεια αυτή δεν θα μπορεί να αναιρεθεί. Είστε σίγουρος/η;";

            bool isConfirmed = await JS.InvokeAsync<bool>("confirmActionWithHTML", confirmMessage);

            if (isConfirmed)
            {
                try
                {
                    var successCount = 0;
                    var failCount = 0;

                    // Store the email setting for this bulk operation
                    var shouldSendEmails = sendEmailsForBulkProfessorInternshipAction;

                    foreach (var (rng, studentId) in selectedProfessorInternshipApplicantIds)
                    {
                        try
                        {
                            if (pendingBulkActionForProfessorInternshipApplicants == "accept")
                            {
                                await AcceptInternshipApplicationAsProfessor_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                                // Update slot count for accepted applications - MATCHING COMPANY INTERNSHIP PATTERN
                                acceptedApplicantsCountPerProfessorInternship[rng] = 
                                    acceptedApplicantsCountPerProfessorInternship.GetValueOrDefault(rng, 0) + 1;
                            }
                            else
                            {
                                await RejectInternshipApplicationAsProfessor_MadeByStudent_Bulk(rng, studentId, shouldSendEmails);
                            }
                            successCount++;

                            // Small delay to avoid overwhelming the server
                            await Task.Delay(100);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error processing professor internship application {rng}-{studentId}: {ex.Message}");
                            failCount++;
                        }
                    }

                    // Show results summary
                    var resultMessage = $"Ολοκληρώθηκε η μαζική ενέργεια!\n\n" +
                                    $"Επιτυχείς Ενημερώσεις: {successCount}\n" +
                                    $"Αποτυχίες Ενημερώσεων: {failCount}";

                    if (shouldSendEmails)
                    {
                        resultMessage += $"\n\nΑποστολή Email: Ολοκληρώθηκε";
                    }
                    else
                    {
                        resultMessage += $"\n\nΔεν στάλθηκαν email ειδοποιήσεων.\n" +
                                    $"Οι φοιτητές θα δουν την αλλαγή κατάστασης όταν συνδεθούν στην εφαρμογή.";
                    }

                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", resultMessage).AsTask());

                    // Set the flag to trigger refresh
                    actionsPerformedToAcceptorRejectInternshipsAsProfessor = true;
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    await SafeInvokeJsAsync(() => JS.InvokeVoidAsync("confirmActionWithHTML2", 
                        $"Σφάλμα κατά την μαζική επεξεργασία: {ex.Message}").AsTask());
                }
                finally
                {
                    CloseEmailConfirmationModalForProfessorInternshipApplicants();
                    CancelBulkEditForProfessorInternshipApplicants();
                    // Reset email option to default for next time
                    sendEmailsForBulkProfessorInternshipAction = true;
                }
            }
            else
            {
                CloseEmailConfirmationModalForProfessorInternshipApplicants();
            }
        }

        private async Task AcceptInternshipApplicationAsProfessor_MadeByStudent_Bulk(long internshipRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related internship
                var application = await dbContext.ProfessorInternshipsApplied
                    .Join(dbContext.ProfessorInternships.Include(i => i.Professor),
                        applied => applied.RNGForProfessorInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsProfessor,
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForProfessorInternshipApplied == internshipRNG &&
                                            x.Application.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Professor internship application not found: {internshipRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheProfessorSide = "Επιτυχής";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Επιτυχής";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship);

                        // Send acceptance email to student
                        await InternshipEmailService.SendAcceptanceEmailAsProfessorToStudentAfterHeAppliedForInternshipPosition(
                            application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Internship.ProfessorInternshipTitle,
                            application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                            $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}"
                        );

                        // Send notification email to professor
                        await InternshipEmailService.SendAcceptanceConfirmationEmailToProfessorAfterStudentAppliedForInternshipPosition(
                            application.Application.ProfessorDetails.ProfessorEmailWhereStudentAppliedForProfessorInternship.Trim(),
                            $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}",
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                            application.Internship.ProfessorInternshipTitle
                        );

                        Console.WriteLine($"Professor internship acceptance emails sent for: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for professor internship: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending professor internship emails for {internshipRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting professor internship {internshipRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        private async Task RejectInternshipApplicationAsProfessor_MadeByStudent_Bulk(long internshipRNG, string studentUniqueID, bool sendEmails)
        {
            try
            {
                // Fetch application with related internship
                var application = await dbContext.ProfessorInternshipsApplied
                    .Join(dbContext.ProfessorInternships.Include(i => i.Professor),
                        applied => applied.RNGForProfessorInternshipApplied,
                        internship => internship.RNGForInternshipUploadedAsProfessor,
                        (applied, internship) => new { Application = applied, Internship = internship })
                    .FirstOrDefaultAsync(x => x.Application.RNGForProfessorInternshipApplied == internshipRNG &&
                                        x.Application.StudentDetails.StudentUniqueIDAppliedForProfessorInternship == studentUniqueID);

                if (application == null)
                {
                    Console.WriteLine($"Professor internship application not found: {internshipRNG}-{studentUniqueID}");
                    return;
                }

                // Update status directly on the main application entity
                application.Application.InternshipStatusAppliedAtTheProfessorSide = "Απορρίφθηκε";
                application.Application.InternshipStatusAppliedAtTheStudentSide = "Απορρίφθηκε";

                await dbContext.SaveChangesAsync();

                if (sendEmails)
                {
                    try
                    {
                        // Get student details
                        var student = await GetStudentDetails(application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship);

                        // Send rejection email to student
                        await InternshipEmailService.SendRejectionEmailAsProfessorToStudentAfterHeAppliedForInternshipPosition(
                            application.Application.StudentDetails.StudentEmailAppliedForProfessorInternship.Trim(),
                            student?.Name,
                            student?.Surname,
                            application.Internship.ProfessorInternshipTitle,
                            application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                            $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}"
                        );

                        // Send notification email to professor
                        await InternshipEmailService.SendRejectionConfirmationEmailToProfessorAfterStudentAppliedForInternshipPosition(
                            application.Application.ProfessorDetails.ProfessorEmailWhereStudentAppliedForProfessorInternship.Trim(),
                            $"{application.Internship.Professor.ProfName} {application.Internship.Professor.ProfSurname}",
                            student?.Name,
                            student?.Surname,
                            application.Application.RNGForProfessorInternshipApplied_HashedAsUniqueID,
                            application.Internship.ProfessorInternshipTitle
                        );

                        Console.WriteLine($"Professor internship rejection emails sent for: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (FormatException)
                    {
                        Console.WriteLine($"Invalid email address format for professor internship: {internshipRNG}-{studentUniqueID}");
                    }
                    catch (Exception emailEx)
                    {
                        Console.WriteLine($"Error sending professor internship emails for {internshipRNG}-{studentUniqueID}: {emailEx.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting professor internship {internshipRNG}-{studentUniqueID}: {ex.Message}");
                throw;
            }
        }

        // Current slot tracking - NEW CODE
        // Current slot tracking - FIXED to use long keys
        private Dictionary<long, int> acceptedApplicantsCountPerJob_ForCompanyJob = new Dictionary<long, int>();
        private Dictionary<long, int> availableSlotsPerJob_ForCompanyJob = new Dictionary<long, int>();
        private bool showSlotWarningModal_ForCompanyJob = false;
        private string slotWarningMessage_ForCompanyJob = "";
        private void InitializeSlotData_ForCompanyJob()
        {
            // Only clear if we're initializing all jobs, but for now let's just update
            // acceptedApplicantsCountPerJob_ForCompanyJob.Clear();
            // availableSlotsPerJob_ForCompanyJob.Clear();

            foreach (var job in jobs)
            {
                long jobRNG = job.RNGForPositionUploaded;
        
                // Get accepted applicants count for this job
                var acceptedCount_ForCompanyJob = 0;
                if (jobApplicantsMap.ContainsKey(jobRNG))
                {
                    acceptedCount_ForCompanyJob = jobApplicantsMap[jobRNG]
                        .Where(a => a.CompanyPositionStatusAppliedAtTheCompanySide == "Επιτυχής")
                        .Count();
                }
            
                acceptedApplicantsCountPerJob_ForCompanyJob[jobRNG] = acceptedCount_ForCompanyJob;
                availableSlotsPerJob_ForCompanyJob[jobRNG] = job.OpenSlots;
            }
        }

        private void CloseSlotWarningModal_ForCompanyJob() // NEW METHOD
        {
            showSlotWarningModal_ForCompanyJob = false;
            slotWarningMessage_ForCompanyJob = "";
        }

        // Current slot tracking for Internships - NEW CODE
        private Dictionary<long, int> acceptedApplicantsCountPerInternship_ForCompanyInternship = new Dictionary<long, int>();
        private Dictionary<long, int> availableSlotsPerInternship_ForCompanyInternship = new Dictionary<long, int>();
        private bool showSlotWarningModal_ForCompanyInternship = false;
        private string slotWarningMessage_ForCompanyInternship = "";
        private void InitializeSlotData_ForCompanyInternship() // NEW METHOD
        {
            acceptedApplicantsCountPerInternship_ForCompanyInternship.Clear();
            availableSlotsPerInternship_ForCompanyInternship.Clear();

            foreach (var internship in internships)
            {
                long internshipRNG = internship.RNGForInternshipUploadedAsCompany;
        
                // Get accepted applicants count for this internship
                var acceptedCount_ForCompanyInternship = internshipApplicantsMap.ContainsKey(internshipRNG) 
                    ? internshipApplicantsMap[internshipRNG]
                        .Count(a => a.InternshipStatusAppliedAtTheCompanySide == "Επιτυχής")
                    : 0;
            
                acceptedApplicantsCountPerInternship_ForCompanyInternship[internshipRNG] = acceptedCount_ForCompanyInternship;
                availableSlotsPerInternship_ForCompanyInternship[internshipRNG] = internship.OpenSlots_CompanyInternships;
            }
        }

        private void CloseSlotWarningModal_ForCompanyInternship() // NEW METHOD
        {
            showSlotWarningModal_ForCompanyInternship = false;
            slotWarningMessage_ForCompanyInternship = "";
        }
        
        // Current slot tracking for Theses - NEW CODE
        private Dictionary<long, int> acceptedApplicantsCountPerThesis_ForCompanyThesis = new Dictionary<long, int>();
        private Dictionary<long, int> availableSlotsPerThesis_ForCompanyThesis = new Dictionary<long, int>();
        private bool showSlotWarningModal_ForCompanyThesis = false;
        private string slotWarningMessage_ForCompanyThesis = "";
        private void InitializeSlotData_ForCompanyThesis() // NEW METHOD
        {
            acceptedApplicantsCountPerThesis_ForCompanyThesis.Clear();
            availableSlotsPerThesis_ForCompanyThesis.Clear();

            foreach (var thesis in companytheses)
            {
                long thesisRNG = thesis.RNGForThesisUploadedAsCompany;
        
                // Get accepted applicants count for this thesis
                var acceptedCount_ForCompanyThesis = companyThesisApplicantsMap.ContainsKey(thesisRNG) 
                    ? companyThesisApplicantsMap[thesisRNG]
                        .Count(a => a.CompanyThesisStatusAppliedAtCompanySide == "Έχει γίνει Αποδοχή")
                    : 0;
            
                acceptedApplicantsCountPerThesis_ForCompanyThesis[thesisRNG] = acceptedCount_ForCompanyThesis;
                availableSlotsPerThesis_ForCompanyThesis[thesisRNG] = thesis.OpenSlots_CompanyThesis;
            }
        }

        private void CloseSlotWarningModal_ForCompanyThesis() // NEW METHOD
        {
            showSlotWarningModal_ForCompanyThesis = false;
            slotWarningMessage_ForCompanyThesis = "";
        }

        // Current slot tracking for Professor Theses - NEW CODE
        private Dictionary<long, int> acceptedApplicantsCountPerProfessorThesis = new Dictionary<long, int>();
        private Dictionary<long, int> availableSlotsPerProfessorThesis = new Dictionary<long, int>();
        private bool showSlotWarningModalForProfessorThesis = false;
        private string slotWarningMessageForProfessorThesis = "";
        private void InitializeSlotDataForProfessorThesis()
        {
            acceptedApplicantsCountPerProfessorThesis.Clear();
            availableSlotsPerProfessorThesis.Clear();

            foreach (var thesis in FilteredThesesAsProfessor)
            {
                long thesisRNG = thesis.RNGForThesisUploaded;
        
                // Get accepted applicants count for this thesis
                var acceptedCountForProfessorThesis = professorThesisApplicantsMap.ContainsKey(thesisRNG) 
                    ? professorThesisApplicantsMap[thesisRNG]
                        .Count(a => a.ProfessorThesisStatusAppliedAtProfessorSide == "Έχει γίνει Αποδοχή")
                    : 0;
            
                acceptedApplicantsCountPerProfessorThesis[thesisRNG] = acceptedCountForProfessorThesis;
                availableSlotsPerProfessorThesis[thesisRNG] = thesis.OpenSlots_ProfessorThesis;
            }
        }

        private void CloseSlotWarningModalForProfessorThesis() // NEW METHOD
        {
            showSlotWarningModalForProfessorThesis = false;
            slotWarningMessageForProfessorThesis = "";
        }

        // Current slot tracking for Professor Internships - NEW CODE
        private Dictionary<long, int> acceptedApplicantsCountPerProfessorInternship = new Dictionary<long, int>();
        private Dictionary<long, int> availableSlotsPerProfessorInternship = new Dictionary<long, int>();
        private bool showSlotWarningModalForProfessorInternship = false;
        private string slotWarningMessageForProfessorInternship = "";

        private void InitializeSlotDataForProfessorInternships() // NEW METHOD
        {
            acceptedApplicantsCountPerProfessorInternship.Clear();
            availableSlotsPerProfessorInternship.Clear();

            foreach (var internship in professorInternships)
            {
                long internshipRNG = internship.RNGForInternshipUploadedAsProfessor;
        
                // Get accepted applicants count for this internship
                var acceptedCountForProfessorInternship = professorInternshipApplicantsMap.ContainsKey(internshipRNG) 
                    ? professorInternshipApplicantsMap[internshipRNG]
                        .Count(a => a.InternshipStatusAppliedAtTheProfessorSide == "Επιτυχής")
                    : 0;
            
                acceptedApplicantsCountPerProfessorInternship[internshipRNG] = acceptedCountForProfessorInternship;
                availableSlotsPerProfessorInternship[internshipRNG] = internship.OpenSlots_ProfessorInternship;
            }
        }

        private void CloseSlotWarningModalForProfessorInternship() // NEW METHOD
        {
            showSlotWarningModalForProfessorInternship = false;
            slotWarningMessageForProfessorInternship = "";
        }

        private int activeAnnouncementMenuId = 0;
        private void ToggleAnnouncementMenu(int announcementId)
        {
            if (activeAnnouncementMenuId == announcementId)
            {
                activeAnnouncementMenuId = 0;
            }
            else
            {
                activeAnnouncementMenuId = announcementId;
            }
        }

        private int activeEventMenuId = 0;
        private void ToggleEventMenu(int eventId)
        {
            if (activeEventMenuId == eventId)
            {
                activeEventMenuId = 0;
            }
            else
            {
                activeEventMenuId = eventId;
            }
            StateHasChanged();
        }

        private int activeJobMenuId = 0;
        private void ToggleJobMenu(int jobId)
        {
            if (activeJobMenuId == jobId)
            {
                activeJobMenuId = 0;
            }
            else
            {
                activeJobMenuId = jobId;
            }
            StateHasChanged();
        }

        private int activeInternshipMenuId = 0;
        private void ToggleInternshipMenu(int internshipId)
        {
            if (activeInternshipMenuId == internshipId)
            {
                activeInternshipMenuId = 0;
            }
            else
            {
                activeInternshipMenuId = internshipId;
            }
            StateHasChanged();
        } 
        
        private int activeThesisMenuId = 0;
        private void ToggleThesisMenu(int thesisId)
        {
            if (activeThesisMenuId == thesisId)
            {
                activeThesisMenuId = 0;
            }
            else
            {
                activeThesisMenuId = thesisId;
            }
            StateHasChanged();
        }

        private int activeProfessorEventMenuId = 0;
        private void ToggleProfessorEventMenu(int eventId)
        {
            if (activeProfessorEventMenuId == eventId)
            {
                activeProfessorEventMenuId = 0;
            }
            else
            {
                activeProfessorEventMenuId = eventId;
            }
        }

        private int activeProfessorThesisMenuId = 0;
        private void ToggleProfessorThesisMenu(int thesisId)
        {
            if (activeProfessorThesisMenuId == thesisId)
            {
                activeProfessorThesisMenuId = 0;
            }
            else
            {
                activeProfessorThesisMenuId = thesisId;
            }
            StateHasChanged();
        }

        private int activeProfessorAnnouncementMenuId = 0;
        private void ToggleProfessorAnnouncementMenu(int announcementId)
        {
            if (activeProfessorAnnouncementMenuId == announcementId)
            {
                activeProfessorAnnouncementMenuId = 0;
            }
            else
            {
                activeProfessorAnnouncementMenuId = announcementId;
            }
            StateHasChanged();
        }

        private int activeProfessorInternshipMenuId = 0;
        private void ToggleProfessorInternshipMenu(int internshipId)
        {
            if (activeProfessorInternshipMenuId == internshipId)
            {
                activeProfessorInternshipMenuId = 0;
            }
            else
            {
                activeProfessorInternshipMenuId = internshipId;
            }
            StateHasChanged();
        }

        private bool isLoadingUploadedResearchGroupAnnouncements = false;
        private bool showLoadingModalForDeleteResearchGroupAnnouncement = false;

        private int activeResearchGroupAnnouncementMenuId = 0;
        private void ToggleResearchGroupAnnouncementMenu(int announcementId)
        {
            if (activeResearchGroupAnnouncementMenuId == announcementId)
            {
                activeResearchGroupAnnouncementMenuId = 0;
            }
            else
            {
                activeResearchGroupAnnouncementMenuId = announcementId;
            }
        }  
    }
}